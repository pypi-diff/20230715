# Comparing `tmp/ctransformers-langdash-0.2.11.tar.gz` & `tmp/ctransformers-langdash-0.2.9.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ctransformers-langdash-0.2.11.tar", last modified: Sat Jul 15 02:46:31 2023, max compression
+gzip compressed data, was "ctransformers-langdash-0.2.9.tar", last modified: Thu Jun 22 20:15:31 2023, max compression
```

## Comparing `ctransformers-langdash-0.2.11.tar` & `ctransformers-langdash-0.2.9.tar`

### file list

```diff
@@ -1,67 +1,61 @@
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.220380 ctransformers-langdash-0.2.11/
--rw-rw-r--   0 user      (1000) user      (1000)       43 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/.gitattributes
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.204380 ctransformers-langdash-0.2.11/.github/
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.208380 ctransformers-langdash-0.2.11/.github/workflows/
--rw-rw-r--   0 user      (1000) user      (1000)     1325 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/.github/workflows/build.yml
--rw-rw-r--   0 user      (1000) user      (1000)      981 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/.github/workflows/tests.yml
--rw-rw-r--   0 user      (1000) user      (1000)    13529 2023-07-15 02:44:43.000000 ctransformers-langdash-0.2.11/.gitignore
--rw-rw-r--   0 user      (1000) user      (1000)      333 2023-07-15 02:37:44.000000 ctransformers-langdash-0.2.11/.gitmodules
--rw-rw-r--   0 user      (1000) user      (1000)     4547 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/CMakeLists.txt
--rw-rw-r--   0 user      (1000) user      (1000)     1078 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/LICENSE
--rw-rw-r--   0 user      (1000) user      (1000)    15411 2023-07-15 02:46:31.220380 ctransformers-langdash-0.2.11/PKG-INFO
--rw-rw-r--   0 user      (1000) user      (1000)    14393 2023-07-15 02:38:47.000000 ctransformers-langdash-0.2.11/README.md
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.208380 ctransformers-langdash-0.2.11/ctransformers/
--rw-rw-r--   0 user      (1000) user      (1000)       79 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/ctransformers/__init__.py
--rw-rw-r--   0 user      (1000) user      (1000)     6692 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/ctransformers/hub.py
--rw-rw-r--   0 user      (1000) user      (1000)     2620 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/ctransformers/langchain.py
--rw-rw-r--   0 user      (1000) user      (1000)     1260 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/ctransformers/lib.py
--rw-rw-r--   0 user      (1000) user      (1000)    18191 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/ctransformers/llm.py
--rw-rw-r--   0 user      (1000) user      (1000)     1596 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/ctransformers/utils.py
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.208380 ctransformers-langdash-0.2.11/ctransformers_langdash.egg-info/
--rw-rw-r--   0 user      (1000) user      (1000)    15411 2023-07-15 02:46:31.000000 ctransformers-langdash-0.2.11/ctransformers_langdash.egg-info/PKG-INFO
--rw-rw-r--   0 user      (1000) user      (1000)     1242 2023-07-15 02:46:31.000000 ctransformers-langdash-0.2.11/ctransformers_langdash.egg-info/SOURCES.txt
--rw-rw-r--   0 user      (1000) user      (1000)        1 2023-07-15 02:46:31.000000 ctransformers-langdash-0.2.11/ctransformers_langdash.egg-info/dependency_links.txt
--rw-rw-r--   0 user      (1000) user      (1000)        1 2023-07-15 02:42:00.000000 ctransformers-langdash-0.2.11/ctransformers_langdash.egg-info/not-zip-safe
--rw-rw-r--   0 user      (1000) user      (1000)       32 2023-07-15 02:46:31.000000 ctransformers-langdash-0.2.11/ctransformers_langdash.egg-info/requires.txt
--rw-rw-r--   0 user      (1000) user      (1000)       14 2023-07-15 02:46:31.000000 ctransformers-langdash-0.2.11/ctransformers_langdash.egg-info/top_level.txt
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.212380 ctransformers-langdash-0.2.11/models/
--rw-rw-r--   0 user      (1000) user      (1000)     5722 2023-07-15 02:38:25.000000 ctransformers-langdash-0.2.11/models/common.h
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.216380 ctransformers-langdash-0.2.11/models/ggml/
--rw-rw-r--   0 user      (1000) user      (1000)    99093 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/ggml/ggml-cuda.cu
--rw-rw-r--   0 user      (1000) user      (1000)     1513 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/ggml/ggml-cuda.h
--rw-rw-r--   0 user      (1000) user      (1000)     3066 2023-07-15 02:37:44.000000 ctransformers-langdash-0.2.11/models/ggml/ggml-ggllm.c
--rw-rw-r--   0 user      (1000) user      (1000)      259 2023-07-15 02:37:44.000000 ctransformers-langdash-0.2.11/models/ggml/ggml-ggllm.h
--rw-rw-r--   0 user      (1000) user      (1000)   589010 2023-07-15 02:37:44.000000 ctransformers-langdash-0.2.11/models/ggml/ggml.c
--rw-rw-r--   0 user      (1000) user      (1000)    44960 2023-07-15 02:37:44.000000 ctransformers-langdash-0.2.11/models/ggml/ggml.h
--rw-rw-r--   0 user      (1000) user      (1000)    86455 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/ggml/k_quants.c
--rw-rw-r--   0 user      (1000) user      (1000)     5813 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/ggml/k_quants.h
--rw-rw-r--   0 user      (1000) user      (1000)   106770 2023-07-15 02:37:44.000000 ctransformers-langdash-0.2.11/models/ggml/libfalcon.cpp
--rw-rw-r--   0 user      (1000) user      (1000)    14674 2023-07-15 02:37:44.000000 ctransformers-langdash-0.2.11/models/ggml/libfalcon.h
--rw-rw-r--   0 user      (1000) user      (1000)    13994 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/ggml/llama-util.h
--rw-rw-r--   0 user      (1000) user      (1000)   116686 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/ggml/llama.cpp
--rw-rw-r--   0 user      (1000) user      (1000)    16681 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/ggml/llama.h
--rw-rw-r--   0 user      (1000) user      (1000)     3628 2023-07-15 02:38:25.000000 ctransformers-langdash-0.2.11/models/llm.cc
--rw-rw-r--   0 user      (1000) user      (1000)    11652 2023-07-15 02:38:47.000000 ctransformers-langdash-0.2.11/models/llm.h
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.216380 ctransformers-langdash-0.2.11/models/llms/
--rw-rw-r--   0 user      (1000) user      (1000)    22380 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/llms/dolly.cc
--rw-rw-r--   0 user      (1000) user      (1000)     3387 2023-07-15 02:37:44.000000 ctransformers-langdash-0.2.11/models/llms/falcon.cc
--rw-rw-r--   0 user      (1000) user      (1000)    22959 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/llms/gpt-neox.cc
--rw-rw-r--   0 user      (1000) user      (1000)    23320 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/llms/gpt2.cc
--rw-rw-r--   0 user      (1000) user      (1000)    20183 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/llms/gptj.cc
--rw-rw-r--   0 user      (1000) user      (1000)     3324 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/llms/llama.cc
--rw-rw-r--   0 user      (1000) user      (1000)    19883 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/llms/mpt.cc
--rw-rw-r--   0 user      (1000) user      (1000)    21779 2023-07-15 02:38:25.000000 ctransformers-langdash-0.2.11/models/llms/replit.cc
--rw-rw-r--   0 user      (1000) user      (1000)    25363 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/models/llms/starcoder.cc
--rw-rw-r--   0 user      (1000) user      (1000)      150 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/pyproject.toml
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.216380 ctransformers-langdash-0.2.11/scripts/
--rwxrwxr-x   0 user      (1000) user      (1000)      107 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/scripts/build.sh
--rwxrwxr-x   0 user      (1000) user      (1000)     1479 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/scripts/docs.py
--rwxrwxr-x   0 user      (1000) user      (1000)      550 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/scripts/release.sh
--rwxrwxr-x   0 user      (1000) user      (1000)      829 2023-07-15 02:37:44.000000 ctransformers-langdash-0.2.11/scripts/sync.sh
--rw-rw-r--   0 user      (1000) user      (1000)       38 2023-07-15 02:46:31.220380 ctransformers-langdash-0.2.11/setup.cfg
--rw-rw-r--   0 user      (1000) user      (1000)     1783 2023-07-15 02:38:58.000000 ctransformers-langdash-0.2.11/setup.py
-drwxrwxr-x   0 user      (1000) user      (1000)        0 2023-07-15 02:46:31.216380 ctransformers-langdash-0.2.11/tests/
--rw-rw-r--   0 user      (1000) user      (1000)        0 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/tests/__init__.py
--rw-rw-r--   0 user      (1000) user      (1000)      261 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/tests/conftest.py
--rw-rw-r--   0 user      (1000) user      (1000)     1765 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/tests/test_llm.py
--rw-rw-r--   0 user      (1000) user      (1000)     1286 2023-06-21 03:55:19.000000 ctransformers-langdash-0.2.11/tests/test_model.py
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.893349 ctransformers-langdash-0.2.9/
+-rw-r--r--   0 user      (1000) user      (1000)       43 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/.gitattributes
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.890016 ctransformers-langdash-0.2.9/.github/
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.890016 ctransformers-langdash-0.2.9/.github/workflows/
+-rw-r--r--   0 user      (1000) user      (1000)     1325 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/.github/workflows/build.yml
+-rw-r--r--   0 user      (1000) user      (1000)      981 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/.github/workflows/tests.yml
+-rw-r--r--   0 user      (1000) user      (1000)    13506 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/.gitignore
+-rw-r--r--   0 user      (1000) user      (1000)      211 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/.gitmodules
+-rw-r--r--   0 user      (1000) user      (1000)     4547 2023-06-19 23:22:01.000000 ctransformers-langdash-0.2.9/CMakeLists.txt
+-rw-r--r--   0 user      (1000) user      (1000)     1078 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/LICENSE
+-rw-r--r--   0 user      (1000) user      (1000)    15312 2023-06-22 20:15:31.893349 ctransformers-langdash-0.2.9/PKG-INFO
+-rw-r--r--   0 user      (1000) user      (1000)    14295 2023-06-22 20:07:51.000000 ctransformers-langdash-0.2.9/README.md
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.890016 ctransformers-langdash-0.2.9/ctransformers/
+-rw-r--r--   0 user      (1000) user      (1000)       79 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/ctransformers/__init__.py
+-rw-r--r--   0 user      (1000) user      (1000)     6692 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/ctransformers/hub.py
+-rw-r--r--   0 user      (1000) user      (1000)     2620 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/ctransformers/langchain.py
+-rw-r--r--   0 user      (1000) user      (1000)     1260 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/ctransformers/lib.py
+-rw-r--r--   0 user      (1000) user      (1000)    18191 2023-06-19 23:21:37.000000 ctransformers-langdash-0.2.9/ctransformers/llm.py
+-rw-r--r--   0 user      (1000) user      (1000)     1596 2023-06-19 23:20:35.000000 ctransformers-langdash-0.2.9/ctransformers/utils.py
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.890016 ctransformers-langdash-0.2.9/ctransformers_langdash.egg-info/
+-rw-r--r--   0 user      (1000) user      (1000)    15312 2023-06-22 20:15:31.000000 ctransformers-langdash-0.2.9/ctransformers_langdash.egg-info/PKG-INFO
+-rw-r--r--   0 user      (1000) user      (1000)     1098 2023-06-22 20:15:31.000000 ctransformers-langdash-0.2.9/ctransformers_langdash.egg-info/SOURCES.txt
+-rw-r--r--   0 user      (1000) user      (1000)        1 2023-06-22 20:15:31.000000 ctransformers-langdash-0.2.9/ctransformers_langdash.egg-info/dependency_links.txt
+-rw-r--r--   0 user      (1000) user      (1000)        1 2023-06-22 20:14:54.000000 ctransformers-langdash-0.2.9/ctransformers_langdash.egg-info/not-zip-safe
+-rw-r--r--   0 user      (1000) user      (1000)       32 2023-06-22 20:15:31.000000 ctransformers-langdash-0.2.9/ctransformers_langdash.egg-info/requires.txt
+-rw-r--r--   0 user      (1000) user      (1000)       14 2023-06-22 20:15:31.000000 ctransformers-langdash-0.2.9/ctransformers_langdash.egg-info/top_level.txt
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.890016 ctransformers-langdash-0.2.9/models/
+-rw-r--r--   0 user      (1000) user      (1000)     5697 2023-06-19 23:22:01.000000 ctransformers-langdash-0.2.9/models/common.h
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.890016 ctransformers-langdash-0.2.9/models/ggml/
+-rw-r--r--   0 user      (1000) user      (1000)    99093 2023-06-19 23:22:01.000000 ctransformers-langdash-0.2.9/models/ggml/ggml-cuda.cu
+-rw-r--r--   0 user      (1000) user      (1000)     1513 2023-06-19 23:22:01.000000 ctransformers-langdash-0.2.9/models/ggml/ggml-cuda.h
+-rw-r--r--   0 user      (1000) user      (1000)   588642 2023-06-19 23:22:01.000000 ctransformers-langdash-0.2.9/models/ggml/ggml.c
+-rw-r--r--   0 user      (1000) user      (1000)    44901 2023-06-19 23:22:01.000000 ctransformers-langdash-0.2.9/models/ggml/ggml.h
+-rw-r--r--   0 user      (1000) user      (1000)    86455 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/ggml/k_quants.c
+-rw-r--r--   0 user      (1000) user      (1000)     5813 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/ggml/k_quants.h
+-rw-r--r--   0 user      (1000) user      (1000)    13994 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/ggml/llama-util.h
+-rw-r--r--   0 user      (1000) user      (1000)   116686 2023-06-19 23:22:01.000000 ctransformers-langdash-0.2.9/models/ggml/llama.cpp
+-rw-r--r--   0 user      (1000) user      (1000)    16681 2023-06-19 23:22:01.000000 ctransformers-langdash-0.2.9/models/ggml/llama.h
+-rw-r--r--   0 user      (1000) user      (1000)     3427 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/llm.cc
+-rw-r--r--   0 user      (1000) user      (1000)    11494 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/llm.h
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.890016 ctransformers-langdash-0.2.9/models/llms/
+-rw-r--r--   0 user      (1000) user      (1000)    22380 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/llms/dolly.cc
+-rw-r--r--   0 user      (1000) user      (1000)    22959 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/llms/gpt-neox.cc
+-rw-r--r--   0 user      (1000) user      (1000)    23320 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/llms/gpt2.cc
+-rw-r--r--   0 user      (1000) user      (1000)    20183 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/llms/gptj.cc
+-rw-r--r--   0 user      (1000) user      (1000)     3324 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/llms/llama.cc
+-rw-r--r--   0 user      (1000) user      (1000)    19883 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/llms/mpt.cc
+-rw-r--r--   0 user      (1000) user      (1000)    25363 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/models/llms/starcoder.cc
+-rw-r--r--   0 user      (1000) user      (1000)      150 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/pyproject.toml
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.893349 ctransformers-langdash-0.2.9/scripts/
+-rwxr-xr-x   0 user      (1000) user      (1000)      107 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/scripts/build.sh
+-rwxr-xr-x   0 user      (1000) user      (1000)     1479 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/scripts/docs.py
+-rwxr-xr-x   0 user      (1000) user      (1000)       65 2023-06-22 20:15:20.000000 ctransformers-langdash-0.2.9/scripts/release.sh
+-rwxr-xr-x   0 user      (1000) user      (1000)      714 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/scripts/sync.sh
+-rw-r--r--   0 user      (1000) user      (1000)       38 2023-06-22 20:15:31.893349 ctransformers-langdash-0.2.9/setup.cfg
+-rw-r--r--   0 user      (1000) user      (1000)     1782 2023-06-22 20:08:55.000000 ctransformers-langdash-0.2.9/setup.py
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-06-22 20:15:31.893349 ctransformers-langdash-0.2.9/tests/
+-rw-r--r--   0 user      (1000) user      (1000)        0 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/tests/__init__.py
+-rw-r--r--   0 user      (1000) user      (1000)      261 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/tests/conftest.py
+-rw-r--r--   0 user      (1000) user      (1000)     1765 2023-06-19 23:22:01.000000 ctransformers-langdash-0.2.9/tests/test_llm.py
+-rw-r--r--   0 user      (1000) user      (1000)     1286 2023-06-12 23:24:14.000000 ctransformers-langdash-0.2.9/tests/test_model.py
```

### Comparing `ctransformers-langdash-0.2.11/.github/workflows/build.yml` & `ctransformers-langdash-0.2.9/.github/workflows/build.yml`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/.github/workflows/tests.yml` & `ctransformers-langdash-0.2.9/.github/workflows/tests.yml`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/.gitignore` & `ctransformers-langdash-0.2.9/.gitignore`

 * *Files 2% similar despite different names*

```diff
@@ -748,11 +748,7 @@
 # JetBrains Rider
 *.sln.iml
 
 ### VisualStudio Patch ###
 # Additional files built by Visual Studio
 
 # End of https://www.toptal.com/developers/gitignore/api/c++,python,cmake,linux,macos,windows,sublimetext,vim,visualstudio,visualstudiocode
-
-MANIFEST.in
-_skbuild
-
```

### Comparing `ctransformers-langdash-0.2.11/CMakeLists.txt` & `ctransformers-langdash-0.2.9/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/LICENSE` & `ctransformers-langdash-0.2.9/LICENSE`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/PKG-INFO` & `ctransformers-langdash-0.2.9/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ctransformers-langdash
-Version: 0.2.11
+Version: 0.2.9
 Summary: Fork of CTransformers to support Langdash functions.
 Home-page: https://git.mysymphony.jp.net/nana/ctransformers
 Author: Nana Mochizuki
 Author-email: nana@mysymphony.jp.net
 License: MIT
 Keywords: ctransformers transformers ai llm
 Classifier: Development Status :: 1 - Planning
@@ -38,25 +38,23 @@
   - [LangChain](#langchain)
   - [GPU](#gpu)
 - [Documentation](#documentation)
 - [License](#license)
 
 ## Supported Models
 
-| Models                | Model Type  |
-| :-------------------- | ----------- |
-| GPT-2                 | `gpt2`      |
-| GPT-J, GPT4All-J      | `gptj`      |
-| GPT-NeoX, StableLM    | `gpt_neox`  |
-| LLaMA                 | `llama`     |
-| MPT                   | `mpt`       |
-| Dolly V2              | `dolly-v2`  |
-| Replit                | `replit`    |
-| StarCoder, StarChat   | `starcoder` |
-| Falcon (Experimental) | `falcon`    |
+| Models              | Model Type  |
+| :------------------ | ----------- |
+| GPT-2               | `gpt2`      |
+| GPT-J, GPT4All-J    | `gptj`      |
+| GPT-NeoX, StableLM  | `gpt_neox`  |
+| LLaMA               | `llama`     |
+| MPT                 | `mpt`       |
+| Dolly V2            | `dolly-v2`  |
+| StarCoder, StarChat | `starcoder` |
 
 ## Installation
 
 ```sh
 pip install ctransformers
 ```
 
@@ -155,15 +153,15 @@
 
 You can also specify additional parameters under `task_specific_params.text-generation`.
 
 See [marella/gpt-2-ggml](https://huggingface.co/marella/gpt-2-ggml/blob/main/config.json) for a minimal example and [marella/gpt-2-ggml-example](https://huggingface.co/marella/gpt-2-ggml-example/blob/main/config.json) for a full example.
 
 ### LangChain
 
-It is integrated into LangChain. See [LangChain docs](https://python.langchain.com/docs/ecosystem/integrations/ctransformers).
+It is integrated into LangChain. See [LangChain docs](https://python.langchain.com/en/latest/integrations/ctransformers.html).
 
 ### GPU
 
 > **Note:** Currently only LLaMA models have GPU support.
 
 To run some of the model layers on GPU, set the `gpu_layers` parameter:
```

### Comparing `ctransformers-langdash-0.2.11/README.md` & `ctransformers-langdash-0.2.9/README.md`

 * *Files 1% similar despite different names*

```diff
@@ -13,25 +13,23 @@
   - [LangChain](#langchain)
   - [GPU](#gpu)
 - [Documentation](#documentation)
 - [License](#license)
 
 ## Supported Models
 
-| Models                | Model Type  |
-| :-------------------- | ----------- |
-| GPT-2                 | `gpt2`      |
-| GPT-J, GPT4All-J      | `gptj`      |
-| GPT-NeoX, StableLM    | `gpt_neox`  |
-| LLaMA                 | `llama`     |
-| MPT                   | `mpt`       |
-| Dolly V2              | `dolly-v2`  |
-| Replit                | `replit`    |
-| StarCoder, StarChat   | `starcoder` |
-| Falcon (Experimental) | `falcon`    |
+| Models              | Model Type  |
+| :------------------ | ----------- |
+| GPT-2               | `gpt2`      |
+| GPT-J, GPT4All-J    | `gptj`      |
+| GPT-NeoX, StableLM  | `gpt_neox`  |
+| LLaMA               | `llama`     |
+| MPT                 | `mpt`       |
+| Dolly V2            | `dolly-v2`  |
+| StarCoder, StarChat | `starcoder` |
 
 ## Installation
 
 ```sh
 pip install ctransformers
 ```
 
@@ -130,15 +128,15 @@
 
 You can also specify additional parameters under `task_specific_params.text-generation`.
 
 See [marella/gpt-2-ggml](https://huggingface.co/marella/gpt-2-ggml/blob/main/config.json) for a minimal example and [marella/gpt-2-ggml-example](https://huggingface.co/marella/gpt-2-ggml-example/blob/main/config.json) for a full example.
 
 ### LangChain
 
-It is integrated into LangChain. See [LangChain docs](https://python.langchain.com/docs/ecosystem/integrations/ctransformers).
+It is integrated into LangChain. See [LangChain docs](https://python.langchain.com/en/latest/integrations/ctransformers.html).
 
 ### GPU
 
 > **Note:** Currently only LLaMA models have GPU support.
 
 To run some of the model layers on GPU, set the `gpu_layers` parameter:
```

### Comparing `ctransformers-langdash-0.2.11/ctransformers/hub.py` & `ctransformers-langdash-0.2.9/ctransformers/hub.py`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/ctransformers/langchain.py` & `ctransformers-langdash-0.2.9/ctransformers/langchain.py`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/ctransformers/lib.py` & `ctransformers-langdash-0.2.9/ctransformers/lib.py`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/ctransformers/llm.py` & `ctransformers-langdash-0.2.9/ctransformers/llm.py`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/ctransformers/utils.py` & `ctransformers-langdash-0.2.9/ctransformers/utils.py`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/ctransformers_langdash.egg-info/PKG-INFO` & `ctransformers-langdash-0.2.9/ctransformers_langdash.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ctransformers-langdash
-Version: 0.2.11
+Version: 0.2.9
 Summary: Fork of CTransformers to support Langdash functions.
 Home-page: https://git.mysymphony.jp.net/nana/ctransformers
 Author: Nana Mochizuki
 Author-email: nana@mysymphony.jp.net
 License: MIT
 Keywords: ctransformers transformers ai llm
 Classifier: Development Status :: 1 - Planning
@@ -38,25 +38,23 @@
   - [LangChain](#langchain)
   - [GPU](#gpu)
 - [Documentation](#documentation)
 - [License](#license)
 
 ## Supported Models
 
-| Models                | Model Type  |
-| :-------------------- | ----------- |
-| GPT-2                 | `gpt2`      |
-| GPT-J, GPT4All-J      | `gptj`      |
-| GPT-NeoX, StableLM    | `gpt_neox`  |
-| LLaMA                 | `llama`     |
-| MPT                   | `mpt`       |
-| Dolly V2              | `dolly-v2`  |
-| Replit                | `replit`    |
-| StarCoder, StarChat   | `starcoder` |
-| Falcon (Experimental) | `falcon`    |
+| Models              | Model Type  |
+| :------------------ | ----------- |
+| GPT-2               | `gpt2`      |
+| GPT-J, GPT4All-J    | `gptj`      |
+| GPT-NeoX, StableLM  | `gpt_neox`  |
+| LLaMA               | `llama`     |
+| MPT                 | `mpt`       |
+| Dolly V2            | `dolly-v2`  |
+| StarCoder, StarChat | `starcoder` |
 
 ## Installation
 
 ```sh
 pip install ctransformers
 ```
 
@@ -155,15 +153,15 @@
 
 You can also specify additional parameters under `task_specific_params.text-generation`.
 
 See [marella/gpt-2-ggml](https://huggingface.co/marella/gpt-2-ggml/blob/main/config.json) for a minimal example and [marella/gpt-2-ggml-example](https://huggingface.co/marella/gpt-2-ggml-example/blob/main/config.json) for a full example.
 
 ### LangChain
 
-It is integrated into LangChain. See [LangChain docs](https://python.langchain.com/docs/ecosystem/integrations/ctransformers).
+It is integrated into LangChain. See [LangChain docs](https://python.langchain.com/en/latest/integrations/ctransformers.html).
 
 ### GPU
 
 > **Note:** Currently only LLaMA models have GPU support.
 
 To run some of the model layers on GPU, set the `gpu_layers` parameter:
```

### Comparing `ctransformers-langdash-0.2.11/ctransformers_langdash.egg-info/SOURCES.txt` & `ctransformers-langdash-0.2.9/ctransformers_langdash.egg-info/SOURCES.txt`

 * *Files 22% similar despite different names*

```diff
@@ -21,33 +21,27 @@
 ctransformers_langdash.egg-info/requires.txt
 ctransformers_langdash.egg-info/top_level.txt
 models/common.h
 models/llm.cc
 models/llm.h
 models/ggml/ggml-cuda.cu
 models/ggml/ggml-cuda.h
-models/ggml/ggml-ggllm.c
-models/ggml/ggml-ggllm.h
 models/ggml/ggml.c
 models/ggml/ggml.h
 models/ggml/k_quants.c
 models/ggml/k_quants.h
-models/ggml/libfalcon.cpp
-models/ggml/libfalcon.h
 models/ggml/llama-util.h
 models/ggml/llama.cpp
 models/ggml/llama.h
 models/llms/dolly.cc
-models/llms/falcon.cc
 models/llms/gpt-neox.cc
 models/llms/gpt2.cc
 models/llms/gptj.cc
 models/llms/llama.cc
 models/llms/mpt.cc
-models/llms/replit.cc
 models/llms/starcoder.cc
 scripts/build.sh
 scripts/docs.py
 scripts/release.sh
 scripts/sync.sh
 tests/__init__.py
 tests/conftest.py
```

### Comparing `ctransformers-langdash-0.2.11/models/common.h` & `ctransformers-langdash-0.2.9/models/common.h`

 * *Files 1% similar despite different names*

```diff
@@ -10,15 +10,14 @@
 #include <locale>
 #include <map>
 #include <queue>
 #include <random>
 #include <regex>
 #include <string>
 #include <thread>
-#include <unordered_map>
 #include <unordered_set>
 #include <vector>
 
 #include "ggml/ggml.h"
 
 // https://github.com/ggerganov/ggml/blob/master/examples/common.cpp
```

### Comparing `ctransformers-langdash-0.2.11/models/ggml/ggml-cuda.cu` & `ctransformers-langdash-0.2.9/models/ggml/ggml-cuda.cu`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/ggml/ggml-cuda.h` & `ctransformers-langdash-0.2.9/models/ggml/ggml-cuda.h`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/ggml/ggml.c` & `ctransformers-langdash-0.2.9/models/ggml/ggml.c`

 * *Files 0% similar despite different names*

```diff
@@ -8079,28736 +8079,28713 @@
 0001f8e0: 4449 5622 2c0a 2020 2020 2253 5152 222c  DIV",.    "SQR",
 0001f8f0: 0a20 2020 2022 5351 5254 222c 0a20 2020  .    "SQRT",.   
 0001f900: 2022 4c4f 4722 2c0a 2020 2020 2253 554d   "LOG",.    "SUM
 0001f910: 222c 0a20 2020 2022 5355 4d5f 524f 5753  ",.    "SUM_ROWS
 0001f920: 222c 0a20 2020 2022 4d45 414e 222c 0a20  ",.    "MEAN",. 
 0001f930: 2020 2022 5245 5045 4154 222c 0a20 2020     "REPEAT",.   
 0001f940: 2022 5245 5045 4154 5f42 4143 4b22 2c0a   "REPEAT_BACK",.
-0001f950: 2020 2020 2252 4550 4541 5432 222c 0a20      "REPEAT2",. 
-0001f960: 2020 2022 4142 5322 2c0a 2020 2020 2253     "ABS",.    "S
-0001f970: 474e 222c 0a20 2020 2022 4e45 4722 2c0a  GN",.    "NEG",.
-0001f980: 2020 2020 2253 5445 5022 2c0a 2020 2020      "STEP",.    
-0001f990: 2252 454c 5522 2c0a 2020 2020 2247 454c  "RELU",.    "GEL
-0001f9a0: 5522 2c0a 2020 2020 2253 494c 5522 2c0a  U",.    "SILU",.
-0001f9b0: 2020 2020 2253 494c 555f 4241 434b 222c      "SILU_BACK",
-0001f9c0: 0a20 2020 2022 4e4f 524d 222c 0a20 2020  .    "NORM",.   
-0001f9d0: 2022 524d 535f 4e4f 524d 222c 0a20 2020   "RMS_NORM",.   
-0001f9e0: 2022 524d 535f 4e4f 524d 5f42 4143 4b22   "RMS_NORM_BACK"
-0001f9f0: 2c0a 0a20 2020 2022 4d55 4c5f 4d41 5422  ,..    "MUL_MAT"
-0001fa00: 2c0a 2020 2020 224f 5554 5f50 524f 4422  ,.    "OUT_PROD"
-0001fa10: 2c0a 0a20 2020 2022 5343 414c 4522 2c0a  ,..    "SCALE",.
-0001fa20: 2020 2020 2253 4554 222c 0a20 2020 2022      "SET",.    "
-0001fa30: 4350 5922 2c0a 2020 2020 2243 4f4e 5422  CPY",.    "CONT"
-0001fa40: 2c0a 2020 2020 2252 4553 4841 5045 222c  ,.    "RESHAPE",
-0001fa50: 0a20 2020 2022 5649 4557 222c 0a20 2020  .    "VIEW",.   
-0001fa60: 2022 5045 524d 5554 4522 2c0a 2020 2020   "PERMUTE",.    
-0001fa70: 2254 5241 4e53 504f 5345 222c 0a20 2020  "TRANSPOSE",.   
-0001fa80: 2022 4745 545f 524f 5753 222c 0a20 2020   "GET_ROWS",.   
-0001fa90: 2022 4745 545f 524f 5753 5f42 4143 4b22   "GET_ROWS_BACK"
-0001faa0: 2c0a 2020 2020 2244 4941 4722 2c0a 2020  ,.    "DIAG",.  
-0001fab0: 2020 2244 4941 475f 4d41 534b 5f49 4e46    "DIAG_MASK_INF
-0001fac0: 222c 0a20 2020 2022 4449 4147 5f4d 4153  ",.    "DIAG_MAS
-0001fad0: 4b5f 5a45 524f 222c 0a20 2020 2022 534f  K_ZERO",.    "SO
-0001fae0: 4654 5f4d 4158 222c 0a20 2020 2022 534f  FT_MAX",.    "SO
-0001faf0: 4654 5f4d 4158 5f42 4143 4b22 2c0a 2020  FT_MAX_BACK",.  
-0001fb00: 2020 2252 4f50 4522 2c0a 2020 2020 2252    "ROPE",.    "R
-0001fb10: 4f50 455f 4241 434b 222c 0a20 2020 2022  OPE_BACK",.    "
-0001fb20: 414c 4942 4922 2c0a 2020 2020 2243 4c41  ALIBI",.    "CLA
-0001fb30: 4d50 222c 0a20 2020 2022 434f 4e56 5f31  MP",.    "CONV_1
-0001fb40: 445f 3153 222c 0a20 2020 2022 434f 4e56  D_1S",.    "CONV
-0001fb50: 5f31 445f 3253 222c 0a0a 2020 2020 2246  _1D_2S",..    "F
-0001fb60: 4c41 5348 5f41 5454 4e22 2c0a 2020 2020  LASH_ATTN",.    
-0001fb70: 2246 4c41 5348 5f46 4622 2c0a 2020 2020  "FLASH_FF",.    
-0001fb80: 2246 4c41 5348 5f41 5454 4e5f 4241 434b  "FLASH_ATTN_BACK
-0001fb90: 222c 0a0a 2020 2020 224d 4150 5f55 4e41  ",..    "MAP_UNA
-0001fba0: 5259 222c 0a20 2020 2022 4d41 505f 4249  RY",.    "MAP_BI
-0001fbb0: 4e41 5259 222c 0a0a 2020 2020 2243 524f  NARY",..    "CRO
-0001fbc0: 5353 5f45 4e54 524f 5059 5f4c 4f53 5322  SS_ENTROPY_LOSS"
-0001fbd0: 2c0a 2020 2020 2243 524f 5353 5f45 4e54  ,.    "CROSS_ENT
-0001fbe0: 524f 5059 5f4c 4f53 535f 4241 434b 222c  ROPY_LOSS_BACK",
-0001fbf0: 0a7d 3b0a 0a73 7461 7469 635f 6173 7365  .};..static_asse
-0001fc00: 7274 2847 474d 4c5f 4f50 5f43 4f55 4e54  rt(GGML_OP_COUNT
-0001fc10: 203d 3d20 3538 2c20 2247 474d 4c5f 4f50   == 58, "GGML_OP
-0001fc20: 5f43 4f55 4e54 2021 3d20 3538 2229 3b0a  _COUNT != 58");.
-0001fc30: 0a73 7461 7469 6320 636f 6e73 7420 6368  .static const ch
-0001fc40: 6172 202a 2047 474d 4c5f 4f50 5f53 594d  ar * GGML_OP_SYM
-0001fc50: 424f 4c5b 4747 4d4c 5f4f 505f 434f 554e  BOL[GGML_OP_COUN
-0001fc60: 545d 203d 207b 0a20 2020 2022 6e6f 6e65  T] = {.    "none
-0001fc70: 222c 0a0a 2020 2020 2278 222c 0a20 2020  ",..    "x",.   
-0001fc80: 2022 782b 7922 2c0a 2020 2020 2278 2b79   "x+y",.    "x+y
-0001fc90: 222c 0a20 2020 2022 7669 6577 2878 2c6e  ",.    "view(x,n
-0001fca0: 622c 6f66 6673 6574 292b 3d79 2d3e 7822  b,offset)+=y->x"
-0001fcb0: 2c0a 2020 2020 2278 2d79 222c 0a20 2020  ,.    "x-y",.   
-0001fcc0: 2022 782a 7922 2c0a 2020 2020 2278 2f79   "x*y",.    "x/y
-0001fcd0: 222c 0a20 2020 2022 785e 3222 2c0a 2020  ",.    "x^2",.  
-0001fce0: 2020 22e2 889a 7822 2c0a 2020 2020 226c    "...x",.    "l
-0001fcf0: 6f67 2878 2922 2c0a 2020 2020 22ce a378  og(x)",.    "..x
-0001fd00: 222c 0a20 2020 2022 cea3 785f 6b22 2c0a  ",.    "..x_k",.
-0001fd10: 2020 2020 22ce a378 2f6e 222c 0a20 2020      "..x/n",.   
-0001fd20: 2022 7265 7065 6174 2878 2922 2c0a 2020   "repeat(x)",.  
-0001fd30: 2020 2272 6570 6561 745f 6261 636b 2878    "repeat_back(x
-0001fd40: 2922 2c0a 2020 2020 2272 6570 6561 7432  )",.    "repeat2
-0001fd50: 2878 2922 2c0a 2020 2020 2261 6273 2878  (x)",.    "abs(x
-0001fd60: 2922 2c0a 2020 2020 2273 676e 2878 2922  )",.    "sgn(x)"
-0001fd70: 2c0a 2020 2020 222d 7822 2c0a 2020 2020  ,.    "-x",.    
-0001fd80: 2273 7465 7028 7829 222c 0a20 2020 2022  "step(x)",.    "
-0001fd90: 7265 6c75 2878 2922 2c0a 2020 2020 2267  relu(x)",.    "g
-0001fda0: 656c 7528 7829 222c 0a20 2020 2022 7369  elu(x)",.    "si
-0001fdb0: 6c75 2878 2922 2c0a 2020 2020 2273 696c  lu(x)",.    "sil
-0001fdc0: 755f 6261 636b 2878 2922 2c0a 2020 2020  u_back(x)",.    
-0001fdd0: 226e 6f72 6d28 7829 222c 0a20 2020 2022  "norm(x)",.    "
-0001fde0: 726d 735f 6e6f 726d 2878 2922 2c0a 2020  rms_norm(x)",.  
-0001fdf0: 2020 2272 6d73 5f6e 6f72 6d5f 6261 636b    "rms_norm_back
-0001fe00: 2878 2922 2c0a 0a20 2020 2022 582a 5922  (x)",..    "X*Y"
-0001fe10: 2c0a 2020 2020 2258 2a59 222c 0a0a 2020  ,.    "X*Y",..  
-0001fe20: 2020 2278 2a76 222c 0a20 2020 2022 792d    "x*v",.    "y-
-0001fe30: 5c5c 3e76 6965 7728 7829 222c 0a20 2020  \\>view(x)",.   
-0001fe40: 2022 782d 5c5c 3e79 222c 0a20 2020 2022   "x-\\>y",.    "
-0001fe50: 636f 6e74 2878 2922 2c0a 2020 2020 2272  cont(x)",.    "r
-0001fe60: 6573 6861 7065 2878 2922 2c0a 2020 2020  eshape(x)",.    
-0001fe70: 2276 6965 7728 7829 222c 0a20 2020 2022  "view(x)",.    "
-0001fe80: 7065 726d 7574 6528 7829 222c 0a20 2020  permute(x)",.   
-0001fe90: 2022 7472 616e 7370 6f73 6528 7829 222c   "transpose(x)",
-0001fea0: 0a20 2020 2022 6765 745f 726f 7773 2878  .    "get_rows(x
-0001feb0: 2922 2c0a 2020 2020 2267 6574 5f72 6f77  )",.    "get_row
-0001fec0: 735f 6261 636b 2878 2922 2c0a 2020 2020  s_back(x)",.    
-0001fed0: 2264 6961 6728 7829 222c 0a20 2020 2022  "diag(x)",.    "
-0001fee0: 6469 6167 5f6d 6173 6b5f 696e 6628 7829  diag_mask_inf(x)
-0001fef0: 222c 0a20 2020 2022 6469 6167 5f6d 6173  ",.    "diag_mas
-0001ff00: 6b5f 7a65 726f 2878 2922 2c0a 2020 2020  k_zero(x)",.    
-0001ff10: 2273 6f66 745f 6d61 7828 7829 222c 0a20  "soft_max(x)",. 
-0001ff20: 2020 2022 736f 6674 5f6d 6178 5f62 6163     "soft_max_bac
-0001ff30: 6b28 7829 222c 0a20 2020 2022 726f 7065  k(x)",.    "rope
-0001ff40: 2878 2922 2c0a 2020 2020 2272 6f70 655f  (x)",.    "rope_
-0001ff50: 6261 636b 2878 2922 2c0a 2020 2020 2261  back(x)",.    "a
-0001ff60: 6c69 6269 2878 2922 2c0a 2020 2020 2263  libi(x)",.    "c
-0001ff70: 6c61 6d70 2878 2922 2c0a 2020 2020 2263  lamp(x)",.    "c
-0001ff80: 6f6e 765f 3164 5f31 7328 7829 222c 0a20  onv_1d_1s(x)",. 
-0001ff90: 2020 2022 636f 6e76 5f31 645f 3273 2878     "conv_1d_2s(x
-0001ffa0: 2922 2c0a 0a20 2020 2022 666c 6173 685f  )",..    "flash_
-0001ffb0: 6174 746e 2878 2922 2c0a 2020 2020 2266  attn(x)",.    "f
-0001ffc0: 6c61 7368 5f66 6628 7829 222c 0a20 2020  lash_ff(x)",.   
-0001ffd0: 2022 666c 6173 685f 6174 746e 5f62 6163   "flash_attn_bac
-0001ffe0: 6b28 7829 222c 0a0a 2020 2020 2266 2878  k(x)",..    "f(x
-0001fff0: 2922 2c0a 2020 2020 2266 2878 2c79 2922  )",.    "f(x,y)"
-00020000: 2c0a 0a20 2020 2022 6372 6f73 735f 656e  ,..    "cross_en
-00020010: 7472 6f70 795f 6c6f 7373 2878 2c79 2922  tropy_loss(x,y)"
-00020020: 2c0a 2020 2020 2263 726f 7373 5f65 6e74  ,.    "cross_ent
-00020030: 726f 7079 5f6c 6f73 735f 6261 636b 2878  ropy_loss_back(x
-00020040: 2c79 2922 2c0a 7d3b 0a0a 7374 6174 6963  ,y)",.};..static
-00020050: 5f61 7373 6572 7428 4747 4d4c 5f4f 505f  _assert(GGML_OP_
-00020060: 434f 554e 5420 3d3d 2035 382c 2022 4747  COUNT == 58, "GG
-00020070: 4d4c 5f4f 505f 434f 554e 5420 213d 2035  ML_OP_COUNT != 5
-00020080: 3822 293b 0a0a 7374 6174 6963 5f61 7373  8");..static_ass
-00020090: 6572 7428 7369 7a65 6f66 2873 7472 7563  ert(sizeof(struc
-000200a0: 7420 6767 6d6c 5f6f 626a 6563 7429 2547  t ggml_object)%G
-000200b0: 474d 4c5f 4d45 4d5f 414c 4947 4e20 3d3d  GML_MEM_ALIGN ==
-000200c0: 2030 2c20 2267 676d 6c5f 6f62 6a65 6374   0, "ggml_object
-000200d0: 2073 697a 6520 6d75 7374 2062 6520 6120   size must be a 
-000200e0: 6d75 6c74 6970 6c65 206f 6620 4747 4d4c  multiple of GGML
-000200f0: 5f4d 454d 5f41 4c49 474e 2229 3b0a 7374  _MEM_ALIGN");.st
-00020100: 6174 6963 5f61 7373 6572 7428 7369 7a65  atic_assert(size
-00020110: 6f66 2873 7472 7563 7420 6767 6d6c 5f74  of(struct ggml_t
-00020120: 656e 736f 7229 2547 474d 4c5f 4d45 4d5f  ensor)%GGML_MEM_
-00020130: 414c 4947 4e20 3d3d 2030 2c20 2267 676d  ALIGN == 0, "ggm
-00020140: 6c5f 7465 6e73 6f72 2073 697a 6520 6d75  l_tensor size mu
-00020150: 7374 2062 6520 6120 6d75 6c74 6970 6c65  st be a multiple
-00020160: 206f 6620 4747 4d4c 5f4d 454d 5f41 4c49   of GGML_MEM_ALI
-00020170: 474e 2229 3b0a 0a2f 2f0a 2f2f 2067 676d  GN");..//.// ggm
-00020180: 6c20 636f 6e74 6578 740a 2f2f 0a0a 7374  l context.//..st
-00020190: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-000201a0: 7420 7b0a 2020 2020 7369 7a65 5f74 206d  t {.    size_t m
-000201b0: 656d 5f73 697a 653b 0a20 2020 2076 6f69  em_size;.    voi
-000201c0: 6420 2a20 6d65 6d5f 6275 6666 6572 3b0a  d * mem_buffer;.
-000201d0: 2020 2020 626f 6f6c 2020 206d 656d 5f62      bool   mem_b
-000201e0: 7566 6665 725f 6f77 6e65 643b 0a20 2020  uffer_owned;.   
-000201f0: 2062 6f6f 6c20 2020 6e6f 5f61 6c6c 6f63   bool   no_alloc
-00020200: 3b0a 2020 2020 626f 6f6c 2020 206e 6f5f  ;.    bool   no_
-00020210: 616c 6c6f 635f 7361 7665 3b20 2f2f 2074  alloc_save; // t
-00020220: 6869 7320 6973 2075 7365 6420 746f 2073  his is used to s
-00020230: 6176 6520 7468 6520 6e6f 5f61 6c6c 6f63  ave the no_alloc
-00020240: 2073 7461 7465 2077 6865 6e20 7573 696e   state when usin
-00020250: 6720 7363 7261 7463 6820 6275 6666 6572  g scratch buffer
-00020260: 730a 0a20 2020 2069 6e74 2020 2020 6e5f  s..    int    n_
-00020270: 6f62 6a65 6374 733b 0a0a 2020 2020 7374  objects;..    st
-00020280: 7275 6374 2067 676d 6c5f 6f62 6a65 6374  ruct ggml_object
-00020290: 202a 206f 626a 6563 7473 5f62 6567 696e   * objects_begin
-000202a0: 3b0a 2020 2020 7374 7275 6374 2067 676d  ;.    struct ggm
-000202b0: 6c5f 6f62 6a65 6374 202a 206f 626a 6563  l_object * objec
-000202c0: 7473 5f65 6e64 3b0a 0a20 2020 2073 7472  ts_end;..    str
+0001f950: 2020 2020 2241 4253 222c 0a20 2020 2022      "ABS",.    "
+0001f960: 5347 4e22 2c0a 2020 2020 224e 4547 222c  SGN",.    "NEG",
+0001f970: 0a20 2020 2022 5354 4550 222c 0a20 2020  .    "STEP",.   
+0001f980: 2022 5245 4c55 222c 0a20 2020 2022 4745   "RELU",.    "GE
+0001f990: 4c55 222c 0a20 2020 2022 5349 4c55 222c  LU",.    "SILU",
+0001f9a0: 0a20 2020 2022 5349 4c55 5f42 4143 4b22  .    "SILU_BACK"
+0001f9b0: 2c0a 2020 2020 224e 4f52 4d22 2c0a 2020  ,.    "NORM",.  
+0001f9c0: 2020 2252 4d53 5f4e 4f52 4d22 2c0a 2020    "RMS_NORM",.  
+0001f9d0: 2020 2252 4d53 5f4e 4f52 4d5f 4241 434b    "RMS_NORM_BACK
+0001f9e0: 222c 0a0a 2020 2020 224d 554c 5f4d 4154  ",..    "MUL_MAT
+0001f9f0: 222c 0a20 2020 2022 4f55 545f 5052 4f44  ",.    "OUT_PROD
+0001fa00: 222c 0a0a 2020 2020 2253 4341 4c45 222c  ",..    "SCALE",
+0001fa10: 0a20 2020 2022 5345 5422 2c0a 2020 2020  .    "SET",.    
+0001fa20: 2243 5059 222c 0a20 2020 2022 434f 4e54  "CPY",.    "CONT
+0001fa30: 222c 0a20 2020 2022 5245 5348 4150 4522  ",.    "RESHAPE"
+0001fa40: 2c0a 2020 2020 2256 4945 5722 2c0a 2020  ,.    "VIEW",.  
+0001fa50: 2020 2250 4552 4d55 5445 222c 0a20 2020    "PERMUTE",.   
+0001fa60: 2022 5452 414e 5350 4f53 4522 2c0a 2020   "TRANSPOSE",.  
+0001fa70: 2020 2247 4554 5f52 4f57 5322 2c0a 2020    "GET_ROWS",.  
+0001fa80: 2020 2247 4554 5f52 4f57 535f 4241 434b    "GET_ROWS_BACK
+0001fa90: 222c 0a20 2020 2022 4449 4147 222c 0a20  ",.    "DIAG",. 
+0001faa0: 2020 2022 4449 4147 5f4d 4153 4b5f 494e     "DIAG_MASK_IN
+0001fab0: 4622 2c0a 2020 2020 2244 4941 475f 4d41  F",.    "DIAG_MA
+0001fac0: 534b 5f5a 4552 4f22 2c0a 2020 2020 2253  SK_ZERO",.    "S
+0001fad0: 4f46 545f 4d41 5822 2c0a 2020 2020 2253  OFT_MAX",.    "S
+0001fae0: 4f46 545f 4d41 585f 4241 434b 222c 0a20  OFT_MAX_BACK",. 
+0001faf0: 2020 2022 524f 5045 222c 0a20 2020 2022     "ROPE",.    "
+0001fb00: 524f 5045 5f42 4143 4b22 2c0a 2020 2020  ROPE_BACK",.    
+0001fb10: 2241 4c49 4249 222c 0a20 2020 2022 434c  "ALIBI",.    "CL
+0001fb20: 414d 5022 2c0a 2020 2020 2243 4f4e 565f  AMP",.    "CONV_
+0001fb30: 3144 5f31 5322 2c0a 2020 2020 2243 4f4e  1D_1S",.    "CON
+0001fb40: 565f 3144 5f32 5322 2c0a 0a20 2020 2022  V_1D_2S",..    "
+0001fb50: 464c 4153 485f 4154 544e 222c 0a20 2020  FLASH_ATTN",.   
+0001fb60: 2022 464c 4153 485f 4646 222c 0a20 2020   "FLASH_FF",.   
+0001fb70: 2022 464c 4153 485f 4154 544e 5f42 4143   "FLASH_ATTN_BAC
+0001fb80: 4b22 2c0a 0a20 2020 2022 4d41 505f 554e  K",..    "MAP_UN
+0001fb90: 4152 5922 2c0a 2020 2020 224d 4150 5f42  ARY",.    "MAP_B
+0001fba0: 494e 4152 5922 2c0a 0a20 2020 2022 4352  INARY",..    "CR
+0001fbb0: 4f53 535f 454e 5452 4f50 595f 4c4f 5353  OSS_ENTROPY_LOSS
+0001fbc0: 222c 0a20 2020 2022 4352 4f53 535f 454e  ",.    "CROSS_EN
+0001fbd0: 5452 4f50 595f 4c4f 5353 5f42 4143 4b22  TROPY_LOSS_BACK"
+0001fbe0: 2c0a 7d3b 0a0a 7374 6174 6963 5f61 7373  ,.};..static_ass
+0001fbf0: 6572 7428 4747 4d4c 5f4f 505f 434f 554e  ert(GGML_OP_COUN
+0001fc00: 5420 3d3d 2035 372c 2022 4747 4d4c 5f4f  T == 57, "GGML_O
+0001fc10: 505f 434f 554e 5420 213d 2035 3722 293b  P_COUNT != 57");
+0001fc20: 0a0a 7374 6174 6963 2063 6f6e 7374 2063  ..static const c
+0001fc30: 6861 7220 2a20 4747 4d4c 5f4f 505f 5359  har * GGML_OP_SY
+0001fc40: 4d42 4f4c 5b47 474d 4c5f 4f50 5f43 4f55  MBOL[GGML_OP_COU
+0001fc50: 4e54 5d20 3d20 7b0a 2020 2020 226e 6f6e  NT] = {.    "non
+0001fc60: 6522 2c0a 0a20 2020 2022 7822 2c0a 2020  e",..    "x",.  
+0001fc70: 2020 2278 2b79 222c 0a20 2020 2022 782b    "x+y",.    "x+
+0001fc80: 7922 2c0a 2020 2020 2276 6965 7728 782c  y",.    "view(x,
+0001fc90: 6e62 2c6f 6666 7365 7429 2b3d 792d 3e78  nb,offset)+=y->x
+0001fca0: 222c 0a20 2020 2022 782d 7922 2c0a 2020  ",.    "x-y",.  
+0001fcb0: 2020 2278 2a79 222c 0a20 2020 2022 782f    "x*y",.    "x/
+0001fcc0: 7922 2c0a 2020 2020 2278 5e32 222c 0a20  y",.    "x^2",. 
+0001fcd0: 2020 2022 e288 9a78 222c 0a20 2020 2022     "...x",.    "
+0001fce0: 6c6f 6728 7829 222c 0a20 2020 2022 cea3  log(x)",.    "..
+0001fcf0: 7822 2c0a 2020 2020 22ce a378 5f6b 222c  x",.    "..x_k",
+0001fd00: 0a20 2020 2022 cea3 782f 6e22 2c0a 2020  .    "..x/n",.  
+0001fd10: 2020 2272 6570 6561 7428 7829 222c 0a20    "repeat(x)",. 
+0001fd20: 2020 2022 7265 7065 6174 5f62 6163 6b28     "repeat_back(
+0001fd30: 7829 222c 0a20 2020 2022 6162 7328 7829  x)",.    "abs(x)
+0001fd40: 222c 0a20 2020 2022 7367 6e28 7829 222c  ",.    "sgn(x)",
+0001fd50: 0a20 2020 2022 2d78 222c 0a20 2020 2022  .    "-x",.    "
+0001fd60: 7374 6570 2878 2922 2c0a 2020 2020 2272  step(x)",.    "r
+0001fd70: 656c 7528 7829 222c 0a20 2020 2022 6765  elu(x)",.    "ge
+0001fd80: 6c75 2878 2922 2c0a 2020 2020 2273 696c  lu(x)",.    "sil
+0001fd90: 7528 7829 222c 0a20 2020 2022 7369 6c75  u(x)",.    "silu
+0001fda0: 5f62 6163 6b28 7829 222c 0a20 2020 2022  _back(x)",.    "
+0001fdb0: 6e6f 726d 2878 2922 2c0a 2020 2020 2272  norm(x)",.    "r
+0001fdc0: 6d73 5f6e 6f72 6d28 7829 222c 0a20 2020  ms_norm(x)",.   
+0001fdd0: 2022 726d 735f 6e6f 726d 5f62 6163 6b28   "rms_norm_back(
+0001fde0: 7829 222c 0a0a 2020 2020 2258 2a59 222c  x)",..    "X*Y",
+0001fdf0: 0a20 2020 2022 582a 5922 2c0a 0a20 2020  .    "X*Y",..   
+0001fe00: 2022 782a 7622 2c0a 2020 2020 2279 2d5c   "x*v",.    "y-\
+0001fe10: 5c3e 7669 6577 2878 2922 2c0a 2020 2020  \>view(x)",.    
+0001fe20: 2278 2d5c 5c3e 7922 2c0a 2020 2020 2263  "x-\\>y",.    "c
+0001fe30: 6f6e 7428 7829 222c 0a20 2020 2022 7265  ont(x)",.    "re
+0001fe40: 7368 6170 6528 7829 222c 0a20 2020 2022  shape(x)",.    "
+0001fe50: 7669 6577 2878 2922 2c0a 2020 2020 2270  view(x)",.    "p
+0001fe60: 6572 6d75 7465 2878 2922 2c0a 2020 2020  ermute(x)",.    
+0001fe70: 2274 7261 6e73 706f 7365 2878 2922 2c0a  "transpose(x)",.
+0001fe80: 2020 2020 2267 6574 5f72 6f77 7328 7829      "get_rows(x)
+0001fe90: 222c 0a20 2020 2022 6765 745f 726f 7773  ",.    "get_rows
+0001fea0: 5f62 6163 6b28 7829 222c 0a20 2020 2022  _back(x)",.    "
+0001feb0: 6469 6167 2878 2922 2c0a 2020 2020 2264  diag(x)",.    "d
+0001fec0: 6961 675f 6d61 736b 5f69 6e66 2878 2922  iag_mask_inf(x)"
+0001fed0: 2c0a 2020 2020 2264 6961 675f 6d61 736b  ,.    "diag_mask
+0001fee0: 5f7a 6572 6f28 7829 222c 0a20 2020 2022  _zero(x)",.    "
+0001fef0: 736f 6674 5f6d 6178 2878 2922 2c0a 2020  soft_max(x)",.  
+0001ff00: 2020 2273 6f66 745f 6d61 785f 6261 636b    "soft_max_back
+0001ff10: 2878 2922 2c0a 2020 2020 2272 6f70 6528  (x)",.    "rope(
+0001ff20: 7829 222c 0a20 2020 2022 726f 7065 5f62  x)",.    "rope_b
+0001ff30: 6163 6b28 7829 222c 0a20 2020 2022 616c  ack(x)",.    "al
+0001ff40: 6962 6928 7829 222c 0a20 2020 2022 636c  ibi(x)",.    "cl
+0001ff50: 616d 7028 7829 222c 0a20 2020 2022 636f  amp(x)",.    "co
+0001ff60: 6e76 5f31 645f 3173 2878 2922 2c0a 2020  nv_1d_1s(x)",.  
+0001ff70: 2020 2263 6f6e 765f 3164 5f32 7328 7829    "conv_1d_2s(x)
+0001ff80: 222c 0a0a 2020 2020 2266 6c61 7368 5f61  ",..    "flash_a
+0001ff90: 7474 6e28 7829 222c 0a20 2020 2022 666c  ttn(x)",.    "fl
+0001ffa0: 6173 685f 6666 2878 2922 2c0a 2020 2020  ash_ff(x)",.    
+0001ffb0: 2266 6c61 7368 5f61 7474 6e5f 6261 636b  "flash_attn_back
+0001ffc0: 2878 2922 2c0a 0a20 2020 2022 6628 7829  (x)",..    "f(x)
+0001ffd0: 222c 0a20 2020 2022 6628 782c 7929 222c  ",.    "f(x,y)",
+0001ffe0: 0a0a 2020 2020 2263 726f 7373 5f65 6e74  ..    "cross_ent
+0001fff0: 726f 7079 5f6c 6f73 7328 782c 7929 222c  ropy_loss(x,y)",
+00020000: 0a20 2020 2022 6372 6f73 735f 656e 7472  .    "cross_entr
+00020010: 6f70 795f 6c6f 7373 5f62 6163 6b28 782c  opy_loss_back(x,
+00020020: 7929 222c 0a7d 3b0a 0a73 7461 7469 635f  y)",.};..static_
+00020030: 6173 7365 7274 2847 474d 4c5f 4f50 5f43  assert(GGML_OP_C
+00020040: 4f55 4e54 203d 3d20 3537 2c20 2247 474d  OUNT == 57, "GGM
+00020050: 4c5f 4f50 5f43 4f55 4e54 2021 3d20 3537  L_OP_COUNT != 57
+00020060: 2229 3b0a 0a73 7461 7469 635f 6173 7365  ");..static_asse
+00020070: 7274 2873 697a 656f 6628 7374 7275 6374  rt(sizeof(struct
+00020080: 2067 676d 6c5f 6f62 6a65 6374 2925 4747   ggml_object)%GG
+00020090: 4d4c 5f4d 454d 5f41 4c49 474e 203d 3d20  ML_MEM_ALIGN == 
+000200a0: 302c 2022 6767 6d6c 5f6f 626a 6563 7420  0, "ggml_object 
+000200b0: 7369 7a65 206d 7573 7420 6265 2061 206d  size must be a m
+000200c0: 756c 7469 706c 6520 6f66 2047 474d 4c5f  ultiple of GGML_
+000200d0: 4d45 4d5f 414c 4947 4e22 293b 0a73 7461  MEM_ALIGN");.sta
+000200e0: 7469 635f 6173 7365 7274 2873 697a 656f  tic_assert(sizeo
+000200f0: 6628 7374 7275 6374 2067 676d 6c5f 7465  f(struct ggml_te
+00020100: 6e73 6f72 2925 4747 4d4c 5f4d 454d 5f41  nsor)%GGML_MEM_A
+00020110: 4c49 474e 203d 3d20 302c 2022 6767 6d6c  LIGN == 0, "ggml
+00020120: 5f74 656e 736f 7220 7369 7a65 206d 7573  _tensor size mus
+00020130: 7420 6265 2061 206d 756c 7469 706c 6520  t be a multiple 
+00020140: 6f66 2047 474d 4c5f 4d45 4d5f 414c 4947  of GGML_MEM_ALIG
+00020150: 4e22 293b 0a0a 2f2f 0a2f 2f20 6767 6d6c  N");..//.// ggml
+00020160: 2063 6f6e 7465 7874 0a2f 2f0a 0a73 7472   context.//..str
+00020170: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00020180: 207b 0a20 2020 2073 697a 655f 7420 6d65   {.    size_t me
+00020190: 6d5f 7369 7a65 3b0a 2020 2020 766f 6964  m_size;.    void
+000201a0: 202a 206d 656d 5f62 7566 6665 723b 0a20   * mem_buffer;. 
+000201b0: 2020 2062 6f6f 6c20 2020 6d65 6d5f 6275     bool   mem_bu
+000201c0: 6666 6572 5f6f 776e 6564 3b0a 2020 2020  ffer_owned;.    
+000201d0: 626f 6f6c 2020 206e 6f5f 616c 6c6f 633b  bool   no_alloc;
+000201e0: 0a20 2020 2062 6f6f 6c20 2020 6e6f 5f61  .    bool   no_a
+000201f0: 6c6c 6f63 5f73 6176 653b 202f 2f20 7468  lloc_save; // th
+00020200: 6973 2069 7320 7573 6564 2074 6f20 7361  is is used to sa
+00020210: 7665 2074 6865 206e 6f5f 616c 6c6f 6320  ve the no_alloc 
+00020220: 7374 6174 6520 7768 656e 2075 7369 6e67  state when using
+00020230: 2073 6372 6174 6368 2062 7566 6665 7273   scratch buffers
+00020240: 0a0a 2020 2020 696e 7420 2020 206e 5f6f  ..    int    n_o
+00020250: 626a 6563 7473 3b0a 0a20 2020 2073 7472  bjects;..    str
+00020260: 7563 7420 6767 6d6c 5f6f 626a 6563 7420  uct ggml_object 
+00020270: 2a20 6f62 6a65 6374 735f 6265 6769 6e3b  * objects_begin;
+00020280: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00020290: 5f6f 626a 6563 7420 2a20 6f62 6a65 6374  _object * object
+000202a0: 735f 656e 643b 0a0a 2020 2020 7374 7275  s_end;..    stru
+000202b0: 6374 2067 676d 6c5f 7363 7261 7463 6820  ct ggml_scratch 
+000202c0: 7363 7261 7463 683b 0a20 2020 2073 7472  scratch;.    str
 000202d0: 7563 7420 6767 6d6c 5f73 6372 6174 6368  uct ggml_scratch
-000202e0: 2073 6372 6174 6368 3b0a 2020 2020 7374   scratch;.    st
-000202f0: 7275 6374 2067 676d 6c5f 7363 7261 7463  ruct ggml_scratc
-00020300: 6820 7363 7261 7463 685f 7361 7665 3b0a  h scratch_save;.
-00020310: 7d3b 0a0a 7374 7275 6374 2067 676d 6c5f  };..struct ggml_
-00020320: 636f 6e74 6578 745f 636f 6e74 6169 6e65  context_containe
-00020330: 7220 7b0a 2020 2020 626f 6f6c 2075 7365  r {.    bool use
-00020340: 643b 0a0a 2020 2020 7374 7275 6374 2067  d;..    struct g
-00020350: 676d 6c5f 636f 6e74 6578 7420 636f 6e74  gml_context cont
-00020360: 6578 743b 0a7d 3b0a 0a2f 2f0a 2f2f 2067  ext;.};..//.// g
-00020370: 676d 6c20 7374 6174 650a 2f2f 0a0a 7374  gml state.//..st
-00020380: 7275 6374 2067 676d 6c5f 7374 6174 6520  ruct ggml_state 
-00020390: 7b0a 2020 2020 7374 7275 6374 2067 676d  {.    struct ggm
-000203a0: 6c5f 636f 6e74 6578 745f 636f 6e74 6169  l_context_contai
-000203b0: 6e65 7220 636f 6e74 6578 7473 5b47 474d  ner contexts[GGM
-000203c0: 4c5f 4d41 585f 434f 4e54 4558 5453 5d3b  L_MAX_CONTEXTS];
-000203d0: 0a7d 3b0a 0a2f 2f20 676c 6f62 616c 2073  .};..// global s
-000203e0: 7461 7465 0a73 7461 7469 6320 7374 7275  tate.static stru
-000203f0: 6374 2067 676d 6c5f 7374 6174 6520 675f  ct ggml_state g_
-00020400: 7374 6174 653b 0a73 7461 7469 6320 6174  state;.static at
-00020410: 6f6d 6963 5f69 6e74 2067 5f73 7461 7465  omic_int g_state
-00020420: 5f62 6172 7269 6572 203d 2030 3b0a 0a2f  _barrier = 0;../
-00020430: 2f20 6261 7272 6965 7220 7669 6120 7370  / barrier via sp
-00020440: 696e 206c 6f63 6b0a 696e 6c69 6e65 2073  in lock.inline s
-00020450: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00020460: 6372 6974 6963 616c 5f73 6563 7469 6f6e  critical_section
-00020470: 5f73 7461 7274 2876 6f69 6429 207b 0a20  _start(void) {. 
-00020480: 2020 2069 6e74 2070 726f 6365 7373 696e     int processin
-00020490: 6720 3d20 6174 6f6d 6963 5f66 6574 6368  g = atomic_fetch
-000204a0: 5f61 6464 2826 675f 7374 6174 655f 6261  _add(&g_state_ba
-000204b0: 7272 6965 722c 2031 293b 0a0a 2020 2020  rrier, 1);..    
-000204c0: 7768 696c 6520 2870 726f 6365 7373 696e  while (processin
-000204d0: 6720 3e20 3029 207b 0a20 2020 2020 2020  g > 0) {.       
-000204e0: 202f 2f20 7761 6974 2066 6f72 206f 7468   // wait for oth
-000204f0: 6572 2074 6872 6561 6473 2074 6f20 6669  er threads to fi
-00020500: 6e69 7368 0a20 2020 2020 2020 2061 746f  nish.        ato
-00020510: 6d69 635f 6665 7463 685f 7375 6228 2667  mic_fetch_sub(&g
-00020520: 5f73 7461 7465 5f62 6172 7269 6572 2c20  _state_barrier, 
-00020530: 3129 3b0a 2020 2020 2020 2020 7363 6865  1);.        sche
-00020540: 645f 7969 656c 6428 293b 202f 2f20 544f  d_yield(); // TO
-00020550: 444f 3a20 7265 636f 6e73 6964 6572 2074  DO: reconsider t
-00020560: 6869 730a 2020 2020 2020 2020 7072 6f63  his.        proc
-00020570: 6573 7369 6e67 203d 2061 746f 6d69 635f  essing = atomic_
-00020580: 6665 7463 685f 6164 6428 2667 5f73 7461  fetch_add(&g_sta
-00020590: 7465 5f62 6172 7269 6572 2c20 3129 3b0a  te_barrier, 1);.
-000205a0: 2020 2020 7d0a 7d0a 0a2f 2f20 544f 444f      }.}..// TODO
-000205b0: 3a20 6d61 6b65 2074 6869 7320 736f 6d65  : make this some
-000205c0: 686f 7720 6175 746f 6d61 7469 6361 6c6c  how automaticall
-000205d0: 7920 6578 6563 7574 6564 0a2f 2f20 2020  y executed.//   
-000205e0: 2020 2020 736f 6d65 2073 6f72 7420 6f66      some sort of
-000205f0: 2022 7365 6e74 7279 2220 6d65 6368 616e   "sentry" mechan
-00020600: 6973 6d0a 696e 6c69 6e65 2073 7461 7469  ism.inline stati
-00020610: 6320 766f 6964 2067 676d 6c5f 6372 6974  c void ggml_crit
-00020620: 6963 616c 5f73 6563 7469 6f6e 5f65 6e64  ical_section_end
-00020630: 2876 6f69 6429 207b 0a20 2020 2061 746f  (void) {.    ato
-00020640: 6d69 635f 6665 7463 685f 7375 6228 2667  mic_fetch_sub(&g
-00020650: 5f73 7461 7465 5f62 6172 7269 6572 2c20  _state_barrier, 
-00020660: 3129 3b0a 7d0a 0a2f 2f2f 2f2f 2f2f 2f2f  1);.}../////////
+000202e0: 2073 6372 6174 6368 5f73 6176 653b 0a7d   scratch_save;.}
+000202f0: 3b0a 0a73 7472 7563 7420 6767 6d6c 5f63  ;..struct ggml_c
+00020300: 6f6e 7465 7874 5f63 6f6e 7461 696e 6572  ontext_container
+00020310: 207b 0a20 2020 2062 6f6f 6c20 7573 6564   {.    bool used
+00020320: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
+00020330: 6d6c 5f63 6f6e 7465 7874 2063 6f6e 7465  ml_context conte
+00020340: 7874 3b0a 7d3b 0a0a 2f2f 0a2f 2f20 6767  xt;.};..//.// gg
+00020350: 6d6c 2073 7461 7465 0a2f 2f0a 0a73 7472  ml state.//..str
+00020360: 7563 7420 6767 6d6c 5f73 7461 7465 207b  uct ggml_state {
+00020370: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00020380: 5f63 6f6e 7465 7874 5f63 6f6e 7461 696e  _context_contain
+00020390: 6572 2063 6f6e 7465 7874 735b 4747 4d4c  er contexts[GGML
+000203a0: 5f4d 4158 5f43 4f4e 5445 5854 535d 3b0a  _MAX_CONTEXTS];.
+000203b0: 7d3b 0a0a 2f2f 2067 6c6f 6261 6c20 7374  };..// global st
+000203c0: 6174 650a 7374 6174 6963 2073 7472 7563  ate.static struc
+000203d0: 7420 6767 6d6c 5f73 7461 7465 2067 5f73  t ggml_state g_s
+000203e0: 7461 7465 3b0a 7374 6174 6963 2061 746f  tate;.static ato
+000203f0: 6d69 635f 696e 7420 675f 7374 6174 655f  mic_int g_state_
+00020400: 6261 7272 6965 7220 3d20 303b 0a0a 2f2f  barrier = 0;..//
+00020410: 2062 6172 7269 6572 2076 6961 2073 7069   barrier via spi
+00020420: 6e20 6c6f 636b 0a69 6e6c 696e 6520 7374  n lock.inline st
+00020430: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00020440: 7269 7469 6361 6c5f 7365 6374 696f 6e5f  ritical_section_
+00020450: 7374 6172 7428 766f 6964 2920 7b0a 2020  start(void) {.  
+00020460: 2020 696e 7420 7072 6f63 6573 7369 6e67    int processing
+00020470: 203d 2061 746f 6d69 635f 6665 7463 685f   = atomic_fetch_
+00020480: 6164 6428 2667 5f73 7461 7465 5f62 6172  add(&g_state_bar
+00020490: 7269 6572 2c20 3129 3b0a 0a20 2020 2077  rier, 1);..    w
+000204a0: 6869 6c65 2028 7072 6f63 6573 7369 6e67  hile (processing
+000204b0: 203e 2030 2920 7b0a 2020 2020 2020 2020   > 0) {.        
+000204c0: 2f2f 2077 6169 7420 666f 7220 6f74 6865  // wait for othe
+000204d0: 7220 7468 7265 6164 7320 746f 2066 696e  r threads to fin
+000204e0: 6973 680a 2020 2020 2020 2020 6174 6f6d  ish.        atom
+000204f0: 6963 5f66 6574 6368 5f73 7562 2826 675f  ic_fetch_sub(&g_
+00020500: 7374 6174 655f 6261 7272 6965 722c 2031  state_barrier, 1
+00020510: 293b 0a20 2020 2020 2020 2073 6368 6564  );.        sched
+00020520: 5f79 6965 6c64 2829 3b20 2f2f 2054 4f44  _yield(); // TOD
+00020530: 4f3a 2072 6563 6f6e 7369 6465 7220 7468  O: reconsider th
+00020540: 6973 0a20 2020 2020 2020 2070 726f 6365  is.        proce
+00020550: 7373 696e 6720 3d20 6174 6f6d 6963 5f66  ssing = atomic_f
+00020560: 6574 6368 5f61 6464 2826 675f 7374 6174  etch_add(&g_stat
+00020570: 655f 6261 7272 6965 722c 2031 293b 0a20  e_barrier, 1);. 
+00020580: 2020 207d 0a7d 0a0a 2f2f 2054 4f44 4f3a     }.}..// TODO:
+00020590: 206d 616b 6520 7468 6973 2073 6f6d 6568   make this someh
+000205a0: 6f77 2061 7574 6f6d 6174 6963 616c 6c79  ow automatically
+000205b0: 2065 7865 6375 7465 640a 2f2f 2020 2020   executed.//    
+000205c0: 2020 2073 6f6d 6520 736f 7274 206f 6620     some sort of 
+000205d0: 2273 656e 7472 7922 206d 6563 6861 6e69  "sentry" mechani
+000205e0: 736d 0a69 6e6c 696e 6520 7374 6174 6963  sm.inline static
+000205f0: 2076 6f69 6420 6767 6d6c 5f63 7269 7469   void ggml_criti
+00020600: 6361 6c5f 7365 6374 696f 6e5f 656e 6428  cal_section_end(
+00020610: 766f 6964 2920 7b0a 2020 2020 6174 6f6d  void) {.    atom
+00020620: 6963 5f66 6574 6368 5f73 7562 2826 675f  ic_fetch_sub(&g_
+00020630: 7374 6174 655f 6261 7272 6965 722c 2031  state_barrier, 1
+00020640: 293b 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f  );.}..//////////
+00020650: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00020660: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00020670: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00020680: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00020690: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000206a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000206b0: 2f2f 2f2f 2f2f 2f0a 0a76 6f69 6420 6767  ///////..void gg
-000206c0: 6d6c 5f70 7269 6e74 5f6f 626a 6563 7428  ml_print_object(
-000206d0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000206e0: 6c5f 6f62 6a65 6374 202a 206f 626a 2920  l_object * obj) 
-000206f0: 7b0a 2020 2020 4747 4d4c 5f50 5249 4e54  {.    GGML_PRINT
-00020700: 2822 202d 2067 676d 6c5f 6f62 6a65 6374  (" - ggml_object
-00020710: 3a20 6f66 6673 6574 203d 2025 7a75 2c20  : offset = %zu, 
-00020720: 7369 7a65 203d 2025 7a75 2c20 6e65 7874  size = %zu, next
-00020730: 203d 2025 705c 6e22 2c0a 2020 2020 2020   = %p\n",.      
-00020740: 2020 2020 2020 6f62 6a2d 3e6f 6666 732c        obj->offs,
-00020750: 206f 626a 2d3e 7369 7a65 2c20 2863 6f6e   obj->size, (con
-00020760: 7374 2076 6f69 6420 2a29 206f 626a 2d3e  st void *) obj->
-00020770: 6e65 7874 293b 0a7d 0a0a 766f 6964 2067  next);.}..void g
-00020780: 676d 6c5f 7072 696e 745f 6f62 6a65 6374  gml_print_object
-00020790: 7328 636f 6e73 7420 7374 7275 6374 2067  s(const struct g
-000207a0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-000207b0: 7829 207b 0a20 2020 2073 7472 7563 7420  x) {.    struct 
-000207c0: 6767 6d6c 5f6f 626a 6563 7420 2a20 6f62  ggml_object * ob
-000207d0: 6a20 3d20 6374 782d 3e6f 626a 6563 7473  j = ctx->objects
-000207e0: 5f62 6567 696e 3b0a 0a20 2020 2047 474d  _begin;..    GGM
-000207f0: 4c5f 5052 494e 5428 2225 733a 206f 626a  L_PRINT("%s: obj
-00020800: 6563 7473 2069 6e20 636f 6e74 6578 7420  ects in context 
-00020810: 2570 3a5c 6e22 2c20 5f5f 6675 6e63 5f5f  %p:\n", __func__
-00020820: 2c20 2863 6f6e 7374 2076 6f69 6420 2a29  , (const void *)
-00020830: 2063 7478 293b 0a0a 2020 2020 7768 696c   ctx);..    whil
-00020840: 6520 286f 626a 2021 3d20 4e55 4c4c 2920  e (obj != NULL) 
-00020850: 7b0a 2020 2020 2020 2020 6767 6d6c 5f70  {.        ggml_p
-00020860: 7269 6e74 5f6f 626a 6563 7428 6f62 6a29  rint_object(obj)
-00020870: 3b0a 2020 2020 2020 2020 6f62 6a20 3d20  ;.        obj = 
-00020880: 6f62 6a2d 3e6e 6578 743b 0a20 2020 207d  obj->next;.    }
-00020890: 0a0a 2020 2020 4747 4d4c 5f50 5249 4e54  ..    GGML_PRINT
-000208a0: 2822 2573 3a20 2d2d 2d20 656e 6420 2d2d  ("%s: --- end --
-000208b0: 2d5c 6e22 2c20 5f5f 6675 6e63 5f5f 293b  -\n", __func__);
-000208c0: 0a7d 0a0a 696e 7436 345f 7420 6767 6d6c  .}..int64_t ggml
-000208d0: 5f6e 656c 656d 656e 7473 2863 6f6e 7374  _nelements(const
-000208e0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000208f0: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
-00020900: 2020 2020 7374 6174 6963 5f61 7373 6572      static_asser
-00020910: 7428 4747 4d4c 5f4d 4158 5f44 494d 5320  t(GGML_MAX_DIMS 
-00020920: 3d3d 2034 2c20 2247 474d 4c5f 4d41 585f  == 4, "GGML_MAX_
-00020930: 4449 4d53 2069 7320 6e6f 7420 3420 2d20  DIMS is not 4 - 
-00020940: 7570 6461 7465 2074 6869 7320 6675 6e63  update this func
-00020950: 7469 6f6e 2229 3b0a 0a20 2020 2072 6574  tion");..    ret
-00020960: 7572 6e20 7465 6e73 6f72 2d3e 6e65 5b30  urn tensor->ne[0
-00020970: 5d2a 7465 6e73 6f72 2d3e 6e65 5b31 5d2a  ]*tensor->ne[1]*
-00020980: 7465 6e73 6f72 2d3e 6e65 5b32 5d2a 7465  tensor->ne[2]*te
-00020990: 6e73 6f72 2d3e 6e65 5b33 5d3b 0a7d 0a0a  nsor->ne[3];.}..
-000209a0: 696e 7436 345f 7420 6767 6d6c 5f6e 726f  int64_t ggml_nro
-000209b0: 7773 2863 6f6e 7374 2073 7472 7563 7420  ws(const struct 
-000209c0: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
-000209d0: 6e73 6f72 2920 7b0a 2020 2020 7374 6174  nsor) {.    stat
-000209e0: 6963 5f61 7373 6572 7428 4747 4d4c 5f4d  ic_assert(GGML_M
-000209f0: 4158 5f44 494d 5320 3d3d 2034 2c20 2247  AX_DIMS == 4, "G
-00020a00: 474d 4c5f 4d41 585f 4449 4d53 2069 7320  GML_MAX_DIMS is 
-00020a10: 6e6f 7420 3420 2d20 7570 6461 7465 2074  not 4 - update t
-00020a20: 6869 7320 6675 6e63 7469 6f6e 2229 3b0a  his function");.
-00020a30: 0a20 2020 2072 6574 7572 6e20 7465 6e73  .    return tens
-00020a40: 6f72 2d3e 6e65 5b31 5d2a 7465 6e73 6f72  or->ne[1]*tensor
-00020a50: 2d3e 6e65 5b32 5d2a 7465 6e73 6f72 2d3e  ->ne[2]*tensor->
-00020a60: 6e65 5b33 5d3b 0a7d 0a0a 7369 7a65 5f74  ne[3];.}..size_t
-00020a70: 2067 676d 6c5f 6e62 7974 6573 2863 6f6e   ggml_nbytes(con
-00020a80: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00020a90: 656e 736f 7220 2a20 7465 6e73 6f72 2920  ensor * tensor) 
-00020aa0: 7b0a 2020 2020 7374 6174 6963 5f61 7373  {.    static_ass
-00020ab0: 6572 7428 4747 4d4c 5f4d 4158 5f44 494d  ert(GGML_MAX_DIM
-00020ac0: 5320 3d3d 2034 2c20 2247 474d 4c5f 4d41  S == 4, "GGML_MA
-00020ad0: 585f 4449 4d53 2069 7320 6e6f 7420 3420  X_DIMS is not 4 
-00020ae0: 2d20 7570 6461 7465 2074 6869 7320 6675  - update this fu
-00020af0: 6e63 7469 6f6e 2229 3b0a 0a20 2020 202f  nction");..    /
-00020b00: 2f20 7468 6973 2073 686f 756c 6420 6861  / this should ha
-00020b10: 6e64 6c65 2063 6173 6573 2077 6865 7265  ndle cases where
-00020b20: 2074 6865 2074 656e 736f 7220 6973 206e   the tensor is n
-00020b30: 6f74 2063 6f6e 7469 6775 6f75 7320 696e  ot contiguous in
-00020b40: 206d 656d 6f72 790a 2020 2020 2f2f 2070   memory.    // p
-00020b50: 726f 6261 6279 206a 7573 743a 0a20 2020  robaby just:.   
-00020b60: 202f 2f0a 2020 2020 2f2f 2020 2020 2072   //.    //     r
-00020b70: 6574 7572 6e20 7465 6e73 6f72 2d3e 6e65  eturn tensor->ne
-00020b80: 5b33 5d2a 7465 6e73 6f72 2d3e 6e62 5b33  [3]*tensor->nb[3
-00020b90: 5d0a 2020 2020 2f2f 0a20 2020 202f 2f20  ].    //.    // 
-00020ba0: 6973 2065 6e6f 7567 682c 2062 7574 206a  is enough, but j
-00020bb0: 7573 7420 696e 2063 6173 652c 2061 6464  ust in case, add
-00020bc0: 696e 6720 7468 6520 7365 636f 6e64 2070  ing the second p
-00020bd0: 6172 740a 0a20 2020 2072 6574 7572 6e20  art..    return 
-00020be0: 4d41 5828 7465 6e73 6f72 2d3e 6e65 5b33  MAX(tensor->ne[3
-00020bf0: 5d2a 7465 6e73 6f72 2d3e 6e62 5b33 5d2c  ]*tensor->nb[3],
-00020c00: 2028 6767 6d6c 5f6e 656c 656d 656e 7473   (ggml_nelements
-00020c10: 2874 656e 736f 7229 2a47 474d 4c5f 5459  (tensor)*GGML_TY
-00020c20: 5045 5f53 495a 455b 7465 6e73 6f72 2d3e  PE_SIZE[tensor->
-00020c30: 7479 7065 5d29 2f47 474d 4c5f 424c 434b  type])/GGML_BLCK
-00020c40: 5f53 495a 455b 7465 6e73 6f72 2d3e 7479  _SIZE[tensor->ty
-00020c50: 7065 5d29 3b0a 7d0a 0a73 697a 655f 7420  pe]);.}..size_t 
-00020c60: 6767 6d6c 5f6e 6279 7465 735f 7370 6c69  ggml_nbytes_spli
-00020c70: 7428 636f 6e73 7420 7374 7275 6374 2067  t(const struct g
-00020c80: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
-00020c90: 736f 722c 2069 6e74 206e 726f 7773 5f73  sor, int nrows_s
-00020ca0: 706c 6974 2920 7b0a 2020 2020 7374 6174  plit) {.    stat
-00020cb0: 6963 5f61 7373 6572 7428 4747 4d4c 5f4d  ic_assert(GGML_M
-00020cc0: 4158 5f44 494d 5320 3d3d 2034 2c20 2247  AX_DIMS == 4, "G
-00020cd0: 474d 4c5f 4d41 585f 4449 4d53 2069 7320  GML_MAX_DIMS is 
-00020ce0: 6e6f 7420 3420 2d20 7570 6461 7465 2074  not 4 - update t
-00020cf0: 6869 7320 6675 6e63 7469 6f6e 2229 3b0a  his function");.
-00020d00: 0a20 2020 2072 6574 7572 6e20 286e 726f  .    return (nro
-00020d10: 7773 5f73 706c 6974 2a74 656e 736f 722d  ws_split*tensor-
-00020d20: 3e6e 655b 305d 2a47 474d 4c5f 5459 5045  >ne[0]*GGML_TYPE
-00020d30: 5f53 495a 455b 7465 6e73 6f72 2d3e 7479  _SIZE[tensor->ty
-00020d40: 7065 5d29 2f47 474d 4c5f 424c 434b 5f53  pe])/GGML_BLCK_S
-00020d50: 495a 455b 7465 6e73 6f72 2d3e 7479 7065  IZE[tensor->type
-00020d60: 5d3b 0a7d 0a0a 696e 7420 6767 6d6c 5f62  ];.}..int ggml_b
-00020d70: 6c63 6b5f 7369 7a65 2865 6e75 6d20 6767  lck_size(enum gg
-00020d80: 6d6c 5f74 7970 6520 7479 7065 2920 7b0a  ml_type type) {.
-00020d90: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
-00020da0: 424c 434b 5f53 495a 455b 7479 7065 5d3b  BLCK_SIZE[type];
-00020db0: 0a7d 0a0a 7369 7a65 5f74 2067 676d 6c5f  .}..size_t ggml_
-00020dc0: 7479 7065 5f73 697a 6528 656e 756d 2067  type_size(enum g
-00020dd0: 676d 6c5f 7479 7065 2074 7970 6529 207b  gml_type type) {
-00020de0: 0a20 2020 2072 6574 7572 6e20 4747 4d4c  .    return GGML
-00020df0: 5f54 5950 455f 5349 5a45 5b74 7970 655d  _TYPE_SIZE[type]
-00020e00: 3b0a 7d0a 0a66 6c6f 6174 2067 676d 6c5f  ;.}..float ggml_
-00020e10: 7479 7065 5f73 697a 6566 2865 6e75 6d20  type_sizef(enum 
-00020e20: 6767 6d6c 5f74 7970 6520 7479 7065 2920  ggml_type type) 
-00020e30: 7b0a 2020 2020 7265 7475 726e 2028 2866  {.    return ((f
-00020e40: 6c6f 6174 2928 4747 4d4c 5f54 5950 455f  loat)(GGML_TYPE_
-00020e50: 5349 5a45 5b74 7970 655d 2929 2f47 474d  SIZE[type]))/GGM
-00020e60: 4c5f 424c 434b 5f53 495a 455b 7479 7065  L_BLCK_SIZE[type
-00020e70: 5d3b 0a7d 0a0a 636f 6e73 7420 6368 6172  ];.}..const char
-00020e80: 202a 2067 676d 6c5f 7479 7065 5f6e 616d   * ggml_type_nam
-00020e90: 6528 656e 756d 2067 676d 6c5f 7479 7065  e(enum ggml_type
-00020ea0: 2074 7970 6529 207b 0a20 2020 2072 6574   type) {.    ret
-00020eb0: 7572 6e20 4747 4d4c 5f54 5950 455f 4e41  urn GGML_TYPE_NA
-00020ec0: 4d45 5b74 7970 655d 3b0a 7d0a 0a63 6f6e  ME[type];.}..con
-00020ed0: 7374 2063 6861 7220 2a20 6767 6d6c 5f6f  st char * ggml_o
-00020ee0: 705f 6e61 6d65 2865 6e75 6d20 6767 6d6c  p_name(enum ggml
-00020ef0: 5f6f 7020 6f70 2920 7b0a 2020 2020 7265  _op op) {.    re
-00020f00: 7475 726e 2047 474d 4c5f 4f50 5f4e 414d  turn GGML_OP_NAM
-00020f10: 455b 6f70 5d3b 0a7d 0a0a 7369 7a65 5f74  E[op];.}..size_t
-00020f20: 2067 676d 6c5f 656c 656d 656e 745f 7369   ggml_element_si
-00020f30: 7a65 2863 6f6e 7374 2073 7472 7563 7420  ze(const struct 
-00020f40: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
-00020f50: 6e73 6f72 2920 7b0a 2020 2020 7265 7475  nsor) {.    retu
-00020f60: 726e 2047 474d 4c5f 5459 5045 5f53 495a  rn GGML_TYPE_SIZ
-00020f70: 455b 7465 6e73 6f72 2d3e 7479 7065 5d3b  E[tensor->type];
-00020f80: 0a7d 0a0a 7374 6174 6963 2069 6e6c 696e  .}..static inlin
-00020f90: 6520 626f 6f6c 2067 676d 6c5f 6973 5f73  e bool ggml_is_s
-00020fa0: 6361 6c61 7228 636f 6e73 7420 7374 7275  calar(const stru
-00020fb0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00020fc0: 2074 656e 736f 7229 207b 0a20 2020 2073   tensor) {.    s
-00020fd0: 7461 7469 635f 6173 7365 7274 2847 474d  tatic_assert(GGM
-00020fe0: 4c5f 4d41 585f 4449 4d53 203d 3d20 342c  L_MAX_DIMS == 4,
-00020ff0: 2022 4747 4d4c 5f4d 4158 5f44 494d 5320   "GGML_MAX_DIMS 
-00021000: 6973 206e 6f74 2034 202d 2075 7064 6174  is not 4 - updat
-00021010: 6520 7468 6973 2066 756e 6374 696f 6e22  e this function"
-00021020: 293b 0a0a 2020 2020 7265 7475 726e 2074  );..    return t
-00021030: 656e 736f 722d 3e6e 655b 305d 203d 3d20  ensor->ne[0] == 
-00021040: 3120 2626 2074 656e 736f 722d 3e6e 655b  1 && tensor->ne[
-00021050: 315d 203d 3d20 3120 2626 2074 656e 736f  1] == 1 && tenso
-00021060: 722d 3e6e 655b 325d 203d 3d20 3120 2626  r->ne[2] == 1 &&
-00021070: 2074 656e 736f 722d 3e6e 655b 335d 203d   tensor->ne[3] =
-00021080: 3d20 313b 0a7d 0a0a 7374 6174 6963 2069  = 1;.}..static i
-00021090: 6e6c 696e 6520 626f 6f6c 2067 676d 6c5f  nline bool ggml_
-000210a0: 6973 5f76 6563 746f 7228 636f 6e73 7420  is_vector(const 
-000210b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000210c0: 6f72 202a 2074 656e 736f 7229 207b 0a20  or * tensor) {. 
-000210d0: 2020 2073 7461 7469 635f 6173 7365 7274     static_assert
-000210e0: 2847 474d 4c5f 4d41 585f 4449 4d53 203d  (GGML_MAX_DIMS =
-000210f0: 3d20 342c 2022 4747 4d4c 5f4d 4158 5f44  = 4, "GGML_MAX_D
-00021100: 494d 5320 6973 206e 6f74 2034 202d 2075  IMS is not 4 - u
-00021110: 7064 6174 6520 7468 6973 2066 756e 6374  pdate this funct
-00021120: 696f 6e22 293b 0a0a 2020 2020 7265 7475  ion");..    retu
-00021130: 726e 2074 656e 736f 722d 3e6e 655b 315d  rn tensor->ne[1]
-00021140: 203d 3d20 3120 2626 2074 656e 736f 722d   == 1 && tensor-
-00021150: 3e6e 655b 325d 203d 3d20 3120 2626 2074  >ne[2] == 1 && t
-00021160: 656e 736f 722d 3e6e 655b 335d 203d 3d20  ensor->ne[3] == 
-00021170: 313b 0a7d 0a0a 7374 6174 6963 2069 6e6c  1;.}..static inl
-00021180: 696e 6520 626f 6f6c 2067 676d 6c5f 6973  ine bool ggml_is
-00021190: 5f6d 6174 7269 7828 636f 6e73 7420 7374  _matrix(const st
-000211a0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000211b0: 202a 2074 656e 736f 7229 207b 0a20 2020   * tensor) {.   
-000211c0: 2073 7461 7469 635f 6173 7365 7274 2847   static_assert(G
-000211d0: 474d 4c5f 4d41 585f 4449 4d53 203d 3d20  GML_MAX_DIMS == 
-000211e0: 342c 2022 4747 4d4c 5f4d 4158 5f44 494d  4, "GGML_MAX_DIM
-000211f0: 5320 6973 206e 6f74 2034 202d 2075 7064  S is not 4 - upd
-00021200: 6174 6520 7468 6973 2066 756e 6374 696f  ate this functio
-00021210: 6e22 293b 0a0a 2020 2020 7265 7475 726e  n");..    return
-00021220: 2074 656e 736f 722d 3e6e 655b 325d 203d   tensor->ne[2] =
-00021230: 3d20 3120 2626 2074 656e 736f 722d 3e6e  = 1 && tensor->n
-00021240: 655b 335d 203d 3d20 313b 0a7d 0a0a 7374  e[3] == 1;.}..st
-00021250: 6174 6963 2069 6e6c 696e 6520 626f 6f6c  atic inline bool
-00021260: 2067 676d 6c5f 6361 6e5f 6d75 6c5f 6d61   ggml_can_mul_ma
-00021270: 7428 636f 6e73 7420 7374 7275 6374 2067  t(const struct g
-00021280: 676d 6c5f 7465 6e73 6f72 202a 2074 302c  gml_tensor * t0,
-00021290: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-000212a0: 6d6c 5f74 656e 736f 7220 2a20 7431 2920  ml_tensor * t1) 
-000212b0: 7b0a 2020 2020 7374 6174 6963 5f61 7373  {.    static_ass
-000212c0: 6572 7428 4747 4d4c 5f4d 4158 5f44 494d  ert(GGML_MAX_DIM
-000212d0: 5320 3d3d 2034 2c20 2247 474d 4c5f 4d41  S == 4, "GGML_MA
-000212e0: 585f 4449 4d53 2069 7320 6e6f 7420 3420  X_DIMS is not 4 
-000212f0: 2d20 7570 6461 7465 2074 6869 7320 6675  - update this fu
-00021300: 6e63 7469 6f6e 2229 3b0a 0a20 2020 2072  nction");..    r
-00021310: 6574 7572 6e0a 2020 2020 2020 2020 2874  eturn.        (t
-00021320: 302d 3e6e 655b 305d 203d 3d20 7431 2d3e  0->ne[0] == t1->
-00021330: 6e65 5b30 5d29 2020 2626 0a20 2020 2020  ne[0])  &&.     
-00021340: 2020 2028 7430 2d3e 6e65 5b32 5d20 3d3d     (t0->ne[2] ==
-00021350: 2074 312d 3e6e 655b 325d 2920 2026 260a   t1->ne[2])  &&.
-00021360: 2020 2020 2020 2020 2874 302d 3e6e 655b          (t0->ne[
-00021370: 335d 203d 3d20 7431 2d3e 6e65 5b33 5d29  3] == t1->ne[3])
-00021380: 3b0a 7d0a 0a73 7461 7469 6320 696e 6c69  ;.}..static inli
-00021390: 6e65 2062 6f6f 6c20 6767 6d6c 5f63 616e  ne bool ggml_can
-000213a0: 5f6f 7574 5f70 726f 6428 636f 6e73 7420  _out_prod(const 
-000213b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000213c0: 6f72 202a 2074 302c 2063 6f6e 7374 2073  or * t0, const s
-000213d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000213e0: 7220 2a20 7431 2920 7b0a 2020 2020 7374  r * t1) {.    st
-000213f0: 6174 6963 5f61 7373 6572 7428 4747 4d4c  atic_assert(GGML
-00021400: 5f4d 4158 5f44 494d 5320 3d3d 2034 2c20  _MAX_DIMS == 4, 
-00021410: 2247 474d 4c5f 4d41 585f 4449 4d53 2069  "GGML_MAX_DIMS i
-00021420: 7320 6e6f 7420 3420 2d20 7570 6461 7465  s not 4 - update
-00021430: 2074 6869 7320 6675 6e63 7469 6f6e 2229   this function")
-00021440: 3b0a 0a20 2020 2072 6574 7572 6e0a 2020  ;..    return.  
-00021450: 2020 2020 2020 2874 302d 3e6e 655b 315d        (t0->ne[1]
-00021460: 203d 3d20 7431 2d3e 6e65 5b31 5d29 2020   == t1->ne[1])  
-00021470: 2626 0a20 2020 2020 2020 2028 7430 2d3e  &&.        (t0->
-00021480: 6e65 5b32 5d20 3d3d 2074 312d 3e6e 655b  ne[2] == t1->ne[
-00021490: 325d 2920 2026 260a 2020 2020 2020 2020  2])  &&.        
-000214a0: 2874 302d 3e6e 655b 335d 203d 3d20 7431  (t0->ne[3] == t1
-000214b0: 2d3e 6e65 5b33 5d29 3b0a 7d0a 0a62 6f6f  ->ne[3]);.}..boo
-000214c0: 6c20 6767 6d6c 5f69 735f 7175 616e 7469  l ggml_is_quanti
-000214d0: 7a65 6428 656e 756d 2067 676d 6c5f 7479  zed(enum ggml_ty
-000214e0: 7065 2074 7970 6529 207b 0a20 2020 2072  pe type) {.    r
-000214f0: 6574 7572 6e20 4747 4d4c 5f49 535f 5155  eturn GGML_IS_QU
-00021500: 414e 5449 5a45 445b 7479 7065 5d3b 0a7d  ANTIZED[type];.}
-00021510: 0a0a 656e 756d 2067 676d 6c5f 7479 7065  ..enum ggml_type
-00021520: 2067 676d 6c5f 6674 7970 655f 746f 5f67   ggml_ftype_to_g
-00021530: 676d 6c5f 7479 7065 2865 6e75 6d20 6767  gml_type(enum gg
-00021540: 6d6c 5f66 7479 7065 2066 7479 7065 2920  ml_ftype ftype) 
-00021550: 7b0a 2020 2020 656e 756d 2067 676d 6c5f  {.    enum ggml_
-00021560: 7479 7065 2077 7479 7065 203d 2047 474d  type wtype = GGM
-00021570: 4c5f 5459 5045 5f43 4f55 4e54 3b0a 0a20  L_TYPE_COUNT;.. 
-00021580: 2020 2073 7769 7463 6820 2866 7479 7065     switch (ftype
-00021590: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-000215a0: 2047 474d 4c5f 4654 5950 455f 414c 4c5f   GGML_FTYPE_ALL_
-000215b0: 4633 323a 2020 2020 2020 2020 2020 2020  F32:            
-000215c0: 2020 7774 7970 6520 3d20 4747 4d4c 5f54    wtype = GGML_T
-000215d0: 5950 455f 4633 323b 2020 2062 7265 616b  YPE_F32;   break
-000215e0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000215f0: 474d 4c5f 4654 5950 455f 4d4f 5354 4c59  GML_FTYPE_MOSTLY
-00021600: 5f46 3136 3a20 2020 2020 2020 2020 2020  _F16:           
-00021610: 7774 7970 6520 3d20 4747 4d4c 5f54 5950  wtype = GGML_TYP
-00021620: 455f 4631 363b 2020 2062 7265 616b 3b0a  E_F16;   break;.
-00021630: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00021640: 4c5f 4654 5950 455f 4d4f 5354 4c59 5f51  L_FTYPE_MOSTLY_Q
-00021650: 345f 303a 2020 2020 2020 2020 2020 7774  4_0:          wt
-00021660: 7970 6520 3d20 4747 4d4c 5f54 5950 455f  ype = GGML_TYPE_
-00021670: 5134 5f30 3b20 2062 7265 616b 3b0a 2020  Q4_0;  break;.  
-00021680: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00021690: 4654 5950 455f 4d4f 5354 4c59 5f51 345f  FTYPE_MOSTLY_Q4_
-000216a0: 313a 2020 2020 2020 2020 2020 7774 7970  1:          wtyp
-000216b0: 6520 3d20 4747 4d4c 5f54 5950 455f 5134  e = GGML_TYPE_Q4
-000216c0: 5f31 3b20 2062 7265 616b 3b0a 2020 2020  _1;  break;.    
-000216d0: 2020 2020 6361 7365 2047 474d 4c5f 4654      case GGML_FT
-000216e0: 5950 455f 4d4f 5354 4c59 5f51 355f 303a  YPE_MOSTLY_Q5_0:
-000216f0: 2020 2020 2020 2020 2020 7774 7970 6520            wtype 
-00021700: 3d20 4747 4d4c 5f54 5950 455f 5135 5f30  = GGML_TYPE_Q5_0
-00021710: 3b20 2062 7265 616b 3b0a 2020 2020 2020  ;  break;.      
-00021720: 2020 6361 7365 2047 474d 4c5f 4654 5950    case GGML_FTYP
-00021730: 455f 4d4f 5354 4c59 5f51 355f 313a 2020  E_MOSTLY_Q5_1:  
-00021740: 2020 2020 2020 2020 7774 7970 6520 3d20          wtype = 
-00021750: 4747 4d4c 5f54 5950 455f 5135 5f31 3b20  GGML_TYPE_Q5_1; 
-00021760: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00021770: 6361 7365 2047 474d 4c5f 4654 5950 455f  case GGML_FTYPE_
-00021780: 4d4f 5354 4c59 5f51 385f 303a 2020 2020  MOSTLY_Q8_0:    
-00021790: 2020 2020 2020 7774 7970 6520 3d20 4747        wtype = GG
-000217a0: 4d4c 5f54 5950 455f 5138 5f30 3b20 2062  ML_TYPE_Q8_0;  b
-000217b0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-000217c0: 7365 2047 474d 4c5f 4654 5950 455f 4d4f  se GGML_FTYPE_MO
-000217d0: 5354 4c59 5f51 325f 4b3a 2020 2020 2020  STLY_Q2_K:      
-000217e0: 2020 2020 7774 7970 6520 3d20 4747 4d4c      wtype = GGML
-000217f0: 5f54 5950 455f 5132 5f4b 3b20 2062 7265  _TYPE_Q2_K;  bre
-00021800: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00021810: 2047 474d 4c5f 4654 5950 455f 4d4f 5354   GGML_FTYPE_MOST
-00021820: 4c59 5f51 335f 4b3a 2020 2020 2020 2020  LY_Q3_K:        
-00021830: 2020 7774 7970 6520 3d20 4747 4d4c 5f54    wtype = GGML_T
-00021840: 5950 455f 5133 5f4b 3b20 2062 7265 616b  YPE_Q3_K;  break
-00021850: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00021860: 474d 4c5f 4654 5950 455f 4d4f 5354 4c59  GML_FTYPE_MOSTLY
-00021870: 5f51 345f 4b3a 2020 2020 2020 2020 2020  _Q4_K:          
-00021880: 7774 7970 6520 3d20 4747 4d4c 5f54 5950  wtype = GGML_TYP
-00021890: 455f 5134 5f4b 3b20 2062 7265 616b 3b0a  E_Q4_K;  break;.
-000218a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000218b0: 4c5f 4654 5950 455f 4d4f 5354 4c59 5f51  L_FTYPE_MOSTLY_Q
-000218c0: 355f 4b3a 2020 2020 2020 2020 2020 7774  5_K:          wt
-000218d0: 7970 6520 3d20 4747 4d4c 5f54 5950 455f  ype = GGML_TYPE_
-000218e0: 5135 5f4b 3b20 2062 7265 616b 3b0a 2020  Q5_K;  break;.  
-000218f0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00021900: 4654 5950 455f 4d4f 5354 4c59 5f51 365f  FTYPE_MOSTLY_Q6_
-00021910: 4b3a 2020 2020 2020 2020 2020 7774 7970  K:          wtyp
-00021920: 6520 3d20 4747 4d4c 5f54 5950 455f 5136  e = GGML_TYPE_Q6
-00021930: 5f4b 3b20 2062 7265 616b 3b0a 2020 2020  _K;  break;.    
-00021940: 2020 2020 6361 7365 2047 474d 4c5f 4654      case GGML_FT
-00021950: 5950 455f 554e 4b4e 4f57 4e3a 2020 2020  YPE_UNKNOWN:    
-00021960: 2020 2020 2020 2020 2020 7774 7970 6520            wtype 
-00021970: 3d20 4747 4d4c 5f54 5950 455f 434f 554e  = GGML_TYPE_COUN
-00021980: 543b 2062 7265 616b 3b0a 2020 2020 2020  T; break;.      
-00021990: 2020 6361 7365 2047 474d 4c5f 4654 5950    case GGML_FTYP
-000219a0: 455f 4d4f 5354 4c59 5f51 345f 315f 534f  E_MOSTLY_Q4_1_SO
-000219b0: 4d45 5f46 3136 3a20 7774 7970 6520 3d20  ME_F16: wtype = 
-000219c0: 4747 4d4c 5f54 5950 455f 434f 554e 543b  GGML_TYPE_COUNT;
-000219d0: 2062 7265 616b 3b0a 2020 2020 7d0a 0a20   break;.    }.. 
-000219e0: 2020 2047 474d 4c5f 4153 5345 5254 2877     GGML_ASSERT(w
-000219f0: 7479 7065 2021 3d20 4747 4d4c 5f54 5950  type != GGML_TYP
-00021a00: 455f 434f 554e 5429 3b0a 0a20 2020 2072  E_COUNT);..    r
-00021a10: 6574 7572 6e20 7774 7970 653b 0a7d 0a0a  eturn wtype;.}..
-00021a20: 7369 7a65 5f74 2067 676d 6c5f 7465 6e73  size_t ggml_tens
-00021a30: 6f72 5f6f 7665 7268 6561 6428 766f 6964  or_overhead(void
-00021a40: 2920 7b0a 2020 2020 7265 7475 726e 2047  ) {.    return G
-00021a50: 474d 4c5f 4f42 4a45 4354 5f53 495a 4520  GML_OBJECT_SIZE 
-00021a60: 2b20 4747 4d4c 5f54 454e 534f 525f 5349  + GGML_TENSOR_SI
-00021a70: 5a45 202b 2031 363b 0a7d 0a0a 626f 6f6c  ZE + 16;.}..bool
-00021a80: 2067 676d 6c5f 6973 5f74 7261 6e73 706f   ggml_is_transpo
-00021a90: 7365 6428 636f 6e73 7420 7374 7275 6374  sed(const struct
-00021aa0: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
-00021ab0: 656e 736f 7229 207b 0a20 2020 2072 6574  ensor) {.    ret
-00021ac0: 7572 6e20 7465 6e73 6f72 2d3e 6e62 5b30  urn tensor->nb[0
-00021ad0: 5d20 3e20 7465 6e73 6f72 2d3e 6e62 5b31  ] > tensor->nb[1
-00021ae0: 5d3b 0a7d 0a0a 626f 6f6c 2067 676d 6c5f  ];.}..bool ggml_
-00021af0: 6973 5f63 6f6e 7469 6775 6f75 7328 636f  is_contiguous(co
-00021b00: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00021b10: 7465 6e73 6f72 202a 2074 656e 736f 7229  tensor * tensor)
-00021b20: 207b 0a20 2020 2073 7461 7469 635f 6173   {.    static_as
-00021b30: 7365 7274 2847 474d 4c5f 4d41 585f 4449  sert(GGML_MAX_DI
-00021b40: 4d53 203d 3d20 342c 2022 4747 4d4c 5f4d  MS == 4, "GGML_M
-00021b50: 4158 5f44 494d 5320 6973 206e 6f74 2034  AX_DIMS is not 4
-00021b60: 202d 2075 7064 6174 6520 7468 6973 2066   - update this f
-00021b70: 756e 6374 696f 6e22 293b 0a0a 2020 2020  unction");..    
-00021b80: 7265 7475 726e 0a20 2020 2020 2020 2074  return.        t
-00021b90: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
-00021ba0: 4747 4d4c 5f54 5950 455f 5349 5a45 5b74  GGML_TYPE_SIZE[t
-00021bb0: 656e 736f 722d 3e74 7970 655d 2026 260a  ensor->type] &&.
-00021bc0: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
-00021bd0: 6e62 5b31 5d20 3d3d 2028 7465 6e73 6f72  nb[1] == (tensor
-00021be0: 2d3e 6e62 5b30 5d2a 7465 6e73 6f72 2d3e  ->nb[0]*tensor->
-00021bf0: 6e65 5b30 5d29 2f47 474d 4c5f 424c 434b  ne[0])/GGML_BLCK
-00021c00: 5f53 495a 455b 7465 6e73 6f72 2d3e 7479  _SIZE[tensor->ty
-00021c10: 7065 5d20 2626 0a20 2020 2020 2020 2074  pe] &&.        t
-00021c20: 656e 736f 722d 3e6e 625b 325d 203d 3d20  ensor->nb[2] == 
-00021c30: 7465 6e73 6f72 2d3e 6e62 5b31 5d2a 7465  tensor->nb[1]*te
-00021c40: 6e73 6f72 2d3e 6e65 5b31 5d20 2626 0a20  nsor->ne[1] &&. 
-00021c50: 2020 2020 2020 2074 656e 736f 722d 3e6e         tensor->n
-00021c60: 625b 335d 203d 3d20 7465 6e73 6f72 2d3e  b[3] == tensor->
-00021c70: 6e62 5b32 5d2a 7465 6e73 6f72 2d3e 6e65  nb[2]*tensor->ne
-00021c80: 5b32 5d3b 0a7d 0a0a 626f 6f6c 2067 676d  [2];.}..bool ggm
-00021c90: 6c5f 6973 5f70 6572 6d75 7465 6428 636f  l_is_permuted(co
-00021ca0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00021cb0: 7465 6e73 6f72 202a 2074 656e 736f 7229  tensor * tensor)
-00021cc0: 207b 0a20 2020 2073 7461 7469 635f 6173   {.    static_as
-00021cd0: 7365 7274 2847 474d 4c5f 4d41 585f 4449  sert(GGML_MAX_DI
-00021ce0: 4d53 203d 3d20 342c 2022 4747 4d4c 5f4d  MS == 4, "GGML_M
-00021cf0: 4158 5f44 494d 5320 6973 206e 6f74 2034  AX_DIMS is not 4
-00021d00: 202d 2075 7064 6174 6520 7468 6973 2066   - update this f
-00021d10: 756e 6374 696f 6e22 293b 0a0a 2020 2020  unction");..    
-00021d20: 7265 7475 726e 2074 656e 736f 722d 3e6e  return tensor->n
-00021d30: 625b 305d 203e 2074 656e 736f 722d 3e6e  b[0] > tensor->n
-00021d40: 625b 315d 207c 7c20 7465 6e73 6f72 2d3e  b[1] || tensor->
-00021d50: 6e62 5b31 5d20 3e20 7465 6e73 6f72 2d3e  nb[1] > tensor->
-00021d60: 6e62 5b32 5d20 7c7c 2074 656e 736f 722d  nb[2] || tensor-
-00021d70: 3e6e 625b 325d 203e 2074 656e 736f 722d  >nb[2] > tensor-
-00021d80: 3e6e 625b 335d 3b0a 7d0a 0a73 7461 7469  >nb[3];.}..stati
-00021d90: 6320 696e 6c69 6e65 2062 6f6f 6c20 6767  c inline bool gg
-00021da0: 6d6c 5f69 735f 7061 6464 6564 5f31 6428  ml_is_padded_1d(
-00021db0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00021dc0: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
-00021dd0: 7229 207b 0a20 2020 2073 7461 7469 635f  r) {.    static_
-00021de0: 6173 7365 7274 2847 474d 4c5f 4d41 585f  assert(GGML_MAX_
-00021df0: 4449 4d53 203d 3d20 342c 2022 4747 4d4c  DIMS == 4, "GGML
-00021e00: 5f4d 4158 5f44 494d 5320 6973 206e 6f74  _MAX_DIMS is not
-00021e10: 2034 202d 2075 7064 6174 6520 7468 6973   4 - update this
-00021e20: 2066 756e 6374 696f 6e22 293b 0a0a 2020   function");..  
-00021e30: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-00021e40: 2074 656e 736f 722d 3e6e 625b 305d 203d   tensor->nb[0] =
-00021e50: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
-00021e60: 5b74 656e 736f 722d 3e74 7970 655d 2026  [tensor->type] &
-00021e70: 260a 2020 2020 2020 2020 7465 6e73 6f72  &.        tensor
-00021e80: 2d3e 6e62 5b32 5d20 3d3d 2074 656e 736f  ->nb[2] == tenso
-00021e90: 722d 3e6e 625b 315d 2a74 656e 736f 722d  r->nb[1]*tensor-
-00021ea0: 3e6e 655b 315d 2026 260a 2020 2020 2020  >ne[1] &&.      
-00021eb0: 2020 7465 6e73 6f72 2d3e 6e62 5b33 5d20    tensor->nb[3] 
-00021ec0: 3d3d 2074 656e 736f 722d 3e6e 625b 325d  == tensor->nb[2]
-00021ed0: 2a74 656e 736f 722d 3e6e 655b 325d 3b0a  *tensor->ne[2];.
-00021ee0: 7d0a 0a73 7461 7469 6320 696e 6c69 6e65  }..static inline
-00021ef0: 2062 6f6f 6c20 6767 6d6c 5f61 7265 5f73   bool ggml_are_s
-00021f00: 616d 655f 7368 6170 6528 636f 6e73 7420  ame_shape(const 
-00021f10: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00021f20: 6f72 202a 2074 302c 2063 6f6e 7374 2073  or * t0, const s
-00021f30: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00021f40: 7220 2a20 7431 2920 7b0a 2020 2020 7374  r * t1) {.    st
-00021f50: 6174 6963 5f61 7373 6572 7428 4747 4d4c  atic_assert(GGML
-00021f60: 5f4d 4158 5f44 494d 5320 3d3d 2034 2c20  _MAX_DIMS == 4, 
-00021f70: 2247 474d 4c5f 4d41 585f 4449 4d53 2069  "GGML_MAX_DIMS i
-00021f80: 7320 6e6f 7420 3420 2d20 7570 6461 7465  s not 4 - update
-00021f90: 2074 6869 7320 6675 6e63 7469 6f6e 2229   this function")
-00021fa0: 3b0a 0a20 2020 2072 6574 7572 6e0a 2020  ;..    return.  
-00021fb0: 2020 2020 2020 2874 302d 3e6e 655b 305d        (t0->ne[0]
-00021fc0: 203d 3d20 7431 2d3e 6e65 5b30 5d20 2920   == t1->ne[0] ) 
-00021fd0: 2626 0a20 2020 2020 2020 2028 7430 2d3e  &&.        (t0->
-00021fe0: 6e65 5b31 5d20 3d3d 2074 312d 3e6e 655b  ne[1] == t1->ne[
-00021ff0: 315d 2029 2026 260a 2020 2020 2020 2020  1] ) &&.        
-00022000: 2874 302d 3e6e 655b 325d 203d 3d20 7431  (t0->ne[2] == t1
-00022010: 2d3e 6e65 5b32 5d20 2920 2626 0a20 2020  ->ne[2] ) &&.   
-00022020: 2020 2020 2028 7430 2d3e 6e65 5b33 5d20       (t0->ne[3] 
-00022030: 3d3d 2074 312d 3e6e 655b 335d 2029 3b0a  == t1->ne[3] );.
-00022040: 7d0a 0a2f 2f20 6368 6563 6b20 6966 2074  }..// check if t
-00022050: 3120 6361 6e20 6265 2072 6570 7265 7365  1 can be represe
-00022060: 6e74 6564 2061 7320 6120 7265 7065 6174  nted as a repeat
-00022070: 6974 696f 6e20 6f66 2074 300a 7374 6174  ition of t0.stat
-00022080: 6963 2069 6e6c 696e 6520 626f 6f6c 2067  ic inline bool g
-00022090: 676d 6c5f 6361 6e5f 7265 7065 6174 2863  gml_can_repeat(c
-000220a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000220b0: 5f74 656e 736f 7220 2a20 7430 2c20 636f  _tensor * t0, co
-000220c0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000220d0: 7465 6e73 6f72 202a 2074 3129 207b 0a20  tensor * t1) {. 
-000220e0: 2020 2073 7461 7469 635f 6173 7365 7274     static_assert
-000220f0: 2847 474d 4c5f 4d41 585f 4449 4d53 203d  (GGML_MAX_DIMS =
-00022100: 3d20 342c 2022 4747 4d4c 5f4d 4158 5f44  = 4, "GGML_MAX_D
-00022110: 494d 5320 6973 206e 6f74 2034 202d 2075  IMS is not 4 - u
-00022120: 7064 6174 6520 7468 6973 2066 756e 6374  pdate this funct
-00022130: 696f 6e22 293b 0a0a 2020 2020 7265 7475  ion");..    retu
-00022140: 726e 0a20 2020 2020 2020 2028 7431 2d3e  rn.        (t1->
-00022150: 6e65 5b30 5d25 7430 2d3e 6e65 5b30 5d20  ne[0]%t0->ne[0] 
-00022160: 3d3d 2030 2920 2626 0a20 2020 2020 2020  == 0) &&.       
-00022170: 2028 7431 2d3e 6e65 5b31 5d25 7430 2d3e   (t1->ne[1]%t0->
-00022180: 6e65 5b31 5d20 3d3d 2030 2920 2626 0a20  ne[1] == 0) &&. 
-00022190: 2020 2020 2020 2028 7431 2d3e 6e65 5b32         (t1->ne[2
-000221a0: 5d25 7430 2d3e 6e65 5b32 5d20 3d3d 2030  ]%t0->ne[2] == 0
-000221b0: 2920 2626 0a20 2020 2020 2020 2028 7431  ) &&.        (t1
-000221c0: 2d3e 6e65 5b33 5d25 7430 2d3e 6e65 5b33  ->ne[3]%t0->ne[3
-000221d0: 5d20 3d3d 2030 293b 0a7d 0a0a 7374 6174  ] == 0);.}..stat
-000221e0: 6963 2069 6e6c 696e 6520 626f 6f6c 2067  ic inline bool g
-000221f0: 676d 6c5f 6361 6e5f 7265 7065 6174 5f72  gml_can_repeat_r
-00022200: 6f77 7328 636f 6e73 7420 7374 7275 6374  ows(const struct
-00022210: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
-00022220: 302c 2063 6f6e 7374 2073 7472 7563 7420  0, const struct 
-00022230: 6767 6d6c 5f74 656e 736f 7220 2a20 7431  ggml_tensor * t1
-00022240: 2920 7b0a 2020 2020 7374 6174 6963 5f61  ) {.    static_a
-00022250: 7373 6572 7428 4747 4d4c 5f4d 4158 5f44  ssert(GGML_MAX_D
-00022260: 494d 5320 3d3d 2034 2c20 2247 474d 4c5f  IMS == 4, "GGML_
-00022270: 4d41 585f 4449 4d53 2069 7320 6e6f 7420  MAX_DIMS is not 
-00022280: 3420 2d20 7570 6461 7465 2074 6869 7320  4 - update this 
-00022290: 6675 6e63 7469 6f6e 2229 3b0a 0a20 2020  function");..   
-000222a0: 2072 6574 7572 6e20 2874 302d 3e6e 655b   return (t0->ne[
-000222b0: 305d 203d 3d20 7431 2d3e 6e65 5b30 5d29  0] == t1->ne[0])
-000222c0: 2026 2620 6767 6d6c 5f63 616e 5f72 6570   && ggml_can_rep
-000222d0: 6561 7428 7430 2c20 7431 293b 0a7d 0a0a  eat(t0, t1);.}..
-000222e0: 7374 6174 6963 2069 6e6c 696e 6520 696e  static inline in
-000222f0: 7420 6767 6d6c 5f75 7033 3228 696e 7420  t ggml_up32(int 
-00022300: 6e29 207b 0a20 2020 2072 6574 7572 6e20  n) {.    return 
-00022310: 286e 202b 2033 3129 2026 207e 3331 3b0a  (n + 31) & ~31;.
-00022320: 7d0a 0a2f 2f73 7461 7469 6320 696e 6c69  }..//static inli
-00022330: 6e65 2069 6e74 2067 676d 6c5f 7570 3634  ne int ggml_up64
-00022340: 2869 6e74 206e 2920 7b0a 2f2f 2020 2020  (int n) {.//    
-00022350: 7265 7475 726e 2028 6e20 2b20 3633 2920  return (n + 63) 
-00022360: 2620 7e36 333b 0a2f 2f7d 0a0a 7374 6174  & ~63;.//}..stat
-00022370: 6963 2069 6e6c 696e 6520 696e 7420 6767  ic inline int gg
-00022380: 6d6c 5f75 7028 696e 7420 6e2c 2069 6e74  ml_up(int n, int
-00022390: 206d 2920 7b0a 2020 2020 2f2f 2061 7373   m) {.    // ass
-000223a0: 6572 7420 6d20 6973 2061 2070 6f77 6572  ert m is a power
-000223b0: 206f 6620 320a 2020 2020 4747 4d4c 5f41   of 2.    GGML_A
-000223c0: 5353 4552 5428 286d 2026 2028 6d20 2d20  SSERT((m & (m - 
-000223d0: 3129 2920 3d3d 2030 293b 0a20 2020 2072  1)) == 0);.    r
-000223e0: 6574 7572 6e20 286e 202b 206d 202d 2031  eturn (n + m - 1
-000223f0: 2920 2620 7e28 6d20 2d20 3129 3b0a 7d0a  ) & ~(m - 1);.}.
-00022400: 0a2f 2f20 6173 7365 7274 2074 6861 7420  .// assert that 
-00022410: 706f 696e 7465 7220 6973 2061 6c69 676e  pointer is align
-00022420: 6564 2074 6f20 4747 4d4c 5f4d 454d 5f41  ed to GGML_MEM_A
-00022430: 4c49 474e 0a23 6465 6669 6e65 2067 676d  LIGN.#define ggm
-00022440: 6c5f 6173 7365 7274 5f61 6c69 676e 6564  l_assert_aligned
-00022450: 2870 7472 2920 5c0a 2020 2020 4747 4d4c  (ptr) \.    GGML
-00022460: 5f41 5353 4552 5428 2828 7569 6e74 7074  _ASSERT(((uintpt
-00022470: 725f 7429 2028 7074 7229 2925 4747 4d4c  r_t) (ptr))%GGML
-00022480: 5f4d 454d 5f41 4c49 474e 203d 3d20 3029  _MEM_ALIGN == 0)
-00022490: 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ..//////////////
+00020690: 2f2f 2f2f 2f2f 0a0a 766f 6964 2067 676d  //////..void ggm
+000206a0: 6c5f 7072 696e 745f 6f62 6a65 6374 2863  l_print_object(c
+000206b0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+000206c0: 5f6f 626a 6563 7420 2a20 6f62 6a29 207b  _object * obj) {
+000206d0: 0a20 2020 2047 474d 4c5f 5052 494e 5428  .    GGML_PRINT(
+000206e0: 2220 2d20 6767 6d6c 5f6f 626a 6563 743a  " - ggml_object:
+000206f0: 206f 6666 7365 7420 3d20 257a 752c 2073   offset = %zu, s
+00020700: 697a 6520 3d20 257a 752c 206e 6578 7420  ize = %zu, next 
+00020710: 3d20 2570 5c6e 222c 0a20 2020 2020 2020  = %p\n",.       
+00020720: 2020 2020 206f 626a 2d3e 6f66 6673 2c20       obj->offs, 
+00020730: 6f62 6a2d 3e73 697a 652c 2028 636f 6e73  obj->size, (cons
+00020740: 7420 766f 6964 202a 2920 6f62 6a2d 3e6e  t void *) obj->n
+00020750: 6578 7429 3b0a 7d0a 0a76 6f69 6420 6767  ext);.}..void gg
+00020760: 6d6c 5f70 7269 6e74 5f6f 626a 6563 7473  ml_print_objects
+00020770: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
+00020780: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+00020790: 2920 7b0a 2020 2020 7374 7275 6374 2067  ) {.    struct g
+000207a0: 676d 6c5f 6f62 6a65 6374 202a 206f 626a  gml_object * obj
+000207b0: 203d 2063 7478 2d3e 6f62 6a65 6374 735f   = ctx->objects_
+000207c0: 6265 6769 6e3b 0a0a 2020 2020 4747 4d4c  begin;..    GGML
+000207d0: 5f50 5249 4e54 2822 2573 3a20 6f62 6a65  _PRINT("%s: obje
+000207e0: 6374 7320 696e 2063 6f6e 7465 7874 2025  cts in context %
+000207f0: 703a 5c6e 222c 205f 5f66 756e 635f 5f2c  p:\n", __func__,
+00020800: 2028 636f 6e73 7420 766f 6964 202a 2920   (const void *) 
+00020810: 6374 7829 3b0a 0a20 2020 2077 6869 6c65  ctx);..    while
+00020820: 2028 6f62 6a20 213d 204e 554c 4c29 207b   (obj != NULL) {
+00020830: 0a20 2020 2020 2020 2067 676d 6c5f 7072  .        ggml_pr
+00020840: 696e 745f 6f62 6a65 6374 286f 626a 293b  int_object(obj);
+00020850: 0a20 2020 2020 2020 206f 626a 203d 206f  .        obj = o
+00020860: 626a 2d3e 6e65 7874 3b0a 2020 2020 7d0a  bj->next;.    }.
+00020870: 0a20 2020 2047 474d 4c5f 5052 494e 5428  .    GGML_PRINT(
+00020880: 2225 733a 202d 2d2d 2065 6e64 202d 2d2d  "%s: --- end ---
+00020890: 5c6e 222c 205f 5f66 756e 635f 5f29 3b0a  \n", __func__);.
+000208a0: 7d0a 0a69 6e74 3634 5f74 2067 676d 6c5f  }..int64_t ggml_
+000208b0: 6e65 6c65 6d65 6e74 7328 636f 6e73 7420  nelements(const 
+000208c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000208d0: 6f72 202a 2074 656e 736f 7229 207b 0a20  or * tensor) {. 
+000208e0: 2020 2073 7461 7469 635f 6173 7365 7274     static_assert
+000208f0: 2847 474d 4c5f 4d41 585f 4449 4d53 203d  (GGML_MAX_DIMS =
+00020900: 3d20 342c 2022 4747 4d4c 5f4d 4158 5f44  = 4, "GGML_MAX_D
+00020910: 494d 5320 6973 206e 6f74 2034 202d 2075  IMS is not 4 - u
+00020920: 7064 6174 6520 7468 6973 2066 756e 6374  pdate this funct
+00020930: 696f 6e22 293b 0a0a 2020 2020 7265 7475  ion");..    retu
+00020940: 726e 2074 656e 736f 722d 3e6e 655b 305d  rn tensor->ne[0]
+00020950: 2a74 656e 736f 722d 3e6e 655b 315d 2a74  *tensor->ne[1]*t
+00020960: 656e 736f 722d 3e6e 655b 325d 2a74 656e  ensor->ne[2]*ten
+00020970: 736f 722d 3e6e 655b 335d 3b0a 7d0a 0a69  sor->ne[3];.}..i
+00020980: 6e74 3634 5f74 2067 676d 6c5f 6e72 6f77  nt64_t ggml_nrow
+00020990: 7328 636f 6e73 7420 7374 7275 6374 2067  s(const struct g
+000209a0: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
+000209b0: 736f 7229 207b 0a20 2020 2073 7461 7469  sor) {.    stati
+000209c0: 635f 6173 7365 7274 2847 474d 4c5f 4d41  c_assert(GGML_MA
+000209d0: 585f 4449 4d53 203d 3d20 342c 2022 4747  X_DIMS == 4, "GG
+000209e0: 4d4c 5f4d 4158 5f44 494d 5320 6973 206e  ML_MAX_DIMS is n
+000209f0: 6f74 2034 202d 2075 7064 6174 6520 7468  ot 4 - update th
+00020a00: 6973 2066 756e 6374 696f 6e22 293b 0a0a  is function");..
+00020a10: 2020 2020 7265 7475 726e 2074 656e 736f      return tenso
+00020a20: 722d 3e6e 655b 315d 2a74 656e 736f 722d  r->ne[1]*tensor-
+00020a30: 3e6e 655b 325d 2a74 656e 736f 722d 3e6e  >ne[2]*tensor->n
+00020a40: 655b 335d 3b0a 7d0a 0a73 697a 655f 7420  e[3];.}..size_t 
+00020a50: 6767 6d6c 5f6e 6279 7465 7328 636f 6e73  ggml_nbytes(cons
+00020a60: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00020a70: 6e73 6f72 202a 2074 656e 736f 7229 207b  nsor * tensor) {
+00020a80: 0a20 2020 2073 7461 7469 635f 6173 7365  .    static_asse
+00020a90: 7274 2847 474d 4c5f 4d41 585f 4449 4d53  rt(GGML_MAX_DIMS
+00020aa0: 203d 3d20 342c 2022 4747 4d4c 5f4d 4158   == 4, "GGML_MAX
+00020ab0: 5f44 494d 5320 6973 206e 6f74 2034 202d  _DIMS is not 4 -
+00020ac0: 2075 7064 6174 6520 7468 6973 2066 756e   update this fun
+00020ad0: 6374 696f 6e22 293b 0a0a 2020 2020 2f2f  ction");..    //
+00020ae0: 2074 6869 7320 7368 6f75 6c64 2068 616e   this should han
+00020af0: 646c 6520 6361 7365 7320 7768 6572 6520  dle cases where 
+00020b00: 7468 6520 7465 6e73 6f72 2069 7320 6e6f  the tensor is no
+00020b10: 7420 636f 6e74 6967 756f 7573 2069 6e20  t contiguous in 
+00020b20: 6d65 6d6f 7279 0a20 2020 202f 2f20 7072  memory.    // pr
+00020b30: 6f62 6162 7920 6a75 7374 3a0a 2020 2020  obaby just:.    
+00020b40: 2f2f 0a20 2020 202f 2f20 2020 2020 7265  //.    //     re
+00020b50: 7475 726e 2074 656e 736f 722d 3e6e 655b  turn tensor->ne[
+00020b60: 335d 2a74 656e 736f 722d 3e6e 625b 335d  3]*tensor->nb[3]
+00020b70: 0a20 2020 202f 2f0a 2020 2020 2f2f 2069  .    //.    // i
+00020b80: 7320 656e 6f75 6768 2c20 6275 7420 6a75  s enough, but ju
+00020b90: 7374 2069 6e20 6361 7365 2c20 6164 6469  st in case, addi
+00020ba0: 6e67 2074 6865 2073 6563 6f6e 6420 7061  ng the second pa
+00020bb0: 7274 0a0a 2020 2020 7265 7475 726e 204d  rt..    return M
+00020bc0: 4158 2874 656e 736f 722d 3e6e 655b 335d  AX(tensor->ne[3]
+00020bd0: 2a74 656e 736f 722d 3e6e 625b 335d 2c20  *tensor->nb[3], 
+00020be0: 2867 676d 6c5f 6e65 6c65 6d65 6e74 7328  (ggml_nelements(
+00020bf0: 7465 6e73 6f72 292a 4747 4d4c 5f54 5950  tensor)*GGML_TYP
+00020c00: 455f 5349 5a45 5b74 656e 736f 722d 3e74  E_SIZE[tensor->t
+00020c10: 7970 655d 292f 4747 4d4c 5f42 4c43 4b5f  ype])/GGML_BLCK_
+00020c20: 5349 5a45 5b74 656e 736f 722d 3e74 7970  SIZE[tensor->typ
+00020c30: 655d 293b 0a7d 0a0a 7369 7a65 5f74 2067  e]);.}..size_t g
+00020c40: 676d 6c5f 6e62 7974 6573 5f73 706c 6974  gml_nbytes_split
+00020c50: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
+00020c60: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+00020c70: 6f72 2c20 696e 7420 6e72 6f77 735f 7370  or, int nrows_sp
+00020c80: 6c69 7429 207b 0a20 2020 2073 7461 7469  lit) {.    stati
+00020c90: 635f 6173 7365 7274 2847 474d 4c5f 4d41  c_assert(GGML_MA
+00020ca0: 585f 4449 4d53 203d 3d20 342c 2022 4747  X_DIMS == 4, "GG
+00020cb0: 4d4c 5f4d 4158 5f44 494d 5320 6973 206e  ML_MAX_DIMS is n
+00020cc0: 6f74 2034 202d 2075 7064 6174 6520 7468  ot 4 - update th
+00020cd0: 6973 2066 756e 6374 696f 6e22 293b 0a0a  is function");..
+00020ce0: 2020 2020 7265 7475 726e 2028 6e72 6f77      return (nrow
+00020cf0: 735f 7370 6c69 742a 7465 6e73 6f72 2d3e  s_split*tensor->
+00020d00: 6e65 5b30 5d2a 4747 4d4c 5f54 5950 455f  ne[0]*GGML_TYPE_
+00020d10: 5349 5a45 5b74 656e 736f 722d 3e74 7970  SIZE[tensor->typ
+00020d20: 655d 292f 4747 4d4c 5f42 4c43 4b5f 5349  e])/GGML_BLCK_SI
+00020d30: 5a45 5b74 656e 736f 722d 3e74 7970 655d  ZE[tensor->type]
+00020d40: 3b0a 7d0a 0a69 6e74 2067 676d 6c5f 626c  ;.}..int ggml_bl
+00020d50: 636b 5f73 697a 6528 656e 756d 2067 676d  ck_size(enum ggm
+00020d60: 6c5f 7479 7065 2074 7970 6529 207b 0a20  l_type type) {. 
+00020d70: 2020 2072 6574 7572 6e20 4747 4d4c 5f42     return GGML_B
+00020d80: 4c43 4b5f 5349 5a45 5b74 7970 655d 3b0a  LCK_SIZE[type];.
+00020d90: 7d0a 0a73 697a 655f 7420 6767 6d6c 5f74  }..size_t ggml_t
+00020da0: 7970 655f 7369 7a65 2865 6e75 6d20 6767  ype_size(enum gg
+00020db0: 6d6c 5f74 7970 6520 7479 7065 2920 7b0a  ml_type type) {.
+00020dc0: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
+00020dd0: 5459 5045 5f53 495a 455b 7479 7065 5d3b  TYPE_SIZE[type];
+00020de0: 0a7d 0a0a 666c 6f61 7420 6767 6d6c 5f74  .}..float ggml_t
+00020df0: 7970 655f 7369 7a65 6628 656e 756d 2067  ype_sizef(enum g
+00020e00: 676d 6c5f 7479 7065 2074 7970 6529 207b  gml_type type) {
+00020e10: 0a20 2020 2072 6574 7572 6e20 2828 666c  .    return ((fl
+00020e20: 6f61 7429 2847 474d 4c5f 5459 5045 5f53  oat)(GGML_TYPE_S
+00020e30: 495a 455b 7479 7065 5d29 292f 4747 4d4c  IZE[type]))/GGML
+00020e40: 5f42 4c43 4b5f 5349 5a45 5b74 7970 655d  _BLCK_SIZE[type]
+00020e50: 3b0a 7d0a 0a63 6f6e 7374 2063 6861 7220  ;.}..const char 
+00020e60: 2a20 6767 6d6c 5f74 7970 655f 6e61 6d65  * ggml_type_name
+00020e70: 2865 6e75 6d20 6767 6d6c 5f74 7970 6520  (enum ggml_type 
+00020e80: 7479 7065 2920 7b0a 2020 2020 7265 7475  type) {.    retu
+00020e90: 726e 2047 474d 4c5f 5459 5045 5f4e 414d  rn GGML_TYPE_NAM
+00020ea0: 455b 7479 7065 5d3b 0a7d 0a0a 636f 6e73  E[type];.}..cons
+00020eb0: 7420 6368 6172 202a 2067 676d 6c5f 6f70  t char * ggml_op
+00020ec0: 5f6e 616d 6528 656e 756d 2067 676d 6c5f  _name(enum ggml_
+00020ed0: 6f70 206f 7029 207b 0a20 2020 2072 6574  op op) {.    ret
+00020ee0: 7572 6e20 4747 4d4c 5f4f 505f 4e41 4d45  urn GGML_OP_NAME
+00020ef0: 5b6f 705d 3b0a 7d0a 0a73 697a 655f 7420  [op];.}..size_t 
+00020f00: 6767 6d6c 5f65 6c65 6d65 6e74 5f73 697a  ggml_element_siz
+00020f10: 6528 636f 6e73 7420 7374 7275 6374 2067  e(const struct g
+00020f20: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
+00020f30: 736f 7229 207b 0a20 2020 2072 6574 7572  sor) {.    retur
+00020f40: 6e20 4747 4d4c 5f54 5950 455f 5349 5a45  n GGML_TYPE_SIZE
+00020f50: 5b74 656e 736f 722d 3e74 7970 655d 3b0a  [tensor->type];.
+00020f60: 7d0a 0a73 7461 7469 6320 696e 6c69 6e65  }..static inline
+00020f70: 2062 6f6f 6c20 6767 6d6c 5f69 735f 7363   bool ggml_is_sc
+00020f80: 616c 6172 2863 6f6e 7374 2073 7472 7563  alar(const struc
+00020f90: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00020fa0: 7465 6e73 6f72 2920 7b0a 2020 2020 7374  tensor) {.    st
+00020fb0: 6174 6963 5f61 7373 6572 7428 4747 4d4c  atic_assert(GGML
+00020fc0: 5f4d 4158 5f44 494d 5320 3d3d 2034 2c20  _MAX_DIMS == 4, 
+00020fd0: 2247 474d 4c5f 4d41 585f 4449 4d53 2069  "GGML_MAX_DIMS i
+00020fe0: 7320 6e6f 7420 3420 2d20 7570 6461 7465  s not 4 - update
+00020ff0: 2074 6869 7320 6675 6e63 7469 6f6e 2229   this function")
+00021000: 3b0a 0a20 2020 2072 6574 7572 6e20 7465  ;..    return te
+00021010: 6e73 6f72 2d3e 6e65 5b30 5d20 3d3d 2031  nsor->ne[0] == 1
+00021020: 2026 2620 7465 6e73 6f72 2d3e 6e65 5b31   && tensor->ne[1
+00021030: 5d20 3d3d 2031 2026 2620 7465 6e73 6f72  ] == 1 && tensor
+00021040: 2d3e 6e65 5b32 5d20 3d3d 2031 2026 2620  ->ne[2] == 1 && 
+00021050: 7465 6e73 6f72 2d3e 6e65 5b33 5d20 3d3d  tensor->ne[3] ==
+00021060: 2031 3b0a 7d0a 0a73 7461 7469 6320 696e   1;.}..static in
+00021070: 6c69 6e65 2062 6f6f 6c20 6767 6d6c 5f69  line bool ggml_i
+00021080: 735f 7665 6374 6f72 2863 6f6e 7374 2073  s_vector(const s
+00021090: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000210a0: 7220 2a20 7465 6e73 6f72 2920 7b0a 2020  r * tensor) {.  
+000210b0: 2020 7374 6174 6963 5f61 7373 6572 7428    static_assert(
+000210c0: 4747 4d4c 5f4d 4158 5f44 494d 5320 3d3d  GGML_MAX_DIMS ==
+000210d0: 2034 2c20 2247 474d 4c5f 4d41 585f 4449   4, "GGML_MAX_DI
+000210e0: 4d53 2069 7320 6e6f 7420 3420 2d20 7570  MS is not 4 - up
+000210f0: 6461 7465 2074 6869 7320 6675 6e63 7469  date this functi
+00021100: 6f6e 2229 3b0a 0a20 2020 2072 6574 7572  on");..    retur
+00021110: 6e20 7465 6e73 6f72 2d3e 6e65 5b31 5d20  n tensor->ne[1] 
+00021120: 3d3d 2031 2026 2620 7465 6e73 6f72 2d3e  == 1 && tensor->
+00021130: 6e65 5b32 5d20 3d3d 2031 2026 2620 7465  ne[2] == 1 && te
+00021140: 6e73 6f72 2d3e 6e65 5b33 5d20 3d3d 2031  nsor->ne[3] == 1
+00021150: 3b0a 7d0a 0a73 7461 7469 6320 696e 6c69  ;.}..static inli
+00021160: 6e65 2062 6f6f 6c20 6767 6d6c 5f69 735f  ne bool ggml_is_
+00021170: 6d61 7472 6978 2863 6f6e 7374 2073 7472  matrix(const str
+00021180: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00021190: 2a20 7465 6e73 6f72 2920 7b0a 2020 2020  * tensor) {.    
+000211a0: 7374 6174 6963 5f61 7373 6572 7428 4747  static_assert(GG
+000211b0: 4d4c 5f4d 4158 5f44 494d 5320 3d3d 2034  ML_MAX_DIMS == 4
+000211c0: 2c20 2247 474d 4c5f 4d41 585f 4449 4d53  , "GGML_MAX_DIMS
+000211d0: 2069 7320 6e6f 7420 3420 2d20 7570 6461   is not 4 - upda
+000211e0: 7465 2074 6869 7320 6675 6e63 7469 6f6e  te this function
+000211f0: 2229 3b0a 0a20 2020 2072 6574 7572 6e20  ");..    return 
+00021200: 7465 6e73 6f72 2d3e 6e65 5b32 5d20 3d3d  tensor->ne[2] ==
+00021210: 2031 2026 2620 7465 6e73 6f72 2d3e 6e65   1 && tensor->ne
+00021220: 5b33 5d20 3d3d 2031 3b0a 7d0a 0a73 7461  [3] == 1;.}..sta
+00021230: 7469 6320 696e 6c69 6e65 2062 6f6f 6c20  tic inline bool 
+00021240: 6767 6d6c 5f63 616e 5f6d 756c 5f6d 6174  ggml_can_mul_mat
+00021250: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
+00021260: 6d6c 5f74 656e 736f 7220 2a20 7430 2c20  ml_tensor * t0, 
+00021270: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00021280: 6c5f 7465 6e73 6f72 202a 2074 3129 207b  l_tensor * t1) {
+00021290: 0a20 2020 2073 7461 7469 635f 6173 7365  .    static_asse
+000212a0: 7274 2847 474d 4c5f 4d41 585f 4449 4d53  rt(GGML_MAX_DIMS
+000212b0: 203d 3d20 342c 2022 4747 4d4c 5f4d 4158   == 4, "GGML_MAX
+000212c0: 5f44 494d 5320 6973 206e 6f74 2034 202d  _DIMS is not 4 -
+000212d0: 2075 7064 6174 6520 7468 6973 2066 756e   update this fun
+000212e0: 6374 696f 6e22 293b 0a0a 2020 2020 7265  ction");..    re
+000212f0: 7475 726e 0a20 2020 2020 2020 2028 7430  turn.        (t0
+00021300: 2d3e 6e65 5b30 5d20 3d3d 2074 312d 3e6e  ->ne[0] == t1->n
+00021310: 655b 305d 2920 2026 260a 2020 2020 2020  e[0])  &&.      
+00021320: 2020 2874 302d 3e6e 655b 325d 203d 3d20    (t0->ne[2] == 
+00021330: 7431 2d3e 6e65 5b32 5d29 2020 2626 0a20  t1->ne[2])  &&. 
+00021340: 2020 2020 2020 2028 7430 2d3e 6e65 5b33         (t0->ne[3
+00021350: 5d20 3d3d 2074 312d 3e6e 655b 335d 293b  ] == t1->ne[3]);
+00021360: 0a7d 0a0a 7374 6174 6963 2069 6e6c 696e  .}..static inlin
+00021370: 6520 626f 6f6c 2067 676d 6c5f 6361 6e5f  e bool ggml_can_
+00021380: 6f75 745f 7072 6f64 2863 6f6e 7374 2073  out_prod(const s
+00021390: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000213a0: 7220 2a20 7430 2c20 636f 6e73 7420 7374  r * t0, const st
+000213b0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000213c0: 202a 2074 3129 207b 0a20 2020 2073 7461   * t1) {.    sta
+000213d0: 7469 635f 6173 7365 7274 2847 474d 4c5f  tic_assert(GGML_
+000213e0: 4d41 585f 4449 4d53 203d 3d20 342c 2022  MAX_DIMS == 4, "
+000213f0: 4747 4d4c 5f4d 4158 5f44 494d 5320 6973  GGML_MAX_DIMS is
+00021400: 206e 6f74 2034 202d 2075 7064 6174 6520   not 4 - update 
+00021410: 7468 6973 2066 756e 6374 696f 6e22 293b  this function");
+00021420: 0a0a 2020 2020 7265 7475 726e 0a20 2020  ..    return.   
+00021430: 2020 2020 2028 7430 2d3e 6e65 5b31 5d20       (t0->ne[1] 
+00021440: 3d3d 2074 312d 3e6e 655b 315d 2920 2026  == t1->ne[1])  &
+00021450: 260a 2020 2020 2020 2020 2874 302d 3e6e  &.        (t0->n
+00021460: 655b 325d 203d 3d20 7431 2d3e 6e65 5b32  e[2] == t1->ne[2
+00021470: 5d29 2020 2626 0a20 2020 2020 2020 2028  ])  &&.        (
+00021480: 7430 2d3e 6e65 5b33 5d20 3d3d 2074 312d  t0->ne[3] == t1-
+00021490: 3e6e 655b 335d 293b 0a7d 0a0a 626f 6f6c  >ne[3]);.}..bool
+000214a0: 2067 676d 6c5f 6973 5f71 7561 6e74 697a   ggml_is_quantiz
+000214b0: 6564 2865 6e75 6d20 6767 6d6c 5f74 7970  ed(enum ggml_typ
+000214c0: 6520 7479 7065 2920 7b0a 2020 2020 7265  e type) {.    re
+000214d0: 7475 726e 2047 474d 4c5f 4953 5f51 5541  turn GGML_IS_QUA
+000214e0: 4e54 495a 4544 5b74 7970 655d 3b0a 7d0a  NTIZED[type];.}.
+000214f0: 0a65 6e75 6d20 6767 6d6c 5f74 7970 6520  .enum ggml_type 
+00021500: 6767 6d6c 5f66 7479 7065 5f74 6f5f 6767  ggml_ftype_to_gg
+00021510: 6d6c 5f74 7970 6528 656e 756d 2067 676d  ml_type(enum ggm
+00021520: 6c5f 6674 7970 6520 6674 7970 6529 207b  l_ftype ftype) {
+00021530: 0a20 2020 2065 6e75 6d20 6767 6d6c 5f74  .    enum ggml_t
+00021540: 7970 6520 7774 7970 6520 3d20 4747 4d4c  ype wtype = GGML
+00021550: 5f54 5950 455f 434f 554e 543b 0a0a 2020  _TYPE_COUNT;..  
+00021560: 2020 7377 6974 6368 2028 6674 7970 6529    switch (ftype)
+00021570: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+00021580: 4747 4d4c 5f46 5459 5045 5f41 4c4c 5f46  GGML_FTYPE_ALL_F
+00021590: 3332 3a20 2020 2020 2020 2020 2020 2020  32:             
+000215a0: 2077 7479 7065 203d 2047 474d 4c5f 5459   wtype = GGML_TY
+000215b0: 5045 5f46 3332 3b20 2020 6272 6561 6b3b  PE_F32;   break;
+000215c0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000215d0: 4d4c 5f46 5459 5045 5f4d 4f53 544c 595f  ML_FTYPE_MOSTLY_
+000215e0: 4631 363a 2020 2020 2020 2020 2020 2077  F16:           w
+000215f0: 7479 7065 203d 2047 474d 4c5f 5459 5045  type = GGML_TYPE
+00021600: 5f46 3136 3b20 2020 6272 6561 6b3b 0a20  _F16;   break;. 
+00021610: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00021620: 5f46 5459 5045 5f4d 4f53 544c 595f 5134  _FTYPE_MOSTLY_Q4
+00021630: 5f30 3a20 2020 2020 2020 2020 2077 7479  _0:          wty
+00021640: 7065 203d 2047 474d 4c5f 5459 5045 5f51  pe = GGML_TYPE_Q
+00021650: 345f 303b 2020 6272 6561 6b3b 0a20 2020  4_0;  break;.   
+00021660: 2020 2020 2063 6173 6520 4747 4d4c 5f46       case GGML_F
+00021670: 5459 5045 5f4d 4f53 544c 595f 5134 5f31  TYPE_MOSTLY_Q4_1
+00021680: 3a20 2020 2020 2020 2020 2077 7479 7065  :          wtype
+00021690: 203d 2047 474d 4c5f 5459 5045 5f51 345f   = GGML_TYPE_Q4_
+000216a0: 313b 2020 6272 6561 6b3b 0a20 2020 2020  1;  break;.     
+000216b0: 2020 2063 6173 6520 4747 4d4c 5f46 5459     case GGML_FTY
+000216c0: 5045 5f4d 4f53 544c 595f 5135 5f30 3a20  PE_MOSTLY_Q5_0: 
+000216d0: 2020 2020 2020 2020 2077 7479 7065 203d           wtype =
+000216e0: 2047 474d 4c5f 5459 5045 5f51 355f 303b   GGML_TYPE_Q5_0;
+000216f0: 2020 6272 6561 6b3b 0a20 2020 2020 2020    break;.       
+00021700: 2063 6173 6520 4747 4d4c 5f46 5459 5045   case GGML_FTYPE
+00021710: 5f4d 4f53 544c 595f 5135 5f31 3a20 2020  _MOSTLY_Q5_1:   
+00021720: 2020 2020 2020 2077 7479 7065 203d 2047         wtype = G
+00021730: 474d 4c5f 5459 5045 5f51 355f 313b 2020  GML_TYPE_Q5_1;  
+00021740: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00021750: 6173 6520 4747 4d4c 5f46 5459 5045 5f4d  ase GGML_FTYPE_M
+00021760: 4f53 544c 595f 5138 5f30 3a20 2020 2020  OSTLY_Q8_0:     
+00021770: 2020 2020 2077 7479 7065 203d 2047 474d       wtype = GGM
+00021780: 4c5f 5459 5045 5f51 385f 303b 2020 6272  L_TYPE_Q8_0;  br
+00021790: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000217a0: 6520 4747 4d4c 5f46 5459 5045 5f4d 4f53  e GGML_FTYPE_MOS
+000217b0: 544c 595f 5132 5f4b 3a20 2020 2020 2020  TLY_Q2_K:       
+000217c0: 2020 2077 7479 7065 203d 2047 474d 4c5f     wtype = GGML_
+000217d0: 5459 5045 5f51 325f 4b3b 2020 6272 6561  TYPE_Q2_K;  brea
+000217e0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+000217f0: 4747 4d4c 5f46 5459 5045 5f4d 4f53 544c  GGML_FTYPE_MOSTL
+00021800: 595f 5133 5f4b 3a20 2020 2020 2020 2020  Y_Q3_K:         
+00021810: 2077 7479 7065 203d 2047 474d 4c5f 5459   wtype = GGML_TY
+00021820: 5045 5f51 335f 4b3b 2020 6272 6561 6b3b  PE_Q3_K;  break;
+00021830: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00021840: 4d4c 5f46 5459 5045 5f4d 4f53 544c 595f  ML_FTYPE_MOSTLY_
+00021850: 5134 5f4b 3a20 2020 2020 2020 2020 2077  Q4_K:          w
+00021860: 7479 7065 203d 2047 474d 4c5f 5459 5045  type = GGML_TYPE
+00021870: 5f51 345f 4b3b 2020 6272 6561 6b3b 0a20  _Q4_K;  break;. 
+00021880: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00021890: 5f46 5459 5045 5f4d 4f53 544c 595f 5135  _FTYPE_MOSTLY_Q5
+000218a0: 5f4b 3a20 2020 2020 2020 2020 2077 7479  _K:          wty
+000218b0: 7065 203d 2047 474d 4c5f 5459 5045 5f51  pe = GGML_TYPE_Q
+000218c0: 355f 4b3b 2020 6272 6561 6b3b 0a20 2020  5_K;  break;.   
+000218d0: 2020 2020 2063 6173 6520 4747 4d4c 5f46       case GGML_F
+000218e0: 5459 5045 5f4d 4f53 544c 595f 5136 5f4b  TYPE_MOSTLY_Q6_K
+000218f0: 3a20 2020 2020 2020 2020 2077 7479 7065  :          wtype
+00021900: 203d 2047 474d 4c5f 5459 5045 5f51 365f   = GGML_TYPE_Q6_
+00021910: 4b3b 2020 6272 6561 6b3b 0a20 2020 2020  K;  break;.     
+00021920: 2020 2063 6173 6520 4747 4d4c 5f46 5459     case GGML_FTY
+00021930: 5045 5f55 4e4b 4e4f 574e 3a20 2020 2020  PE_UNKNOWN:     
+00021940: 2020 2020 2020 2020 2077 7479 7065 203d           wtype =
+00021950: 2047 474d 4c5f 5459 5045 5f43 4f55 4e54   GGML_TYPE_COUNT
+00021960: 3b20 6272 6561 6b3b 0a20 2020 2020 2020  ; break;.       
+00021970: 2063 6173 6520 4747 4d4c 5f46 5459 5045   case GGML_FTYPE
+00021980: 5f4d 4f53 544c 595f 5134 5f31 5f53 4f4d  _MOSTLY_Q4_1_SOM
+00021990: 455f 4631 363a 2077 7479 7065 203d 2047  E_F16: wtype = G
+000219a0: 474d 4c5f 5459 5045 5f43 4f55 4e54 3b20  GML_TYPE_COUNT; 
+000219b0: 6272 6561 6b3b 0a20 2020 207d 0a0a 2020  break;.    }..  
+000219c0: 2020 4747 4d4c 5f41 5353 4552 5428 7774    GGML_ASSERT(wt
+000219d0: 7970 6520 213d 2047 474d 4c5f 5459 5045  ype != GGML_TYPE
+000219e0: 5f43 4f55 4e54 293b 0a0a 2020 2020 7265  _COUNT);..    re
+000219f0: 7475 726e 2077 7479 7065 3b0a 7d0a 0a73  turn wtype;.}..s
+00021a00: 697a 655f 7420 6767 6d6c 5f74 656e 736f  ize_t ggml_tenso
+00021a10: 725f 6f76 6572 6865 6164 2876 6f69 6429  r_overhead(void)
+00021a20: 207b 0a20 2020 2072 6574 7572 6e20 4747   {.    return GG
+00021a30: 4d4c 5f4f 424a 4543 545f 5349 5a45 202b  ML_OBJECT_SIZE +
+00021a40: 2047 474d 4c5f 5445 4e53 4f52 5f53 495a   GGML_TENSOR_SIZ
+00021a50: 4520 2b20 3136 3b0a 7d0a 0a62 6f6f 6c20  E + 16;.}..bool 
+00021a60: 6767 6d6c 5f69 735f 7472 616e 7370 6f73  ggml_is_transpos
+00021a70: 6564 2863 6f6e 7374 2073 7472 7563 7420  ed(const struct 
+00021a80: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
+00021a90: 6e73 6f72 2920 7b0a 2020 2020 7265 7475  nsor) {.    retu
+00021aa0: 726e 2074 656e 736f 722d 3e6e 625b 305d  rn tensor->nb[0]
+00021ab0: 203e 2074 656e 736f 722d 3e6e 625b 315d   > tensor->nb[1]
+00021ac0: 3b0a 7d0a 0a62 6f6f 6c20 6767 6d6c 5f69  ;.}..bool ggml_i
+00021ad0: 735f 636f 6e74 6967 756f 7573 2863 6f6e  s_contiguous(con
+00021ae0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00021af0: 656e 736f 7220 2a20 7465 6e73 6f72 2920  ensor * tensor) 
+00021b00: 7b0a 2020 2020 7374 6174 6963 5f61 7373  {.    static_ass
+00021b10: 6572 7428 4747 4d4c 5f4d 4158 5f44 494d  ert(GGML_MAX_DIM
+00021b20: 5320 3d3d 2034 2c20 2247 474d 4c5f 4d41  S == 4, "GGML_MA
+00021b30: 585f 4449 4d53 2069 7320 6e6f 7420 3420  X_DIMS is not 4 
+00021b40: 2d20 7570 6461 7465 2074 6869 7320 6675  - update this fu
+00021b50: 6e63 7469 6f6e 2229 3b0a 0a20 2020 2072  nction");..    r
+00021b60: 6574 7572 6e0a 2020 2020 2020 2020 7465  eturn.        te
+00021b70: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2047  nsor->nb[0] == G
+00021b80: 474d 4c5f 5459 5045 5f53 495a 455b 7465  GML_TYPE_SIZE[te
+00021b90: 6e73 6f72 2d3e 7479 7065 5d20 2626 0a20  nsor->type] &&. 
+00021ba0: 2020 2020 2020 2074 656e 736f 722d 3e6e         tensor->n
+00021bb0: 625b 315d 203d 3d20 2874 656e 736f 722d  b[1] == (tensor-
+00021bc0: 3e6e 625b 305d 2a74 656e 736f 722d 3e6e  >nb[0]*tensor->n
+00021bd0: 655b 305d 292f 4747 4d4c 5f42 4c43 4b5f  e[0])/GGML_BLCK_
+00021be0: 5349 5a45 5b74 656e 736f 722d 3e74 7970  SIZE[tensor->typ
+00021bf0: 655d 2026 260a 2020 2020 2020 2020 7465  e] &&.        te
+00021c00: 6e73 6f72 2d3e 6e62 5b32 5d20 3d3d 2074  nsor->nb[2] == t
+00021c10: 656e 736f 722d 3e6e 625b 315d 2a74 656e  ensor->nb[1]*ten
+00021c20: 736f 722d 3e6e 655b 315d 2026 260a 2020  sor->ne[1] &&.  
+00021c30: 2020 2020 2020 7465 6e73 6f72 2d3e 6e62        tensor->nb
+00021c40: 5b33 5d20 3d3d 2074 656e 736f 722d 3e6e  [3] == tensor->n
+00021c50: 625b 325d 2a74 656e 736f 722d 3e6e 655b  b[2]*tensor->ne[
+00021c60: 325d 3b0a 7d0a 0a62 6f6f 6c20 6767 6d6c  2];.}..bool ggml
+00021c70: 5f69 735f 7065 726d 7574 6564 2863 6f6e  _is_permuted(con
+00021c80: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00021c90: 656e 736f 7220 2a20 7465 6e73 6f72 2920  ensor * tensor) 
+00021ca0: 7b0a 2020 2020 7374 6174 6963 5f61 7373  {.    static_ass
+00021cb0: 6572 7428 4747 4d4c 5f4d 4158 5f44 494d  ert(GGML_MAX_DIM
+00021cc0: 5320 3d3d 2034 2c20 2247 474d 4c5f 4d41  S == 4, "GGML_MA
+00021cd0: 585f 4449 4d53 2069 7320 6e6f 7420 3420  X_DIMS is not 4 
+00021ce0: 2d20 7570 6461 7465 2074 6869 7320 6675  - update this fu
+00021cf0: 6e63 7469 6f6e 2229 3b0a 0a20 2020 2072  nction");..    r
+00021d00: 6574 7572 6e20 7465 6e73 6f72 2d3e 6e62  eturn tensor->nb
+00021d10: 5b30 5d20 3e20 7465 6e73 6f72 2d3e 6e62  [0] > tensor->nb
+00021d20: 5b31 5d20 7c7c 2074 656e 736f 722d 3e6e  [1] || tensor->n
+00021d30: 625b 315d 203e 2074 656e 736f 722d 3e6e  b[1] > tensor->n
+00021d40: 625b 325d 207c 7c20 7465 6e73 6f72 2d3e  b[2] || tensor->
+00021d50: 6e62 5b32 5d20 3e20 7465 6e73 6f72 2d3e  nb[2] > tensor->
+00021d60: 6e62 5b33 5d3b 0a7d 0a0a 7374 6174 6963  nb[3];.}..static
+00021d70: 2069 6e6c 696e 6520 626f 6f6c 2067 676d   inline bool ggm
+00021d80: 6c5f 6973 5f70 6164 6465 645f 3164 2863  l_is_padded_1d(c
+00021d90: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00021da0: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
+00021db0: 2920 7b0a 2020 2020 7374 6174 6963 5f61  ) {.    static_a
+00021dc0: 7373 6572 7428 4747 4d4c 5f4d 4158 5f44  ssert(GGML_MAX_D
+00021dd0: 494d 5320 3d3d 2034 2c20 2247 474d 4c5f  IMS == 4, "GGML_
+00021de0: 4d41 585f 4449 4d53 2069 7320 6e6f 7420  MAX_DIMS is not 
+00021df0: 3420 2d20 7570 6461 7465 2074 6869 7320  4 - update this 
+00021e00: 6675 6e63 7469 6f6e 2229 3b0a 0a20 2020  function");..   
+00021e10: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+00021e20: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
+00021e30: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
+00021e40: 7465 6e73 6f72 2d3e 7479 7065 5d20 2626  tensor->type] &&
+00021e50: 0a20 2020 2020 2020 2074 656e 736f 722d  .        tensor-
+00021e60: 3e6e 625b 325d 203d 3d20 7465 6e73 6f72  >nb[2] == tensor
+00021e70: 2d3e 6e62 5b31 5d2a 7465 6e73 6f72 2d3e  ->nb[1]*tensor->
+00021e80: 6e65 5b31 5d20 2626 0a20 2020 2020 2020  ne[1] &&.       
+00021e90: 2074 656e 736f 722d 3e6e 625b 335d 203d   tensor->nb[3] =
+00021ea0: 3d20 7465 6e73 6f72 2d3e 6e62 5b32 5d2a  = tensor->nb[2]*
+00021eb0: 7465 6e73 6f72 2d3e 6e65 5b32 5d3b 0a7d  tensor->ne[2];.}
+00021ec0: 0a0a 7374 6174 6963 2069 6e6c 696e 6520  ..static inline 
+00021ed0: 626f 6f6c 2067 676d 6c5f 6172 655f 7361  bool ggml_are_sa
+00021ee0: 6d65 5f73 6861 7065 2863 6f6e 7374 2073  me_shape(const s
+00021ef0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00021f00: 7220 2a20 7430 2c20 636f 6e73 7420 7374  r * t0, const st
+00021f10: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00021f20: 202a 2074 3129 207b 0a20 2020 2073 7461   * t1) {.    sta
+00021f30: 7469 635f 6173 7365 7274 2847 474d 4c5f  tic_assert(GGML_
+00021f40: 4d41 585f 4449 4d53 203d 3d20 342c 2022  MAX_DIMS == 4, "
+00021f50: 4747 4d4c 5f4d 4158 5f44 494d 5320 6973  GGML_MAX_DIMS is
+00021f60: 206e 6f74 2034 202d 2075 7064 6174 6520   not 4 - update 
+00021f70: 7468 6973 2066 756e 6374 696f 6e22 293b  this function");
+00021f80: 0a0a 2020 2020 7265 7475 726e 0a20 2020  ..    return.   
+00021f90: 2020 2020 2028 7430 2d3e 6e65 5b30 5d20       (t0->ne[0] 
+00021fa0: 3d3d 2074 312d 3e6e 655b 305d 2029 2026  == t1->ne[0] ) &
+00021fb0: 260a 2020 2020 2020 2020 2874 302d 3e6e  &.        (t0->n
+00021fc0: 655b 315d 203d 3d20 7431 2d3e 6e65 5b31  e[1] == t1->ne[1
+00021fd0: 5d20 2920 2626 0a20 2020 2020 2020 2028  ] ) &&.        (
+00021fe0: 7430 2d3e 6e65 5b32 5d20 3d3d 2074 312d  t0->ne[2] == t1-
+00021ff0: 3e6e 655b 325d 2029 2026 260a 2020 2020  >ne[2] ) &&.    
+00022000: 2020 2020 2874 302d 3e6e 655b 335d 203d      (t0->ne[3] =
+00022010: 3d20 7431 2d3e 6e65 5b33 5d20 293b 0a7d  = t1->ne[3] );.}
+00022020: 0a0a 2f2f 2063 6865 636b 2069 6620 7431  ..// check if t1
+00022030: 2063 616e 2062 6520 7265 7072 6573 656e   can be represen
+00022040: 7465 6420 6173 2061 2072 6570 6561 7469  ted as a repeati
+00022050: 7469 6f6e 206f 6620 7430 0a73 7461 7469  tion of t0.stati
+00022060: 6320 696e 6c69 6e65 2062 6f6f 6c20 6767  c inline bool gg
+00022070: 6d6c 5f63 616e 5f72 6570 6561 7428 636f  ml_can_repeat(co
+00022080: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00022090: 7465 6e73 6f72 202a 2074 302c 2063 6f6e  tensor * t0, con
+000220a0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000220b0: 656e 736f 7220 2a20 7431 2920 7b0a 2020  ensor * t1) {.  
+000220c0: 2020 7374 6174 6963 5f61 7373 6572 7428    static_assert(
+000220d0: 4747 4d4c 5f4d 4158 5f44 494d 5320 3d3d  GGML_MAX_DIMS ==
+000220e0: 2034 2c20 2247 474d 4c5f 4d41 585f 4449   4, "GGML_MAX_DI
+000220f0: 4d53 2069 7320 6e6f 7420 3420 2d20 7570  MS is not 4 - up
+00022100: 6461 7465 2074 6869 7320 6675 6e63 7469  date this functi
+00022110: 6f6e 2229 3b0a 0a20 2020 2072 6574 7572  on");..    retur
+00022120: 6e0a 2020 2020 2020 2020 2874 312d 3e6e  n.        (t1->n
+00022130: 655b 305d 2574 302d 3e6e 655b 305d 203d  e[0]%t0->ne[0] =
+00022140: 3d20 3029 2026 260a 2020 2020 2020 2020  = 0) &&.        
+00022150: 2874 312d 3e6e 655b 315d 2574 302d 3e6e  (t1->ne[1]%t0->n
+00022160: 655b 315d 203d 3d20 3029 2026 260a 2020  e[1] == 0) &&.  
+00022170: 2020 2020 2020 2874 312d 3e6e 655b 325d        (t1->ne[2]
+00022180: 2574 302d 3e6e 655b 325d 203d 3d20 3029  %t0->ne[2] == 0)
+00022190: 2026 260a 2020 2020 2020 2020 2874 312d   &&.        (t1-
+000221a0: 3e6e 655b 335d 2574 302d 3e6e 655b 335d  >ne[3]%t0->ne[3]
+000221b0: 203d 3d20 3029 3b0a 7d0a 0a73 7461 7469   == 0);.}..stati
+000221c0: 6320 696e 6c69 6e65 2062 6f6f 6c20 6767  c inline bool gg
+000221d0: 6d6c 5f63 616e 5f72 6570 6561 745f 726f  ml_can_repeat_ro
+000221e0: 7773 2863 6f6e 7374 2073 7472 7563 7420  ws(const struct 
+000221f0: 6767 6d6c 5f74 656e 736f 7220 2a20 7430  ggml_tensor * t0
+00022200: 2c20 636f 6e73 7420 7374 7275 6374 2067  , const struct g
+00022210: 676d 6c5f 7465 6e73 6f72 202a 2074 3129  gml_tensor * t1)
+00022220: 207b 0a20 2020 2073 7461 7469 635f 6173   {.    static_as
+00022230: 7365 7274 2847 474d 4c5f 4d41 585f 4449  sert(GGML_MAX_DI
+00022240: 4d53 203d 3d20 342c 2022 4747 4d4c 5f4d  MS == 4, "GGML_M
+00022250: 4158 5f44 494d 5320 6973 206e 6f74 2034  AX_DIMS is not 4
+00022260: 202d 2075 7064 6174 6520 7468 6973 2066   - update this f
+00022270: 756e 6374 696f 6e22 293b 0a0a 2020 2020  unction");..    
+00022280: 7265 7475 726e 2028 7430 2d3e 6e65 5b30  return (t0->ne[0
+00022290: 5d20 3d3d 2074 312d 3e6e 655b 305d 2920  ] == t1->ne[0]) 
+000222a0: 2626 2067 676d 6c5f 6361 6e5f 7265 7065  && ggml_can_repe
+000222b0: 6174 2874 302c 2074 3129 3b0a 7d0a 0a73  at(t0, t1);.}..s
+000222c0: 7461 7469 6320 696e 6c69 6e65 2069 6e74  tatic inline int
+000222d0: 2067 676d 6c5f 7570 3332 2869 6e74 206e   ggml_up32(int n
+000222e0: 2920 7b0a 2020 2020 7265 7475 726e 2028  ) {.    return (
+000222f0: 6e20 2b20 3331 2920 2620 7e33 313b 0a7d  n + 31) & ~31;.}
+00022300: 0a0a 2f2f 7374 6174 6963 2069 6e6c 696e  ..//static inlin
+00022310: 6520 696e 7420 6767 6d6c 5f75 7036 3428  e int ggml_up64(
+00022320: 696e 7420 6e29 207b 0a2f 2f20 2020 2072  int n) {.//    r
+00022330: 6574 7572 6e20 286e 202b 2036 3329 2026  eturn (n + 63) &
+00022340: 207e 3633 3b0a 2f2f 7d0a 0a73 7461 7469   ~63;.//}..stati
+00022350: 6320 696e 6c69 6e65 2069 6e74 2067 676d  c inline int ggm
+00022360: 6c5f 7570 2869 6e74 206e 2c20 696e 7420  l_up(int n, int 
+00022370: 6d29 207b 0a20 2020 202f 2f20 6173 7365  m) {.    // asse
+00022380: 7274 206d 2069 7320 6120 706f 7765 7220  rt m is a power 
+00022390: 6f66 2032 0a20 2020 2047 474d 4c5f 4153  of 2.    GGML_AS
+000223a0: 5345 5254 2828 6d20 2620 286d 202d 2031  SERT((m & (m - 1
+000223b0: 2929 203d 3d20 3029 3b0a 2020 2020 7265  )) == 0);.    re
+000223c0: 7475 726e 2028 6e20 2b20 6d20 2d20 3129  turn (n + m - 1)
+000223d0: 2026 207e 286d 202d 2031 293b 0a7d 0a0a   & ~(m - 1);.}..
+000223e0: 2f2f 2061 7373 6572 7420 7468 6174 2070  // assert that p
+000223f0: 6f69 6e74 6572 2069 7320 616c 6967 6e65  ointer is aligne
+00022400: 6420 746f 2047 474d 4c5f 4d45 4d5f 414c  d to GGML_MEM_AL
+00022410: 4947 4e0a 2364 6566 696e 6520 6767 6d6c  IGN.#define ggml
+00022420: 5f61 7373 6572 745f 616c 6967 6e65 6428  _assert_aligned(
+00022430: 7074 7229 205c 0a20 2020 2047 474d 4c5f  ptr) \.    GGML_
+00022440: 4153 5345 5254 2828 2875 696e 7470 7472  ASSERT(((uintptr
+00022450: 5f74 2920 2870 7472 2929 2547 474d 4c5f  _t) (ptr))%GGML_
+00022460: 4d45 4d5f 414c 4947 4e20 3d3d 2030 290a  MEM_ALIGN == 0).
+00022470: 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .///////////////
+00022480: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00022490: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 000224a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 000224b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000224c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000224d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000224e0: 2f2f 0a0a 7374 7275 6374 2067 676d 6c5f  //..struct ggml_
-000224f0: 636f 6e74 6578 7420 2a20 6767 6d6c 5f69  context * ggml_i
-00022500: 6e69 7428 7374 7275 6374 2067 676d 6c5f  nit(struct ggml_
-00022510: 696e 6974 5f70 6172 616d 7320 7061 7261  init_params para
-00022520: 6d73 2920 7b0a 2020 2020 2f2f 206d 616b  ms) {.    // mak
-00022530: 6520 7468 6973 2066 756e 6374 696f 6e20  e this function 
-00022540: 7468 7265 6164 2073 6166 650a 2020 2020  thread safe.    
-00022550: 6767 6d6c 5f63 7269 7469 6361 6c5f 7365  ggml_critical_se
-00022560: 6374 696f 6e5f 7374 6172 7428 293b 0a0a  ction_start();..
-00022570: 2020 2020 7374 6174 6963 2062 6f6f 6c20      static bool 
-00022580: 6973 5f66 6972 7374 5f63 616c 6c20 3d20  is_first_call = 
-00022590: 7472 7565 3b0a 0a20 2020 2069 6620 2869  true;..    if (i
-000225a0: 735f 6669 7273 745f 6361 6c6c 2920 7b0a  s_first_call) {.
-000225b0: 2020 2020 2020 2020 2f2f 2069 6e69 7469          // initi
-000225c0: 616c 697a 6520 7469 6d65 2073 7973 7465  alize time syste
-000225d0: 6d20 2872 6571 7569 7265 6420 6f6e 2057  m (required on W
-000225e0: 696e 646f 7773 290a 2020 2020 2020 2020  indows).        
-000225f0: 6767 6d6c 5f74 696d 655f 696e 6974 2829  ggml_time_init()
-00022600: 3b0a 0a20 2020 2020 2020 202f 2f20 696e  ;..        // in
-00022610: 6974 6961 6c69 7a65 2047 454c 552c 2053  itialize GELU, S
-00022620: 494c 5520 616e 6420 4558 5020 4633 3220  ILU and EXP F32 
-00022630: 7461 626c 6573 0a20 2020 2020 2020 207b  tables.        {
-00022640: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00022650: 7374 2075 696e 7436 345f 7420 745f 7374  st uint64_t t_st
-00022660: 6172 7420 3d20 6767 6d6c 5f74 696d 655f  art = ggml_time_
-00022670: 7573 2829 3b20 554e 5553 4544 2874 5f73  us(); UNUSED(t_s
-00022680: 7461 7274 293b 0a0a 2020 2020 2020 2020  tart);..        
-00022690: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-000226a0: 6969 3b0a 2020 2020 2020 2020 2020 2020  ii;.            
-000226b0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-000226c0: 6920 3c20 2831 203c 3c20 3136 293b 202b  i < (1 << 16); +
-000226d0: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
-000226e0: 2020 2020 2020 7569 6e74 3136 5f74 2075        uint16_t u
-000226f0: 6920 3d20 693b 0a20 2020 2020 2020 2020  i = i;.         
-00022700: 2020 2020 2020 206d 656d 6370 7928 2669         memcpy(&i
-00022710: 692c 2026 7569 2c20 7369 7a65 6f66 2869  i, &ui, sizeof(i
-00022720: 6929 293b 0a20 2020 2020 2020 2020 2020  i));.           
-00022730: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-00022740: 2066 203d 2074 6162 6c65 5f66 3332 5f66   f = table_f32_f
-00022750: 3136 5b69 5d20 3d20 4747 4d4c 5f43 4f4d  16[i] = GGML_COM
-00022760: 5055 5445 5f46 5031 365f 544f 5f46 5033  PUTE_FP16_TO_FP3
-00022770: 3228 6969 293b 0a20 2020 2020 2020 2020  2(ii);.         
-00022780: 2020 2020 2020 2074 6162 6c65 5f67 656c         table_gel
-00022790: 755f 6631 365b 695d 203d 2047 474d 4c5f  u_f16[i] = GGML_
-000227a0: 4650 3332 5f54 4f5f 4650 3136 2867 676d  FP32_TO_FP16(ggm
-000227b0: 6c5f 6765 6c75 5f66 3332 2866 2929 3b0a  l_gelu_f32(f));.
-000227c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000227d0: 7461 626c 655f 7369 6c75 5f66 3136 5b69  table_silu_f16[i
-000227e0: 5d20 3d20 4747 4d4c 5f46 5033 325f 544f  ] = GGML_FP32_TO
-000227f0: 5f46 5031 3628 6767 6d6c 5f73 696c 755f  _FP16(ggml_silu_
-00022800: 6633 3228 6629 293b 0a20 2020 2020 2020  f32(f));.       
-00022810: 2020 2020 2020 2020 2074 6162 6c65 5f65           table_e
-00022820: 7870 5f66 3136 5b69 5d20 203d 2047 474d  xp_f16[i]  = GGM
-00022830: 4c5f 4650 3332 5f54 4f5f 4650 3136 2865  L_FP32_TO_FP16(e
-00022840: 7870 6628 6629 293b 0a20 2020 2020 2020  xpf(f));.       
-00022850: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00022860: 2020 2020 636f 6e73 7420 7569 6e74 3634      const uint64
-00022870: 5f74 2074 5f65 6e64 203d 2067 676d 6c5f  _t t_end = ggml_
-00022880: 7469 6d65 5f75 7328 293b 2055 4e55 5345  time_us(); UNUSE
-00022890: 4428 745f 656e 6429 3b0a 0a20 2020 2020  D(t_end);..     
-000228a0: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
-000228b0: 545f 4445 4255 4728 2225 733a 2047 454c  T_DEBUG("%s: GEL
-000228c0: 552c 2053 494c 5520 616e 6420 4558 5020  U, SILU and EXP 
-000228d0: 7461 626c 6573 2069 6e69 7469 616c 697a  tables initializ
-000228e0: 6564 2069 6e20 2566 206d 735c 6e22 2c20  ed in %f ms\n", 
-000228f0: 5f5f 6675 6e63 5f5f 2c20 2874 5f65 6e64  __func__, (t_end
-00022900: 202d 2074 5f73 7461 7274 292f 3130 3030   - t_start)/1000
-00022910: 2e30 6629 3b0a 2020 2020 2020 2020 7d0a  .0f);.        }.
-00022920: 0a20 2020 2020 2020 202f 2f20 696e 6974  .        // init
-00022930: 6961 6c69 7a65 2067 5f73 7461 7465 0a20  ialize g_state. 
-00022940: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00022950: 2020 2020 2063 6f6e 7374 2075 696e 7436       const uint6
-00022960: 345f 7420 745f 7374 6172 7420 3d20 6767  4_t t_start = gg
-00022970: 6d6c 5f74 696d 655f 7573 2829 3b20 554e  ml_time_us(); UN
-00022980: 5553 4544 2874 5f73 7461 7274 293b 0a0a  USED(t_start);..
-00022990: 2020 2020 2020 2020 2020 2020 675f 7374              g_st
-000229a0: 6174 6520 3d20 2873 7472 7563 7420 6767  ate = (struct gg
-000229b0: 6d6c 5f73 7461 7465 2920 7b0a 2020 2020  ml_state) {.    
-000229c0: 2020 2020 2020 2020 2020 2020 2f2a 2e63              /*.c
-000229d0: 6f6e 7465 7874 7320 3d2a 2f20 7b20 7b20  ontexts =*/ { { 
-000229e0: 3020 7d20 7d2c 0a20 2020 2020 2020 2020  0 } },.         
-000229f0: 2020 207d 3b0a 0a20 2020 2020 2020 2020     };..         
-00022a00: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00022a10: 303b 2069 203c 2047 474d 4c5f 4d41 585f  0; i < GGML_MAX_
-00022a20: 434f 4e54 4558 5453 3b20 2b2b 6929 207b  CONTEXTS; ++i) {
-00022a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022a40: 2067 5f73 7461 7465 2e63 6f6e 7465 7874   g_state.context
-00022a50: 735b 695d 2e75 7365 6420 3d20 6661 6c73  s[i].used = fals
-00022a60: 653b 0a20 2020 2020 2020 2020 2020 207d  e;.            }
-00022a70: 0a0a 2020 2020 2020 2020 2020 2020 636f  ..            co
-00022a80: 6e73 7420 7569 6e74 3634 5f74 2074 5f65  nst uint64_t t_e
-00022a90: 6e64 203d 2067 676d 6c5f 7469 6d65 5f75  nd = ggml_time_u
-00022aa0: 7328 293b 2055 4e55 5345 4428 745f 656e  s(); UNUSED(t_en
-00022ab0: 6429 3b0a 0a20 2020 2020 2020 2020 2020  d);..           
-00022ac0: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
-00022ad0: 4728 2225 733a 2067 5f73 7461 7465 2069  G("%s: g_state i
-00022ae0: 6e69 7469 616c 697a 6564 2069 6e20 2566  nitialized in %f
-00022af0: 206d 735c 6e22 2c20 5f5f 6675 6e63 5f5f   ms\n", __func__
-00022b00: 2c20 2874 5f65 6e64 202d 2074 5f73 7461  , (t_end - t_sta
-00022b10: 7274 292f 3130 3030 2e30 6629 3b0a 2020  rt)/1000.0f);.  
-00022b20: 2020 2020 2020 7d0a 0a23 6966 2064 6566        }..#if def
-00022b30: 696e 6564 2847 474d 4c5f 5553 455f 4355  ined(GGML_USE_CU
-00022b40: 424c 4153 290a 2020 2020 2020 2020 6767  BLAS).        gg
-00022b50: 6d6c 5f69 6e69 745f 6375 626c 6173 2829  ml_init_cublas()
-00022b60: 3b0a 2365 6c69 6620 6465 6669 6e65 6428  ;.#elif defined(
-00022b70: 4747 4d4c 5f55 5345 5f43 4c42 4c41 5354  GGML_USE_CLBLAST
-00022b80: 290a 2020 2020 2020 2020 6767 6d6c 5f63  ).        ggml_c
-00022b90: 6c5f 696e 6974 2829 3b0a 2365 6e64 6966  l_init();.#endif
-00022ba0: 0a0a 2020 2020 2020 2020 6973 5f66 6972  ..        is_fir
-00022bb0: 7374 5f63 616c 6c20 3d20 6661 6c73 653b  st_call = false;
-00022bc0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2066  .    }..    // f
-00022bd0: 696e 6420 6e6f 6e2d 7573 6564 2063 6f6e  ind non-used con
-00022be0: 7465 7874 2069 6e20 675f 7374 6174 650a  text in g_state.
-00022bf0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00022c00: 636f 6e74 6578 7420 2a20 6374 7820 3d20  context * ctx = 
-00022c10: 4e55 4c4c 3b0a 0a20 2020 2066 6f72 2028  NULL;..    for (
-00022c20: 696e 7420 6920 3d20 303b 2069 203c 2047  int i = 0; i < G
-00022c30: 474d 4c5f 4d41 585f 434f 4e54 4558 5453  GML_MAX_CONTEXTS
-00022c40: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00022c50: 2069 6620 2821 675f 7374 6174 652e 636f   if (!g_state.co
-00022c60: 6e74 6578 7473 5b69 5d2e 7573 6564 2920  ntexts[i].used) 
-00022c70: 7b0a 2020 2020 2020 2020 2020 2020 675f  {.            g_
-00022c80: 7374 6174 652e 636f 6e74 6578 7473 5b69  state.contexts[i
-00022c90: 5d2e 7573 6564 203d 2074 7275 653b 0a20  ].used = true;. 
-00022ca0: 2020 2020 2020 2020 2020 2063 7478 203d             ctx =
-00022cb0: 2026 675f 7374 6174 652e 636f 6e74 6578   &g_state.contex
-00022cc0: 7473 5b69 5d2e 636f 6e74 6578 743b 0a0a  ts[i].context;..
-00022cd0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00022ce0: 5f50 5249 4e54 5f44 4542 5547 2822 2573  _PRINT_DEBUG("%s
-00022cf0: 3a20 666f 756e 6420 756e 7573 6564 2063  : found unused c
-00022d00: 6f6e 7465 7874 2025 645c 6e22 2c20 5f5f  ontext %d\n", __
-00022d10: 6675 6e63 5f5f 2c20 6929 3b0a 2020 2020  func__, i);.    
-00022d20: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-00022d30: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-00022d40: 2020 2020 6966 2028 6374 7820 3d3d 204e      if (ctx == N
-00022d50: 554c 4c29 207b 0a20 2020 2020 2020 2047  ULL) {.        G
-00022d60: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
-00022d70: 2225 733a 206e 6f20 756e 7573 6564 2063  "%s: no unused c
-00022d80: 6f6e 7465 7874 2066 6f75 6e64 5c6e 222c  ontext found\n",
-00022d90: 205f 5f66 756e 635f 5f29 3b0a 0a20 2020   __func__);..   
-00022da0: 2020 2020 2067 676d 6c5f 6372 6974 6963       ggml_critic
-00022db0: 616c 5f73 6563 7469 6f6e 5f65 6e64 2829  al_section_end()
-00022dc0: 3b0a 0a20 2020 2020 2020 2072 6574 7572  ;..        retur
-00022dd0: 6e20 4e55 4c4c 3b0a 2020 2020 7d0a 0a20  n NULL;.    }.. 
-00022de0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00022df0: 6d65 6d5f 7369 7a65 203d 2028 7061 7261  mem_size = (para
-00022e00: 6d73 2e6d 656d 5f73 697a 6520 2b20 4747  ms.mem_size + GG
-00022e10: 4d4c 5f4d 454d 5f41 4c49 474e 202d 2031  ML_MEM_ALIGN - 1
-00022e20: 2920 2620 7e28 4747 4d4c 5f4d 454d 5f41  ) & ~(GGML_MEM_A
-00022e30: 4c49 474e 202d 2031 293b 0a0a 2020 2020  LIGN - 1);..    
-00022e40: 2a63 7478 203d 2028 7374 7275 6374 2067  *ctx = (struct g
-00022e50: 676d 6c5f 636f 6e74 6578 7429 207b 0a20  gml_context) {. 
-00022e60: 2020 2020 2020 202f 2a2e 6d65 6d5f 7369         /*.mem_si
-00022e70: 7a65 2020 2020 2020 2020 2020 203d 2a2f  ze           =*/
-00022e80: 206d 656d 5f73 697a 652c 0a20 2020 2020   mem_size,.     
-00022e90: 2020 202f 2a2e 6d65 6d5f 6275 6666 6572     /*.mem_buffer
-00022ea0: 2020 2020 2020 2020 203d 2a2f 2070 6172           =*/ par
-00022eb0: 616d 732e 6d65 6d5f 6275 6666 6572 203f  ams.mem_buffer ?
-00022ec0: 2070 6172 616d 732e 6d65 6d5f 6275 6666   params.mem_buff
-00022ed0: 6572 203a 2047 474d 4c5f 414c 4947 4e45  er : GGML_ALIGNE
-00022ee0: 445f 4d41 4c4c 4f43 286d 656d 5f73 697a  D_MALLOC(mem_siz
-00022ef0: 6529 2c0a 2020 2020 2020 2020 2f2a 2e6d  e),.        /*.m
-00022f00: 656d 5f62 7566 6665 725f 6f77 6e65 6420  em_buffer_owned 
-00022f10: 2020 3d2a 2f20 7061 7261 6d73 2e6d 656d    =*/ params.mem
-00022f20: 5f62 7566 6665 7220 3f20 6661 6c73 6520  _buffer ? false 
-00022f30: 3a20 7472 7565 2c0a 2020 2020 2020 2020  : true,.        
-00022f40: 2f2a 2e6e 6f5f 616c 6c6f 6320 2020 2020  /*.no_alloc     
-00022f50: 2020 2020 2020 3d2a 2f20 7061 7261 6d73        =*/ params
-00022f60: 2e6e 6f5f 616c 6c6f 632c 0a20 2020 2020  .no_alloc,.     
-00022f70: 2020 202f 2a2e 6e6f 5f61 6c6c 6f63 5f73     /*.no_alloc_s
-00022f80: 6176 6520 2020 2020 203d 2a2f 2070 6172  ave      =*/ par
-00022f90: 616d 732e 6e6f 5f61 6c6c 6f63 2c0a 2020  ams.no_alloc,.  
-00022fa0: 2020 2020 2020 2f2a 2e6e 5f6f 626a 6563        /*.n_objec
-00022fb0: 7473 2020 2020 2020 2020 2020 3d2a 2f20  ts          =*/ 
-00022fc0: 302c 0a20 2020 2020 2020 202f 2a2e 6f62  0,.        /*.ob
-00022fd0: 6a65 6374 735f 6265 6769 6e20 2020 2020  jects_begin     
-00022fe0: 203d 2a2f 204e 554c 4c2c 0a20 2020 2020   =*/ NULL,.     
-00022ff0: 2020 202f 2a2e 6f62 6a65 6374 735f 656e     /*.objects_en
-00023000: 6420 2020 2020 2020 203d 2a2f 204e 554c  d        =*/ NUL
-00023010: 4c2c 0a20 2020 2020 2020 202f 2a2e 7363  L,.        /*.sc
-00023020: 7261 7463 6820 2020 2020 2020 2020 2020  ratch           
-00023030: 203d 2a2f 207b 2030 2c20 302c 204e 554c   =*/ { 0, 0, NUL
-00023040: 4c2c 207d 2c0a 2020 2020 2020 2020 2f2a  L, },.        /*
-00023050: 2e73 6372 6174 6368 5f73 6176 6520 2020  .scratch_save   
-00023060: 2020 2020 3d2a 2f20 7b20 302c 2030 2c20      =*/ { 0, 0, 
-00023070: 4e55 4c4c 2c20 7d2c 0a20 2020 207d 3b0a  NULL, },.    };.
-00023080: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00023090: 2863 7478 2d3e 6d65 6d5f 6275 6666 6572  (ctx->mem_buffer
-000230a0: 2021 3d20 4e55 4c4c 293b 0a0a 2020 2020   != NULL);..    
-000230b0: 6767 6d6c 5f61 7373 6572 745f 616c 6967  ggml_assert_alig
-000230c0: 6e65 6428 6374 782d 3e6d 656d 5f62 7566  ned(ctx->mem_buf
-000230d0: 6665 7229 3b0a 0a20 2020 2047 474d 4c5f  fer);..    GGML_
-000230e0: 5052 494e 545f 4445 4255 4728 2225 733a  PRINT_DEBUG("%s:
-000230f0: 2063 6f6e 7465 7874 2069 6e69 7469 616c   context initial
-00023100: 697a 6564 5c6e 222c 205f 5f66 756e 635f  ized\n", __func_
-00023110: 5f29 3b0a 0a20 2020 2067 676d 6c5f 6372  _);..    ggml_cr
-00023120: 6974 6963 616c 5f73 6563 7469 6f6e 5f65  itical_section_e
-00023130: 6e64 2829 3b0a 0a20 2020 2072 6574 7572  nd();..    retur
-00023140: 6e20 6374 783b 0a7d 0a0a 766f 6964 2067  n ctx;.}..void g
-00023150: 676d 6c5f 6672 6565 2873 7472 7563 7420  gml_free(struct 
-00023160: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00023170: 7478 2920 7b0a 2020 2020 2f2f 206d 616b  tx) {.    // mak
-00023180: 6520 7468 6973 2066 756e 6374 696f 6e20  e this function 
-00023190: 7468 7265 6164 2073 6166 650a 2020 2020  thread safe.    
-000231a0: 6767 6d6c 5f63 7269 7469 6361 6c5f 7365  ggml_critical_se
-000231b0: 6374 696f 6e5f 7374 6172 7428 293b 0a0a  ction_start();..
-000231c0: 2020 2020 626f 6f6c 2066 6f75 6e64 203d      bool found =
-000231d0: 2066 616c 7365 3b0a 0a20 2020 2066 6f72   false;..    for
-000231e0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-000231f0: 2047 474d 4c5f 4d41 585f 434f 4e54 4558   GGML_MAX_CONTEX
-00023200: 5453 3b20 692b 2b29 207b 0a20 2020 2020  TS; i++) {.     
-00023210: 2020 2069 6620 2826 675f 7374 6174 652e     if (&g_state.
-00023220: 636f 6e74 6578 7473 5b69 5d2e 636f 6e74  contexts[i].cont
-00023230: 6578 7420 3d3d 2063 7478 2920 7b0a 2020  ext == ctx) {.  
-00023240: 2020 2020 2020 2020 2020 675f 7374 6174            g_stat
-00023250: 652e 636f 6e74 6578 7473 5b69 5d2e 7573  e.contexts[i].us
-00023260: 6564 203d 2066 616c 7365 3b0a 0a20 2020  ed = false;..   
-00023270: 2020 2020 2020 2020 2047 474d 4c5f 5052           GGML_PR
-00023280: 494e 545f 4445 4255 4728 2225 733a 2063  INT_DEBUG("%s: c
-00023290: 6f6e 7465 7874 2025 6420 7769 7468 2025  ontext %d with %
-000232a0: 6420 6f62 6a65 6374 7320 6861 7320 6265  d objects has be
-000232b0: 656e 2066 7265 6564 2e20 6d65 6d6f 7279  en freed. memory
-000232c0: 2075 7365 6420 3d20 257a 755c 6e22 2c0a   used = %zu\n",.
-000232d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000232e0: 2020 2020 5f5f 6675 6e63 5f5f 2c20 692c      __func__, i,
-000232f0: 2063 7478 2d3e 6e5f 6f62 6a65 6374 732c   ctx->n_objects,
-00023300: 2063 7478 2d3e 6f62 6a65 6374 735f 656e   ctx->objects_en
-00023310: 642d 3e6f 6666 7320 2b20 6374 782d 3e6f  d->offs + ctx->o
-00023320: 626a 6563 7473 5f65 6e64 2d3e 7369 7a65  bjects_end->size
-00023330: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00023340: 6966 2028 6374 782d 3e6d 656d 5f62 7566  if (ctx->mem_buf
-00023350: 6665 725f 6f77 6e65 6429 207b 0a20 2020  fer_owned) {.   
-00023360: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00023370: 4c5f 414c 4947 4e45 445f 4652 4545 2863  L_ALIGNED_FREE(c
-00023380: 7478 2d3e 6d65 6d5f 6275 6666 6572 293b  tx->mem_buffer);
-00023390: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-000233a0: 2020 2020 2020 2020 2020 2020 666f 756e              foun
-000233b0: 6420 3d20 7472 7565 3b0a 2020 2020 2020  d = true;.      
-000233c0: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
-000233d0: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-000233e0: 2020 6966 2028 2166 6f75 6e64 2920 7b0a    if (!found) {.
-000233f0: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
-00023400: 4e54 5f44 4542 5547 2822 2573 3a20 636f  NT_DEBUG("%s: co
-00023410: 6e74 6578 7420 6e6f 7420 666f 756e 645c  ntext not found\
-00023420: 6e22 2c20 5f5f 6675 6e63 5f5f 293b 0a20  n", __func__);. 
-00023430: 2020 207d 0a0a 2020 2020 6767 6d6c 5f63     }..    ggml_c
-00023440: 7269 7469 6361 6c5f 7365 6374 696f 6e5f  ritical_section_
-00023450: 656e 6428 293b 0a7d 0a0a 7369 7a65 5f74  end();.}..size_t
-00023460: 2067 676d 6c5f 7573 6564 5f6d 656d 2863   ggml_used_mem(c
-00023470: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00023480: 5f63 6f6e 7465 7874 202a 2063 7478 2920  _context * ctx) 
-00023490: 7b0a 2020 2020 7265 7475 726e 2063 7478  {.    return ctx
-000234a0: 2d3e 6f62 6a65 6374 735f 656e 6420 3d3d  ->objects_end ==
-000234b0: 204e 554c 4c20 3f20 3020 3a20 6374 782d   NULL ? 0 : ctx-
-000234c0: 3e6f 626a 6563 7473 5f65 6e64 2d3e 6f66  >objects_end->of
-000234d0: 6673 202b 2063 7478 2d3e 6f62 6a65 6374  fs + ctx->object
-000234e0: 735f 656e 642d 3e73 697a 653b 0a7d 0a0a  s_end->size;.}..
-000234f0: 7369 7a65 5f74 2067 676d 6c5f 7365 745f  size_t ggml_set_
-00023500: 7363 7261 7463 6828 7374 7275 6374 2067  scratch(struct g
-00023510: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-00023520: 782c 2073 7472 7563 7420 6767 6d6c 5f73  x, struct ggml_s
-00023530: 6372 6174 6368 2073 6372 6174 6368 2920  cratch scratch) 
-00023540: 7b0a 2020 2020 636f 6e73 7420 7369 7a65  {.    const size
-00023550: 5f74 2072 6573 756c 7420 3d20 6374 782d  _t result = ctx-
-00023560: 3e73 6372 6174 6368 2e64 6174 6120 3f20  >scratch.data ? 
-00023570: 6374 782d 3e73 6372 6174 6368 2e6f 6666  ctx->scratch.off
-00023580: 7320 3a20 303b 0a0a 2020 2020 6374 782d  s : 0;..    ctx-
-00023590: 3e73 6372 6174 6368 203d 2073 6372 6174  >scratch = scrat
-000235a0: 6368 3b0a 0a20 2020 2072 6574 7572 6e20  ch;..    return 
-000235b0: 7265 7375 6c74 3b0a 7d0a 0a76 6f69 6420  result;.}..void 
-000235c0: 6767 6d6c 5f73 6574 5f6e 6f5f 616c 6c6f  ggml_set_no_allo
-000235d0: 6328 7374 7275 6374 2067 676d 6c5f 636f  c(struct ggml_co
-000235e0: 6e74 6578 7420 2a20 6374 782c 2062 6f6f  ntext * ctx, boo
-000235f0: 6c20 6e6f 5f61 6c6c 6f63 2920 7b0a 2020  l no_alloc) {.  
-00023600: 2020 6374 782d 3e6e 6f5f 616c 6c6f 6320    ctx->no_alloc 
-00023610: 3d20 6e6f 5f61 6c6c 6f63 3b0a 7d0a 0a76  = no_alloc;.}..v
-00023620: 6f69 6420 2a20 6767 6d6c 5f67 6574 5f6d  oid * ggml_get_m
-00023630: 656d 5f62 7566 6665 7228 636f 6e73 7420  em_buffer(const 
-00023640: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-00023650: 6578 7420 2a20 6374 7829 207b 0a20 2020  ext * ctx) {.   
-00023660: 2072 6574 7572 6e20 6374 782d 3e6d 656d   return ctx->mem
-00023670: 5f62 7566 6665 723b 0a7d 0a0a 7369 7a65  _buffer;.}..size
-00023680: 5f74 2067 676d 6c5f 6765 745f 6d65 6d5f  _t ggml_get_mem_
-00023690: 7369 7a65 2863 6f6e 7374 2073 7472 7563  size(const struc
-000236a0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-000236b0: 2063 7478 2920 7b0a 2020 2020 7265 7475   ctx) {.    retu
-000236c0: 726e 2063 7478 2d3e 6d65 6d5f 7369 7a65  rn ctx->mem_size
-000236d0: 3b0a 7d0a 0a73 697a 655f 7420 6767 6d6c  ;.}..size_t ggml
-000236e0: 5f67 6574 5f6d 6178 5f74 656e 736f 725f  _get_max_tensor_
-000236f0: 7369 7a65 2863 6f6e 7374 2073 7472 7563  size(const struc
-00023700: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00023710: 2063 7478 2920 7b0a 2020 2020 7369 7a65   ctx) {.    size
-00023720: 5f74 206d 6178 5f73 697a 6520 3d20 303b  _t max_size = 0;
-00023730: 0a0a 2020 2020 7374 7275 6374 2067 676d  ..    struct ggm
-00023740: 6c5f 6f62 6a65 6374 202a 206f 626a 203d  l_object * obj =
-00023750: 2063 7478 2d3e 6f62 6a65 6374 735f 6265   ctx->objects_be
-00023760: 6769 6e3b 0a0a 2020 2020 7768 696c 6520  gin;..    while 
-00023770: 286f 626a 2021 3d20 4e55 4c4c 2920 7b0a  (obj != NULL) {.
-00023780: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00023790: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
-000237a0: 736f 7220 3d20 2873 7472 7563 7420 6767  sor = (struct gg
-000237b0: 6d6c 5f74 656e 736f 7220 2a29 2028 2863  ml_tensor *) ((c
-000237c0: 6861 7220 2a29 2063 7478 2d3e 6d65 6d5f  har *) ctx->mem_
-000237d0: 6275 6666 6572 202b 206f 626a 2d3e 6f66  buffer + obj->of
-000237e0: 6673 293b 0a0a 2020 2020 2020 2020 636f  fs);..        co
-000237f0: 6e73 7420 7369 7a65 5f74 2073 697a 6520  nst size_t size 
-00023800: 3d20 6767 6d6c 5f6e 6279 7465 7328 7465  = ggml_nbytes(te
-00023810: 6e73 6f72 293b 0a0a 2020 2020 2020 2020  nsor);..        
-00023820: 6966 2028 6d61 785f 7369 7a65 203c 2073  if (max_size < s
-00023830: 697a 6529 207b 0a20 2020 2020 2020 2020  ize) {.         
-00023840: 2020 206d 6178 5f73 697a 6520 3d20 7369     max_size = si
-00023850: 7a65 3b0a 2020 2020 2020 2020 7d0a 0a20  ze;.        }.. 
-00023860: 2020 2020 2020 206f 626a 203d 206f 626a         obj = obj
-00023870: 2d3e 6e65 7874 3b0a 2020 2020 7d0a 0a20  ->next;.    }.. 
-00023880: 2020 2072 6574 7572 6e20 6d61 785f 7369     return max_si
-00023890: 7a65 3b0a 7d0a 0a2f 2f20 494d 504f 5254  ze;.}..// IMPORT
-000238a0: 414e 543a 0a2f 2f20 7768 656e 2063 7265  ANT:.// when cre
-000238b0: 6174 696e 6720 226f 7074 2220 7465 6e73  ating "opt" tens
-000238c0: 6f72 732c 2061 6c77 6179 7320 7361 7665  ors, always save
-000238d0: 2061 6e64 206c 6f61 6420 7468 6520 7363   and load the sc
-000238e0: 7261 7463 6820 6275 6666 6572 0a2f 2f20  ratch buffer.// 
-000238f0: 7468 6973 2069 7320 616e 2065 7272 6f72  this is an error
-00023900: 2070 726f 6e65 2070 726f 6365 7373 2c20   prone process, 
-00023910: 6275 7420 6974 2069 7320 6e65 6365 7373  but it is necess
-00023920: 6172 7920 746f 2073 7570 706f 7274 2069  ary to support i
-00023930: 6e70 6c61 6365 0a2f 2f20 6f70 6572 6174  nplace.// operat
-00023940: 6f72 7320 7768 656e 2075 7369 6e67 2073  ors when using s
-00023950: 6372 6174 6368 2062 7566 6665 7273 0a2f  cratch buffers./
-00023960: 2f20 544f 444f 3a20 696d 706c 656d 656e  / TODO: implemen
-00023970: 7420 6120 6265 7474 6572 2077 6179 0a76  t a better way.v
-00023980: 6f69 6420 6767 6d6c 5f73 6372 6174 6368  oid ggml_scratch
-00023990: 5f73 6176 6528 7374 7275 6374 2067 676d  _save(struct ggm
-000239a0: 6c5f 636f 6e74 6578 7420 2a20 6374 7829  l_context * ctx)
-000239b0: 207b 0a20 2020 202f 2f20 7468 6973 2069   {.    // this i
-000239c0: 7320 6e65 6564 6564 2074 6f20 616c 6c6f  s needed to allo
-000239d0: 7720 6f70 7420 7465 6e73 6f72 7320 746f  w opt tensors to
-000239e0: 2073 746f 7265 2074 6865 6972 2064 6174   store their dat
-000239f0: 610a 2020 2020 2f2f 2054 4f44 4f3a 2061  a.    // TODO: a
-00023a00: 6761 696e 2c20 6e65 6564 2074 6f20 6669  gain, need to fi
-00023a10: 6e64 2061 2062 6574 7465 7220 7761 790a  nd a better way.
-00023a20: 2020 2020 6374 782d 3e6e 6f5f 616c 6c6f      ctx->no_allo
-00023a30: 635f 7361 7665 203d 2063 7478 2d3e 6e6f  c_save = ctx->no
-00023a40: 5f61 6c6c 6f63 3b0a 2020 2020 6374 782d  _alloc;.    ctx-
-00023a50: 3e6e 6f5f 616c 6c6f 6320 2020 2020 203d  >no_alloc      =
-00023a60: 2066 616c 7365 3b0a 0a20 2020 2063 7478   false;..    ctx
-00023a70: 2d3e 7363 7261 7463 685f 7361 7665 203d  ->scratch_save =
-00023a80: 2063 7478 2d3e 7363 7261 7463 683b 0a20   ctx->scratch;. 
-00023a90: 2020 2063 7478 2d3e 7363 7261 7463 682e     ctx->scratch.
-00023aa0: 6461 7461 203d 204e 554c 4c3b 0a7d 0a0a  data = NULL;.}..
-00023ab0: 766f 6964 2067 676d 6c5f 7363 7261 7463  void ggml_scratc
-00023ac0: 685f 6c6f 6164 2873 7472 7563 7420 6767  h_load(struct gg
-00023ad0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00023ae0: 2920 7b0a 2020 2020 6374 782d 3e6e 6f5f  ) {.    ctx->no_
-00023af0: 616c 6c6f 6320 3d20 6374 782d 3e6e 6f5f  alloc = ctx->no_
-00023b00: 616c 6c6f 635f 7361 7665 3b0a 0a20 2020  alloc_save;..   
-00023b10: 2063 7478 2d3e 7363 7261 7463 6820 3d20   ctx->scratch = 
-00023b20: 6374 782d 3e73 6372 6174 6368 5f73 6176  ctx->scratch_sav
-00023b30: 653b 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f  e;.}..//////////
+000224c0: 2f0a 0a73 7472 7563 7420 6767 6d6c 5f63  /..struct ggml_c
+000224d0: 6f6e 7465 7874 202a 2067 676d 6c5f 696e  ontext * ggml_in
+000224e0: 6974 2873 7472 7563 7420 6767 6d6c 5f69  it(struct ggml_i
+000224f0: 6e69 745f 7061 7261 6d73 2070 6172 616d  nit_params param
+00022500: 7329 207b 0a20 2020 202f 2f20 6d61 6b65  s) {.    // make
+00022510: 2074 6869 7320 6675 6e63 7469 6f6e 2074   this function t
+00022520: 6872 6561 6420 7361 6665 0a20 2020 2067  hread safe.    g
+00022530: 676d 6c5f 6372 6974 6963 616c 5f73 6563  gml_critical_sec
+00022540: 7469 6f6e 5f73 7461 7274 2829 3b0a 0a20  tion_start();.. 
+00022550: 2020 2073 7461 7469 6320 626f 6f6c 2069     static bool i
+00022560: 735f 6669 7273 745f 6361 6c6c 203d 2074  s_first_call = t
+00022570: 7275 653b 0a0a 2020 2020 6966 2028 6973  rue;..    if (is
+00022580: 5f66 6972 7374 5f63 616c 6c29 207b 0a20  _first_call) {. 
+00022590: 2020 2020 2020 202f 2f20 696e 6974 6961         // initia
+000225a0: 6c69 7a65 2074 696d 6520 7379 7374 656d  lize time system
+000225b0: 2028 7265 7175 6972 6564 206f 6e20 5769   (required on Wi
+000225c0: 6e64 6f77 7329 0a20 2020 2020 2020 2067  ndows).        g
+000225d0: 676d 6c5f 7469 6d65 5f69 6e69 7428 293b  gml_time_init();
+000225e0: 0a0a 2020 2020 2020 2020 2f2f 2069 6e69  ..        // ini
+000225f0: 7469 616c 697a 6520 4745 4c55 2c20 5349  tialize GELU, SI
+00022600: 4c55 2061 6e64 2045 5850 2046 3332 2074  LU and EXP F32 t
+00022610: 6162 6c65 730a 2020 2020 2020 2020 7b0a  ables.        {.
+00022620: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00022630: 7420 7569 6e74 3634 5f74 2074 5f73 7461  t uint64_t t_sta
+00022640: 7274 203d 2067 676d 6c5f 7469 6d65 5f75  rt = ggml_time_u
+00022650: 7328 293b 2055 4e55 5345 4428 745f 7374  s(); UNUSED(t_st
+00022660: 6172 7429 3b0a 0a20 2020 2020 2020 2020  art);..         
+00022670: 2020 2067 676d 6c5f 6670 3136 5f74 2069     ggml_fp16_t i
+00022680: 693b 0a20 2020 2020 2020 2020 2020 2066  i;.            f
+00022690: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+000226a0: 203c 2028 3120 3c3c 2031 3629 3b20 2b2b   < (1 << 16); ++
+000226b0: 6929 207b 0a20 2020 2020 2020 2020 2020  i) {.           
+000226c0: 2020 2020 2075 696e 7431 365f 7420 7569       uint16_t ui
+000226d0: 203d 2069 3b0a 2020 2020 2020 2020 2020   = i;.          
+000226e0: 2020 2020 2020 6d65 6d63 7079 2826 6969        memcpy(&ii
+000226f0: 2c20 2675 692c 2073 697a 656f 6628 6969  , &ui, sizeof(ii
+00022700: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
+00022710: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00022720: 6620 3d20 7461 626c 655f 6633 325f 6631  f = table_f32_f1
+00022730: 365b 695d 203d 2047 474d 4c5f 434f 4d50  6[i] = GGML_COMP
+00022740: 5554 455f 4650 3136 5f54 4f5f 4650 3332  UTE_FP16_TO_FP32
+00022750: 2869 6929 3b0a 2020 2020 2020 2020 2020  (ii);.          
+00022760: 2020 2020 2020 7461 626c 655f 6765 6c75        table_gelu
+00022770: 5f66 3136 5b69 5d20 3d20 4747 4d4c 5f46  _f16[i] = GGML_F
+00022780: 5033 325f 544f 5f46 5031 3628 6767 6d6c  P32_TO_FP16(ggml
+00022790: 5f67 656c 755f 6633 3228 6629 293b 0a20  _gelu_f32(f));. 
+000227a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000227b0: 6162 6c65 5f73 696c 755f 6631 365b 695d  able_silu_f16[i]
+000227c0: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
+000227d0: 4650 3136 2867 676d 6c5f 7369 6c75 5f66  FP16(ggml_silu_f
+000227e0: 3332 2866 2929 3b0a 2020 2020 2020 2020  32(f));.        
+000227f0: 2020 2020 2020 2020 7461 626c 655f 6578          table_ex
+00022800: 705f 6631 365b 695d 2020 3d20 4747 4d4c  p_f16[i]  = GGML
+00022810: 5f46 5033 325f 544f 5f46 5031 3628 6578  _FP32_TO_FP16(ex
+00022820: 7066 2866 2929 3b0a 2020 2020 2020 2020  pf(f));.        
+00022830: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00022840: 2020 2063 6f6e 7374 2075 696e 7436 345f     const uint64_
+00022850: 7420 745f 656e 6420 3d20 6767 6d6c 5f74  t t_end = ggml_t
+00022860: 696d 655f 7573 2829 3b20 554e 5553 4544  ime_us(); UNUSED
+00022870: 2874 5f65 6e64 293b 0a0a 2020 2020 2020  (t_end);..      
+00022880: 2020 2020 2020 4747 4d4c 5f50 5249 4e54        GGML_PRINT
+00022890: 5f44 4542 5547 2822 2573 3a20 4745 4c55  _DEBUG("%s: GELU
+000228a0: 2c20 5349 4c55 2061 6e64 2045 5850 2074  , SILU and EXP t
+000228b0: 6162 6c65 7320 696e 6974 6961 6c69 7a65  ables initialize
+000228c0: 6420 696e 2025 6620 6d73 5c6e 222c 205f  d in %f ms\n", _
+000228d0: 5f66 756e 635f 5f2c 2028 745f 656e 6420  _func__, (t_end 
+000228e0: 2d20 745f 7374 6172 7429 2f31 3030 302e  - t_start)/1000.
+000228f0: 3066 293b 0a20 2020 2020 2020 207d 0a0a  0f);.        }..
+00022900: 2020 2020 2020 2020 2f2f 2069 6e69 7469          // initi
+00022910: 616c 697a 6520 675f 7374 6174 650a 2020  alize g_state.  
+00022920: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00022930: 2020 2020 636f 6e73 7420 7569 6e74 3634      const uint64
+00022940: 5f74 2074 5f73 7461 7274 203d 2067 676d  _t t_start = ggm
+00022950: 6c5f 7469 6d65 5f75 7328 293b 2055 4e55  l_time_us(); UNU
+00022960: 5345 4428 745f 7374 6172 7429 3b0a 0a20  SED(t_start);.. 
+00022970: 2020 2020 2020 2020 2020 2067 5f73 7461             g_sta
+00022980: 7465 203d 2028 7374 7275 6374 2067 676d  te = (struct ggm
+00022990: 6c5f 7374 6174 6529 207b 0a20 2020 2020  l_state) {.     
+000229a0: 2020 2020 2020 2020 2020 202f 2a2e 636f             /*.co
+000229b0: 6e74 6578 7473 203d 2a2f 207b 207b 2030  ntexts =*/ { { 0
+000229c0: 207d 207d 2c0a 2020 2020 2020 2020 2020   } },.          
+000229d0: 2020 7d3b 0a0a 2020 2020 2020 2020 2020    };..          
+000229e0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+000229f0: 3b20 6920 3c20 4747 4d4c 5f4d 4158 5f43  ; i < GGML_MAX_C
+00022a00: 4f4e 5445 5854 533b 202b 2b69 2920 7b0a  ONTEXTS; ++i) {.
+00022a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a20: 675f 7374 6174 652e 636f 6e74 6578 7473  g_state.contexts
+00022a30: 5b69 5d2e 7573 6564 203d 2066 616c 7365  [i].used = false
+00022a40: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+00022a50: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00022a60: 7374 2075 696e 7436 345f 7420 745f 656e  st uint64_t t_en
+00022a70: 6420 3d20 6767 6d6c 5f74 696d 655f 7573  d = ggml_time_us
+00022a80: 2829 3b20 554e 5553 4544 2874 5f65 6e64  (); UNUSED(t_end
+00022a90: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00022aa0: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+00022ab0: 2822 2573 3a20 675f 7374 6174 6520 696e  ("%s: g_state in
+00022ac0: 6974 6961 6c69 7a65 6420 696e 2025 6620  itialized in %f 
+00022ad0: 6d73 5c6e 222c 205f 5f66 756e 635f 5f2c  ms\n", __func__,
+00022ae0: 2028 745f 656e 6420 2d20 745f 7374 6172   (t_end - t_star
+00022af0: 7429 2f31 3030 302e 3066 293b 0a20 2020  t)/1000.0f);.   
+00022b00: 2020 2020 207d 0a0a 2369 6620 6465 6669       }..#if defi
+00022b10: 6e65 6428 4747 4d4c 5f55 5345 5f43 5542  ned(GGML_USE_CUB
+00022b20: 4c41 5329 0a20 2020 2020 2020 2067 676d  LAS).        ggm
+00022b30: 6c5f 696e 6974 5f63 7562 6c61 7328 293b  l_init_cublas();
+00022b40: 0a23 656c 6966 2064 6566 696e 6564 2847  .#elif defined(G
+00022b50: 474d 4c5f 5553 455f 434c 424c 4153 5429  GML_USE_CLBLAST)
+00022b60: 0a20 2020 2020 2020 2067 676d 6c5f 636c  .        ggml_cl
+00022b70: 5f69 6e69 7428 293b 0a23 656e 6469 660a  _init();.#endif.
+00022b80: 0a20 2020 2020 2020 2069 735f 6669 7273  .        is_firs
+00022b90: 745f 6361 6c6c 203d 2066 616c 7365 3b0a  t_call = false;.
+00022ba0: 2020 2020 7d0a 0a20 2020 202f 2f20 6669      }..    // fi
+00022bb0: 6e64 206e 6f6e 2d75 7365 6420 636f 6e74  nd non-used cont
+00022bc0: 6578 7420 696e 2067 5f73 7461 7465 0a20  ext in g_state. 
+00022bd0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+00022be0: 6f6e 7465 7874 202a 2063 7478 203d 204e  ontext * ctx = N
+00022bf0: 554c 4c3b 0a0a 2020 2020 666f 7220 2869  ULL;..    for (i
+00022c00: 6e74 2069 203d 2030 3b20 6920 3c20 4747  nt i = 0; i < GG
+00022c10: 4d4c 5f4d 4158 5f43 4f4e 5445 5854 533b  ML_MAX_CONTEXTS;
+00022c20: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+00022c30: 6966 2028 2167 5f73 7461 7465 2e63 6f6e  if (!g_state.con
+00022c40: 7465 7874 735b 695d 2e75 7365 6429 207b  texts[i].used) {
+00022c50: 0a20 2020 2020 2020 2020 2020 2067 5f73  .            g_s
+00022c60: 7461 7465 2e63 6f6e 7465 7874 735b 695d  tate.contexts[i]
+00022c70: 2e75 7365 6420 3d20 7472 7565 3b0a 2020  .used = true;.  
+00022c80: 2020 2020 2020 2020 2020 6374 7820 3d20            ctx = 
+00022c90: 2667 5f73 7461 7465 2e63 6f6e 7465 7874  &g_state.context
+00022ca0: 735b 695d 2e63 6f6e 7465 7874 3b0a 0a20  s[i].context;.. 
+00022cb0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00022cc0: 5052 494e 545f 4445 4255 4728 2225 733a  PRINT_DEBUG("%s:
+00022cd0: 2066 6f75 6e64 2075 6e75 7365 6420 636f   found unused co
+00022ce0: 6e74 6578 7420 2564 5c6e 222c 205f 5f66  ntext %d\n", __f
+00022cf0: 756e 635f 5f2c 2069 293b 0a20 2020 2020  unc__, i);.     
+00022d00: 2020 2020 2020 2062 7265 616b 3b0a 2020         break;.  
+00022d10: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
+00022d20: 2020 2069 6620 2863 7478 203d 3d20 4e55     if (ctx == NU
+00022d30: 4c4c 2920 7b0a 2020 2020 2020 2020 4747  LL) {.        GG
+00022d40: 4d4c 5f50 5249 4e54 5f44 4542 5547 2822  ML_PRINT_DEBUG("
+00022d50: 2573 3a20 6e6f 2075 6e75 7365 6420 636f  %s: no unused co
+00022d60: 6e74 6578 7420 666f 756e 645c 6e22 2c20  ntext found\n", 
+00022d70: 5f5f 6675 6e63 5f5f 293b 0a0a 2020 2020  __func__);..    
+00022d80: 2020 2020 6767 6d6c 5f63 7269 7469 6361      ggml_critica
+00022d90: 6c5f 7365 6374 696f 6e5f 656e 6428 293b  l_section_end();
+00022da0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00022db0: 204e 554c 4c3b 0a20 2020 207d 0a0a 2020   NULL;.    }..  
+00022dc0: 2020 636f 6e73 7420 7369 7a65 5f74 206d    const size_t m
+00022dd0: 656d 5f73 697a 6520 3d20 2870 6172 616d  em_size = (param
+00022de0: 732e 6d65 6d5f 7369 7a65 202b 2047 474d  s.mem_size + GGM
+00022df0: 4c5f 4d45 4d5f 414c 4947 4e20 2d20 3129  L_MEM_ALIGN - 1)
+00022e00: 2026 207e 2847 474d 4c5f 4d45 4d5f 414c   & ~(GGML_MEM_AL
+00022e10: 4947 4e20 2d20 3129 3b0a 0a20 2020 202a  IGN - 1);..    *
+00022e20: 6374 7820 3d20 2873 7472 7563 7420 6767  ctx = (struct gg
+00022e30: 6d6c 5f63 6f6e 7465 7874 2920 7b0a 2020  ml_context) {.  
+00022e40: 2020 2020 2020 2f2a 2e6d 656d 5f73 697a        /*.mem_siz
+00022e50: 6520 2020 2020 2020 2020 2020 3d2a 2f20  e           =*/ 
+00022e60: 6d65 6d5f 7369 7a65 2c0a 2020 2020 2020  mem_size,.      
+00022e70: 2020 2f2a 2e6d 656d 5f62 7566 6665 7220    /*.mem_buffer 
+00022e80: 2020 2020 2020 2020 3d2a 2f20 7061 7261          =*/ para
+00022e90: 6d73 2e6d 656d 5f62 7566 6665 7220 3f20  ms.mem_buffer ? 
+00022ea0: 7061 7261 6d73 2e6d 656d 5f62 7566 6665  params.mem_buffe
+00022eb0: 7220 3a20 4747 4d4c 5f41 4c49 474e 4544  r : GGML_ALIGNED
+00022ec0: 5f4d 414c 4c4f 4328 6d65 6d5f 7369 7a65  _MALLOC(mem_size
+00022ed0: 292c 0a20 2020 2020 2020 202f 2a2e 6d65  ),.        /*.me
+00022ee0: 6d5f 6275 6666 6572 5f6f 776e 6564 2020  m_buffer_owned  
+00022ef0: 203d 2a2f 2070 6172 616d 732e 6d65 6d5f   =*/ params.mem_
+00022f00: 6275 6666 6572 203f 2066 616c 7365 203a  buffer ? false :
+00022f10: 2074 7275 652c 0a20 2020 2020 2020 202f   true,.        /
+00022f20: 2a2e 6e6f 5f61 6c6c 6f63 2020 2020 2020  *.no_alloc      
+00022f30: 2020 2020 203d 2a2f 2070 6172 616d 732e       =*/ params.
+00022f40: 6e6f 5f61 6c6c 6f63 2c0a 2020 2020 2020  no_alloc,.      
+00022f50: 2020 2f2a 2e6e 6f5f 616c 6c6f 635f 7361    /*.no_alloc_sa
+00022f60: 7665 2020 2020 2020 3d2a 2f20 7061 7261  ve      =*/ para
+00022f70: 6d73 2e6e 6f5f 616c 6c6f 632c 0a20 2020  ms.no_alloc,.   
+00022f80: 2020 2020 202f 2a2e 6e5f 6f62 6a65 6374       /*.n_object
+00022f90: 7320 2020 2020 2020 2020 203d 2a2f 2030  s          =*/ 0
+00022fa0: 2c0a 2020 2020 2020 2020 2f2a 2e6f 626a  ,.        /*.obj
+00022fb0: 6563 7473 5f62 6567 696e 2020 2020 2020  ects_begin      
+00022fc0: 3d2a 2f20 4e55 4c4c 2c0a 2020 2020 2020  =*/ NULL,.      
+00022fd0: 2020 2f2a 2e6f 626a 6563 7473 5f65 6e64    /*.objects_end
+00022fe0: 2020 2020 2020 2020 3d2a 2f20 4e55 4c4c          =*/ NULL
+00022ff0: 2c0a 2020 2020 2020 2020 2f2a 2e73 6372  ,.        /*.scr
+00023000: 6174 6368 2020 2020 2020 2020 2020 2020  atch            
+00023010: 3d2a 2f20 7b20 302c 2030 2c20 4e55 4c4c  =*/ { 0, 0, NULL
+00023020: 2c20 7d2c 0a20 2020 2020 2020 202f 2a2e  , },.        /*.
+00023030: 7363 7261 7463 685f 7361 7665 2020 2020  scratch_save    
+00023040: 2020 203d 2a2f 207b 2030 2c20 302c 204e     =*/ { 0, 0, N
+00023050: 554c 4c2c 207d 2c0a 2020 2020 7d3b 0a0a  ULL, },.    };..
+00023060: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00023070: 6374 782d 3e6d 656d 5f62 7566 6665 7220  ctx->mem_buffer 
+00023080: 213d 204e 554c 4c29 3b0a 0a20 2020 2067  != NULL);..    g
+00023090: 676d 6c5f 6173 7365 7274 5f61 6c69 676e  gml_assert_align
+000230a0: 6564 2863 7478 2d3e 6d65 6d5f 6275 6666  ed(ctx->mem_buff
+000230b0: 6572 293b 0a0a 2020 2020 4747 4d4c 5f50  er);..    GGML_P
+000230c0: 5249 4e54 5f44 4542 5547 2822 2573 3a20  RINT_DEBUG("%s: 
+000230d0: 636f 6e74 6578 7420 696e 6974 6961 6c69  context initiali
+000230e0: 7a65 645c 6e22 2c20 5f5f 6675 6e63 5f5f  zed\n", __func__
+000230f0: 293b 0a0a 2020 2020 6767 6d6c 5f63 7269  );..    ggml_cri
+00023100: 7469 6361 6c5f 7365 6374 696f 6e5f 656e  tical_section_en
+00023110: 6428 293b 0a0a 2020 2020 7265 7475 726e  d();..    return
+00023120: 2063 7478 3b0a 7d0a 0a76 6f69 6420 6767   ctx;.}..void gg
+00023130: 6d6c 5f66 7265 6528 7374 7275 6374 2067  ml_free(struct g
+00023140: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00023150: 7829 207b 0a20 2020 202f 2f20 6d61 6b65  x) {.    // make
+00023160: 2074 6869 7320 6675 6e63 7469 6f6e 2074   this function t
+00023170: 6872 6561 6420 7361 6665 0a20 2020 2067  hread safe.    g
+00023180: 676d 6c5f 6372 6974 6963 616c 5f73 6563  gml_critical_sec
+00023190: 7469 6f6e 5f73 7461 7274 2829 3b0a 0a20  tion_start();.. 
+000231a0: 2020 2062 6f6f 6c20 666f 756e 6420 3d20     bool found = 
+000231b0: 6661 6c73 653b 0a0a 2020 2020 666f 7220  false;..    for 
+000231c0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+000231d0: 4747 4d4c 5f4d 4158 5f43 4f4e 5445 5854  GGML_MAX_CONTEXT
+000231e0: 533b 2069 2b2b 2920 7b0a 2020 2020 2020  S; i++) {.      
+000231f0: 2020 6966 2028 2667 5f73 7461 7465 2e63    if (&g_state.c
+00023200: 6f6e 7465 7874 735b 695d 2e63 6f6e 7465  ontexts[i].conte
+00023210: 7874 203d 3d20 6374 7829 207b 0a20 2020  xt == ctx) {.   
+00023220: 2020 2020 2020 2020 2067 5f73 7461 7465           g_state
+00023230: 2e63 6f6e 7465 7874 735b 695d 2e75 7365  .contexts[i].use
+00023240: 6420 3d20 6661 6c73 653b 0a0a 2020 2020  d = false;..    
+00023250: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
+00023260: 4e54 5f44 4542 5547 2822 2573 3a20 636f  NT_DEBUG("%s: co
+00023270: 6e74 6578 7420 2564 2077 6974 6820 2564  ntext %d with %d
+00023280: 206f 626a 6563 7473 2068 6173 2062 6565   objects has bee
+00023290: 6e20 6672 6565 642e 206d 656d 6f72 7920  n freed. memory 
+000232a0: 7573 6564 203d 2025 7a75 5c6e 222c 0a20  used = %zu\n",. 
+000232b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232c0: 2020 205f 5f66 756e 635f 5f2c 2069 2c20     __func__, i, 
+000232d0: 6374 782d 3e6e 5f6f 626a 6563 7473 2c20  ctx->n_objects, 
+000232e0: 6374 782d 3e6f 626a 6563 7473 5f65 6e64  ctx->objects_end
+000232f0: 2d3e 6f66 6673 202b 2063 7478 2d3e 6f62  ->offs + ctx->ob
+00023300: 6a65 6374 735f 656e 642d 3e73 697a 6529  jects_end->size)
+00023310: 3b0a 0a20 2020 2020 2020 2020 2020 2069  ;..            i
+00023320: 6620 2863 7478 2d3e 6d65 6d5f 6275 6666  f (ctx->mem_buff
+00023330: 6572 5f6f 776e 6564 2920 7b0a 2020 2020  er_owned) {.    
+00023340: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00023350: 5f41 4c49 474e 4544 5f46 5245 4528 6374  _ALIGNED_FREE(ct
+00023360: 782d 3e6d 656d 5f62 7566 6665 7229 3b0a  x->mem_buffer);.
+00023370: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00023380: 2020 2020 2020 2020 2020 2066 6f75 6e64             found
+00023390: 203d 2074 7275 653b 0a20 2020 2020 2020   = true;.       
+000233a0: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
+000233b0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+000233c0: 2069 6620 2821 666f 756e 6429 207b 0a20   if (!found) {. 
+000233d0: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
+000233e0: 545f 4445 4255 4728 2225 733a 2063 6f6e  T_DEBUG("%s: con
+000233f0: 7465 7874 206e 6f74 2066 6f75 6e64 5c6e  text not found\n
+00023400: 222c 205f 5f66 756e 635f 5f29 3b0a 2020  ", __func__);.  
+00023410: 2020 7d0a 0a20 2020 2067 676d 6c5f 6372    }..    ggml_cr
+00023420: 6974 6963 616c 5f73 6563 7469 6f6e 5f65  itical_section_e
+00023430: 6e64 2829 3b0a 7d0a 0a73 697a 655f 7420  nd();.}..size_t 
+00023440: 6767 6d6c 5f75 7365 645f 6d65 6d28 636f  ggml_used_mem(co
+00023450: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00023460: 636f 6e74 6578 7420 2a20 6374 7829 207b  context * ctx) {
+00023470: 0a20 2020 2072 6574 7572 6e20 6374 782d  .    return ctx-
+00023480: 3e6f 626a 6563 7473 5f65 6e64 203d 3d20  >objects_end == 
+00023490: 4e55 4c4c 203f 2030 203a 2063 7478 2d3e  NULL ? 0 : ctx->
+000234a0: 6f62 6a65 6374 735f 656e 642d 3e6f 6666  objects_end->off
+000234b0: 7320 2b20 6374 782d 3e6f 626a 6563 7473  s + ctx->objects
+000234c0: 5f65 6e64 2d3e 7369 7a65 3b0a 7d0a 0a73  _end->size;.}..s
+000234d0: 697a 655f 7420 6767 6d6c 5f73 6574 5f73  ize_t ggml_set_s
+000234e0: 6372 6174 6368 2873 7472 7563 7420 6767  cratch(struct gg
+000234f0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+00023500: 2c20 7374 7275 6374 2067 676d 6c5f 7363  , struct ggml_sc
+00023510: 7261 7463 6820 7363 7261 7463 6829 207b  ratch scratch) {
+00023520: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00023530: 7420 7265 7375 6c74 203d 2063 7478 2d3e  t result = ctx->
+00023540: 7363 7261 7463 682e 6461 7461 203f 2063  scratch.data ? c
+00023550: 7478 2d3e 7363 7261 7463 682e 6f66 6673  tx->scratch.offs
+00023560: 203a 2030 3b0a 0a20 2020 2063 7478 2d3e   : 0;..    ctx->
+00023570: 7363 7261 7463 6820 3d20 7363 7261 7463  scratch = scratc
+00023580: 683b 0a0a 2020 2020 7265 7475 726e 2072  h;..    return r
+00023590: 6573 756c 743b 0a7d 0a0a 766f 6964 2067  esult;.}..void g
+000235a0: 676d 6c5f 7365 745f 6e6f 5f61 6c6c 6f63  gml_set_no_alloc
+000235b0: 2873 7472 7563 7420 6767 6d6c 5f63 6f6e  (struct ggml_con
+000235c0: 7465 7874 202a 2063 7478 2c20 626f 6f6c  text * ctx, bool
+000235d0: 206e 6f5f 616c 6c6f 6329 207b 0a20 2020   no_alloc) {.   
+000235e0: 2063 7478 2d3e 6e6f 5f61 6c6c 6f63 203d   ctx->no_alloc =
+000235f0: 206e 6f5f 616c 6c6f 633b 0a7d 0a0a 766f   no_alloc;.}..vo
+00023600: 6964 202a 2067 676d 6c5f 6765 745f 6d65  id * ggml_get_me
+00023610: 6d5f 6275 6666 6572 2863 6f6e 7374 2073  m_buffer(const s
+00023620: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+00023630: 7874 202a 2063 7478 2920 7b0a 2020 2020  xt * ctx) {.    
+00023640: 7265 7475 726e 2063 7478 2d3e 6d65 6d5f  return ctx->mem_
+00023650: 6275 6666 6572 3b0a 7d0a 0a73 697a 655f  buffer;.}..size_
+00023660: 7420 6767 6d6c 5f67 6574 5f6d 656d 5f73  t ggml_get_mem_s
+00023670: 697a 6528 636f 6e73 7420 7374 7275 6374  ize(const struct
+00023680: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00023690: 6374 7829 207b 0a20 2020 2072 6574 7572  ctx) {.    retur
+000236a0: 6e20 6374 782d 3e6d 656d 5f73 697a 653b  n ctx->mem_size;
+000236b0: 0a7d 0a0a 7369 7a65 5f74 2067 676d 6c5f  .}..size_t ggml_
+000236c0: 6765 745f 6d61 785f 7465 6e73 6f72 5f73  get_max_tensor_s
+000236d0: 697a 6528 636f 6e73 7420 7374 7275 6374  ize(const struct
+000236e0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+000236f0: 6374 7829 207b 0a20 2020 2073 697a 655f  ctx) {.    size_
+00023700: 7420 6d61 785f 7369 7a65 203d 2030 3b0a  t max_size = 0;.
+00023710: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00023720: 5f6f 626a 6563 7420 2a20 6f62 6a20 3d20  _object * obj = 
+00023730: 6374 782d 3e6f 626a 6563 7473 5f62 6567  ctx->objects_beg
+00023740: 696e 3b0a 0a20 2020 2077 6869 6c65 2028  in;..    while (
+00023750: 6f62 6a20 213d 204e 554c 4c29 207b 0a20  obj != NULL) {. 
+00023760: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00023770: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+00023780: 6f72 203d 2028 7374 7275 6374 2067 676d  or = (struct ggm
+00023790: 6c5f 7465 6e73 6f72 202a 2920 2828 6368  l_tensor *) ((ch
+000237a0: 6172 202a 2920 6374 782d 3e6d 656d 5f62  ar *) ctx->mem_b
+000237b0: 7566 6665 7220 2b20 6f62 6a2d 3e6f 6666  uffer + obj->off
+000237c0: 7329 3b0a 0a20 2020 2020 2020 2063 6f6e  s);..        con
+000237d0: 7374 2073 697a 655f 7420 7369 7a65 203d  st size_t size =
+000237e0: 2067 676d 6c5f 6e62 7974 6573 2874 656e   ggml_nbytes(ten
+000237f0: 736f 7229 3b0a 0a20 2020 2020 2020 2069  sor);..        i
+00023800: 6620 286d 6178 5f73 697a 6520 3c20 7369  f (max_size < si
+00023810: 7a65 2920 7b0a 2020 2020 2020 2020 2020  ze) {.          
+00023820: 2020 6d61 785f 7369 7a65 203d 2073 697a    max_size = siz
+00023830: 653b 0a20 2020 2020 2020 207d 0a0a 2020  e;.        }..  
+00023840: 2020 2020 2020 6f62 6a20 3d20 6f62 6a2d        obj = obj-
+00023850: 3e6e 6578 743b 0a20 2020 207d 0a0a 2020  >next;.    }..  
+00023860: 2020 7265 7475 726e 206d 6178 5f73 697a    return max_siz
+00023870: 653b 0a7d 0a0a 2f2f 2049 4d50 4f52 5441  e;.}..// IMPORTA
+00023880: 4e54 3a0a 2f2f 2077 6865 6e20 6372 6561  NT:.// when crea
+00023890: 7469 6e67 2022 6f70 7422 2074 656e 736f  ting "opt" tenso
+000238a0: 7273 2c20 616c 7761 7973 2073 6176 6520  rs, always save 
+000238b0: 616e 6420 6c6f 6164 2074 6865 2073 6372  and load the scr
+000238c0: 6174 6368 2062 7566 6665 720a 2f2f 2074  atch buffer.// t
+000238d0: 6869 7320 6973 2061 6e20 6572 726f 7220  his is an error 
+000238e0: 7072 6f6e 6520 7072 6f63 6573 732c 2062  prone process, b
+000238f0: 7574 2069 7420 6973 206e 6563 6573 7361  ut it is necessa
+00023900: 7279 2074 6f20 7375 7070 6f72 7420 696e  ry to support in
+00023910: 706c 6163 650a 2f2f 206f 7065 7261 746f  place.// operato
+00023920: 7273 2077 6865 6e20 7573 696e 6720 7363  rs when using sc
+00023930: 7261 7463 6820 6275 6666 6572 730a 2f2f  ratch buffers.//
+00023940: 2054 4f44 4f3a 2069 6d70 6c65 6d65 6e74   TODO: implement
+00023950: 2061 2062 6574 7465 7220 7761 790a 766f   a better way.vo
+00023960: 6964 2067 676d 6c5f 7363 7261 7463 685f  id ggml_scratch_
+00023970: 7361 7665 2873 7472 7563 7420 6767 6d6c  save(struct ggml
+00023980: 5f63 6f6e 7465 7874 202a 2063 7478 2920  _context * ctx) 
+00023990: 7b0a 2020 2020 2f2f 2074 6869 7320 6973  {.    // this is
+000239a0: 206e 6565 6465 6420 746f 2061 6c6c 6f77   needed to allow
+000239b0: 206f 7074 2074 656e 736f 7273 2074 6f20   opt tensors to 
+000239c0: 7374 6f72 6520 7468 6569 7220 6461 7461  store their data
+000239d0: 0a20 2020 202f 2f20 544f 444f 3a20 6167  .    // TODO: ag
+000239e0: 6169 6e2c 206e 6565 6420 746f 2066 696e  ain, need to fin
+000239f0: 6420 6120 6265 7474 6572 2077 6179 0a20  d a better way. 
+00023a00: 2020 2063 7478 2d3e 6e6f 5f61 6c6c 6f63     ctx->no_alloc
+00023a10: 5f73 6176 6520 3d20 6374 782d 3e6e 6f5f  _save = ctx->no_
+00023a20: 616c 6c6f 633b 0a20 2020 2063 7478 2d3e  alloc;.    ctx->
+00023a30: 6e6f 5f61 6c6c 6f63 2020 2020 2020 3d20  no_alloc      = 
+00023a40: 6661 6c73 653b 0a0a 2020 2020 6374 782d  false;..    ctx-
+00023a50: 3e73 6372 6174 6368 5f73 6176 6520 3d20  >scratch_save = 
+00023a60: 6374 782d 3e73 6372 6174 6368 3b0a 2020  ctx->scratch;.  
+00023a70: 2020 6374 782d 3e73 6372 6174 6368 2e64    ctx->scratch.d
+00023a80: 6174 6120 3d20 4e55 4c4c 3b0a 7d0a 0a76  ata = NULL;.}..v
+00023a90: 6f69 6420 6767 6d6c 5f73 6372 6174 6368  oid ggml_scratch
+00023aa0: 5f6c 6f61 6428 7374 7275 6374 2067 676d  _load(struct ggm
+00023ab0: 6c5f 636f 6e74 6578 7420 2a20 6374 7829  l_context * ctx)
+00023ac0: 207b 0a20 2020 2063 7478 2d3e 6e6f 5f61   {.    ctx->no_a
+00023ad0: 6c6c 6f63 203d 2063 7478 2d3e 6e6f 5f61  lloc = ctx->no_a
+00023ae0: 6c6c 6f63 5f73 6176 653b 0a0a 2020 2020  lloc_save;..    
+00023af0: 6374 782d 3e73 6372 6174 6368 203d 2063  ctx->scratch = c
+00023b00: 7478 2d3e 7363 7261 7463 685f 7361 7665  tx->scratch_save
+00023b10: 3b0a 7d0a 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f  ;.}..///////////
+00023b20: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00023b30: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00023b40: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00023b50: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00023b60: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00023b70: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00023b80: 2f2f 2f2f 2f2f 0a0a 7374 7275 6374 2067  //////..struct g
-00023b90: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-00023ba0: 6c5f 6e65 775f 7465 6e73 6f72 5f69 6d70  l_new_tensor_imp
-00023bb0: 6c28 0a20 2020 2020 2020 2073 7472 7563  l(.        struc
-00023bc0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00023bd0: 2063 7478 2c0a 2020 2020 2020 2020 656e   ctx,.        en
-00023be0: 756d 2020 2067 676d 6c5f 7479 7065 2074  um   ggml_type t
-00023bf0: 7970 652c 0a20 2020 2020 2020 2069 6e74  ype,.        int
-00023c00: 2020 2020 6e5f 6469 6d73 2c0a 2020 2020      n_dims,.    
-00023c10: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00023c20: 742a 206e 652c 0a20 2020 2020 2020 2076  t* ne,.        v
-00023c30: 6f69 642a 2020 6461 7461 2920 7b0a 2020  oid*  data) {.  
-00023c40: 2020 2f2f 2061 6c77 6179 7320 696e 7365    // always inse
-00023c50: 7274 206f 626a 6563 7473 2061 7420 7468  rt objects at th
-00023c60: 6520 656e 6420 6f66 2074 6865 2063 6f6e  e end of the con
-00023c70: 7465 7874 2773 206d 656d 6f72 7920 706f  text's memory po
-00023c80: 6f6c 0a20 2020 2073 7472 7563 7420 6767  ol.    struct gg
-00023c90: 6d6c 5f6f 626a 6563 7420 2a20 6f62 6a5f  ml_object * obj_
-00023ca0: 6375 7220 3d20 6374 782d 3e6f 626a 6563  cur = ctx->objec
-00023cb0: 7473 5f65 6e64 3b0a 0a20 2020 2063 6f6e  ts_end;..    con
-00023cc0: 7374 2073 697a 655f 7420 6375 725f 6f66  st size_t cur_of
-00023cd0: 6673 203d 206f 626a 5f63 7572 203d 3d20  fs = obj_cur == 
-00023ce0: 4e55 4c4c 203f 2030 203a 206f 626a 5f63  NULL ? 0 : obj_c
-00023cf0: 7572 2d3e 6f66 6673 3b0a 2020 2020 636f  ur->offs;.    co
-00023d00: 6e73 7420 7369 7a65 5f74 2063 7572 5f73  nst size_t cur_s
-00023d10: 697a 6520 3d20 6f62 6a5f 6375 7220 3d3d  ize = obj_cur ==
-00023d20: 204e 554c 4c20 3f20 3020 3a20 6f62 6a5f   NULL ? 0 : obj_
-00023d30: 6375 722d 3e73 697a 653b 0a20 2020 2063  cur->size;.    c
-00023d40: 6f6e 7374 2073 697a 655f 7420 6375 725f  onst size_t cur_
-00023d50: 656e 6420 203d 2063 7572 5f6f 6666 7320  end  = cur_offs 
-00023d60: 2b20 6375 725f 7369 7a65 3b0a 0a20 2020  + cur_size;..   
-00023d70: 2073 697a 655f 7420 7369 7a65 5f6e 6565   size_t size_nee
-00023d80: 6465 6420 3d20 303b 0a0a 2020 2020 6966  ded = 0;..    if
-00023d90: 2028 6461 7461 203d 3d20 4e55 4c4c 2026   (data == NULL &
-00023da0: 2620 2163 7478 2d3e 6e6f 5f61 6c6c 6f63  & !ctx->no_alloc
-00023db0: 2920 7b0a 2020 2020 2020 2020 7369 7a65  ) {.        size
-00023dc0: 5f6e 6565 6465 6420 2b3d 2047 474d 4c5f  _needed += GGML_
-00023dd0: 5459 5045 5f53 495a 455b 7479 7065 5d2a  TYPE_SIZE[type]*
-00023de0: 286e 655b 305d 2f47 474d 4c5f 424c 434b  (ne[0]/GGML_BLCK
-00023df0: 5f53 495a 455b 7479 7065 5d29 3b0a 2020  _SIZE[type]);.  
-00023e00: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-00023e10: 203d 2031 3b20 6920 3c20 6e5f 6469 6d73   = 1; i < n_dims
-00023e20: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00023e30: 2020 2020 2073 697a 655f 6e65 6564 6564       size_needed
-00023e40: 202a 3d20 6e65 5b69 5d3b 0a20 2020 2020   *= ne[i];.     
-00023e50: 2020 207d 0a20 2020 2020 2020 202f 2f20     }.        // 
-00023e60: 616c 6967 6e20 746f 2047 474d 4c5f 4d45  align to GGML_ME
-00023e70: 4d5f 414c 4947 4e0a 2020 2020 2020 2020  M_ALIGN.        
-00023e80: 7369 7a65 5f6e 6565 6465 6420 3d20 2828  size_needed = ((
-00023e90: 7369 7a65 5f6e 6565 6465 6420 2b20 4747  size_needed + GG
-00023ea0: 4d4c 5f4d 454d 5f41 4c49 474e 202d 2031  ML_MEM_ALIGN - 1
-00023eb0: 292f 4747 4d4c 5f4d 454d 5f41 4c49 474e  )/GGML_MEM_ALIGN
-00023ec0: 292a 4747 4d4c 5f4d 454d 5f41 4c49 474e  )*GGML_MEM_ALIGN
-00023ed0: 3b0a 2020 2020 7d0a 0a20 2020 2063 6861  ;.    }..    cha
-00023ee0: 7220 2a20 636f 6e73 7420 6d65 6d5f 6275  r * const mem_bu
-00023ef0: 6666 6572 203d 2063 7478 2d3e 6d65 6d5f  ffer = ctx->mem_
-00023f00: 6275 6666 6572 3b0a 2020 2020 7374 7275  buffer;.    stru
-00023f10: 6374 2067 676d 6c5f 6f62 6a65 6374 202a  ct ggml_object *
-00023f20: 2063 6f6e 7374 206f 626a 5f6e 6577 203d   const obj_new =
-00023f30: 2028 7374 7275 6374 2067 676d 6c5f 6f62   (struct ggml_ob
-00023f40: 6a65 6374 202a 2928 6d65 6d5f 6275 6666  ject *)(mem_buff
-00023f50: 6572 202b 2063 7572 5f65 6e64 293b 0a0a  er + cur_end);..
-00023f60: 2020 2020 6966 2028 6374 782d 3e73 6372      if (ctx->scr
-00023f70: 6174 6368 2e64 6174 6120 3d3d 204e 554c  atch.data == NUL
-00023f80: 4c20 7c7c 2064 6174 6120 213d 204e 554c  L || data != NUL
-00023f90: 4c29 207b 0a20 2020 2020 2020 2073 697a  L) {.        siz
-00023fa0: 655f 6e65 6564 6564 202b 3d20 4747 4d4c  e_needed += GGML
-00023fb0: 5f54 454e 534f 525f 5349 5a45 3b0a 0a20  _TENSOR_SIZE;.. 
-00023fc0: 2020 2020 2020 2069 6620 2863 7572 5f65         if (cur_e
-00023fd0: 6e64 202b 2073 697a 655f 6e65 6564 6564  nd + size_needed
-00023fe0: 202b 2047 474d 4c5f 4f42 4a45 4354 5f53   + GGML_OBJECT_S
-00023ff0: 495a 4520 3e20 6374 782d 3e6d 656d 5f73  IZE > ctx->mem_s
-00024000: 697a 6529 207b 0a20 2020 2020 2020 2020  ize) {.         
-00024010: 2020 2047 474d 4c5f 5052 494e 5428 2225     GGML_PRINT("%
-00024020: 733a 206e 6f74 2065 6e6f 7567 6820 7370  s: not enough sp
-00024030: 6163 6520 696e 2074 6865 2063 6f6e 7465  ace in the conte
-00024040: 7874 2773 206d 656d 6f72 7920 706f 6f6c  xt's memory pool
-00024050: 2028 6e65 6564 6564 2025 7a75 2c20 6176   (needed %zu, av
-00024060: 6169 6c61 626c 6520 257a 7529 5c6e 222c  ailable %zu)\n",
-00024070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024080: 2020 2020 205f 5f66 756e 635f 5f2c 2063       __func__, c
-00024090: 7572 5f65 6e64 202b 2073 697a 655f 6e65  ur_end + size_ne
-000240a0: 6564 6564 202b 2047 474d 4c5f 4f42 4a45  eded + GGML_OBJE
-000240b0: 4354 5f53 495a 452c 2063 7478 2d3e 6d65  CT_SIZE, ctx->me
-000240c0: 6d5f 7369 7a65 293b 0a20 2020 2020 2020  m_size);.       
-000240d0: 2020 2020 2061 7373 6572 7428 6661 6c73       assert(fals
-000240e0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-000240f0: 7265 7475 726e 204e 554c 4c3b 0a20 2020  return NULL;.   
-00024100: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00024110: 2a6f 626a 5f6e 6577 203d 2028 7374 7275  *obj_new = (stru
-00024120: 6374 2067 676d 6c5f 6f62 6a65 6374 2920  ct ggml_object) 
-00024130: 7b0a 2020 2020 2020 2020 2020 2020 2e6f  {.            .o
-00024140: 6666 7320 3d20 6375 725f 656e 6420 2b20  ffs = cur_end + 
-00024150: 4747 4d4c 5f4f 424a 4543 545f 5349 5a45  GGML_OBJECT_SIZE
-00024160: 2c0a 2020 2020 2020 2020 2020 2020 2e73  ,.            .s
-00024170: 697a 6520 3d20 7369 7a65 5f6e 6565 6465  ize = size_neede
-00024180: 642c 0a20 2020 2020 2020 2020 2020 202e  d,.            .
-00024190: 6e65 7874 203d 204e 554c 4c2c 0a20 2020  next = NULL,.   
-000241a0: 2020 2020 207d 3b0a 2020 2020 7d20 656c       };.    } el
-000241b0: 7365 207b 0a20 2020 2020 2020 2069 6620  se {.        if 
-000241c0: 2863 7478 2d3e 7363 7261 7463 682e 6f66  (ctx->scratch.of
-000241d0: 6673 202b 2073 697a 655f 6e65 6564 6564  fs + size_needed
-000241e0: 203e 2063 7478 2d3e 7363 7261 7463 682e   > ctx->scratch.
-000241f0: 7369 7a65 2920 7b0a 2020 2020 2020 2020  size) {.        
-00024200: 2020 2020 4747 4d4c 5f50 5249 4e54 2822      GGML_PRINT("
-00024210: 2573 3a20 6e6f 7420 656e 6f75 6768 2073  %s: not enough s
-00024220: 7061 6365 2069 6e20 7468 6520 7363 7261  pace in the scra
-00024230: 7463 6820 6d65 6d6f 7279 2070 6f6f 6c20  tch memory pool 
-00024240: 286e 6565 6465 6420 257a 752c 2061 7661  (needed %zu, ava
-00024250: 696c 6162 6c65 2025 7a75 295c 6e22 2c0a  ilable %zu)\n",.
-00024260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024270: 2020 2020 5f5f 6675 6e63 5f5f 2c20 6374      __func__, ct
-00024280: 782d 3e73 6372 6174 6368 2e6f 6666 7320  x->scratch.offs 
-00024290: 2b20 7369 7a65 5f6e 6565 6465 642c 2063  + size_needed, c
-000242a0: 7478 2d3e 7363 7261 7463 682e 7369 7a65  tx->scratch.size
-000242b0: 293b 0a20 2020 2020 2020 2020 2020 2061  );.            a
-000242c0: 7373 6572 7428 6661 6c73 6529 3b0a 2020  ssert(false);.  
-000242d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000242e0: 204e 554c 4c3b 0a20 2020 2020 2020 207d   NULL;.        }
-000242f0: 0a0a 2020 2020 2020 2020 6966 2028 6375  ..        if (cu
-00024300: 725f 656e 6420 2b20 4747 4d4c 5f54 454e  r_end + GGML_TEN
-00024310: 534f 525f 5349 5a45 202b 2047 474d 4c5f  SOR_SIZE + GGML_
-00024320: 4f42 4a45 4354 5f53 495a 4520 3e20 6374  OBJECT_SIZE > ct
-00024330: 782d 3e6d 656d 5f73 697a 6529 207b 0a20  x->mem_size) {. 
-00024340: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00024350: 5052 494e 5428 2225 733a 206e 6f74 2065  PRINT("%s: not e
-00024360: 6e6f 7567 6820 7370 6163 6520 696e 2074  nough space in t
-00024370: 6865 2063 6f6e 7465 7874 2773 206d 656d  he context's mem
-00024380: 6f72 7920 706f 6f6c 2028 6e65 6564 6564  ory pool (needed
-00024390: 2025 7a75 2c20 6176 6169 6c61 626c 6520   %zu, available 
-000243a0: 257a 7529 5c6e 222c 0a20 2020 2020 2020  %zu)\n",.       
-000243b0: 2020 2020 2020 2020 2020 2020 205f 5f66               __f
-000243c0: 756e 635f 5f2c 2063 7572 5f65 6e64 202b  unc__, cur_end +
-000243d0: 2047 474d 4c5f 5445 4e53 4f52 5f53 495a   GGML_TENSOR_SIZ
-000243e0: 4520 2b20 4747 4d4c 5f4f 424a 4543 545f  E + GGML_OBJECT_
-000243f0: 5349 5a45 2c20 6374 782d 3e6d 656d 5f73  SIZE, ctx->mem_s
-00024400: 697a 6529 3b0a 2020 2020 2020 2020 2020  ize);.          
-00024410: 2020 6173 7365 7274 2866 616c 7365 293b    assert(false);
-00024420: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00024430: 7572 6e20 4e55 4c4c 3b0a 2020 2020 2020  urn NULL;.      
-00024440: 2020 7d0a 0a20 2020 2020 2020 2064 6174    }..        dat
-00024450: 6120 3d20 2863 6861 7220 2a20 636f 6e73  a = (char * cons
-00024460: 7429 2063 7478 2d3e 7363 7261 7463 682e  t) ctx->scratch.
-00024470: 6461 7461 202b 2063 7478 2d3e 7363 7261  data + ctx->scra
-00024480: 7463 682e 6f66 6673 3b0a 0a20 2020 2020  tch.offs;..     
-00024490: 2020 202a 6f62 6a5f 6e65 7720 3d20 2873     *obj_new = (s
-000244a0: 7472 7563 7420 6767 6d6c 5f6f 626a 6563  truct ggml_objec
-000244b0: 7429 207b 0a20 2020 2020 2020 2020 2020  t) {.           
-000244c0: 202e 6f66 6673 203d 2063 7572 5f65 6e64   .offs = cur_end
-000244d0: 202b 2047 474d 4c5f 4f42 4a45 4354 5f53   + GGML_OBJECT_S
-000244e0: 495a 452c 0a20 2020 2020 2020 2020 2020  IZE,.           
-000244f0: 202e 7369 7a65 203d 2047 474d 4c5f 5445   .size = GGML_TE
-00024500: 4e53 4f52 5f53 495a 452c 0a20 2020 2020  NSOR_SIZE,.     
-00024510: 2020 2020 2020 202e 6e65 7874 203d 204e         .next = N
-00024520: 554c 4c2c 0a20 2020 2020 2020 207d 3b0a  ULL,.        };.
-00024530: 0a20 2020 2020 2020 202f 2f70 7269 6e74  .        //print
-00024540: 6628 2273 6372 6174 6368 206f 6666 7320  f("scratch offs 
-00024550: 3d20 257a 752c 2073 697a 655f 6e65 6564  = %zu, size_need
-00024560: 6564 203d 2025 7a75 5c6e 222c 2063 7478  ed = %zu\n", ctx
-00024570: 2d3e 7363 7261 7463 682e 6f66 6673 2c20  ->scratch.offs, 
-00024580: 7369 7a65 5f6e 6565 6465 6429 3b0a 0a20  size_needed);.. 
-00024590: 2020 2020 2020 2063 7478 2d3e 7363 7261         ctx->scra
-000245a0: 7463 682e 6f66 6673 202b 3d20 7369 7a65  tch.offs += size
-000245b0: 5f6e 6565 6465 643b 0a20 2020 207d 0a0a  _needed;.    }..
-000245c0: 2020 2020 6966 2028 6f62 6a5f 6375 7220      if (obj_cur 
-000245d0: 213d 204e 554c 4c29 207b 0a20 2020 2020  != NULL) {.     
-000245e0: 2020 206f 626a 5f63 7572 2d3e 6e65 7874     obj_cur->next
-000245f0: 203d 206f 626a 5f6e 6577 3b0a 2020 2020   = obj_new;.    
-00024600: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-00024610: 202f 2f20 7468 6973 2069 7320 7468 6520   // this is the 
-00024620: 6669 7273 7420 6f62 6a65 6374 2069 6e20  first object in 
-00024630: 7468 6973 2063 6f6e 7465 7874 0a20 2020  this context.   
-00024640: 2020 2020 2063 7478 2d3e 6f62 6a65 6374       ctx->object
-00024650: 735f 6265 6769 6e20 3d20 6f62 6a5f 6e65  s_begin = obj_ne
-00024660: 773b 0a20 2020 207d 0a0a 2020 2020 6374  w;.    }..    ct
-00024670: 782d 3e6f 626a 6563 7473 5f65 6e64 203d  x->objects_end =
-00024680: 206f 626a 5f6e 6577 3b0a 0a20 2020 202f   obj_new;..    /
-00024690: 2f70 7269 6e74 6628 2225 733a 2069 6e73  /printf("%s: ins
-000246a0: 6572 7465 6420 6e65 7720 6f62 6a65 6374  erted new object
-000246b0: 2061 7420 257a 752c 2073 697a 6520 3d20   at %zu, size = 
-000246c0: 257a 755c 6e22 2c20 5f5f 6675 6e63 5f5f  %zu\n", __func__
-000246d0: 2c20 6375 725f 656e 642c 206f 626a 5f6e  , cur_end, obj_n
-000246e0: 6577 2d3e 7369 7a65 293b 0a0a 2020 2020  ew->size);..    
-000246f0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00024700: 6f72 202a 2063 6f6e 7374 2072 6573 756c  or * const resul
-00024710: 7420 3d20 2873 7472 7563 7420 6767 6d6c  t = (struct ggml
-00024720: 5f74 656e 736f 7220 2a29 286d 656d 5f62  _tensor *)(mem_b
-00024730: 7566 6665 7220 2b20 6f62 6a5f 6e65 772d  uffer + obj_new-
-00024740: 3e6f 6666 7329 3b0a 0a20 2020 2067 676d  >offs);..    ggm
-00024750: 6c5f 6173 7365 7274 5f61 6c69 676e 6564  l_assert_aligned
-00024760: 2872 6573 756c 7429 3b0a 0a20 2020 202a  (result);..    *
-00024770: 7265 7375 6c74 203d 2028 7374 7275 6374  result = (struct
-00024780: 2067 676d 6c5f 7465 6e73 6f72 2920 7b0a   ggml_tensor) {.
-00024790: 2020 2020 2020 2020 2f2a 2e74 7970 6520          /*.type 
-000247a0: 2020 2020 2020 2020 3d2a 2f20 7479 7065          =*/ type
-000247b0: 2c0a 2020 2020 2020 2020 2f2a 2e62 6163  ,.        /*.bac
-000247c0: 6b65 6e64 2020 2020 2020 3d2a 2f20 4747  kend      =*/ GG
-000247d0: 4d4c 5f42 4143 4b45 4e44 5f43 5055 2c0a  ML_BACKEND_CPU,.
-000247e0: 2020 2020 2020 2020 2f2a 2e6e 5f64 696d          /*.n_dim
-000247f0: 7320 2020 2020 2020 3d2a 2f20 6e5f 6469  s       =*/ n_di
-00024800: 6d73 2c0a 2020 2020 2020 2020 2f2a 2e6e  ms,.        /*.n
-00024810: 6520 2020 2020 2020 2020 2020 3d2a 2f20  e           =*/ 
-00024820: 7b20 312c 2031 2c20 312c 2031 207d 2c0a  { 1, 1, 1, 1 },.
-00024830: 2020 2020 2020 2020 2f2a 2e6e 6220 2020          /*.nb   
-00024840: 2020 2020 2020 2020 3d2a 2f20 7b20 302c          =*/ { 0,
-00024850: 2030 2c20 302c 2030 207d 2c0a 2020 2020   0, 0, 0 },.    
-00024860: 2020 2020 2f2a 2e6f 7020 2020 2020 2020      /*.op       
-00024870: 2020 2020 3d2a 2f20 4747 4d4c 5f4f 505f      =*/ GGML_OP_
-00024880: 4e4f 4e45 2c0a 2020 2020 2020 2020 2f2a  NONE,.        /*
-00024890: 2e69 735f 7061 7261 6d20 2020 2020 3d2a  .is_param     =*
-000248a0: 2f20 6661 6c73 652c 0a20 2020 2020 2020  / false,.       
-000248b0: 202f 2a2e 6772 6164 2020 2020 2020 2020   /*.grad        
-000248c0: 203d 2a2f 204e 554c 4c2c 0a20 2020 2020   =*/ NULL,.     
-000248d0: 2020 202f 2a2e 7372 6330 2020 2020 2020     /*.src0      
-000248e0: 2020 203d 2a2f 204e 554c 4c2c 0a20 2020     =*/ NULL,.   
-000248f0: 2020 2020 202f 2a2e 7372 6331 2020 2020       /*.src1    
-00024900: 2020 2020 203d 2a2f 204e 554c 4c2c 0a20       =*/ NULL,. 
-00024910: 2020 2020 2020 202f 2a2e 6f70 7420 2020         /*.opt   
-00024920: 2020 2020 2020 203d 2a2f 207b 204e 554c         =*/ { NUL
-00024930: 4c20 7d2c 0a20 2020 2020 2020 202f 2a2e  L },.        /*.
-00024940: 6e5f 7461 736b 7320 2020 2020 203d 2a2f  n_tasks      =*/
-00024950: 2030 2c0a 2020 2020 2020 2020 2f2a 2e70   0,.        /*.p
-00024960: 6572 665f 7275 6e73 2020 2020 3d2a 2f20  erf_runs    =*/ 
-00024970: 302c 0a20 2020 2020 2020 202f 2a2e 7065  0,.        /*.pe
-00024980: 7266 5f63 7963 6c65 7320 203d 2a2f 2030  rf_cycles  =*/ 0
-00024990: 2c0a 2020 2020 2020 2020 2f2a 2e70 6572  ,.        /*.per
-000249a0: 665f 7469 6d65 5f75 7320 3d2a 2f20 302c  f_time_us =*/ 0,
-000249b0: 0a20 2020 2020 2020 202f 2a2e 6461 7461  .        /*.data
-000249c0: 2020 2020 2020 2020 203d 2a2f 2028 6461           =*/ (da
-000249d0: 7461 203d 3d20 4e55 4c4c 2026 2620 2163  ta == NULL && !c
-000249e0: 7478 2d3e 6e6f 5f61 6c6c 6f63 2920 3f20  tx->no_alloc) ? 
-000249f0: 2876 6f69 6420 2a29 2872 6573 756c 7420  (void *)(result 
-00024a00: 2b20 3129 203a 2064 6174 612c 0a20 2020  + 1) : data,.   
-00024a10: 2020 2020 202f 2a2e 6e61 6d65 2020 2020       /*.name    
-00024a20: 2020 2020 203d 2a2f 207b 2030 207d 2c0a       =*/ { 0 },.
-00024a30: 2020 2020 2020 2020 2f2a 2e65 7874 7261          /*.extra
-00024a40: 2020 2020 2020 2020 3d2a 2f20 4e55 4c4c          =*/ NULL
-00024a50: 2c0a 2020 2020 2020 2020 2f2a 2e70 6164  ,.        /*.pad
-00024a60: 2020 2020 2020 2020 2020 3d2a 2f20 7b20            =*/ { 
-00024a70: 3020 7d2c 0a20 2020 207d 3b0a 0a20 2020  0 },.    };..   
-00024a80: 202f 2f20 544f 444f 3a20 7468 6973 2073   // TODO: this s
-00024a90: 686f 756c 6420 6e6f 7420 6265 206e 6565  hould not be nee
-00024aa0: 6465 6420 6173 206c 6f6e 6720 6173 2077  ded as long as w
-00024ab0: 6520 646f 6e27 7420 7265 6c79 206f 6e20  e don't rely on 
-00024ac0: 616c 6967 6e65 6420 5349 4d44 206c 6f61  aligned SIMD loa
-00024ad0: 6473 0a20 2020 202f 2f67 676d 6c5f 6173  ds.    //ggml_as
-00024ae0: 7365 7274 5f61 6c69 676e 6564 2872 6573  sert_aligned(res
-00024af0: 756c 742d 3e64 6174 6129 3b0a 0a20 2020  ult->data);..   
-00024b00: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00024b10: 2069 203c 206e 5f64 696d 733b 2069 2b2b   i < n_dims; i++
-00024b20: 2920 7b0a 2020 2020 2020 2020 7265 7375  ) {.        resu
-00024b30: 6c74 2d3e 6e65 5b69 5d20 3d20 6e65 5b69  lt->ne[i] = ne[i
-00024b40: 5d3b 0a20 2020 207d 0a0a 2020 2020 7265  ];.    }..    re
-00024b50: 7375 6c74 2d3e 6e62 5b30 5d20 3d20 4747  sult->nb[0] = GG
-00024b60: 4d4c 5f54 5950 455f 5349 5a45 5b74 7970  ML_TYPE_SIZE[typ
-00024b70: 655d 3b0a 2020 2020 7265 7375 6c74 2d3e  e];.    result->
-00024b80: 6e62 5b31 5d20 3d20 7265 7375 6c74 2d3e  nb[1] = result->
-00024b90: 6e62 5b30 5d2a 2872 6573 756c 742d 3e6e  nb[0]*(result->n
-00024ba0: 655b 305d 2f47 474d 4c5f 424c 434b 5f53  e[0]/GGML_BLCK_S
-00024bb0: 495a 455b 7479 7065 5d29 3b0a 2020 2020  IZE[type]);.    
-00024bc0: 666f 7220 2869 6e74 2069 203d 2032 3b20  for (int i = 2; 
-00024bd0: 6920 3c20 4747 4d4c 5f4d 4158 5f44 494d  i < GGML_MAX_DIM
-00024be0: 533b 2069 2b2b 2920 7b0a 2020 2020 2020  S; i++) {.      
-00024bf0: 2020 7265 7375 6c74 2d3e 6e62 5b69 5d20    result->nb[i] 
-00024c00: 3d20 7265 7375 6c74 2d3e 6e62 5b69 202d  = result->nb[i -
-00024c10: 2031 5d2a 7265 7375 6c74 2d3e 6e65 5b69   1]*result->ne[i
-00024c20: 202d 2031 5d3b 0a20 2020 207d 0a0a 2020   - 1];.    }..  
-00024c30: 2020 6374 782d 3e6e 5f6f 626a 6563 7473    ctx->n_objects
-00024c40: 2b2b 3b0a 0a20 2020 2072 6574 7572 6e20  ++;..    return 
-00024c50: 7265 7375 6c74 3b0a 7d0a 0a73 7472 7563  result;.}..struc
-00024c60: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00024c70: 6767 6d6c 5f6e 6577 5f74 656e 736f 7228  ggml_new_tensor(
-00024c80: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00024c90: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00024ca0: 7478 2c0a 2020 2020 2020 2020 656e 756d  tx,.        enum
-00024cb0: 2020 2067 676d 6c5f 7479 7065 2074 7970     ggml_type typ
-00024cc0: 652c 0a20 2020 2020 2020 2069 6e74 2020  e,.        int  
-00024cd0: 2020 6e5f 6469 6d73 2c0a 2020 2020 2020    n_dims,.      
-00024ce0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00024cf0: 2a20 6e65 2920 7b0a 2020 2020 7265 7475  * ne) {.    retu
-00024d00: 726e 2067 676d 6c5f 6e65 775f 7465 6e73  rn ggml_new_tens
-00024d10: 6f72 5f69 6d70 6c28 6374 782c 2074 7970  or_impl(ctx, typ
-00024d20: 652c 206e 5f64 696d 732c 206e 652c 204e  e, n_dims, ne, N
-00024d30: 554c 4c29 3b0a 7d0a 0a73 7472 7563 7420  ULL);.}..struct 
-00024d40: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-00024d50: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
-00024d60: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-00024d70: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00024d80: 6374 782c 0a20 2020 2020 2020 2065 6e75  ctx,.        enu
-00024d90: 6d20 2020 6767 6d6c 5f74 7970 6520 7479  m   ggml_type ty
-00024da0: 7065 2c0a 2020 2020 2020 2020 696e 7436  pe,.        int6
-00024db0: 345f 7420 6e65 3029 207b 0a20 2020 2072  4_t ne0) {.    r
-00024dc0: 6574 7572 6e20 6767 6d6c 5f6e 6577 5f74  eturn ggml_new_t
-00024dd0: 656e 736f 7228 6374 782c 2074 7970 652c  ensor(ctx, type,
-00024de0: 2031 2c20 266e 6530 293b 0a7d 0a0a 7374   1, &ne0);.}..st
-00024df0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00024e00: 202a 2067 676d 6c5f 6e65 775f 7465 6e73   * ggml_new_tens
-00024e10: 6f72 5f32 6428 0a20 2020 2020 2020 2073  or_2d(.        s
-00024e20: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00024e30: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00024e40: 2020 656e 756d 2020 2067 676d 6c5f 7479    enum   ggml_ty
-00024e50: 7065 2074 7970 652c 0a20 2020 2020 2020  pe type,.       
-00024e60: 2069 6e74 3634 5f74 206e 6530 2c0a 2020   int64_t ne0,.  
-00024e70: 2020 2020 2020 696e 7436 345f 7420 6e65        int64_t ne
-00024e80: 3129 207b 0a20 2020 2063 6f6e 7374 2069  1) {.    const i
-00024e90: 6e74 3634 5f74 206e 655b 325d 203d 207b  nt64_t ne[2] = {
-00024ea0: 206e 6530 2c20 6e65 3120 7d3b 0a20 2020   ne0, ne1 };.   
-00024eb0: 2072 6574 7572 6e20 6767 6d6c 5f6e 6577   return ggml_new
-00024ec0: 5f74 656e 736f 7228 6374 782c 2074 7970  _tensor(ctx, typ
-00024ed0: 652c 2032 2c20 6e65 293b 0a7d 0a0a 7374  e, 2, ne);.}..st
-00024ee0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00024ef0: 202a 2067 676d 6c5f 6e65 775f 7465 6e73   * ggml_new_tens
-00024f00: 6f72 5f33 6428 0a20 2020 2020 2020 2073  or_3d(.        s
-00024f10: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00024f20: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00024f30: 2020 656e 756d 2020 2067 676d 6c5f 7479    enum   ggml_ty
-00024f40: 7065 2074 7970 652c 0a20 2020 2020 2020  pe type,.       
-00024f50: 2069 6e74 3634 5f74 206e 6530 2c0a 2020   int64_t ne0,.  
-00024f60: 2020 2020 2020 696e 7436 345f 7420 6e65        int64_t ne
-00024f70: 312c 0a20 2020 2020 2020 2069 6e74 3634  1,.        int64
-00024f80: 5f74 206e 6532 2920 7b0a 2020 2020 636f  _t ne2) {.    co
-00024f90: 6e73 7420 696e 7436 345f 7420 6e65 5b33  nst int64_t ne[3
-00024fa0: 5d20 3d20 7b20 6e65 302c 206e 6531 2c20  ] = { ne0, ne1, 
-00024fb0: 6e65 3220 7d3b 0a20 2020 2072 6574 7572  ne2 };.    retur
-00024fc0: 6e20 6767 6d6c 5f6e 6577 5f74 656e 736f  n ggml_new_tenso
-00024fd0: 7228 6374 782c 2074 7970 652c 2033 2c20  r(ctx, type, 3, 
-00024fe0: 6e65 293b 0a7d 0a0a 7374 7275 6374 2067  ne);.}..struct g
-00024ff0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-00025000: 6c5f 6e65 775f 7465 6e73 6f72 5f34 6428  l_new_tensor_4d(
-00025010: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00025020: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00025030: 7478 2c0a 2020 2020 2020 2020 656e 756d  tx,.        enum
-00025040: 2020 2067 676d 6c5f 7479 7065 2074 7970     ggml_type typ
-00025050: 652c 0a20 2020 2020 2020 2069 6e74 3634  e,.        int64
-00025060: 5f74 206e 6530 2c0a 2020 2020 2020 2020  _t ne0,.        
-00025070: 696e 7436 345f 7420 6e65 312c 0a20 2020  int64_t ne1,.   
-00025080: 2020 2020 2069 6e74 3634 5f74 206e 6532       int64_t ne2
-00025090: 2c0a 2020 2020 2020 2020 696e 7436 345f  ,.        int64_
-000250a0: 7420 6e65 3329 207b 0a20 2020 2063 6f6e  t ne3) {.    con
-000250b0: 7374 2069 6e74 3634 5f74 206e 655b 345d  st int64_t ne[4]
-000250c0: 203d 207b 206e 6530 2c20 6e65 312c 206e   = { ne0, ne1, n
-000250d0: 6532 2c20 6e65 3320 7d3b 0a20 2020 2072  e2, ne3 };.    r
-000250e0: 6574 7572 6e20 6767 6d6c 5f6e 6577 5f74  eturn ggml_new_t
-000250f0: 656e 736f 7228 6374 782c 2074 7970 652c  ensor(ctx, type,
-00025100: 2034 2c20 6e65 293b 0a7d 0a0a 7374 7275   4, ne);.}..stru
-00025110: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00025120: 2067 676d 6c5f 6e65 775f 6933 3228 7374   ggml_new_i32(st
-00025130: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-00025140: 7420 2a20 6374 782c 2069 6e74 3332 5f74  t * ctx, int32_t
-00025150: 2076 616c 7565 2920 7b0a 2020 2020 6767   value) {.    gg
-00025160: 6d6c 5f73 6372 6174 6368 5f73 6176 6528  ml_scratch_save(
-00025170: 6374 7829 3b0a 0a20 2020 2073 7472 7563  ctx);..    struc
-00025180: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00025190: 7265 7375 6c74 203d 2067 676d 6c5f 6e65  result = ggml_ne
-000251a0: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
-000251b0: 2047 474d 4c5f 5459 5045 5f49 3332 2c20   GGML_TYPE_I32, 
-000251c0: 3129 3b0a 0a20 2020 2067 676d 6c5f 7363  1);..    ggml_sc
-000251d0: 7261 7463 685f 6c6f 6164 2863 7478 293b  ratch_load(ctx);
-000251e0: 0a0a 2020 2020 6767 6d6c 5f73 6574 5f69  ..    ggml_set_i
-000251f0: 3332 2872 6573 756c 742c 2076 616c 7565  32(result, value
-00025200: 293b 0a0a 2020 2020 7265 7475 726e 2072  );..    return r
-00025210: 6573 756c 743b 0a7d 0a0a 7374 7275 6374  esult;.}..struct
-00025220: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-00025230: 676d 6c5f 6e65 775f 6633 3228 7374 7275  gml_new_f32(stru
-00025240: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00025250: 2a20 6374 782c 2066 6c6f 6174 2076 616c  * ctx, float val
-00025260: 7565 2920 7b0a 2020 2020 6767 6d6c 5f73  ue) {.    ggml_s
-00025270: 6372 6174 6368 5f73 6176 6528 6374 7829  cratch_save(ctx)
-00025280: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
-00025290: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-000252a0: 6c74 203d 2067 676d 6c5f 6e65 775f 7465  lt = ggml_new_te
-000252b0: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
-000252c0: 4c5f 5459 5045 5f46 3332 2c20 3129 3b0a  L_TYPE_F32, 1);.
-000252d0: 0a20 2020 2067 676d 6c5f 7363 7261 7463  .    ggml_scratc
-000252e0: 685f 6c6f 6164 2863 7478 293b 0a0a 2020  h_load(ctx);..  
-000252f0: 2020 6767 6d6c 5f73 6574 5f66 3332 2872    ggml_set_f32(r
-00025300: 6573 756c 742c 2076 616c 7565 293b 0a0a  esult, value);..
-00025310: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-00025320: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
-00025330: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-00025340: 6475 705f 7465 6e73 6f72 2873 7472 7563  dup_tensor(struc
-00025350: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00025360: 2063 7478 2c20 636f 6e73 7420 7374 7275   ctx, const stru
-00025370: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00025380: 2073 7263 2920 7b0a 2020 2020 7265 7475   src) {.    retu
-00025390: 726e 2067 676d 6c5f 6e65 775f 7465 6e73  rn ggml_new_tens
-000253a0: 6f72 5f69 6d70 6c28 6374 782c 2073 7263  or_impl(ctx, src
-000253b0: 2d3e 7479 7065 2c20 7372 632d 3e6e 5f64  ->type, src->n_d
-000253c0: 696d 732c 2073 7263 2d3e 6e65 2c20 4e55  ims, src->ne, NU
-000253d0: 4c4c 293b 0a7d 0a0a 7374 7275 6374 2067  LL);.}..struct g
-000253e0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-000253f0: 6c5f 7365 745f 7a65 726f 2873 7472 7563  l_set_zero(struc
-00025400: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00025410: 7465 6e73 6f72 2920 7b0a 2020 2020 6d65  tensor) {.    me
-00025420: 6d73 6574 2874 656e 736f 722d 3e64 6174  mset(tensor->dat
-00025430: 612c 2030 2c20 6767 6d6c 5f6e 6279 7465  a, 0, ggml_nbyte
-00025440: 7328 7465 6e73 6f72 2929 3b0a 2020 2020  s(tensor));.    
-00025450: 7265 7475 726e 2074 656e 736f 723b 0a7d  return tensor;.}
-00025460: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-00025470: 6e73 6f72 202a 2067 676d 6c5f 7365 745f  nsor * ggml_set_
-00025480: 6933 3220 2873 7472 7563 7420 6767 6d6c  i32 (struct ggml
-00025490: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
-000254a0: 2c20 696e 7433 325f 7420 7661 6c75 6529  , int32_t value)
-000254b0: 207b 0a20 2020 2063 6f6e 7374 2069 6e74   {.    const int
-000254c0: 206e 2020 2020 203d 2067 676d 6c5f 6e72   n     = ggml_nr
-000254d0: 6f77 7328 7465 6e73 6f72 293b 0a20 2020  ows(tensor);.   
-000254e0: 2063 6f6e 7374 2069 6e74 206e 6320 2020   const int nc   
-000254f0: 203d 2074 656e 736f 722d 3e6e 655b 305d   = tensor->ne[0]
-00025500: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00025510: 5f74 206e 3120 3d20 7465 6e73 6f72 2d3e  _t n1 = tensor->
-00025520: 6e62 5b31 5d3b 0a0a 2020 2020 6368 6172  nb[1];..    char
-00025530: 202a 2063 6f6e 7374 2064 6174 6120 3d20   * const data = 
-00025540: 7465 6e73 6f72 2d3e 6461 7461 3b0a 0a20  tensor->data;.. 
-00025550: 2020 2073 7769 7463 6820 2874 656e 736f     switch (tenso
-00025560: 722d 3e74 7970 6529 207b 0a20 2020 2020  r->type) {.     
-00025570: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00025580: 455f 4938 3a0a 2020 2020 2020 2020 2020  E_I8:.          
-00025590: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000255a0: 2020 2020 6173 7365 7274 2874 656e 736f      assert(tenso
-000255b0: 722d 3e6e 625b 305d 203d 3d20 7369 7a65  r->nb[0] == size
-000255c0: 6f66 2869 6e74 385f 7429 293b 0a20 2020  of(int8_t));.   
-000255d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000255e0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-000255f0: 206e 3b20 692b 2b29 207b 0a20 2020 2020   n; i++) {.     
-00025600: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00025610: 676d 6c5f 7665 635f 7365 745f 6938 286e  gml_vec_set_i8(n
-00025620: 632c 2028 696e 7438 5f74 202a 2928 6461  c, (int8_t *)(da
-00025630: 7461 202b 2069 2a6e 3129 2c20 7661 6c75  ta + i*n1), valu
-00025640: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00025650: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00025660: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00025670: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00025680: 455f 4931 363a 0a20 2020 2020 2020 2020  E_I16:.         
-00025690: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000256a0: 2020 2020 2061 7373 6572 7428 7465 6e73       assert(tens
-000256b0: 6f72 2d3e 6e62 5b30 5d20 3d3d 2073 697a  or->nb[0] == siz
-000256c0: 656f 6628 696e 7431 365f 7429 293b 0a20  eof(int16_t));. 
-000256d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000256e0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-000256f0: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
-00025700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025710: 2067 676d 6c5f 7665 635f 7365 745f 6931   ggml_vec_set_i1
-00025720: 3628 6e63 2c20 2869 6e74 3136 5f74 202a  6(nc, (int16_t *
-00025730: 2928 6461 7461 202b 2069 2a6e 3129 2c20  )(data + i*n1), 
-00025740: 7661 6c75 6529 3b0a 2020 2020 2020 2020  value);.        
-00025750: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00025760: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00025770: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00025780: 5f54 5950 455f 4933 323a 0a20 2020 2020  _TYPE_I32:.     
-00025790: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000257a0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-000257b0: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
-000257c0: 2073 697a 656f 6628 696e 7433 325f 7429   sizeof(int32_t)
-000257d0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000257e0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-000257f0: 303b 2069 203c 206e 3b20 692b 2b29 207b  0; i < n; i++) {
-00025800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025810: 2020 2020 2067 676d 6c5f 7665 635f 7365       ggml_vec_se
-00025820: 745f 6933 3228 6e63 2c20 2869 6e74 3332  t_i32(nc, (int32
-00025830: 5f74 202a 2928 6461 7461 202b 2069 2a6e  _t *)(data + i*n
-00025840: 3129 2c20 7661 6c75 6529 3b0a 2020 2020  1), value);.    
-00025850: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00025860: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00025870: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00025880: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
-00025890: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000258a0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-000258b0: 6572 7428 7465 6e73 6f72 2d3e 6e62 5b30  ert(tensor->nb[0
-000258c0: 5d20 3d3d 2073 697a 656f 6628 6767 6d6c  ] == sizeof(ggml
-000258d0: 5f66 7031 365f 7429 293b 0a20 2020 2020  _fp16_t));.     
-000258e0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-000258f0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-00025900: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00025910: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00025920: 6c5f 7665 635f 7365 745f 6631 3628 6e63  l_vec_set_f16(nc
-00025930: 2c20 2867 676d 6c5f 6670 3136 5f74 202a  , (ggml_fp16_t *
-00025940: 2928 6461 7461 202b 2069 2a6e 3129 2c20  )(data + i*n1), 
-00025950: 7661 6c75 6529 3b0a 2020 2020 2020 2020  value);.        
-00025960: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00025970: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00025980: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00025990: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-000259a0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000259b0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-000259c0: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
-000259d0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-000259e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000259f0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00025a00: 2069 203c 206e 3b20 692b 2b29 207b 0a20   i < n; i++) {. 
-00025a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a20: 2020 2067 676d 6c5f 7665 635f 7365 745f     ggml_vec_set_
-00025a30: 6633 3228 6e63 2c20 2866 6c6f 6174 202a  f32(nc, (float *
-00025a40: 2928 6461 7461 202b 2069 2a6e 3129 2c20  )(data + i*n1), 
-00025a50: 7661 6c75 6529 3b0a 2020 2020 2020 2020  value);.        
-00025a60: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00025a70: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00025a80: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
-00025a90: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00025aa0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00025ab0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00025ac0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00025ad0: 6272 6561 6b3b 0a20 2020 207d 0a0a 2020  break;.    }..  
-00025ae0: 2020 7265 7475 726e 2074 656e 736f 723b    return tensor;
-00025af0: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-00025b00: 7465 6e73 6f72 202a 2067 676d 6c5f 7365  tensor * ggml_se
-00025b10: 745f 6633 3228 7374 7275 6374 2067 676d  t_f32(struct ggm
-00025b20: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
-00025b30: 722c 2066 6c6f 6174 2076 616c 7565 2920  r, float value) 
-00025b40: 7b0a 2020 2020 636f 6e73 7420 696e 7420  {.    const int 
-00025b50: 6e20 2020 2020 3d20 6767 6d6c 5f6e 726f  n     = ggml_nro
-00025b60: 7773 2874 656e 736f 7229 3b0a 2020 2020  ws(tensor);.    
-00025b70: 636f 6e73 7420 696e 7420 6e63 2020 2020  const int nc    
-00025b80: 3d20 7465 6e73 6f72 2d3e 6e65 5b30 5d3b  = tensor->ne[0];
-00025b90: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00025ba0: 7420 6e31 203d 2074 656e 736f 722d 3e6e  t n1 = tensor->n
-00025bb0: 625b 315d 3b0a 0a20 2020 2063 6861 7220  b[1];..    char 
-00025bc0: 2a20 636f 6e73 7420 6461 7461 203d 2074  * const data = t
-00025bd0: 656e 736f 722d 3e64 6174 613b 0a0a 2020  ensor->data;..  
-00025be0: 2020 7377 6974 6368 2028 7465 6e73 6f72    switch (tensor
-00025bf0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-00025c00: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00025c10: 5f49 383a 0a20 2020 2020 2020 2020 2020  _I8:.           
-00025c20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00025c30: 2020 2061 7373 6572 7428 7465 6e73 6f72     assert(tensor
-00025c40: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
-00025c50: 6628 696e 7438 5f74 2929 3b0a 2020 2020  f(int8_t));.    
-00025c60: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00025c70: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00025c80: 6e3b 2069 2b2b 2920 7b0a 2020 2020 2020  n; i++) {.      
-00025c90: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00025ca0: 6d6c 5f76 6563 5f73 6574 5f69 3828 6e63  ml_vec_set_i8(nc
-00025cb0: 2c20 2869 6e74 385f 7420 2a29 2864 6174  , (int8_t *)(dat
-00025cc0: 6120 2b20 692a 6e31 292c 2076 616c 7565  a + i*n1), value
-00025cd0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00025ce0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00025cf0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00025d00: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00025d10: 5f49 3136 3a0a 2020 2020 2020 2020 2020  _I16:.          
-00025d20: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00025d30: 2020 2020 6173 7365 7274 2874 656e 736f      assert(tenso
-00025d40: 722d 3e6e 625b 305d 203d 3d20 7369 7a65  r->nb[0] == size
-00025d50: 6f66 2869 6e74 3136 5f74 2929 3b0a 2020  of(int16_t));.  
-00025d60: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00025d70: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00025d80: 3c20 6e3b 2069 2b2b 2920 7b0a 2020 2020  < n; i++) {.    
-00025d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025da0: 6767 6d6c 5f76 6563 5f73 6574 5f69 3136  ggml_vec_set_i16
-00025db0: 286e 632c 2028 696e 7431 365f 7420 2a29  (nc, (int16_t *)
-00025dc0: 2864 6174 6120 2b20 692a 6e31 292c 2076  (data + i*n1), v
-00025dd0: 616c 7565 293b 0a20 2020 2020 2020 2020  alue);.         
-00025de0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00025df0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00025e00: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00025e10: 5459 5045 5f49 3332 3a0a 2020 2020 2020  TYPE_I32:.      
-00025e20: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00025e30: 2020 2020 2020 2020 6173 7365 7274 2874          assert(t
-00025e40: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
-00025e50: 7369 7a65 6f66 2869 6e74 3332 5f74 2929  sizeof(int32_t))
-00025e60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00025e70: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00025e80: 3b20 6920 3c20 6e3b 2069 2b2b 2920 7b0a  ; i < n; i++) {.
-00025e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025ea0: 2020 2020 6767 6d6c 5f76 6563 5f73 6574      ggml_vec_set
-00025eb0: 5f69 3332 286e 632c 2028 696e 7433 325f  _i32(nc, (int32_
-00025ec0: 7420 2a29 2864 6174 6120 2b20 692a 6e31  t *)(data + i*n1
-00025ed0: 292c 2076 616c 7565 293b 0a20 2020 2020  ), value);.     
-00025ee0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00025ef0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00025f00: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00025f10: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-00025f20: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00025f30: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00025f40: 7274 2874 656e 736f 722d 3e6e 625b 305d  rt(tensor->nb[0]
-00025f50: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
-00025f60: 6670 3136 5f74 2929 3b0a 2020 2020 2020  fp16_t));.      
-00025f70: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00025f80: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
-00025f90: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-00025fa0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00025fb0: 5f76 6563 5f73 6574 5f66 3136 286e 632c  _vec_set_f16(nc,
-00025fc0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-00025fd0: 2864 6174 6120 2b20 692a 6e31 292c 2076  (data + i*n1), v
-00025fe0: 616c 7565 293b 0a20 2020 2020 2020 2020  alue);.         
-00025ff0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00026000: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00026010: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00026020: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-00026030: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00026040: 2020 2020 2020 2020 6173 7365 7274 2874          assert(t
-00026050: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
-00026060: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00026070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026080: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00026090: 6920 3c20 6e3b 2069 2b2b 2920 7b0a 2020  i < n; i++) {.  
-000260a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000260b0: 2020 6767 6d6c 5f76 6563 5f73 6574 5f66    ggml_vec_set_f
-000260c0: 3332 286e 632c 2028 666c 6f61 7420 2a29  32(nc, (float *)
-000260d0: 2864 6174 6120 2b20 692a 6e31 292c 2076  (data + i*n1), v
-000260e0: 616c 7565 293b 0a20 2020 2020 2020 2020  alue);.         
-000260f0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00026100: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00026110: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
-00026120: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00026130: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00026140: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00026150: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00026160: 7265 616b 3b0a 2020 2020 7d0a 0a20 2020  reak;.    }..   
-00026170: 2072 6574 7572 6e20 7465 6e73 6f72 3b0a   return tensor;.
-00026180: 7d0a 0a69 6e74 3332 5f74 2067 676d 6c5f  }..int32_t ggml_
-00026190: 6765 745f 6933 325f 3164 2863 6f6e 7374  get_i32_1d(const
-000261a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000261b0: 736f 7220 2a20 7465 6e73 6f72 2c20 696e  sor * tensor, in
-000261c0: 7420 6929 207b 0a20 2020 2073 7769 7463  t i) {.    switc
-000261d0: 6820 2874 656e 736f 722d 3e74 7970 6529  h (tensor->type)
-000261e0: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-000261f0: 4747 4d4c 5f54 5950 455f 4938 3a0a 2020  GGML_TYPE_I8:.  
-00026200: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00026210: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00026220: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
-00026230: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
-00026240: 696e 7438 5f74 2929 3b0a 2020 2020 2020  int8_t));.      
-00026250: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00026260: 2028 2869 6e74 385f 7420 2a29 2874 656e   ((int8_t *)(ten
-00026270: 736f 722d 3e64 6174 6129 295b 695d 3b0a  sor->data))[i];.
-00026280: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00026290: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000262a0: 6520 4747 4d4c 5f54 5950 455f 4931 363a  e GGML_TYPE_I16:
-000262b0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000262c0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-000262d0: 474d 4c5f 4153 5345 5254 2874 656e 736f  GML_ASSERT(tenso
-000262e0: 722d 3e6e 625b 305d 203d 3d20 7369 7a65  r->nb[0] == size
-000262f0: 6f66 2869 6e74 3136 5f74 2929 3b0a 2020  of(int16_t));.  
-00026300: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00026310: 7475 726e 2028 2869 6e74 3136 5f74 202a  turn ((int16_t *
-00026320: 2928 7465 6e73 6f72 2d3e 6461 7461 2929  )(tensor->data))
-00026330: 5b69 5d3b 0a20 2020 2020 2020 2020 2020  [i];.           
-00026340: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00026350: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00026360: 5f49 3332 3a0a 2020 2020 2020 2020 2020  _I32:.          
-00026370: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00026380: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00026390: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
-000263a0: 2073 697a 656f 6628 696e 7433 325f 7429   sizeof(int32_t)
-000263b0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000263c0: 2020 2072 6574 7572 6e20 2828 696e 7433     return ((int3
-000263d0: 325f 7420 2a29 2874 656e 736f 722d 3e64  2_t *)(tensor->d
-000263e0: 6174 6129 295b 695d 3b0a 2020 2020 2020  ata))[i];.      
-000263f0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00026400: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00026410: 5f54 5950 455f 4631 363a 0a20 2020 2020  _TYPE_F16:.     
-00026420: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00026430: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00026440: 5345 5254 2874 656e 736f 722d 3e6e 625b  SERT(tensor->nb[
-00026450: 305d 203d 3d20 7369 7a65 6f66 2867 676d  0] == sizeof(ggm
-00026460: 6c5f 6670 3136 5f74 2929 3b0a 2020 2020  l_fp16_t));.    
-00026470: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00026480: 726e 2047 474d 4c5f 4650 3136 5f54 4f5f  rn GGML_FP16_TO_
-00026490: 4650 3332 2828 2867 676d 6c5f 6670 3136  FP32(((ggml_fp16
-000264a0: 5f74 202a 2928 7465 6e73 6f72 2d3e 6461  _t *)(tensor->da
-000264b0: 7461 2929 5b69 5d29 3b0a 2020 2020 2020  ta))[i]);.      
-000264c0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000264d0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000264e0: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-000264f0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00026500: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00026510: 5345 5254 2874 656e 736f 722d 3e6e 625b  SERT(tensor->nb[
-00026520: 305d 203d 3d20 7369 7a65 6f66 2866 6c6f  0] == sizeof(flo
-00026530: 6174 2929 3b0a 2020 2020 2020 2020 2020  at));.          
-00026540: 2020 2020 2020 7265 7475 726e 2028 2866        return ((f
-00026550: 6c6f 6174 202a 2928 7465 6e73 6f72 2d3e  loat *)(tensor->
-00026560: 6461 7461 2929 5b69 5d3b 0a20 2020 2020  data))[i];.     
-00026570: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00026580: 2020 2020 2020 2020 6465 6661 756c 743a          default:
-00026590: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000265a0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-000265b0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-000265c0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000265d0: 2062 7265 616b 3b0a 2020 2020 7d0a 0a20   break;.    }.. 
-000265e0: 2020 2072 6574 7572 6e20 302e 3066 3b0a     return 0.0f;.
-000265f0: 7d0a 0a76 6f69 6420 6767 6d6c 5f73 6574  }..void ggml_set
-00026600: 5f69 3332 5f31 6428 636f 6e73 7420 7374  _i32_1d(const st
-00026610: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00026620: 202a 2074 656e 736f 722c 2069 6e74 2069   * tensor, int i
-00026630: 2c20 696e 7433 325f 7420 7661 6c75 6529  , int32_t value)
-00026640: 207b 0a20 2020 2073 7769 7463 6820 2874   {.    switch (t
-00026650: 656e 736f 722d 3e74 7970 6529 207b 0a20  ensor->type) {. 
-00026660: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00026670: 5f54 5950 455f 4938 3a0a 2020 2020 2020  _TYPE_I8:.      
-00026680: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00026690: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-000266a0: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
-000266b0: 5d20 3d3d 2073 697a 656f 6628 696e 7438  ] == sizeof(int8
-000266c0: 5f74 2929 3b0a 2020 2020 2020 2020 2020  _t));.          
-000266d0: 2020 2020 2020 2828 696e 7438 5f74 202a        ((int8_t *
-000266e0: 2928 7465 6e73 6f72 2d3e 6461 7461 2929  )(tensor->data))
-000266f0: 5b69 5d20 3d20 7661 6c75 653b 0a20 2020  [i] = value;.   
-00026700: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00026710: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00026720: 474d 4c5f 5459 5045 5f49 3136 3a0a 2020  GML_TYPE_I16:.  
-00026730: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00026740: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00026750: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
-00026760: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
-00026770: 696e 7431 365f 7429 293b 0a20 2020 2020  int16_t));.     
-00026780: 2020 2020 2020 2020 2020 2028 2869 6e74             ((int
-00026790: 3136 5f74 202a 2928 7465 6e73 6f72 2d3e  16_t *)(tensor->
-000267a0: 6461 7461 2929 5b69 5d20 3d20 7661 6c75  data))[i] = valu
-000267b0: 653b 0a20 2020 2020 2020 2020 2020 207d  e;.            }
-000267c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000267d0: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
-000267e0: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
-000267f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00026800: 2020 4747 4d4c 5f41 5353 4552 5428 7465    GGML_ASSERT(te
-00026810: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
-00026820: 697a 656f 6628 696e 7433 325f 7429 293b  izeof(int32_t));
-00026830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026840: 2028 2869 6e74 3332 5f74 202a 2928 7465   ((int32_t *)(te
-00026850: 6e73 6f72 2d3e 6461 7461 2929 5b69 5d20  nsor->data))[i] 
-00026860: 3d20 7661 6c75 653b 0a20 2020 2020 2020  = value;.       
-00026870: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00026880: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00026890: 5459 5045 5f46 3136 3a0a 2020 2020 2020  TYPE_F16:.      
-000268a0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000268b0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-000268c0: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
-000268d0: 5d20 3d3d 2073 697a 656f 6628 6767 6d6c  ] == sizeof(ggml
-000268e0: 5f66 7031 365f 7429 293b 0a20 2020 2020  _fp16_t));.     
-000268f0: 2020 2020 2020 2020 2020 2028 2867 676d             ((ggm
-00026900: 6c5f 6670 3136 5f74 202a 2928 7465 6e73  l_fp16_t *)(tens
-00026910: 6f72 2d3e 6461 7461 2929 5b69 5d20 3d20  or->data))[i] = 
-00026920: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
-00026930: 3628 7661 6c75 6529 3b0a 2020 2020 2020  6(value);.      
-00026940: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00026950: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00026960: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-00026970: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00026980: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00026990: 5345 5254 2874 656e 736f 722d 3e6e 625b  SERT(tensor->nb[
-000269a0: 305d 203d 3d20 7369 7a65 6f66 2866 6c6f  0] == sizeof(flo
-000269b0: 6174 2929 3b0a 2020 2020 2020 2020 2020  at));.          
-000269c0: 2020 2020 2020 2828 666c 6f61 7420 2a29        ((float *)
-000269d0: 2874 656e 736f 722d 3e64 6174 6129 295b  (tensor->data))[
-000269e0: 695d 203d 2076 616c 7565 3b0a 2020 2020  i] = value;.    
-000269f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00026a00: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
-00026a10: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00026a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026a30: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-00026a40: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00026a50: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
-00026a60: 0a0a 666c 6f61 7420 6767 6d6c 5f67 6574  ..float ggml_get
-00026a70: 5f66 3332 5f31 6428 636f 6e73 7420 7374  _f32_1d(const st
-00026a80: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00026a90: 202a 2074 656e 736f 722c 2069 6e74 2069   * tensor, int i
-00026aa0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00026ab0: 7465 6e73 6f72 2d3e 7479 7065 2920 7b0a  tensor->type) {.
-00026ac0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00026ad0: 4c5f 5459 5045 5f49 383a 0a20 2020 2020  L_TYPE_I8:.     
-00026ae0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00026af0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00026b00: 5345 5254 2874 656e 736f 722d 3e6e 625b  SERT(tensor->nb[
-00026b10: 305d 203d 3d20 7369 7a65 6f66 2869 6e74  0] == sizeof(int
-00026b20: 385f 7429 293b 0a20 2020 2020 2020 2020  8_t));.         
-00026b30: 2020 2020 2020 2072 6574 7572 6e20 2828         return ((
-00026b40: 696e 7438 5f74 202a 2928 7465 6e73 6f72  int8_t *)(tensor
-00026b50: 2d3e 6461 7461 2929 5b69 5d3b 0a20 2020  ->data))[i];.   
-00026b60: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00026b70: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00026b80: 474d 4c5f 5459 5045 5f49 3136 3a0a 2020  GML_TYPE_I16:.  
-00026b90: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00026ba0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00026bb0: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
-00026bc0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
-00026bd0: 696e 7431 365f 7429 293b 0a20 2020 2020  int16_t));.     
-00026be0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00026bf0: 6e20 2828 696e 7431 365f 7420 2a29 2874  n ((int16_t *)(t
-00026c00: 656e 736f 722d 3e64 6174 6129 295b 695d  ensor->data))[i]
-00026c10: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00026c20: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00026c30: 6173 6520 4747 4d4c 5f54 5950 455f 4933  ase GGML_TYPE_I3
-00026c40: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-00026c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026c60: 2047 474d 4c5f 4153 5345 5254 2874 656e   GGML_ASSERT(ten
-00026c70: 736f 722d 3e6e 625b 305d 203d 3d20 7369  sor->nb[0] == si
-00026c80: 7a65 6f66 2869 6e74 3332 5f74 2929 3b0a  zeof(int32_t));.
-00026c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ca0: 7265 7475 726e 2028 2869 6e74 3332 5f74  return ((int32_t
-00026cb0: 202a 2928 7465 6e73 6f72 2d3e 6461 7461   *)(tensor->data
-00026cc0: 2929 5b69 5d3b 0a20 2020 2020 2020 2020  ))[i];.         
-00026cd0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00026ce0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00026cf0: 5045 5f46 3136 3a0a 2020 2020 2020 2020  PE_F16:.        
-00026d00: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00026d10: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00026d20: 5428 7465 6e73 6f72 2d3e 6e62 5b30 5d20  T(tensor->nb[0] 
-00026d30: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
-00026d40: 7031 365f 7429 293b 0a20 2020 2020 2020  p16_t));.       
-00026d50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00026d60: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
-00026d70: 3228 2828 6767 6d6c 5f66 7031 365f 7420  2(((ggml_fp16_t 
-00026d80: 2a29 2874 656e 736f 722d 3e64 6174 6129  *)(tensor->data)
-00026d90: 295b 695d 293b 0a20 2020 2020 2020 2020  )[i]);.         
-00026da0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00026db0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00026dc0: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
-00026dd0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00026de0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00026df0: 5428 7465 6e73 6f72 2d3e 6e62 5b30 5d20  T(tensor->nb[0] 
-00026e00: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-00026e10: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00026e20: 2020 2072 6574 7572 6e20 2828 666c 6f61     return ((floa
-00026e30: 7420 2a29 2874 656e 736f 722d 3e64 6174  t *)(tensor->dat
-00026e40: 6129 295b 695d 3b0a 2020 2020 2020 2020  a))[i];.        
-00026e50: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00026e60: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
-00026e70: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00026e80: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00026e90: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-00026ea0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00026eb0: 6561 6b3b 0a20 2020 207d 0a0a 2020 2020  eak;.    }..    
-00026ec0: 7265 7475 726e 2030 2e30 663b 0a7d 0a0a  return 0.0f;.}..
-00026ed0: 766f 6964 2067 676d 6c5f 7365 745f 6633  void ggml_set_f3
-00026ee0: 325f 3164 2863 6f6e 7374 2073 7472 7563  2_1d(const struc
-00026ef0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00026f00: 7465 6e73 6f72 2c20 696e 7420 692c 2066  tensor, int i, f
-00026f10: 6c6f 6174 2076 616c 7565 2920 7b0a 2020  loat value) {.  
-00026f20: 2020 7377 6974 6368 2028 7465 6e73 6f72    switch (tensor
-00026f30: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-00026f40: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00026f50: 5f49 383a 0a20 2020 2020 2020 2020 2020  _I8:.           
-00026f60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00026f70: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
-00026f80: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
-00026f90: 7369 7a65 6f66 2869 6e74 385f 7429 293b  sizeof(int8_t));
-00026fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026fb0: 2028 2869 6e74 385f 7420 2a29 2874 656e   ((int8_t *)(ten
-00026fc0: 736f 722d 3e64 6174 6129 295b 695d 203d  sor->data))[i] =
-00026fd0: 2076 616c 7565 3b0a 2020 2020 2020 2020   value;.        
-00026fe0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00026ff0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00027000: 5950 455f 4931 363a 0a20 2020 2020 2020  YPE_I16:.       
-00027010: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00027020: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00027030: 5254 2874 656e 736f 722d 3e6e 625b 305d  RT(tensor->nb[0]
-00027040: 203d 3d20 7369 7a65 6f66 2869 6e74 3136   == sizeof(int16
-00027050: 5f74 2929 3b0a 2020 2020 2020 2020 2020  _t));.          
-00027060: 2020 2020 2020 2828 696e 7431 365f 7420        ((int16_t 
-00027070: 2a29 2874 656e 736f 722d 3e64 6174 6129  *)(tensor->data)
-00027080: 295b 695d 203d 2076 616c 7565 3b0a 2020  )[i] = value;.  
-00027090: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000270a0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-000270b0: 4747 4d4c 5f54 5950 455f 4933 323a 0a20  GGML_TYPE_I32:. 
-000270c0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000270d0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-000270e0: 4c5f 4153 5345 5254 2874 656e 736f 722d  L_ASSERT(tensor-
-000270f0: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-00027100: 2869 6e74 3332 5f74 2929 3b0a 2020 2020  (int32_t));.    
-00027110: 2020 2020 2020 2020 2020 2020 2828 696e              ((in
-00027120: 7433 325f 7420 2a29 2874 656e 736f 722d  t32_t *)(tensor-
-00027130: 3e64 6174 6129 295b 695d 203d 2076 616c  >data))[i] = val
-00027140: 7565 3b0a 2020 2020 2020 2020 2020 2020  ue;.            
-00027150: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00027160: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00027170: 4631 363a 0a20 2020 2020 2020 2020 2020  F16:.           
-00027180: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00027190: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
-000271a0: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
-000271b0: 7369 7a65 6f66 2867 676d 6c5f 6670 3136  sizeof(ggml_fp16
-000271c0: 5f74 2929 3b0a 2020 2020 2020 2020 2020  _t));.          
-000271d0: 2020 2020 2020 2828 6767 6d6c 5f66 7031        ((ggml_fp1
-000271e0: 365f 7420 2a29 2874 656e 736f 722d 3e64  6_t *)(tensor->d
-000271f0: 6174 6129 295b 695d 203d 2047 474d 4c5f  ata))[i] = GGML_
-00027200: 4650 3332 5f54 4f5f 4650 3136 2876 616c  FP32_TO_FP16(val
-00027210: 7565 293b 0a20 2020 2020 2020 2020 2020  ue);.           
-00027220: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00027230: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00027240: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-00027250: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00027260: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00027270: 7465 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d  tensor->nb[0] ==
-00027280: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-00027290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000272a0: 2028 2866 6c6f 6174 202a 2928 7465 6e73   ((float *)(tens
-000272b0: 6f72 2d3e 6461 7461 2929 5b69 5d20 3d20  or->data))[i] = 
-000272c0: 7661 6c75 653b 0a20 2020 2020 2020 2020  value;.         
-000272d0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000272e0: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-000272f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00027300: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00027310: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-00027320: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00027330: 616b 3b0a 2020 2020 7d0a 7d0a 0a76 6f69  ak;.    }.}..voi
-00027340: 6420 2a20 6767 6d6c 5f67 6574 5f64 6174  d * ggml_get_dat
-00027350: 6128 636f 6e73 7420 7374 7275 6374 2067  a(const struct g
-00027360: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
-00027370: 736f 7229 207b 0a20 2020 2072 6574 7572  sor) {.    retur
-00027380: 6e20 7465 6e73 6f72 2d3e 6461 7461 3b0a  n tensor->data;.
-00027390: 7d0a 0a66 6c6f 6174 202a 2067 676d 6c5f  }..float * ggml_
-000273a0: 6765 745f 6461 7461 5f66 3332 2863 6f6e  get_data_f32(con
-000273b0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-000273c0: 656e 736f 7220 2a20 7465 6e73 6f72 2920  ensor * tensor) 
-000273d0: 7b0a 2020 2020 6173 7365 7274 2874 656e  {.    assert(ten
-000273e0: 736f 722d 3e74 7970 6520 3d3d 2047 474d  sor->type == GGM
-000273f0: 4c5f 5459 5045 5f46 3332 293b 0a20 2020  L_TYPE_F32);.   
-00027400: 2072 6574 7572 6e20 2866 6c6f 6174 202a   return (float *
-00027410: 2928 7465 6e73 6f72 2d3e 6461 7461 293b  )(tensor->data);
-00027420: 0a7d 0a0a 636f 6e73 7420 6368 6172 202a  .}..const char *
-00027430: 2067 676d 6c5f 6765 745f 6e61 6d65 2863   ggml_get_name(c
-00027440: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00027450: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
-00027460: 2920 7b0a 2020 2020 7265 7475 726e 2074  ) {.    return t
-00027470: 656e 736f 722d 3e6e 616d 653b 0a7d 0a0a  ensor->name;.}..
-00027480: 766f 6964 2067 676d 6c5f 7365 745f 6e61  void ggml_set_na
-00027490: 6d65 2873 7472 7563 7420 6767 6d6c 5f74  me(struct ggml_t
-000274a0: 656e 736f 7220 2a20 7465 6e73 6f72 2c20  ensor * tensor, 
-000274b0: 636f 6e73 7420 6368 6172 202a 206e 616d  const char * nam
-000274c0: 6529 207b 0a20 2020 2073 7472 6e63 7079  e) {.    strncpy
-000274d0: 2874 656e 736f 722d 3e6e 616d 652c 206e  (tensor->name, n
-000274e0: 616d 652c 2073 697a 656f 6628 7465 6e73  ame, sizeof(tens
-000274f0: 6f72 2d3e 6e61 6d65 2929 3b0a 2020 2020  or->name));.    
-00027500: 7465 6e73 6f72 2d3e 6e61 6d65 5b73 697a  tensor->name[siz
-00027510: 656f 6628 7465 6e73 6f72 2d3e 6e61 6d65  eof(tensor->name
-00027520: 2920 2d20 315d 203d 2027 5c30 273b 0a7d  ) - 1] = '\0';.}
-00027530: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-00027540: 6e73 6f72 202a 2067 676d 6c5f 7669 6577  nsor * ggml_view
-00027550: 5f74 656e 736f 7228 0a20 2020 2020 2020  _tensor(.       
-00027560: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-00027570: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-00027580: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00027590: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-000275a0: 7263 2920 7b0a 2020 2020 7374 7275 6374  rc) {.    struct
-000275b0: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
-000275c0: 6573 756c 7420 3d20 6767 6d6c 5f6e 6577  esult = ggml_new
-000275d0: 5f74 656e 736f 725f 696d 706c 2863 7478  _tensor_impl(ctx
-000275e0: 2c20 7372 632d 3e74 7970 652c 2073 7263  , src->type, src
-000275f0: 2d3e 6e5f 6469 6d73 2c20 7372 632d 3e6e  ->n_dims, src->n
-00027600: 652c 2073 7263 2d3e 6461 7461 293b 0a0a  e, src->data);..
-00027610: 2020 2020 7265 7375 6c74 2d3e 6e62 5b30      result->nb[0
-00027620: 5d20 3d20 7372 632d 3e6e 625b 305d 3b0a  ] = src->nb[0];.
-00027630: 2020 2020 7265 7375 6c74 2d3e 6e62 5b31      result->nb[1
-00027640: 5d20 3d20 7372 632d 3e6e 625b 315d 3b0a  ] = src->nb[1];.
-00027650: 2020 2020 7265 7375 6c74 2d3e 6e62 5b32      result->nb[2
-00027660: 5d20 3d20 7372 632d 3e6e 625b 325d 3b0a  ] = src->nb[2];.
-00027670: 2020 2020 7265 7375 6c74 2d3e 6e62 5b33      result->nb[3
-00027680: 5d20 3d20 7372 632d 3e6e 625b 335d 3b0a  ] = src->nb[3];.
-00027690: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-000276a0: 6c74 3b0a 7d0a 0a73 7472 7563 7420 6767  lt;.}..struct gg
-000276b0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
-000276c0: 5f67 6574 5f74 656e 736f 7228 7374 7275  _get_tensor(stru
-000276d0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-000276e0: 2a20 6374 782c 2063 6f6e 7374 2063 6861  * ctx, const cha
-000276f0: 7220 2a20 6e61 6d65 2920 7b0a 2020 2020  r * name) {.    
-00027700: 7374 7275 6374 2067 676d 6c5f 6f62 6a65  struct ggml_obje
-00027710: 6374 202a 206f 626a 203d 2063 7478 2d3e  ct * obj = ctx->
-00027720: 6f62 6a65 6374 735f 6265 6769 6e3b 0a0a  objects_begin;..
-00027730: 2020 2020 6368 6172 202a 2063 6f6e 7374      char * const
-00027740: 206d 656d 5f62 7566 6665 7220 3d20 6374   mem_buffer = ct
-00027750: 782d 3e6d 656d 5f62 7566 6665 723b 0a0a  x->mem_buffer;..
-00027760: 2020 2020 7768 696c 6520 286f 626a 2021      while (obj !
-00027770: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
-00027780: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00027790: 6e73 6f72 202a 2063 7572 203d 2028 7374  nsor * cur = (st
-000277a0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000277b0: 202a 2928 6d65 6d5f 6275 6666 6572 202b   *)(mem_buffer +
-000277c0: 206f 626a 2d3e 6f66 6673 293b 0a20 2020   obj->offs);.   
-000277d0: 2020 2020 2069 6620 2873 7472 636d 7028       if (strcmp(
-000277e0: 6375 722d 3e6e 616d 652c 206e 616d 6529  cur->name, name)
-000277f0: 203d 3d20 3029 207b 0a20 2020 2020 2020   == 0) {.       
-00027800: 2020 2020 2072 6574 7572 6e20 6375 723b       return cur;
-00027810: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00027820: 2020 2020 6f62 6a20 3d20 6f62 6a2d 3e6e      obj = obj->n
-00027830: 6578 743b 0a20 2020 207d 0a0a 2020 2020  ext;.    }..    
-00027840: 7265 7475 726e 204e 554c 4c3b 0a7d 0a0a  return NULL;.}..
+00023b60: 2f2f 2f2f 2f0a 0a73 7472 7563 7420 6767  /////..struct gg
+00023b70: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+00023b80: 5f6e 6577 5f74 656e 736f 725f 696d 706c  _new_tensor_impl
+00023b90: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+00023ba0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00023bb0: 6374 782c 0a20 2020 2020 2020 2065 6e75  ctx,.        enu
+00023bc0: 6d20 2020 6767 6d6c 5f74 7970 6520 7479  m   ggml_type ty
+00023bd0: 7065 2c0a 2020 2020 2020 2020 696e 7420  pe,.        int 
+00023be0: 2020 206e 5f64 696d 732c 0a20 2020 2020     n_dims,.     
+00023bf0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00023c00: 2a20 6e65 2c0a 2020 2020 2020 2020 766f  * ne,.        vo
+00023c10: 6964 2a20 2064 6174 6129 207b 0a20 2020  id*  data) {.   
+00023c20: 202f 2f20 616c 7761 7973 2069 6e73 6572   // always inser
+00023c30: 7420 6f62 6a65 6374 7320 6174 2074 6865  t objects at the
+00023c40: 2065 6e64 206f 6620 7468 6520 636f 6e74   end of the cont
+00023c50: 6578 7427 7320 6d65 6d6f 7279 2070 6f6f  ext's memory poo
+00023c60: 6c0a 2020 2020 7374 7275 6374 2067 676d  l.    struct ggm
+00023c70: 6c5f 6f62 6a65 6374 202a 206f 626a 5f63  l_object * obj_c
+00023c80: 7572 203d 2063 7478 2d3e 6f62 6a65 6374  ur = ctx->object
+00023c90: 735f 656e 643b 0a0a 2020 2020 636f 6e73  s_end;..    cons
+00023ca0: 7420 7369 7a65 5f74 2063 7572 5f6f 6666  t size_t cur_off
+00023cb0: 7320 3d20 6f62 6a5f 6375 7220 3d3d 204e  s = obj_cur == N
+00023cc0: 554c 4c20 3f20 3020 3a20 6f62 6a5f 6375  ULL ? 0 : obj_cu
+00023cd0: 722d 3e6f 6666 733b 0a20 2020 2063 6f6e  r->offs;.    con
+00023ce0: 7374 2073 697a 655f 7420 6375 725f 7369  st size_t cur_si
+00023cf0: 7a65 203d 206f 626a 5f63 7572 203d 3d20  ze = obj_cur == 
+00023d00: 4e55 4c4c 203f 2030 203a 206f 626a 5f63  NULL ? 0 : obj_c
+00023d10: 7572 2d3e 7369 7a65 3b0a 2020 2020 636f  ur->size;.    co
+00023d20: 6e73 7420 7369 7a65 5f74 2063 7572 5f65  nst size_t cur_e
+00023d30: 6e64 2020 3d20 6375 725f 6f66 6673 202b  nd  = cur_offs +
+00023d40: 2063 7572 5f73 697a 653b 0a0a 2020 2020   cur_size;..    
+00023d50: 7369 7a65 5f74 2073 697a 655f 6e65 6564  size_t size_need
+00023d60: 6564 203d 2030 3b0a 0a20 2020 2069 6620  ed = 0;..    if 
+00023d70: 2864 6174 6120 3d3d 204e 554c 4c20 2626  (data == NULL &&
+00023d80: 2021 6374 782d 3e6e 6f5f 616c 6c6f 6329   !ctx->no_alloc)
+00023d90: 207b 0a20 2020 2020 2020 2073 697a 655f   {.        size_
+00023da0: 6e65 6564 6564 202b 3d20 4747 4d4c 5f54  needed += GGML_T
+00023db0: 5950 455f 5349 5a45 5b74 7970 655d 2a28  YPE_SIZE[type]*(
+00023dc0: 6e65 5b30 5d2f 4747 4d4c 5f42 4c43 4b5f  ne[0]/GGML_BLCK_
+00023dd0: 5349 5a45 5b74 7970 655d 293b 0a20 2020  SIZE[type]);.   
+00023de0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00023df0: 3d20 313b 2069 203c 206e 5f64 696d 733b  = 1; i < n_dims;
+00023e00: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+00023e10: 2020 2020 7369 7a65 5f6e 6565 6465 6420      size_needed 
+00023e20: 2a3d 206e 655b 695d 3b0a 2020 2020 2020  *= ne[i];.      
+00023e30: 2020 7d0a 2020 2020 2020 2020 2f2f 2061    }.        // a
+00023e40: 6c69 676e 2074 6f20 4747 4d4c 5f4d 454d  lign to GGML_MEM
+00023e50: 5f41 4c49 474e 0a20 2020 2020 2020 2073  _ALIGN.        s
+00023e60: 697a 655f 6e65 6564 6564 203d 2028 2873  ize_needed = ((s
+00023e70: 697a 655f 6e65 6564 6564 202b 2047 474d  ize_needed + GGM
+00023e80: 4c5f 4d45 4d5f 414c 4947 4e20 2d20 3129  L_MEM_ALIGN - 1)
+00023e90: 2f47 474d 4c5f 4d45 4d5f 414c 4947 4e29  /GGML_MEM_ALIGN)
+00023ea0: 2a47 474d 4c5f 4d45 4d5f 414c 4947 4e3b  *GGML_MEM_ALIGN;
+00023eb0: 0a20 2020 207d 0a0a 2020 2020 6368 6172  .    }..    char
+00023ec0: 202a 2063 6f6e 7374 206d 656d 5f62 7566   * const mem_buf
+00023ed0: 6665 7220 3d20 6374 782d 3e6d 656d 5f62  fer = ctx->mem_b
+00023ee0: 7566 6665 723b 0a20 2020 2073 7472 7563  uffer;.    struc
+00023ef0: 7420 6767 6d6c 5f6f 626a 6563 7420 2a20  t ggml_object * 
+00023f00: 636f 6e73 7420 6f62 6a5f 6e65 7720 3d20  const obj_new = 
+00023f10: 2873 7472 7563 7420 6767 6d6c 5f6f 626a  (struct ggml_obj
+00023f20: 6563 7420 2a29 286d 656d 5f62 7566 6665  ect *)(mem_buffe
+00023f30: 7220 2b20 6375 725f 656e 6429 3b0a 0a20  r + cur_end);.. 
+00023f40: 2020 2069 6620 2863 7478 2d3e 7363 7261     if (ctx->scra
+00023f50: 7463 682e 6461 7461 203d 3d20 4e55 4c4c  tch.data == NULL
+00023f60: 207c 7c20 6461 7461 2021 3d20 4e55 4c4c   || data != NULL
+00023f70: 2920 7b0a 2020 2020 2020 2020 7369 7a65  ) {.        size
+00023f80: 5f6e 6565 6465 6420 2b3d 2047 474d 4c5f  _needed += GGML_
+00023f90: 5445 4e53 4f52 5f53 495a 453b 0a0a 2020  TENSOR_SIZE;..  
+00023fa0: 2020 2020 2020 6966 2028 6375 725f 656e        if (cur_en
+00023fb0: 6420 2b20 7369 7a65 5f6e 6565 6465 6420  d + size_needed 
+00023fc0: 2b20 4747 4d4c 5f4f 424a 4543 545f 5349  + GGML_OBJECT_SI
+00023fd0: 5a45 203e 2063 7478 2d3e 6d65 6d5f 7369  ZE > ctx->mem_si
+00023fe0: 7a65 2920 7b0a 2020 2020 2020 2020 2020  ze) {.          
+00023ff0: 2020 4747 4d4c 5f50 5249 4e54 2822 2573    GGML_PRINT("%s
+00024000: 3a20 6e6f 7420 656e 6f75 6768 2073 7061  : not enough spa
+00024010: 6365 2069 6e20 7468 6520 636f 6e74 6578  ce in the contex
+00024020: 7427 7320 6d65 6d6f 7279 2070 6f6f 6c20  t's memory pool 
+00024030: 286e 6565 6465 6420 257a 752c 2061 7661  (needed %zu, ava
+00024040: 696c 6162 6c65 2025 7a75 295c 6e22 2c0a  ilable %zu)\n",.
+00024050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024060: 2020 2020 5f5f 6675 6e63 5f5f 2c20 6375      __func__, cu
+00024070: 725f 656e 6420 2b20 7369 7a65 5f6e 6565  r_end + size_nee
+00024080: 6465 6420 2b20 4747 4d4c 5f4f 424a 4543  ded + GGML_OBJEC
+00024090: 545f 5349 5a45 2c20 6374 782d 3e6d 656d  T_SIZE, ctx->mem
+000240a0: 5f73 697a 6529 3b0a 2020 2020 2020 2020  _size);.        
+000240b0: 2020 2020 6173 7365 7274 2866 616c 7365      assert(false
+000240c0: 293b 0a20 2020 2020 2020 2020 2020 2072  );.            r
+000240d0: 6574 7572 6e20 4e55 4c4c 3b0a 2020 2020  eturn NULL;.    
+000240e0: 2020 2020 7d0a 0a20 2020 2020 2020 202a      }..        *
+000240f0: 6f62 6a5f 6e65 7720 3d20 2873 7472 7563  obj_new = (struc
+00024100: 7420 6767 6d6c 5f6f 626a 6563 7429 207b  t ggml_object) {
+00024110: 0a20 2020 2020 2020 2020 2020 202e 6f66  .            .of
+00024120: 6673 203d 2063 7572 5f65 6e64 202b 2047  fs = cur_end + G
+00024130: 474d 4c5f 4f42 4a45 4354 5f53 495a 452c  GML_OBJECT_SIZE,
+00024140: 0a20 2020 2020 2020 2020 2020 202e 7369  .            .si
+00024150: 7a65 203d 2073 697a 655f 6e65 6564 6564  ze = size_needed
+00024160: 2c0a 2020 2020 2020 2020 2020 2020 2e6e  ,.            .n
+00024170: 6578 7420 3d20 4e55 4c4c 2c0a 2020 2020  ext = NULL,.    
+00024180: 2020 2020 7d3b 0a20 2020 207d 2065 6c73      };.    } els
+00024190: 6520 7b0a 2020 2020 2020 2020 6966 2028  e {.        if (
+000241a0: 6374 782d 3e73 6372 6174 6368 2e6f 6666  ctx->scratch.off
+000241b0: 7320 2b20 7369 7a65 5f6e 6565 6465 6420  s + size_needed 
+000241c0: 3e20 6374 782d 3e73 6372 6174 6368 2e73  > ctx->scratch.s
+000241d0: 697a 6529 207b 0a20 2020 2020 2020 2020  ize) {.         
+000241e0: 2020 2047 474d 4c5f 5052 494e 5428 2225     GGML_PRINT("%
+000241f0: 733a 206e 6f74 2065 6e6f 7567 6820 7370  s: not enough sp
+00024200: 6163 6520 696e 2074 6865 2073 6372 6174  ace in the scrat
+00024210: 6368 206d 656d 6f72 7920 706f 6f6c 2028  ch memory pool (
+00024220: 6e65 6564 6564 2025 7a75 2c20 6176 6169  needed %zu, avai
+00024230: 6c61 626c 6520 257a 7529 5c6e 222c 0a20  lable %zu)\n",. 
+00024240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024250: 2020 205f 5f66 756e 635f 5f2c 2063 7478     __func__, ctx
+00024260: 2d3e 7363 7261 7463 682e 6f66 6673 202b  ->scratch.offs +
+00024270: 2073 697a 655f 6e65 6564 6564 2c20 6374   size_needed, ct
+00024280: 782d 3e73 6372 6174 6368 2e73 697a 6529  x->scratch.size)
+00024290: 3b0a 2020 2020 2020 2020 2020 2020 6173  ;.            as
+000242a0: 7365 7274 2866 616c 7365 293b 0a20 2020  sert(false);.   
+000242b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000242c0: 4e55 4c4c 3b0a 2020 2020 2020 2020 7d0a  NULL;.        }.
+000242d0: 0a20 2020 2020 2020 2069 6620 2863 7572  .        if (cur
+000242e0: 5f65 6e64 202b 2047 474d 4c5f 5445 4e53  _end + GGML_TENS
+000242f0: 4f52 5f53 495a 4520 2b20 4747 4d4c 5f4f  OR_SIZE + GGML_O
+00024300: 424a 4543 545f 5349 5a45 203e 2063 7478  BJECT_SIZE > ctx
+00024310: 2d3e 6d65 6d5f 7369 7a65 2920 7b0a 2020  ->mem_size) {.  
+00024320: 2020 2020 2020 2020 2020 4747 4d4c 5f50            GGML_P
+00024330: 5249 4e54 2822 2573 3a20 6e6f 7420 656e  RINT("%s: not en
+00024340: 6f75 6768 2073 7061 6365 2069 6e20 7468  ough space in th
+00024350: 6520 636f 6e74 6578 7427 7320 6d65 6d6f  e context's memo
+00024360: 7279 2070 6f6f 6c20 286e 6565 6465 6420  ry pool (needed 
+00024370: 257a 752c 2061 7661 696c 6162 6c65 2025  %zu, available %
+00024380: 7a75 295c 6e22 2c0a 2020 2020 2020 2020  zu)\n",.        
+00024390: 2020 2020 2020 2020 2020 2020 5f5f 6675              __fu
+000243a0: 6e63 5f5f 2c20 6375 725f 656e 6420 2b20  nc__, cur_end + 
+000243b0: 4747 4d4c 5f54 454e 534f 525f 5349 5a45  GGML_TENSOR_SIZE
+000243c0: 202b 2047 474d 4c5f 4f42 4a45 4354 5f53   + GGML_OBJECT_S
+000243d0: 495a 452c 2063 7478 2d3e 6d65 6d5f 7369  IZE, ctx->mem_si
+000243e0: 7a65 293b 0a20 2020 2020 2020 2020 2020  ze);.           
+000243f0: 2061 7373 6572 7428 6661 6c73 6529 3b0a   assert(false);.
+00024400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00024410: 726e 204e 554c 4c3b 0a20 2020 2020 2020  rn NULL;.       
+00024420: 207d 0a0a 2020 2020 2020 2020 6461 7461   }..        data
+00024430: 203d 2028 6368 6172 202a 2063 6f6e 7374   = (char * const
+00024440: 2920 6374 782d 3e73 6372 6174 6368 2e64  ) ctx->scratch.d
+00024450: 6174 6120 2b20 6374 782d 3e73 6372 6174  ata + ctx->scrat
+00024460: 6368 2e6f 6666 733b 0a0a 2020 2020 2020  ch.offs;..      
+00024470: 2020 2a6f 626a 5f6e 6577 203d 2028 7374    *obj_new = (st
+00024480: 7275 6374 2067 676d 6c5f 6f62 6a65 6374  ruct ggml_object
+00024490: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000244a0: 2e6f 6666 7320 3d20 6375 725f 656e 6420  .offs = cur_end 
+000244b0: 2b20 4747 4d4c 5f4f 424a 4543 545f 5349  + GGML_OBJECT_SI
+000244c0: 5a45 2c0a 2020 2020 2020 2020 2020 2020  ZE,.            
+000244d0: 2e73 697a 6520 3d20 4747 4d4c 5f54 454e  .size = GGML_TEN
+000244e0: 534f 525f 5349 5a45 2c0a 2020 2020 2020  SOR_SIZE,.      
+000244f0: 2020 2020 2020 2e6e 6578 7420 3d20 4e55        .next = NU
+00024500: 4c4c 2c0a 2020 2020 2020 2020 7d3b 0a0a  LL,.        };..
+00024510: 2020 2020 2020 2020 2f2f 7072 696e 7466          //printf
+00024520: 2822 7363 7261 7463 6820 6f66 6673 203d  ("scratch offs =
+00024530: 2025 7a75 2c20 7369 7a65 5f6e 6565 6465   %zu, size_neede
+00024540: 6420 3d20 257a 755c 6e22 2c20 6374 782d  d = %zu\n", ctx-
+00024550: 3e73 6372 6174 6368 2e6f 6666 732c 2073  >scratch.offs, s
+00024560: 697a 655f 6e65 6564 6564 293b 0a0a 2020  ize_needed);..  
+00024570: 2020 2020 2020 6374 782d 3e73 6372 6174        ctx->scrat
+00024580: 6368 2e6f 6666 7320 2b3d 2073 697a 655f  ch.offs += size_
+00024590: 6e65 6564 6564 3b0a 2020 2020 7d0a 0a20  needed;.    }.. 
+000245a0: 2020 2069 6620 286f 626a 5f63 7572 2021     if (obj_cur !
+000245b0: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
+000245c0: 2020 6f62 6a5f 6375 722d 3e6e 6578 7420    obj_cur->next 
+000245d0: 3d20 6f62 6a5f 6e65 773b 0a20 2020 207d  = obj_new;.    }
+000245e0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+000245f0: 2f2f 2074 6869 7320 6973 2074 6865 2066  // this is the f
+00024600: 6972 7374 206f 626a 6563 7420 696e 2074  irst object in t
+00024610: 6869 7320 636f 6e74 6578 740a 2020 2020  his context.    
+00024620: 2020 2020 6374 782d 3e6f 626a 6563 7473      ctx->objects
+00024630: 5f62 6567 696e 203d 206f 626a 5f6e 6577  _begin = obj_new
+00024640: 3b0a 2020 2020 7d0a 0a20 2020 2063 7478  ;.    }..    ctx
+00024650: 2d3e 6f62 6a65 6374 735f 656e 6420 3d20  ->objects_end = 
+00024660: 6f62 6a5f 6e65 773b 0a0a 2020 2020 2f2f  obj_new;..    //
+00024670: 7072 696e 7466 2822 2573 3a20 696e 7365  printf("%s: inse
+00024680: 7274 6564 206e 6577 206f 626a 6563 7420  rted new object 
+00024690: 6174 2025 7a75 2c20 7369 7a65 203d 2025  at %zu, size = %
+000246a0: 7a75 5c6e 222c 205f 5f66 756e 635f 5f2c  zu\n", __func__,
+000246b0: 2063 7572 5f65 6e64 2c20 6f62 6a5f 6e65   cur_end, obj_ne
+000246c0: 772d 3e73 697a 6529 3b0a 0a20 2020 2073  w->size);..    s
+000246d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000246e0: 7220 2a20 636f 6e73 7420 7265 7375 6c74  r * const result
+000246f0: 203d 2028 7374 7275 6374 2067 676d 6c5f   = (struct ggml_
+00024700: 7465 6e73 6f72 202a 2928 6d65 6d5f 6275  tensor *)(mem_bu
+00024710: 6666 6572 202b 206f 626a 5f6e 6577 2d3e  ffer + obj_new->
+00024720: 6f66 6673 293b 0a0a 2020 2020 6767 6d6c  offs);..    ggml
+00024730: 5f61 7373 6572 745f 616c 6967 6e65 6428  _assert_aligned(
+00024740: 7265 7375 6c74 293b 0a0a 2020 2020 2a72  result);..    *r
+00024750: 6573 756c 7420 3d20 2873 7472 7563 7420  esult = (struct 
+00024760: 6767 6d6c 5f74 656e 736f 7229 207b 0a20  ggml_tensor) {. 
+00024770: 2020 2020 2020 202f 2a2e 7479 7065 2020         /*.type  
+00024780: 2020 2020 2020 203d 2a2f 2074 7970 652c         =*/ type,
+00024790: 0a20 2020 2020 2020 202f 2a2e 6261 636b  .        /*.back
+000247a0: 656e 6420 2020 2020 203d 2a2f 2047 474d  end      =*/ GGM
+000247b0: 4c5f 4241 434b 454e 445f 4350 552c 0a20  L_BACKEND_CPU,. 
+000247c0: 2020 2020 2020 202f 2a2e 6e5f 6469 6d73         /*.n_dims
+000247d0: 2020 2020 2020 203d 2a2f 206e 5f64 696d         =*/ n_dim
+000247e0: 732c 0a20 2020 2020 2020 202f 2a2e 6e65  s,.        /*.ne
+000247f0: 2020 2020 2020 2020 2020 203d 2a2f 207b             =*/ {
+00024800: 2031 2c20 312c 2031 2c20 3120 7d2c 0a20   1, 1, 1, 1 },. 
+00024810: 2020 2020 2020 202f 2a2e 6e62 2020 2020         /*.nb    
+00024820: 2020 2020 2020 203d 2a2f 207b 2030 2c20         =*/ { 0, 
+00024830: 302c 2030 2c20 3020 7d2c 0a20 2020 2020  0, 0, 0 },.     
+00024840: 2020 202f 2a2e 6f70 2020 2020 2020 2020     /*.op        
+00024850: 2020 203d 2a2f 2047 474d 4c5f 4f50 5f4e     =*/ GGML_OP_N
+00024860: 4f4e 452c 0a20 2020 2020 2020 202f 2a2e  ONE,.        /*.
+00024870: 6973 5f70 6172 616d 2020 2020 203d 2a2f  is_param     =*/
+00024880: 2066 616c 7365 2c0a 2020 2020 2020 2020   false,.        
+00024890: 2f2a 2e67 7261 6420 2020 2020 2020 2020  /*.grad         
+000248a0: 3d2a 2f20 4e55 4c4c 2c0a 2020 2020 2020  =*/ NULL,.      
+000248b0: 2020 2f2a 2e73 7263 3020 2020 2020 2020    /*.src0       
+000248c0: 2020 3d2a 2f20 4e55 4c4c 2c0a 2020 2020    =*/ NULL,.    
+000248d0: 2020 2020 2f2a 2e73 7263 3120 2020 2020      /*.src1     
+000248e0: 2020 2020 3d2a 2f20 4e55 4c4c 2c0a 2020      =*/ NULL,.  
+000248f0: 2020 2020 2020 2f2a 2e6f 7074 2020 2020        /*.opt    
+00024900: 2020 2020 2020 3d2a 2f20 7b20 4e55 4c4c        =*/ { NULL
+00024910: 207d 2c0a 2020 2020 2020 2020 2f2a 2e6e   },.        /*.n
+00024920: 5f74 6173 6b73 2020 2020 2020 3d2a 2f20  _tasks      =*/ 
+00024930: 302c 0a20 2020 2020 2020 202f 2a2e 7065  0,.        /*.pe
+00024940: 7266 5f72 756e 7320 2020 203d 2a2f 2030  rf_runs    =*/ 0
+00024950: 2c0a 2020 2020 2020 2020 2f2a 2e70 6572  ,.        /*.per
+00024960: 665f 6379 636c 6573 2020 3d2a 2f20 302c  f_cycles  =*/ 0,
+00024970: 0a20 2020 2020 2020 202f 2a2e 7065 7266  .        /*.perf
+00024980: 5f74 696d 655f 7573 203d 2a2f 2030 2c0a  _time_us =*/ 0,.
+00024990: 2020 2020 2020 2020 2f2a 2e64 6174 6120          /*.data 
+000249a0: 2020 2020 2020 2020 3d2a 2f20 2864 6174          =*/ (dat
+000249b0: 6120 3d3d 204e 554c 4c20 2626 2021 6374  a == NULL && !ct
+000249c0: 782d 3e6e 6f5f 616c 6c6f 6329 203f 2028  x->no_alloc) ? (
+000249d0: 766f 6964 202a 2928 7265 7375 6c74 202b  void *)(result +
+000249e0: 2031 2920 3a20 6461 7461 2c0a 2020 2020   1) : data,.    
+000249f0: 2020 2020 2f2a 2e6e 616d 6520 2020 2020      /*.name     
+00024a00: 2020 2020 3d2a 2f20 7b20 3020 7d2c 0a20      =*/ { 0 },. 
+00024a10: 2020 2020 2020 202f 2a2e 6578 7472 6120         /*.extra 
+00024a20: 2020 2020 2020 203d 2a2f 204e 554c 4c2c         =*/ NULL,
+00024a30: 0a20 2020 2020 2020 202f 2a2e 7061 6420  .        /*.pad 
+00024a40: 2020 2020 2020 2020 203d 2a2f 207b 2030           =*/ { 0
+00024a50: 207d 2c0a 2020 2020 7d3b 0a0a 2020 2020   },.    };..    
+00024a60: 2f2f 2054 4f44 4f3a 2074 6869 7320 7368  // TODO: this sh
+00024a70: 6f75 6c64 206e 6f74 2062 6520 6e65 6564  ould not be need
+00024a80: 6564 2061 7320 6c6f 6e67 2061 7320 7765  ed as long as we
+00024a90: 2064 6f6e 2774 2072 656c 7920 6f6e 2061   don't rely on a
+00024aa0: 6c69 676e 6564 2053 494d 4420 6c6f 6164  ligned SIMD load
+00024ab0: 730a 2020 2020 2f2f 6767 6d6c 5f61 7373  s.    //ggml_ass
+00024ac0: 6572 745f 616c 6967 6e65 6428 7265 7375  ert_aligned(resu
+00024ad0: 6c74 2d3e 6461 7461 293b 0a0a 2020 2020  lt->data);..    
+00024ae0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+00024af0: 6920 3c20 6e5f 6469 6d73 3b20 692b 2b29  i < n_dims; i++)
+00024b00: 207b 0a20 2020 2020 2020 2072 6573 756c   {.        resul
+00024b10: 742d 3e6e 655b 695d 203d 206e 655b 695d  t->ne[i] = ne[i]
+00024b20: 3b0a 2020 2020 7d0a 0a20 2020 2072 6573  ;.    }..    res
+00024b30: 756c 742d 3e6e 625b 305d 203d 2047 474d  ult->nb[0] = GGM
+00024b40: 4c5f 5459 5045 5f53 495a 455b 7479 7065  L_TYPE_SIZE[type
+00024b50: 5d3b 0a20 2020 2072 6573 756c 742d 3e6e  ];.    result->n
+00024b60: 625b 315d 203d 2072 6573 756c 742d 3e6e  b[1] = result->n
+00024b70: 625b 305d 2a28 7265 7375 6c74 2d3e 6e65  b[0]*(result->ne
+00024b80: 5b30 5d2f 4747 4d4c 5f42 4c43 4b5f 5349  [0]/GGML_BLCK_SI
+00024b90: 5a45 5b74 7970 655d 293b 0a20 2020 2066  ZE[type]);.    f
+00024ba0: 6f72 2028 696e 7420 6920 3d20 323b 2069  or (int i = 2; i
+00024bb0: 203c 2047 474d 4c5f 4d41 585f 4449 4d53   < GGML_MAX_DIMS
+00024bc0: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+00024bd0: 2072 6573 756c 742d 3e6e 625b 695d 203d   result->nb[i] =
+00024be0: 2072 6573 756c 742d 3e6e 625b 6920 2d20   result->nb[i - 
+00024bf0: 315d 2a72 6573 756c 742d 3e6e 655b 6920  1]*result->ne[i 
+00024c00: 2d20 315d 3b0a 2020 2020 7d0a 0a20 2020  - 1];.    }..   
+00024c10: 2063 7478 2d3e 6e5f 6f62 6a65 6374 732b   ctx->n_objects+
+00024c20: 2b3b 0a0a 2020 2020 7265 7475 726e 2072  +;..    return r
+00024c30: 6573 756c 743b 0a7d 0a0a 7374 7275 6374  esult;.}..struct
+00024c40: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+00024c50: 676d 6c5f 6e65 775f 7465 6e73 6f72 280a  gml_new_tensor(.
+00024c60: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00024c70: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00024c80: 782c 0a20 2020 2020 2020 2065 6e75 6d20  x,.        enum 
+00024c90: 2020 6767 6d6c 5f74 7970 6520 7479 7065    ggml_type type
+00024ca0: 2c0a 2020 2020 2020 2020 696e 7420 2020  ,.        int   
+00024cb0: 206e 5f64 696d 732c 0a20 2020 2020 2020   n_dims,.       
+00024cc0: 2063 6f6e 7374 2069 6e74 3634 5f74 202a   const int64_t *
+00024cd0: 206e 6529 207b 0a20 2020 2072 6574 7572   ne) {.    retur
+00024ce0: 6e20 6767 6d6c 5f6e 6577 5f74 656e 736f  n ggml_new_tenso
+00024cf0: 725f 696d 706c 2863 7478 2c20 7479 7065  r_impl(ctx, type
+00024d00: 2c20 6e5f 6469 6d73 2c20 6e65 2c20 4e55  , n_dims, ne, NU
+00024d10: 4c4c 293b 0a7d 0a0a 7374 7275 6374 2067  LL);.}..struct g
+00024d20: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+00024d30: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
+00024d40: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00024d50: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+00024d60: 7478 2c0a 2020 2020 2020 2020 656e 756d  tx,.        enum
+00024d70: 2020 2067 676d 6c5f 7479 7065 2074 7970     ggml_type typ
+00024d80: 652c 0a20 2020 2020 2020 2069 6e74 3634  e,.        int64
+00024d90: 5f74 206e 6530 2920 7b0a 2020 2020 7265  _t ne0) {.    re
+00024da0: 7475 726e 2067 676d 6c5f 6e65 775f 7465  turn ggml_new_te
+00024db0: 6e73 6f72 2863 7478 2c20 7479 7065 2c20  nsor(ctx, type, 
+00024dc0: 312c 2026 6e65 3029 3b0a 7d0a 0a73 7472  1, &ne0);.}..str
+00024dd0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00024de0: 2a20 6767 6d6c 5f6e 6577 5f74 656e 736f  * ggml_new_tenso
+00024df0: 725f 3264 280a 2020 2020 2020 2020 7374  r_2d(.        st
+00024e00: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+00024e10: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+00024e20: 2065 6e75 6d20 2020 6767 6d6c 5f74 7970   enum   ggml_typ
+00024e30: 6520 7479 7065 2c0a 2020 2020 2020 2020  e type,.        
+00024e40: 696e 7436 345f 7420 6e65 302c 0a20 2020  int64_t ne0,.   
+00024e50: 2020 2020 2069 6e74 3634 5f74 206e 6531       int64_t ne1
+00024e60: 2920 7b0a 2020 2020 636f 6e73 7420 696e  ) {.    const in
+00024e70: 7436 345f 7420 6e65 5b32 5d20 3d20 7b20  t64_t ne[2] = { 
+00024e80: 6e65 302c 206e 6531 207d 3b0a 2020 2020  ne0, ne1 };.    
+00024e90: 7265 7475 726e 2067 676d 6c5f 6e65 775f  return ggml_new_
+00024ea0: 7465 6e73 6f72 2863 7478 2c20 7479 7065  tensor(ctx, type
+00024eb0: 2c20 322c 206e 6529 3b0a 7d0a 0a73 7472  , 2, ne);.}..str
+00024ec0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00024ed0: 2a20 6767 6d6c 5f6e 6577 5f74 656e 736f  * ggml_new_tenso
+00024ee0: 725f 3364 280a 2020 2020 2020 2020 7374  r_3d(.        st
+00024ef0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+00024f00: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+00024f10: 2065 6e75 6d20 2020 6767 6d6c 5f74 7970   enum   ggml_typ
+00024f20: 6520 7479 7065 2c0a 2020 2020 2020 2020  e type,.        
+00024f30: 696e 7436 345f 7420 6e65 302c 0a20 2020  int64_t ne0,.   
+00024f40: 2020 2020 2069 6e74 3634 5f74 206e 6531       int64_t ne1
+00024f50: 2c0a 2020 2020 2020 2020 696e 7436 345f  ,.        int64_
+00024f60: 7420 6e65 3229 207b 0a20 2020 2063 6f6e  t ne2) {.    con
+00024f70: 7374 2069 6e74 3634 5f74 206e 655b 335d  st int64_t ne[3]
+00024f80: 203d 207b 206e 6530 2c20 6e65 312c 206e   = { ne0, ne1, n
+00024f90: 6532 207d 3b0a 2020 2020 7265 7475 726e  e2 };.    return
+00024fa0: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+00024fb0: 2863 7478 2c20 7479 7065 2c20 332c 206e  (ctx, type, 3, n
+00024fc0: 6529 3b0a 7d0a 0a73 7472 7563 7420 6767  e);.}..struct gg
+00024fd0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+00024fe0: 5f6e 6577 5f74 656e 736f 725f 3464 280a  _new_tensor_4d(.
+00024ff0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00025000: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00025010: 782c 0a20 2020 2020 2020 2065 6e75 6d20  x,.        enum 
+00025020: 2020 6767 6d6c 5f74 7970 6520 7479 7065    ggml_type type
+00025030: 2c0a 2020 2020 2020 2020 696e 7436 345f  ,.        int64_
+00025040: 7420 6e65 302c 0a20 2020 2020 2020 2069  t ne0,.        i
+00025050: 6e74 3634 5f74 206e 6531 2c0a 2020 2020  nt64_t ne1,.    
+00025060: 2020 2020 696e 7436 345f 7420 6e65 322c      int64_t ne2,
+00025070: 0a20 2020 2020 2020 2069 6e74 3634 5f74  .        int64_t
+00025080: 206e 6533 2920 7b0a 2020 2020 636f 6e73   ne3) {.    cons
+00025090: 7420 696e 7436 345f 7420 6e65 5b34 5d20  t int64_t ne[4] 
+000250a0: 3d20 7b20 6e65 302c 206e 6531 2c20 6e65  = { ne0, ne1, ne
+000250b0: 322c 206e 6533 207d 3b0a 2020 2020 7265  2, ne3 };.    re
+000250c0: 7475 726e 2067 676d 6c5f 6e65 775f 7465  turn ggml_new_te
+000250d0: 6e73 6f72 2863 7478 2c20 7479 7065 2c20  nsor(ctx, type, 
+000250e0: 342c 206e 6529 3b0a 7d0a 0a73 7472 7563  4, ne);.}..struc
+000250f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00025100: 6767 6d6c 5f6e 6577 5f69 3332 2873 7472  ggml_new_i32(str
+00025110: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00025120: 202a 2063 7478 2c20 696e 7433 325f 7420   * ctx, int32_t 
+00025130: 7661 6c75 6529 207b 0a20 2020 2067 676d  value) {.    ggm
+00025140: 6c5f 7363 7261 7463 685f 7361 7665 2863  l_scratch_save(c
+00025150: 7478 293b 0a0a 2020 2020 7374 7275 6374  tx);..    struct
+00025160: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
+00025170: 6573 756c 7420 3d20 6767 6d6c 5f6e 6577  esult = ggml_new
+00025180: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
+00025190: 4747 4d4c 5f54 5950 455f 4933 322c 2031  GGML_TYPE_I32, 1
+000251a0: 293b 0a0a 2020 2020 6767 6d6c 5f73 6372  );..    ggml_scr
+000251b0: 6174 6368 5f6c 6f61 6428 6374 7829 3b0a  atch_load(ctx);.
+000251c0: 0a20 2020 2067 676d 6c5f 7365 745f 6933  .    ggml_set_i3
+000251d0: 3228 7265 7375 6c74 2c20 7661 6c75 6529  2(result, value)
+000251e0: 3b0a 0a20 2020 2072 6574 7572 6e20 7265  ;..    return re
+000251f0: 7375 6c74 3b0a 7d0a 0a73 7472 7563 7420  sult;.}..struct 
+00025200: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+00025210: 6d6c 5f6e 6577 5f66 3332 2873 7472 7563  ml_new_f32(struc
+00025220: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+00025230: 2063 7478 2c20 666c 6f61 7420 7661 6c75   ctx, float valu
+00025240: 6529 207b 0a20 2020 2067 676d 6c5f 7363  e) {.    ggml_sc
+00025250: 7261 7463 685f 7361 7665 2863 7478 293b  ratch_save(ctx);
+00025260: 0a0a 2020 2020 7374 7275 6374 2067 676d  ..    struct ggm
+00025270: 6c5f 7465 6e73 6f72 202a 2072 6573 756c  l_tensor * resul
+00025280: 7420 3d20 6767 6d6c 5f6e 6577 5f74 656e  t = ggml_new_ten
+00025290: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
+000252a0: 5f54 5950 455f 4633 322c 2031 293b 0a0a  _TYPE_F32, 1);..
+000252b0: 2020 2020 6767 6d6c 5f73 6372 6174 6368      ggml_scratch
+000252c0: 5f6c 6f61 6428 6374 7829 3b0a 0a20 2020  _load(ctx);..   
+000252d0: 2067 676d 6c5f 7365 745f 6633 3228 7265   ggml_set_f32(re
+000252e0: 7375 6c74 2c20 7661 6c75 6529 3b0a 0a20  sult, value);.. 
+000252f0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00025300: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+00025310: 5f74 656e 736f 7220 2a20 6767 6d6c 5f64  _tensor * ggml_d
+00025320: 7570 5f74 656e 736f 7228 7374 7275 6374  up_tensor(struct
+00025330: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00025340: 6374 782c 2063 6f6e 7374 2073 7472 7563  ctx, const struc
+00025350: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00025360: 7372 6329 207b 0a20 2020 2072 6574 7572  src) {.    retur
+00025370: 6e20 6767 6d6c 5f6e 6577 5f74 656e 736f  n ggml_new_tenso
+00025380: 725f 696d 706c 2863 7478 2c20 7372 632d  r_impl(ctx, src-
+00025390: 3e74 7970 652c 2073 7263 2d3e 6e5f 6469  >type, src->n_di
+000253a0: 6d73 2c20 7372 632d 3e6e 652c 204e 554c  ms, src->ne, NUL
+000253b0: 4c29 3b0a 7d0a 0a73 7472 7563 7420 6767  L);.}..struct gg
+000253c0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+000253d0: 5f73 6574 5f7a 6572 6f28 7374 7275 6374  _set_zero(struct
+000253e0: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
+000253f0: 656e 736f 7229 207b 0a20 2020 206d 656d  ensor) {.    mem
+00025400: 7365 7428 7465 6e73 6f72 2d3e 6461 7461  set(tensor->data
+00025410: 2c20 302c 2067 676d 6c5f 6e62 7974 6573  , 0, ggml_nbytes
+00025420: 2874 656e 736f 7229 293b 0a20 2020 2072  (tensor));.    r
+00025430: 6574 7572 6e20 7465 6e73 6f72 3b0a 7d0a  eturn tensor;.}.
+00025440: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+00025450: 736f 7220 2a20 6767 6d6c 5f73 6574 5f69  sor * ggml_set_i
+00025460: 3332 2028 7374 7275 6374 2067 676d 6c5f  32 (struct ggml_
+00025470: 7465 6e73 6f72 202a 2074 656e 736f 722c  tensor * tensor,
+00025480: 2069 6e74 3332 5f74 2076 616c 7565 2920   int32_t value) 
+00025490: 7b0a 2020 2020 636f 6e73 7420 696e 7420  {.    const int 
+000254a0: 6e20 2020 2020 3d20 6767 6d6c 5f6e 726f  n     = ggml_nro
+000254b0: 7773 2874 656e 736f 7229 3b0a 2020 2020  ws(tensor);.    
+000254c0: 636f 6e73 7420 696e 7420 6e63 2020 2020  const int nc    
+000254d0: 3d20 7465 6e73 6f72 2d3e 6e65 5b30 5d3b  = tensor->ne[0];
+000254e0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+000254f0: 7420 6e31 203d 2074 656e 736f 722d 3e6e  t n1 = tensor->n
+00025500: 625b 315d 3b0a 0a20 2020 2063 6861 7220  b[1];..    char 
+00025510: 2a20 636f 6e73 7420 6461 7461 203d 2074  * const data = t
+00025520: 656e 736f 722d 3e64 6174 613b 0a0a 2020  ensor->data;..  
+00025530: 2020 7377 6974 6368 2028 7465 6e73 6f72    switch (tensor
+00025540: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+00025550: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00025560: 5f49 383a 0a20 2020 2020 2020 2020 2020  _I8:.           
+00025570: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00025580: 2020 2061 7373 6572 7428 7465 6e73 6f72     assert(tensor
+00025590: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+000255a0: 6628 696e 7438 5f74 2929 3b0a 2020 2020  f(int8_t));.    
+000255b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000255c0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+000255d0: 6e3b 2069 2b2b 2920 7b0a 2020 2020 2020  n; i++) {.      
+000255e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000255f0: 6d6c 5f76 6563 5f73 6574 5f69 3828 6e63  ml_vec_set_i8(nc
+00025600: 2c20 2869 6e74 385f 7420 2a29 2864 6174  , (int8_t *)(dat
+00025610: 6120 2b20 692a 6e31 292c 2076 616c 7565  a + i*n1), value
+00025620: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00025630: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00025640: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00025650: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00025660: 5f49 3136 3a0a 2020 2020 2020 2020 2020  _I16:.          
+00025670: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00025680: 2020 2020 6173 7365 7274 2874 656e 736f      assert(tenso
+00025690: 722d 3e6e 625b 305d 203d 3d20 7369 7a65  r->nb[0] == size
+000256a0: 6f66 2869 6e74 3136 5f74 2929 3b0a 2020  of(int16_t));.  
+000256b0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000256c0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+000256d0: 3c20 6e3b 2069 2b2b 2920 7b0a 2020 2020  < n; i++) {.    
+000256e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000256f0: 6767 6d6c 5f76 6563 5f73 6574 5f69 3136  ggml_vec_set_i16
+00025700: 286e 632c 2028 696e 7431 365f 7420 2a29  (nc, (int16_t *)
+00025710: 2864 6174 6120 2b20 692a 6e31 292c 2076  (data + i*n1), v
+00025720: 616c 7565 293b 0a20 2020 2020 2020 2020  alue);.         
+00025730: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00025740: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00025750: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00025760: 5459 5045 5f49 3332 3a0a 2020 2020 2020  TYPE_I32:.      
+00025770: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00025780: 2020 2020 2020 2020 6173 7365 7274 2874          assert(t
+00025790: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
+000257a0: 7369 7a65 6f66 2869 6e74 3332 5f74 2929  sizeof(int32_t))
+000257b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000257c0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+000257d0: 3b20 6920 3c20 6e3b 2069 2b2b 2920 7b0a  ; i < n; i++) {.
+000257e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000257f0: 2020 2020 6767 6d6c 5f76 6563 5f73 6574      ggml_vec_set
+00025800: 5f69 3332 286e 632c 2028 696e 7433 325f  _i32(nc, (int32_
+00025810: 7420 2a29 2864 6174 6120 2b20 692a 6e31  t *)(data + i*n1
+00025820: 292c 2076 616c 7565 293b 0a20 2020 2020  ), value);.     
+00025830: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00025840: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00025850: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00025860: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
+00025870: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00025880: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00025890: 7274 2874 656e 736f 722d 3e6e 625b 305d  rt(tensor->nb[0]
+000258a0: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
+000258b0: 6670 3136 5f74 2929 3b0a 2020 2020 2020  fp16_t));.      
+000258c0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+000258d0: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
+000258e0: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+000258f0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00025900: 5f76 6563 5f73 6574 5f66 3136 286e 632c  _vec_set_f16(nc,
+00025910: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+00025920: 2864 6174 6120 2b20 692a 6e31 292c 2076  (data + i*n1), v
+00025930: 616c 7565 293b 0a20 2020 2020 2020 2020  alue);.         
+00025940: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00025950: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00025960: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00025970: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00025980: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00025990: 2020 2020 2020 2020 6173 7365 7274 2874          assert(t
+000259a0: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
+000259b0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+000259c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000259d0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+000259e0: 6920 3c20 6e3b 2069 2b2b 2920 7b0a 2020  i < n; i++) {.  
+000259f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025a00: 2020 6767 6d6c 5f76 6563 5f73 6574 5f66    ggml_vec_set_f
+00025a10: 3332 286e 632c 2028 666c 6f61 7420 2a29  32(nc, (float *)
+00025a20: 2864 6174 6120 2b20 692a 6e31 292c 2076  (data + i*n1), v
+00025a30: 616c 7565 293b 0a20 2020 2020 2020 2020  alue);.         
+00025a40: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00025a50: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00025a60: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+00025a70: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00025a80: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00025a90: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+00025aa0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00025ab0: 7265 616b 3b0a 2020 2020 7d0a 0a20 2020  reak;.    }..   
+00025ac0: 2072 6574 7572 6e20 7465 6e73 6f72 3b0a   return tensor;.
+00025ad0: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
+00025ae0: 656e 736f 7220 2a20 6767 6d6c 5f73 6574  ensor * ggml_set
+00025af0: 5f66 3332 2873 7472 7563 7420 6767 6d6c  _f32(struct ggml
+00025b00: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
+00025b10: 2c20 666c 6f61 7420 7661 6c75 6529 207b  , float value) {
+00025b20: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00025b30: 2020 2020 203d 2067 676d 6c5f 6e72 6f77       = ggml_nrow
+00025b40: 7328 7465 6e73 6f72 293b 0a20 2020 2063  s(tensor);.    c
+00025b50: 6f6e 7374 2069 6e74 206e 6320 2020 203d  onst int nc    =
+00025b60: 2074 656e 736f 722d 3e6e 655b 305d 3b0a   tensor->ne[0];.
+00025b70: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00025b80: 206e 3120 3d20 7465 6e73 6f72 2d3e 6e62   n1 = tensor->nb
+00025b90: 5b31 5d3b 0a0a 2020 2020 6368 6172 202a  [1];..    char *
+00025ba0: 2063 6f6e 7374 2064 6174 6120 3d20 7465   const data = te
+00025bb0: 6e73 6f72 2d3e 6461 7461 3b0a 0a20 2020  nsor->data;..   
+00025bc0: 2073 7769 7463 6820 2874 656e 736f 722d   switch (tensor-
+00025bd0: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+00025be0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00025bf0: 4938 3a0a 2020 2020 2020 2020 2020 2020  I8:.            
+00025c00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00025c10: 2020 6173 7365 7274 2874 656e 736f 722d    assert(tensor-
+00025c20: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
+00025c30: 2869 6e74 385f 7429 293b 0a20 2020 2020  (int8_t));.     
+00025c40: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00025c50: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
+00025c60: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+00025c70: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00025c80: 6c5f 7665 635f 7365 745f 6938 286e 632c  l_vec_set_i8(nc,
+00025c90: 2028 696e 7438 5f74 202a 2928 6461 7461   (int8_t *)(data
+00025ca0: 202b 2069 2a6e 3129 2c20 7661 6c75 6529   + i*n1), value)
+00025cb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00025cc0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00025cd0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00025ce0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00025cf0: 4931 363a 0a20 2020 2020 2020 2020 2020  I16:.           
+00025d00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00025d10: 2020 2061 7373 6572 7428 7465 6e73 6f72     assert(tensor
+00025d20: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+00025d30: 6628 696e 7431 365f 7429 293b 0a20 2020  f(int16_t));.   
+00025d40: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00025d50: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00025d60: 206e 3b20 692b 2b29 207b 0a20 2020 2020   n; i++) {.     
+00025d70: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00025d80: 676d 6c5f 7665 635f 7365 745f 6931 3628  gml_vec_set_i16(
+00025d90: 6e63 2c20 2869 6e74 3136 5f74 202a 2928  nc, (int16_t *)(
+00025da0: 6461 7461 202b 2069 2a6e 3129 2c20 7661  data + i*n1), va
+00025db0: 6c75 6529 3b0a 2020 2020 2020 2020 2020  lue);.          
+00025dc0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00025dd0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00025de0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00025df0: 5950 455f 4933 323a 0a20 2020 2020 2020  YPE_I32:.       
+00025e00: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00025e10: 2020 2020 2020 2061 7373 6572 7428 7465         assert(te
+00025e20: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
+00025e30: 697a 656f 6628 696e 7433 325f 7429 293b  izeof(int32_t));
+00025e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025e50: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00025e60: 2069 203c 206e 3b20 692b 2b29 207b 0a20   i < n; i++) {. 
+00025e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025e80: 2020 2067 676d 6c5f 7665 635f 7365 745f     ggml_vec_set_
+00025e90: 6933 3228 6e63 2c20 2869 6e74 3332 5f74  i32(nc, (int32_t
+00025ea0: 202a 2928 6461 7461 202b 2069 2a6e 3129   *)(data + i*n1)
+00025eb0: 2c20 7661 6c75 6529 3b0a 2020 2020 2020  , value);.      
+00025ec0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00025ed0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00025ee0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00025ef0: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
+00025f00: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00025f10: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00025f20: 7428 7465 6e73 6f72 2d3e 6e62 5b30 5d20  t(tensor->nb[0] 
+00025f30: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
+00025f40: 7031 365f 7429 293b 0a20 2020 2020 2020  p16_t));.       
+00025f50: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00025f60: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
+00025f70: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
+00025f80: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00025f90: 7665 635f 7365 745f 6631 3628 6e63 2c20  vec_set_f16(nc, 
+00025fa0: 2867 676d 6c5f 6670 3136 5f74 202a 2928  (ggml_fp16_t *)(
+00025fb0: 6461 7461 202b 2069 2a6e 3129 2c20 7661  data + i*n1), va
+00025fc0: 6c75 6529 3b0a 2020 2020 2020 2020 2020  lue);.          
+00025fd0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00025fe0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00025ff0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00026000: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+00026010: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00026020: 2020 2020 2020 2061 7373 6572 7428 7465         assert(te
+00026030: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
+00026040: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+00026050: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00026060: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00026070: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
+00026080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026090: 2067 676d 6c5f 7665 635f 7365 745f 6633   ggml_vec_set_f3
+000260a0: 3228 6e63 2c20 2866 6c6f 6174 202a 2928  2(nc, (float *)(
+000260b0: 6461 7461 202b 2069 2a6e 3129 2c20 7661  data + i*n1), va
+000260c0: 6c75 6529 3b0a 2020 2020 2020 2020 2020  lue);.          
+000260d0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000260e0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000260f0: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
+00026100: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00026110: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00026120: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+00026130: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00026140: 6561 6b3b 0a20 2020 207d 0a0a 2020 2020  eak;.    }..    
+00026150: 7265 7475 726e 2074 656e 736f 723b 0a7d  return tensor;.}
+00026160: 0a0a 696e 7433 325f 7420 6767 6d6c 5f67  ..int32_t ggml_g
+00026170: 6574 5f69 3332 5f31 6428 636f 6e73 7420  et_i32_1d(const 
+00026180: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00026190: 6f72 202a 2074 656e 736f 722c 2069 6e74  or * tensor, int
+000261a0: 2069 2920 7b0a 2020 2020 7377 6974 6368   i) {.    switch
+000261b0: 2028 7465 6e73 6f72 2d3e 7479 7065 2920   (tensor->type) 
+000261c0: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
+000261d0: 474d 4c5f 5459 5045 5f49 383a 0a20 2020  GML_TYPE_I8:.   
+000261e0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000261f0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00026200: 4153 5345 5254 2874 656e 736f 722d 3e6e  ASSERT(tensor->n
+00026210: 625b 305d 203d 3d20 7369 7a65 6f66 2869  b[0] == sizeof(i
+00026220: 6e74 385f 7429 293b 0a20 2020 2020 2020  nt8_t));.       
+00026230: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00026240: 2828 696e 7438 5f74 202a 2928 7465 6e73  ((int8_t *)(tens
+00026250: 6f72 2d3e 6461 7461 2929 5b69 5d3b 0a20  or->data))[i];. 
+00026260: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00026270: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00026280: 2047 474d 4c5f 5459 5045 5f49 3136 3a0a   GGML_TYPE_I16:.
+00026290: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000262a0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+000262b0: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
+000262c0: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+000262d0: 6628 696e 7431 365f 7429 293b 0a20 2020  f(int16_t));.   
+000262e0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000262f0: 7572 6e20 2828 696e 7431 365f 7420 2a29  urn ((int16_t *)
+00026300: 2874 656e 736f 722d 3e64 6174 6129 295b  (tensor->data))[
+00026310: 695d 3b0a 2020 2020 2020 2020 2020 2020  i];.            
+00026320: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00026330: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00026340: 4933 323a 0a20 2020 2020 2020 2020 2020  I32:.           
+00026350: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00026360: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
+00026370: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
+00026380: 7369 7a65 6f66 2869 6e74 3332 5f74 2929  sizeof(int32_t))
+00026390: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000263a0: 2020 7265 7475 726e 2028 2869 6e74 3332    return ((int32
+000263b0: 5f74 202a 2928 7465 6e73 6f72 2d3e 6461  _t *)(tensor->da
+000263c0: 7461 2929 5b69 5d3b 0a20 2020 2020 2020  ta))[i];.       
+000263d0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000263e0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000263f0: 5459 5045 5f46 3136 3a0a 2020 2020 2020  TYPE_F16:.      
+00026400: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00026410: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00026420: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
+00026430: 5d20 3d3d 2073 697a 656f 6628 6767 6d6c  ] == sizeof(ggml
+00026440: 5f66 7031 365f 7429 293b 0a20 2020 2020  _fp16_t));.     
+00026450: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00026460: 6e20 4747 4d4c 5f46 5031 365f 544f 5f46  n GGML_FP16_TO_F
+00026470: 5033 3228 2828 6767 6d6c 5f66 7031 365f  P32(((ggml_fp16_
+00026480: 7420 2a29 2874 656e 736f 722d 3e64 6174  t *)(tensor->dat
+00026490: 6129 295b 695d 293b 0a20 2020 2020 2020  a))[i]);.       
+000264a0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000264b0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000264c0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+000264d0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000264e0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+000264f0: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
+00026500: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+00026510: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
+00026520: 2020 2020 2072 6574 7572 6e20 2828 666c       return ((fl
+00026530: 6f61 7420 2a29 2874 656e 736f 722d 3e64  oat *)(tensor->d
+00026540: 6174 6129 295b 695d 3b0a 2020 2020 2020  ata))[i];.      
+00026550: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00026560: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
+00026570: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00026580: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00026590: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+000265a0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+000265b0: 6272 6561 6b3b 0a20 2020 207d 0a0a 2020  break;.    }..  
+000265c0: 2020 7265 7475 726e 2030 2e30 663b 0a7d    return 0.0f;.}
+000265d0: 0a0a 766f 6964 2067 676d 6c5f 7365 745f  ..void ggml_set_
+000265e0: 6933 325f 3164 2863 6f6e 7374 2073 7472  i32_1d(const str
+000265f0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00026600: 2a20 7465 6e73 6f72 2c20 696e 7420 692c  * tensor, int i,
+00026610: 2069 6e74 3332 5f74 2076 616c 7565 2920   int32_t value) 
+00026620: 7b0a 2020 2020 7377 6974 6368 2028 7465  {.    switch (te
+00026630: 6e73 6f72 2d3e 7479 7065 2920 7b0a 2020  nsor->type) {.  
+00026640: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00026650: 5459 5045 5f49 383a 0a20 2020 2020 2020  TYPE_I8:.       
+00026660: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00026670: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00026680: 5254 2874 656e 736f 722d 3e6e 625b 305d  RT(tensor->nb[0]
+00026690: 203d 3d20 7369 7a65 6f66 2869 6e74 385f   == sizeof(int8_
+000266a0: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
+000266b0: 2020 2020 2028 2869 6e74 385f 7420 2a29       ((int8_t *)
+000266c0: 2874 656e 736f 722d 3e64 6174 6129 295b  (tensor->data))[
+000266d0: 695d 203d 2076 616c 7565 3b0a 2020 2020  i] = value;.    
+000266e0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+000266f0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00026700: 4d4c 5f54 5950 455f 4931 363a 0a20 2020  ML_TYPE_I16:.   
+00026710: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00026720: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00026730: 4153 5345 5254 2874 656e 736f 722d 3e6e  ASSERT(tensor->n
+00026740: 625b 305d 203d 3d20 7369 7a65 6f66 2869  b[0] == sizeof(i
+00026750: 6e74 3136 5f74 2929 3b0a 2020 2020 2020  nt16_t));.      
+00026760: 2020 2020 2020 2020 2020 2828 696e 7431            ((int1
+00026770: 365f 7420 2a29 2874 656e 736f 722d 3e64  6_t *)(tensor->d
+00026780: 6174 6129 295b 695d 203d 2076 616c 7565  ata))[i] = value
+00026790: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+000267a0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+000267b0: 6173 6520 4747 4d4c 5f54 5950 455f 4933  ase GGML_TYPE_I3
+000267c0: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
+000267d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000267e0: 2047 474d 4c5f 4153 5345 5254 2874 656e   GGML_ASSERT(ten
+000267f0: 736f 722d 3e6e 625b 305d 203d 3d20 7369  sor->nb[0] == si
+00026800: 7a65 6f66 2869 6e74 3332 5f74 2929 3b0a  zeof(int32_t));.
+00026810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026820: 2828 696e 7433 325f 7420 2a29 2874 656e  ((int32_t *)(ten
+00026830: 736f 722d 3e64 6174 6129 295b 695d 203d  sor->data))[i] =
+00026840: 2076 616c 7565 3b0a 2020 2020 2020 2020   value;.        
+00026850: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00026860: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00026870: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
+00026880: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00026890: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+000268a0: 5254 2874 656e 736f 722d 3e6e 625b 305d  RT(tensor->nb[0]
+000268b0: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
+000268c0: 6670 3136 5f74 2929 3b0a 2020 2020 2020  fp16_t));.      
+000268d0: 2020 2020 2020 2020 2020 2828 6767 6d6c            ((ggml
+000268e0: 5f66 7031 365f 7420 2a29 2874 656e 736f  _fp16_t *)(tenso
+000268f0: 722d 3e64 6174 6129 295b 695d 203d 2047  r->data))[i] = G
+00026900: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+00026910: 2876 616c 7565 293b 0a20 2020 2020 2020  (value);.       
+00026920: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00026930: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00026940: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00026950: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00026960: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00026970: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
+00026980: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+00026990: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
+000269a0: 2020 2020 2028 2866 6c6f 6174 202a 2928       ((float *)(
+000269b0: 7465 6e73 6f72 2d3e 6461 7461 2929 5b69  tensor->data))[i
+000269c0: 5d20 3d20 7661 6c75 653b 0a20 2020 2020  ] = value;.     
+000269d0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000269e0: 2020 2020 2020 2020 6465 6661 756c 743a          default:
+000269f0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00026a00: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00026a10: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00026a20: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00026a30: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+00026a40: 0a66 6c6f 6174 2067 676d 6c5f 6765 745f  .float ggml_get_
+00026a50: 6633 325f 3164 2863 6f6e 7374 2073 7472  f32_1d(const str
+00026a60: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00026a70: 2a20 7465 6e73 6f72 2c20 696e 7420 6929  * tensor, int i)
+00026a80: 207b 0a20 2020 2073 7769 7463 6820 2874   {.    switch (t
+00026a90: 656e 736f 722d 3e74 7970 6529 207b 0a20  ensor->type) {. 
+00026aa0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00026ab0: 5f54 5950 455f 4938 3a0a 2020 2020 2020  _TYPE_I8:.      
+00026ac0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00026ad0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00026ae0: 4552 5428 7465 6e73 6f72 2d3e 6e62 5b30  ERT(tensor->nb[0
+00026af0: 5d20 3d3d 2073 697a 656f 6628 696e 7438  ] == sizeof(int8
+00026b00: 5f74 2929 3b0a 2020 2020 2020 2020 2020  _t));.          
+00026b10: 2020 2020 2020 7265 7475 726e 2028 2869        return ((i
+00026b20: 6e74 385f 7420 2a29 2874 656e 736f 722d  nt8_t *)(tensor-
+00026b30: 3e64 6174 6129 295b 695d 3b0a 2020 2020  >data))[i];.    
+00026b40: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00026b50: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00026b60: 4d4c 5f54 5950 455f 4931 363a 0a20 2020  ML_TYPE_I16:.   
+00026b70: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00026b80: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00026b90: 4153 5345 5254 2874 656e 736f 722d 3e6e  ASSERT(tensor->n
+00026ba0: 625b 305d 203d 3d20 7369 7a65 6f66 2869  b[0] == sizeof(i
+00026bb0: 6e74 3136 5f74 2929 3b0a 2020 2020 2020  nt16_t));.      
+00026bc0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00026bd0: 2028 2869 6e74 3136 5f74 202a 2928 7465   ((int16_t *)(te
+00026be0: 6e73 6f72 2d3e 6461 7461 2929 5b69 5d3b  nsor->data))[i];
+00026bf0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00026c00: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00026c10: 7365 2047 474d 4c5f 5459 5045 5f49 3332  se GGML_TYPE_I32
+00026c20: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00026c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026c40: 4747 4d4c 5f41 5353 4552 5428 7465 6e73  GGML_ASSERT(tens
+00026c50: 6f72 2d3e 6e62 5b30 5d20 3d3d 2073 697a  or->nb[0] == siz
+00026c60: 656f 6628 696e 7433 325f 7429 293b 0a20  eof(int32_t));. 
+00026c70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00026c80: 6574 7572 6e20 2828 696e 7433 325f 7420  eturn ((int32_t 
+00026c90: 2a29 2874 656e 736f 722d 3e64 6174 6129  *)(tensor->data)
+00026ca0: 295b 695d 3b0a 2020 2020 2020 2020 2020  )[i];.          
+00026cb0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00026cc0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00026cd0: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
+00026ce0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00026cf0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00026d00: 2874 656e 736f 722d 3e6e 625b 305d 203d  (tensor->nb[0] =
+00026d10: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
+00026d20: 3136 5f74 2929 3b0a 2020 2020 2020 2020  16_t));.        
+00026d30: 2020 2020 2020 2020 7265 7475 726e 2047          return G
+00026d40: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
+00026d50: 2828 2867 676d 6c5f 6670 3136 5f74 202a  (((ggml_fp16_t *
+00026d60: 2928 7465 6e73 6f72 2d3e 6461 7461 2929  )(tensor->data))
+00026d70: 5b69 5d29 3b0a 2020 2020 2020 2020 2020  [i]);.          
+00026d80: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00026d90: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00026da0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
+00026db0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00026dc0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00026dd0: 2874 656e 736f 722d 3e6e 625b 305d 203d  (tensor->nb[0] =
+00026de0: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
+00026df0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00026e00: 2020 7265 7475 726e 2028 2866 6c6f 6174    return ((float
+00026e10: 202a 2928 7465 6e73 6f72 2d3e 6461 7461   *)(tensor->data
+00026e20: 2929 5b69 5d3b 0a20 2020 2020 2020 2020  ))[i];.         
+00026e30: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00026e40: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
+00026e50: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00026e60: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00026e70: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+00026e80: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00026e90: 616b 3b0a 2020 2020 7d0a 0a20 2020 2072  ak;.    }..    r
+00026ea0: 6574 7572 6e20 302e 3066 3b0a 7d0a 0a76  eturn 0.0f;.}..v
+00026eb0: 6f69 6420 6767 6d6c 5f73 6574 5f66 3332  oid ggml_set_f32
+00026ec0: 5f31 6428 636f 6e73 7420 7374 7275 6374  _1d(const struct
+00026ed0: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
+00026ee0: 656e 736f 722c 2069 6e74 2069 2c20 666c  ensor, int i, fl
+00026ef0: 6f61 7420 7661 6c75 6529 207b 0a20 2020  oat value) {.   
+00026f00: 2073 7769 7463 6820 2874 656e 736f 722d   switch (tensor-
+00026f10: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+00026f20: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00026f30: 4938 3a0a 2020 2020 2020 2020 2020 2020  I8:.            
+00026f40: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00026f50: 2020 4747 4d4c 5f41 5353 4552 5428 7465    GGML_ASSERT(te
+00026f60: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
+00026f70: 697a 656f 6628 696e 7438 5f74 2929 3b0a  izeof(int8_t));.
+00026f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026f90: 2828 696e 7438 5f74 202a 2928 7465 6e73  ((int8_t *)(tens
+00026fa0: 6f72 2d3e 6461 7461 2929 5b69 5d20 3d20  or->data))[i] = 
+00026fb0: 7661 6c75 653b 0a20 2020 2020 2020 2020  value;.         
+00026fc0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00026fd0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00026fe0: 5045 5f49 3136 3a0a 2020 2020 2020 2020  PE_I16:.        
+00026ff0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00027000: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00027010: 5428 7465 6e73 6f72 2d3e 6e62 5b30 5d20  T(tensor->nb[0] 
+00027020: 3d3d 2073 697a 656f 6628 696e 7431 365f  == sizeof(int16_
+00027030: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
+00027040: 2020 2020 2028 2869 6e74 3136 5f74 202a       ((int16_t *
+00027050: 2928 7465 6e73 6f72 2d3e 6461 7461 2929  )(tensor->data))
+00027060: 5b69 5d20 3d20 7661 6c75 653b 0a20 2020  [i] = value;.   
+00027070: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00027080: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00027090: 474d 4c5f 5459 5045 5f49 3332 3a0a 2020  GML_TYPE_I32:.  
+000270a0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000270b0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+000270c0: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
+000270d0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+000270e0: 696e 7433 325f 7429 293b 0a20 2020 2020  int32_t));.     
+000270f0: 2020 2020 2020 2020 2020 2028 2869 6e74             ((int
+00027100: 3332 5f74 202a 2928 7465 6e73 6f72 2d3e  32_t *)(tensor->
+00027110: 6461 7461 2929 5b69 5d20 3d20 7661 6c75  data))[i] = valu
+00027120: 653b 0a20 2020 2020 2020 2020 2020 207d  e;.            }
+00027130: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00027140: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+00027150: 3136 3a0a 2020 2020 2020 2020 2020 2020  16:.            
+00027160: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00027170: 2020 4747 4d4c 5f41 5353 4552 5428 7465    GGML_ASSERT(te
+00027180: 6e73 6f72 2d3e 6e62 5b30 5d20 3d3d 2073  nsor->nb[0] == s
+00027190: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
+000271a0: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
+000271b0: 2020 2020 2028 2867 676d 6c5f 6670 3136       ((ggml_fp16
+000271c0: 5f74 202a 2928 7465 6e73 6f72 2d3e 6461  _t *)(tensor->da
+000271d0: 7461 2929 5b69 5d20 3d20 4747 4d4c 5f46  ta))[i] = GGML_F
+000271e0: 5033 325f 544f 5f46 5031 3628 7661 6c75  P32_TO_FP16(valu
+000271f0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00027200: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00027210: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00027220: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
+00027230: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00027240: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
+00027250: 656e 736f 722d 3e6e 625b 305d 203d 3d20  ensor->nb[0] == 
+00027260: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+00027270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027280: 2828 666c 6f61 7420 2a29 2874 656e 736f  ((float *)(tenso
+00027290: 722d 3e64 6174 6129 295b 695d 203d 2076  r->data))[i] = v
+000272a0: 616c 7565 3b0a 2020 2020 2020 2020 2020  alue;.          
+000272b0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000272c0: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+000272d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000272e0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+000272f0: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00027300: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00027310: 6b3b 0a20 2020 207d 0a7d 0a0a 766f 6964  k;.    }.}..void
+00027320: 202a 2067 676d 6c5f 6765 745f 6461 7461   * ggml_get_data
+00027330: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
+00027340: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+00027350: 6f72 2920 7b0a 2020 2020 7265 7475 726e  or) {.    return
+00027360: 2074 656e 736f 722d 3e64 6174 613b 0a7d   tensor->data;.}
+00027370: 0a0a 666c 6f61 7420 2a20 6767 6d6c 5f67  ..float * ggml_g
+00027380: 6574 5f64 6174 615f 6633 3228 636f 6e73  et_data_f32(cons
+00027390: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+000273a0: 6e73 6f72 202a 2074 656e 736f 7229 207b  nsor * tensor) {
+000273b0: 0a20 2020 2061 7373 6572 7428 7465 6e73  .    assert(tens
+000273c0: 6f72 2d3e 7479 7065 203d 3d20 4747 4d4c  or->type == GGML
+000273d0: 5f54 5950 455f 4633 3229 3b0a 2020 2020  _TYPE_F32);.    
+000273e0: 7265 7475 726e 2028 666c 6f61 7420 2a29  return (float *)
+000273f0: 2874 656e 736f 722d 3e64 6174 6129 3b0a  (tensor->data);.
+00027400: 7d0a 0a63 6f6e 7374 2063 6861 7220 2a20  }..const char * 
+00027410: 6767 6d6c 5f67 6574 5f6e 616d 6528 636f  ggml_get_name(co
+00027420: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00027430: 7465 6e73 6f72 202a 2074 656e 736f 7229  tensor * tensor)
+00027440: 207b 0a20 2020 2072 6574 7572 6e20 7465   {.    return te
+00027450: 6e73 6f72 2d3e 6e61 6d65 3b0a 7d0a 0a76  nsor->name;.}..v
+00027460: 6f69 6420 6767 6d6c 5f73 6574 5f6e 616d  oid ggml_set_nam
+00027470: 6528 7374 7275 6374 2067 676d 6c5f 7465  e(struct ggml_te
+00027480: 6e73 6f72 202a 2074 656e 736f 722c 2063  nsor * tensor, c
+00027490: 6f6e 7374 2063 6861 7220 2a20 6e61 6d65  onst char * name
+000274a0: 2920 7b0a 2020 2020 7374 726e 6370 7928  ) {.    strncpy(
+000274b0: 7465 6e73 6f72 2d3e 6e61 6d65 2c20 6e61  tensor->name, na
+000274c0: 6d65 2c20 7369 7a65 6f66 2874 656e 736f  me, sizeof(tenso
+000274d0: 722d 3e6e 616d 6529 293b 0a20 2020 2074  r->name));.    t
+000274e0: 656e 736f 722d 3e6e 616d 655b 7369 7a65  ensor->name[size
+000274f0: 6f66 2874 656e 736f 722d 3e6e 616d 6529  of(tensor->name)
+00027500: 202d 2031 5d20 3d20 275c 3027 3b0a 7d0a   - 1] = '\0';.}.
+00027510: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+00027520: 736f 7220 2a20 6767 6d6c 5f76 6965 775f  sor * ggml_view_
+00027530: 7465 6e73 6f72 280a 2020 2020 2020 2020  tensor(.        
+00027540: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+00027550: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+00027560: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00027570: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00027580: 6329 207b 0a20 2020 2073 7472 7563 7420  c) {.    struct 
+00027590: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
+000275a0: 7375 6c74 203d 2067 676d 6c5f 6e65 775f  sult = ggml_new_
+000275b0: 7465 6e73 6f72 5f69 6d70 6c28 6374 782c  tensor_impl(ctx,
+000275c0: 2073 7263 2d3e 7479 7065 2c20 7372 632d   src->type, src-
+000275d0: 3e6e 5f64 696d 732c 2073 7263 2d3e 6e65  >n_dims, src->ne
+000275e0: 2c20 7372 632d 3e64 6174 6129 3b0a 0a20  , src->data);.. 
+000275f0: 2020 2072 6573 756c 742d 3e6e 625b 305d     result->nb[0]
+00027600: 203d 2073 7263 2d3e 6e62 5b30 5d3b 0a20   = src->nb[0];. 
+00027610: 2020 2072 6573 756c 742d 3e6e 625b 315d     result->nb[1]
+00027620: 203d 2073 7263 2d3e 6e62 5b31 5d3b 0a20   = src->nb[1];. 
+00027630: 2020 2072 6573 756c 742d 3e6e 625b 325d     result->nb[2]
+00027640: 203d 2073 7263 2d3e 6e62 5b32 5d3b 0a20   = src->nb[2];. 
+00027650: 2020 2072 6573 756c 742d 3e6e 625b 335d     result->nb[3]
+00027660: 203d 2073 7263 2d3e 6e62 5b33 5d3b 0a0a   = src->nb[3];..
+00027670: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00027680: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
+00027690: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+000276a0: 6765 745f 7465 6e73 6f72 2873 7472 7563  get_tensor(struc
+000276b0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+000276c0: 2063 7478 2c20 636f 6e73 7420 6368 6172   ctx, const char
+000276d0: 202a 206e 616d 6529 207b 0a20 2020 2073   * name) {.    s
+000276e0: 7472 7563 7420 6767 6d6c 5f6f 626a 6563  truct ggml_objec
+000276f0: 7420 2a20 6f62 6a20 3d20 6374 782d 3e6f  t * obj = ctx->o
+00027700: 626a 6563 7473 5f62 6567 696e 3b0a 0a20  bjects_begin;.. 
+00027710: 2020 2063 6861 7220 2a20 636f 6e73 7420     char * const 
+00027720: 6d65 6d5f 6275 6666 6572 203d 2063 7478  mem_buffer = ctx
+00027730: 2d3e 6d65 6d5f 6275 6666 6572 3b0a 0a20  ->mem_buffer;.. 
+00027740: 2020 2077 6869 6c65 2028 6f62 6a20 213d     while (obj !=
+00027750: 204e 554c 4c29 207b 0a20 2020 2020 2020   NULL) {.       
+00027760: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00027770: 736f 7220 2a20 6375 7220 3d20 2873 7472  sor * cur = (str
+00027780: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00027790: 2a29 286d 656d 5f62 7566 6665 7220 2b20  *)(mem_buffer + 
+000277a0: 6f62 6a2d 3e6f 6666 7329 3b0a 2020 2020  obj->offs);.    
+000277b0: 2020 2020 6966 2028 7374 7263 6d70 2863      if (strcmp(c
+000277c0: 7572 2d3e 6e61 6d65 2c20 6e61 6d65 2920  ur->name, name) 
+000277d0: 3d3d 2030 2920 7b0a 2020 2020 2020 2020  == 0) {.        
+000277e0: 2020 2020 7265 7475 726e 2063 7572 3b0a      return cur;.
+000277f0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00027800: 2020 206f 626a 203d 206f 626a 2d3e 6e65     obj = obj->ne
+00027810: 7874 3b0a 2020 2020 7d0a 0a20 2020 2072  xt;.    }..    r
+00027820: 6574 7572 6e20 4e55 4c4c 3b0a 7d0a 0a2f  eturn NULL;.}../
+00027830: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00027840: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00027850: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00027860: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00027870: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00027880: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00027890: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000278a0: 0a0a 2f2f 2067 676d 6c5f 6475 700a 0a73  ..// ggml_dup..s
-000278b0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000278c0: 7220 2a20 6767 6d6c 5f64 7570 5f69 6d70  r * ggml_dup_imp
-000278d0: 6c28 0a20 2020 2020 2020 2073 7472 7563  l(.        struc
-000278e0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-000278f0: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-00027900: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00027910: 202a 2061 2c0a 2020 2020 2020 2020 626f   * a,.        bo
-00027920: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
-00027930: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
-00027940: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
-00027950: 2821 696e 706c 6163 6520 2626 2028 612d  (!inplace && (a-
-00027960: 3e67 7261 6429 2920 7b0a 2020 2020 2020  >grad)) {.      
-00027970: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
-00027980: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
-00027990: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000279a0: 2a20 7265 7375 6c74 203d 2069 6e70 6c61  * result = inpla
-000279b0: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
-000279c0: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
-000279d0: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
-000279e0: 6374 782c 2061 293b 0a0a 2020 2020 7265  ctx, a);..    re
-000279f0: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-00027a00: 4c5f 4f50 5f44 5550 3b0a 2020 2020 7265  L_OP_DUP;.    re
-00027a10: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
-00027a20: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
-00027a30: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
-00027a40: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
-00027a50: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
-00027a60: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-00027a70: 6331 203d 204e 554c 4c3b 0a0a 2020 2020  c1 = NULL;..    
-00027a80: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
-00027a90: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-00027aa0: 6e73 6f72 202a 2067 676d 6c5f 6475 7028  nsor * ggml_dup(
-00027ab0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00027ac0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00027ad0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-00027ae0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00027af0: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
-00027b00: 2067 676d 6c5f 6475 705f 696d 706c 2863   ggml_dup_impl(c
-00027b10: 7478 2c20 612c 2066 616c 7365 293b 0a7d  tx, a, false);.}
-00027b20: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-00027b30: 6e73 6f72 202a 2067 676d 6c5f 6475 705f  nsor * ggml_dup_
-00027b40: 696e 706c 6163 6528 0a20 2020 2020 2020  inplace(.       
-00027b50: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-00027b60: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-00027b70: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00027b80: 7465 6e73 6f72 202a 2061 2920 7b0a 2020  tensor * a) {.  
-00027b90: 2020 7265 7475 726e 2067 676d 6c5f 6475    return ggml_du
-00027ba0: 705f 696d 706c 2863 7478 2c20 612c 2074  p_impl(ctx, a, t
-00027bb0: 7275 6529 3b0a 7d0a 0a2f 2f20 6767 6d6c  rue);.}..// ggml
-00027bc0: 5f61 6464 0a0a 7374 7275 6374 2067 676d  _add..struct ggm
-00027bd0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-00027be0: 6164 645f 696d 706c 280a 2020 2020 2020  add_impl(.      
-00027bf0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-00027c00: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
-00027c10: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00027c20: 5f74 656e 736f 7220 2a20 612c 0a20 2020  _tensor * a,.   
-00027c30: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00027c40: 5f74 656e 736f 7220 2a20 622c 0a20 2020  _tensor * b,.   
-00027c50: 2020 2020 2062 6f6f 6c20 696e 706c 6163       bool inplac
-00027c60: 6529 207b 0a20 2020 2047 474d 4c5f 4153  e) {.    GGML_AS
-00027c70: 5345 5254 2867 676d 6c5f 6172 655f 7361  SERT(ggml_are_sa
-00027c80: 6d65 5f73 6861 7065 2861 2c20 6229 293b  me_shape(a, b));
-00027c90: 0a0a 2020 2020 626f 6f6c 2069 735f 6e6f  ..    bool is_no
-00027ca0: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
-00027cb0: 2069 6620 2861 2d3e 6772 6164 207c 7c20   if (a->grad || 
-00027cc0: 622d 3e67 7261 6429 207b 0a20 2020 2020  b->grad) {.     
-00027cd0: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
-00027ce0: 653b 0a20 2020 207d 0a0a 2020 2020 7374  e;.    }..    st
-00027cf0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00027d00: 202a 2072 6573 756c 7420 3d20 696e 706c   * result = inpl
-00027d10: 6163 6520 3f20 6767 6d6c 5f76 6965 775f  ace ? ggml_view_
-00027d20: 7465 6e73 6f72 2863 7478 2c20 6129 203a  tensor(ctx, a) :
-00027d30: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-00027d40: 2863 7478 2c20 6129 3b0a 0a20 2020 2072  (ctx, a);..    r
-00027d50: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
-00027d60: 4d4c 5f4f 505f 4144 443b 0a20 2020 2072  ML_OP_ADD;.    r
-00027d70: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
-00027d80: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
-00027d90: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
-00027da0: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
-00027db0: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-00027dc0: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-00027dd0: 7263 3120 3d20 623b 0a0a 2020 2020 7265  rc1 = b;..    re
-00027de0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-00027df0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00027e00: 6f72 202a 2067 676d 6c5f 6164 6428 0a20  or * ggml_add(. 
-00027e10: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00027e20: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00027e30: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00027e40: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
-00027e50: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00027e60: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
-00027e70: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
-00027e80: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-00027e90: 2c20 612c 2062 2c20 6661 6c73 6529 3b0a  , a, b, false);.
-00027ea0: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
-00027eb0: 656e 736f 7220 2a20 6767 6d6c 5f61 6464  ensor * ggml_add
-00027ec0: 5f69 6e70 6c61 6365 280a 2020 2020 2020  _inplace(.      
-00027ed0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-00027ee0: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
-00027ef0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00027f00: 5f74 656e 736f 7220 2a20 612c 0a20 2020  _tensor * a,.   
-00027f10: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00027f20: 5f74 656e 736f 7220 2a20 6229 207b 0a20  _tensor * b) {. 
-00027f30: 2020 2072 6574 7572 6e20 6767 6d6c 5f61     return ggml_a
-00027f40: 6464 5f69 6d70 6c28 6374 782c 2061 2c20  dd_impl(ctx, a, 
-00027f50: 622c 2074 7275 6529 3b0a 7d0a 0a2f 2f20  b, true);.}..// 
-00027f60: 6767 6d6c 5f61 6464 310a 0a73 7472 7563  ggml_add1..struc
-00027f70: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00027f80: 6767 6d6c 5f61 6464 315f 696d 706c 280a  ggml_add1_impl(.
-00027f90: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00027fa0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-00027fb0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-00027fc0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00027fd0: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
-00027fe0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00027ff0: 622c 0a20 2020 2020 2020 2062 6f6f 6c20  b,.        bool 
-00028000: 696e 706c 6163 6529 207b 0a20 2020 2047  inplace) {.    G
-00028010: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
-00028020: 6973 5f73 6361 6c61 7228 6229 293b 0a20  is_scalar(b));. 
-00028030: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-00028040: 676d 6c5f 6973 5f70 6164 6465 645f 3164  gml_is_padded_1d
-00028050: 2861 2929 3b0a 0a20 2020 2062 6f6f 6c20  (a));..    bool 
-00028060: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
-00028070: 0a0a 2020 2020 6966 2028 612d 3e67 7261  ..    if (a->gra
-00028080: 6420 7c7c 2062 2d3e 6772 6164 2920 7b0a  d || b->grad) {.
-00028090: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
-000280a0: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
-000280b0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-000280c0: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
-000280d0: 2069 6e70 6c61 6365 203f 2067 676d 6c5f   inplace ? ggml_
-000280e0: 7669 6577 5f74 656e 736f 7228 6374 782c  view_tensor(ctx,
-000280f0: 2061 2920 3a20 6767 6d6c 5f64 7570 5f74   a) : ggml_dup_t
-00028100: 656e 736f 7228 6374 782c 2061 293b 0a0a  ensor(ctx, a);..
-00028110: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-00028120: 203d 2047 474d 4c5f 4f50 5f41 4444 313b   = GGML_OP_ADD1;
-00028130: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
-00028140: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
-00028150: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
-00028160: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
-00028170: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
-00028180: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
-00028190: 756c 742d 3e73 7263 3120 3d20 623b 0a0a  ult->src1 = b;..
-000281a0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-000281b0: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
-000281c0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-000281d0: 6164 6431 280a 2020 2020 2020 2020 7374  add1(.        st
-000281e0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-000281f0: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
-00028200: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00028210: 736f 7220 2a20 612c 0a20 2020 2020 2020  sor * a,.       
-00028220: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00028230: 736f 7220 2a20 6229 207b 0a20 2020 2072  sor * b) {.    r
-00028240: 6574 7572 6e20 6767 6d6c 5f61 6464 315f  eturn ggml_add1_
-00028250: 696d 706c 2863 7478 2c20 612c 2062 2c20  impl(ctx, a, b, 
-00028260: 6661 6c73 6529 3b0a 7d0a 0a73 7472 7563  false);.}..struc
-00028270: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00028280: 6767 6d6c 5f61 6464 315f 696e 706c 6163  ggml_add1_inplac
-00028290: 6528 0a20 2020 2020 2020 2073 7472 7563  e(.        struc
-000282a0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-000282b0: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-000282c0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000282d0: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
-000282e0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000282f0: 202a 2062 2920 7b0a 2020 2020 7265 7475   * b) {.    retu
-00028300: 726e 2067 676d 6c5f 6164 6431 5f69 6d70  rn ggml_add1_imp
-00028310: 6c28 6374 782c 2061 2c20 622c 2074 7275  l(ctx, a, b, tru
-00028320: 6529 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f61  e);.}..// ggml_a
-00028330: 6363 0a0a 7374 7275 6374 2067 676d 6c5f  cc..struct ggml_
-00028340: 7465 6e73 6f72 202a 2067 676d 6c5f 6163  tensor * ggml_ac
-00028350: 635f 696d 706c 280a 2020 2020 2020 2020  c_impl(.        
-00028360: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-00028370: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-00028380: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00028390: 656e 736f 7220 2a20 612c 0a20 2020 2020  ensor * a,.     
-000283a0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-000283b0: 656e 736f 7220 2a20 622c 0a20 2020 2020  ensor * b,.     
-000283c0: 2020 2073 697a 655f 7420 2020 2020 2020     size_t       
-000283d0: 2020 2020 2020 2020 6e62 312c 0a20 2020          nb1,.   
-000283e0: 2020 2020 2073 697a 655f 7420 2020 2020       size_t     
-000283f0: 2020 2020 2020 2020 2020 6e62 322c 0a20            nb2,. 
-00028400: 2020 2020 2020 2073 697a 655f 7420 2020         size_t   
-00028410: 2020 2020 2020 2020 2020 2020 6e62 332c              nb3,
-00028420: 0a20 2020 2020 2020 2073 697a 655f 7420  .        size_t 
-00028430: 2020 2020 2020 2020 2020 2020 2020 6f66                of
-00028440: 6673 6574 2c0a 2020 2020 2020 2020 626f  fset,.        bo
-00028450: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
-00028460: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00028470: 6d6c 5f6e 656c 656d 656e 7473 2862 2920  ml_nelements(b) 
-00028480: 3c3d 2067 676d 6c5f 6e65 6c65 6d65 6e74  <= ggml_nelement
-00028490: 7328 6129 293b 0a20 2020 2047 474d 4c5f  s(a));.    GGML_
-000284a0: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
-000284b0: 6f6e 7469 6775 6f75 7328 6129 293b 0a20  ontiguous(a));. 
-000284c0: 2020 2047 474d 4c5f 4153 5345 5254 2861     GGML_ASSERT(a
-000284d0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-000284e0: 5950 455f 4633 3229 3b0a 2020 2020 4747  YPE_F32);.    GG
-000284f0: 4d4c 5f41 5353 4552 5428 622d 3e74 7970  ML_ASSERT(b->typ
-00028500: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-00028510: 3332 293b 0a0a 2020 2020 626f 6f6c 2069  32);..    bool i
-00028520: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
-00028530: 0a20 2020 2069 6620 2821 696e 706c 6163  .    if (!inplac
-00028540: 6520 2626 2028 612d 3e67 7261 6420 7c7c  e && (a->grad ||
-00028550: 2062 2d3e 6772 6164 2929 207b 0a20 2020   b->grad)) {.   
-00028560: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
-00028570: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
-00028580: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00028590: 6f72 202a 2072 6573 756c 7420 3d20 696e  or * result = in
-000285a0: 706c 6163 6520 3f20 6767 6d6c 5f76 6965  place ? ggml_vie
-000285b0: 775f 7465 6e73 6f72 2863 7478 2c20 6129  w_tensor(ctx, a)
-000285c0: 203a 2067 676d 6c5f 6475 705f 7465 6e73   : ggml_dup_tens
-000285d0: 6f72 2863 7478 2c20 6129 3b0a 0a20 2020  or(ctx, a);..   
-000285e0: 2067 676d 6c5f 7363 7261 7463 685f 7361   ggml_scratch_sa
-000285f0: 7665 2863 7478 293b 0a0a 2020 2020 7374  ve(ctx);..    st
-00028600: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00028610: 202a 2063 203d 2067 676d 6c5f 6e65 775f   * c = ggml_new_
-00028620: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
-00028630: 474d 4c5f 5459 5045 5f49 3332 2c20 3529  GML_TYPE_I32, 5)
-00028640: 3b0a 0a20 2020 2028 2869 6e74 3332 5f74  ;..    ((int32_t
-00028650: 202a 2920 632d 3e64 6174 6129 5b30 5d20   *) c->data)[0] 
-00028660: 3d20 6e62 313b 0a20 2020 2028 2869 6e74  = nb1;.    ((int
-00028670: 3332 5f74 202a 2920 632d 3e64 6174 6129  32_t *) c->data)
-00028680: 5b31 5d20 3d20 6e62 323b 0a20 2020 2028  [1] = nb2;.    (
-00028690: 2869 6e74 3332 5f74 202a 2920 632d 3e64  (int32_t *) c->d
-000286a0: 6174 6129 5b32 5d20 3d20 6e62 333b 0a20  ata)[2] = nb3;. 
-000286b0: 2020 2028 2869 6e74 3332 5f74 202a 2920     ((int32_t *) 
-000286c0: 632d 3e64 6174 6129 5b33 5d20 3d20 6f66  c->data)[3] = of
-000286d0: 6673 6574 3b0a 2020 2020 2828 696e 7433  fset;.    ((int3
-000286e0: 325f 7420 2a29 2063 2d3e 6461 7461 295b  2_t *) c->data)[
-000286f0: 345d 203d 2069 6e70 6c61 6365 203f 2031  4] = inplace ? 1
-00028700: 203a 2030 3b0a 0a20 2020 2067 676d 6c5f   : 0;..    ggml_
-00028710: 7363 7261 7463 685f 6c6f 6164 2863 7478  scratch_load(ctx
-00028720: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
-00028730: 6f70 2020 203d 2047 474d 4c5f 4f50 5f41  op   = GGML_OP_A
-00028740: 4343 3b0a 2020 2020 7265 7375 6c74 2d3e  CC;.    result->
-00028750: 6772 6164 203d 2069 735f 6e6f 6465 203f  grad = is_node ?
-00028760: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-00028770: 2863 7478 2c20 7265 7375 6c74 2920 3a20  (ctx, result) : 
-00028780: 4e55 4c4c 3b0a 2020 2020 7265 7375 6c74  NULL;.    result
-00028790: 2d3e 7372 6330 203d 2061 3b0a 2020 2020  ->src0 = a;.    
-000287a0: 7265 7375 6c74 2d3e 7372 6331 203d 2062  result->src1 = b
-000287b0: 3b0a 2020 2020 7265 7375 6c74 2d3e 6f70  ;.    result->op
-000287c0: 745b 305d 203d 2063 3b0a 0a20 2020 2072  t[0] = c;..    r
-000287d0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-000287e0: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-000287f0: 736f 7220 2a20 6767 6d6c 5f61 6363 280a  sor * ggml_acc(.
-00028800: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00028810: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-00028820: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-00028830: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00028840: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
-00028850: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00028860: 622c 0a20 2020 2020 2020 2073 697a 655f  b,.        size_
-00028870: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-00028880: 6e62 312c 0a20 2020 2020 2020 2073 697a  nb1,.        siz
-00028890: 655f 7420 2020 2020 2020 2020 2020 2020  e_t             
-000288a0: 2020 6e62 322c 0a20 2020 2020 2020 2073    nb2,.        s
-000288b0: 697a 655f 7420 2020 2020 2020 2020 2020  ize_t           
-000288c0: 2020 2020 6e62 332c 0a20 2020 2020 2020      nb3,.       
-000288d0: 2073 697a 655f 7420 2020 2020 2020 2020   size_t         
-000288e0: 2020 2020 2020 6f66 6673 6574 2920 7b0a        offset) {.
-000288f0: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
-00028900: 6163 635f 696d 706c 2863 7478 2c20 612c  acc_impl(ctx, a,
-00028910: 2062 2c20 6e62 312c 206e 6232 2c20 6e62   b, nb1, nb2, nb
-00028920: 332c 206f 6666 7365 742c 2066 616c 7365  3, offset, false
-00028930: 293b 0a7d 0a0a 7374 7275 6374 2067 676d  );.}..struct ggm
-00028940: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-00028950: 6163 635f 696e 706c 6163 6528 0a20 2020  acc_inplace(.   
-00028960: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00028970: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-00028980: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00028990: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
-000289a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000289b0: 676d 6c5f 7465 6e73 6f72 202a 2062 2c0a  gml_tensor * b,.
-000289c0: 2020 2020 2020 2020 7369 7a65 5f74 2020          size_t  
-000289d0: 2020 2020 2020 2020 2020 2020 206e 6231               nb1
-000289e0: 2c0a 2020 2020 2020 2020 7369 7a65 5f74  ,.        size_t
-000289f0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00028a00: 6232 2c0a 2020 2020 2020 2020 7369 7a65  b2,.        size
-00028a10: 5f74 2020 2020 2020 2020 2020 2020 2020  _t              
-00028a20: 206e 6233 2c0a 2020 2020 2020 2020 7369   nb3,.        si
-00028a30: 7a65 5f74 2020 2020 2020 2020 2020 2020  ze_t            
-00028a40: 2020 206f 6666 7365 7429 207b 0a20 2020     offset) {.   
-00028a50: 2072 6574 7572 6e20 6767 6d6c 5f61 6363   return ggml_acc
-00028a60: 5f69 6d70 6c28 6374 782c 2061 2c20 622c  _impl(ctx, a, b,
-00028a70: 206e 6231 2c20 6e62 322c 206e 6233 2c20   nb1, nb2, nb3, 
-00028a80: 6f66 6673 6574 2c20 7472 7565 293b 0a7d  offset, true);.}
-00028a90: 0a0a 2f2f 2067 676d 6c5f 7375 620a 0a73  ..// ggml_sub..s
-00028aa0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00028ab0: 7220 2a20 6767 6d6c 5f73 7562 5f69 6d70  r * ggml_sub_imp
-00028ac0: 6c28 0a20 2020 2020 2020 2073 7472 7563  l(.        struc
-00028ad0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00028ae0: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-00028af0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00028b00: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
-00028b10: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00028b20: 202a 2062 2c0a 2020 2020 2020 2020 626f   * b,.        bo
-00028b30: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
-00028b40: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00028b50: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-00028b60: 6528 612c 2062 2929 3b0a 0a20 2020 2062  e(a, b));..    b
-00028b70: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-00028b80: 6c73 653b 0a0a 2020 2020 6966 2028 2169  lse;..    if (!i
-00028b90: 6e70 6c61 6365 2026 2620 2861 2d3e 6772  nplace && (a->gr
-00028ba0: 6164 207c 7c20 622d 3e67 7261 6429 2920  ad || b->grad)) 
-00028bb0: 7b0a 2020 2020 2020 2020 6973 5f6e 6f64  {.        is_nod
-00028bc0: 6520 3d20 7472 7565 3b0a 2020 2020 7d0a  e = true;.    }.
-00028bd0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-00028be0: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
-00028bf0: 203d 2069 6e70 6c61 6365 203f 2067 676d   = inplace ? ggm
-00028c00: 6c5f 7669 6577 5f74 656e 736f 7228 6374  l_view_tensor(ct
-00028c10: 782c 2061 2920 3a20 6767 6d6c 5f64 7570  x, a) : ggml_dup
-00028c20: 5f74 656e 736f 7228 6374 782c 2061 293b  _tensor(ctx, a);
-00028c30: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
-00028c40: 2020 203d 2047 474d 4c5f 4f50 5f53 5542     = GGML_OP_SUB
-00028c50: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
-00028c60: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
-00028c70: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-00028c80: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
-00028c90: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
-00028ca0: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
-00028cb0: 7375 6c74 2d3e 7372 6331 203d 2062 3b0a  sult->src1 = b;.
-00028cc0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-00028cd0: 6c74 3b0a 7d0a 0a73 7472 7563 7420 6767  lt;.}..struct gg
-00028ce0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
-00028cf0: 5f73 7562 280a 2020 2020 2020 2020 7374  _sub(.        st
-00028d00: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-00028d10: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
-00028d20: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00028d30: 736f 7220 2a20 612c 0a20 2020 2020 2020  sor * a,.       
-00028d40: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00028d50: 736f 7220 2a20 6229 207b 0a20 2020 2072  sor * b) {.    r
-00028d60: 6574 7572 6e20 6767 6d6c 5f73 7562 5f69  eturn ggml_sub_i
-00028d70: 6d70 6c28 6374 782c 2061 2c20 622c 2066  mpl(ctx, a, b, f
-00028d80: 616c 7365 293b 0a7d 0a0a 7374 7275 6374  alse);.}..struct
-00028d90: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-00028da0: 676d 6c5f 7375 625f 696e 706c 6163 6528  gml_sub_inplace(
-00028db0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00028dc0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00028dd0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-00028de0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00028df0: 2061 2c0a 2020 2020 2020 2020 7374 7275   a,.        stru
-00028e00: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00028e10: 2062 2920 7b0a 2020 2020 7265 7475 726e   b) {.    return
-00028e20: 2067 676d 6c5f 7375 625f 696d 706c 2863   ggml_sub_impl(c
-00028e30: 7478 2c20 612c 2062 2c20 7472 7565 293b  tx, a, b, true);
-00028e40: 0a7d 0a0a 2f2f 2067 676d 6c5f 6d75 6c0a  .}..// ggml_mul.
-00028e50: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-00028e60: 736f 7220 2a20 6767 6d6c 5f6d 756c 5f69  sor * ggml_mul_i
-00028e70: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
-00028e80: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-00028e90: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-00028ea0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00028eb0: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
-00028ec0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00028ed0: 6f72 202a 2062 2c0a 2020 2020 2020 2020  or * b,.        
-00028ee0: 626f 6f6c 2069 6e70 6c61 6365 2920 7b0a  bool inplace) {.
-00028ef0: 2020 2020 2f2f 2054 4f44 4f3a 2073 7570      // TODO: sup
-00028f00: 706f 7274 206c 6573 732d 7374 7269 6374  port less-strict
-00028f10: 2063 6f6e 7374 7261 696e 740a 2020 2020   constraint.    
-00028f20: 2f2f 2020 2020 2020 2047 474d 4c5f 4153  //       GGML_AS
-00028f30: 5345 5254 2867 676d 6c5f 6361 6e5f 7265  SERT(ggml_can_re
-00028f40: 7065 6174 2862 2c20 6129 293b 0a20 2020  peat(b, a));.   
-00028f50: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-00028f60: 6c5f 6361 6e5f 7265 7065 6174 5f72 6f77  l_can_repeat_row
-00028f70: 7328 622c 2061 2929 3b0a 0a20 2020 2062  s(b, a));..    b
-00028f80: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-00028f90: 6c73 653b 0a0a 2020 2020 6966 2028 2169  lse;..    if (!i
-00028fa0: 6e70 6c61 6365 2026 2620 2861 2d3e 6772  nplace && (a->gr
-00028fb0: 6164 207c 7c20 622d 3e67 7261 6429 2920  ad || b->grad)) 
-00028fc0: 7b0a 2020 2020 2020 2020 2f2f 2054 4f44  {.        // TOD
-00028fd0: 4f3a 2073 7570 706f 7274 2062 6163 6b77  O: support backw
-00028fe0: 6172 6420 7061 7373 2066 6f72 2062 726f  ard pass for bro
-00028ff0: 6164 6361 7374 696e 670a 2020 2020 2020  adcasting.      
-00029000: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00029010: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-00029020: 6528 612c 2062 2929 3b0a 2020 2020 2020  e(a, b));.      
-00029030: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
-00029040: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
-00029050: 2869 6e70 6c61 6365 2920 7b0a 2020 2020  (inplace) {.    
-00029060: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00029070: 6973 5f6e 6f64 6520 3d3d 2066 616c 7365  is_node == false
-00029080: 293b 0a20 2020 207d 0a0a 2020 2020 7374  );.    }..    st
-00029090: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000290a0: 202a 2072 6573 756c 7420 3d20 696e 706c   * result = inpl
-000290b0: 6163 6520 3f20 6767 6d6c 5f76 6965 775f  ace ? ggml_view_
-000290c0: 7465 6e73 6f72 2863 7478 2c20 6129 203a  tensor(ctx, a) :
-000290d0: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-000290e0: 2863 7478 2c20 6129 3b0a 0a20 2020 2072  (ctx, a);..    r
-000290f0: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
-00029100: 4d4c 5f4f 505f 4d55 4c3b 0a20 2020 2072  ML_OP_MUL;.    r
-00029110: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
-00029120: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
-00029130: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
-00029140: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
-00029150: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-00029160: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-00029170: 7263 3120 3d20 623b 0a0a 2020 2020 7265  rc1 = b;..    re
-00029180: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-00029190: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000291a0: 6f72 202a 2067 676d 6c5f 6d75 6c28 0a20  or * ggml_mul(. 
-000291b0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000291c0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+00027870: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
+00027880: 0a2f 2f20 6767 6d6c 5f64 7570 0a0a 7374  .// ggml_dup..st
+00027890: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000278a0: 202a 2067 676d 6c5f 6475 705f 696d 706c   * ggml_dup_impl
+000278b0: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+000278c0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+000278d0: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+000278e0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000278f0: 2a20 612c 0a20 2020 2020 2020 2062 6f6f  * a,.        boo
+00027900: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
+00027910: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
+00027920: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
+00027930: 2169 6e70 6c61 6365 2026 2620 2861 2d3e  !inplace && (a->
+00027940: 6772 6164 2929 207b 0a20 2020 2020 2020  grad)) {.       
+00027950: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
+00027960: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
+00027970: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00027980: 2072 6573 756c 7420 3d20 696e 706c 6163   result = inplac
+00027990: 6520 3f20 6767 6d6c 5f76 6965 775f 7465  e ? ggml_view_te
+000279a0: 6e73 6f72 2863 7478 2c20 6129 203a 2067  nsor(ctx, a) : g
+000279b0: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
+000279c0: 7478 2c20 6129 3b0a 0a20 2020 2072 6573  tx, a);..    res
+000279d0: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
+000279e0: 5f4f 505f 4455 503b 0a20 2020 2072 6573  _OP_DUP;.    res
+000279f0: 756c 742d 3e67 7261 6420 3d20 6973 5f6e  ult->grad = is_n
+00027a00: 6f64 6520 3f20 6767 6d6c 5f64 7570 5f74  ode ? ggml_dup_t
+00027a10: 656e 736f 7228 6374 782c 2072 6573 756c  ensor(ctx, resul
+00027a20: 7429 203a 204e 554c 4c3b 0a20 2020 2072  t) : NULL;.    r
+00027a30: 6573 756c 742d 3e73 7263 3020 3d20 613b  esult->src0 = a;
+00027a40: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+00027a50: 3120 3d20 4e55 4c4c 3b0a 0a20 2020 2072  1 = NULL;..    r
+00027a60: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
+00027a70: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+00027a80: 736f 7220 2a20 6767 6d6c 5f64 7570 280a  sor * ggml_dup(.
+00027a90: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00027aa0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00027ab0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+00027ac0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00027ad0: 6129 207b 0a20 2020 2072 6574 7572 6e20  a) {.    return 
+00027ae0: 6767 6d6c 5f64 7570 5f69 6d70 6c28 6374  ggml_dup_impl(ct
+00027af0: 782c 2061 2c20 6661 6c73 6529 3b0a 7d0a  x, a, false);.}.
+00027b00: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+00027b10: 736f 7220 2a20 6767 6d6c 5f64 7570 5f69  sor * ggml_dup_i
+00027b20: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
+00027b30: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+00027b40: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+00027b50: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00027b60: 656e 736f 7220 2a20 6129 207b 0a20 2020  ensor * a) {.   
+00027b70: 2072 6574 7572 6e20 6767 6d6c 5f64 7570   return ggml_dup
+00027b80: 5f69 6d70 6c28 6374 782c 2061 2c20 7472  _impl(ctx, a, tr
+00027b90: 7565 293b 0a7d 0a0a 2f2f 2067 676d 6c5f  ue);.}..// ggml_
+00027ba0: 6164 640a 0a73 7472 7563 7420 6767 6d6c  add..struct ggml
+00027bb0: 5f74 656e 736f 7220 2a20 6767 6d6c 5f61  _tensor * ggml_a
+00027bc0: 6464 5f69 6d70 6c28 0a20 2020 2020 2020  dd_impl(.       
+00027bd0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+00027be0: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+00027bf0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00027c00: 7465 6e73 6f72 202a 2061 2c0a 2020 2020  tensor * a,.    
+00027c10: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00027c20: 7465 6e73 6f72 202a 2062 2c0a 2020 2020  tensor * b,.    
+00027c30: 2020 2020 626f 6f6c 2069 6e70 6c61 6365      bool inplace
+00027c40: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+00027c50: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
+00027c60: 655f 7368 6170 6528 612c 2062 2929 3b0a  e_shape(a, b));.
+00027c70: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
+00027c80: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
+00027c90: 6966 2028 612d 3e67 7261 6420 7c7c 2062  if (a->grad || b
+00027ca0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00027cb0: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+00027cc0: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+00027cd0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00027ce0: 2a20 7265 7375 6c74 203d 2069 6e70 6c61  * result = inpla
+00027cf0: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
+00027d00: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
+00027d10: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00027d20: 6374 782c 2061 293b 0a0a 2020 2020 7265  ctx, a);..    re
+00027d30: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+00027d40: 4c5f 4f50 5f41 4444 3b0a 2020 2020 7265  L_OP_ADD;.    re
+00027d50: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
+00027d60: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
+00027d70: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
+00027d80: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
+00027d90: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
+00027da0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+00027db0: 6331 203d 2062 3b0a 0a20 2020 2072 6574  c1 = b;..    ret
+00027dc0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
+00027dd0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00027de0: 7220 2a20 6767 6d6c 5f61 6464 280a 2020  r * ggml_add(.  
+00027df0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00027e00: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+00027e10: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00027e20: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
+00027e30: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00027e40: 6767 6d6c 5f74 656e 736f 7220 2a20 6229  ggml_tensor * b)
+00027e50: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
+00027e60: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+00027e70: 2061 2c20 622c 2066 616c 7365 293b 0a7d   a, b, false);.}
+00027e80: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+00027e90: 6e73 6f72 202a 2067 676d 6c5f 6164 645f  nsor * ggml_add_
+00027ea0: 696e 706c 6163 6528 0a20 2020 2020 2020  inplace(.       
+00027eb0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+00027ec0: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+00027ed0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00027ee0: 7465 6e73 6f72 202a 2061 2c0a 2020 2020  tensor * a,.    
+00027ef0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00027f00: 7465 6e73 6f72 202a 2062 2920 7b0a 2020  tensor * b) {.  
+00027f10: 2020 7265 7475 726e 2067 676d 6c5f 6164    return ggml_ad
+00027f20: 645f 696d 706c 2863 7478 2c20 612c 2062  d_impl(ctx, a, b
+00027f30: 2c20 7472 7565 293b 0a7d 0a0a 2f2f 2067  , true);.}..// g
+00027f40: 676d 6c5f 6164 6431 0a0a 7374 7275 6374  gml_add1..struct
+00027f50: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+00027f60: 676d 6c5f 6164 6431 5f69 6d70 6c28 0a20  gml_add1_impl(. 
+00027f70: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00027f80: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+00027f90: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00027fa0: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
+00027fb0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00027fc0: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
+00027fd0: 2c0a 2020 2020 2020 2020 626f 6f6c 2069  ,.        bool i
+00027fe0: 6e70 6c61 6365 2920 7b0a 2020 2020 4747  nplace) {.    GG
+00027ff0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+00028000: 735f 7363 616c 6172 2862 2929 3b0a 2020  s_scalar(b));.  
+00028010: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+00028020: 6d6c 5f69 735f 7061 6464 6564 5f31 6428  ml_is_padded_1d(
+00028030: 6129 293b 0a0a 2020 2020 626f 6f6c 2069  a));..    bool i
+00028040: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
+00028050: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
+00028060: 207c 7c20 622d 3e67 7261 6429 207b 0a20   || b->grad) {. 
+00028070: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
+00028080: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
+00028090: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+000280a0: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
+000280b0: 696e 706c 6163 6520 3f20 6767 6d6c 5f76  inplace ? ggml_v
+000280c0: 6965 775f 7465 6e73 6f72 2863 7478 2c20  iew_tensor(ctx, 
+000280d0: 6129 203a 2067 676d 6c5f 6475 705f 7465  a) : ggml_dup_te
+000280e0: 6e73 6f72 2863 7478 2c20 6129 3b0a 0a20  nsor(ctx, a);.. 
+000280f0: 2020 2072 6573 756c 742d 3e6f 7020 2020     result->op   
+00028100: 3d20 4747 4d4c 5f4f 505f 4144 4431 3b0a  = GGML_OP_ADD1;.
+00028110: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
+00028120: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
+00028130: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
+00028140: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
+00028150: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+00028160: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
+00028170: 6c74 2d3e 7372 6331 203d 2062 3b0a 0a20  lt->src1 = b;.. 
+00028180: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00028190: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+000281a0: 5f74 656e 736f 7220 2a20 6767 6d6c 5f61  _tensor * ggml_a
+000281b0: 6464 3128 0a20 2020 2020 2020 2073 7472  dd1(.        str
+000281c0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+000281d0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+000281e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000281f0: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
+00028200: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00028210: 6f72 202a 2062 2920 7b0a 2020 2020 7265  or * b) {.    re
+00028220: 7475 726e 2067 676d 6c5f 6164 6431 5f69  turn ggml_add1_i
+00028230: 6d70 6c28 6374 782c 2061 2c20 622c 2066  mpl(ctx, a, b, f
+00028240: 616c 7365 293b 0a7d 0a0a 7374 7275 6374  alse);.}..struct
+00028250: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+00028260: 676d 6c5f 6164 6431 5f69 6e70 6c61 6365  gml_add1_inplace
+00028270: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+00028280: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00028290: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+000282a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000282b0: 2a20 612c 0a20 2020 2020 2020 2073 7472  * a,.        str
+000282c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000282d0: 2a20 6229 207b 0a20 2020 2072 6574 7572  * b) {.    retur
+000282e0: 6e20 6767 6d6c 5f61 6464 315f 696d 706c  n ggml_add1_impl
+000282f0: 2863 7478 2c20 612c 2062 2c20 7472 7565  (ctx, a, b, true
+00028300: 293b 0a7d 0a0a 2f2f 2067 676d 6c5f 6163  );.}..// ggml_ac
+00028310: 630a 0a73 7472 7563 7420 6767 6d6c 5f74  c..struct ggml_t
+00028320: 656e 736f 7220 2a20 6767 6d6c 5f61 6363  ensor * ggml_acc
+00028330: 5f69 6d70 6c28 0a20 2020 2020 2020 2073  _impl(.        s
+00028340: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+00028350: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+00028360: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00028370: 6e73 6f72 202a 2061 2c0a 2020 2020 2020  nsor * a,.      
+00028380: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00028390: 6e73 6f72 202a 2062 2c0a 2020 2020 2020  nsor * b,.      
+000283a0: 2020 7369 7a65 5f74 2020 2020 2020 2020    size_t        
+000283b0: 2020 2020 2020 206e 6231 2c0a 2020 2020         nb1,.    
+000283c0: 2020 2020 7369 7a65 5f74 2020 2020 2020      size_t      
+000283d0: 2020 2020 2020 2020 206e 6232 2c0a 2020           nb2,.  
+000283e0: 2020 2020 2020 7369 7a65 5f74 2020 2020        size_t    
+000283f0: 2020 2020 2020 2020 2020 206e 6233 2c0a             nb3,.
+00028400: 2020 2020 2020 2020 7369 7a65 5f74 2020          size_t  
+00028410: 2020 2020 2020 2020 2020 2020 206f 6666               off
+00028420: 7365 742c 0a20 2020 2020 2020 2062 6f6f  set,.        boo
+00028430: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
+00028440: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00028450: 6c5f 6e65 6c65 6d65 6e74 7328 6229 203c  l_nelements(b) <
+00028460: 3d20 6767 6d6c 5f6e 656c 656d 656e 7473  = ggml_nelements
+00028470: 2861 2929 3b0a 2020 2020 4747 4d4c 5f41  (a));.    GGML_A
+00028480: 5353 4552 5428 6767 6d6c 5f69 735f 636f  SSERT(ggml_is_co
+00028490: 6e74 6967 756f 7573 2861 2929 3b0a 2020  ntiguous(a));.  
+000284a0: 2020 4747 4d4c 5f41 5353 4552 5428 612d    GGML_ASSERT(a-
+000284b0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+000284c0: 5045 5f46 3332 293b 0a20 2020 2047 474d  PE_F32);.    GGM
+000284d0: 4c5f 4153 5345 5254 2862 2d3e 7479 7065  L_ASSERT(b->type
+000284e0: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
+000284f0: 3229 3b0a 0a20 2020 2062 6f6f 6c20 6973  2);..    bool is
+00028500: 5f6e 6f64 6520 3d20 6661 6c73 653b 0a0a  _node = false;..
+00028510: 2020 2020 6966 2028 2169 6e70 6c61 6365      if (!inplace
+00028520: 2026 2620 2861 2d3e 6772 6164 207c 7c20   && (a->grad || 
+00028530: 622d 3e67 7261 6429 2920 7b0a 2020 2020  b->grad)) {.    
+00028540: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
+00028550: 7565 3b0a 2020 2020 7d0a 0a20 2020 2073  ue;.    }..    s
+00028560: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00028570: 7220 2a20 7265 7375 6c74 203d 2069 6e70  r * result = inp
+00028580: 6c61 6365 203f 2067 676d 6c5f 7669 6577  lace ? ggml_view
+00028590: 5f74 656e 736f 7228 6374 782c 2061 2920  _tensor(ctx, a) 
+000285a0: 3a20 6767 6d6c 5f64 7570 5f74 656e 736f  : ggml_dup_tenso
+000285b0: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
+000285c0: 6767 6d6c 5f73 6372 6174 6368 5f73 6176  ggml_scratch_sav
+000285d0: 6528 6374 7829 3b0a 0a20 2020 2073 7472  e(ctx);..    str
+000285e0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000285f0: 2a20 6320 3d20 6767 6d6c 5f6e 6577 5f74  * c = ggml_new_t
+00028600: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
+00028610: 4d4c 5f54 5950 455f 4933 322c 2035 293b  ML_TYPE_I32, 5);
+00028620: 0a0a 2020 2020 2828 696e 7433 325f 7420  ..    ((int32_t 
+00028630: 2a29 2063 2d3e 6461 7461 295b 305d 203d  *) c->data)[0] =
+00028640: 206e 6231 3b0a 2020 2020 2828 696e 7433   nb1;.    ((int3
+00028650: 325f 7420 2a29 2063 2d3e 6461 7461 295b  2_t *) c->data)[
+00028660: 315d 203d 206e 6232 3b0a 2020 2020 2828  1] = nb2;.    ((
+00028670: 696e 7433 325f 7420 2a29 2063 2d3e 6461  int32_t *) c->da
+00028680: 7461 295b 325d 203d 206e 6233 3b0a 2020  ta)[2] = nb3;.  
+00028690: 2020 2828 696e 7433 325f 7420 2a29 2063    ((int32_t *) c
+000286a0: 2d3e 6461 7461 295b 335d 203d 206f 6666  ->data)[3] = off
+000286b0: 7365 743b 0a20 2020 2028 2869 6e74 3332  set;.    ((int32
+000286c0: 5f74 202a 2920 632d 3e64 6174 6129 5b34  _t *) c->data)[4
+000286d0: 5d20 3d20 696e 706c 6163 6520 3f20 3120  ] = inplace ? 1 
+000286e0: 3a20 303b 0a0a 2020 2020 6767 6d6c 5f73  : 0;..    ggml_s
+000286f0: 6372 6174 6368 5f6c 6f61 6428 6374 7829  cratch_load(ctx)
+00028700: 3b0a 0a20 2020 2072 6573 756c 742d 3e6f  ;..    result->o
+00028710: 7020 2020 3d20 4747 4d4c 5f4f 505f 4143  p   = GGML_OP_AC
+00028720: 433b 0a20 2020 2072 6573 756c 742d 3e67  C;.    result->g
+00028730: 7261 6420 3d20 6973 5f6e 6f64 6520 3f20  rad = is_node ? 
+00028740: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00028750: 6374 782c 2072 6573 756c 7429 203a 204e  ctx, result) : N
+00028760: 554c 4c3b 0a20 2020 2072 6573 756c 742d  ULL;.    result-
+00028770: 3e73 7263 3020 3d20 613b 0a20 2020 2072  >src0 = a;.    r
+00028780: 6573 756c 742d 3e73 7263 3120 3d20 623b  esult->src1 = b;
+00028790: 0a20 2020 2072 6573 756c 742d 3e6f 7074  .    result->opt
+000287a0: 5b30 5d20 3d20 633b 0a0a 2020 2020 7265  [0] = c;..    re
+000287b0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+000287c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000287d0: 6f72 202a 2067 676d 6c5f 6163 6328 0a20  or * ggml_acc(. 
+000287e0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+000287f0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+00028800: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00028810: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
+00028820: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00028830: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
+00028840: 2c0a 2020 2020 2020 2020 7369 7a65 5f74  ,.        size_t
+00028850: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00028860: 6231 2c0a 2020 2020 2020 2020 7369 7a65  b1,.        size
+00028870: 5f74 2020 2020 2020 2020 2020 2020 2020  _t              
+00028880: 206e 6232 2c0a 2020 2020 2020 2020 7369   nb2,.        si
+00028890: 7a65 5f74 2020 2020 2020 2020 2020 2020  ze_t            
+000288a0: 2020 206e 6233 2c0a 2020 2020 2020 2020     nb3,.        
+000288b0: 7369 7a65 5f74 2020 2020 2020 2020 2020  size_t          
+000288c0: 2020 2020 206f 6666 7365 7429 207b 0a20       offset) {. 
+000288d0: 2020 2072 6574 7572 6e20 6767 6d6c 5f61     return ggml_a
+000288e0: 6363 5f69 6d70 6c28 6374 782c 2061 2c20  cc_impl(ctx, a, 
+000288f0: 622c 206e 6231 2c20 6e62 322c 206e 6233  b, nb1, nb2, nb3
+00028900: 2c20 6f66 6673 6574 2c20 6661 6c73 6529  , offset, false)
+00028910: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+00028920: 5f74 656e 736f 7220 2a20 6767 6d6c 5f61  _tensor * ggml_a
+00028930: 6363 5f69 6e70 6c61 6365 280a 2020 2020  cc_inplace(.    
+00028940: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00028950: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+00028960: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00028970: 6d6c 5f74 656e 736f 7220 2a20 612c 0a20  ml_tensor * a,. 
+00028980: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00028990: 6d6c 5f74 656e 736f 7220 2a20 622c 0a20  ml_tensor * b,. 
+000289a0: 2020 2020 2020 2073 697a 655f 7420 2020         size_t   
+000289b0: 2020 2020 2020 2020 2020 2020 6e62 312c              nb1,
+000289c0: 0a20 2020 2020 2020 2073 697a 655f 7420  .        size_t 
+000289d0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+000289e0: 322c 0a20 2020 2020 2020 2073 697a 655f  2,.        size_
+000289f0: 7420 2020 2020 2020 2020 2020 2020 2020  t               
+00028a00: 6e62 332c 0a20 2020 2020 2020 2073 697a  nb3,.        siz
+00028a10: 655f 7420 2020 2020 2020 2020 2020 2020  e_t             
+00028a20: 2020 6f66 6673 6574 2920 7b0a 2020 2020    offset) {.    
+00028a30: 7265 7475 726e 2067 676d 6c5f 6163 635f  return ggml_acc_
+00028a40: 696d 706c 2863 7478 2c20 612c 2062 2c20  impl(ctx, a, b, 
+00028a50: 6e62 312c 206e 6232 2c20 6e62 332c 206f  nb1, nb2, nb3, o
+00028a60: 6666 7365 742c 2074 7275 6529 3b0a 7d0a  ffset, true);.}.
+00028a70: 0a2f 2f20 6767 6d6c 5f73 7562 0a0a 7374  .// ggml_sub..st
+00028a80: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00028a90: 202a 2067 676d 6c5f 7375 625f 696d 706c   * ggml_sub_impl
+00028aa0: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+00028ab0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00028ac0: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+00028ad0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00028ae0: 2a20 612c 0a20 2020 2020 2020 2073 7472  * a,.        str
+00028af0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00028b00: 2a20 622c 0a20 2020 2020 2020 2062 6f6f  * b,.        boo
+00028b10: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
+00028b20: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00028b30: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
+00028b40: 2861 2c20 6229 293b 0a0a 2020 2020 626f  (a, b));..    bo
+00028b50: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
+00028b60: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
+00028b70: 706c 6163 6520 2626 2028 612d 3e67 7261  place && (a->gra
+00028b80: 6420 7c7c 2062 2d3e 6772 6164 2929 207b  d || b->grad)) {
+00028b90: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
+00028ba0: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
+00028bb0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00028bc0: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
+00028bd0: 3d20 696e 706c 6163 6520 3f20 6767 6d6c  = inplace ? ggml
+00028be0: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
+00028bf0: 2c20 6129 203a 2067 676d 6c5f 6475 705f  , a) : ggml_dup_
+00028c00: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
+00028c10: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+00028c20: 2020 3d20 4747 4d4c 5f4f 505f 5355 423b    = GGML_OP_SUB;
+00028c30: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+00028c40: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+00028c50: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+00028c60: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+00028c70: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+00028c80: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+00028c90: 756c 742d 3e73 7263 3120 3d20 623b 0a0a  ult->src1 = b;..
+00028ca0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00028cb0: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
+00028cc0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+00028cd0: 7375 6228 0a20 2020 2020 2020 2073 7472  sub(.        str
+00028ce0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00028cf0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+00028d00: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00028d10: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
+00028d20: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00028d30: 6f72 202a 2062 2920 7b0a 2020 2020 7265  or * b) {.    re
+00028d40: 7475 726e 2067 676d 6c5f 7375 625f 696d  turn ggml_sub_im
+00028d50: 706c 2863 7478 2c20 612c 2062 2c20 6661  pl(ctx, a, b, fa
+00028d60: 6c73 6529 3b0a 7d0a 0a73 7472 7563 7420  lse);.}..struct 
+00028d70: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+00028d80: 6d6c 5f73 7562 5f69 6e70 6c61 6365 280a  ml_sub_inplace(.
+00028d90: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00028da0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00028db0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+00028dc0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00028dd0: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
+00028de0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00028df0: 6229 207b 0a20 2020 2072 6574 7572 6e20  b) {.    return 
+00028e00: 6767 6d6c 5f73 7562 5f69 6d70 6c28 6374  ggml_sub_impl(ct
+00028e10: 782c 2061 2c20 622c 2074 7275 6529 3b0a  x, a, b, true);.
+00028e20: 7d0a 0a2f 2f20 6767 6d6c 5f6d 756c 0a0a  }..// ggml_mul..
+00028e30: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00028e40: 6f72 202a 2067 676d 6c5f 6d75 6c5f 696d  or * ggml_mul_im
+00028e50: 706c 280a 2020 2020 2020 2020 7374 7275  pl(.        stru
+00028e60: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+00028e70: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+00028e80: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00028e90: 7220 2a20 612c 0a20 2020 2020 2020 2073  r * a,.        s
+00028ea0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00028eb0: 7220 2a20 622c 0a20 2020 2020 2020 2062  r * b,.        b
+00028ec0: 6f6f 6c20 696e 706c 6163 6529 207b 0a20  ool inplace) {. 
+00028ed0: 2020 202f 2f20 544f 444f 3a20 7375 7070     // TODO: supp
+00028ee0: 6f72 7420 6c65 7373 2d73 7472 6963 7420  ort less-strict 
+00028ef0: 636f 6e73 7472 6169 6e74 0a20 2020 202f  constraint.    /
+00028f00: 2f20 2020 2020 2020 4747 4d4c 5f41 5353  /       GGML_ASS
+00028f10: 4552 5428 6767 6d6c 5f63 616e 5f72 6570  ERT(ggml_can_rep
+00028f20: 6561 7428 622c 2061 2929 3b0a 2020 2020  eat(b, a));.    
+00028f30: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
+00028f40: 5f63 616e 5f72 6570 6561 745f 726f 7773  _can_repeat_rows
+00028f50: 2862 2c20 6129 293b 0a0a 2020 2020 626f  (b, a));..    bo
+00028f60: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
+00028f70: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
+00028f80: 706c 6163 6520 2626 2028 612d 3e67 7261  place && (a->gra
+00028f90: 6420 7c7c 2062 2d3e 6772 6164 2929 207b  d || b->grad)) {
+00028fa0: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
+00028fb0: 3a20 7375 7070 6f72 7420 6261 636b 7761  : support backwa
+00028fc0: 7264 2070 6173 7320 666f 7220 6272 6f61  rd pass for broa
+00028fd0: 6463 6173 7469 6e67 0a20 2020 2020 2020  dcasting.       
+00028fe0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00028ff0: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
+00029000: 2861 2c20 6229 293b 0a20 2020 2020 2020  (a, b));.       
+00029010: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
+00029020: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
+00029030: 696e 706c 6163 6529 207b 0a20 2020 2020  inplace) {.     
+00029040: 2020 2047 474d 4c5f 4153 5345 5254 2869     GGML_ASSERT(i
+00029050: 735f 6e6f 6465 203d 3d20 6661 6c73 6529  s_node == false)
+00029060: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+00029070: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00029080: 2a20 7265 7375 6c74 203d 2069 6e70 6c61  * result = inpla
+00029090: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
+000290a0: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
+000290b0: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+000290c0: 6374 782c 2061 293b 0a0a 2020 2020 7265  ctx, a);..    re
+000290d0: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+000290e0: 4c5f 4f50 5f4d 554c 3b0a 2020 2020 7265  L_OP_MUL;.    re
+000290f0: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
+00029100: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
+00029110: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
+00029120: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
+00029130: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
+00029140: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+00029150: 6331 203d 2062 3b0a 0a20 2020 2072 6574  c1 = b;..    ret
+00029160: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
+00029170: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00029180: 7220 2a20 6767 6d6c 5f6d 756c 280a 2020  r * ggml_mul(.  
+00029190: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+000291a0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+000291b0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000291c0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
 000291d0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
 000291e0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-000291f0: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
-00029200: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-00029210: 2062 2920 7b0a 2020 2020 7265 7475 726e   b) {.    return
-00029220: 2067 676d 6c5f 6d75 6c5f 696d 706c 2863   ggml_mul_impl(c
-00029230: 7478 2c20 612c 2062 2c20 6661 6c73 6529  tx, a, b, false)
-00029240: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
-00029250: 5f74 656e 736f 7220 2a20 6767 6d6c 5f6d  _tensor * ggml_m
-00029260: 756c 5f69 6e70 6c61 6365 280a 2020 2020  ul_inplace(.    
-00029270: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00029280: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+000291f0: 6229 207b 0a20 2020 2072 6574 7572 6e20  b) {.    return 
+00029200: 6767 6d6c 5f6d 756c 5f69 6d70 6c28 6374  ggml_mul_impl(ct
+00029210: 782c 2061 2c20 622c 2066 616c 7365 293b  x, a, b, false);
+00029220: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
+00029230: 7465 6e73 6f72 202a 2067 676d 6c5f 6d75  tensor * ggml_mu
+00029240: 6c5f 696e 706c 6163 6528 0a20 2020 2020  l_inplace(.     
+00029250: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+00029260: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+00029270: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00029280: 6c5f 7465 6e73 6f72 2020 2a20 612c 0a20  l_tensor  * a,. 
 00029290: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000292a0: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
-000292b0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000292c0: 676d 6c5f 7465 6e73 6f72 2020 2a20 6229  gml_tensor  * b)
-000292d0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-000292e0: 6d6c 5f6d 756c 5f69 6d70 6c28 6374 782c  ml_mul_impl(ctx,
-000292f0: 2061 2c20 622c 2074 7275 6529 3b0a 7d0a   a, b, true);.}.
-00029300: 0a2f 2f20 6767 6d6c 5f64 6976 0a0a 7374  .// ggml_div..st
-00029310: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00029320: 202a 2067 676d 6c5f 6469 765f 696d 706c   * ggml_div_impl
-00029330: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-00029340: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00029350: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-00029360: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00029370: 2a20 612c 0a20 2020 2020 2020 2073 7472  * a,.        str
-00029380: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00029390: 2a20 622c 0a20 2020 2020 2020 2062 6f6f  * b,.        boo
-000293a0: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
-000293b0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-000293c0: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
-000293d0: 2861 2c20 6229 293b 0a0a 2020 2020 626f  (a, b));..    bo
-000293e0: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-000293f0: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
-00029400: 706c 6163 6520 2626 2028 612d 3e67 7261  place && (a->gra
-00029410: 6420 7c7c 2062 2d3e 6772 6164 2929 207b  d || b->grad)) {
-00029420: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
-00029430: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
-00029440: 2020 2020 6966 2028 696e 706c 6163 6529      if (inplace)
-00029450: 207b 0a20 2020 2020 2020 2047 474d 4c5f   {.        GGML_
-00029460: 4153 5345 5254 2869 735f 6e6f 6465 203d  ASSERT(is_node =
-00029470: 3d20 6661 6c73 6529 3b0a 2020 2020 7d0a  = false);.    }.
-00029480: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-00029490: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
-000294a0: 203d 2069 6e70 6c61 6365 203f 2067 676d   = inplace ? ggm
-000294b0: 6c5f 7669 6577 5f74 656e 736f 7228 6374  l_view_tensor(ct
-000294c0: 782c 2061 2920 3a20 6767 6d6c 5f64 7570  x, a) : ggml_dup
-000294d0: 5f74 656e 736f 7228 6374 782c 2061 293b  _tensor(ctx, a);
-000294e0: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
-000294f0: 2020 203d 2047 474d 4c5f 4f50 5f44 4956     = GGML_OP_DIV
-00029500: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
-00029510: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
-00029520: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-00029530: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
-00029540: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
-00029550: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
-00029560: 7375 6c74 2d3e 7372 6331 203d 2062 3b0a  sult->src1 = b;.
-00029570: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-00029580: 6c74 3b0a 7d0a 0a73 7472 7563 7420 6767  lt;.}..struct gg
-00029590: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
-000295a0: 5f64 6976 280a 2020 2020 2020 2020 7374  _div(.        st
-000295b0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-000295c0: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+000292a0: 6d6c 5f74 656e 736f 7220 202a 2062 2920  ml_tensor  * b) 
+000292b0: 7b0a 2020 2020 7265 7475 726e 2067 676d  {.    return ggm
+000292c0: 6c5f 6d75 6c5f 696d 706c 2863 7478 2c20  l_mul_impl(ctx, 
+000292d0: 612c 2062 2c20 7472 7565 293b 0a7d 0a0a  a, b, true);.}..
+000292e0: 2f2f 2067 676d 6c5f 6469 760a 0a73 7472  // ggml_div..str
+000292f0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00029300: 2a20 6767 6d6c 5f64 6976 5f69 6d70 6c28  * ggml_div_impl(
+00029310: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00029320: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+00029330: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+00029340: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00029350: 2061 2c0a 2020 2020 2020 2020 7374 7275   a,.        stru
+00029360: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00029370: 2062 2c0a 2020 2020 2020 2020 626f 6f6c   b,.        bool
+00029380: 2069 6e70 6c61 6365 2920 7b0a 2020 2020   inplace) {.    
+00029390: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
+000293a0: 5f61 7265 5f73 616d 655f 7368 6170 6528  _are_same_shape(
+000293b0: 612c 2062 2929 3b0a 0a20 2020 2062 6f6f  a, b));..    boo
+000293c0: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
+000293d0: 653b 0a0a 2020 2020 6966 2028 2169 6e70  e;..    if (!inp
+000293e0: 6c61 6365 2026 2620 2861 2d3e 6772 6164  lace && (a->grad
+000293f0: 207c 7c20 622d 3e67 7261 6429 2920 7b0a   || b->grad)) {.
+00029400: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
+00029410: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
+00029420: 2020 2069 6620 2869 6e70 6c61 6365 2920     if (inplace) 
+00029430: 7b0a 2020 2020 2020 2020 4747 4d4c 5f41  {.        GGML_A
+00029440: 5353 4552 5428 6973 5f6e 6f64 6520 3d3d  SSERT(is_node ==
+00029450: 2066 616c 7365 293b 0a20 2020 207d 0a0a   false);.    }..
+00029460: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00029470: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
+00029480: 3d20 696e 706c 6163 6520 3f20 6767 6d6c  = inplace ? ggml
+00029490: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
+000294a0: 2c20 6129 203a 2067 676d 6c5f 6475 705f  , a) : ggml_dup_
+000294b0: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
+000294c0: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+000294d0: 2020 3d20 4747 4d4c 5f4f 505f 4449 563b    = GGML_OP_DIV;
+000294e0: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+000294f0: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+00029500: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+00029510: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+00029520: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+00029530: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+00029540: 756c 742d 3e73 7263 3120 3d20 623b 0a0a  ult->src1 = b;..
+00029550: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00029560: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
+00029570: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+00029580: 6469 7628 0a20 2020 2020 2020 2073 7472  div(.        str
+00029590: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+000295a0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+000295b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000295c0: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
 000295d0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000295e0: 736f 7220 202a 2061 2c0a 2020 2020 2020  sor  * a,.      
-000295f0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00029600: 6e73 6f72 2020 2a20 6229 207b 0a20 2020  nsor  * b) {.   
-00029610: 2072 6574 7572 6e20 6767 6d6c 5f64 6976   return ggml_div
-00029620: 5f69 6d70 6c28 6374 782c 2061 2c20 622c  _impl(ctx, a, b,
-00029630: 2066 616c 7365 293b 0a7d 0a0a 7374 7275   false);.}..stru
-00029640: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00029650: 2067 676d 6c5f 6469 765f 696e 706c 6163   ggml_div_inplac
-00029660: 6528 0a20 2020 2020 2020 2073 7472 7563  e(.        struc
-00029670: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00029680: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+000295e0: 736f 7220 202a 2062 2920 7b0a 2020 2020  sor  * b) {.    
+000295f0: 7265 7475 726e 2067 676d 6c5f 6469 765f  return ggml_div_
+00029600: 696d 706c 2863 7478 2c20 612c 2062 2c20  impl(ctx, a, b, 
+00029610: 6661 6c73 6529 3b0a 7d0a 0a73 7472 7563  false);.}..struc
+00029620: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00029630: 6767 6d6c 5f64 6976 5f69 6e70 6c61 6365  ggml_div_inplace
+00029640: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+00029650: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00029660: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+00029670: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00029680: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
 00029690: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000296a0: 2020 2a20 612c 0a20 2020 2020 2020 2073    * a,.        s
-000296b0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000296c0: 7220 202a 2062 2920 7b0a 2020 2020 7265  r  * b) {.    re
-000296d0: 7475 726e 2067 676d 6c5f 6469 765f 696d  turn ggml_div_im
-000296e0: 706c 2863 7478 2c20 612c 2062 2c20 7472  pl(ctx, a, b, tr
-000296f0: 7565 293b 0a7d 0a0a 2f2f 2067 676d 6c5f  ue);.}..// ggml_
-00029700: 7371 720a 0a73 7472 7563 7420 6767 6d6c  sqr..struct ggml
-00029710: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
-00029720: 7172 5f69 6d70 6c28 0a20 2020 2020 2020  qr_impl(.       
-00029730: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-00029740: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-00029750: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00029760: 7465 6e73 6f72 202a 2061 2c0a 2020 2020  tensor * a,.    
-00029770: 2020 2020 626f 6f6c 2069 6e70 6c61 6365      bool inplace
-00029780: 2920 7b0a 2020 2020 626f 6f6c 2069 735f  ) {.    bool is_
-00029790: 6e6f 6465 203d 2066 616c 7365 3b0a 0a20  node = false;.. 
-000297a0: 2020 2069 6620 2821 696e 706c 6163 6520     if (!inplace 
-000297b0: 2626 2028 612d 3e67 7261 6429 2920 7b0a  && (a->grad)) {.
-000297c0: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
-000297d0: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
-000297e0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-000297f0: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
-00029800: 2069 6e70 6c61 6365 203f 2067 676d 6c5f   inplace ? ggml_
-00029810: 7669 6577 5f74 656e 736f 7228 6374 782c  view_tensor(ctx,
-00029820: 2061 2920 3a20 6767 6d6c 5f64 7570 5f74   a) : ggml_dup_t
-00029830: 656e 736f 7228 6374 782c 2061 293b 0a0a  ensor(ctx, a);..
-00029840: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-00029850: 203d 2047 474d 4c5f 4f50 5f53 5152 3b0a   = GGML_OP_SQR;.
-00029860: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
-00029870: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
-00029880: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
-00029890: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
-000298a0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-000298b0: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
-000298c0: 6c74 2d3e 7372 6331 203d 204e 554c 4c3b  lt->src1 = NULL;
-000298d0: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
-000298e0: 756c 743b 0a7d 0a0a 7374 7275 6374 2067  ult;.}..struct g
-000298f0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-00029900: 6c5f 7371 7228 0a20 2020 2020 2020 2073  l_sqr(.        s
-00029910: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00029920: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00029930: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00029940: 6e73 6f72 2020 2a20 6129 207b 0a20 2020  nsor  * a) {.   
-00029950: 2072 6574 7572 6e20 6767 6d6c 5f73 7172   return ggml_sqr
-00029960: 5f69 6d70 6c28 6374 782c 2061 2c20 6661  _impl(ctx, a, fa
-00029970: 6c73 6529 3b0a 7d0a 0a73 7472 7563 7420  lse);.}..struct 
-00029980: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-00029990: 6d6c 5f73 7172 5f69 6e70 6c61 6365 280a  ml_sqr_inplace(.
-000299a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000299b0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-000299c0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-000299d0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-000299e0: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
-000299f0: 2067 676d 6c5f 7371 725f 696d 706c 2863   ggml_sqr_impl(c
-00029a00: 7478 2c20 612c 2074 7275 6529 3b0a 7d0a  tx, a, true);.}.
-00029a10: 0a2f 2f20 6767 6d6c 5f73 7172 740a 0a73  .// ggml_sqrt..s
-00029a20: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00029a30: 7220 2a20 6767 6d6c 5f73 7172 745f 696d  r * ggml_sqrt_im
-00029a40: 706c 280a 2020 2020 2020 2020 7374 7275  pl(.        stru
-00029a50: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00029a60: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-00029a70: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00029a80: 7220 2a20 612c 0a20 2020 2020 2020 2062  r * a,.        b
-00029a90: 6f6f 6c20 696e 706c 6163 6529 207b 0a20  ool inplace) {. 
-00029aa0: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
-00029ab0: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
-00029ac0: 2028 2169 6e70 6c61 6365 2026 2620 2861   (!inplace && (a
-00029ad0: 2d3e 6772 6164 2929 207b 0a20 2020 2020  ->grad)) {.     
-00029ae0: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
-00029af0: 653b 0a20 2020 207d 0a0a 2020 2020 7374  e;.    }..    st
-00029b00: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00029b10: 202a 2072 6573 756c 7420 3d20 696e 706c   * result = inpl
-00029b20: 6163 6520 3f20 6767 6d6c 5f76 6965 775f  ace ? ggml_view_
-00029b30: 7465 6e73 6f72 2863 7478 2c20 6129 203a  tensor(ctx, a) :
-00029b40: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-00029b50: 2863 7478 2c20 6129 3b0a 0a20 2020 2072  (ctx, a);..    r
-00029b60: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
-00029b70: 4d4c 5f4f 505f 5351 5254 3b0a 2020 2020  ML_OP_SQRT;.    
-00029b80: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
-00029b90: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
-00029ba0: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
-00029bb0: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
-00029bc0: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
-00029bd0: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
-00029be0: 7372 6331 203d 204e 554c 4c3b 0a0a 2020  src1 = NULL;..  
-00029bf0: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
-00029c00: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-00029c10: 7465 6e73 6f72 202a 2067 676d 6c5f 7371  tensor * ggml_sq
-00029c20: 7274 280a 2020 2020 2020 2020 7374 7275  rt(.        stru
-00029c30: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00029c40: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-00029c50: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00029c60: 7220 202a 2061 2920 7b0a 2020 2020 7265  r  * a) {.    re
-00029c70: 7475 726e 2067 676d 6c5f 7371 7274 5f69  turn ggml_sqrt_i
-00029c80: 6d70 6c28 6374 782c 2061 2c20 6661 6c73  mpl(ctx, a, fals
-00029c90: 6529 3b0a 7d0a 0a73 7472 7563 7420 6767  e);.}..struct gg
-00029ca0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
-00029cb0: 5f73 7172 745f 696e 706c 6163 6528 0a20  _sqrt_inplace(. 
-00029cc0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00029cd0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00029ce0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00029cf0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-00029d00: 6129 207b 0a20 2020 2072 6574 7572 6e20  a) {.    return 
-00029d10: 6767 6d6c 5f73 7172 745f 696d 706c 2863  ggml_sqrt_impl(c
-00029d20: 7478 2c20 612c 2074 7275 6529 3b0a 7d0a  tx, a, true);.}.
-00029d30: 0a0a 2f2f 2067 676d 6c5f 6c6f 670a 0a73  ..// ggml_log..s
-00029d40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00029d50: 7220 2a20 6767 6d6c 5f6c 6f67 5f69 6d70  r * ggml_log_imp
-00029d60: 6c28 0a20 2020 2020 2020 2073 7472 7563  l(.        struc
-00029d70: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00029d80: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-00029d90: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00029da0: 2020 2a20 612c 0a20 2020 2020 2020 2062    * a,.        b
-00029db0: 6f6f 6c20 696e 706c 6163 6529 207b 0a20  ool inplace) {. 
-00029dc0: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
-00029dd0: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
-00029de0: 2028 2169 6e70 6c61 6365 2026 2620 2861   (!inplace && (a
-00029df0: 2d3e 6772 6164 2929 207b 0a20 2020 2020  ->grad)) {.     
-00029e00: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
-00029e10: 653b 0a20 2020 207d 0a0a 2020 2020 7374  e;.    }..    st
-00029e20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00029e30: 202a 2072 6573 756c 7420 3d20 696e 706c   * result = inpl
-00029e40: 6163 6520 3f20 6767 6d6c 5f76 6965 775f  ace ? ggml_view_
-00029e50: 7465 6e73 6f72 2863 7478 2c20 6129 203a  tensor(ctx, a) :
-00029e60: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-00029e70: 2863 7478 2c20 6129 3b0a 0a20 2020 2072  (ctx, a);..    r
-00029e80: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
-00029e90: 4d4c 5f4f 505f 4c4f 473b 0a20 2020 2072  ML_OP_LOG;.    r
-00029ea0: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
-00029eb0: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
-00029ec0: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
-00029ed0: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
-00029ee0: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-00029ef0: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-00029f00: 7263 3120 3d20 4e55 4c4c 3b0a 0a20 2020  rc1 = NULL;..   
-00029f10: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-00029f20: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
-00029f30: 656e 736f 7220 2a20 6767 6d6c 5f6c 6f67  ensor * ggml_log
-00029f40: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-00029f50: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00029f60: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-00029f70: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00029f80: 202a 2061 2920 7b0a 2020 2020 7265 7475   * a) {.    retu
-00029f90: 726e 2067 676d 6c5f 6c6f 675f 696d 706c  rn ggml_log_impl
-00029fa0: 2863 7478 2c20 612c 2066 616c 7365 293b  (ctx, a, false);
-00029fb0: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-00029fc0: 7465 6e73 6f72 202a 2067 676d 6c5f 6c6f  tensor * ggml_lo
-00029fd0: 675f 696e 706c 6163 6528 0a20 2020 2020  g_inplace(.     
-00029fe0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00029ff0: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0002a000: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0002a010: 6c5f 7465 6e73 6f72 2020 2a20 6129 207b  l_tensor  * a) {
-0002a020: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
-0002a030: 5f6c 6f67 5f69 6d70 6c28 6374 782c 2061  _log_impl(ctx, a
-0002a040: 2c20 7472 7565 293b 0a7d 0a0a 2f2f 2067  , true);.}..// g
-0002a050: 676d 6c5f 7375 6d0a 0a73 7472 7563 7420  gml_sum..struct 
-0002a060: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-0002a070: 6d6c 5f73 756d 280a 2020 2020 2020 2020  ml_sum(.        
-0002a080: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0002a090: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0002a0a0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002a0b0: 656e 736f 7220 2a20 6129 207b 0a20 2020  ensor * a) {.   
-0002a0c0: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
-0002a0d0: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
-0002a0e0: 612d 3e67 7261 6429 207b 0a20 2020 2020  a->grad) {.     
-0002a0f0: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
-0002a100: 653b 0a20 2020 207d 0a0a 2020 2020 7374  e;.    }..    st
-0002a110: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002a120: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
-0002a130: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
-0002a140: 7478 2c20 612d 3e74 7970 652c 2031 293b  tx, a->type, 1);
-0002a150: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
-0002a160: 2020 203d 2047 474d 4c5f 4f50 5f53 554d     = GGML_OP_SUM
-0002a170: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
-0002a180: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
-0002a190: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-0002a1a0: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
-0002a1b0: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
-0002a1c0: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
-0002a1d0: 7375 6c74 2d3e 7372 6331 203d 204e 554c  sult->src1 = NUL
-0002a1e0: 4c3b 0a0a 2020 2020 7265 7475 726e 2072  L;..    return r
-0002a1f0: 6573 756c 743b 0a7d 0a0a 0a2f 2f20 6767  esult;.}...// gg
-0002a200: 6d6c 5f73 756d 5f72 6f77 730a 0a73 7472  ml_sum_rows..str
-0002a210: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002a220: 2a20 6767 6d6c 5f73 756d 5f72 6f77 7328  * ggml_sum_rows(
-0002a230: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0002a240: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-0002a250: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-0002a260: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0002a270: 2061 2920 7b0a 2020 2020 626f 6f6c 2069   a) {.    bool i
-0002a280: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
-0002a290: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
-0002a2a0: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
-0002a2b0: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-0002a2c0: 7d0a 0a20 2020 2069 6e74 3634 5f74 206e  }..    int64_t n
-0002a2d0: 655b 345d 203d 207b 312c 312c 312c 317d  e[4] = {1,1,1,1}
-0002a2e0: 3b0a 2020 2020 666f 7220 2869 6e74 2069  ;.    for (int i
-0002a2f0: 3d31 3b20 693c 612d 3e6e 5f64 696d 733b  =1; i<a->n_dims;
-0002a300: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-0002a310: 6e65 5b69 5d20 3d20 612d 3e6e 655b 695d  ne[i] = a->ne[i]
-0002a320: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
-0002a330: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002a340: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
-0002a350: 6e65 775f 7465 6e73 6f72 2863 7478 2c20  new_tensor(ctx, 
-0002a360: 612d 3e74 7970 652c 2061 2d3e 6e5f 6469  a->type, a->n_di
-0002a370: 6d73 2c20 6e65 293b 0a0a 2020 2020 7265  ms, ne);..    re
-0002a380: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-0002a390: 4c5f 4f50 5f53 554d 5f52 4f57 533b 0a20  L_OP_SUM_ROWS;. 
-0002a3a0: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
-0002a3b0: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
-0002a3c0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-0002a3d0: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
-0002a3e0: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-0002a3f0: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
-0002a400: 742d 3e73 7263 3120 3d20 4e55 4c4c 3b0a  t->src1 = NULL;.
-0002a410: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-0002a420: 6c74 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f6d  lt;.}..// ggml_m
-0002a430: 6561 6e0a 0a73 7472 7563 7420 6767 6d6c  ean..struct ggml
-0002a440: 5f74 656e 736f 7220 2a20 6767 6d6c 5f6d  _tensor * ggml_m
-0002a450: 6561 6e28 0a20 2020 2020 2020 2073 7472  ean(.        str
-0002a460: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0002a470: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0002a480: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002a490: 6f72 202a 2061 2920 7b0a 2020 2020 626f  or * a) {.    bo
-0002a4a0: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-0002a4b0: 7365 3b0a 0a20 2020 2069 6620 2861 2d3e  se;..    if (a->
-0002a4c0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0002a4d0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0002a4e0: 6529 3b20 2f2f 2054 4f44 4f3a 2069 6d70  e); // TODO: imp
-0002a4f0: 6c65 6d65 6e74 0a20 2020 2020 2020 2069  lement.        i
-0002a500: 735f 6e6f 6465 203d 2074 7275 653b 0a20  s_node = true;. 
-0002a510: 2020 207d 0a0a 2020 2020 696e 7436 345f     }..    int64_
-0002a520: 7420 6e65 5b47 474d 4c5f 4d41 585f 4449  t ne[GGML_MAX_DI
-0002a530: 4d53 5d20 3d20 7b20 312c 2061 2d3e 6e65  MS] = { 1, a->ne
-0002a540: 5b31 5d2c 2061 2d3e 6e65 5b32 5d2c 2061  [1], a->ne[2], a
-0002a550: 2d3e 6e65 5b33 5d20 7d3b 0a20 2020 2073  ->ne[3] };.    s
-0002a560: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002a570: 7220 2a20 7265 7375 6c74 203d 2067 676d  r * result = ggm
-0002a580: 6c5f 6e65 775f 7465 6e73 6f72 2863 7478  l_new_tensor(ctx
-0002a590: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
-0002a5a0: 2061 2d3e 6e5f 6469 6d73 2c20 6e65 293b   a->n_dims, ne);
-0002a5b0: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
-0002a5c0: 2020 203d 2047 474d 4c5f 4f50 5f4d 4541     = GGML_OP_MEA
-0002a5d0: 4e3b 0a20 2020 2072 6573 756c 742d 3e67  N;.    result->g
-0002a5e0: 7261 6420 3d20 6973 5f6e 6f64 6520 3f20  rad = is_node ? 
-0002a5f0: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
-0002a600: 6374 782c 2072 6573 756c 7429 203a 204e  ctx, result) : N
-0002a610: 554c 4c3b 0a20 2020 2072 6573 756c 742d  ULL;.    result-
-0002a620: 3e73 7263 3020 3d20 613b 0a20 2020 2072  >src0 = a;.    r
-0002a630: 6573 756c 742d 3e73 7263 3120 3d20 4e55  esult->src1 = NU
-0002a640: 4c4c 3b0a 0a20 2020 2072 6574 7572 6e20  LL;..    return 
-0002a650: 7265 7375 6c74 3b0a 7d0a 0a2f 2f20 6767  result;.}..// gg
-0002a660: 6d6c 5f72 6570 6561 740a 0a73 7472 7563  ml_repeat..struc
-0002a670: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0002a680: 6767 6d6c 5f72 6570 6561 7428 0a20 2020  ggml_repeat(.   
-0002a690: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002a6a0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002a6b0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002a6c0: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
-0002a6d0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002a6e0: 676d 6c5f 7465 6e73 6f72 202a 2062 2920  gml_tensor * b) 
-0002a6f0: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-0002a700: 5428 6767 6d6c 5f63 616e 5f72 6570 6561  T(ggml_can_repea
-0002a710: 7428 612c 2062 2929 3b0a 0a20 2020 2062  t(a, b));..    b
-0002a720: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-0002a730: 6c73 653b 0a0a 2020 2020 6966 2028 612d  lse;..    if (a-
-0002a740: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0002a750: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
-0002a760: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-0002a770: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
-0002a780: 6170 6528 612c 2062 2920 2626 2021 6973  ape(a, b) && !is
-0002a790: 5f6e 6f64 6529 207b 0a20 2020 2020 2020  _node) {.       
-0002a7a0: 2072 6574 7572 6e20 613b 0a20 2020 207d   return a;.    }
-0002a7b0: 0a0a 2020 2020 7374 7275 6374 2067 676d  ..    struct ggm
-0002a7c0: 6c5f 7465 6e73 6f72 202a 2072 6573 756c  l_tensor * resul
-0002a7d0: 7420 3d20 6767 6d6c 5f6e 6577 5f74 656e  t = ggml_new_ten
-0002a7e0: 736f 7228 6374 782c 2061 2d3e 7479 7065  sor(ctx, a->type
-0002a7f0: 2c20 622d 3e6e 5f64 696d 732c 2062 2d3e  , b->n_dims, b->
-0002a800: 6e65 293b 0a0a 2020 2020 7265 7375 6c74  ne);..    result
-0002a810: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-0002a820: 5f52 4550 4541 543b 0a20 2020 2072 6573  _REPEAT;.    res
-0002a830: 756c 742d 3e67 7261 6420 3d20 6973 5f6e  ult->grad = is_n
-0002a840: 6f64 6520 3f20 6767 6d6c 5f64 7570 5f74  ode ? ggml_dup_t
-0002a850: 656e 736f 7228 6374 782c 2072 6573 756c  ensor(ctx, resul
-0002a860: 7429 203a 204e 554c 4c3b 0a20 2020 2072  t) : NULL;.    r
-0002a870: 6573 756c 742d 3e73 7263 3020 3d20 613b  esult->src0 = a;
-0002a880: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-0002a890: 3120 3d20 623b 0a0a 2020 2020 7265 7475  1 = b;..    retu
-0002a8a0: 726e 2072 6573 756c 743b 0a7d 0a0a 2f2f  rn result;.}..//
-0002a8b0: 2067 676d 6c5f 7265 7065 6174 5f62 6163   ggml_repeat_bac
-0002a8c0: 6b0a 0a73 7472 7563 7420 6767 6d6c 5f74  k..struct ggml_t
-0002a8d0: 656e 736f 7220 2a20 6767 6d6c 5f72 6570  ensor * ggml_rep
-0002a8e0: 6561 745f 6261 636b 280a 2020 2020 2020  eat_back(.      
-0002a8f0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-0002a900: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
-0002a910: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002a920: 5f74 656e 736f 7220 2a20 612c 0a20 2020  _tensor * a,.   
-0002a930: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002a940: 5f74 656e 736f 7220 2a20 6229 207b 0a20  _tensor * b) {. 
-0002a950: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-0002a960: 676d 6c5f 6361 6e5f 7265 7065 6174 2862  gml_can_repeat(b
-0002a970: 2c20 6129 293b 0a0a 2020 2020 626f 6f6c  , a));..    bool
-0002a980: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
-0002a990: 3b0a 0a20 2020 2069 6620 2861 2d3e 6772  ;..    if (a->gr
-0002a9a0: 6164 2920 7b0a 2020 2020 2020 2020 6973  ad) {.        is
-0002a9b0: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
-0002a9c0: 2020 7d0a 0a20 2020 2069 6620 2867 676d    }..    if (ggm
-0002a9d0: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
-0002a9e0: 2861 2c20 6229 2026 2620 2169 735f 6e6f  (a, b) && !is_no
-0002a9f0: 6465 2920 7b0a 2020 2020 2020 2020 7265  de) {.        re
-0002aa00: 7475 726e 2061 3b0a 2020 2020 7d0a 0a20  turn a;.    }.. 
-0002aa10: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002aa20: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
-0002aa30: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-0002aa40: 2863 7478 2c20 612d 3e74 7970 652c 2062  (ctx, a->type, b
-0002aa50: 2d3e 6e5f 6469 6d73 2c20 622d 3e6e 6529  ->n_dims, b->ne)
-0002aa60: 3b0a 0a20 2020 2072 6573 756c 742d 3e6f  ;..    result->o
-0002aa70: 7020 2020 3d20 4747 4d4c 5f4f 505f 5245  p   = GGML_OP_RE
-0002aa80: 5045 4154 5f42 4143 4b3b 0a20 2020 2072  PEAT_BACK;.    r
-0002aa90: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
-0002aaa0: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
-0002aab0: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
-0002aac0: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
-0002aad0: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-0002aae0: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-0002aaf0: 7263 3120 3d20 623b 0a0a 2020 2020 7265  rc1 = b;..    re
-0002ab00: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-0002ab10: 2369 6e63 6c75 6465 2022 6767 6d6c 2f67  #include "ggml/g
-0002ab20: 676d 6c2d 6767 6c6c 6d2e 6322 0a0a 2f2f  gml-ggllm.c"..//
-0002ab30: 2067 676d 6c5f 6162 730a 0a73 7472 7563   ggml_abs..struc
-0002ab40: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0002ab50: 6767 6d6c 5f61 6273 5f69 6d70 6c28 0a20  ggml_abs_impl(. 
-0002ab60: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0002ab70: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0002ab80: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0002ab90: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
-0002aba0: 2c0a 2020 2020 2020 2020 626f 6f6c 2069  ,.        bool i
-0002abb0: 6e70 6c61 6365 2920 7b0a 2020 2020 626f  nplace) {.    bo
-0002abc0: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-0002abd0: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
-0002abe0: 706c 6163 6520 2626 2028 612d 3e67 7261  place && (a->gra
-0002abf0: 6429 2920 7b0a 2020 2020 2020 2020 6973  d)) {.        is
-0002ac00: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
-0002ac10: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
-0002ac20: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0002ac30: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
-0002ac40: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
-0002ac50: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
-0002ac60: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-0002ac70: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
-0002ac80: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-0002ac90: 5f41 4253 3b0a 2020 2020 7265 7375 6c74  _ABS;.    result
-0002aca0: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
-0002acb0: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
-0002acc0: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
-0002acd0: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
-0002ace0: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
-0002acf0: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
-0002ad00: 204e 554c 4c3b 0a0a 2020 2020 7265 7475   NULL;..    retu
-0002ad10: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
-0002ad20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002ad30: 202a 2067 676d 6c5f 6162 7328 0a20 2020   * ggml_abs(.   
-0002ad40: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002ad50: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002ad60: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002ad70: 676d 6c5f 7465 6e73 6f72 2020 2a20 6129  gml_tensor  * a)
-0002ad80: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-0002ad90: 6d6c 5f61 6273 5f69 6d70 6c28 6374 782c  ml_abs_impl(ctx,
-0002ada0: 2061 2c20 6661 6c73 6529 3b0a 7d0a 0a73   a, false);.}..s
-0002adb0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002adc0: 7220 2a20 6767 6d6c 5f61 6273 5f69 6e70  r * ggml_abs_inp
-0002add0: 6c61 6365 280a 2020 2020 2020 2020 7374  lace(.        st
-0002ade0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-0002adf0: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
-0002ae00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0002ae10: 736f 7220 202a 2061 2920 7b0a 2020 2020  sor  * a) {.    
-0002ae20: 7265 7475 726e 2067 676d 6c5f 6162 735f  return ggml_abs_
-0002ae30: 696d 706c 2863 7478 2c20 612c 2074 7275  impl(ctx, a, tru
-0002ae40: 6529 3b0a 7d0a 0a0a 2f2f 2067 676d 6c5f  e);.}...// ggml_
-0002ae50: 7367 6e0a 0a73 7472 7563 7420 6767 6d6c  sgn..struct ggml
-0002ae60: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
-0002ae70: 676e 5f69 6d70 6c28 0a20 2020 2020 2020  gn_impl(.       
-0002ae80: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-0002ae90: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-0002aea0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0002aeb0: 7465 6e73 6f72 202a 2061 2c0a 2020 2020  tensor * a,.    
-0002aec0: 2020 2020 626f 6f6c 2069 6e70 6c61 6365      bool inplace
-0002aed0: 2920 7b0a 2020 2020 626f 6f6c 2069 735f  ) {.    bool is_
-0002aee0: 6e6f 6465 203d 2066 616c 7365 3b0a 0a20  node = false;.. 
-0002aef0: 2020 2069 6620 2821 696e 706c 6163 6520     if (!inplace 
-0002af00: 2626 2028 612d 3e67 7261 6429 2920 7b0a  && (a->grad)) {.
-0002af10: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
-0002af20: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
-0002af30: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002af40: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
-0002af50: 2069 6e70 6c61 6365 203f 2067 676d 6c5f   inplace ? ggml_
-0002af60: 7669 6577 5f74 656e 736f 7228 6374 782c  view_tensor(ctx,
-0002af70: 2061 2920 3a20 6767 6d6c 5f64 7570 5f74   a) : ggml_dup_t
-0002af80: 656e 736f 7228 6374 782c 2061 293b 0a0a  ensor(ctx, a);..
-0002af90: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-0002afa0: 203d 2047 474d 4c5f 4f50 5f53 474e 3b0a   = GGML_OP_SGN;.
-0002afb0: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
-0002afc0: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
-0002afd0: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
-0002afe0: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
-0002aff0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-0002b000: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
-0002b010: 6c74 2d3e 7372 6331 203d 204e 554c 4c3b  lt->src1 = NULL;
-0002b020: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
-0002b030: 756c 743b 0a7d 0a0a 7374 7275 6374 2067  ult;.}..struct g
-0002b040: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-0002b050: 6c5f 7367 6e28 0a20 2020 2020 2020 2073  l_sgn(.        s
-0002b060: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-0002b070: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-0002b080: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0002b090: 6e73 6f72 2020 2a20 6129 207b 0a20 2020  nsor  * a) {.   
-0002b0a0: 2072 6574 7572 6e20 6767 6d6c 5f73 676e   return ggml_sgn
-0002b0b0: 5f69 6d70 6c28 6374 782c 2061 2c20 6661  _impl(ctx, a, fa
-0002b0c0: 6c73 6529 3b0a 7d0a 0a73 7472 7563 7420  lse);.}..struct 
-0002b0d0: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-0002b0e0: 6d6c 5f73 676e 5f69 6e70 6c61 6365 280a  ml_sgn_inplace(.
-0002b0f0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002b100: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-0002b110: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-0002b120: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-0002b130: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
-0002b140: 2067 676d 6c5f 7367 6e5f 696d 706c 2863   ggml_sgn_impl(c
-0002b150: 7478 2c20 612c 2074 7275 6529 3b0a 7d0a  tx, a, true);.}.
-0002b160: 0a2f 2f20 6767 6d6c 5f6e 6567 0a0a 7374  .// ggml_neg..st
-0002b170: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002b180: 202a 2067 676d 6c5f 6e65 675f 696d 706c   * ggml_neg_impl
-0002b190: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0002b1a0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0002b1b0: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0002b1c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002b1d0: 2a20 612c 0a20 2020 2020 2020 2062 6f6f  * a,.        boo
-0002b1e0: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
-0002b1f0: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
-0002b200: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
-0002b210: 2169 6e70 6c61 6365 2026 2620 2861 2d3e  !inplace && (a->
-0002b220: 6772 6164 2929 207b 0a20 2020 2020 2020  grad)) {.       
-0002b230: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
-0002b240: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
-0002b250: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0002b260: 2072 6573 756c 7420 3d20 696e 706c 6163   result = inplac
-0002b270: 6520 3f20 6767 6d6c 5f76 6965 775f 7465  e ? ggml_view_te
-0002b280: 6e73 6f72 2863 7478 2c20 6129 203a 2067  nsor(ctx, a) : g
-0002b290: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-0002b2a0: 7478 2c20 6129 3b0a 0a20 2020 2072 6573  tx, a);..    res
-0002b2b0: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
-0002b2c0: 5f4f 505f 4e45 473b 0a20 2020 2072 6573  _OP_NEG;.    res
-0002b2d0: 756c 742d 3e67 7261 6420 3d20 6973 5f6e  ult->grad = is_n
-0002b2e0: 6f64 6520 3f20 6767 6d6c 5f64 7570 5f74  ode ? ggml_dup_t
-0002b2f0: 656e 736f 7228 6374 782c 2072 6573 756c  ensor(ctx, resul
-0002b300: 7429 203a 204e 554c 4c3b 0a20 2020 2072  t) : NULL;.    r
-0002b310: 6573 756c 742d 3e73 7263 3020 3d20 613b  esult->src0 = a;
-0002b320: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-0002b330: 3120 3d20 4e55 4c4c 3b0a 0a20 2020 2072  1 = NULL;..    r
-0002b340: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-0002b350: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-0002b360: 736f 7220 2a20 6767 6d6c 5f6e 6567 280a  sor * ggml_neg(.
-0002b370: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002b380: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-0002b390: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-0002b3a0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-0002b3b0: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
-0002b3c0: 2067 676d 6c5f 6e65 675f 696d 706c 2863   ggml_neg_impl(c
-0002b3d0: 7478 2c20 612c 2066 616c 7365 293b 0a7d  tx, a, false);.}
-0002b3e0: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0002b3f0: 6e73 6f72 202a 2067 676d 6c5f 6e65 675f  nsor * ggml_neg_
-0002b400: 696e 706c 6163 6528 0a20 2020 2020 2020  inplace(.       
-0002b410: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-0002b420: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-0002b430: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0002b440: 7465 6e73 6f72 2020 2a20 6129 207b 0a20  tensor  * a) {. 
-0002b450: 2020 2072 6574 7572 6e20 6767 6d6c 5f6e     return ggml_n
-0002b460: 6567 5f69 6d70 6c28 6374 782c 2061 2c20  eg_impl(ctx, a, 
-0002b470: 7472 7565 293b 0a7d 0a0a 2f2f 2067 676d  true);.}..// ggm
-0002b480: 6c5f 7374 6570 0a0a 7374 7275 6374 2067  l_step..struct g
-0002b490: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-0002b4a0: 6c5f 7374 6570 5f69 6d70 6c28 0a20 2020  l_step_impl(.   
-0002b4b0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002b4c0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002b4d0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002b4e0: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
-0002b4f0: 2020 2020 2020 2020 626f 6f6c 2069 6e70          bool inp
-0002b500: 6c61 6365 2920 7b0a 2020 2020 626f 6f6c  lace) {.    bool
-0002b510: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
-0002b520: 3b0a 0a20 2020 2069 6620 2821 696e 706c  ;..    if (!inpl
-0002b530: 6163 6520 2626 2028 612d 3e67 7261 6429  ace && (a->grad)
-0002b540: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
-0002b550: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-0002b560: 7d0a 0a20 2020 2073 7472 7563 7420 6767  }..    struct gg
-0002b570: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-0002b580: 6c74 203d 2069 6e70 6c61 6365 203f 2067  lt = inplace ? g
-0002b590: 676d 6c5f 7669 6577 5f74 656e 736f 7228  gml_view_tensor(
-0002b5a0: 6374 782c 2061 2920 3a20 6767 6d6c 5f64  ctx, a) : ggml_d
-0002b5b0: 7570 5f74 656e 736f 7228 6374 782c 2061  up_tensor(ctx, a
-0002b5c0: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
-0002b5d0: 6f70 2020 203d 2047 474d 4c5f 4f50 5f53  op   = GGML_OP_S
-0002b5e0: 5445 503b 0a20 2020 2072 6573 756c 742d  TEP;.    result-
-0002b5f0: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
-0002b600: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
-0002b610: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
-0002b620: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
-0002b630: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
-0002b640: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
-0002b650: 4e55 4c4c 3b0a 0a20 2020 2072 6574 7572  NULL;..    retur
-0002b660: 6e20 7265 7375 6c74 3b0a 7d0a 0a73 7472  n result;.}..str
-0002b670: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002b680: 2a20 6767 6d6c 5f73 7465 7028 0a20 2020  * ggml_step(.   
-0002b690: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002b6a0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002b6b0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002b6c0: 676d 6c5f 7465 6e73 6f72 2020 2a20 6129  gml_tensor  * a)
-0002b6d0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-0002b6e0: 6d6c 5f73 7465 705f 696d 706c 2863 7478  ml_step_impl(ctx
-0002b6f0: 2c20 612c 2066 616c 7365 293b 0a7d 0a0a  , a, false);.}..
-0002b700: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002b710: 6f72 202a 2067 676d 6c5f 7374 6570 5f69  or * ggml_step_i
-0002b720: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
-0002b730: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0002b740: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0002b750: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002b760: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
-0002b770: 2020 7265 7475 726e 2067 676d 6c5f 7374    return ggml_st
-0002b780: 6570 5f69 6d70 6c28 6374 782c 2061 2c20  ep_impl(ctx, a, 
-0002b790: 7472 7565 293b 0a7d 0a0a 2f2f 2067 676d  true);.}..// ggm
-0002b7a0: 6c5f 7265 6c75 0a0a 7374 7275 6374 2067  l_relu..struct g
-0002b7b0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-0002b7c0: 6c5f 7265 6c75 5f69 6d70 6c28 0a20 2020  l_relu_impl(.   
-0002b7d0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002b7e0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002b7f0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002b800: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
-0002b810: 2020 2020 2020 2020 626f 6f6c 2069 6e70          bool inp
-0002b820: 6c61 6365 2920 7b0a 2020 2020 626f 6f6c  lace) {.    bool
-0002b830: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
-0002b840: 3b0a 0a20 2020 2069 6620 2821 696e 706c  ;..    if (!inpl
-0002b850: 6163 6520 2626 2028 612d 3e67 7261 6429  ace && (a->grad)
-0002b860: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
-0002b870: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-0002b880: 7d0a 0a20 2020 2073 7472 7563 7420 6767  }..    struct gg
-0002b890: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-0002b8a0: 6c74 203d 2069 6e70 6c61 6365 203f 2067  lt = inplace ? g
-0002b8b0: 676d 6c5f 7669 6577 5f74 656e 736f 7228  gml_view_tensor(
-0002b8c0: 6374 782c 2061 2920 3a20 6767 6d6c 5f64  ctx, a) : ggml_d
-0002b8d0: 7570 5f74 656e 736f 7228 6374 782c 2061  up_tensor(ctx, a
-0002b8e0: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
-0002b8f0: 6f70 2020 203d 2047 474d 4c5f 4f50 5f52  op   = GGML_OP_R
-0002b900: 454c 553b 0a20 2020 2072 6573 756c 742d  ELU;.    result-
-0002b910: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
-0002b920: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
-0002b930: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
-0002b940: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
-0002b950: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
-0002b960: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
-0002b970: 4e55 4c4c 3b0a 0a20 2020 2072 6574 7572  NULL;..    retur
-0002b980: 6e20 7265 7375 6c74 3b0a 7d0a 0a73 7472  n result;.}..str
-0002b990: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002b9a0: 2a20 6767 6d6c 5f72 656c 7528 0a20 2020  * ggml_relu(.   
-0002b9b0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002b9c0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002b9d0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002b9e0: 676d 6c5f 7465 6e73 6f72 2020 2a20 6129  gml_tensor  * a)
-0002b9f0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-0002ba00: 6d6c 5f72 656c 755f 696d 706c 2863 7478  ml_relu_impl(ctx
-0002ba10: 2c20 612c 2066 616c 7365 293b 0a7d 0a0a  , a, false);.}..
-0002ba20: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002ba30: 6f72 202a 2067 676d 6c5f 7265 6c75 5f69  or * ggml_relu_i
-0002ba40: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
-0002ba50: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0002ba60: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0002ba70: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002ba80: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
-0002ba90: 2020 7265 7475 726e 2067 676d 6c5f 7265    return ggml_re
-0002baa0: 6c75 5f69 6d70 6c28 6374 782c 2061 2c20  lu_impl(ctx, a, 
-0002bab0: 7472 7565 293b 0a7d 0a0a 2f2f 2067 676d  true);.}..// ggm
-0002bac0: 6c5f 6765 6c75 0a0a 7374 7275 6374 2067  l_gelu..struct g
-0002bad0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-0002bae0: 6c5f 6765 6c75 5f69 6d70 6c28 0a20 2020  l_gelu_impl(.   
-0002baf0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002bb00: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002bb10: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002bb20: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
-0002bb30: 2020 2020 2020 2020 626f 6f6c 2069 6e70          bool inp
-0002bb40: 6c61 6365 2920 7b0a 2020 2020 626f 6f6c  lace) {.    bool
-0002bb50: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
-0002bb60: 3b0a 0a20 2020 2069 6620 2821 696e 706c  ;..    if (!inpl
-0002bb70: 6163 6520 2626 2028 612d 3e67 7261 6429  ace && (a->grad)
-0002bb80: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
-0002bb90: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-0002bba0: 7d0a 0a20 2020 2073 7472 7563 7420 6767  }..    struct gg
-0002bbb0: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-0002bbc0: 6c74 203d 2069 6e70 6c61 6365 203f 2067  lt = inplace ? g
-0002bbd0: 676d 6c5f 7669 6577 5f74 656e 736f 7228  gml_view_tensor(
-0002bbe0: 6374 782c 2061 2920 3a20 6767 6d6c 5f64  ctx, a) : ggml_d
-0002bbf0: 7570 5f74 656e 736f 7228 6374 782c 2061  up_tensor(ctx, a
-0002bc00: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
-0002bc10: 6f70 2020 203d 2047 474d 4c5f 4f50 5f47  op   = GGML_OP_G
-0002bc20: 454c 553b 0a20 2020 2072 6573 756c 742d  ELU;.    result-
-0002bc30: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
-0002bc40: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
-0002bc50: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
-0002bc60: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
-0002bc70: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
-0002bc80: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
-0002bc90: 4e55 4c4c 3b0a 0a20 2020 2072 6574 7572  NULL;..    retur
-0002bca0: 6e20 7265 7375 6c74 3b0a 7d0a 0a73 7472  n result;.}..str
-0002bcb0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002bcc0: 2a20 6767 6d6c 5f67 656c 7528 0a20 2020  * ggml_gelu(.   
-0002bcd0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002bce0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002bcf0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002bd00: 676d 6c5f 7465 6e73 6f72 2020 2a20 6129  gml_tensor  * a)
-0002bd10: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-0002bd20: 6d6c 5f67 656c 755f 696d 706c 2863 7478  ml_gelu_impl(ctx
-0002bd30: 2c20 612c 2066 616c 7365 293b 0a7d 0a0a  , a, false);.}..
-0002bd40: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002bd50: 6f72 202a 2067 676d 6c5f 6765 6c75 5f69  or * ggml_gelu_i
-0002bd60: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
-0002bd70: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0002bd80: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0002bd90: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002bda0: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
-0002bdb0: 2020 7265 7475 726e 2067 676d 6c5f 6765    return ggml_ge
-0002bdc0: 6c75 5f69 6d70 6c28 6374 782c 2061 2c20  lu_impl(ctx, a, 
-0002bdd0: 7472 7565 293b 0a7d 0a0a 2f2f 2067 676d  true);.}..// ggm
-0002bde0: 6c5f 7369 6c75 0a0a 7374 7275 6374 2067  l_silu..struct g
-0002bdf0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-0002be00: 6c5f 7369 6c75 5f69 6d70 6c28 0a20 2020  l_silu_impl(.   
-0002be10: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002be20: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002be30: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002be40: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
-0002be50: 2020 2020 2020 2020 626f 6f6c 2069 6e70          bool inp
-0002be60: 6c61 6365 2920 7b0a 2020 2020 626f 6f6c  lace) {.    bool
-0002be70: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
-0002be80: 3b0a 0a20 2020 2069 6620 2821 696e 706c  ;..    if (!inpl
-0002be90: 6163 6520 2626 2028 612d 3e67 7261 6429  ace && (a->grad)
-0002bea0: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
-0002beb0: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-0002bec0: 7d0a 0a20 2020 2073 7472 7563 7420 6767  }..    struct gg
-0002bed0: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-0002bee0: 6c74 203d 2069 6e70 6c61 6365 203f 2067  lt = inplace ? g
-0002bef0: 676d 6c5f 7669 6577 5f74 656e 736f 7228  gml_view_tensor(
-0002bf00: 6374 782c 2061 2920 3a20 6767 6d6c 5f64  ctx, a) : ggml_d
-0002bf10: 7570 5f74 656e 736f 7228 6374 782c 2061  up_tensor(ctx, a
-0002bf20: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
-0002bf30: 6f70 2020 203d 2047 474d 4c5f 4f50 5f53  op   = GGML_OP_S
-0002bf40: 494c 553b 0a20 2020 2072 6573 756c 742d  ILU;.    result-
-0002bf50: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
-0002bf60: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
-0002bf70: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
-0002bf80: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
-0002bf90: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
-0002bfa0: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
-0002bfb0: 4e55 4c4c 3b0a 0a20 2020 2072 6574 7572  NULL;..    retur
-0002bfc0: 6e20 7265 7375 6c74 3b0a 7d0a 0a73 7472  n result;.}..str
-0002bfd0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002bfe0: 2a20 6767 6d6c 5f73 696c 7528 0a20 2020  * ggml_silu(.   
-0002bff0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002c000: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002c010: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002c020: 676d 6c5f 7465 6e73 6f72 2020 2a20 6129  gml_tensor  * a)
-0002c030: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-0002c040: 6d6c 5f73 696c 755f 696d 706c 2863 7478  ml_silu_impl(ctx
-0002c050: 2c20 612c 2066 616c 7365 293b 0a7d 0a0a  , a, false);.}..
-0002c060: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002c070: 6f72 202a 2067 676d 6c5f 7369 6c75 5f69  or * ggml_silu_i
-0002c080: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
-0002c090: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0002c0a0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0002c0b0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002c0c0: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
-0002c0d0: 2020 7265 7475 726e 2067 676d 6c5f 7369    return ggml_si
-0002c0e0: 6c75 5f69 6d70 6c28 6374 782c 2061 2c20  lu_impl(ctx, a, 
-0002c0f0: 7472 7565 293b 0a7d 0a0a 2f2f 2067 676d  true);.}..// ggm
-0002c100: 6c5f 7369 6c75 5f62 6163 6b0a 0a73 7472  l_silu_back..str
-0002c110: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002c120: 2a20 6767 6d6c 5f73 696c 755f 6261 636b  * ggml_silu_back
-0002c130: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0002c140: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0002c150: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0002c160: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002c170: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
-0002c180: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002c190: 2020 2a20 6229 207b 0a20 2020 2062 6f6f    * b) {.    boo
-0002c1a0: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
-0002c1b0: 653b 0a0a 2020 2020 6966 2028 612d 3e67  e;..    if (a->g
-0002c1c0: 7261 6420 7c7c 2062 2d3e 6772 6164 2920  rad || b->grad) 
-0002c1d0: 7b0a 2020 2020 2020 2020 2f2f 2054 4f44  {.        // TOD
-0002c1e0: 4f3a 2069 6d70 6c65 6d65 6e74 2062 6163  O: implement bac
-0002c1f0: 6b77 6172 640a 2020 2020 2020 2020 6973  kward.        is
-0002c200: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
-0002c210: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
-0002c220: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0002c230: 7375 6c74 203d 2067 676d 6c5f 6475 705f  sult = ggml_dup_
-0002c240: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
-0002c250: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
-0002c260: 2020 3d20 4747 4d4c 5f4f 505f 5349 4c55    = GGML_OP_SILU
-0002c270: 5f42 4143 4b3b 0a20 2020 2072 6573 756c  _BACK;.    resul
-0002c280: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
-0002c290: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
-0002c2a0: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
-0002c2b0: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
-0002c2c0: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
-0002c2d0: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
-0002c2e0: 3d20 623b 0a0a 2020 2020 7265 7475 726e  = b;..    return
-0002c2f0: 2072 6573 756c 743b 0a7d 0a0a 2f2f 2067   result;.}..// g
-0002c300: 676d 6c5f 6e6f 726d 0a0a 7374 7275 6374  gml_norm..struct
-0002c310: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-0002c320: 676d 6c5f 6e6f 726d 5f69 6d70 6c28 0a20  gml_norm_impl(. 
-0002c330: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0002c340: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0002c350: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0002c360: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0002c370: 612c 0a20 2020 2020 2020 2062 6f6f 6c20  a,.        bool 
-0002c380: 696e 706c 6163 6529 207b 0a20 2020 2062  inplace) {.    b
-0002c390: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-0002c3a0: 6c73 653b 0a0a 2020 2020 6966 2028 2169  lse;..    if (!i
-0002c3b0: 6e70 6c61 6365 2026 2620 2861 2d3e 6772  nplace && (a->gr
-0002c3c0: 6164 2929 207b 0a20 2020 2020 2020 2047  ad)) {.        G
-0002c3d0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-0002c3e0: 293b 202f 2f20 544f 444f 3a20 696d 706c  ); // TODO: impl
-0002c3f0: 656d 656e 7420 6261 636b 7761 7264 0a20  ement backward. 
-0002c400: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
-0002c410: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
-0002c420: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0002c430: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
-0002c440: 696e 706c 6163 6520 3f20 6767 6d6c 5f76  inplace ? ggml_v
-0002c450: 6965 775f 7465 6e73 6f72 2863 7478 2c20  iew_tensor(ctx, 
-0002c460: 6129 203a 2067 676d 6c5f 6475 705f 7465  a) : ggml_dup_te
-0002c470: 6e73 6f72 2863 7478 2c20 6129 3b0a 0a20  nsor(ctx, a);.. 
-0002c480: 2020 2072 6573 756c 742d 3e6f 7020 2020     result->op   
-0002c490: 3d20 4747 4d4c 5f4f 505f 4e4f 524d 3b0a  = GGML_OP_NORM;.
-0002c4a0: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
-0002c4b0: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
-0002c4c0: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
-0002c4d0: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
-0002c4e0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-0002c4f0: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
-0002c500: 6c74 2d3e 7372 6331 203d 204e 554c 4c3b  lt->src1 = NULL;
-0002c510: 202f 2f20 544f 444f 3a20 6d61 7962 6520   // TODO: maybe 
-0002c520: 7374 6f72 6520 6570 7369 6c6f 6e20 6865  store epsilon he
-0002c530: 7265 3f0a 0a20 2020 2072 6574 7572 6e20  re?..    return 
-0002c540: 7265 7375 6c74 3b0a 7d0a 0a73 7472 7563  result;.}..struc
-0002c550: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0002c560: 6767 6d6c 5f6e 6f72 6d28 0a20 2020 2020  ggml_norm(.     
-0002c570: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0002c580: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0002c590: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0002c5a0: 6c5f 7465 6e73 6f72 2020 2a20 6129 207b  l_tensor  * a) {
-0002c5b0: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
-0002c5c0: 5f6e 6f72 6d5f 696d 706c 2863 7478 2c20  _norm_impl(ctx, 
-0002c5d0: 612c 2066 616c 7365 293b 0a7d 0a0a 7374  a, false);.}..st
-0002c5e0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002c5f0: 202a 2067 676d 6c5f 6e6f 726d 5f69 6e70   * ggml_norm_inp
-0002c600: 6c61 6365 280a 2020 2020 2020 2020 7374  lace(.        st
-0002c610: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-0002c620: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
-0002c630: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0002c640: 736f 7220 202a 2061 2920 7b0a 2020 2020  sor  * a) {.    
-0002c650: 7265 7475 726e 2067 676d 6c5f 6e6f 726d  return ggml_norm
-0002c660: 5f69 6d70 6c28 6374 782c 2061 2c20 7472  _impl(ctx, a, tr
-0002c670: 7565 293b 0a7d 0a0a 7374 7275 6374 2067  ue);.}..struct g
-0002c680: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-0002c690: 6c5f 726d 735f 6e6f 726d 5f69 6d70 6c28  l_rms_norm_impl(
-0002c6a0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0002c6b0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-0002c6c0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-0002c6d0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
-0002c6e0: 2a20 612c 0a20 2020 2020 2020 2062 6f6f  * a,.        boo
-0002c6f0: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
-0002c700: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
-0002c710: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
-0002c720: 2169 6e70 6c61 6365 2026 2620 2861 2d3e  !inplace && (a->
-0002c730: 6772 6164 2929 207b 0a20 2020 2020 2020  grad)) {.       
-0002c740: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
-0002c750: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
-0002c760: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0002c770: 2072 6573 756c 7420 3d20 696e 706c 6163   result = inplac
-0002c780: 6520 3f20 6767 6d6c 5f76 6965 775f 7465  e ? ggml_view_te
-0002c790: 6e73 6f72 2863 7478 2c20 6129 203a 2067  nsor(ctx, a) : g
-0002c7a0: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-0002c7b0: 7478 2c20 6129 3b0a 0a20 2020 2072 6573  tx, a);..    res
-0002c7c0: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
-0002c7d0: 5f4f 505f 524d 535f 4e4f 524d 3b0a 2020  _OP_RMS_NORM;.  
-0002c7e0: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
-0002c7f0: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
-0002c800: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-0002c810: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
-0002c820: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
-0002c830: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
-0002c840: 2d3e 7372 6331 203d 204e 554c 4c3b 202f  ->src1 = NULL; /
-0002c850: 2f20 544f 444f 3a20 6d61 7962 6520 7374  / TODO: maybe st
-0002c860: 6f72 6520 6570 7369 6c6f 6e20 6865 7265  ore epsilon here
-0002c870: 3f0a 0a20 2020 2072 6574 7572 6e20 7265  ?..    return re
-0002c880: 7375 6c74 3b0a 7d0a 0a73 7472 7563 7420  sult;.}..struct 
-0002c890: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-0002c8a0: 6d6c 5f72 6d73 5f6e 6f72 6d28 0a20 2020  ml_rms_norm(.   
-0002c8b0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002c8c0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002c8d0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002c8e0: 676d 6c5f 7465 6e73 6f72 2020 2a20 6129  gml_tensor  * a)
-0002c8f0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-0002c900: 6d6c 5f72 6d73 5f6e 6f72 6d5f 696d 706c  ml_rms_norm_impl
-0002c910: 2863 7478 2c20 612c 2066 616c 7365 293b  (ctx, a, false);
-0002c920: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-0002c930: 7465 6e73 6f72 202a 2067 676d 6c5f 726d  tensor * ggml_rm
-0002c940: 735f 6e6f 726d 5f69 6e70 6c61 6365 280a  s_norm_inplace(.
-0002c950: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002c960: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-0002c970: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-0002c980: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-0002c990: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
-0002c9a0: 2067 676d 6c5f 726d 735f 6e6f 726d 5f69   ggml_rms_norm_i
-0002c9b0: 6d70 6c28 6374 782c 2061 2c20 7472 7565  mpl(ctx, a, true
-0002c9c0: 293b 0a7d 0a0a 7374 7275 6374 2067 676d  );.}..struct ggm
-0002c9d0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-0002c9e0: 726d 735f 6e6f 726d 5f62 6163 6b28 0a20  rms_norm_back(. 
-0002c9f0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0002ca00: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0002ca10: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0002ca20: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-0002ca30: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
-0002ca40: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-0002ca50: 2062 2920 7b0a 2020 2020 626f 6f6c 2069   b) {.    bool i
-0002ca60: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
-0002ca70: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
-0002ca80: 2920 7b0a 2020 2020 2020 2020 2f2f 2054  ) {.        // T
-0002ca90: 4f44 4f3a 2069 6d70 6c65 6d65 6e74 2062  ODO: implement b
-0002caa0: 6163 6b77 6172 640a 2020 2020 2020 2020  ackward.        
-0002cab0: 6973 5f6e 6f64 6520 3d20 7472 7565 3b0a  is_node = true;.
-0002cac0: 2020 2020 7d0a 0a20 2020 2073 7472 7563      }..    struc
-0002cad0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0002cae0: 7265 7375 6c74 203d 2067 676d 6c5f 6475  result = ggml_du
-0002caf0: 705f 7465 6e73 6f72 2863 7478 2c20 6129  p_tensor(ctx, a)
-0002cb00: 3b0a 0a20 2020 2072 6573 756c 742d 3e6f  ;..    result->o
-0002cb10: 7020 2020 3d20 4747 4d4c 5f4f 505f 524d  p   = GGML_OP_RM
-0002cb20: 535f 4e4f 524d 5f42 4143 4b3b 0a20 2020  S_NORM_BACK;.   
-0002cb30: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
-0002cb40: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
-0002cb50: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
-0002cb60: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
-0002cb70: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
-0002cb80: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
-0002cb90: 3e73 7263 3120 3d20 623b 0a0a 2020 2020  >src1 = b;..    
-0002cba0: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
-0002cbb0: 0a0a 0a2f 2f20 6767 6d6c 5f6d 756c 5f6d  ...// ggml_mul_m
-0002cbc0: 6174 0a0a 7374 7275 6374 2067 676d 6c5f  at..struct ggml_
-0002cbd0: 7465 6e73 6f72 202a 2067 676d 6c5f 6d75  tensor * ggml_mu
-0002cbe0: 6c5f 6d61 7428 0a20 2020 2020 2020 2073  l_mat(.        s
-0002cbf0: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-0002cc00: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-0002cc10: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0002cc20: 6e73 6f72 2020 2a20 612c 0a20 2020 2020  nsor  * a,.     
-0002cc30: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002cc40: 656e 736f 7220 202a 2062 2920 7b0a 2020  ensor  * b) {.  
-0002cc50: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-0002cc60: 6d6c 5f63 616e 5f6d 756c 5f6d 6174 2861  ml_can_mul_mat(a
-0002cc70: 2c20 6229 293b 0a20 2020 2047 474d 4c5f  , b));.    GGML_
-0002cc80: 4153 5345 5254 2821 6767 6d6c 5f69 735f  ASSERT(!ggml_is_
-0002cc90: 7472 616e 7370 6f73 6564 2861 2929 3b0a  transposed(a));.
-0002cca0: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
-0002ccb0: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
-0002ccc0: 6966 2028 612d 3e67 7261 6420 7c7c 2062  if (a->grad || b
-0002ccd0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-0002cce0: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
-0002ccf0: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
-0002cd00: 7374 2069 6e74 3634 5f74 206e 655b 345d  st int64_t ne[4]
-0002cd10: 203d 207b 2061 2d3e 6e65 5b31 5d2c 2062   = { a->ne[1], b
-0002cd20: 2d3e 6e65 5b31 5d2c 2061 2d3e 6e65 5b32  ->ne[1], a->ne[2
-0002cd30: 5d2c 2062 2d3e 6e65 5b33 5d20 7d3b 0a20  ], b->ne[3] };. 
-0002cd40: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002cd50: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
-0002cd60: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-0002cd70: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
-0002cd80: 4633 322c 204d 494e 2861 2d3e 6e5f 6469  F32, MIN(a->n_di
-0002cd90: 6d73 2c20 622d 3e6e 5f64 696d 7329 2c20  ms, b->n_dims), 
-0002cda0: 6e65 293b 0a0a 2020 2020 7265 7375 6c74  ne);..    result
-0002cdb0: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-0002cdc0: 5f4d 554c 5f4d 4154 3b0a 2020 2020 7265  _MUL_MAT;.    re
-0002cdd0: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
-0002cde0: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
-0002cdf0: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
-0002ce00: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
-0002ce10: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
-0002ce20: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-0002ce30: 6331 203d 2062 3b0a 0a20 2020 2072 6574  c1 = b;..    ret
-0002ce40: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
-0002ce50: 2f20 6767 6d6c 5f6f 7574 5f70 726f 640a  / ggml_out_prod.
-0002ce60: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-0002ce70: 736f 7220 2a20 6767 6d6c 5f6f 7574 5f70  sor * ggml_out_p
-0002ce80: 726f 6428 0a20 2020 2020 2020 2073 7472  rod(.        str
-0002ce90: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0002cea0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0002ceb0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002cec0: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
-0002ced0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0002cee0: 736f 7220 202a 2062 2920 7b0a 2020 2020  sor  * b) {.    
-0002cef0: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-0002cf00: 5f63 616e 5f6f 7574 5f70 726f 6428 612c  _can_out_prod(a,
-0002cf10: 2062 2929 3b0a 2020 2020 4747 4d4c 5f41   b));.    GGML_A
-0002cf20: 5353 4552 5428 2167 676d 6c5f 6973 5f74  SSERT(!ggml_is_t
-0002cf30: 7261 6e73 706f 7365 6428 6129 293b 0a0a  ransposed(a));..
-0002cf40: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
-0002cf50: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
-0002cf60: 6620 2861 2d3e 6772 6164 207c 7c20 622d  f (a->grad || b-
-0002cf70: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0002cf80: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
-0002cf90: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
-0002cfa0: 7420 696e 7436 345f 7420 6e65 5b34 5d20  t int64_t ne[4] 
-0002cfb0: 3d20 7b20 612d 3e6e 655b 305d 2c20 622d  = { a->ne[0], b-
-0002cfc0: 3e6e 655b 305d 2c20 612d 3e6e 655b 325d  >ne[0], a->ne[2]
-0002cfd0: 2c20 622d 3e6e 655b 335d 207d 3b0a 2020  , b->ne[3] };.  
-0002cfe0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0002cff0: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
-0002d000: 6767 6d6c 5f6e 6577 5f74 656e 736f 7228  ggml_new_tensor(
-0002d010: 6374 782c 2047 474d 4c5f 5459 5045 5f46  ctx, GGML_TYPE_F
-0002d020: 3332 2c20 4d49 4e28 612d 3e6e 5f64 696d  32, MIN(a->n_dim
-0002d030: 732c 2062 2d3e 6e5f 6469 6d73 292c 206e  s, b->n_dims), n
-0002d040: 6529 3b0a 0a20 2020 2072 6573 756c 742d  e);..    result-
-0002d050: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-0002d060: 4f55 545f 5052 4f44 3b0a 2020 2020 7265  OUT_PROD;.    re
-0002d070: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
-0002d080: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
-0002d090: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
-0002d0a0: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
-0002d0b0: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
-0002d0c0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-0002d0d0: 6331 203d 2062 3b0a 0a20 2020 2072 6574  c1 = b;..    ret
-0002d0e0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
-0002d0f0: 2f20 6767 6d6c 5f73 6361 6c65 0a0a 7374  / ggml_scale..st
-0002d100: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002d110: 202a 2067 676d 6c5f 7363 616c 655f 696d   * ggml_scale_im
-0002d120: 706c 280a 2020 2020 2020 2020 7374 7275  pl(.        stru
-0002d130: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0002d140: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-0002d150: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002d160: 7220 202a 2061 2c0a 2020 2020 2020 2020  r  * a,.        
-0002d170: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002d180: 6f72 2020 2a20 622c 0a20 2020 2020 2020  or  * b,.       
-0002d190: 2062 6f6f 6c20 696e 706c 6163 6529 207b   bool inplace) {
-0002d1a0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0002d1b0: 2867 676d 6c5f 6973 5f73 6361 6c61 7228  (ggml_is_scalar(
-0002d1c0: 6229 293b 0a20 2020 2047 474d 4c5f 4153  b));.    GGML_AS
-0002d1d0: 5345 5254 2867 676d 6c5f 6973 5f70 6164  SERT(ggml_is_pad
-0002d1e0: 6465 645f 3164 2861 2929 3b0a 0a20 2020  ded_1d(a));..   
-0002d1f0: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
-0002d200: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
-0002d210: 612d 3e67 7261 6420 7c7c 2062 2d3e 6772  a->grad || b->gr
-0002d220: 6164 2920 7b0a 2020 2020 2020 2020 6973  ad) {.        is
-0002d230: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
-0002d240: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
-0002d250: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-0002d260: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
-0002d270: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
-0002d280: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
-0002d290: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-0002d2a0: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
-0002d2b0: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-0002d2c0: 5f53 4341 4c45 3b0a 2020 2020 7265 7375  _SCALE;.    resu
-0002d2d0: 6c74 2d3e 6772 6164 203d 2069 735f 6e6f  lt->grad = is_no
-0002d2e0: 6465 203f 2067 676d 6c5f 6475 705f 7465  de ? ggml_dup_te
-0002d2f0: 6e73 6f72 2863 7478 2c20 7265 7375 6c74  nsor(ctx, result
-0002d300: 2920 3a20 4e55 4c4c 3b0a 2020 2020 7265  ) : NULL;.    re
-0002d310: 7375 6c74 2d3e 7372 6330 203d 2061 3b0a  sult->src0 = a;.
-0002d320: 2020 2020 7265 7375 6c74 2d3e 7372 6331      result->src1
-0002d330: 203d 2062 3b0a 0a20 2020 2072 6574 7572   = b;..    retur
-0002d340: 6e20 7265 7375 6c74 3b0a 7d0a 0a73 7472  n result;.}..str
-0002d350: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002d360: 2a20 6767 6d6c 5f73 6361 6c65 280a 2020  * ggml_scale(.  
-0002d370: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0002d380: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
-0002d390: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0002d3a0: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
-0002d3b0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0002d3c0: 6767 6d6c 5f74 656e 736f 7220 2a20 6229  ggml_tensor * b)
-0002d3d0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-0002d3e0: 6d6c 5f73 6361 6c65 5f69 6d70 6c28 6374  ml_scale_impl(ct
-0002d3f0: 782c 2061 2c20 622c 2066 616c 7365 293b  x, a, b, false);
-0002d400: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-0002d410: 7465 6e73 6f72 202a 2067 676d 6c5f 7363  tensor * ggml_sc
-0002d420: 616c 655f 696e 706c 6163 6528 0a20 2020  ale_inplace(.   
-0002d430: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002d440: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002d450: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002d460: 676d 6c5f 7465 6e73 6f72 202a 2061 2c0a  gml_tensor * a,.
-0002d470: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002d480: 676d 6c5f 7465 6e73 6f72 202a 2062 2920  gml_tensor * b) 
-0002d490: 7b0a 2020 2020 7265 7475 726e 2067 676d  {.    return ggm
-0002d4a0: 6c5f 7363 616c 655f 696d 706c 2863 7478  l_scale_impl(ctx
-0002d4b0: 2c20 612c 2062 2c20 7472 7565 293b 0a7d  , a, b, true);.}
-0002d4c0: 0a0a 2f2f 2067 676d 6c5f 7365 740a 0a73  ..// ggml_set..s
-0002d4d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002d4e0: 7220 2a20 6767 6d6c 5f73 6574 5f69 6d70  r * ggml_set_imp
-0002d4f0: 6c28 0a20 2020 2020 2020 2073 7472 7563  l(.        struc
-0002d500: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-0002d510: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-0002d520: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002d530: 2020 2a20 612c 0a20 2020 2020 2020 2073    * a,.        s
-0002d540: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002d550: 7220 202a 2062 2c0a 2020 2020 2020 2020  r  * b,.        
-0002d560: 7369 7a65 5f74 2020 2020 2020 2020 2020  size_t          
-0002d570: 2020 2020 2020 6e62 312c 0a20 2020 2020        nb1,.     
-0002d580: 2020 2073 697a 655f 7420 2020 2020 2020     size_t       
-0002d590: 2020 2020 2020 2020 206e 6232 2c0a 2020           nb2,.  
-0002d5a0: 2020 2020 2020 7369 7a65 5f74 2020 2020        size_t    
-0002d5b0: 2020 2020 2020 2020 2020 2020 6e62 332c              nb3,
-0002d5c0: 0a20 2020 2020 2020 2073 697a 655f 7420  .        size_t 
-0002d5d0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0002d5e0: 6666 7365 742c 0a20 2020 2020 2020 2062  ffset,.        b
-0002d5f0: 6f6f 6c20 696e 706c 6163 6529 207b 0a20  ool inplace) {. 
-0002d600: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-0002d610: 676d 6c5f 6e65 6c65 6d65 6e74 7328 6129  gml_nelements(a)
-0002d620: 203e 3d20 6767 6d6c 5f6e 656c 656d 656e   >= ggml_nelemen
-0002d630: 7473 2862 2929 3b0a 0a20 2020 2062 6f6f  ts(b));..    boo
-0002d640: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
-0002d650: 653b 0a0a 2020 2020 6966 2028 612d 3e67  e;..    if (a->g
-0002d660: 7261 6420 7c7c 2062 2d3e 6772 6164 2920  rad || b->grad) 
-0002d670: 7b0a 2020 2020 2020 2020 6973 5f6e 6f64  {.        is_nod
-0002d680: 6520 3d20 7472 7565 3b0a 2020 2020 7d0a  e = true;.    }.
-0002d690: 0a20 2020 202f 2f20 6d61 6b65 2061 2076  .    // make a v
-0002d6a0: 6965 7720 6f66 2074 6865 2064 6573 7469  iew of the desti
-0002d6b0: 6e61 7469 6f6e 0a20 2020 2073 7472 7563  nation.    struc
-0002d6c0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0002d6d0: 7265 7375 6c74 203d 2069 6e70 6c61 6365  result = inplace
-0002d6e0: 203f 2067 676d 6c5f 7669 6577 5f74 656e   ? ggml_view_ten
-0002d6f0: 736f 7228 6374 782c 2061 2920 3a20 6767  sor(ctx, a) : gg
-0002d700: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
-0002d710: 782c 2061 293b 0a0a 2020 2020 6767 6d6c  x, a);..    ggml
-0002d720: 5f73 6372 6174 6368 5f73 6176 6528 6374  _scratch_save(ct
-0002d730: 7829 3b0a 0a20 2020 2073 7472 7563 7420  x);..    struct 
-0002d740: 6767 6d6c 5f74 656e 736f 7220 2a20 6320  ggml_tensor * c 
-0002d750: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-0002d760: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-0002d770: 5950 455f 4933 322c 2035 293b 0a0a 2020  YPE_I32, 5);..  
-0002d780: 2020 2828 2069 6e74 3332 5f74 202a 2029    (( int32_t * )
-0002d790: 2063 2d3e 6461 7461 295b 305d 203d 206e   c->data)[0] = n
-0002d7a0: 6231 3b0a 2020 2020 2828 2069 6e74 3332  b1;.    (( int32
-0002d7b0: 5f74 202a 2029 2063 2d3e 6461 7461 295b  _t * ) c->data)[
-0002d7c0: 315d 203d 206e 6232 3b0a 2020 2020 2828  1] = nb2;.    ((
-0002d7d0: 2069 6e74 3332 5f74 202a 2029 2063 2d3e   int32_t * ) c->
-0002d7e0: 6461 7461 295b 325d 203d 206e 6233 3b0a  data)[2] = nb3;.
-0002d7f0: 2020 2020 2828 2069 6e74 3332 5f74 202a      (( int32_t *
-0002d800: 2029 2063 2d3e 6461 7461 295b 335d 203d   ) c->data)[3] =
-0002d810: 206f 6666 7365 743b 0a20 2020 2028 2820   offset;.    (( 
-0002d820: 696e 7433 325f 7420 2a20 2920 632d 3e64  int32_t * ) c->d
-0002d830: 6174 6129 5b34 5d20 3d20 696e 706c 6163  ata)[4] = inplac
-0002d840: 6520 3f20 3120 3a20 303b 0a0a 2020 2020  e ? 1 : 0;..    
-0002d850: 6767 6d6c 5f73 6372 6174 6368 5f6c 6f61  ggml_scratch_loa
-0002d860: 6428 6374 7829 3b0a 0a20 2020 2072 6573  d(ctx);..    res
-0002d870: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
-0002d880: 5f4f 505f 5345 543b 0a20 2020 2072 6573  _OP_SET;.    res
-0002d890: 756c 742d 3e67 7261 6420 3d20 6973 5f6e  ult->grad = is_n
-0002d8a0: 6f64 6520 3f20 6767 6d6c 5f64 7570 5f74  ode ? ggml_dup_t
-0002d8b0: 656e 736f 7228 6374 782c 2072 6573 756c  ensor(ctx, resul
-0002d8c0: 7429 203a 204e 554c 4c3b 0a20 2020 2072  t) : NULL;.    r
-0002d8d0: 6573 756c 742d 3e73 7263 3020 3d20 613b  esult->src0 = a;
-0002d8e0: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-0002d8f0: 3120 3d20 623b 0a20 2020 2072 6573 756c  1 = b;.    resul
-0002d900: 742d 3e6f 7074 5b30 5d20 3d20 633b 0a0a  t->opt[0] = c;..
-0002d910: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0002d920: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
-0002d930: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-0002d940: 7365 7428 0a20 2020 2020 2020 2073 7472  set(.        str
-0002d950: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0002d960: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0002d970: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002d980: 6f72 202a 2020 612c 0a20 2020 2020 2020  or *  a,.       
-0002d990: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0002d9a0: 736f 7220 2a20 2062 2c0a 2020 2020 2020  sor *  b,.      
-0002d9b0: 2020 7369 7a65 5f74 2020 2020 2020 2020    size_t        
-0002d9c0: 2020 2020 2020 2020 6e62 312c 0a20 2020          nb1,.   
-0002d9d0: 2020 2020 2073 697a 655f 7420 2020 2020       size_t     
-0002d9e0: 2020 2020 2020 2020 2020 206e 6232 2c0a             nb2,.
-0002d9f0: 2020 2020 2020 2020 7369 7a65 5f74 2020          size_t  
-0002da00: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-0002da10: 332c 0a20 2020 2020 2020 2073 697a 655f  3,.        size_
-0002da20: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-0002da30: 206f 6666 7365 7429 207b 0a20 2020 2072   offset) {.    r
-0002da40: 6574 7572 6e20 6767 6d6c 5f73 6574 5f69  eturn ggml_set_i
-0002da50: 6d70 6c28 6374 782c 2061 2c20 622c 206e  mpl(ctx, a, b, n
-0002da60: 6231 2c20 6e62 322c 206e 6233 2c20 6f66  b1, nb2, nb3, of
-0002da70: 6673 6574 2c20 6661 6c73 6529 3b0a 7d0a  fset, false);.}.
-0002da80: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-0002da90: 736f 7220 2a20 6767 6d6c 5f73 6574 5f69  sor * ggml_set_i
-0002daa0: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
-0002dab0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0002dac0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0002dad0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0002dae0: 656e 736f 7220 2a20 2061 2c0a 2020 2020  ensor *  a,.    
-0002daf0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0002db00: 7465 6e73 6f72 202a 2020 622c 0a20 2020  tensor *  b,.   
-0002db10: 2020 2020 2073 697a 655f 7420 2020 2020       size_t     
-0002db20: 2020 2020 2020 2020 2020 206e 6231 2c0a             nb1,.
-0002db30: 2020 2020 2020 2020 7369 7a65 5f74 2020          size_t  
-0002db40: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-0002db50: 322c 0a20 2020 2020 2020 2073 697a 655f  2,.        size_
-0002db60: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-0002db70: 206e 6233 2c0a 2020 2020 2020 2020 7369   nb3,.        si
-0002db80: 7a65 5f74 2020 2020 2020 2020 2020 2020  ze_t            
-0002db90: 2020 2020 6f66 6673 6574 2920 7b0a 2020      offset) {.  
-0002dba0: 2020 7265 7475 726e 2067 676d 6c5f 7365    return ggml_se
-0002dbb0: 745f 696d 706c 2863 7478 2c20 612c 2062  t_impl(ctx, a, b
-0002dbc0: 2c20 6e62 312c 206e 6232 2c20 6e62 332c  , nb1, nb2, nb3,
-0002dbd0: 206f 6666 7365 742c 2074 7275 6529 3b0a   offset, true);.
-0002dbe0: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
-0002dbf0: 656e 736f 7220 2a20 6767 6d6c 5f73 6574  ensor * ggml_set
-0002dc00: 5f31 6428 0a20 2020 2020 2020 2073 7472  _1d(.        str
-0002dc10: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0002dc20: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0002dc30: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002dc40: 6f72 202a 2020 612c 0a20 2020 2020 2020  or *  a,.       
-0002dc50: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0002dc60: 736f 7220 2a20 2062 2c0a 2020 2020 2020  sor *  b,.      
-0002dc70: 2020 7369 7a65 5f74 2020 2020 2020 2020    size_t        
-0002dc80: 2020 2020 2020 2020 6f66 6673 6574 2920          offset) 
-0002dc90: 7b0a 2020 2020 7265 7475 726e 2067 676d  {.    return ggm
-0002dca0: 6c5f 7365 745f 696d 706c 2863 7478 2c20  l_set_impl(ctx, 
-0002dcb0: 612c 2062 2c20 612d 3e6e 625b 315d 2c20  a, b, a->nb[1], 
-0002dcc0: 612d 3e6e 625b 325d 2c20 612d 3e6e 625b  a->nb[2], a->nb[
-0002dcd0: 335d 2c20 6f66 6673 6574 2c20 6661 6c73  3], offset, fals
-0002dce0: 6529 3b0a 7d0a 0a73 7472 7563 7420 6767  e);.}..struct gg
-0002dcf0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
-0002dd00: 5f73 6574 5f31 645f 696e 706c 6163 6528  _set_1d_inplace(
-0002dd10: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0002dd20: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-0002dd30: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-0002dd40: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0002dd50: 2020 612c 0a20 2020 2020 2020 2073 7472    a,.        str
-0002dd60: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002dd70: 2a20 2062 2c0a 2020 2020 2020 2020 7369  *  b,.        si
-0002dd80: 7a65 5f74 2020 2020 2020 2020 2020 2020  ze_t            
-0002dd90: 2020 2020 6f66 6673 6574 2920 7b0a 2020      offset) {.  
-0002dda0: 2020 7265 7475 726e 2067 676d 6c5f 7365    return ggml_se
-0002ddb0: 745f 696d 706c 2863 7478 2c20 612c 2062  t_impl(ctx, a, b
-0002ddc0: 2c20 612d 3e6e 625b 315d 2c20 612d 3e6e  , a->nb[1], a->n
-0002ddd0: 625b 325d 2c20 612d 3e6e 625b 335d 2c20  b[2], a->nb[3], 
-0002dde0: 6f66 6673 6574 2c20 7472 7565 293b 0a7d  offset, true);.}
-0002ddf0: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0002de00: 6e73 6f72 202a 2067 676d 6c5f 7365 745f  nsor * ggml_set_
-0002de10: 3264 280a 2020 2020 2020 2020 7374 7275  2d(.        stru
-0002de20: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0002de30: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-0002de40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002de50: 7220 2a20 2061 2c0a 2020 2020 2020 2020  r *  a,.        
-0002de60: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002de70: 6f72 202a 2020 622c 0a20 2020 2020 2020  or *  b,.       
-0002de80: 2073 697a 655f 7420 2020 2020 2020 2020   size_t         
-0002de90: 2020 2020 2020 206e 6231 2c0a 2020 2020         nb1,.    
-0002dea0: 2020 2020 7369 7a65 5f74 2020 2020 2020      size_t      
-0002deb0: 2020 2020 2020 2020 2020 6f66 6673 6574            offset
-0002dec0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
-0002ded0: 676d 6c5f 7365 745f 696d 706c 2863 7478  gml_set_impl(ctx
-0002dee0: 2c20 612c 2062 2c20 6e62 312c 2061 2d3e  , a, b, nb1, a->
-0002def0: 6e62 5b32 5d2c 2061 2d3e 6e62 5b33 5d2c  nb[2], a->nb[3],
-0002df00: 206f 6666 7365 742c 2066 616c 7365 293b   offset, false);
-0002df10: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-0002df20: 7465 6e73 6f72 202a 2067 676d 6c5f 7365  tensor * ggml_se
-0002df30: 745f 3264 5f69 6e70 6c61 6365 280a 2020  t_2d_inplace(.  
-0002df40: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0002df50: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
-0002df60: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0002df70: 6767 6d6c 5f74 656e 736f 7220 2a20 2061  ggml_tensor *  a
-0002df80: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0002df90: 2067 676d 6c5f 7465 6e73 6f72 202a 2020   ggml_tensor *  
-0002dfa0: 622c 0a20 2020 2020 2020 2073 697a 655f  b,.        size_
-0002dfb0: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-0002dfc0: 206e 6231 2c0a 2020 2020 2020 2020 7369   nb1,.        si
-0002dfd0: 7a65 5f74 2020 2020 2020 2020 2020 2020  ze_t            
-0002dfe0: 2020 2020 6f66 6673 6574 2920 7b0a 2020      offset) {.  
-0002dff0: 2020 7265 7475 726e 2067 676d 6c5f 7365    return ggml_se
-0002e000: 745f 696d 706c 2863 7478 2c20 612c 2062  t_impl(ctx, a, b
-0002e010: 2c20 6e62 312c 2061 2d3e 6e62 5b32 5d2c  , nb1, a->nb[2],
-0002e020: 2061 2d3e 6e62 5b33 5d2c 206f 6666 7365   a->nb[3], offse
-0002e030: 742c 2066 616c 7365 293b 0a7d 0a0a 0a2f  t, false);.}.../
-0002e040: 2f20 6767 6d6c 5f63 7079 0a0a 7374 7275  / ggml_cpy..stru
-0002e050: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0002e060: 2067 676d 6c5f 6370 795f 696d 706c 280a   ggml_cpy_impl(.
-0002e070: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002e080: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-0002e090: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-0002e0a0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-0002e0b0: 2061 2c0a 2020 2020 2020 2020 7374 7275   a,.        stru
-0002e0c0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
-0002e0d0: 2a20 622c 0a20 2020 2020 2020 2062 6f6f  * b,.        boo
-0002e0e0: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
-0002e0f0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-0002e100: 6c5f 6e65 6c65 6d65 6e74 7328 6129 203d  l_nelements(a) =
-0002e110: 3d20 6767 6d6c 5f6e 656c 656d 656e 7473  = ggml_nelements
-0002e120: 2862 2929 3b0a 0a20 2020 2062 6f6f 6c20  (b));..    bool 
-0002e130: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
-0002e140: 0a0a 2020 2020 6966 2028 2169 6e70 6c61  ..    if (!inpla
-0002e150: 6365 2026 2620 2861 2d3e 6772 6164 207c  ce && (a->grad |
-0002e160: 7c20 622d 3e67 7261 6429 2920 7b0a 2020  | b->grad)) {.  
-0002e170: 2020 2020 2020 6973 5f6e 6f64 6520 3d20        is_node = 
-0002e180: 7472 7565 3b0a 2020 2020 7d0a 0a20 2020  true;.    }..   
-0002e190: 202f 2f20 6d61 6b65 2061 2076 6965 7720   // make a view 
-0002e1a0: 6f66 2074 6865 2064 6573 7469 6e61 7469  of the destinati
-0002e1b0: 6f6e 0a20 2020 2073 7472 7563 7420 6767  on.    struct gg
-0002e1c0: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-0002e1d0: 6c74 203d 2067 676d 6c5f 7669 6577 5f74  lt = ggml_view_t
-0002e1e0: 656e 736f 7228 6374 782c 2062 293b 0a0a  ensor(ctx, b);..
-0002e1f0: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-0002e200: 203d 2047 474d 4c5f 4f50 5f43 5059 3b0a   = GGML_OP_CPY;.
-0002e210: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
-0002e220: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
-0002e230: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
-0002e240: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
-0002e250: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-0002e260: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
-0002e270: 6c74 2d3e 7372 6331 203d 2062 3b0a 0a20  lt->src1 = b;.. 
-0002e280: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-0002e290: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
-0002e2a0: 5f74 656e 736f 7220 2a20 6767 6d6c 5f63  _tensor * ggml_c
-0002e2b0: 7079 280a 2020 2020 2020 2020 7374 7275  py(.        stru
-0002e2c0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0002e2d0: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-0002e2e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002e2f0: 7220 2a20 612c 0a20 2020 2020 2020 2073  r * a,.        s
-0002e300: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002e310: 7220 2a20 6229 207b 0a20 2020 2072 6574  r * b) {.    ret
-0002e320: 7572 6e20 6767 6d6c 5f63 7079 5f69 6d70  urn ggml_cpy_imp
-0002e330: 6c28 6374 782c 2061 2c20 622c 2066 616c  l(ctx, a, b, fal
-0002e340: 7365 293b 0a7d 0a0a 7374 7275 6374 2067  se);.}..struct g
-0002e350: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-0002e360: 6c5f 6370 795f 696e 706c 6163 6528 0a20  l_cpy_inplace(. 
-0002e370: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0002e380: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0002e390: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0002e3a0: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
-0002e3b0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0002e3c0: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
-0002e3d0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
-0002e3e0: 676d 6c5f 6370 795f 696d 706c 2863 7478  gml_cpy_impl(ctx
-0002e3f0: 2c20 612c 2062 2c20 7472 7565 293b 0a7d  , a, b, true);.}
-0002e400: 0a0a 2f2f 2067 676d 6c5f 636f 6e74 0a0a  ..// ggml_cont..
-0002e410: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002e420: 6f72 202a 2067 676d 6c5f 636f 6e74 5f69  or * ggml_cont_i
-0002e430: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
-0002e440: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0002e450: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0002e460: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002e470: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
-0002e480: 2062 6f6f 6c20 696e 706c 6163 6529 207b   bool inplace) {
-0002e490: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
-0002e4a0: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
-0002e4b0: 6966 2028 2169 6e70 6c61 6365 2026 2620  if (!inplace && 
-0002e4c0: 612d 3e67 7261 6429 207b 0a20 2020 2020  a->grad) {.     
-0002e4d0: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
-0002e4e0: 653b 0a20 2020 207d 0a0a 2020 2020 7374  e;.    }..    st
-0002e4f0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002e500: 202a 2072 6573 756c 7420 3d20 696e 706c   * result = inpl
-0002e510: 6163 6520 3f20 6767 6d6c 5f76 6965 775f  ace ? ggml_view_
-0002e520: 7465 6e73 6f72 2863 7478 2c20 6129 203a  tensor(ctx, a) :
-0002e530: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-0002e540: 2863 7478 2c20 6129 3b0a 0a20 2020 2072  (ctx, a);..    r
-0002e550: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
-0002e560: 4d4c 5f4f 505f 434f 4e54 3b0a 2020 2020  ML_OP_CONT;.    
-0002e570: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
-0002e580: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
-0002e590: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
-0002e5a0: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
-0002e5b0: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
-0002e5c0: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
-0002e5d0: 7372 6331 203d 204e 554c 4c3b 0a0a 2020  src1 = NULL;..  
-0002e5e0: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
-0002e5f0: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-0002e600: 7465 6e73 6f72 202a 2067 676d 6c5f 636f  tensor * ggml_co
-0002e610: 6e74 280a 2020 2020 2020 2020 7374 7275  nt(.        stru
-0002e620: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0002e630: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-0002e640: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002e650: 7220 2a20 6129 207b 0a20 2020 2072 6574  r * a) {.    ret
-0002e660: 7572 6e20 6767 6d6c 5f63 6f6e 745f 696d  urn ggml_cont_im
-0002e670: 706c 2863 7478 2c20 612c 2066 616c 7365  pl(ctx, a, false
-0002e680: 293b 0a7d 0a0a 7374 7275 6374 2067 676d  );.}..struct ggm
-0002e690: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-0002e6a0: 636f 6e74 5f69 6e70 6c61 6365 280a 2020  cont_inplace(.  
-0002e6b0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0002e6c0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
-0002e6d0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0002e6e0: 6767 6d6c 5f74 656e 736f 7220 2a20 6129  ggml_tensor * a)
-0002e6f0: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-0002e700: 6d6c 5f63 6f6e 745f 696d 706c 2863 7478  ml_cont_impl(ctx
-0002e710: 2c20 612c 2074 7275 6529 3b0a 7d0a 0a2f  , a, true);.}../
-0002e720: 2f20 6767 6d6c 5f72 6573 6861 7065 0a0a  / ggml_reshape..
-0002e730: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002e740: 6f72 202a 2067 676d 6c5f 7265 7368 6170  or * ggml_reshap
-0002e750: 6528 0a20 2020 2020 2020 2073 7472 7563  e(.        struc
-0002e760: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-0002e770: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-0002e780: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002e790: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
-0002e7a0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002e7b0: 202a 2062 2920 7b0a 2020 2020 4747 4d4c   * b) {.    GGML
-0002e7c0: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
-0002e7d0: 636f 6e74 6967 756f 7573 2861 2929 3b0a  contiguous(a));.
-0002e7e0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0002e7f0: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
-0002e800: 7573 2862 2929 3b0a 2020 2020 4747 4d4c  us(b));.    GGML
-0002e810: 5f41 5353 4552 5428 6767 6d6c 5f6e 656c  _ASSERT(ggml_nel
-0002e820: 656d 656e 7473 2861 2920 3d3d 2067 676d  ements(a) == ggm
-0002e830: 6c5f 6e65 6c65 6d65 6e74 7328 6229 293b  l_nelements(b));
-0002e840: 0a0a 2020 2020 626f 6f6c 2069 735f 6e6f  ..    bool is_no
-0002e850: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
-0002e860: 2069 6620 2861 2d3e 6772 6164 2920 7b0a   if (a->grad) {.
-0002e870: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
-0002e880: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
-0002e890: 2020 2069 6620 2862 2d3e 6772 6164 2920     if (b->grad) 
-0002e8a0: 7b0a 2020 2020 2020 2020 2f2f 2067 7261  {.        // gra
-0002e8b0: 6469 656e 7420 7072 6f70 6167 6174 696f  dient propagatio
-0002e8c0: 6e20 6973 206e 6f74 2073 7570 706f 7274  n is not support
-0002e8d0: 6564 0a20 2020 2020 2020 202f 2f47 474d  ed.        //GGM
-0002e8e0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-0002e8f0: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
-0002e900: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0002e910: 2072 6573 756c 7420 3d20 6767 6d6c 5f6e   result = ggml_n
-0002e920: 6577 5f74 656e 736f 725f 696d 706c 2863  ew_tensor_impl(c
-0002e930: 7478 2c20 612d 3e74 7970 652c 2062 2d3e  tx, a->type, b->
-0002e940: 6e5f 6469 6d73 2c20 622d 3e6e 652c 2061  n_dims, b->ne, a
-0002e950: 2d3e 6461 7461 293b 0a0a 2020 2020 7265  ->data);..    re
-0002e960: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-0002e970: 4c5f 4f50 5f52 4553 4841 5045 3b0a 2020  L_OP_RESHAPE;.  
-0002e980: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
-0002e990: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
-0002e9a0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-0002e9b0: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
-0002e9c0: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
-0002e9d0: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
-0002e9e0: 2d3e 7372 6331 203d 204e 554c 4c3b 0a0a  ->src1 = NULL;..
-0002e9f0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0002ea00: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
-0002ea10: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-0002ea20: 7265 7368 6170 655f 3164 280a 2020 2020  reshape_1d(.    
-0002ea30: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0002ea40: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-0002ea50: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0002ea60: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
-0002ea70: 2020 2020 2020 2020 696e 7436 345f 7420          int64_t 
-0002ea80: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0002ea90: 3029 207b 0a20 2020 2047 474d 4c5f 4153  0) {.    GGML_AS
-0002eaa0: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
-0002eab0: 7469 6775 6f75 7328 6129 293b 0a20 2020  tiguous(a));.   
-0002eac0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-0002ead0: 6c5f 6e65 6c65 6d65 6e74 7328 6129 203d  l_nelements(a) =
-0002eae0: 3d20 6e65 3029 3b0a 0a20 2020 2062 6f6f  = ne0);..    boo
-0002eaf0: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
-0002eb00: 653b 0a0a 2020 2020 6966 2028 612d 3e67  e;..    if (a->g
-0002eb10: 7261 6429 207b 0a20 2020 2020 2020 2069  rad) {.        i
-0002eb20: 735f 6e6f 6465 203d 2074 7275 653b 0a20  s_node = true;. 
-0002eb30: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
-0002eb40: 696e 7436 345f 7420 6e65 5b31 5d20 3d20  int64_t ne[1] = 
-0002eb50: 7b20 6e65 3020 7d3b 0a20 2020 2073 7472  { ne0 };.    str
-0002eb60: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002eb70: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
-0002eb80: 6e65 775f 7465 6e73 6f72 5f69 6d70 6c28  new_tensor_impl(
-0002eb90: 6374 782c 2061 2d3e 7479 7065 2c20 312c  ctx, a->type, 1,
-0002eba0: 206e 652c 2061 2d3e 6461 7461 293b 0a0a   ne, a->data);..
-0002ebb0: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-0002ebc0: 203d 2047 474d 4c5f 4f50 5f52 4553 4841   = GGML_OP_RESHA
-0002ebd0: 5045 3b0a 2020 2020 7265 7375 6c74 2d3e  PE;.    result->
-0002ebe0: 6772 6164 203d 2069 735f 6e6f 6465 203f  grad = is_node ?
-0002ebf0: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-0002ec00: 2863 7478 2c20 7265 7375 6c74 2920 3a20  (ctx, result) : 
-0002ec10: 4e55 4c4c 3b0a 2020 2020 7265 7375 6c74  NULL;.    result
-0002ec20: 2d3e 7372 6330 203d 2061 3b0a 2020 2020  ->src0 = a;.    
-0002ec30: 7265 7375 6c74 2d3e 7372 6331 203d 204e  result->src1 = N
-0002ec40: 554c 4c3b 0a0a 2020 2020 7265 7475 726e  ULL;..    return
-0002ec50: 2072 6573 756c 743b 0a7d 0a0a 7374 7275   result;.}..stru
-0002ec60: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0002ec70: 2067 676d 6c5f 7265 7368 6170 655f 3264   ggml_reshape_2d
-0002ec80: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0002ec90: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0002eca0: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0002ecb0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002ecc0: 202a 2061 2c0a 2020 2020 2020 2020 696e   * a,.        in
-0002ecd0: 7436 345f 7420 2020 2020 2020 2020 2020  t64_t           
-0002ece0: 2020 2020 6e65 302c 0a20 2020 2020 2020      ne0,.       
-0002ecf0: 2069 6e74 3634 5f74 2020 2020 2020 2020   int64_t        
-0002ed00: 2020 2020 2020 206e 6531 2920 7b0a 2020         ne1) {.  
-0002ed10: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-0002ed20: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-0002ed30: 2861 2929 3b0a 2020 2020 4747 4d4c 5f41  (a));.    GGML_A
-0002ed40: 5353 4552 5428 6767 6d6c 5f6e 656c 656d  SSERT(ggml_nelem
-0002ed50: 656e 7473 2861 2920 3d3d 206e 6530 2a6e  ents(a) == ne0*n
-0002ed60: 6531 293b 0a0a 2020 2020 626f 6f6c 2069  e1);..    bool i
-0002ed70: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
-0002ed80: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
-0002ed90: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
-0002eda0: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-0002edb0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
-0002edc0: 3634 5f74 206e 655b 325d 203d 207b 206e  64_t ne[2] = { n
-0002edd0: 6530 2c20 6e65 3120 7d3b 0a20 2020 2073  e0, ne1 };.    s
-0002ede0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002edf0: 7220 2a20 7265 7375 6c74 203d 2067 676d  r * result = ggm
-0002ee00: 6c5f 6e65 775f 7465 6e73 6f72 5f69 6d70  l_new_tensor_imp
-0002ee10: 6c28 6374 782c 2061 2d3e 7479 7065 2c20  l(ctx, a->type, 
-0002ee20: 322c 206e 652c 2061 2d3e 6461 7461 293b  2, ne, a->data);
-0002ee30: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
-0002ee40: 2020 203d 2047 474d 4c5f 4f50 5f52 4553     = GGML_OP_RES
-0002ee50: 4841 5045 3b0a 2020 2020 7265 7375 6c74  HAPE;.    result
-0002ee60: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
-0002ee70: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
-0002ee80: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
-0002ee90: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
-0002eea0: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
-0002eeb0: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
-0002eec0: 204e 554c 4c3b 0a0a 2020 2020 7265 7475   NULL;..    retu
-0002eed0: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
-0002eee0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002eef0: 202a 2067 676d 6c5f 7265 7368 6170 655f   * ggml_reshape_
-0002ef00: 3364 280a 2020 2020 2020 2020 7374 7275  3d(.        stru
-0002ef10: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0002ef20: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-0002ef30: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002ef40: 7220 202a 2061 2c0a 2020 2020 2020 2020  r  * a,.        
-0002ef50: 696e 7436 345f 7420 2020 2020 2020 2020  int64_t         
-0002ef60: 2020 2020 2020 6e65 302c 0a20 2020 2020        ne0,.     
-0002ef70: 2020 2069 6e74 3634 5f74 2020 2020 2020     int64_t      
-0002ef80: 2020 2020 2020 2020 206e 6531 2c0a 2020           ne1,.  
-0002ef90: 2020 2020 2020 696e 7436 345f 7420 2020        int64_t   
-0002efa0: 2020 2020 2020 2020 2020 2020 6e65 3229              ne2)
-0002efb0: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-0002efc0: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
-0002efd0: 6775 6f75 7328 6129 293b 0a20 2020 2047  guous(a));.    G
-0002efe0: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
-0002eff0: 6e65 6c65 6d65 6e74 7328 6129 203d 3d20  nelements(a) == 
-0002f000: 6e65 302a 6e65 312a 6e65 3229 3b0a 0a20  ne0*ne1*ne2);.. 
-0002f010: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
-0002f020: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
-0002f030: 2028 612d 3e67 7261 6429 207b 0a20 2020   (a->grad) {.   
-0002f040: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
-0002f050: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
-0002f060: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0002f070: 5b33 5d20 3d20 7b20 6e65 302c 206e 6531  [3] = { ne0, ne1
-0002f080: 2c20 6e65 3220 7d3b 0a20 2020 2073 7472  , ne2 };.    str
-0002f090: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002f0a0: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
-0002f0b0: 6e65 775f 7465 6e73 6f72 5f69 6d70 6c28  new_tensor_impl(
-0002f0c0: 6374 782c 2061 2d3e 7479 7065 2c20 332c  ctx, a->type, 3,
-0002f0d0: 206e 652c 2061 2d3e 6461 7461 293b 0a0a   ne, a->data);..
-0002f0e0: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-0002f0f0: 203d 2047 474d 4c5f 4f50 5f52 4553 4841   = GGML_OP_RESHA
-0002f100: 5045 3b0a 2020 2020 7265 7375 6c74 2d3e  PE;.    result->
-0002f110: 6772 6164 203d 2069 735f 6e6f 6465 203f  grad = is_node ?
-0002f120: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-0002f130: 2863 7478 2c20 7265 7375 6c74 2920 3a20  (ctx, result) : 
-0002f140: 4e55 4c4c 3b0a 2020 2020 7265 7375 6c74  NULL;.    result
-0002f150: 2d3e 7372 6330 203d 2061 3b0a 2020 2020  ->src0 = a;.    
-0002f160: 7265 7375 6c74 2d3e 7372 6331 203d 204e  result->src1 = N
-0002f170: 554c 4c3b 0a0a 2020 2020 7265 7475 726e  ULL;..    return
-0002f180: 2072 6573 756c 743b 0a7d 0a0a 0a73 7472   result;.}...str
-0002f190: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002f1a0: 2a20 6767 6d6c 5f72 6573 6861 7065 5f34  * ggml_reshape_4
-0002f1b0: 6428 0a20 2020 2020 2020 2073 7472 7563  d(.        struc
-0002f1c0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-0002f1d0: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-0002f1e0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0002f1f0: 2020 2a20 612c 0a20 2020 2020 2020 2069    * a,.        i
-0002f200: 6e74 3634 5f74 2020 2020 2020 2020 2020  nt64_t          
-0002f210: 2020 2020 206e 6530 2c0a 2020 2020 2020       ne0,.      
-0002f220: 2020 696e 7436 345f 7420 2020 2020 2020    int64_t       
-0002f230: 2020 2020 2020 2020 6e65 312c 0a20 2020          ne1,.   
-0002f240: 2020 2020 2069 6e74 3634 5f74 2020 2020       int64_t    
-0002f250: 2020 2020 2020 2020 2020 206e 6532 2c0a             ne2,.
-0002f260: 2020 2020 2020 2020 696e 7436 345f 7420          int64_t 
-0002f270: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0002f280: 3329 207b 0a20 2020 2047 474d 4c5f 4153  3) {.    GGML_AS
-0002f290: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
-0002f2a0: 7469 6775 6f75 7328 6129 293b 0a20 2020  tiguous(a));.   
-0002f2b0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-0002f2c0: 6c5f 6e65 6c65 6d65 6e74 7328 6129 203d  l_nelements(a) =
-0002f2d0: 3d20 6e65 302a 6e65 312a 6e65 322a 6e65  = ne0*ne1*ne2*ne
-0002f2e0: 3329 3b0a 0a20 2020 2062 6f6f 6c20 6973  3);..    bool is
-0002f2f0: 5f6e 6f64 6520 3d20 6661 6c73 653b 0a0a  _node = false;..
-0002f300: 2020 2020 6966 2028 612d 3e67 7261 6429      if (a->grad)
-0002f310: 207b 0a20 2020 2020 2020 2069 735f 6e6f   {.        is_no
-0002f320: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
-0002f330: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-0002f340: 345f 7420 6e65 5b34 5d20 3d20 7b20 6e65  4_t ne[4] = { ne
-0002f350: 302c 206e 6531 2c20 6e65 322c 206e 6533  0, ne1, ne2, ne3
-0002f360: 207d 3b0a 2020 2020 7374 7275 6374 2067   };.    struct g
-0002f370: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
-0002f380: 756c 7420 3d20 6767 6d6c 5f6e 6577 5f74  ult = ggml_new_t
-0002f390: 656e 736f 725f 696d 706c 2863 7478 2c20  ensor_impl(ctx, 
-0002f3a0: 612d 3e74 7970 652c 2034 2c20 6e65 2c20  a->type, 4, ne, 
-0002f3b0: 612d 3e64 6174 6129 3b0a 0a20 2020 2072  a->data);..    r
-0002f3c0: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
-0002f3d0: 4d4c 5f4f 505f 5245 5348 4150 453b 0a20  ML_OP_RESHAPE;. 
-0002f3e0: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
-0002f3f0: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
-0002f400: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-0002f410: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
-0002f420: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-0002f430: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
-0002f440: 742d 3e73 7263 3120 3d20 4e55 4c4c 3b0a  t->src1 = NULL;.
-0002f450: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-0002f460: 6c74 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f76  lt;.}..// ggml_v
-0002f470: 6965 775f 3164 0a0a 7374 7275 6374 2067  iew_1d..struct g
-0002f480: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-0002f490: 6c5f 7669 6577 5f31 6428 0a20 2020 2020  l_view_1d(.     
-0002f4a0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0002f4b0: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0002f4c0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0002f4d0: 6c5f 7465 6e73 6f72 2020 2a20 612c 0a20  l_tensor  * a,. 
-0002f4e0: 2020 2020 2020 2069 6e74 3634 5f74 2020         int64_t  
-0002f4f0: 2020 2020 2020 2020 2020 2020 206e 6530               ne0
-0002f500: 2c0a 2020 2020 2020 2020 7369 7a65 5f74  ,.        size_t
-0002f510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f520: 6f66 6673 6574 2920 7b0a 0a20 2020 2062  offset) {..    b
-0002f530: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-0002f540: 6c73 653b 0a0a 2020 2020 6966 2028 612d  lse;..    if (a-
-0002f550: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0002f560: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
-0002f570: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
-0002f580: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0002f590: 2072 6573 756c 7420 3d20 6767 6d6c 5f6e   result = ggml_n
-0002f5a0: 6577 5f74 656e 736f 725f 696d 706c 2863  ew_tensor_impl(c
-0002f5b0: 7478 2c20 612d 3e74 7970 652c 2031 2c20  tx, a->type, 1, 
-0002f5c0: 266e 6530 2c20 2863 6861 7220 2a29 2061  &ne0, (char *) a
-0002f5d0: 2d3e 6461 7461 202b 206f 6666 7365 7429  ->data + offset)
-0002f5e0: 3b0a 0a20 2020 2067 676d 6c5f 7363 7261  ;..    ggml_scra
-0002f5f0: 7463 685f 7361 7665 2863 7478 293b 0a0a  tch_save(ctx);..
-0002f600: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0002f610: 7465 6e73 6f72 202a 206f 6666 7320 3d20  tensor * offs = 
-0002f620: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
-0002f630: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
-0002f640: 455f 4933 322c 2032 293b 0a20 2020 206d  E_I32, 2);.    m
-0002f650: 656d 6370 7928 6f66 6673 2d3e 6461 7461  emcpy(offs->data
-0002f660: 2c20 266f 6666 7365 742c 2032 2a73 697a  , &offset, 2*siz
-0002f670: 656f 6628 696e 7433 325f 7429 293b 0a0a  eof(int32_t));..
-0002f680: 2020 2020 6767 6d6c 5f73 6372 6174 6368      ggml_scratch
-0002f690: 5f6c 6f61 6428 6374 7829 3b0a 0a20 2020  _load(ctx);..   
-0002f6a0: 2072 6573 756c 742d 3e6f 7020 2020 3d20   result->op   = 
-0002f6b0: 4747 4d4c 5f4f 505f 5649 4557 3b0a 2020  GGML_OP_VIEW;.  
-0002f6c0: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
-0002f6d0: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
-0002f6e0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-0002f6f0: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
-0002f700: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
-0002f710: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
-0002f720: 2d3e 7372 6331 203d 204e 554c 4c3b 0a20  ->src1 = NULL;. 
-0002f730: 2020 2072 6573 756c 742d 3e6f 7074 5b30     result->opt[0
-0002f740: 5d20 3d20 6f66 6673 3b0a 0a20 2020 2072  ] = offs;..    r
-0002f750: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-0002f760: 0a2f 2f20 6767 6d6c 5f76 6965 775f 3264  .// ggml_view_2d
-0002f770: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-0002f780: 6e73 6f72 202a 2067 676d 6c5f 7669 6577  nsor * ggml_view
-0002f790: 5f32 6428 0a20 2020 2020 2020 2073 7472  _2d(.        str
-0002f7a0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-0002f7b0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0002f7c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0002f7d0: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
-0002f7e0: 2069 6e74 3634 5f74 2020 2020 2020 2020   int64_t        
-0002f7f0: 2020 2020 2020 206e 6530 2c0a 2020 2020         ne0,.    
-0002f800: 2020 2020 696e 7436 345f 7420 2020 2020      int64_t     
-0002f810: 2020 2020 2020 2020 2020 6e65 312c 0a20            ne1,. 
-0002f820: 2020 2020 2020 2073 697a 655f 7420 2020         size_t   
-0002f830: 2020 2020 2020 2020 2020 2020 206e 6231               nb1
-0002f840: 2c0a 2020 2020 2020 2020 7369 7a65 5f74  ,.        size_t
-0002f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f860: 6f66 6673 6574 2920 7b0a 0a20 2020 2062  offset) {..    b
-0002f870: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-0002f880: 6c73 653b 0a0a 2020 2020 6966 2028 612d  lse;..    if (a-
-0002f890: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0002f8a0: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
-0002f8b0: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
-0002f8c0: 7420 696e 7436 345f 7420 6e65 5b47 474d  t int64_t ne[GGM
-0002f8d0: 4c5f 4d41 585f 4449 4d53 5d20 3d20 7b20  L_MAX_DIMS] = { 
-0002f8e0: 6e65 302c 206e 6531 2c20 312c 2031 207d  ne0, ne1, 1, 1 }
-0002f8f0: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
-0002f900: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-0002f910: 6c74 203d 2067 676d 6c5f 6e65 775f 7465  lt = ggml_new_te
-0002f920: 6e73 6f72 5f69 6d70 6c28 6374 782c 2061  nsor_impl(ctx, a
-0002f930: 2d3e 7479 7065 2c20 322c 206e 652c 2028  ->type, 2, ne, (
-0002f940: 6368 6172 202a 2920 612d 3e64 6174 6120  char *) a->data 
-0002f950: 2b20 6f66 6673 6574 293b 0a0a 2020 2020  + offset);..    
-0002f960: 6767 6d6c 5f73 6372 6174 6368 5f73 6176  ggml_scratch_sav
-0002f970: 6528 6374 7829 3b0a 0a20 2020 2073 7472  e(ctx);..    str
-0002f980: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002f990: 2a20 6f66 6673 203d 2067 676d 6c5f 6e65  * offs = ggml_ne
-0002f9a0: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
-0002f9b0: 2047 474d 4c5f 5459 5045 5f49 3332 2c20   GGML_TYPE_I32, 
-0002f9c0: 3229 3b0a 2020 2020 6d65 6d63 7079 286f  2);.    memcpy(o
-0002f9d0: 6666 732d 3e64 6174 612c 2026 6f66 6673  ffs->data, &offs
-0002f9e0: 6574 2c20 322a 7369 7a65 6f66 2869 6e74  et, 2*sizeof(int
-0002f9f0: 3332 5f74 2929 3b0a 0a20 2020 2067 676d  32_t));..    ggm
-0002fa00: 6c5f 7363 7261 7463 685f 6c6f 6164 2863  l_scratch_load(c
-0002fa10: 7478 293b 0a0a 2020 2020 7265 7375 6c74  tx);..    result
-0002fa20: 2d3e 6e62 5b31 5d20 3d20 6e62 313b 0a20  ->nb[1] = nb1;. 
-0002fa30: 2020 2072 6573 756c 742d 3e6e 625b 325d     result->nb[2]
-0002fa40: 203d 2072 6573 756c 742d 3e6e 625b 315d   = result->nb[1]
-0002fa50: 2a6e 6531 3b0a 2020 2020 7265 7375 6c74  *ne1;.    result
-0002fa60: 2d3e 6e62 5b33 5d20 3d20 7265 7375 6c74  ->nb[3] = result
-0002fa70: 2d3e 6e62 5b32 5d3b 0a0a 2020 2020 7265  ->nb[2];..    re
-0002fa80: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-0002fa90: 4c5f 4f50 5f56 4945 573b 0a20 2020 2072  L_OP_VIEW;.    r
-0002faa0: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
-0002fab0: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
-0002fac0: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
-0002fad0: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
-0002fae0: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-0002faf0: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-0002fb00: 7263 3120 3d20 4e55 4c4c 3b0a 2020 2020  rc1 = NULL;.    
-0002fb10: 7265 7375 6c74 2d3e 6f70 745b 305d 203d  result->opt[0] =
-0002fb20: 206f 6666 733b 0a0a 2020 2020 7265 7475   offs;..    retu
-0002fb30: 726e 2072 6573 756c 743b 0a7d 0a0a 2f2f  rn result;.}..//
-0002fb40: 2067 676d 6c5f 7669 6577 5f33 640a 0a73   ggml_view_3d..s
-0002fb50: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0002fb60: 7220 2a20 6767 6d6c 5f76 6965 775f 3364  r * ggml_view_3d
-0002fb70: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-0002fb80: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0002fb90: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-0002fba0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0002fbb0: 202a 2061 2c0a 2020 2020 2020 2020 696e   * a,.        in
-0002fbc0: 7436 345f 7420 2020 2020 2020 2020 2020  t64_t           
-0002fbd0: 2020 2020 6e65 302c 0a20 2020 2020 2020      ne0,.       
-0002fbe0: 2069 6e74 3634 5f74 2020 2020 2020 2020   int64_t        
-0002fbf0: 2020 2020 2020 206e 6531 2c0a 2020 2020         ne1,.    
-0002fc00: 2020 2020 696e 7436 345f 7420 2020 2020      int64_t     
-0002fc10: 2020 2020 2020 2020 2020 6e65 322c 0a20            ne2,. 
-0002fc20: 2020 2020 2020 2073 697a 655f 7420 2020         size_t   
-0002fc30: 2020 2020 2020 2020 2020 2020 206e 6231               nb1
-0002fc40: 2c0a 2020 2020 2020 2020 7369 7a65 5f74  ,.        size_t
-0002fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fc60: 6e62 322c 0a20 2020 2020 2020 2073 697a  nb2,.        siz
-0002fc70: 655f 7420 2020 2020 2020 2020 2020 2020  e_t             
-0002fc80: 2020 206f 6666 7365 7429 207b 0a0a 2020     offset) {..  
-0002fc90: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
-0002fca0: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
-0002fcb0: 2861 2d3e 6772 6164 2920 7b0a 2020 2020  (a->grad) {.    
-0002fcc0: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-0002fcd0: 7565 3b0a 2020 2020 7d0a 0a20 2020 2063  ue;.    }..    c
-0002fce0: 6f6e 7374 2069 6e74 3634 5f74 206e 655b  onst int64_t ne[
-0002fcf0: 4747 4d4c 5f4d 4158 5f44 494d 535d 203d  GGML_MAX_DIMS] =
-0002fd00: 207b 206e 6530 2c20 6e65 312c 206e 6532   { ne0, ne1, ne2
-0002fd10: 2c20 3120 7d3b 0a0a 2020 2020 7374 7275  , 1 };..    stru
-0002fd20: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0002fd30: 2072 6573 756c 7420 3d20 6767 6d6c 5f6e   result = ggml_n
-0002fd40: 6577 5f74 656e 736f 725f 696d 706c 2863  ew_tensor_impl(c
-0002fd50: 7478 2c20 612d 3e74 7970 652c 2033 2c20  tx, a->type, 3, 
-0002fd60: 6e65 2c20 2863 6861 7220 2a29 2061 2d3e  ne, (char *) a->
-0002fd70: 6461 7461 202b 206f 6666 7365 7429 3b0a  data + offset);.
-0002fd80: 0a20 2020 2067 676d 6c5f 7363 7261 7463  .    ggml_scratc
-0002fd90: 685f 7361 7665 2863 7478 293b 0a0a 2020  h_save(ctx);..  
-0002fda0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0002fdb0: 6e73 6f72 202a 206f 6666 7320 3d20 6767  nsor * offs = gg
-0002fdc0: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
-0002fdd0: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
-0002fde0: 4933 322c 2032 293b 0a20 2020 206d 656d  I32, 2);.    mem
-0002fdf0: 6370 7928 6f66 6673 2d3e 6461 7461 2c20  cpy(offs->data, 
-0002fe00: 266f 6666 7365 742c 2032 2a73 697a 656f  &offset, 2*sizeo
-0002fe10: 6628 696e 7433 325f 7429 293b 0a0a 2020  f(int32_t));..  
-0002fe20: 2020 6767 6d6c 5f73 6372 6174 6368 5f6c    ggml_scratch_l
-0002fe30: 6f61 6428 6374 7829 3b0a 0a20 2020 2072  oad(ctx);..    r
-0002fe40: 6573 756c 742d 3e6e 625b 315d 203d 206e  esult->nb[1] = n
-0002fe50: 6231 3b0a 2020 2020 7265 7375 6c74 2d3e  b1;.    result->
-0002fe60: 6e62 5b32 5d20 3d20 6e62 323b 0a20 2020  nb[2] = nb2;.   
-0002fe70: 2072 6573 756c 742d 3e6e 625b 335d 203d   result->nb[3] =
-0002fe80: 2072 6573 756c 742d 3e6e 625b 325d 2a6e   result->nb[2]*n
-0002fe90: 6532 3b0a 0a20 2020 2072 6573 756c 742d  e2;..    result-
-0002fea0: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-0002feb0: 5649 4557 3b0a 2020 2020 7265 7375 6c74  VIEW;.    result
-0002fec0: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
-0002fed0: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
-0002fee0: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
-0002fef0: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
-0002ff00: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
-0002ff10: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
-0002ff20: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
-0002ff30: 742d 3e6f 7074 5b30 5d20 3d20 6f66 6673  t->opt[0] = offs
-0002ff40: 3b0a 0a20 2020 2072 6574 7572 6e20 7265  ;..    return re
-0002ff50: 7375 6c74 3b0a 7d0a 0a2f 2f20 6767 6d6c  sult;.}..// ggml
-0002ff60: 5f76 6965 775f 3464 0a0a 7374 7275 6374  _view_4d..struct
-0002ff70: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-0002ff80: 676d 6c5f 7669 6577 5f34 6428 0a20 2020  gml_view_4d(.   
-0002ff90: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0002ffa0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0002ffb0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0002ffc0: 676d 6c5f 7465 6e73 6f72 2020 2a20 612c  gml_tensor  * a,
-0002ffd0: 0a20 2020 2020 2020 2069 6e74 3634 5f74  .        int64_t
-0002ffe0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0002fff0: 6530 2c0a 2020 2020 2020 2020 696e 7436  e0,.        int6
-00030000: 345f 7420 2020 2020 2020 2020 2020 2020  4_t             
-00030010: 2020 6e65 312c 0a20 2020 2020 2020 2069    ne1,.        i
-00030020: 6e74 3634 5f74 2020 2020 2020 2020 2020  nt64_t          
-00030030: 2020 2020 206e 6532 2c0a 2020 2020 2020       ne2,.      
-00030040: 2020 696e 7436 345f 7420 2020 2020 2020    int64_t       
-00030050: 2020 2020 2020 2020 6e65 332c 0a20 2020          ne3,.   
-00030060: 2020 2020 2073 697a 655f 7420 2020 2020       size_t     
-00030070: 2020 2020 2020 2020 2020 206e 6231 2c0a             nb1,.
-00030080: 2020 2020 2020 2020 7369 7a65 5f74 2020          size_t  
-00030090: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-000300a0: 322c 0a20 2020 2020 2020 2073 697a 655f  2,.        size_
-000300b0: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-000300c0: 206e 6233 2c0a 2020 2020 2020 2020 7369   nb3,.        si
-000300d0: 7a65 5f74 2020 2020 2020 2020 2020 2020  ze_t            
-000300e0: 2020 2020 6f66 6673 6574 2920 7b0a 0a20      offset) {.. 
-000300f0: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
-00030100: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
-00030110: 2028 612d 3e67 7261 6429 207b 0a20 2020   (a->grad) {.   
-00030120: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
-00030130: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
-00030140: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00030150: 5b47 474d 4c5f 4d41 585f 4449 4d53 5d20  [GGML_MAX_DIMS] 
-00030160: 3d20 7b20 6e65 302c 206e 6531 2c20 6e65  = { ne0, ne1, ne
-00030170: 322c 206e 6533 207d 3b0a 0a20 2020 2073  2, ne3 };..    s
-00030180: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00030190: 7220 2a20 7265 7375 6c74 203d 2067 676d  r * result = ggm
-000301a0: 6c5f 6e65 775f 7465 6e73 6f72 5f69 6d70  l_new_tensor_imp
-000301b0: 6c28 6374 782c 2061 2d3e 7479 7065 2c20  l(ctx, a->type, 
-000301c0: 342c 206e 652c 2028 6368 6172 202a 2920  4, ne, (char *) 
-000301d0: 612d 3e64 6174 6120 2b20 6f66 6673 6574  a->data + offset
-000301e0: 293b 0a0a 2020 2020 6767 6d6c 5f73 6372  );..    ggml_scr
-000301f0: 6174 6368 5f73 6176 6528 6374 7829 3b0a  atch_save(ctx);.
-00030200: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-00030210: 5f74 656e 736f 7220 2a20 6f66 6673 203d  _tensor * offs =
-00030220: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-00030230: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
-00030240: 5045 5f49 3332 2c20 3229 3b0a 2020 2020  PE_I32, 2);.    
-00030250: 6d65 6d63 7079 286f 6666 732d 3e64 6174  memcpy(offs->dat
-00030260: 612c 2026 6f66 6673 6574 2c20 322a 7369  a, &offset, 2*si
-00030270: 7a65 6f66 2869 6e74 3332 5f74 2929 3b0a  zeof(int32_t));.
-00030280: 0a20 2020 2067 676d 6c5f 7363 7261 7463  .    ggml_scratc
-00030290: 685f 6c6f 6164 2863 7478 293b 0a0a 2020  h_load(ctx);..  
-000302a0: 2020 7265 7375 6c74 2d3e 6e62 5b31 5d20    result->nb[1] 
-000302b0: 3d20 6e62 313b 0a20 2020 2072 6573 756c  = nb1;.    resul
-000302c0: 742d 3e6e 625b 325d 203d 206e 6232 3b0a  t->nb[2] = nb2;.
-000302d0: 2020 2020 7265 7375 6c74 2d3e 6e62 5b33      result->nb[3
-000302e0: 5d20 3d20 6e62 333b 0a0a 2020 2020 7265  ] = nb3;..    re
-000302f0: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-00030300: 4c5f 4f50 5f56 4945 573b 0a20 2020 2072  L_OP_VIEW;.    r
-00030310: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
-00030320: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
-00030330: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
-00030340: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
-00030350: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-00030360: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-00030370: 7263 3120 3d20 4e55 4c4c 3b0a 2020 2020  rc1 = NULL;.    
-00030380: 7265 7375 6c74 2d3e 6f70 745b 305d 203d  result->opt[0] =
-00030390: 206f 6666 733b 0a0a 2020 2020 7265 7475   offs;..    retu
-000303a0: 726e 2072 6573 756c 743b 0a7d 0a0a 2f2f  rn result;.}..//
-000303b0: 2067 676d 6c5f 7065 726d 7574 650a 0a73   ggml_permute..s
-000303c0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000303d0: 7220 2a20 6767 6d6c 5f70 6572 6d75 7465  r * ggml_permute
-000303e0: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-000303f0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00030400: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-00030410: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00030420: 202a 2061 2c0a 2020 2020 2020 2020 696e   * a,.        in
-00030430: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-00030440: 2020 2020 6178 6973 302c 0a20 2020 2020      axis0,.     
-00030450: 2020 2069 6e74 2020 2020 2020 2020 2020     int          
-00030460: 2020 2020 2020 2020 2061 7869 7331 2c0a           axis1,.
-00030470: 2020 2020 2020 2020 696e 7420 2020 2020          int     
-00030480: 2020 2020 2020 2020 2020 2020 2020 6178                ax
-00030490: 6973 322c 0a20 2020 2020 2020 2069 6e74  is2,.        int
-000304a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304b0: 2020 2061 7869 7333 2920 7b0a 2020 2020     axis3) {.    
-000304c0: 4747 4d4c 5f41 5353 4552 5428 6178 6973  GGML_ASSERT(axis
-000304d0: 3020 3e3d 2030 2026 2620 6178 6973 3020  0 >= 0 && axis0 
-000304e0: 3c20 4747 4d4c 5f4d 4158 5f44 494d 5329  < GGML_MAX_DIMS)
-000304f0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00030500: 5428 6178 6973 3120 3e3d 2030 2026 2620  T(axis1 >= 0 && 
-00030510: 6178 6973 3120 3c20 4747 4d4c 5f4d 4158  axis1 < GGML_MAX
-00030520: 5f44 494d 5329 3b0a 2020 2020 4747 4d4c  _DIMS);.    GGML
-00030530: 5f41 5353 4552 5428 6178 6973 3220 3e3d  _ASSERT(axis2 >=
-00030540: 2030 2026 2620 6178 6973 3220 3c20 4747   0 && axis2 < GG
-00030550: 4d4c 5f4d 4158 5f44 494d 5329 3b0a 2020  ML_MAX_DIMS);.  
-00030560: 2020 4747 4d4c 5f41 5353 4552 5428 6178    GGML_ASSERT(ax
-00030570: 6973 3320 3e3d 2030 2026 2620 6178 6973  is3 >= 0 && axis
-00030580: 3320 3c20 4747 4d4c 5f4d 4158 5f44 494d  3 < GGML_MAX_DIM
-00030590: 5329 3b0a 0a20 2020 2047 474d 4c5f 4153  S);..    GGML_AS
-000305a0: 5345 5254 2861 7869 7330 2021 3d20 6178  SERT(axis0 != ax
-000305b0: 6973 3129 3b0a 2020 2020 4747 4d4c 5f41  is1);.    GGML_A
-000305c0: 5353 4552 5428 6178 6973 3020 213d 2061  SSERT(axis0 != a
-000305d0: 7869 7332 293b 0a20 2020 2047 474d 4c5f  xis2);.    GGML_
-000305e0: 4153 5345 5254 2861 7869 7330 2021 3d20  ASSERT(axis0 != 
-000305f0: 6178 6973 3329 3b0a 2020 2020 4747 4d4c  axis3);.    GGML
-00030600: 5f41 5353 4552 5428 6178 6973 3120 213d  _ASSERT(axis1 !=
-00030610: 2061 7869 7332 293b 0a20 2020 2047 474d   axis2);.    GGM
-00030620: 4c5f 4153 5345 5254 2861 7869 7331 2021  L_ASSERT(axis1 !
-00030630: 3d20 6178 6973 3329 3b0a 2020 2020 4747  = axis3);.    GG
-00030640: 4d4c 5f41 5353 4552 5428 6178 6973 3220  ML_ASSERT(axis2 
-00030650: 213d 2061 7869 7333 293b 0a0a 2020 2020  != axis3);..    
-00030660: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
-00030670: 616c 7365 3b0a 0a20 2020 2069 6620 2861  alse;..    if (a
-00030680: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-00030690: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
-000306a0: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
-000306b0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000306c0: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
-000306d0: 7669 6577 5f74 656e 736f 7228 6374 782c  view_tensor(ctx,
-000306e0: 2061 293b 0a0a 2020 2020 696e 7420 6e65   a);..    int ne
-000306f0: 5b47 474d 4c5f 4d41 585f 4449 4d53 5d3b  [GGML_MAX_DIMS];
-00030700: 0a20 2020 2069 6e74 206e 625b 4747 4d4c  .    int nb[GGML
-00030710: 5f4d 4158 5f44 494d 535d 3b0a 0a20 2020  _MAX_DIMS];..   
-00030720: 206e 655b 6178 6973 305d 203d 2061 2d3e   ne[axis0] = a->
-00030730: 6e65 5b30 5d3b 0a20 2020 206e 655b 6178  ne[0];.    ne[ax
-00030740: 6973 315d 203d 2061 2d3e 6e65 5b31 5d3b  is1] = a->ne[1];
-00030750: 0a20 2020 206e 655b 6178 6973 325d 203d  .    ne[axis2] =
-00030760: 2061 2d3e 6e65 5b32 5d3b 0a20 2020 206e   a->ne[2];.    n
-00030770: 655b 6178 6973 335d 203d 2061 2d3e 6e65  e[axis3] = a->ne
-00030780: 5b33 5d3b 0a0a 2020 2020 6e62 5b61 7869  [3];..    nb[axi
-00030790: 7330 5d20 3d20 612d 3e6e 625b 305d 3b0a  s0] = a->nb[0];.
-000307a0: 2020 2020 6e62 5b61 7869 7331 5d20 3d20      nb[axis1] = 
-000307b0: 612d 3e6e 625b 315d 3b0a 2020 2020 6e62  a->nb[1];.    nb
-000307c0: 5b61 7869 7332 5d20 3d20 612d 3e6e 625b  [axis2] = a->nb[
-000307d0: 325d 3b0a 2020 2020 6e62 5b61 7869 7333  2];.    nb[axis3
-000307e0: 5d20 3d20 612d 3e6e 625b 335d 3b0a 0a20  ] = a->nb[3];.. 
-000307f0: 2020 2072 6573 756c 742d 3e6e 655b 305d     result->ne[0]
-00030800: 203d 206e 655b 305d 3b0a 2020 2020 7265   = ne[0];.    re
-00030810: 7375 6c74 2d3e 6e65 5b31 5d20 3d20 6e65  sult->ne[1] = ne
-00030820: 5b31 5d3b 0a20 2020 2072 6573 756c 742d  [1];.    result-
-00030830: 3e6e 655b 325d 203d 206e 655b 325d 3b0a  >ne[2] = ne[2];.
-00030840: 2020 2020 7265 7375 6c74 2d3e 6e65 5b33      result->ne[3
-00030850: 5d20 3d20 6e65 5b33 5d3b 0a0a 2020 2020  ] = ne[3];..    
-00030860: 7265 7375 6c74 2d3e 6e62 5b30 5d20 3d20  result->nb[0] = 
-00030870: 6e62 5b30 5d3b 0a20 2020 2072 6573 756c  nb[0];.    resul
-00030880: 742d 3e6e 625b 315d 203d 206e 625b 315d  t->nb[1] = nb[1]
-00030890: 3b0a 2020 2020 7265 7375 6c74 2d3e 6e62  ;.    result->nb
-000308a0: 5b32 5d20 3d20 6e62 5b32 5d3b 0a20 2020  [2] = nb[2];.   
-000308b0: 2072 6573 756c 742d 3e6e 625b 335d 203d   result->nb[3] =
-000308c0: 206e 625b 335d 3b0a 0a20 2020 2072 6573   nb[3];..    res
-000308d0: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
-000308e0: 5f4f 505f 5045 524d 5554 453b 0a20 2020  _OP_PERMUTE;.   
-000308f0: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
-00030900: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
-00030910: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
-00030920: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
-00030930: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
-00030940: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
-00030950: 3e73 7263 3120 3d20 4e55 4c4c 3b0a 0a20  >src1 = NULL;.. 
-00030960: 2020 2069 6620 2869 735f 6e6f 6465 2920     if (is_node) 
-00030970: 7b0a 2020 2020 2020 2020 6767 6d6c 5f73  {.        ggml_s
-00030980: 6372 6174 6368 5f73 6176 6528 6374 7829  cratch_save(ctx)
-00030990: 3b0a 0a20 2020 2020 2020 2073 7472 7563  ;..        struc
-000309a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000309b0: 6220 3d20 6767 6d6c 5f6e 6577 5f74 656e  b = ggml_new_ten
-000309c0: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
-000309d0: 5f54 5950 455f 4933 322c 2034 293b 0a0a  _TYPE_I32, 4);..
-000309e0: 2020 2020 2020 2020 2828 696e 7433 325f          ((int32_
-000309f0: 7420 2a29 2062 2d3e 6461 7461 295b 305d  t *) b->data)[0]
-00030a00: 203d 2061 7869 7330 3b0a 2020 2020 2020   = axis0;.      
-00030a10: 2020 2828 696e 7433 325f 7420 2a29 2062    ((int32_t *) b
-00030a20: 2d3e 6461 7461 295b 315d 203d 2061 7869  ->data)[1] = axi
-00030a30: 7331 3b0a 2020 2020 2020 2020 2828 696e  s1;.        ((in
-00030a40: 7433 325f 7420 2a29 2062 2d3e 6461 7461  t32_t *) b->data
-00030a50: 295b 325d 203d 2061 7869 7332 3b0a 2020  )[2] = axis2;.  
-00030a60: 2020 2020 2020 2828 696e 7433 325f 7420        ((int32_t 
-00030a70: 2a29 2062 2d3e 6461 7461 295b 335d 203d  *) b->data)[3] =
-00030a80: 2061 7869 7333 3b0a 0a20 2020 2020 2020   axis3;..       
-00030a90: 2067 676d 6c5f 7363 7261 7463 685f 6c6f   ggml_scratch_lo
-00030aa0: 6164 2863 7478 293b 0a0a 2020 2020 2020  ad(ctx);..      
-00030ab0: 2020 7265 7375 6c74 2d3e 6f70 745b 305d    result->opt[0]
-00030ac0: 203d 2062 3b0a 2020 2020 7d0a 0a20 2020   = b;.    }..   
-00030ad0: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-00030ae0: 7d0a 0a2f 2f20 6767 6d6c 5f74 7261 6e73  }..// ggml_trans
-00030af0: 706f 7365 0a0a 7374 7275 6374 2067 676d  pose..struct ggm
-00030b00: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-00030b10: 7472 616e 7370 6f73 6528 0a20 2020 2020  transpose(.     
-00030b20: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00030b30: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-00030b40: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00030b50: 6c5f 7465 6e73 6f72 2020 2a20 6129 207b  l_tensor  * a) {
-00030b60: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
-00030b70: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
-00030b80: 6966 2028 612d 3e67 7261 6429 207b 0a20  if (a->grad) {. 
-00030b90: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
-00030ba0: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
-00030bb0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00030bc0: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
-00030bd0: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
-00030be0: 2863 7478 2c20 6129 3b0a 0a20 2020 2072  (ctx, a);..    r
-00030bf0: 6573 756c 742d 3e6e 655b 305d 203d 2061  esult->ne[0] = a
-00030c00: 2d3e 6e65 5b31 5d3b 0a20 2020 2072 6573  ->ne[1];.    res
-00030c10: 756c 742d 3e6e 655b 315d 203d 2061 2d3e  ult->ne[1] = a->
-00030c20: 6e65 5b30 5d3b 0a0a 2020 2020 7265 7375  ne[0];..    resu
-00030c30: 6c74 2d3e 6e62 5b30 5d20 3d20 612d 3e6e  lt->nb[0] = a->n
-00030c40: 625b 315d 3b0a 2020 2020 7265 7375 6c74  b[1];.    result
-00030c50: 2d3e 6e62 5b31 5d20 3d20 612d 3e6e 625b  ->nb[1] = a->nb[
-00030c60: 305d 3b0a 0a20 2020 2072 6573 756c 742d  0];..    result-
-00030c70: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-00030c80: 5452 414e 5350 4f53 453b 0a20 2020 2072  TRANSPOSE;.    r
-00030c90: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
-00030ca0: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
-00030cb0: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
-00030cc0: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
-00030cd0: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-00030ce0: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-00030cf0: 7263 3120 3d20 4e55 4c4c 3b0a 0a20 2020  rc1 = NULL;..   
-00030d00: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-00030d10: 7d0a 0a2f 2f20 6767 6d6c 5f67 6574 5f72  }..// ggml_get_r
-00030d20: 6f77 730a 0a73 7472 7563 7420 6767 6d6c  ows..struct ggml
-00030d30: 5f74 656e 736f 7220 2a20 6767 6d6c 5f67  _tensor * ggml_g
-00030d40: 6574 5f72 6f77 7328 0a20 2020 2020 2020  et_rows(.       
-00030d50: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-00030d60: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-00030d70: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00030d80: 7465 6e73 6f72 2020 2a20 612c 0a20 2020  tensor  * a,.   
-00030d90: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00030da0: 5f74 656e 736f 7220 202a 2062 2920 7b0a  _tensor  * b) {.
-00030db0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00030dc0: 6767 6d6c 5f69 735f 6d61 7472 6978 2861  ggml_is_matrix(a
-00030dd0: 2920 2626 2067 676d 6c5f 6973 5f76 6563  ) && ggml_is_vec
-00030de0: 746f 7228 6229 2026 2620 622d 3e74 7970  tor(b) && b->typ
-00030df0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
-00030e00: 3332 293b 0a0a 2020 2020 626f 6f6c 2069  32);..    bool i
-00030e10: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
-00030e20: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
-00030e30: 207c 7c20 622d 3e67 7261 6429 207b 0a20   || b->grad) {. 
-00030e40: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
-00030e50: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
-00030e60: 2020 2f2f 2054 4f44 4f3a 2069 6d70 6c65    // TODO: imple
-00030e70: 6d65 6e74 206e 6f6e 2046 3332 2072 6574  ment non F32 ret
-00030e80: 7572 6e0a 2020 2020 2f2f 7374 7275 6374  urn.    //struct
-00030e90: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
-00030ea0: 6573 756c 7420 3d20 6767 6d6c 5f6e 6577  esult = ggml_new
-00030eb0: 5f74 656e 736f 725f 3264 2863 7478 2c20  _tensor_2d(ctx, 
-00030ec0: 612d 3e74 7970 652c 2061 2d3e 6e65 5b30  a->type, a->ne[0
-00030ed0: 5d2c 2062 2d3e 6e65 5b30 5d29 3b0a 2020  ], b->ne[0]);.  
-00030ee0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00030ef0: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
-00030f00: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
-00030f10: 3264 2863 7478 2c20 4747 4d4c 5f54 5950  2d(ctx, GGML_TYP
-00030f20: 455f 4633 322c 2061 2d3e 6e65 5b30 5d2c  E_F32, a->ne[0],
-00030f30: 2062 2d3e 6e65 5b30 5d29 3b0a 0a20 2020   b->ne[0]);..   
-00030f40: 2072 6573 756c 742d 3e6f 7020 2020 3d20   result->op   = 
-00030f50: 4747 4d4c 5f4f 505f 4745 545f 524f 5753  GGML_OP_GET_ROWS
-00030f60: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
-00030f70: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
-00030f80: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-00030f90: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
-00030fa0: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
-00030fb0: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
-00030fc0: 7375 6c74 2d3e 7372 6331 203d 2062 3b0a  sult->src1 = b;.
-00030fd0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-00030fe0: 6c74 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f67  lt;.}..// ggml_g
-00030ff0: 6574 5f72 6f77 735f 6261 636b 0a0a 7374  et_rows_back..st
-00031000: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00031010: 202a 2067 676d 6c5f 6765 745f 726f 7773   * ggml_get_rows
-00031020: 5f62 6163 6b28 0a20 2020 2020 2020 2073  _back(.        s
-00031030: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00031040: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00031050: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00031060: 6e73 6f72 2020 2a20 612c 0a20 2020 2020  nsor  * a,.     
-00031070: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00031080: 656e 736f 7220 202a 2062 2c0a 2020 2020  ensor  * b,.    
-00031090: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000310a0: 7465 6e73 6f72 2020 2a20 6329 207b 0a20  tensor  * c) {. 
-000310b0: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-000310c0: 676d 6c5f 6973 5f6d 6174 7269 7828 6129  gml_is_matrix(a)
-000310d0: 2026 2620 6767 6d6c 5f69 735f 7665 6374   && ggml_is_vect
-000310e0: 6f72 2862 2920 2626 2062 2d3e 7479 7065  or(b) && b->type
-000310f0: 203d 3d20 4747 4d4c 5f54 5950 455f 4933   == GGML_TYPE_I3
-00031100: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
-00031110: 4552 5428 6767 6d6c 5f69 735f 6d61 7472  ERT(ggml_is_matr
-00031120: 6978 2863 2920 2626 2028 612d 3e6e 655b  ix(c) && (a->ne[
-00031130: 305d 203d 3d20 632d 3e6e 655b 305d 2929  0] == c->ne[0]))
-00031140: 3b0a 0a20 2020 2062 6f6f 6c20 6973 5f6e  ;..    bool is_n
-00031150: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
-00031160: 2020 6966 2028 612d 3e67 7261 6420 7c7c    if (a->grad ||
-00031170: 2062 2d3e 6772 6164 2920 7b0a 2020 2020   b->grad) {.    
-00031180: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-00031190: 7565 3b0a 2020 2020 7d0a 0a20 2020 202f  ue;.    }..    /
-000311a0: 2f20 544f 444f 3a20 696d 706c 656d 656e  / TODO: implemen
-000311b0: 7420 6e6f 6e20 4633 3220 7265 7475 726e  t non F32 return
-000311c0: 0a20 2020 202f 2f73 7472 7563 7420 6767  .    //struct gg
-000311d0: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-000311e0: 6c74 203d 2067 676d 6c5f 6e65 775f 7465  lt = ggml_new_te
-000311f0: 6e73 6f72 5f32 6428 6374 782c 2061 2d3e  nsor_2d(ctx, a->
-00031200: 7479 7065 2c20 612d 3e6e 655b 305d 2c20  type, a->ne[0], 
-00031210: 622d 3e6e 655b 305d 293b 0a20 2020 2073  b->ne[0]);.    s
-00031220: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00031230: 7220 2a20 7265 7375 6c74 203d 2067 676d  r * result = ggm
-00031240: 6c5f 6e65 775f 7465 6e73 6f72 5f32 6428  l_new_tensor_2d(
-00031250: 6374 782c 2047 474d 4c5f 5459 5045 5f46  ctx, GGML_TYPE_F
-00031260: 3332 2c20 632d 3e6e 655b 305d 2c20 632d  32, c->ne[0], c-
-00031270: 3e6e 655b 315d 293b 0a0a 2020 2020 7265  >ne[1]);..    re
-00031280: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-00031290: 4c5f 4f50 5f47 4554 5f52 4f57 535f 4241  L_OP_GET_ROWS_BA
-000312a0: 434b 3b0a 2020 2020 7265 7375 6c74 2d3e  CK;.    result->
-000312b0: 6772 6164 203d 2069 735f 6e6f 6465 203f  grad = is_node ?
-000312c0: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-000312d0: 2863 7478 2c20 7265 7375 6c74 2920 3a20  (ctx, result) : 
-000312e0: 4e55 4c4c 3b0a 2020 2020 7265 7375 6c74  NULL;.    result
-000312f0: 2d3e 7372 6330 203d 2061 3b0a 2020 2020  ->src0 = a;.    
-00031300: 7265 7375 6c74 2d3e 7372 6331 203d 2062  result->src1 = b
-00031310: 3b0a 2020 2020 7265 7375 6c74 2d3e 6f70  ;.    result->op
-00031320: 745b 305d 203d 2063 3b0a 0a20 2020 2072  t[0] = c;..    r
-00031330: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-00031340: 0a2f 2f20 6767 6d6c 5f64 6961 670a 0a73  .// ggml_diag..s
-00031350: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00031360: 7220 2a20 6767 6d6c 5f64 6961 6728 0a20  r * ggml_diag(. 
-00031370: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00031380: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00031390: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-000313a0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-000313b0: 6129 207b 0a20 2020 2047 474d 4c5f 4153  a) {.    GGML_AS
-000313c0: 5345 5254 2861 2d3e 6e65 5b31 5d20 3d3d  SERT(a->ne[1] ==
-000313d0: 2031 293b 0a20 2020 2062 6f6f 6c20 6973   1);.    bool is
-000313e0: 5f6e 6f64 6520 3d20 6661 6c73 653b 0a0a  _node = false;..
-000313f0: 2020 2020 6966 2028 612d 3e67 7261 6429      if (a->grad)
-00031400: 207b 0a20 2020 2020 2020 2069 735f 6e6f   {.        is_no
-00031410: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
-00031420: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-00031430: 345f 7420 6e65 5b34 5d20 3d20 7b20 612d  4_t ne[4] = { a-
-00031440: 3e6e 655b 305d 2c20 612d 3e6e 655b 305d  >ne[0], a->ne[0]
-00031450: 2c20 612d 3e6e 655b 325d 2c20 612d 3e6e  , a->ne[2], a->n
-00031460: 655b 335d 207d 3b0a 2020 2020 7374 7275  e[3] };.    stru
-00031470: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00031480: 2072 6573 756c 7420 3d20 6767 6d6c 5f6e   result = ggml_n
-00031490: 6577 5f74 656e 736f 7228 6374 782c 2061  ew_tensor(ctx, a
-000314a0: 2d3e 7479 7065 2c20 4d41 5828 612d 3e6e  ->type, MAX(a->n
-000314b0: 5f64 696d 732c 2032 292c 206e 6529 3b0a  _dims, 2), ne);.
-000314c0: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
-000314d0: 2020 3d20 4747 4d4c 5f4f 505f 4449 4147    = GGML_OP_DIAG
-000314e0: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
-000314f0: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
-00031500: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-00031510: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
-00031520: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
-00031530: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
-00031540: 7375 6c74 2d3e 7372 6331 203d 204e 554c  sult->src1 = NUL
-00031550: 4c3b 0a0a 2020 2020 7265 7475 726e 2072  L;..    return r
-00031560: 6573 756c 743b 0a7d 0a0a 0a2f 2f20 6767  esult;.}...// gg
-00031570: 6d6c 5f64 6961 675f 6d61 736b 5f69 6e66  ml_diag_mask_inf
-00031580: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-00031590: 6e73 6f72 202a 2067 676d 6c5f 6469 6167  nsor * ggml_diag
-000315a0: 5f6d 6173 6b5f 696e 665f 696d 706c 280a  _mask_inf_impl(.
-000315b0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000315c0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-000315d0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-000315e0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-000315f0: 2061 2c0a 2020 2020 2020 2020 696e 7420   a,.        int 
-00031600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031610: 2020 6e5f 7061 7374 2c0a 2020 2020 2020    n_past,.      
-00031620: 2020 626f 6f6c 2020 2020 2020 2020 2020    bool          
-00031630: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-00031640: 207b 0a20 2020 2062 6f6f 6c20 6973 5f6e   {.    bool is_n
-00031650: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
-00031660: 2020 6966 2028 612d 3e67 7261 6429 207b    if (a->grad) {
-00031670: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
-00031680: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
-00031690: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000316a0: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
-000316b0: 3d20 696e 706c 6163 6520 3f20 6767 6d6c  = inplace ? ggml
-000316c0: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
-000316d0: 2c20 6129 203a 2067 676d 6c5f 6475 705f  , a) : ggml_dup_
-000316e0: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
-000316f0: 0a20 2020 2067 676d 6c5f 7363 7261 7463  .    ggml_scratc
-00031700: 685f 7361 7665 2863 7478 293b 0a0a 2020  h_save(ctx);..  
-00031710: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00031720: 6e73 6f72 202a 2062 203d 2067 676d 6c5f  nsor * b = ggml_
-00031730: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-00031740: 782c 2047 474d 4c5f 5459 5045 5f49 3332  x, GGML_TYPE_I32
-00031750: 2c20 3229 3b0a 0a20 2020 2028 2869 6e74  , 2);..    ((int
-00031760: 3332 5f74 202a 2920 622d 3e64 6174 6129  32_t *) b->data)
-00031770: 5b30 5d20 3d20 6e5f 7061 7374 3b0a 2020  [0] = n_past;.  
-00031780: 2020 2828 696e 7433 325f 7420 2a29 2062    ((int32_t *) b
-00031790: 2d3e 6461 7461 295b 315d 203d 2069 6e70  ->data)[1] = inp
-000317a0: 6c61 6365 203f 2031 203a 2030 3b0a 0a20  lace ? 1 : 0;.. 
-000317b0: 2020 2067 676d 6c5f 7363 7261 7463 685f     ggml_scratch_
-000317c0: 6c6f 6164 2863 7478 293b 0a0a 2020 2020  load(ctx);..    
-000317d0: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
-000317e0: 474d 4c5f 4f50 5f44 4941 475f 4d41 534b  GML_OP_DIAG_MASK
-000317f0: 5f49 4e46 3b0a 2020 2020 7265 7375 6c74  _INF;.    result
-00031800: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
-00031810: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
-00031820: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
-00031830: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
-00031840: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
-00031850: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
-00031860: 2062 3b0a 0a20 2020 2072 6574 7572 6e20   b;..    return 
-00031870: 7265 7375 6c74 3b0a 7d0a 0a73 7472 7563  result;.}..struc
-00031880: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00031890: 6767 6d6c 5f64 6961 675f 6d61 736b 5f69  ggml_diag_mask_i
-000318a0: 6e66 280a 2020 2020 2020 2020 7374 7275  nf(.        stru
-000318b0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-000318c0: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-000318d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000318e0: 7220 202a 2061 2c0a 2020 2020 2020 2020  r  * a,.        
-000318f0: 696e 7420 2020 2020 2020 2020 2020 2020  int             
-00031900: 2020 2020 2020 6e5f 7061 7374 2920 7b0a        n_past) {.
-00031910: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
-00031920: 6469 6167 5f6d 6173 6b5f 696e 665f 696d  diag_mask_inf_im
-00031930: 706c 2863 7478 2c20 612c 206e 5f70 6173  pl(ctx, a, n_pas
-00031940: 742c 2066 616c 7365 293b 0a7d 0a0a 0a73  t, false);.}...s
-00031950: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00031960: 7220 2a20 6767 6d6c 5f64 6961 675f 6d61  r * ggml_diag_ma
-00031970: 736b 5f69 6e66 5f69 6e70 6c61 6365 280a  sk_inf_inplace(.
-00031980: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00031990: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-000319a0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-000319b0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-000319c0: 2061 2c0a 2020 2020 2020 2020 696e 7420   a,.        int 
-000319d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319e0: 2020 6e5f 7061 7374 2920 7b0a 2020 2020    n_past) {.    
-000319f0: 7265 7475 726e 2067 676d 6c5f 6469 6167  return ggml_diag
-00031a00: 5f6d 6173 6b5f 696e 665f 696d 706c 2863  _mask_inf_impl(c
-00031a10: 7478 2c20 612c 206e 5f70 6173 742c 2074  tx, a, n_past, t
-00031a20: 7275 6529 3b0a 7d0a 0a2f 2f20 6767 6d6c  rue);.}..// ggml
-00031a30: 5f64 6961 675f 6d61 736b 5f7a 6572 6f0a  _diag_mask_zero.
-00031a40: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-00031a50: 736f 7220 2a20 6767 6d6c 5f64 6961 675f  sor * ggml_diag_
-00031a60: 6d61 736b 5f7a 6572 6f5f 696d 706c 280a  mask_zero_impl(.
-00031a70: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00031a80: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-00031a90: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-00031aa0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-00031ab0: 2061 2c0a 2020 2020 2020 2020 696e 7420   a,.        int 
-00031ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031ad0: 2020 6e5f 7061 7374 2c0a 2020 2020 2020    n_past,.      
-00031ae0: 2020 626f 6f6c 2020 2020 2020 2020 2020    bool          
-00031af0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-00031b00: 207b 0a20 2020 2062 6f6f 6c20 6973 5f6e   {.    bool is_n
-00031b10: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
-00031b20: 2020 6966 2028 612d 3e67 7261 6429 207b    if (a->grad) {
-00031b30: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
-00031b40: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
-00031b50: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00031b60: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
-00031b70: 3d20 696e 706c 6163 6520 3f20 6767 6d6c  = inplace ? ggml
-00031b80: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
-00031b90: 2c20 6129 203a 2067 676d 6c5f 6475 705f  , a) : ggml_dup_
-00031ba0: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
-00031bb0: 0a20 2020 2067 676d 6c5f 7363 7261 7463  .    ggml_scratc
-00031bc0: 685f 7361 7665 2863 7478 293b 0a0a 2020  h_save(ctx);..  
-00031bd0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00031be0: 6e73 6f72 202a 2062 203d 2067 676d 6c5f  nsor * b = ggml_
-00031bf0: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-00031c00: 782c 2047 474d 4c5f 5459 5045 5f49 3332  x, GGML_TYPE_I32
-00031c10: 2c20 3229 3b0a 2020 2020 6767 6d6c 5f73  , 2);.    ggml_s
-00031c20: 6574 5f6e 616d 6528 622c 2022 6e5f 7061  et_name(b, "n_pa
-00031c30: 7374 2c20 696e 706c 6163 6522 293b 0a0a  st, inplace");..
-00031c40: 2020 2020 2828 696e 7433 325f 7420 2a29      ((int32_t *)
-00031c50: 2062 2d3e 6461 7461 295b 305d 203d 206e   b->data)[0] = n
-00031c60: 5f70 6173 743b 0a20 2020 2028 2869 6e74  _past;.    ((int
-00031c70: 3332 5f74 202a 2920 622d 3e64 6174 6129  32_t *) b->data)
-00031c80: 5b31 5d20 3d20 696e 706c 6163 6520 3f20  [1] = inplace ? 
-00031c90: 3120 3a20 303b 0a0a 2020 2020 6767 6d6c  1 : 0;..    ggml
-00031ca0: 5f73 6372 6174 6368 5f6c 6f61 6428 6374  _scratch_load(ct
-00031cb0: 7829 3b0a 0a20 2020 2072 6573 756c 742d  x);..    result-
-00031cc0: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-00031cd0: 4449 4147 5f4d 4153 4b5f 5a45 524f 3b0a  DIAG_MASK_ZERO;.
-00031ce0: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
-00031cf0: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
-00031d00: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
-00031d10: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
-00031d20: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-00031d30: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
-00031d40: 6c74 2d3e 7372 6331 203d 2062 3b0a 0a20  lt->src1 = b;.. 
-00031d50: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00031d60: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
-00031d70: 5f74 656e 736f 7220 2a20 6767 6d6c 5f64  _tensor * ggml_d
-00031d80: 6961 675f 6d61 736b 5f7a 6572 6f28 0a20  iag_mask_zero(. 
-00031d90: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00031da0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00031db0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00031dc0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-00031dd0: 612c 0a20 2020 2020 2020 2069 6e74 2020  a,.        int  
-00031de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031df0: 206e 5f70 6173 7429 207b 0a20 2020 2072   n_past) {.    r
-00031e00: 6574 7572 6e20 6767 6d6c 5f64 6961 675f  eturn ggml_diag_
-00031e10: 6d61 736b 5f7a 6572 6f5f 696d 706c 2863  mask_zero_impl(c
-00031e20: 7478 2c20 612c 206e 5f70 6173 742c 2066  tx, a, n_past, f
-00031e30: 616c 7365 293b 0a7d 0a0a 7374 7275 6374  alse);.}..struct
-00031e40: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-00031e50: 676d 6c5f 6469 6167 5f6d 6173 6b5f 7a65  gml_diag_mask_ze
-00031e60: 726f 5f69 6e70 6c61 6365 280a 2020 2020  ro_inplace(.    
-00031e70: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00031e80: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-00031e90: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00031ea0: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
-00031eb0: 2020 2020 2020 2020 696e 7420 2020 2020          int     
-00031ec0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-00031ed0: 7061 7374 2920 7b0a 2020 2020 7265 7475  past) {.    retu
-00031ee0: 726e 2067 676d 6c5f 6469 6167 5f6d 6173  rn ggml_diag_mas
-00031ef0: 6b5f 7a65 726f 5f69 6d70 6c28 6374 782c  k_zero_impl(ctx,
-00031f00: 2061 2c20 6e5f 7061 7374 2c20 7472 7565   a, n_past, true
-00031f10: 293b 0a7d 0a0a 2f2f 2067 676d 6c5f 736f  );.}..// ggml_so
-00031f20: 6674 5f6d 6178 0a0a 7374 7275 6374 2067  ft_max..struct g
-00031f30: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-00031f40: 6c5f 736f 6674 5f6d 6178 5f69 6d70 6c28  l_soft_max_impl(
-00031f50: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00031f60: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00031f70: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-00031f80: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
-00031f90: 2a20 612c 0a20 2020 2020 2020 2062 6f6f  * a,.        boo
-00031fa0: 6c20 2020 2020 2020 2020 2020 2020 2020  l               
-00031fb0: 2020 2069 6e70 6c61 6365 2920 7b0a 2020     inplace) {.  
-00031fc0: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
-00031fd0: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
-00031fe0: 2861 2d3e 6772 6164 2920 7b0a 2020 2020  (a->grad) {.    
-00031ff0: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-00032000: 7565 3b0a 2020 2020 7d0a 0a20 2020 2073  ue;.    }..    s
-00032010: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00032020: 7220 2a20 7265 7375 6c74 203d 2069 6e70  r * result = inp
-00032030: 6c61 6365 203f 2067 676d 6c5f 7669 6577  lace ? ggml_view
-00032040: 5f74 656e 736f 7228 6374 782c 2061 2920  _tensor(ctx, a) 
-00032050: 3a20 6767 6d6c 5f64 7570 5f74 656e 736f  : ggml_dup_tenso
-00032060: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
-00032070: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
-00032080: 474d 4c5f 4f50 5f53 4f46 545f 4d41 583b  GML_OP_SOFT_MAX;
-00032090: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
-000320a0: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
-000320b0: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
-000320c0: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
-000320d0: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
-000320e0: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
-000320f0: 756c 742d 3e73 7263 3120 3d20 4e55 4c4c  ult->src1 = NULL
-00032100: 3b0a 0a20 2020 2072 6574 7572 6e20 7265  ;..    return re
-00032110: 7375 6c74 3b0a 7d0a 0a73 7472 7563 7420  sult;.}..struct 
-00032120: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-00032130: 6d6c 5f73 6f66 745f 6d61 7828 0a20 2020  ml_soft_max(.   
-00032140: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00032150: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-00032160: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00032170: 676d 6c5f 7465 6e73 6f72 2020 2a20 6129  gml_tensor  * a)
-00032180: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
-00032190: 6d6c 5f73 6f66 745f 6d61 785f 696d 706c  ml_soft_max_impl
-000321a0: 2863 7478 2c20 612c 2066 616c 7365 293b  (ctx, a, false);
-000321b0: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-000321c0: 7465 6e73 6f72 202a 2067 676d 6c5f 736f  tensor * ggml_so
-000321d0: 6674 5f6d 6178 5f69 6e70 6c61 6365 280a  ft_max_inplace(.
-000321e0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000321f0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-00032200: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-00032210: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-00032220: 2061 2920 7b0a 2020 2020 7265 7475 726e   a) {.    return
-00032230: 2067 676d 6c5f 736f 6674 5f6d 6178 5f69   ggml_soft_max_i
-00032240: 6d70 6c28 6374 782c 2061 2c20 7472 7565  mpl(ctx, a, true
-00032250: 293b 0a7d 0a0a 0a2f 2f20 6767 6d6c 5f73  );.}...// ggml_s
-00032260: 6f66 745f 6d61 785f 6261 636b 0a0a 7374  oft_max_back..st
-00032270: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00032280: 202a 2067 676d 6c5f 736f 6674 5f6d 6178   * ggml_soft_max
-00032290: 5f62 6163 6b5f 696d 706c 280a 2020 2020  _back_impl(.    
-000322a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000322b0: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-000322c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000322d0: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
-000322e0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000322f0: 676d 6c5f 7465 6e73 6f72 2020 2a20 622c  gml_tensor  * b,
-00032300: 0a20 2020 2020 2020 2062 6f6f 6c20 2020  .        bool   
-00032310: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00032320: 6e70 6c61 6365 2920 7b0a 2020 2020 626f  nplace) {.    bo
-00032330: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-00032340: 7365 3b0a 0a20 2020 2069 6620 2861 2d3e  se;..    if (a->
-00032350: 6772 6164 207c 7c20 622d 3e67 7261 6429  grad || b->grad)
-00032360: 207b 0a20 2020 2020 2020 2069 735f 6e6f   {.        is_no
-00032370: 6465 203d 2074 7275 653b 202f 2f20 544f  de = true; // TO
-00032380: 444f 203a 2069 6d70 6c65 6d65 6e74 2062  DO : implement b
-00032390: 6163 6b77 6172 6420 7061 7373 0a20 2020  ackward pass.   
-000323a0: 207d 0a0a 2020 2020 7374 7275 6374 2067   }..    struct g
-000323b0: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
-000323c0: 756c 7420 3d20 696e 706c 6163 6520 3f20  ult = inplace ? 
-000323d0: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
-000323e0: 2863 7478 2c20 6129 203a 2067 676d 6c5f  (ctx, a) : ggml_
-000323f0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-00032400: 6129 3b0a 0a20 2020 2072 6573 756c 742d  a);..    result-
-00032410: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-00032420: 534f 4654 5f4d 4158 5f42 4143 4b3b 0a20  SOFT_MAX_BACK;. 
-00032430: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
-00032440: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
-00032450: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-00032460: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
-00032470: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-00032480: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
-00032490: 742d 3e73 7263 3120 3d20 623b 0a0a 2020  t->src1 = b;..  
-000324a0: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
-000324b0: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
-000324c0: 7465 6e73 6f72 202a 2067 676d 6c5f 736f  tensor * ggml_so
-000324d0: 6674 5f6d 6178 5f62 6163 6b28 0a20 2020  ft_max_back(.   
-000324e0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000324f0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-00032500: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00032510: 676d 6c5f 7465 6e73 6f72 2020 2a20 612c  gml_tensor  * a,
-00032520: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00032530: 6767 6d6c 5f74 656e 736f 7220 202a 2062  ggml_tensor  * b
-00032540: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
-00032550: 676d 6c5f 736f 6674 5f6d 6178 5f62 6163  gml_soft_max_bac
-00032560: 6b5f 696d 706c 2863 7478 2c20 612c 2062  k_impl(ctx, a, b
-00032570: 2c20 6661 6c73 6529 3b0a 7d0a 0a73 7472  , false);.}..str
-00032580: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00032590: 2a20 6767 6d6c 5f73 6f66 745f 6d61 785f  * ggml_soft_max_
-000325a0: 6261 636b 5f69 6e70 6c61 6365 280a 2020  back_inplace(.  
-000325b0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-000325c0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
-000325d0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-000325e0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
-000325f0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00032600: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-00032610: 6229 207b 0a20 2020 2072 6574 7572 6e20  b) {.    return 
-00032620: 6767 6d6c 5f73 6f66 745f 6d61 785f 6261  ggml_soft_max_ba
-00032630: 636b 5f69 6d70 6c28 6374 782c 2061 2c20  ck_impl(ctx, a, 
-00032640: 622c 2074 7275 6529 3b0a 7d0a 0a2f 2f20  b, true);.}..// 
-00032650: 6767 6d6c 5f72 6f70 650a 0a73 7472 7563  ggml_rope..struc
-00032660: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00032670: 6767 6d6c 5f72 6f70 655f 696d 706c 280a  ggml_rope_impl(.
-00032680: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00032690: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-000326a0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-000326b0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
-000326c0: 2061 2c0a 2020 2020 2020 2020 696e 7420   a,.        int 
-000326d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000326e0: 2020 6e5f 7061 7374 2c0a 2020 2020 2020    n_past,.      
-000326f0: 2020 696e 7420 2020 2020 2020 2020 2020    int           
-00032700: 2020 2020 2020 2020 6e5f 6469 6d73 2c0a          n_dims,.
-00032710: 2020 2020 2020 2020 696e 7420 2020 2020          int     
-00032720: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-00032730: 6465 2c0a 2020 2020 2020 2020 626f 6f6c  de,.        bool
-00032740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032750: 2020 696e 706c 6163 6529 207b 0a20 2020    inplace) {.   
-00032760: 2047 474d 4c5f 4153 5345 5254 286e 5f70   GGML_ASSERT(n_p
-00032770: 6173 7420 3e3d 2030 293b 0a20 2020 2062  ast >= 0);.    b
-00032780: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-00032790: 6c73 653b 0a0a 2020 2020 6966 2028 612d  lse;..    if (a-
-000327a0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-000327b0: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
-000327c0: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
-000327d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000327e0: 2072 6573 756c 7420 3d20 696e 706c 6163   result = inplac
-000327f0: 6520 3f20 6767 6d6c 5f76 6965 775f 7465  e ? ggml_view_te
-00032800: 6e73 6f72 2863 7478 2c20 6129 203a 2067  nsor(ctx, a) : g
-00032810: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-00032820: 7478 2c20 6129 3b0a 0a20 2020 2067 676d  tx, a);..    ggm
-00032830: 6c5f 7363 7261 7463 685f 7361 7665 2863  l_scratch_save(c
-00032840: 7478 293b 0a0a 2020 2020 7374 7275 6374  tx);..    struct
-00032850: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
-00032860: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
-00032870: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
-00032880: 5459 5045 5f49 3332 2c20 3329 3b0a 0a20  TYPE_I32, 3);.. 
-00032890: 2020 2028 2869 6e74 3332 5f74 202a 2920     ((int32_t *) 
-000328a0: 622d 3e64 6174 6129 5b30 5d20 3d20 6e5f  b->data)[0] = n_
-000328b0: 7061 7374 3b0a 2020 2020 2828 696e 7433  past;.    ((int3
-000328c0: 325f 7420 2a29 2062 2d3e 6461 7461 295b  2_t *) b->data)[
-000328d0: 315d 203d 206e 5f64 696d 733b 0a20 2020  1] = n_dims;.   
-000328e0: 2028 2869 6e74 3332 5f74 202a 2920 622d   ((int32_t *) b-
-000328f0: 3e64 6174 6129 5b32 5d20 3d20 6d6f 6465  >data)[2] = mode
-00032900: 3b0a 0a20 2020 2067 676d 6c5f 7363 7261  ;..    ggml_scra
-00032910: 7463 685f 6c6f 6164 2863 7478 293b 0a0a  tch_load(ctx);..
-00032920: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-00032930: 203d 2047 474d 4c5f 4f50 5f52 4f50 453b   = GGML_OP_ROPE;
-00032940: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
-00032950: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
-00032960: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
-00032970: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
-00032980: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
-00032990: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
-000329a0: 756c 742d 3e73 7263 3120 3d20 623b 0a0a  ult->src1 = b;..
-000329b0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-000329c0: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
-000329d0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-000329e0: 726f 7065 280a 2020 2020 2020 2020 7374  rope(.        st
-000329f0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-00032a00: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
-00032a10: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00032a20: 736f 7220 202a 2061 2c0a 2020 2020 2020  sor  * a,.      
-00032a30: 2020 696e 7420 2020 2020 2020 2020 2020    int           
-00032a40: 2020 2020 2020 2020 6e5f 7061 7374 2c0a          n_past,.
-00032a50: 2020 2020 2020 2020 696e 7420 2020 2020          int     
-00032a60: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-00032a70: 6469 6d73 2c0a 2020 2020 2020 2020 696e  dims,.        in
-00032a80: 7420 2020 2020 2020 2020 2020 2020 2020  t               
-00032a90: 2020 2020 6d6f 6465 2920 7b0a 2020 2020      mode) {.    
-00032aa0: 7265 7475 726e 2067 676d 6c5f 726f 7065  return ggml_rope
-00032ab0: 5f69 6d70 6c28 6374 782c 2061 2c20 6e5f  _impl(ctx, a, n_
-00032ac0: 7061 7374 2c20 6e5f 6469 6d73 2c20 6d6f  past, n_dims, mo
-00032ad0: 6465 2c20 6661 6c73 6529 3b0a 7d0a 0a73  de, false);.}..s
-00032ae0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00032af0: 7220 2a20 6767 6d6c 5f72 6f70 655f 696e  r * ggml_rope_in
-00032b00: 706c 6163 6528 0a20 2020 2020 2020 2073  place(.        s
-00032b10: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00032b20: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00032b30: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00032b40: 6e73 6f72 2020 2a20 612c 0a20 2020 2020  nsor  * a,.     
-00032b50: 2020 2069 6e74 2020 2020 2020 2020 2020     int          
-00032b60: 2020 2020 2020 2020 206e 5f70 6173 742c           n_past,
-00032b70: 0a20 2020 2020 2020 2069 6e74 2020 2020  .        int    
-00032b80: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00032b90: 5f64 696d 732c 0a20 2020 2020 2020 2069  _dims,.        i
-00032ba0: 6e74 2020 2020 2020 2020 2020 2020 2020  nt              
-00032bb0: 2020 2020 206d 6f64 6529 207b 0a20 2020       mode) {.   
-00032bc0: 2072 6574 7572 6e20 6767 6d6c 5f72 6f70   return ggml_rop
-00032bd0: 655f 696d 706c 2863 7478 2c20 612c 206e  e_impl(ctx, a, n
-00032be0: 5f70 6173 742c 206e 5f64 696d 732c 206d  _past, n_dims, m
-00032bf0: 6f64 652c 2074 7275 6529 3b0a 7d0a 0a2f  ode, true);.}../
-00032c00: 2f20 6767 6d6c 5f72 6f70 655f 6261 636b  / ggml_rope_back
-00032c10: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
-00032c20: 6e73 6f72 202a 2067 676d 6c5f 726f 7065  nsor * ggml_rope
-00032c30: 5f62 6163 6b28 0a20 2020 2020 2020 2073  _back(.        s
-00032c40: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
-00032c50: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
-00032c60: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00032c70: 6e73 6f72 2020 2a20 612c 0a20 2020 2020  nsor  * a,.     
-00032c80: 2020 2069 6e74 2020 2020 2020 2020 2020     int          
-00032c90: 2020 2020 2020 2020 206e 5f70 6173 742c           n_past,
-00032ca0: 0a20 2020 2020 2020 2069 6e74 2020 2020  .        int    
-00032cb0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00032cc0: 5f64 696d 732c 0a20 2020 2020 2020 2069  _dims,.        i
-00032cd0: 6e74 2020 2020 2020 2020 2020 2020 2020  nt              
-00032ce0: 2020 2020 206d 6f64 6529 207b 0a20 2020       mode) {.   
-00032cf0: 2047 474d 4c5f 4153 5345 5254 286e 5f70   GGML_ASSERT(n_p
-00032d00: 6173 7420 3e3d 2030 293b 0a20 2020 2062  ast >= 0);.    b
-00032d10: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-00032d20: 6c73 653b 0a0a 2020 2020 6966 2028 612d  lse;..    if (a-
-00032d30: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-00032d40: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
-00032d50: 3b20 2f2f 2054 4f44 4f3a 2069 6d70 6c65  ; // TODO: imple
-00032d60: 6d65 6e74 2062 6163 6b77 6172 640a 2020  ment backward.  
-00032d70: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
-00032d80: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
-00032d90: 7375 6c74 203d 2067 676d 6c5f 6475 705f  sult = ggml_dup_
-00032da0: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
-00032db0: 0a20 2020 2067 676d 6c5f 7363 7261 7463  .    ggml_scratc
-00032dc0: 685f 7361 7665 2863 7478 293b 0a0a 2020  h_save(ctx);..  
-00032dd0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00032de0: 6e73 6f72 202a 2062 203d 2067 676d 6c5f  nsor * b = ggml_
-00032df0: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-00032e00: 782c 2047 474d 4c5f 5459 5045 5f49 3332  x, GGML_TYPE_I32
-00032e10: 2c20 3329 3b0a 2020 2020 6767 6d6c 5f73  , 3);.    ggml_s
-00032e20: 6574 5f6e 616d 6528 622c 2022 6e5f 7061  et_name(b, "n_pa
-00032e30: 7374 2c20 6e5f 6469 6d73 2c20 6d6f 6465  st, n_dims, mode
-00032e40: 2229 3b0a 0a20 2020 2028 2869 6e74 3332  ");..    ((int32
-00032e50: 5f74 202a 2920 622d 3e64 6174 6129 5b30  _t *) b->data)[0
-00032e60: 5d20 3d20 6e5f 7061 7374 3b0a 2020 2020  ] = n_past;.    
-00032e70: 2828 696e 7433 325f 7420 2a29 2062 2d3e  ((int32_t *) b->
-00032e80: 6461 7461 295b 315d 203d 206e 5f64 696d  data)[1] = n_dim
-00032e90: 733b 0a20 2020 2028 2869 6e74 3332 5f74  s;.    ((int32_t
-00032ea0: 202a 2920 622d 3e64 6174 6129 5b32 5d20   *) b->data)[2] 
-00032eb0: 3d20 6d6f 6465 3b0a 0a20 2020 2067 676d  = mode;..    ggm
-00032ec0: 6c5f 7363 7261 7463 685f 6c6f 6164 2863  l_scratch_load(c
-00032ed0: 7478 293b 0a0a 2020 2020 7265 7375 6c74  tx);..    result
-00032ee0: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
-00032ef0: 5f52 4f50 455f 4241 434b 3b0a 2020 2020  _ROPE_BACK;.    
-00032f00: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
-00032f10: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
-00032f20: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
-00032f30: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
-00032f40: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
-00032f50: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
-00032f60: 7372 6331 203d 2062 3b0a 0a20 2020 2072  src1 = b;..    r
-00032f70: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-00032f80: 0a2f 2f20 6767 6d6c 5f61 6c69 6269 0a0a  .// ggml_alibi..
-00032f90: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00032fa0: 6f72 202a 2067 676d 6c5f 616c 6962 6928  or * ggml_alibi(
-00032fb0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00032fc0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00032fd0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-00032fe0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
-00032ff0: 2a20 612c 0a20 2020 2020 2020 2069 6e74  * a,.        int
-00033000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033010: 2020 206e 5f70 6173 742c 0a20 2020 2020     n_past,.     
-00033020: 2020 2069 6e74 2020 2020 2020 2020 2020     int          
-00033030: 2020 2020 2020 2020 206e 5f68 6561 642c           n_head,
-00033040: 0a20 2020 2020 2020 2066 6c6f 6174 2020  .        float  
-00033050: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00033060: 6961 735f 6d61 7829 207b 0a20 2020 2047  ias_max) {.    G
-00033070: 474d 4c5f 4153 5345 5254 286e 5f70 6173  GML_ASSERT(n_pas
-00033080: 7420 3e3d 2030 293b 0a20 2020 2062 6f6f  t >= 0);.    boo
-00033090: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
-000330a0: 653b 0a0a 2020 2020 6966 2028 612d 3e67  e;..    if (a->g
-000330b0: 7261 6429 207b 0a20 2020 2020 2020 2047  rad) {.        G
-000330c0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-000330d0: 293b 202f 2f20 544f 444f 3a20 696d 706c  ); // TODO: impl
-000330e0: 656d 656e 7420 6261 636b 7761 7264 0a20  ement backward. 
-000330f0: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
-00033100: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
-00033110: 2020 2f2f 2054 4f44 4f3a 2077 6865 6e20    // TODO: when 
-00033120: 696d 706c 656d 656e 7420 6261 636b 7761  implement backwa
-00033130: 7264 2c20 6669 7820 7468 6973 3a0a 2020  rd, fix this:.  
-00033140: 2020 2f2f 7374 7275 6374 2067 676d 6c5f    //struct ggml_
-00033150: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
-00033160: 3d20 696e 706c 6163 6520 3f20 6767 6d6c  = inplace ? ggml
-00033170: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
-00033180: 2c20 6129 203a 2067 676d 6c5f 6475 705f  , a) : ggml_dup_
-00033190: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
-000331a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000331b0: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
-000331c0: 3d20 6767 6d6c 5f76 6965 775f 7465 6e73  = ggml_view_tens
-000331d0: 6f72 2863 7478 2c20 6129 3b0a 0a20 2020  or(ctx, a);..   
-000331e0: 2067 676d 6c5f 7363 7261 7463 685f 7361   ggml_scratch_sa
-000331f0: 7665 2863 7478 293b 0a0a 2020 2020 7374  ve(ctx);..    st
-00033200: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00033210: 202a 2062 203d 2067 676d 6c5f 6e65 775f   * b = ggml_new_
-00033220: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
-00033230: 474d 4c5f 5459 5045 5f49 3332 2c20 3329  GML_TYPE_I32, 3)
-00033240: 3b0a 0a20 2020 2028 2869 6e74 3332 5f74  ;..    ((int32_t
-00033250: 202a 2920 622d 3e64 6174 6129 5b30 5d20   *) b->data)[0] 
-00033260: 3d20 6e5f 7061 7374 3b0a 2020 2020 2828  = n_past;.    ((
-00033270: 696e 7433 325f 7420 2a29 2062 2d3e 6461  int32_t *) b->da
-00033280: 7461 295b 315d 203d 206e 5f68 6561 643b  ta)[1] = n_head;
-00033290: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000332a0: 2873 697a 656f 6628 666c 6f61 7429 203d  (sizeof(float) =
-000332b0: 3d20 7369 7a65 6f66 2869 6e74 3332 5f74  = sizeof(int32_t
-000332c0: 2929 3b0a 2020 2020 2828 2866 6c6f 6174  ));.    (((float
-000332d0: 202a 2920 622d 3e64 6174 6129 5b32 5d29   *) b->data)[2])
-000332e0: 203d 2062 6961 735f 6d61 783b 0a0a 2020   = bias_max;..  
-000332f0: 2020 6767 6d6c 5f73 6372 6174 6368 5f6c    ggml_scratch_l
-00033300: 6f61 6428 6374 7829 3b0a 0a20 2020 2072  oad(ctx);..    r
-00033310: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
-00033320: 4d4c 5f4f 505f 414c 4942 493b 0a20 2020  ML_OP_ALIBI;.   
-00033330: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
-00033340: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
-00033350: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
-00033360: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
-00033370: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
-00033380: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
-00033390: 3e73 7263 3120 3d20 623b 0a0a 2020 2020  >src1 = b;..    
-000333a0: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
-000333b0: 0a0a 2f2f 2067 676d 6c5f 636c 616d 700a  ..// ggml_clamp.
-000333c0: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-000333d0: 736f 7220 2a20 6767 6d6c 5f63 6c61 6d70  sor * ggml_clamp
-000333e0: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
-000333f0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00033400: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-00033410: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00033420: 202a 2061 2c0a 2020 2020 2020 2020 666c   * a,.        fl
-00033430: 6f61 7420 2020 2020 2020 2020 2020 2020  oat             
-00033440: 2020 2020 6d69 6e2c 0a20 2020 2020 2020      min,.       
-00033450: 2066 6c6f 6174 2020 2020 2020 2020 2020   float          
-00033460: 2020 2020 2020 206d 6178 2920 7b0a 2020         max) {.  
-00033470: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
-00033480: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
-00033490: 2861 2d3e 6772 6164 2920 7b0a 2020 2020  (a->grad) {.    
-000334a0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-000334b0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-000334c0: 2069 6d70 6c65 6d65 6e74 2062 6163 6b77   implement backw
-000334d0: 6172 640a 2020 2020 2020 2020 6973 5f6e  ard.        is_n
-000334e0: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-000334f0: 7d0a 0a20 2020 202f 2f20 544f 444f 3a20  }..    // TODO: 
-00033500: 7768 656e 2069 6d70 6c65 6d65 6e74 2062  when implement b
-00033510: 6163 6b77 6172 642c 2066 6978 2074 6869  ackward, fix thi
-00033520: 733a 0a20 2020 2073 7472 7563 7420 6767  s:.    struct gg
-00033530: 6d6c 5f74 656e 736f 7220 2a20 7265 7375  ml_tensor * resu
-00033540: 6c74 203d 2067 676d 6c5f 7669 6577 5f74  lt = ggml_view_t
-00033550: 656e 736f 7228 6374 782c 2061 293b 0a0a  ensor(ctx, a);..
-00033560: 2020 2020 6767 6d6c 5f73 6372 6174 6368      ggml_scratch
-00033570: 5f73 6176 6528 6374 7829 3b0a 0a20 2020  _save(ctx);..   
-00033580: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00033590: 736f 7220 2a20 6220 3d20 6767 6d6c 5f6e  sor * b = ggml_n
-000335a0: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
-000335b0: 2c20 4747 4d4c 5f54 5950 455f 4933 322c  , GGML_TYPE_I32,
-000335c0: 2033 293b 0a0a 2020 2020 2828 666c 6f61   3);..    ((floa
-000335d0: 7420 2a29 2062 2d3e 6461 7461 295b 305d  t *) b->data)[0]
-000335e0: 203d 206d 696e 3b0a 2020 2020 2828 666c   = min;.    ((fl
-000335f0: 6f61 7420 2a29 2062 2d3e 6461 7461 295b  oat *) b->data)[
-00033600: 315d 203d 206d 6178 3b0a 0a20 2020 2067  1] = max;..    g
-00033610: 676d 6c5f 7363 7261 7463 685f 6c6f 6164  gml_scratch_load
-00033620: 2863 7478 293b 0a0a 2020 2020 7265 7375  (ctx);..    resu
-00033630: 6c74 2d3e 6f70 2020 203d 2047 474d 4c5f  lt->op   = GGML_
-00033640: 4f50 5f43 4c41 4d50 3b0a 2020 2020 7265  OP_CLAMP;.    re
-00033650: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
-00033660: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
-00033670: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
-00033680: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
-00033690: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
-000336a0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-000336b0: 6331 203d 2062 3b0a 0a20 2020 2072 6574  c1 = b;..    ret
-000336c0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
-000336d0: 2f20 6767 6d6c 5f63 6f6e 765f 3164 5f31  / ggml_conv_1d_1
-000336e0: 730a 0a73 7472 7563 7420 6767 6d6c 5f74  s..struct ggml_t
-000336f0: 656e 736f 7220 2a20 6767 6d6c 5f63 6f6e  ensor * ggml_con
-00033700: 765f 3164 5f31 7328 0a20 2020 2020 2020  v_1d_1s(.       
-00033710: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-00033720: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-00033730: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00033740: 7465 6e73 6f72 2020 2a20 612c 0a20 2020  tensor  * a,.   
-00033750: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00033760: 5f74 656e 736f 7220 202a 2062 2920 7b0a  _tensor  * b) {.
-00033770: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00033780: 6767 6d6c 5f69 735f 6d61 7472 6978 2862  ggml_is_matrix(b
-00033790: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-000337a0: 4552 5428 612d 3e6e 655b 315d 203d 3d20  ERT(a->ne[1] == 
-000337b0: 622d 3e6e 655b 315d 293b 0a20 2020 2047  b->ne[1]);.    G
-000337c0: 474d 4c5f 4153 5345 5254 2861 2d3e 6e65  GML_ASSERT(a->ne
-000337d0: 5b33 5d20 3d3d 2031 293b 0a20 2020 2062  [3] == 1);.    b
-000337e0: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-000337f0: 6c73 653b 0a0a 2020 2020 6966 2028 612d  lse;..    if (a-
-00033800: 3e67 7261 6420 7c7c 2062 2d3e 6772 6164  >grad || b->grad
-00033810: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
-00033820: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
-00033830: 2f2f 2054 4f44 4f3a 2069 6d70 6c65 6d65  // TODO: impleme
-00033840: 6e74 2062 6163 6b77 6172 640a 2020 2020  nt backward.    
-00033850: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-00033860: 7565 3b0a 2020 2020 7d0a 0a20 2020 2063  ue;.    }..    c
-00033870: 6f6e 7374 2069 6e74 3634 5f74 206e 655b  onst int64_t ne[
-00033880: 345d 203d 207b 2062 2d3e 6e65 5b30 5d2c  4] = { b->ne[0],
-00033890: 2061 2d3e 6e65 5b32 5d2c 2031 2c20 312c   a->ne[2], 1, 1,
-000338a0: 207d 3b0a 2020 2020 7374 7275 6374 2067   };.    struct g
-000338b0: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
-000338c0: 756c 7420 3d20 6767 6d6c 5f6e 6577 5f74  ult = ggml_new_t
-000338d0: 656e 736f 7228 6374 782c 2047 474d 4c5f  ensor(ctx, GGML_
-000338e0: 5459 5045 5f46 3332 2c20 322c 206e 6529  TYPE_F32, 2, ne)
-000338f0: 3b0a 0a20 2020 2072 6573 756c 742d 3e6f  ;..    result->o
-00033900: 7020 2020 3d20 4747 4d4c 5f4f 505f 434f  p   = GGML_OP_CO
-00033910: 4e56 5f31 445f 3153 3b0a 2020 2020 7265  NV_1D_1S;.    re
-00033920: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
-00033930: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
-00033940: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
-00033950: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
-00033960: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
-00033970: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
-00033980: 6331 203d 2062 3b0a 0a20 2020 2072 6574  c1 = b;..    ret
-00033990: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
-000339a0: 2f20 6767 6d6c 5f63 6f6e 765f 3164 5f32  / ggml_conv_1d_2
-000339b0: 730a 0a73 7472 7563 7420 6767 6d6c 5f74  s..struct ggml_t
-000339c0: 656e 736f 7220 2a20 6767 6d6c 5f63 6f6e  ensor * ggml_con
-000339d0: 765f 3164 5f32 7328 0a20 2020 2020 2020  v_1d_2s(.       
-000339e0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-000339f0: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-00033a00: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00033a10: 7465 6e73 6f72 2020 2a20 612c 0a20 2020  tensor  * a,.   
-00033a20: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00033a30: 5f74 656e 736f 7220 202a 2062 2920 7b0a  _tensor  * b) {.
-00033a40: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00033a50: 6767 6d6c 5f69 735f 6d61 7472 6978 2862  ggml_is_matrix(b
-00033a60: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00033a70: 4552 5428 612d 3e6e 655b 315d 203d 3d20  ERT(a->ne[1] == 
-00033a80: 622d 3e6e 655b 315d 293b 0a20 2020 2047  b->ne[1]);.    G
-00033a90: 474d 4c5f 4153 5345 5254 2861 2d3e 6e65  GML_ASSERT(a->ne
-00033aa0: 5b33 5d20 3d3d 2031 293b 0a20 2020 2062  [3] == 1);.    b
-00033ab0: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
-00033ac0: 6c73 653b 0a0a 2020 2020 6966 2028 612d  lse;..    if (a-
-00033ad0: 3e67 7261 6420 7c7c 2062 2d3e 6772 6164  >grad || b->grad
-00033ae0: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
-00033af0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
-00033b00: 2f2f 2054 4f44 4f3a 2069 6d70 6c65 6d65  // TODO: impleme
-00033b10: 6e74 2062 6163 6b77 6172 640a 2020 2020  nt backward.    
-00033b20: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-00033b30: 7565 3b0a 2020 2020 7d0a 0a20 2020 2063  ue;.    }..    c
-00033b40: 6f6e 7374 2069 6e74 3634 5f74 206e 655b  onst int64_t ne[
-00033b50: 345d 203d 207b 2062 2d3e 6e65 5b30 5d2f  4] = { b->ne[0]/
-00033b60: 322c 2061 2d3e 6e65 5b32 5d2c 2031 2c20  2, a->ne[2], 1, 
-00033b70: 312c 207d 3b0a 2020 2020 7374 7275 6374  1, };.    struct
-00033b80: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
-00033b90: 6573 756c 7420 3d20 6767 6d6c 5f6e 6577  esult = ggml_new
-00033ba0: 5f74 656e 736f 7228 6374 782c 2047 474d  _tensor(ctx, GGM
-00033bb0: 4c5f 5459 5045 5f46 3332 2c20 322c 206e  L_TYPE_F32, 2, n
-00033bc0: 6529 3b0a 0a20 2020 2072 6573 756c 742d  e);..    result-
-00033bd0: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
-00033be0: 434f 4e56 5f31 445f 3253 3b0a 2020 2020  CONV_1D_2S;.    
-00033bf0: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
-00033c00: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
-00033c10: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
-00033c20: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
-00033c30: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
-00033c40: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
-00033c50: 7372 6331 203d 2062 3b0a 0a20 2020 2072  src1 = b;..    r
-00033c60: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-00033c70: 0a2f 2f20 6767 6d6c 5f66 6c61 7368 5f61  .// ggml_flash_a
-00033c80: 7474 6e0a 0a73 7472 7563 7420 6767 6d6c  ttn..struct ggml
-00033c90: 5f74 656e 736f 7220 2a20 6767 6d6c 5f66  _tensor * ggml_f
-00033ca0: 6c61 7368 5f61 7474 6e28 0a20 2020 2020  lash_attn(.     
-00033cb0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00033cc0: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-00033cd0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00033ce0: 6c5f 7465 6e73 6f72 2020 2a20 712c 0a20  l_tensor  * q,. 
-00033cf0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00033d00: 6d6c 5f74 656e 736f 7220 202a 206b 2c0a  ml_tensor  * k,.
-00033d10: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00033d20: 676d 6c5f 7465 6e73 6f72 2020 2a20 762c  gml_tensor  * v,
-00033d30: 0a20 2020 2020 2020 2062 6f6f 6c20 2020  .        bool   
-00033d40: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00033d50: 6173 6b65 6429 207b 0a20 2020 2047 474d  asked) {.    GGM
-00033d60: 4c5f 4153 5345 5254 2867 676d 6c5f 6361  L_ASSERT(ggml_ca
-00033d70: 6e5f 6d75 6c5f 6d61 7428 6b2c 2071 2929  n_mul_mat(k, q))
-00033d80: 3b0a 2020 2020 2f2f 2054 4f44 4f3a 2063  ;.    // TODO: c
-00033d90: 6865 636b 2069 6620 7654 2063 616e 2062  heck if vT can b
-00033da0: 6520 6d75 6c74 6970 6c69 6564 2062 7920  e multiplied by 
-00033db0: 286b 2a71 5429 0a0a 2020 2020 626f 6f6c  (k*qT)..    bool
-00033dc0: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
-00033dd0: 3b0a 0a20 2020 2069 6620 2871 2d3e 6772  ;..    if (q->gr
-00033de0: 6164 207c 7c20 6b2d 3e67 7261 6420 7c7c  ad || k->grad ||
-00033df0: 2076 2d3e 6772 6164 2920 7b0a 2020 2020   v->grad) {.    
-00033e00: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-00033e10: 7565 3b0a 2020 2020 7d0a 0a20 2020 202f  ue;.    }..    /
-00033e20: 2f73 7472 7563 7420 6767 6d6c 5f74 656e  /struct ggml_ten
-00033e30: 736f 7220 2a20 7265 7375 6c74 203d 2067  sor * result = g
-00033e40: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-00033e50: 7478 2c20 7129 3b0a 2020 2020 7374 7275  tx, q);.    stru
-00033e60: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00033e70: 2072 6573 756c 7420 3d20 6767 6d6c 5f6e   result = ggml_n
-00033e80: 6577 5f74 656e 736f 7228 6374 782c 2047  ew_tensor(ctx, G
-00033e90: 474d 4c5f 5459 5045 5f46 3332 2c20 342c  GML_TYPE_F32, 4,
-00033ea0: 2071 2d3e 6e65 293b 0a0a 2020 2020 7265   q->ne);..    re
-00033eb0: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-00033ec0: 4c5f 4f50 5f46 4c41 5348 5f41 5454 4e3b  L_OP_FLASH_ATTN;
-00033ed0: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
-00033ee0: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
-00033ef0: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
-00033f00: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
-00033f10: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
-00033f20: 7263 3020 3d20 713b 0a20 2020 2072 6573  rc0 = q;.    res
-00033f30: 756c 742d 3e73 7263 3120 3d20 6b3b 0a20  ult->src1 = k;. 
-00033f40: 2020 2072 6573 756c 742d 3e6f 7074 5b30     result->opt[0
-00033f50: 5d20 3d20 763b 0a20 2020 2072 6573 756c  ] = v;.    resul
-00033f60: 742d 3e6f 7074 5b31 5d20 3d20 6767 6d6c  t->opt[1] = ggml
-00033f70: 5f6e 6577 5f69 3332 2863 7478 2c20 6d61  _new_i32(ctx, ma
-00033f80: 736b 6564 203f 2031 203a 2030 293b 0a0a  sked ? 1 : 0);..
-00033f90: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-00033fa0: 743b 0a7d 0a0a 2f2f 2067 676d 6c5f 666c  t;.}..// ggml_fl
-00033fb0: 6173 685f 6666 0a0a 7374 7275 6374 2067  ash_ff..struct g
-00033fc0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-00033fd0: 6c5f 666c 6173 685f 6666 280a 2020 2020  l_flash_ff(.    
-00033fe0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00033ff0: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
-00034000: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00034010: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
-00034020: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00034030: 676d 6c5f 7465 6e73 6f72 2020 2a20 6230  gml_tensor  * b0
-00034040: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00034050: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
-00034060: 6231 2c0a 2020 2020 2020 2020 7374 7275  b1,.        stru
-00034070: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
-00034080: 2a20 6330 2c0a 2020 2020 2020 2020 7374  * c0,.        st
-00034090: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000340a0: 2020 2a20 6331 2920 7b0a 2020 2020 4747    * c1) {.    GG
-000340b0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f63  ML_ASSERT(ggml_c
-000340c0: 616e 5f6d 756c 5f6d 6174 2862 302c 2061  an_mul_mat(b0, a
-000340d0: 2929 3b0a 2020 2020 2f2f 2054 4f44 4f3a  ));.    // TODO:
-000340e0: 206d 6f72 6520 6368 6563 6b73 0a0a 2020   more checks..  
-000340f0: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
-00034100: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
-00034110: 2861 2d3e 6772 6164 207c 7c20 6230 2d3e  (a->grad || b0->
-00034120: 6772 6164 207c 7c20 6231 2d3e 6772 6164  grad || b1->grad
-00034130: 207c 7c20 6330 2d3e 6772 6164 207c 7c20   || c0->grad || 
-00034140: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
-00034150: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-00034160: 7565 3b0a 2020 2020 7d0a 0a20 2020 202f  ue;.    }..    /
-00034170: 2f73 7472 7563 7420 6767 6d6c 5f74 656e  /struct ggml_ten
-00034180: 736f 7220 2a20 7265 7375 6c74 203d 2067  sor * result = g
-00034190: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-000341a0: 7478 2c20 6129 3b0a 2020 2020 7374 7275  tx, a);.    stru
-000341b0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000341c0: 2072 6573 756c 7420 3d20 6767 6d6c 5f6e   result = ggml_n
-000341d0: 6577 5f74 656e 736f 7228 6374 782c 2047  ew_tensor(ctx, G
-000341e0: 474d 4c5f 5459 5045 5f46 3332 2c20 342c  GML_TYPE_F32, 4,
-000341f0: 2061 2d3e 6e65 293b 0a0a 2020 2020 7265   a->ne);..    re
-00034200: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
-00034210: 4c5f 4f50 5f46 4c41 5348 5f46 463b 0a20  L_OP_FLASH_FF;. 
-00034220: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
-00034230: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
-00034240: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
-00034250: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
-00034260: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
-00034270: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
-00034280: 742d 3e73 7263 3120 3d20 6230 3b0a 2020  t->src1 = b0;.  
-00034290: 2020 7265 7375 6c74 2d3e 6f70 745b 305d    result->opt[0]
-000342a0: 203d 2062 313b 0a20 2020 2072 6573 756c   = b1;.    resul
-000342b0: 742d 3e6f 7074 5b31 5d20 3d20 6330 3b0a  t->opt[1] = c0;.
-000342c0: 2020 2020 7265 7375 6c74 2d3e 6f70 745b      result->opt[
-000342d0: 325d 203d 2063 313b 0a0a 2020 2020 7265  2] = c1;..    re
-000342e0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-000342f0: 2f2f 2067 676d 6c5f 666c 6173 685f 6174  // ggml_flash_at
-00034300: 746e 5f62 6163 6b0a 0a73 7472 7563 7420  tn_back..struct 
-00034310: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
-00034320: 6d6c 5f66 6c61 7368 5f61 7474 6e5f 6261  ml_flash_attn_ba
-00034330: 636b 280a 2020 2020 2020 2020 7374 7275  ck(.        stru
-00034340: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00034350: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-00034360: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00034370: 7220 202a 2071 2c0a 2020 2020 2020 2020  r  * q,.        
-00034380: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00034390: 6f72 2020 2a20 6b2c 0a20 2020 2020 2020  or  * k,.       
-000343a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000343b0: 736f 7220 202a 2076 2c0a 2020 2020 2020  sor  * v,.      
-000343c0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000343d0: 6e73 6f72 2020 2a20 642c 0a20 2020 2020  nsor  * d,.     
-000343e0: 2020 2062 6f6f 6c20 2020 2020 2020 2020     bool         
-000343f0: 2020 2020 2020 2020 206d 6173 6b65 6429           masked)
-00034400: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-00034410: 5254 2867 676d 6c5f 6361 6e5f 6d75 6c5f  RT(ggml_can_mul_
-00034420: 6d61 7428 6b2c 2071 2929 3b0a 2020 2020  mat(k, q));.    
-00034430: 2f2f 2054 4f44 4f3a 2063 6865 636b 2069  // TODO: check i
-00034440: 6620 7654 2063 616e 2062 6520 6d75 6c74  f vT can be mult
-00034450: 6970 6c69 6564 2062 7920 286b 2a71 5429  iplied by (k*qT)
-00034460: 0a0a 2020 2020 2f2f 2064 2073 6861 7065  ..    // d shape
-00034470: 205b 442c 4e2c 6e65 322c 6e65 335d 0a20   [D,N,ne2,ne3]. 
-00034480: 2020 202f 2f20 7120 7368 6170 6520 5b44     // q shape [D
-00034490: 2c4e 2c6e 6532 2c6e 6533 5d0a 2020 2020  ,N,ne2,ne3].    
-000344a0: 2f2f 206b 2073 6861 7065 205b 442c 4d2c  // k shape [D,M,
-000344b0: 6e65 322c 6e65 335d 0a20 2020 202f 2f20  ne2,ne3].    // 
-000344c0: 7620 7368 6170 6520 5b4d 2c44 2c6e 6532  v shape [M,D,ne2
-000344d0: 2c6e 6533 5d0a 0a20 2020 2063 6f6e 7374  ,ne3]..    const
-000344e0: 2069 6e74 3634 5f74 2020 2044 203d 2071   int64_t   D = q
-000344f0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
-00034500: 7374 2069 6e74 3634 5f74 2020 204e 203d  st int64_t   N =
-00034510: 2071 2d3e 6e65 5b31 5d3b 0a20 2020 2063   q->ne[1];.    c
-00034520: 6f6e 7374 2069 6e74 3634 5f74 2020 204d  onst int64_t   M
-00034530: 203d 206b 2d3e 6e65 5b31 5d3b 0a20 2020   = k->ne[1];.   
-00034540: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00034550: 6532 203d 2071 2d3e 6e65 5b32 5d3b 0a20  e2 = q->ne[2];. 
-00034560: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00034570: 206e 6533 203d 2071 2d3e 6e65 5b33 5d3b   ne3 = q->ne[3];
-00034580: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00034590: 5428 6b2d 3e6e 655b 305d 203d 3d20 4429  T(k->ne[0] == D)
-000345a0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-000345b0: 5428 762d 3e6e 655b 305d 203d 3d20 4d29  T(v->ne[0] == M)
-000345c0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-000345d0: 5428 762d 3e6e 655b 315d 203d 3d20 4429  T(v->ne[1] == D)
-000345e0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-000345f0: 5428 642d 3e6e 655b 305d 203d 3d20 4429  T(d->ne[0] == D)
-00034600: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00034610: 5428 642d 3e6e 655b 315d 203d 3d20 4e29  T(d->ne[1] == N)
-00034620: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00034630: 5428 6b2d 3e6e 655b 325d 203d 3d20 6e65  T(k->ne[2] == ne
-00034640: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
-00034650: 4552 5428 6b2d 3e6e 655b 335d 203d 3d20  ERT(k->ne[3] == 
-00034660: 6e65 3329 3b0a 2020 2020 4747 4d4c 5f41  ne3);.    GGML_A
-00034670: 5353 4552 5428 762d 3e6e 655b 325d 203d  SSERT(v->ne[2] =
-00034680: 3d20 6e65 3229 3b0a 2020 2020 4747 4d4c  = ne2);.    GGML
-00034690: 5f41 5353 4552 5428 762d 3e6e 655b 335d  _ASSERT(v->ne[3]
-000346a0: 203d 3d20 6e65 3329 3b0a 2020 2020 4747   == ne3);.    GG
-000346b0: 4d4c 5f41 5353 4552 5428 642d 3e6e 655b  ML_ASSERT(d->ne[
-000346c0: 325d 203d 3d20 6e65 3229 3b0a 2020 2020  2] == ne2);.    
-000346d0: 4747 4d4c 5f41 5353 4552 5428 642d 3e6e  GGML_ASSERT(d->n
-000346e0: 655b 335d 203d 3d20 6e65 3329 3b0a 0a20  e[3] == ne3);.. 
-000346f0: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
-00034700: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
-00034710: 2028 712d 3e67 7261 6420 7c7c 206b 2d3e   (q->grad || k->
-00034720: 6772 6164 207c 7c20 762d 3e67 7261 6429  grad || v->grad)
-00034730: 207b 0a20 2020 2020 2020 202f 2f20 7768   {.        // wh
-00034740: 656e 2075 7369 6e67 2074 6869 7320 6f70  en using this op
-00034750: 6572 6174 696f 6e20 2869 6e20 6261 636b  eration (in back
-00034760: 7761 7264 7320 7061 7373 2920 7468 6573  wards pass) thes
-00034770: 6520 6772 6164 7320 6172 6520 7365 742e  e grads are set.
-00034780: 0a20 2020 2020 2020 202f 2f20 7765 2064  .        // we d
-00034790: 6f6e 2774 2077 616e 7420 746f 2063 7265  on't want to cre
-000347a0: 6174 6520 2862 6967 2920 6772 6164 206f  ate (big) grad o
-000347b0: 6620 6f75 7220 7265 7375 6c74 2c20 736f  f our result, so
-000347c0: 2069 735f 6e6f 6465 2069 7320 6661 6c73   is_node is fals
-000347d0: 652e 0a20 2020 2020 2020 2069 735f 6e6f  e..        is_no
-000347e0: 6465 203d 2066 616c 7365 3b0a 2020 2020  de = false;.    
-000347f0: 7d0a 0a20 2020 202f 2f20 7374 6f72 6520  }..    // store 
-00034800: 6772 6164 6965 6e74 7320 6f66 2071 2c20  gradients of q, 
-00034810: 6b20 616e 6420 7620 6173 2063 6f6e 7469  k and v as conti
-00034820: 6e75 6f75 7320 7465 6e73 6f72 7320 636f  nuous tensors co
-00034830: 6e63 6174 656e 6174 6564 2069 6e20 7265  ncatenated in re
-00034840: 7375 6c74 2e0a 2020 2020 2f2f 2071 2073  sult..    // q s
-00034850: 6861 7065 5b44 2c4e 2c6e 6532 2c6e 6533  hape[D,N,ne2,ne3
-00034860: 5d20 3b20 6b20 7368 6170 6520 5b44 2c4d  ] ; k shape [D,M
-00034870: 2c6e 6532 2c6e 6533 5d20 3b20 7620 7368  ,ne2,ne3] ; v sh
-00034880: 6170 6520 5b4d 2c44 2c6e 6532 2c6e 6533  ape [M,D,ne2,ne3
-00034890: 5d0a 2020 2020 2f2f 2067 7261 6471 2d3e  ].    // gradq->
-000348a0: 6461 7461 203d 2072 6573 756c 742d 3e64  data = result->d
-000348b0: 6174 610a 2020 2020 2f2f 2067 7261 646b  ata.    // gradk
-000348c0: 2d3e 6461 7461 203d 2072 6573 756c 742d  ->data = result-
-000348d0: 3e64 6174 6120 2b20 6e62 302a 442a 4e2a  >data + nb0*D*N*
-000348e0: 6e65 322a 6e65 330a 2020 2020 2f2f 2067  ne2*ne3.    // g
-000348f0: 7261 6476 2d3e 6461 7461 203d 2072 6573  radv->data = res
-00034900: 756c 742d 3e64 6174 6120 2b20 6e62 302a  ult->data + nb0*
-00034910: 442a 4e2a 6e65 322a 6e65 3320 2b20 6e62  D*N*ne2*ne3 + nb
-00034920: 302a 442a 4d2a 6e65 322a 6e65 330a 2020  0*D*M*ne2*ne3.  
-00034930: 2020 2f2f 206e 6f74 653a 2076 2061 6e64    // note: v and
-00034940: 2067 7261 6476 2061 7265 2061 6374 7561   gradv are actua
-00034950: 6c6c 7920 7472 616e 7370 6f73 6564 2c20  lly transposed, 
-00034960: 692e 652e 2076 2d3e 6e65 5b30 5d20 213d  i.e. v->ne[0] !=
-00034970: 2044 2e0a 2020 2020 696e 7436 345f 7420   D..    int64_t 
-00034980: 6e65 5b34 5d20 3d20 7b44 2c4d 2b4e 2b4d  ne[4] = {D,M+N+M
-00034990: 2c6e 6532 2c6e 6533 7d3b 0a0a 2020 2020  ,ne2,ne3};..    
-000349a0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000349b0: 6f72 202a 2072 6573 756c 7420 3d20 6767  or * result = gg
-000349c0: 6d6c 5f6e 6577 5f74 656e 736f 7228 6374  ml_new_tensor(ct
-000349d0: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
-000349e0: 2c20 342c 206e 6529 3b0a 0a20 2020 2072  , 4, ne);..    r
-000349f0: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
-00034a00: 4d4c 5f4f 505f 464c 4153 485f 4154 544e  ML_OP_FLASH_ATTN
-00034a10: 5f42 4143 4b3b 0a20 2020 2072 6573 756c  _BACK;.    resul
-00034a20: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
-00034a30: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
-00034a40: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
-00034a50: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
-00034a60: 756c 742d 3e73 7263 3020 3d20 713b 0a20  ult->src0 = q;. 
-00034a70: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
-00034a80: 3d20 6b3b 0a20 2020 2072 6573 756c 742d  = k;.    result-
-00034a90: 3e6f 7074 5b30 5d20 3d20 763b 0a20 2020  >opt[0] = v;.   
-00034aa0: 2072 6573 756c 742d 3e6f 7074 5b31 5d20   result->opt[1] 
-00034ab0: 3d20 643b 0a20 2020 2072 6573 756c 742d  = d;.    result-
-00034ac0: 3e6f 7074 5b32 5d20 3d20 6767 6d6c 5f6e  >opt[2] = ggml_n
-00034ad0: 6577 5f69 3332 2863 7478 2c20 6d61 736b  ew_i32(ctx, mask
-00034ae0: 6564 203f 2031 203a 2030 293b 0a0a 2020  ed ? 1 : 0);..  
-00034af0: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
-00034b00: 0a7d 0a0a 0a2f 2f20 6767 6d6c 5f6d 6170  .}...// ggml_map
-00034b10: 5f75 6e61 7279 0a0a 7374 7275 6374 2067  _unary..struct g
-00034b20: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-00034b30: 6c5f 6d61 705f 756e 6172 795f 696d 706c  l_map_unary_impl
-00034b40: 5f66 3332 280a 2020 2020 2020 2020 7374  _f32(.        st
-00034b50: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-00034b60: 7420 2020 2020 2020 202a 2063 7478 2c0a  t        * ctx,.
-00034b70: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00034b80: 676d 6c5f 7465 6e73 6f72 2020 2020 2020  gml_tensor      
-00034b90: 2020 202a 2061 2c0a 2020 2020 2020 2020     * a,.        
-00034ba0: 636f 6e73 7420 2067 676d 6c5f 756e 6172  const  ggml_unar
-00034bb0: 795f 6f70 5f66 3332 5f74 2066 756e 2c0a  y_op_f32_t fun,.
-00034bc0: 2020 2020 2020 2020 626f 6f6c 2020 2069          bool   i
-00034bd0: 6e70 6c61 6365 2920 7b0a 2020 2020 626f  nplace) {.    bo
-00034be0: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
-00034bf0: 7365 3b0a 0a20 2020 2069 6620 2821 696e  se;..    if (!in
-00034c00: 706c 6163 6520 2626 2061 2d3e 6772 6164  place && a->grad
-00034c10: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
-00034c20: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
-00034c30: 7d0a 0a20 2020 2073 7472 7563 7420 6767  }..    struct gg
-00034c40: 6d6c 5f74 656e 736f 7220 2a20 6164 6472  ml_tensor * addr
-00034c50: 5f74 656e 736f 7220 3d20 6767 6d6c 5f6e  _tensor = ggml_n
-00034c60: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
-00034c70: 2c20 4747 4d4c 5f54 5950 455f 4933 322c  , GGML_TYPE_I32,
-00034c80: 2073 697a 656f 6628 766f 6964 202a 2920   sizeof(void *) 
-00034c90: 2f20 7369 7a65 6f66 2869 6e74 3332 5f74  / sizeof(int32_t
-00034ca0: 2929 3b0a 2020 2020 2a28 2876 6f69 6420  ));.    *((void 
-00034cb0: 282a 2a29 2876 6f69 6429 2961 6464 725f  (**)(void))addr_
-00034cc0: 7465 6e73 6f72 2d3e 6461 7461 2920 3d20  tensor->data) = 
-00034cd0: 2876 6f69 6420 282a 2928 766f 6964 2929  (void (*)(void))
-00034ce0: 6675 6e3b 0a20 2020 2073 7472 7563 7420  fun;.    struct 
-00034cf0: 6767 6d6c 5f74 656e 736f 7220 2a72 6573  ggml_tensor *res
-00034d00: 756c 7420 3d20 696e 706c 6163 6520 3f20  ult = inplace ? 
-00034d10: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
-00034d20: 2863 7478 2c20 6129 203a 2067 676d 6c5f  (ctx, a) : ggml_
-00034d30: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-00034d40: 6129 3b0a 0a20 2020 2072 6573 756c 742d  a);..    result-
-00034d50: 3e6f 7020 3d20 4747 4d4c 5f4f 505f 4d41  >op = GGML_OP_MA
-00034d60: 505f 554e 4152 593b 0a20 2020 2072 6573  P_UNARY;.    res
-00034d70: 756c 742d 3e67 7261 6420 3d20 6973 5f6e  ult->grad = is_n
-00034d80: 6f64 6520 3f20 6767 6d6c 5f64 7570 5f74  ode ? ggml_dup_t
-00034d90: 656e 736f 7228 6374 782c 2072 6573 756c  ensor(ctx, resul
-00034da0: 7429 203a 204e 554c 4c3b 0a20 2020 2072  t) : NULL;.    r
-00034db0: 6573 756c 742d 3e73 7263 3020 3d20 613b  esult->src0 = a;
-00034dc0: 0a20 2020 2072 6573 756c 742d 3e6f 7074  .    result->opt
-00034dd0: 5b30 5d20 3d20 6164 6472 5f74 656e 736f  [0] = addr_tenso
-00034de0: 723b 0a0a 2020 2020 7265 7475 726e 2072  r;..    return r
-00034df0: 6573 756c 743b 0a7d 0a0a 7374 7275 6374  esult;.}..struct
-00034e00: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-00034e10: 676d 6c5f 6d61 705f 756e 6172 795f 6633  gml_map_unary_f3
-00034e20: 3228 0a20 2020 2020 2020 2073 7472 7563  2(.        struc
-00034e30: 7420 6767 6d6c 5f63 6f6e 7465 7874 2020  t ggml_context  
-00034e40: 2020 2020 2020 2a20 6374 782c 0a20 2020        * ctx,.   
-00034e50: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00034e60: 5f74 656e 736f 7220 2020 2020 2020 2020  _tensor         
-00034e70: 2a20 612c 0a20 2020 2020 2020 2063 6f6e  * a,.        con
-00034e80: 7374 2020 6767 6d6c 5f75 6e61 7279 5f6f  st  ggml_unary_o
-00034e90: 705f 6633 325f 7420 6675 6e29 207b 0a20  p_f32_t fun) {. 
-00034ea0: 2020 2072 6574 7572 6e20 6767 6d6c 5f6d     return ggml_m
-00034eb0: 6170 5f75 6e61 7279 5f69 6d70 6c5f 6633  ap_unary_impl_f3
-00034ec0: 3228 6374 782c 2061 2c20 6675 6e2c 2066  2(ctx, a, fun, f
-00034ed0: 616c 7365 293b 0a7d 0a0a 7374 7275 6374  alse);.}..struct
-00034ee0: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-00034ef0: 676d 6c5f 6d61 705f 756e 6172 795f 696e  gml_map_unary_in
-00034f00: 706c 6163 655f 6633 3228 0a20 2020 2020  place_f32(.     
-00034f10: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00034f20: 6f6e 7465 7874 2020 2020 2020 2020 2a20  ontext        * 
-00034f30: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
-00034f40: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00034f50: 2020 2020 2020 2020 2a20 612c 0a20 2020          * a,.   
-00034f60: 2020 2020 2063 6f6e 7374 2020 6767 6d6c       const  ggml
-00034f70: 5f75 6e61 7279 5f6f 705f 6633 325f 7420  _unary_op_f32_t 
-00034f80: 6675 6e29 207b 0a20 2020 2072 6574 7572  fun) {.    retur
-00034f90: 6e20 6767 6d6c 5f6d 6170 5f75 6e61 7279  n ggml_map_unary
-00034fa0: 5f69 6d70 6c5f 6633 3228 6374 782c 2061  _impl_f32(ctx, a
-00034fb0: 2c20 6675 6e2c 2074 7275 6529 3b0a 7d0a  , fun, true);.}.
-00034fc0: 0a2f 2f20 6767 6d6c 5f6d 6170 5f62 696e  .// ggml_map_bin
-00034fd0: 6172 790a 0a73 7472 7563 7420 6767 6d6c  ary..struct ggml
-00034fe0: 5f74 656e 736f 7220 2a20 6767 6d6c 5f6d  _tensor * ggml_m
-00034ff0: 6170 5f62 696e 6172 795f 696d 706c 5f66  ap_binary_impl_f
-00035000: 3332 280a 2020 2020 2020 2020 7374 7275  32(.        stru
-00035010: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-00035020: 2020 2020 2020 2020 2a20 6374 782c 0a20          * ctx,. 
-00035030: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00035040: 6d6c 5f74 656e 736f 7220 2020 2020 2020  ml_tensor       
-00035050: 2020 202a 2061 2c0a 2020 2020 2020 2020     * a,.        
-00035060: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00035070: 6f72 2020 2020 2020 2020 2020 2a20 622c  or          * b,
-00035080: 0a20 2020 2020 2020 2063 6f6e 7374 2020  .        const  
-00035090: 6767 6d6c 5f62 696e 6172 795f 6f70 5f66  ggml_binary_op_f
-000350a0: 3332 5f74 2066 756e 2c0a 2020 2020 2020  32_t fun,.      
-000350b0: 2020 626f 6f6c 2020 2069 6e70 6c61 6365    bool   inplace
-000350c0: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
-000350d0: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
-000350e0: 655f 7368 6170 6528 612c 2062 2929 3b0a  e_shape(a, b));.
-000350f0: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
-00035100: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
-00035110: 6966 2028 2169 6e70 6c61 6365 2026 2620  if (!inplace && 
-00035120: 2861 2d3e 6772 6164 207c 7c20 622d 3e67  (a->grad || b->g
-00035130: 7261 6429 2920 7b0a 2020 2020 2020 2020  rad)) {.        
-00035140: 6973 5f6e 6f64 6520 3d20 7472 7565 3b0a  is_node = true;.
-00035150: 2020 2020 7d0a 0a20 2020 2073 7472 7563      }..    struc
-00035160: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00035170: 6164 6472 5f74 656e 736f 7220 3d20 6767  addr_tensor = gg
-00035180: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
-00035190: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
-000351a0: 4933 322c 2073 697a 656f 6628 766f 6964  I32, sizeof(void
-000351b0: 202a 2920 2f20 7369 7a65 6f66 2869 6e74   *) / sizeof(int
-000351c0: 3332 5f74 2929 3b0a 2020 2020 2a28 2876  32_t));.    *((v
-000351d0: 6f69 6420 282a 2a29 2876 6f69 6429 2961  oid (**)(void))a
-000351e0: 6464 725f 7465 6e73 6f72 2d3e 6461 7461  ddr_tensor->data
-000351f0: 2920 3d20 2876 6f69 6420 282a 2928 766f  ) = (void (*)(vo
-00035200: 6964 2929 6675 6e3b 0a20 2020 2073 7472  id))fun;.    str
-00035210: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00035220: 2a72 6573 756c 7420 3d20 696e 706c 6163  *result = inplac
-00035230: 6520 3f20 6767 6d6c 5f76 6965 775f 7465  e ? ggml_view_te
-00035240: 6e73 6f72 2863 7478 2c20 6129 203a 2067  nsor(ctx, a) : g
-00035250: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-00035260: 7478 2c20 6129 3b0a 0a20 2020 2072 6573  tx, a);..    res
-00035270: 756c 742d 3e6f 7020 3d20 4747 4d4c 5f4f  ult->op = GGML_O
-00035280: 505f 4d41 505f 4249 4e41 5259 3b0a 2020  P_MAP_BINARY;.  
-00035290: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
-000352a0: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
-000352b0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
-000352c0: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
-000352d0: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
-000352e0: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
-000352f0: 2d3e 7372 6331 203d 2062 3b0a 2020 2020  ->src1 = b;.    
-00035300: 7265 7375 6c74 2d3e 6f70 745b 305d 203d  result->opt[0] =
-00035310: 2061 6464 725f 7465 6e73 6f72 3b0a 0a20   addr_tensor;.. 
-00035320: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00035330: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
-00035340: 5f74 656e 736f 7220 2a20 6767 6d6c 5f6d  _tensor * ggml_m
-00035350: 6170 5f62 696e 6172 795f 6633 3228 0a20  ap_binary_f32(. 
-00035360: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00035370: 6d6c 5f63 6f6e 7465 7874 2020 2020 2020  ml_context      
-00035380: 2020 202a 2063 7478 2c0a 2020 2020 2020     * ctx,.      
-00035390: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000353a0: 6e73 6f72 2020 2020 2020 2020 2020 2a20  nsor          * 
-000353b0: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
-000353c0: 7420 6767 6d6c 5f74 656e 736f 7220 2020  t ggml_tensor   
-000353d0: 2020 2020 2020 202a 2062 2c0a 2020 2020         * b,.    
-000353e0: 2020 2020 636f 6e73 7420 2067 676d 6c5f      const  ggml_
-000353f0: 6269 6e61 7279 5f6f 705f 6633 325f 7420  binary_op_f32_t 
-00035400: 6675 6e29 207b 0a20 2020 2072 6574 7572  fun) {.    retur
-00035410: 6e20 6767 6d6c 5f6d 6170 5f62 696e 6172  n ggml_map_binar
-00035420: 795f 696d 706c 5f66 3332 2863 7478 2c20  y_impl_f32(ctx, 
-00035430: 612c 2062 2c20 6675 6e2c 2066 616c 7365  a, b, fun, false
-00035440: 293b 0a7d 0a0a 7374 7275 6374 2067 676d  );.}..struct ggm
-00035450: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
-00035460: 6d61 705f 6269 6e61 7279 5f69 6e70 6c61  map_binary_inpla
-00035470: 6365 5f66 3332 280a 2020 2020 2020 2020  ce_f32(.        
-00035480: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-00035490: 6578 7420 2020 2020 2020 2020 2a20 6374  ext         * ct
-000354a0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-000354b0: 7420 6767 6d6c 5f74 656e 736f 7220 2020  t ggml_tensor   
-000354c0: 2020 2020 2020 202a 2061 2c0a 2020 2020         * a,.    
-000354d0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000354e0: 7465 6e73 6f72 2020 2020 2020 2020 2020  tensor          
-000354f0: 2a20 622c 0a20 2020 2020 2020 2063 6f6e  * b,.        con
-00035500: 7374 2020 6767 6d6c 5f62 696e 6172 795f  st  ggml_binary_
-00035510: 6f70 5f66 3332 5f74 2066 756e 2920 7b0a  op_f32_t fun) {.
-00035520: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
-00035530: 6d61 705f 6269 6e61 7279 5f69 6d70 6c5f  map_binary_impl_
-00035540: 6633 3228 6374 782c 2061 2c20 622c 2066  f32(ctx, a, b, f
-00035550: 756e 2c20 7472 7565 293b 0a7d 0a0a 2f2f  un, true);.}..//
-00035560: 2067 676d 6c5f 6372 6f73 735f 656e 7472   ggml_cross_entr
-00035570: 6f70 795f 6c6f 7373 0a0a 7374 7275 6374  opy_loss..struct
-00035580: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
-00035590: 676d 6c5f 6372 6f73 735f 656e 7472 6f70  gml_cross_entrop
-000355a0: 795f 6c6f 7373 280a 2020 2020 2020 2020  y_loss(.        
-000355b0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-000355c0: 6578 7420 2020 2020 2020 2020 2a20 6374  ext         * ct
-000355d0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-000355e0: 7420 6767 6d6c 5f74 656e 736f 7220 2020  t ggml_tensor   
-000355f0: 2020 2020 2020 202a 2061 2c0a 2020 2020         * a,.    
-00035600: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00035610: 7465 6e73 6f72 2020 2020 2020 2020 2020  tensor          
-00035620: 2a20 6229 207b 0a20 2020 2047 474d 4c5f  * b) {.    GGML_
-00035630: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
-00035640: 7361 6d65 5f73 6861 7065 2861 2c20 6229  same_shape(a, b)
-00035650: 293b 0a20 2020 2062 6f6f 6c20 6973 5f6e  );.    bool is_n
-00035660: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
-00035670: 2020 6966 2028 612d 3e67 7261 6420 7c7c    if (a->grad ||
-00035680: 2062 2d3e 6772 6164 2920 7b0a 2020 2020   b->grad) {.    
-00035690: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
-000356a0: 7565 3b0a 2020 2020 7d0a 0a20 2020 2073  ue;.    }..    s
-000356b0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000356c0: 7220 2a20 7265 7375 6c74 203d 2067 676d  r * result = ggm
-000356d0: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
-000356e0: 6374 782c 2061 2d3e 7479 7065 2c20 3129  ctx, a->type, 1)
-000356f0: 3b0a 0a20 2020 2072 6573 756c 742d 3e6f  ;..    result->o
-00035700: 7020 2020 3d20 4747 4d4c 5f4f 505f 4352  p   = GGML_OP_CR
-00035710: 4f53 535f 454e 5452 4f50 595f 4c4f 5353  OSS_ENTROPY_LOSS
-00035720: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
-00035730: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
-00035740: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
-00035750: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
-00035760: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
-00035770: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
-00035780: 7375 6c74 2d3e 7372 6331 203d 2062 3b0a  sult->src1 = b;.
-00035790: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-000357a0: 6c74 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f63  lt;.}..// ggml_c
-000357b0: 726f 7373 5f65 6e74 726f 7079 5f6c 6f73  ross_entropy_los
-000357c0: 735f 6261 636b 0a0a 7374 7275 6374 2067  s_back..struct g
-000357d0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
-000357e0: 6c5f 6372 6f73 735f 656e 7472 6f70 795f  l_cross_entropy_
-000357f0: 6c6f 7373 5f62 6163 6b28 0a20 2020 2020  loss_back(.     
-00035800: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00035810: 6f6e 7465 7874 2020 2020 2020 2020 202a  ontext         *
-00035820: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
-00035830: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00035840: 2020 2020 2020 2020 2020 2a20 612c 0a20            * a,. 
-00035850: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00035860: 6d6c 5f74 656e 736f 7220 2020 2020 2020  ml_tensor       
-00035870: 2020 202a 2062 2c0a 2020 2020 2020 2020     * b,.        
-00035880: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00035890: 6f72 2020 2020 2020 2020 2020 2a20 6329  or          * c)
-000358a0: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-000358b0: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-000358c0: 5f73 6861 7065 2861 2c20 6229 293b 0a20  _shape(a, b));. 
-000358d0: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-000358e0: 676d 6c5f 6973 5f73 6361 6c61 7228 6329  gml_is_scalar(c)
-000358f0: 293b 0a0a 2020 2020 7374 7275 6374 2067  );..    struct g
-00035900: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
-00035910: 756c 7420 3d20 6767 6d6c 5f64 7570 5f74  ult = ggml_dup_t
-00035920: 656e 736f 7228 6374 782c 2061 293b 0a0a  ensor(ctx, a);..
-00035930: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
-00035940: 203d 2047 474d 4c5f 4f50 5f43 524f 5353   = GGML_OP_CROSS
-00035950: 5f45 4e54 524f 5059 5f4c 4f53 535f 4241  _ENTROPY_LOSS_BA
-00035960: 434b 3b0a 2020 2020 7265 7375 6c74 2d3e  CK;.    result->
-00035970: 6772 6164 203d 204e 554c 4c3b 0a20 2020  grad = NULL;.   
-00035980: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
-00035990: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
-000359a0: 7263 3120 3d20 623b 0a20 2020 2072 6573  rc1 = b;.    res
-000359b0: 756c 742d 3e6f 7074 5b30 5d20 3d20 633b  ult->opt[0] = c;
-000359c0: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
-000359d0: 756c 743b 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f  ult;.}..////////
-000359e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000359f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00035a00: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00035a10: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00035a20: 2f2f 2f2f 2f2f 2f2f 0a0a 766f 6964 2067  ////////..void g
-00035a30: 676d 6c5f 7365 745f 7061 7261 6d28 0a20  gml_set_param(. 
-00035a40: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00035a50: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00035a60: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00035a70: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
-00035a80: 656e 736f 7229 207b 0a20 2020 2074 656e  ensor) {.    ten
-00035a90: 736f 722d 3e69 735f 7061 7261 6d20 3d20  sor->is_param = 
-00035aa0: 7472 7565 3b0a 0a20 2020 2047 474d 4c5f  true;..    GGML_
-00035ab0: 4153 5345 5254 2874 656e 736f 722d 3e67  ASSERT(tensor->g
-00035ac0: 7261 6420 3d3d 204e 554c 4c29 3b0a 2020  rad == NULL);.  
-00035ad0: 2020 7465 6e73 6f72 2d3e 6772 6164 203d    tensor->grad =
-00035ae0: 2067 676d 6c5f 6475 705f 7465 6e73 6f72   ggml_dup_tensor
-00035af0: 2863 7478 2c20 7465 6e73 6f72 293b 0a7d  (ctx, tensor);.}
-00035b00: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-00035b10: 655f 666f 7277 6172 645f 6475 700a 0a73  e_forward_dup..s
-00035b20: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00035b30: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00035b40: 6475 705f 7361 6d65 5f63 6f6e 7428 0a20  dup_same_cont(. 
-00035b50: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00035b60: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00035b70: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-00035b80: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00035b90: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00035ba0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-00035bb0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00035bc0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-00035bd0: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-00035be0: 676d 6c5f 6e65 6c65 6d65 6e74 7328 6473  gml_nelements(ds
-00035bf0: 7429 203d 3d20 6767 6d6c 5f6e 656c 656d  t) == ggml_nelem
-00035c00: 656e 7473 2873 7263 3029 293b 0a20 2020  ents(src0));.   
-00035c10: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-00035c20: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
-00035c30: 6473 7429 2026 2620 6767 6d6c 5f69 735f  dst) && ggml_is_
-00035c40: 636f 6e74 6967 756f 7573 2873 7263 3029  contiguous(src0)
-00035c50: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00035c60: 5254 2873 7263 302d 3e74 7970 6520 3d3d  RT(src0->type ==
-00035c70: 2064 7374 2d3e 7479 7065 293b 0a0a 2020   dst->type);..  
-00035c80: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-00035c90: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00035ca0: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
-00035cb0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00035cc0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-00035cd0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00035ce0: 2020 7d0a 0a20 2020 2063 6f6e 7374 2073    }..    const s
-00035cf0: 697a 655f 7420 6e62 3030 203d 2073 7263  ize_t nb00 = src
-00035d00: 302d 3e6e 625b 305d 3b0a 2020 2020 636f  0->nb[0];.    co
-00035d10: 6e73 7420 7369 7a65 5f74 206e 6230 203d  nst size_t nb0 =
-00035d20: 2064 7374 2d3e 6e62 5b30 5d3b 0a0a 2020   dst->nb[0];..  
-00035d30: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
-00035d40: 3d20 7061 7261 6d73 2d3e 6974 683b 202f  = params->ith; /
-00035d50: 2f20 7468 7265 6164 2069 6e64 6578 0a20  / thread index. 
-00035d60: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
-00035d70: 203d 2070 6172 616d 732d 3e6e 7468 3b20   = params->nth; 
-00035d80: 2f2f 206e 756d 6265 7220 6f66 2074 6872  // number of thr
-00035d90: 6561 6473 0a0a 2020 2020 2f2f 2070 6172  eads..    // par
-00035da0: 616c 6c65 6c69 7a65 2062 7920 656c 656d  allelize by elem
-00035db0: 656e 7473 0a20 2020 2063 6f6e 7374 2069  ents.    const i
-00035dc0: 6e74 206e 6520 3d20 6767 6d6c 5f6e 656c  nt ne = ggml_nel
-00035dd0: 656d 656e 7473 2864 7374 293b 0a20 2020  ements(dst);.   
-00035de0: 2063 6f6e 7374 2069 6e74 2064 7220 3d20   const int dr = 
-00035df0: 286e 6520 2b20 6e74 6820 2d20 3129 202f  (ne + nth - 1) /
-00035e00: 206e 7468 3b0a 2020 2020 636f 6e73 7420   nth;.    const 
-00035e10: 696e 7420 6965 3020 3d20 6472 202a 2069  int ie0 = dr * i
-00035e20: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-00035e30: 7420 6965 3120 3d20 4d49 4e28 6965 3020  t ie1 = MIN(ie0 
-00035e40: 2b20 6472 2c20 6e65 293b 0a0a 2020 2020  + dr, ne);..    
-00035e50: 6966 2028 6965 3020 3c20 6965 3129 207b  if (ie0 < ie1) {
-00035e60: 0a20 2020 2020 2020 206d 656d 6370 7928  .        memcpy(
-00035e70: 0a20 2020 2020 2020 2020 2020 2028 2863  .            ((c
-00035e80: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
-00035e90: 6120 2b20 6965 302a 6e62 3029 2c0a 2020  a + ie0*nb0),.  
-00035ea0: 2020 2020 2020 2020 2020 2828 6368 6172            ((char
-00035eb0: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-00035ec0: 2069 6530 2a6e 6230 3029 2c0a 2020 2020   ie0*nb00),.    
-00035ed0: 2020 2020 2020 2020 2869 6531 202d 2069          (ie1 - i
-00035ee0: 6530 2920 2a20 4747 4d4c 5f54 5950 455f  e0) * GGML_TYPE_
-00035ef0: 5349 5a45 5b73 7263 302d 3e74 7970 655d  SIZE[src0->type]
-00035f00: 293b 0a20 2020 207d 0a0a 7d0a 7374 6174  );.    }..}.stat
-00035f10: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00035f20: 7075 7465 5f66 6f72 7761 7264 5f64 7570  pute_forward_dup
-00035f30: 5f66 3136 280a 2020 2020 2020 2020 636f  _f16(.        co
-00035f40: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00035f50: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00035f60: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00035f70: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00035f80: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00035f90: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00035fa0: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00035fb0: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-00035fc0: 5353 4552 5428 6767 6d6c 5f6e 656c 656d  SSERT(ggml_nelem
-00035fd0: 656e 7473 2864 7374 2920 3d3d 2067 676d  ents(dst) == ggm
-00035fe0: 6c5f 6e65 6c65 6d65 6e74 7328 7372 6330  l_nelements(src0
-00035ff0: 2929 3b0a 0a20 2020 2069 6620 2870 6172  ));..    if (par
-00036000: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00036010: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-00036020: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00036030: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-00036040: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00036050: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00036060: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00036070: 3030 203d 2073 7263 302d 3e6e 655b 305d  00 = src0->ne[0]
-00036080: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00036090: 345f 7420 6e65 3031 203d 2073 7263 302d  4_t ne01 = src0-
-000360a0: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
-000360b0: 7420 696e 7436 345f 7420 6e65 3032 203d  t int64_t ne02 =
-000360c0: 2073 7263 302d 3e6e 655b 325d 3b0a 2020   src0->ne[2];.  
-000360d0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000360e0: 6e65 3033 203d 2073 7263 302d 3e6e 655b  ne03 = src0->ne[
-000360f0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-00036100: 6e74 3634 5f74 206e 6530 203d 2064 7374  nt64_t ne0 = dst
-00036110: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
-00036120: 7374 2069 6e74 3634 5f74 206e 6531 203d  st int64_t ne1 =
-00036130: 2064 7374 2d3e 6e65 5b31 5d3b 0a20 2020   dst->ne[1];.   
-00036140: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00036150: 6532 203d 2064 7374 2d3e 6e65 5b32 5d3b  e2 = dst->ne[2];
-00036160: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00036170: 5f74 206e 6533 203d 2064 7374 2d3e 6e65  _t ne3 = dst->ne
-00036180: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-00036190: 7369 7a65 5f74 206e 6230 3020 3d20 7372  size_t nb00 = sr
-000361a0: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
-000361b0: 6f6e 7374 2073 697a 655f 7420 6e62 3031  onst size_t nb01
-000361c0: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
-000361d0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-000361e0: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
-000361f0: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
-00036200: 697a 655f 7420 6e62 3033 203d 2073 7263  ize_t nb03 = src
-00036210: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
-00036220: 6f6e 7374 2073 697a 655f 7420 6e62 3020  onst size_t nb0 
-00036230: 3d20 6473 742d 3e6e 625b 305d 3b0a 2020  = dst->nb[0];.  
-00036240: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00036250: 6231 203d 2064 7374 2d3e 6e62 5b31 5d3b  b1 = dst->nb[1];
-00036260: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00036270: 7420 6e62 3220 3d20 6473 742d 3e6e 625b  t nb2 = dst->nb[
-00036280: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
-00036290: 7a65 5f74 206e 6233 203d 2064 7374 2d3e  ze_t nb3 = dst->
-000362a0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-000362b0: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
-000362c0: 6d73 2d3e 6974 683b 202f 2f20 7468 7265  ms->ith; // thre
-000362d0: 6164 2069 6e64 6578 0a20 2020 2063 6f6e  ad index.    con
-000362e0: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
-000362f0: 616d 732d 3e6e 7468 3b20 2f2f 206e 756d  ams->nth; // num
-00036300: 6265 7220 6f66 2074 6872 6561 6473 0a0a  ber of threads..
-00036310: 2020 2020 6966 2028 6767 6d6c 5f69 735f      if (ggml_is_
-00036320: 636f 6e74 6967 756f 7573 2873 7263 3029  contiguous(src0)
-00036330: 2026 2620 6767 6d6c 5f69 735f 636f 6e74   && ggml_is_cont
-00036340: 6967 756f 7573 2864 7374 2920 2626 2073  iguous(dst) && s
-00036350: 7263 302d 3e74 7970 6520 3d3d 2064 7374  rc0->type == dst
-00036360: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-00036370: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00036380: 6f72 7761 7264 5f64 7570 5f73 616d 655f  orward_dup_same_
-00036390: 636f 6e74 2870 6172 616d 732c 2073 7263  cont(params, src
-000363a0: 302c 2064 7374 293b 0a20 2020 2020 2020  0, dst);.       
-000363b0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-000363c0: 2020 2020 2f2f 2070 6172 616c 6c65 6c69      // paralleli
-000363d0: 7a65 2062 7920 726f 7773 0a20 2020 2063  ze by rows.    c
-000363e0: 6f6e 7374 2069 6e74 206e 7220 3d20 6e65  onst int nr = ne
-000363f0: 3031 3b0a 2020 2020 2f2f 206e 756d 6265  01;.    // numbe
-00036400: 7220 6f66 2072 6f77 7320 7065 7220 7468  r of rows per th
-00036410: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-00036420: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
-00036430: 6820 2d20 3129 202f 206e 7468 3b0a 2020  h - 1) / nth;.  
-00036440: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
-00036450: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
-00036460: 2020 2063 6f6e 7374 2069 6e74 2069 7230     const int ir0
-00036470: 203d 2064 7220 2a20 6974 683b 0a20 2020   = dr * ith;.   
-00036480: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
-00036490: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
-000364a0: 7229 3b0a 0a20 2020 2069 6620 2873 7263  r);..    if (src
-000364b0: 302d 3e74 7970 6520 3d3d 2064 7374 2d3e  0->type == dst->
-000364c0: 7479 7065 2026 260a 2020 2020 2020 2020  type &&.        
-000364d0: 6e65 3030 203d 3d20 6e65 3020 2626 0a20  ne00 == ne0 &&. 
-000364e0: 2020 2020 2020 206e 6230 3020 3d3d 2047         nb00 == G
-000364f0: 474d 4c5f 5459 5045 5f53 495a 455b 7372  GML_TYPE_SIZE[sr
-00036500: 6330 2d3e 7479 7065 5d20 2626 206e 6230  c0->type] && nb0
-00036510: 203d 3d20 4747 4d4c 5f54 5950 455f 5349   == GGML_TYPE_SI
-00036520: 5a45 5b64 7374 2d3e 7479 7065 5d29 207b  ZE[dst->type]) {
-00036530: 0a20 2020 2020 2020 202f 2f20 636f 7079  .        // copy
-00036540: 2062 7920 726f 7773 0a20 2020 2020 2020   by rows.       
-00036550: 2063 6f6e 7374 2073 697a 655f 7420 7273   const size_t rs
-00036560: 203d 206e 6530 302a 6e62 3030 3b0a 2020   = ne00*nb00;.  
-00036570: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00036580: 5f74 2069 3033 203d 2030 3b20 6930 3320  _t i03 = 0; i03 
-00036590: 3c20 6e65 3033 3b20 6930 332b 2b29 207b  < ne03; i03++) {
-000365a0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000365b0: 2028 696e 7436 345f 7420 6930 3220 3d20   (int64_t i02 = 
-000365c0: 303b 2069 3032 203c 206e 6530 323b 2069  0; i02 < ne02; i
-000365d0: 3032 2b2b 2920 7b0a 2020 2020 2020 2020  02++) {.        
-000365e0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-000365f0: 3634 5f74 2069 3031 203d 2069 7230 3b20  64_t i01 = ir0; 
-00036600: 6930 3120 3c20 6972 313b 2069 3031 2b2b  i01 < ir1; i01++
-00036610: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00036620: 2020 2020 2020 2020 6d65 6d63 7079 280a          memcpy(.
-00036630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036640: 2020 2020 2020 2020 2828 6368 6172 202a          ((char *
-00036650: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
-00036660: 3031 2a6e 6231 2020 2b20 6930 322a 6e62  01*nb1  + i02*nb
-00036670: 3220 202b 2069 3033 2a6e 6233 292c 0a20  2  + i03*nb3),. 
-00036680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036690: 2020 2020 2020 2028 2863 6861 7220 2a29         ((char *)
-000366a0: 2073 7263 302d 3e64 6174 6120 2b20 6930   src0->data + i0
-000366b0: 312a 6e62 3031 202b 2069 3032 2a6e 6230  1*nb01 + i02*nb0
-000366c0: 3220 2b20 6930 332a 6e62 3033 292c 0a20  2 + i03*nb03),. 
-000366d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000366e0: 2020 2020 2020 2072 7329 3b0a 2020 2020         rs);.    
-000366f0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00036700: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00036710: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
-00036720: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00036730: 202f 2f20 544f 444f 3a20 6164 6420 6d6f   // TODO: add mo
-00036740: 7265 2073 7065 6369 616c 2d63 6173 6520  re special-case 
-00036750: 696d 706c 656d 656e 7461 7469 6f6e 7320  implementations 
-00036760: 666f 7220 7465 6e73 6f72 2073 6861 7065  for tensor shape
-00036770: 732f 7374 7269 6465 7320 7468 6174 2063  s/strides that c
-00036780: 616e 2062 656e 6566 6974 2066 726f 6d20  an benefit from 
-00036790: 6d65 6d63 7079 0a0a 2020 2020 6966 2028  memcpy..    if (
-000367a0: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
-000367b0: 7573 2864 7374 2929 207b 0a20 2020 2020  us(dst)) {.     
-000367c0: 2020 2069 6620 286e 6230 3020 3d3d 2073     if (nb00 == s
-000367d0: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
-000367e0: 7429 2920 7b0a 2020 2020 2020 2020 2020  t)) {.          
-000367f0: 2020 6966 2028 6473 742d 3e74 7970 6520    if (dst->type 
-00036800: 3d3d 2047 474d 4c5f 5459 5045 5f46 3136  == GGML_TYPE_F16
-00036810: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00036820: 2020 2020 7369 7a65 5f74 2069 6420 3d20      size_t id = 
-00036830: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-00036840: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00036850: 7273 203d 206e 6530 3020 2a20 6e62 3030  rs = ne00 * nb00
-00036860: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00036870: 2020 6368 6172 202a 2064 7374 5f70 7472    char * dst_ptr
-00036880: 203d 2028 6368 6172 202a 2920 6473 742d   = (char *) dst-
-00036890: 3e64 6174 613b 0a0a 2020 2020 2020 2020  >data;..        
-000368a0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-000368b0: 2069 3033 203d 2030 3b20 6930 3320 3c20   i03 = 0; i03 < 
-000368c0: 6e65 3033 3b20 6930 332b 2b29 207b 0a20  ne03; i03++) {. 
+000296a0: 2020 2a20 6229 207b 0a20 2020 2072 6574    * b) {.    ret
+000296b0: 7572 6e20 6767 6d6c 5f64 6976 5f69 6d70  urn ggml_div_imp
+000296c0: 6c28 6374 782c 2061 2c20 622c 2074 7275  l(ctx, a, b, tru
+000296d0: 6529 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f73  e);.}..// ggml_s
+000296e0: 7172 0a0a 7374 7275 6374 2067 676d 6c5f  qr..struct ggml_
+000296f0: 7465 6e73 6f72 202a 2067 676d 6c5f 7371  tensor * ggml_sq
+00029700: 725f 696d 706c 280a 2020 2020 2020 2020  r_impl(.        
+00029710: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+00029720: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+00029730: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00029740: 656e 736f 7220 2a20 612c 0a20 2020 2020  ensor * a,.     
+00029750: 2020 2062 6f6f 6c20 696e 706c 6163 6529     bool inplace)
+00029760: 207b 0a20 2020 2062 6f6f 6c20 6973 5f6e   {.    bool is_n
+00029770: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
+00029780: 2020 6966 2028 2169 6e70 6c61 6365 2026    if (!inplace &
+00029790: 2620 2861 2d3e 6772 6164 2929 207b 0a20  & (a->grad)) {. 
+000297a0: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
+000297b0: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
+000297c0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+000297d0: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
+000297e0: 696e 706c 6163 6520 3f20 6767 6d6c 5f76  inplace ? ggml_v
+000297f0: 6965 775f 7465 6e73 6f72 2863 7478 2c20  iew_tensor(ctx, 
+00029800: 6129 203a 2067 676d 6c5f 6475 705f 7465  a) : ggml_dup_te
+00029810: 6e73 6f72 2863 7478 2c20 6129 3b0a 0a20  nsor(ctx, a);.. 
+00029820: 2020 2072 6573 756c 742d 3e6f 7020 2020     result->op   
+00029830: 3d20 4747 4d4c 5f4f 505f 5351 523b 0a20  = GGML_OP_SQR;. 
+00029840: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
+00029850: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
+00029860: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+00029870: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
+00029880: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+00029890: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
+000298a0: 742d 3e73 7263 3120 3d20 4e55 4c4c 3b0a  t->src1 = NULL;.
+000298b0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+000298c0: 6c74 3b0a 7d0a 0a73 7472 7563 7420 6767  lt;.}..struct gg
+000298d0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+000298e0: 5f73 7172 280a 2020 2020 2020 2020 7374  _sqr(.        st
+000298f0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+00029900: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+00029910: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00029920: 736f 7220 202a 2061 2920 7b0a 2020 2020  sor  * a) {.    
+00029930: 7265 7475 726e 2067 676d 6c5f 7371 725f  return ggml_sqr_
+00029940: 696d 706c 2863 7478 2c20 612c 2066 616c  impl(ctx, a, fal
+00029950: 7365 293b 0a7d 0a0a 7374 7275 6374 2067  se);.}..struct g
+00029960: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+00029970: 6c5f 7371 725f 696e 706c 6163 6528 0a20  l_sqr_inplace(. 
+00029980: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00029990: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+000299a0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+000299b0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
+000299c0: 6129 207b 0a20 2020 2072 6574 7572 6e20  a) {.    return 
+000299d0: 6767 6d6c 5f73 7172 5f69 6d70 6c28 6374  ggml_sqr_impl(ct
+000299e0: 782c 2061 2c20 7472 7565 293b 0a7d 0a0a  x, a, true);.}..
+000299f0: 2f2f 2067 676d 6c5f 7371 7274 0a0a 7374  // ggml_sqrt..st
+00029a00: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00029a10: 202a 2067 676d 6c5f 7371 7274 5f69 6d70   * ggml_sqrt_imp
+00029a20: 6c28 0a20 2020 2020 2020 2073 7472 7563  l(.        struc
+00029a30: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+00029a40: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+00029a50: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00029a60: 202a 2061 2c0a 2020 2020 2020 2020 626f   * a,.        bo
+00029a70: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
+00029a80: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
+00029a90: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
+00029aa0: 2821 696e 706c 6163 6520 2626 2028 612d  (!inplace && (a-
+00029ab0: 3e67 7261 6429 2920 7b0a 2020 2020 2020  >grad)) {.      
+00029ac0: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+00029ad0: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+00029ae0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00029af0: 2a20 7265 7375 6c74 203d 2069 6e70 6c61  * result = inpla
+00029b00: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
+00029b10: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
+00029b20: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00029b30: 6374 782c 2061 293b 0a0a 2020 2020 7265  ctx, a);..    re
+00029b40: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+00029b50: 4c5f 4f50 5f53 5152 543b 0a20 2020 2072  L_OP_SQRT;.    r
+00029b60: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
+00029b70: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
+00029b80: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
+00029b90: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
+00029ba0: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
+00029bb0: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
+00029bc0: 7263 3120 3d20 4e55 4c4c 3b0a 0a20 2020  rc1 = NULL;..   
+00029bd0: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+00029be0: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
+00029bf0: 656e 736f 7220 2a20 6767 6d6c 5f73 7172  ensor * ggml_sqr
+00029c00: 7428 0a20 2020 2020 2020 2073 7472 7563  t(.        struc
+00029c10: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+00029c20: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+00029c30: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00029c40: 2020 2a20 6129 207b 0a20 2020 2072 6574    * a) {.    ret
+00029c50: 7572 6e20 6767 6d6c 5f73 7172 745f 696d  urn ggml_sqrt_im
+00029c60: 706c 2863 7478 2c20 612c 2066 616c 7365  pl(ctx, a, false
+00029c70: 293b 0a7d 0a0a 7374 7275 6374 2067 676d  );.}..struct ggm
+00029c80: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+00029c90: 7371 7274 5f69 6e70 6c61 6365 280a 2020  sqrt_inplace(.  
+00029ca0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00029cb0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+00029cc0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00029cd0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+00029ce0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+00029cf0: 676d 6c5f 7371 7274 5f69 6d70 6c28 6374  gml_sqrt_impl(ct
+00029d00: 782c 2061 2c20 7472 7565 293b 0a7d 0a0a  x, a, true);.}..
+00029d10: 0a2f 2f20 6767 6d6c 5f6c 6f67 0a0a 7374  .// ggml_log..st
+00029d20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00029d30: 202a 2067 676d 6c5f 6c6f 675f 696d 706c   * ggml_log_impl
+00029d40: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+00029d50: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00029d60: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+00029d70: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00029d80: 202a 2061 2c0a 2020 2020 2020 2020 626f   * a,.        bo
+00029d90: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
+00029da0: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
+00029db0: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
+00029dc0: 2821 696e 706c 6163 6520 2626 2028 612d  (!inplace && (a-
+00029dd0: 3e67 7261 6429 2920 7b0a 2020 2020 2020  >grad)) {.      
+00029de0: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+00029df0: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+00029e00: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00029e10: 2a20 7265 7375 6c74 203d 2069 6e70 6c61  * result = inpla
+00029e20: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
+00029e30: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
+00029e40: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00029e50: 6374 782c 2061 293b 0a0a 2020 2020 7265  ctx, a);..    re
+00029e60: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+00029e70: 4c5f 4f50 5f4c 4f47 3b0a 2020 2020 7265  L_OP_LOG;.    re
+00029e80: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
+00029e90: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
+00029ea0: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
+00029eb0: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
+00029ec0: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
+00029ed0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+00029ee0: 6331 203d 204e 554c 4c3b 0a0a 2020 2020  c1 = NULL;..    
+00029ef0: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+00029f00: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+00029f10: 6e73 6f72 202a 2067 676d 6c5f 6c6f 6728  nsor * ggml_log(
+00029f20: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00029f30: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+00029f40: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+00029f50: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+00029f60: 2a20 6129 207b 0a20 2020 2072 6574 7572  * a) {.    retur
+00029f70: 6e20 6767 6d6c 5f6c 6f67 5f69 6d70 6c28  n ggml_log_impl(
+00029f80: 6374 782c 2061 2c20 6661 6c73 6529 3b0a  ctx, a, false);.
+00029f90: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
+00029fa0: 656e 736f 7220 2a20 6767 6d6c 5f6c 6f67  ensor * ggml_log
+00029fb0: 5f69 6e70 6c61 6365 280a 2020 2020 2020  _inplace(.      
+00029fc0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+00029fd0: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+00029fe0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00029ff0: 5f74 656e 736f 7220 202a 2061 2920 7b0a  _tensor  * a) {.
+0002a000: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
+0002a010: 6c6f 675f 696d 706c 2863 7478 2c20 612c  log_impl(ctx, a,
+0002a020: 2074 7275 6529 3b0a 7d0a 0a2f 2f20 6767   true);.}..// gg
+0002a030: 6d6c 5f73 756d 0a0a 7374 7275 6374 2067  ml_sum..struct g
+0002a040: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+0002a050: 6c5f 7375 6d28 0a20 2020 2020 2020 2073  l_sum(.        s
+0002a060: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+0002a070: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+0002a080: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0002a090: 6e73 6f72 202a 2061 2920 7b0a 2020 2020  nsor * a) {.    
+0002a0a0: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
+0002a0b0: 616c 7365 3b0a 0a20 2020 2069 6620 2861  alse;..    if (a
+0002a0c0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0002a0d0: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+0002a0e0: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+0002a0f0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002a100: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+0002a110: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
+0002a120: 782c 2061 2d3e 7479 7065 2c20 3129 3b0a  x, a->type, 1);.
+0002a130: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+0002a140: 2020 3d20 4747 4d4c 5f4f 505f 5355 4d3b    = GGML_OP_SUM;
+0002a150: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+0002a160: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+0002a170: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+0002a180: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+0002a190: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+0002a1a0: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+0002a1b0: 756c 742d 3e73 7263 3120 3d20 4e55 4c4c  ult->src1 = NULL
+0002a1c0: 3b0a 0a20 2020 2072 6574 7572 6e20 7265  ;..    return re
+0002a1d0: 7375 6c74 3b0a 7d0a 0a0a 2f2f 2067 676d  sult;.}...// ggm
+0002a1e0: 6c5f 7375 6d5f 726f 7773 0a0a 7374 7275  l_sum_rows..stru
+0002a1f0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0002a200: 2067 676d 6c5f 7375 6d5f 726f 7773 280a   ggml_sum_rows(.
+0002a210: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0002a220: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0002a230: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0002a240: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0002a250: 6129 207b 0a20 2020 2062 6f6f 6c20 6973  a) {.    bool is
+0002a260: 5f6e 6f64 6520 3d20 6661 6c73 653b 0a0a  _node = false;..
+0002a270: 2020 2020 6966 2028 612d 3e67 7261 6429      if (a->grad)
+0002a280: 207b 0a20 2020 2020 2020 2069 735f 6e6f   {.        is_no
+0002a290: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
+0002a2a0: 0a0a 2020 2020 696e 7436 345f 7420 6e65  ..    int64_t ne
+0002a2b0: 5b34 5d20 3d20 7b31 2c31 2c31 2c31 7d3b  [4] = {1,1,1,1};
+0002a2c0: 0a20 2020 2066 6f72 2028 696e 7420 693d  .    for (int i=
+0002a2d0: 313b 2069 3c61 2d3e 6e5f 6469 6d73 3b20  1; i<a->n_dims; 
+0002a2e0: 2b2b 6929 207b 0a20 2020 2020 2020 206e  ++i) {.        n
+0002a2f0: 655b 695d 203d 2061 2d3e 6e65 5b69 5d3b  e[i] = a->ne[i];
+0002a300: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
+0002a310: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0002a320: 2072 6573 756c 7420 3d20 6767 6d6c 5f6e   result = ggml_n
+0002a330: 6577 5f74 656e 736f 7228 6374 782c 2061  ew_tensor(ctx, a
+0002a340: 2d3e 7479 7065 2c20 612d 3e6e 5f64 696d  ->type, a->n_dim
+0002a350: 732c 206e 6529 3b0a 0a20 2020 2072 6573  s, ne);..    res
+0002a360: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
+0002a370: 5f4f 505f 5355 4d5f 524f 5753 3b0a 2020  _OP_SUM_ROWS;.  
+0002a380: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
+0002a390: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
+0002a3a0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+0002a3b0: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
+0002a3c0: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
+0002a3d0: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
+0002a3e0: 2d3e 7372 6331 203d 204e 554c 4c3b 0a0a  ->src1 = NULL;..
+0002a3f0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0002a400: 743b 0a7d 0a0a 2f2f 2067 676d 6c5f 6d65  t;.}..// ggml_me
+0002a410: 616e 0a0a 7374 7275 6374 2067 676d 6c5f  an..struct ggml_
+0002a420: 7465 6e73 6f72 202a 2067 676d 6c5f 6d65  tensor * ggml_me
+0002a430: 616e 280a 2020 2020 2020 2020 7374 7275  an(.        stru
+0002a440: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0002a450: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+0002a460: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002a470: 7220 2a20 6129 207b 0a20 2020 2062 6f6f  r * a) {.    boo
+0002a480: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
+0002a490: 653b 0a0a 2020 2020 6966 2028 612d 3e67  e;..    if (a->g
+0002a4a0: 7261 6429 207b 0a20 2020 2020 2020 2047  rad) {.        G
+0002a4b0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+0002a4c0: 293b 202f 2f20 544f 444f 3a20 696d 706c  ); // TODO: impl
+0002a4d0: 656d 656e 740a 2020 2020 2020 2020 6973  ement.        is
+0002a4e0: 5f6e 6f64 6520 3d20 7472 7565 3b0a 2020  _node = true;.  
+0002a4f0: 2020 7d0a 0a20 2020 2069 6e74 3634 5f74    }..    int64_t
+0002a500: 206e 655b 4747 4d4c 5f4d 4158 5f44 494d   ne[GGML_MAX_DIM
+0002a510: 535d 203d 207b 2031 2c20 612d 3e6e 655b  S] = { 1, a->ne[
+0002a520: 315d 2c20 612d 3e6e 655b 325d 2c20 612d  1], a->ne[2], a-
+0002a530: 3e6e 655b 335d 207d 3b0a 2020 2020 7374  >ne[3] };.    st
+0002a540: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002a550: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
+0002a560: 5f6e 6577 5f74 656e 736f 7228 6374 782c  _new_tensor(ctx,
+0002a570: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
+0002a580: 612d 3e6e 5f64 696d 732c 206e 6529 3b0a  a->n_dims, ne);.
+0002a590: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+0002a5a0: 2020 3d20 4747 4d4c 5f4f 505f 4d45 414e    = GGML_OP_MEAN
+0002a5b0: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
+0002a5c0: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
+0002a5d0: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
+0002a5e0: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
+0002a5f0: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
+0002a600: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
+0002a610: 7375 6c74 2d3e 7372 6331 203d 204e 554c  sult->src1 = NUL
+0002a620: 4c3b 0a0a 2020 2020 7265 7475 726e 2072  L;..    return r
+0002a630: 6573 756c 743b 0a7d 0a0a 2f2f 2067 676d  esult;.}..// ggm
+0002a640: 6c5f 7265 7065 6174 0a0a 7374 7275 6374  l_repeat..struct
+0002a650: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+0002a660: 676d 6c5f 7265 7065 6174 280a 2020 2020  gml_repeat(.    
+0002a670: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002a680: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+0002a690: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0002a6a0: 6d6c 5f74 656e 736f 7220 2a20 612c 0a20  ml_tensor * a,. 
+0002a6b0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0002a6c0: 6d6c 5f74 656e 736f 7220 2a20 6229 207b  ml_tensor * b) {
+0002a6d0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0002a6e0: 2867 676d 6c5f 6361 6e5f 7265 7065 6174  (ggml_can_repeat
+0002a6f0: 2861 2c20 6229 293b 0a0a 2020 2020 626f  (a, b));..    bo
+0002a700: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
+0002a710: 7365 3b0a 0a20 2020 2069 6620 2861 2d3e  se;..    if (a->
+0002a720: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+0002a730: 6973 5f6e 6f64 6520 3d20 7472 7565 3b0a  is_node = true;.
+0002a740: 2020 2020 7d0a 0a20 2020 2069 6620 2867      }..    if (g
+0002a750: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
+0002a760: 7065 2861 2c20 6229 2026 2620 2169 735f  pe(a, b) && !is_
+0002a770: 6e6f 6465 2920 7b0a 2020 2020 2020 2020  node) {.        
+0002a780: 7265 7475 726e 2061 3b0a 2020 2020 7d0a  return a;.    }.
+0002a790: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+0002a7a0: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
+0002a7b0: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+0002a7c0: 6f72 2863 7478 2c20 612d 3e74 7970 652c  or(ctx, a->type,
+0002a7d0: 2062 2d3e 6e5f 6469 6d73 2c20 622d 3e6e   b->n_dims, b->n
+0002a7e0: 6529 3b0a 0a20 2020 2072 6573 756c 742d  e);..    result-
+0002a7f0: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
+0002a800: 5245 5045 4154 3b0a 2020 2020 7265 7375  REPEAT;.    resu
+0002a810: 6c74 2d3e 6772 6164 203d 2069 735f 6e6f  lt->grad = is_no
+0002a820: 6465 203f 2067 676d 6c5f 6475 705f 7465  de ? ggml_dup_te
+0002a830: 6e73 6f72 2863 7478 2c20 7265 7375 6c74  nsor(ctx, result
+0002a840: 2920 3a20 4e55 4c4c 3b0a 2020 2020 7265  ) : NULL;.    re
+0002a850: 7375 6c74 2d3e 7372 6330 203d 2061 3b0a  sult->src0 = a;.
+0002a860: 2020 2020 7265 7375 6c74 2d3e 7372 6331      result->src1
+0002a870: 203d 2062 3b0a 0a20 2020 2072 6574 7572   = b;..    retur
+0002a880: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f20  n result;.}..// 
+0002a890: 6767 6d6c 5f72 6570 6561 745f 6261 636b  ggml_repeat_back
+0002a8a0: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+0002a8b0: 6e73 6f72 202a 2067 676d 6c5f 7265 7065  nsor * ggml_repe
+0002a8c0: 6174 5f62 6163 6b28 0a20 2020 2020 2020  at_back(.       
+0002a8d0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+0002a8e0: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+0002a8f0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002a900: 7465 6e73 6f72 202a 2061 2c0a 2020 2020  tensor * a,.    
+0002a910: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002a920: 7465 6e73 6f72 202a 2062 2920 7b0a 2020  tensor * b) {.  
+0002a930: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0002a940: 6d6c 5f63 616e 5f72 6570 6561 7428 622c  ml_can_repeat(b,
+0002a950: 2061 2929 3b0a 0a20 2020 2062 6f6f 6c20   a));..    bool 
+0002a960: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
+0002a970: 0a0a 2020 2020 6966 2028 612d 3e67 7261  ..    if (a->gra
+0002a980: 6429 207b 0a20 2020 2020 2020 2069 735f  d) {.        is_
+0002a990: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+0002a9a0: 207d 0a0a 2020 2020 6966 2028 6767 6d6c   }..    if (ggml
+0002a9b0: 5f61 7265 5f73 616d 655f 7368 6170 6528  _are_same_shape(
+0002a9c0: 612c 2062 2920 2626 2021 6973 5f6e 6f64  a, b) && !is_nod
+0002a9d0: 6529 207b 0a20 2020 2020 2020 2072 6574  e) {.        ret
+0002a9e0: 7572 6e20 613b 0a20 2020 207d 0a0a 2020  urn a;.    }..  
+0002a9f0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0002aa00: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
+0002aa10: 6767 6d6c 5f6e 6577 5f74 656e 736f 7228  ggml_new_tensor(
+0002aa20: 6374 782c 2061 2d3e 7479 7065 2c20 622d  ctx, a->type, b-
+0002aa30: 3e6e 5f64 696d 732c 2062 2d3e 6e65 293b  >n_dims, b->ne);
+0002aa40: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
+0002aa50: 2020 203d 2047 474d 4c5f 4f50 5f52 4550     = GGML_OP_REP
+0002aa60: 4541 545f 4241 434b 3b0a 2020 2020 7265  EAT_BACK;.    re
+0002aa70: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
+0002aa80: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
+0002aa90: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
+0002aaa0: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
+0002aab0: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
+0002aac0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+0002aad0: 6331 203d 2062 3b0a 0a20 2020 2072 6574  c1 = b;..    ret
+0002aae0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
+0002aaf0: 2f20 6767 6d6c 5f61 6273 0a0a 7374 7275  / ggml_abs..stru
+0002ab00: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0002ab10: 2067 676d 6c5f 6162 735f 696d 706c 280a   ggml_abs_impl(.
+0002ab20: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0002ab30: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0002ab40: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0002ab50: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0002ab60: 612c 0a20 2020 2020 2020 2062 6f6f 6c20  a,.        bool 
+0002ab70: 696e 706c 6163 6529 207b 0a20 2020 2062  inplace) {.    b
+0002ab80: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
+0002ab90: 6c73 653b 0a0a 2020 2020 6966 2028 2169  lse;..    if (!i
+0002aba0: 6e70 6c61 6365 2026 2620 2861 2d3e 6772  nplace && (a->gr
+0002abb0: 6164 2929 207b 0a20 2020 2020 2020 2069  ad)) {.        i
+0002abc0: 735f 6e6f 6465 203d 2074 7275 653b 0a20  s_node = true;. 
+0002abd0: 2020 207d 0a0a 2020 2020 7374 7275 6374     }..    struct
+0002abe0: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
+0002abf0: 6573 756c 7420 3d20 696e 706c 6163 6520  esult = inplace 
+0002ac00: 3f20 6767 6d6c 5f76 6965 775f 7465 6e73  ? ggml_view_tens
+0002ac10: 6f72 2863 7478 2c20 6129 203a 2067 676d  or(ctx, a) : ggm
+0002ac20: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
+0002ac30: 2c20 6129 3b0a 0a20 2020 2072 6573 756c  , a);..    resul
+0002ac40: 742d 3e6f 7020 2020 3d20 4747 4d4c 5f4f  t->op   = GGML_O
+0002ac50: 505f 4142 533b 0a20 2020 2072 6573 756c  P_ABS;.    resul
+0002ac60: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
+0002ac70: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
+0002ac80: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
+0002ac90: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
+0002aca0: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
+0002acb0: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
+0002acc0: 3d20 4e55 4c4c 3b0a 0a20 2020 2072 6574  = NULL;..    ret
+0002acd0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
+0002ace0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002acf0: 7220 2a20 6767 6d6c 5f61 6273 280a 2020  r * ggml_abs(.  
+0002ad00: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002ad10: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002ad20: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002ad30: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+0002ad40: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0002ad50: 676d 6c5f 6162 735f 696d 706c 2863 7478  gml_abs_impl(ctx
+0002ad60: 2c20 612c 2066 616c 7365 293b 0a7d 0a0a  , a, false);.}..
+0002ad70: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002ad80: 6f72 202a 2067 676d 6c5f 6162 735f 696e  or * ggml_abs_in
+0002ad90: 706c 6163 6528 0a20 2020 2020 2020 2073  place(.        s
+0002ada0: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+0002adb0: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+0002adc0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0002add0: 6e73 6f72 2020 2a20 6129 207b 0a20 2020  nsor  * a) {.   
+0002ade0: 2072 6574 7572 6e20 6767 6d6c 5f61 6273   return ggml_abs
+0002adf0: 5f69 6d70 6c28 6374 782c 2061 2c20 7472  _impl(ctx, a, tr
+0002ae00: 7565 293b 0a7d 0a0a 0a2f 2f20 6767 6d6c  ue);.}...// ggml
+0002ae10: 5f73 676e 0a0a 7374 7275 6374 2067 676d  _sgn..struct ggm
+0002ae20: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+0002ae30: 7367 6e5f 696d 706c 280a 2020 2020 2020  sgn_impl(.      
+0002ae40: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+0002ae50: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+0002ae60: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0002ae70: 5f74 656e 736f 7220 2a20 612c 0a20 2020  _tensor * a,.   
+0002ae80: 2020 2020 2062 6f6f 6c20 696e 706c 6163       bool inplac
+0002ae90: 6529 207b 0a20 2020 2062 6f6f 6c20 6973  e) {.    bool is
+0002aea0: 5f6e 6f64 6520 3d20 6661 6c73 653b 0a0a  _node = false;..
+0002aeb0: 2020 2020 6966 2028 2169 6e70 6c61 6365      if (!inplace
+0002aec0: 2026 2620 2861 2d3e 6772 6164 2929 207b   && (a->grad)) {
+0002aed0: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
+0002aee0: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
+0002aef0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002af00: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
+0002af10: 3d20 696e 706c 6163 6520 3f20 6767 6d6c  = inplace ? ggml
+0002af20: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
+0002af30: 2c20 6129 203a 2067 676d 6c5f 6475 705f  , a) : ggml_dup_
+0002af40: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
+0002af50: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+0002af60: 2020 3d20 4747 4d4c 5f4f 505f 5347 4e3b    = GGML_OP_SGN;
+0002af70: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+0002af80: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+0002af90: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+0002afa0: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+0002afb0: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+0002afc0: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+0002afd0: 756c 742d 3e73 7263 3120 3d20 4e55 4c4c  ult->src1 = NULL
+0002afe0: 3b0a 0a20 2020 2072 6574 7572 6e20 7265  ;..    return re
+0002aff0: 7375 6c74 3b0a 7d0a 0a73 7472 7563 7420  sult;.}..struct 
+0002b000: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0002b010: 6d6c 5f73 676e 280a 2020 2020 2020 2020  ml_sgn(.        
+0002b020: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+0002b030: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+0002b040: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0002b050: 656e 736f 7220 202a 2061 2920 7b0a 2020  ensor  * a) {.  
+0002b060: 2020 7265 7475 726e 2067 676d 6c5f 7367    return ggml_sg
+0002b070: 6e5f 696d 706c 2863 7478 2c20 612c 2066  n_impl(ctx, a, f
+0002b080: 616c 7365 293b 0a7d 0a0a 7374 7275 6374  alse);.}..struct
+0002b090: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+0002b0a0: 676d 6c5f 7367 6e5f 696e 706c 6163 6528  gml_sgn_inplace(
+0002b0b0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002b0c0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0002b0d0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0002b0e0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+0002b0f0: 2a20 6129 207b 0a20 2020 2072 6574 7572  * a) {.    retur
+0002b100: 6e20 6767 6d6c 5f73 676e 5f69 6d70 6c28  n ggml_sgn_impl(
+0002b110: 6374 782c 2061 2c20 7472 7565 293b 0a7d  ctx, a, true);.}
+0002b120: 0a0a 2f2f 2067 676d 6c5f 6e65 670a 0a73  ..// ggml_neg..s
+0002b130: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002b140: 7220 2a20 6767 6d6c 5f6e 6567 5f69 6d70  r * ggml_neg_imp
+0002b150: 6c28 0a20 2020 2020 2020 2073 7472 7563  l(.        struc
+0002b160: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+0002b170: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+0002b180: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002b190: 202a 2061 2c0a 2020 2020 2020 2020 626f   * a,.        bo
+0002b1a0: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
+0002b1b0: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
+0002b1c0: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
+0002b1d0: 2821 696e 706c 6163 6520 2626 2028 612d  (!inplace && (a-
+0002b1e0: 3e67 7261 6429 2920 7b0a 2020 2020 2020  >grad)) {.      
+0002b1f0: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+0002b200: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+0002b210: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002b220: 2a20 7265 7375 6c74 203d 2069 6e70 6c61  * result = inpla
+0002b230: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
+0002b240: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
+0002b250: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+0002b260: 6374 782c 2061 293b 0a0a 2020 2020 7265  ctx, a);..    re
+0002b270: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+0002b280: 4c5f 4f50 5f4e 4547 3b0a 2020 2020 7265  L_OP_NEG;.    re
+0002b290: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
+0002b2a0: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
+0002b2b0: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
+0002b2c0: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
+0002b2d0: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
+0002b2e0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+0002b2f0: 6331 203d 204e 554c 4c3b 0a0a 2020 2020  c1 = NULL;..    
+0002b300: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+0002b310: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+0002b320: 6e73 6f72 202a 2067 676d 6c5f 6e65 6728  nsor * ggml_neg(
+0002b330: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002b340: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0002b350: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0002b360: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+0002b370: 2a20 6129 207b 0a20 2020 2072 6574 7572  * a) {.    retur
+0002b380: 6e20 6767 6d6c 5f6e 6567 5f69 6d70 6c28  n ggml_neg_impl(
+0002b390: 6374 782c 2061 2c20 6661 6c73 6529 3b0a  ctx, a, false);.
+0002b3a0: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
+0002b3b0: 656e 736f 7220 2a20 6767 6d6c 5f6e 6567  ensor * ggml_neg
+0002b3c0: 5f69 6e70 6c61 6365 280a 2020 2020 2020  _inplace(.      
+0002b3d0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+0002b3e0: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+0002b3f0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0002b400: 5f74 656e 736f 7220 202a 2061 2920 7b0a  _tensor  * a) {.
+0002b410: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
+0002b420: 6e65 675f 696d 706c 2863 7478 2c20 612c  neg_impl(ctx, a,
+0002b430: 2074 7275 6529 3b0a 7d0a 0a2f 2f20 6767   true);.}..// gg
+0002b440: 6d6c 5f73 7465 700a 0a73 7472 7563 7420  ml_step..struct 
+0002b450: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0002b460: 6d6c 5f73 7465 705f 696d 706c 280a 2020  ml_step_impl(.  
+0002b470: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002b480: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002b490: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002b4a0: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
+0002b4b0: 0a20 2020 2020 2020 2062 6f6f 6c20 696e  .        bool in
+0002b4c0: 706c 6163 6529 207b 0a20 2020 2062 6f6f  place) {.    boo
+0002b4d0: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
+0002b4e0: 653b 0a0a 2020 2020 6966 2028 2169 6e70  e;..    if (!inp
+0002b4f0: 6c61 6365 2026 2620 2861 2d3e 6772 6164  lace && (a->grad
+0002b500: 2929 207b 0a20 2020 2020 2020 2069 735f  )) {.        is_
+0002b510: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+0002b520: 207d 0a0a 2020 2020 7374 7275 6374 2067   }..    struct g
+0002b530: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+0002b540: 756c 7420 3d20 696e 706c 6163 6520 3f20  ult = inplace ? 
+0002b550: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
+0002b560: 2863 7478 2c20 6129 203a 2067 676d 6c5f  (ctx, a) : ggml_
+0002b570: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+0002b580: 6129 3b0a 0a20 2020 2072 6573 756c 742d  a);..    result-
+0002b590: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
+0002b5a0: 5354 4550 3b0a 2020 2020 7265 7375 6c74  STEP;.    result
+0002b5b0: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
+0002b5c0: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
+0002b5d0: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
+0002b5e0: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
+0002b5f0: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
+0002b600: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
+0002b610: 204e 554c 4c3b 0a0a 2020 2020 7265 7475   NULL;..    retu
+0002b620: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
+0002b630: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002b640: 202a 2067 676d 6c5f 7374 6570 280a 2020   * ggml_step(.  
+0002b650: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002b660: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002b670: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002b680: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+0002b690: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0002b6a0: 676d 6c5f 7374 6570 5f69 6d70 6c28 6374  gml_step_impl(ct
+0002b6b0: 782c 2061 2c20 6661 6c73 6529 3b0a 7d0a  x, a, false);.}.
+0002b6c0: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0002b6d0: 736f 7220 2a20 6767 6d6c 5f73 7465 705f  sor * ggml_step_
+0002b6e0: 696e 706c 6163 6528 0a20 2020 2020 2020  inplace(.       
+0002b6f0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+0002b700: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+0002b710: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002b720: 7465 6e73 6f72 2020 2a20 6129 207b 0a20  tensor  * a) {. 
+0002b730: 2020 2072 6574 7572 6e20 6767 6d6c 5f73     return ggml_s
+0002b740: 7465 705f 696d 706c 2863 7478 2c20 612c  tep_impl(ctx, a,
+0002b750: 2074 7275 6529 3b0a 7d0a 0a2f 2f20 6767   true);.}..// gg
+0002b760: 6d6c 5f72 656c 750a 0a73 7472 7563 7420  ml_relu..struct 
+0002b770: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0002b780: 6d6c 5f72 656c 755f 696d 706c 280a 2020  ml_relu_impl(.  
+0002b790: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002b7a0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002b7b0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002b7c0: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
+0002b7d0: 0a20 2020 2020 2020 2062 6f6f 6c20 696e  .        bool in
+0002b7e0: 706c 6163 6529 207b 0a20 2020 2062 6f6f  place) {.    boo
+0002b7f0: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
+0002b800: 653b 0a0a 2020 2020 6966 2028 2169 6e70  e;..    if (!inp
+0002b810: 6c61 6365 2026 2620 2861 2d3e 6772 6164  lace && (a->grad
+0002b820: 2929 207b 0a20 2020 2020 2020 2069 735f  )) {.        is_
+0002b830: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+0002b840: 207d 0a0a 2020 2020 7374 7275 6374 2067   }..    struct g
+0002b850: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+0002b860: 756c 7420 3d20 696e 706c 6163 6520 3f20  ult = inplace ? 
+0002b870: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
+0002b880: 2863 7478 2c20 6129 203a 2067 676d 6c5f  (ctx, a) : ggml_
+0002b890: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+0002b8a0: 6129 3b0a 0a20 2020 2072 6573 756c 742d  a);..    result-
+0002b8b0: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
+0002b8c0: 5245 4c55 3b0a 2020 2020 7265 7375 6c74  RELU;.    result
+0002b8d0: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
+0002b8e0: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
+0002b8f0: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
+0002b900: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
+0002b910: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
+0002b920: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
+0002b930: 204e 554c 4c3b 0a0a 2020 2020 7265 7475   NULL;..    retu
+0002b940: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
+0002b950: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002b960: 202a 2067 676d 6c5f 7265 6c75 280a 2020   * ggml_relu(.  
+0002b970: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002b980: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002b990: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002b9a0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+0002b9b0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0002b9c0: 676d 6c5f 7265 6c75 5f69 6d70 6c28 6374  gml_relu_impl(ct
+0002b9d0: 782c 2061 2c20 6661 6c73 6529 3b0a 7d0a  x, a, false);.}.
+0002b9e0: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0002b9f0: 736f 7220 2a20 6767 6d6c 5f72 656c 755f  sor * ggml_relu_
+0002ba00: 696e 706c 6163 6528 0a20 2020 2020 2020  inplace(.       
+0002ba10: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+0002ba20: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+0002ba30: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002ba40: 7465 6e73 6f72 2020 2a20 6129 207b 0a20  tensor  * a) {. 
+0002ba50: 2020 2072 6574 7572 6e20 6767 6d6c 5f72     return ggml_r
+0002ba60: 656c 755f 696d 706c 2863 7478 2c20 612c  elu_impl(ctx, a,
+0002ba70: 2074 7275 6529 3b0a 7d0a 0a2f 2f20 6767   true);.}..// gg
+0002ba80: 6d6c 5f67 656c 750a 0a73 7472 7563 7420  ml_gelu..struct 
+0002ba90: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0002baa0: 6d6c 5f67 656c 755f 696d 706c 280a 2020  ml_gelu_impl(.  
+0002bab0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002bac0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002bad0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002bae0: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
+0002baf0: 0a20 2020 2020 2020 2062 6f6f 6c20 696e  .        bool in
+0002bb00: 706c 6163 6529 207b 0a20 2020 2062 6f6f  place) {.    boo
+0002bb10: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
+0002bb20: 653b 0a0a 2020 2020 6966 2028 2169 6e70  e;..    if (!inp
+0002bb30: 6c61 6365 2026 2620 2861 2d3e 6772 6164  lace && (a->grad
+0002bb40: 2929 207b 0a20 2020 2020 2020 2069 735f  )) {.        is_
+0002bb50: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+0002bb60: 207d 0a0a 2020 2020 7374 7275 6374 2067   }..    struct g
+0002bb70: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+0002bb80: 756c 7420 3d20 696e 706c 6163 6520 3f20  ult = inplace ? 
+0002bb90: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
+0002bba0: 2863 7478 2c20 6129 203a 2067 676d 6c5f  (ctx, a) : ggml_
+0002bbb0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+0002bbc0: 6129 3b0a 0a20 2020 2072 6573 756c 742d  a);..    result-
+0002bbd0: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
+0002bbe0: 4745 4c55 3b0a 2020 2020 7265 7375 6c74  GELU;.    result
+0002bbf0: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
+0002bc00: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
+0002bc10: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
+0002bc20: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
+0002bc30: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
+0002bc40: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
+0002bc50: 204e 554c 4c3b 0a0a 2020 2020 7265 7475   NULL;..    retu
+0002bc60: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
+0002bc70: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002bc80: 202a 2067 676d 6c5f 6765 6c75 280a 2020   * ggml_gelu(.  
+0002bc90: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002bca0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002bcb0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002bcc0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+0002bcd0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0002bce0: 676d 6c5f 6765 6c75 5f69 6d70 6c28 6374  gml_gelu_impl(ct
+0002bcf0: 782c 2061 2c20 6661 6c73 6529 3b0a 7d0a  x, a, false);.}.
+0002bd00: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0002bd10: 736f 7220 2a20 6767 6d6c 5f67 656c 755f  sor * ggml_gelu_
+0002bd20: 696e 706c 6163 6528 0a20 2020 2020 2020  inplace(.       
+0002bd30: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+0002bd40: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+0002bd50: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002bd60: 7465 6e73 6f72 2020 2a20 6129 207b 0a20  tensor  * a) {. 
+0002bd70: 2020 2072 6574 7572 6e20 6767 6d6c 5f67     return ggml_g
+0002bd80: 656c 755f 696d 706c 2863 7478 2c20 612c  elu_impl(ctx, a,
+0002bd90: 2074 7275 6529 3b0a 7d0a 0a2f 2f20 6767   true);.}..// gg
+0002bda0: 6d6c 5f73 696c 750a 0a73 7472 7563 7420  ml_silu..struct 
+0002bdb0: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0002bdc0: 6d6c 5f73 696c 755f 696d 706c 280a 2020  ml_silu_impl(.  
+0002bdd0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002bde0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002bdf0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002be00: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
+0002be10: 0a20 2020 2020 2020 2062 6f6f 6c20 696e  .        bool in
+0002be20: 706c 6163 6529 207b 0a20 2020 2062 6f6f  place) {.    boo
+0002be30: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
+0002be40: 653b 0a0a 2020 2020 6966 2028 2169 6e70  e;..    if (!inp
+0002be50: 6c61 6365 2026 2620 2861 2d3e 6772 6164  lace && (a->grad
+0002be60: 2929 207b 0a20 2020 2020 2020 2069 735f  )) {.        is_
+0002be70: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+0002be80: 207d 0a0a 2020 2020 7374 7275 6374 2067   }..    struct g
+0002be90: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+0002bea0: 756c 7420 3d20 696e 706c 6163 6520 3f20  ult = inplace ? 
+0002beb0: 6767 6d6c 5f76 6965 775f 7465 6e73 6f72  ggml_view_tensor
+0002bec0: 2863 7478 2c20 6129 203a 2067 676d 6c5f  (ctx, a) : ggml_
+0002bed0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+0002bee0: 6129 3b0a 0a20 2020 2072 6573 756c 742d  a);..    result-
+0002bef0: 3e6f 7020 2020 3d20 4747 4d4c 5f4f 505f  >op   = GGML_OP_
+0002bf00: 5349 4c55 3b0a 2020 2020 7265 7375 6c74  SILU;.    result
+0002bf10: 2d3e 6772 6164 203d 2069 735f 6e6f 6465  ->grad = is_node
+0002bf20: 203f 2067 676d 6c5f 6475 705f 7465 6e73   ? ggml_dup_tens
+0002bf30: 6f72 2863 7478 2c20 7265 7375 6c74 2920  or(ctx, result) 
+0002bf40: 3a20 4e55 4c4c 3b0a 2020 2020 7265 7375  : NULL;.    resu
+0002bf50: 6c74 2d3e 7372 6330 203d 2061 3b0a 2020  lt->src0 = a;.  
+0002bf60: 2020 7265 7375 6c74 2d3e 7372 6331 203d    result->src1 =
+0002bf70: 204e 554c 4c3b 0a0a 2020 2020 7265 7475   NULL;..    retu
+0002bf80: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
+0002bf90: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002bfa0: 202a 2067 676d 6c5f 7369 6c75 280a 2020   * ggml_silu(.  
+0002bfb0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002bfc0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002bfd0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002bfe0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+0002bff0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0002c000: 676d 6c5f 7369 6c75 5f69 6d70 6c28 6374  gml_silu_impl(ct
+0002c010: 782c 2061 2c20 6661 6c73 6529 3b0a 7d0a  x, a, false);.}.
+0002c020: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0002c030: 736f 7220 2a20 6767 6d6c 5f73 696c 755f  sor * ggml_silu_
+0002c040: 696e 706c 6163 6528 0a20 2020 2020 2020  inplace(.       
+0002c050: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+0002c060: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+0002c070: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002c080: 7465 6e73 6f72 2020 2a20 6129 207b 0a20  tensor  * a) {. 
+0002c090: 2020 2072 6574 7572 6e20 6767 6d6c 5f73     return ggml_s
+0002c0a0: 696c 755f 696d 706c 2863 7478 2c20 612c  ilu_impl(ctx, a,
+0002c0b0: 2074 7275 6529 3b0a 7d0a 0a2f 2f20 6767   true);.}..// gg
+0002c0c0: 6d6c 5f73 696c 755f 6261 636b 0a0a 7374  ml_silu_back..st
+0002c0d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002c0e0: 202a 2067 676d 6c5f 7369 6c75 5f62 6163   * ggml_silu_bac
+0002c0f0: 6b28 0a20 2020 2020 2020 2073 7472 7563  k(.        struc
+0002c100: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+0002c110: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+0002c120: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002c130: 2020 2a20 612c 0a20 2020 2020 2020 2073    * a,.        s
+0002c140: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002c150: 7220 202a 2062 2920 7b0a 2020 2020 626f  r  * b) {.    bo
+0002c160: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
+0002c170: 7365 3b0a 0a20 2020 2069 6620 2861 2d3e  se;..    if (a->
+0002c180: 6772 6164 207c 7c20 622d 3e67 7261 6429  grad || b->grad)
+0002c190: 207b 0a20 2020 2020 2020 202f 2f20 544f   {.        // TO
+0002c1a0: 444f 3a20 696d 706c 656d 656e 7420 6261  DO: implement ba
+0002c1b0: 636b 7761 7264 0a20 2020 2020 2020 2069  ckward.        i
+0002c1c0: 735f 6e6f 6465 203d 2074 7275 653b 0a20  s_node = true;. 
+0002c1d0: 2020 207d 0a0a 2020 2020 7374 7275 6374     }..    struct
+0002c1e0: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
+0002c1f0: 6573 756c 7420 3d20 6767 6d6c 5f64 7570  esult = ggml_dup
+0002c200: 5f74 656e 736f 7228 6374 782c 2061 293b  _tensor(ctx, a);
+0002c210: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
+0002c220: 2020 203d 2047 474d 4c5f 4f50 5f53 494c     = GGML_OP_SIL
+0002c230: 555f 4241 434b 3b0a 2020 2020 7265 7375  U_BACK;.    resu
+0002c240: 6c74 2d3e 6772 6164 203d 2069 735f 6e6f  lt->grad = is_no
+0002c250: 6465 203f 2067 676d 6c5f 6475 705f 7465  de ? ggml_dup_te
+0002c260: 6e73 6f72 2863 7478 2c20 7265 7375 6c74  nsor(ctx, result
+0002c270: 2920 3a20 4e55 4c4c 3b0a 2020 2020 7265  ) : NULL;.    re
+0002c280: 7375 6c74 2d3e 7372 6330 203d 2061 3b0a  sult->src0 = a;.
+0002c290: 2020 2020 7265 7375 6c74 2d3e 7372 6331      result->src1
+0002c2a0: 203d 2062 3b0a 0a20 2020 2072 6574 7572   = b;..    retur
+0002c2b0: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f20  n result;.}..// 
+0002c2c0: 6767 6d6c 5f6e 6f72 6d0a 0a73 7472 7563  ggml_norm..struc
+0002c2d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0002c2e0: 6767 6d6c 5f6e 6f72 6d5f 696d 706c 280a  ggml_norm_impl(.
+0002c2f0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0002c300: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0002c310: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0002c320: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+0002c330: 2061 2c0a 2020 2020 2020 2020 626f 6f6c   a,.        bool
+0002c340: 2069 6e70 6c61 6365 2920 7b0a 2020 2020   inplace) {.    
+0002c350: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
+0002c360: 616c 7365 3b0a 0a20 2020 2069 6620 2821  alse;..    if (!
+0002c370: 696e 706c 6163 6520 2626 2028 612d 3e67  inplace && (a->g
+0002c380: 7261 6429 2920 7b0a 2020 2020 2020 2020  rad)) {.        
+0002c390: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+0002c3a0: 6529 3b20 2f2f 2054 4f44 4f3a 2069 6d70  e); // TODO: imp
+0002c3b0: 6c65 6d65 6e74 2062 6163 6b77 6172 640a  lement backward.
+0002c3c0: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
+0002c3d0: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
+0002c3e0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0002c3f0: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
+0002c400: 2069 6e70 6c61 6365 203f 2067 676d 6c5f   inplace ? ggml_
+0002c410: 7669 6577 5f74 656e 736f 7228 6374 782c  view_tensor(ctx,
+0002c420: 2061 2920 3a20 6767 6d6c 5f64 7570 5f74   a) : ggml_dup_t
+0002c430: 656e 736f 7228 6374 782c 2061 293b 0a0a  ensor(ctx, a);..
+0002c440: 2020 2020 7265 7375 6c74 2d3e 6f70 2020      result->op  
+0002c450: 203d 2047 474d 4c5f 4f50 5f4e 4f52 4d3b   = GGML_OP_NORM;
+0002c460: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+0002c470: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+0002c480: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+0002c490: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+0002c4a0: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+0002c4b0: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+0002c4c0: 756c 742d 3e73 7263 3120 3d20 4e55 4c4c  ult->src1 = NULL
+0002c4d0: 3b20 2f2f 2054 4f44 4f3a 206d 6179 6265  ; // TODO: maybe
+0002c4e0: 2073 746f 7265 2065 7073 696c 6f6e 2068   store epsilon h
+0002c4f0: 6572 653f 0a0a 2020 2020 7265 7475 726e  ere?..    return
+0002c500: 2072 6573 756c 743b 0a7d 0a0a 7374 7275   result;.}..stru
+0002c510: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0002c520: 2067 676d 6c5f 6e6f 726d 280a 2020 2020   ggml_norm(.    
+0002c530: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002c540: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+0002c550: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0002c560: 6d6c 5f74 656e 736f 7220 202a 2061 2920  ml_tensor  * a) 
+0002c570: 7b0a 2020 2020 7265 7475 726e 2067 676d  {.    return ggm
+0002c580: 6c5f 6e6f 726d 5f69 6d70 6c28 6374 782c  l_norm_impl(ctx,
+0002c590: 2061 2c20 6661 6c73 6529 3b0a 7d0a 0a73   a, false);.}..s
+0002c5a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002c5b0: 7220 2a20 6767 6d6c 5f6e 6f72 6d5f 696e  r * ggml_norm_in
+0002c5c0: 706c 6163 6528 0a20 2020 2020 2020 2073  place(.        s
+0002c5d0: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+0002c5e0: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+0002c5f0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0002c600: 6e73 6f72 2020 2a20 6129 207b 0a20 2020  nsor  * a) {.   
+0002c610: 2072 6574 7572 6e20 6767 6d6c 5f6e 6f72   return ggml_nor
+0002c620: 6d5f 696d 706c 2863 7478 2c20 612c 2074  m_impl(ctx, a, t
+0002c630: 7275 6529 3b0a 7d0a 0a73 7472 7563 7420  rue);.}..struct 
+0002c640: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0002c650: 6d6c 5f72 6d73 5f6e 6f72 6d5f 696d 706c  ml_rms_norm_impl
+0002c660: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+0002c670: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+0002c680: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+0002c690: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002c6a0: 202a 2061 2c0a 2020 2020 2020 2020 626f   * a,.        bo
+0002c6b0: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
+0002c6c0: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
+0002c6d0: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
+0002c6e0: 2821 696e 706c 6163 6520 2626 2028 612d  (!inplace && (a-
+0002c6f0: 3e67 7261 6429 2920 7b0a 2020 2020 2020  >grad)) {.      
+0002c700: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+0002c710: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+0002c720: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002c730: 2a20 7265 7375 6c74 203d 2069 6e70 6c61  * result = inpla
+0002c740: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
+0002c750: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
+0002c760: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+0002c770: 6374 782c 2061 293b 0a0a 2020 2020 7265  ctx, a);..    re
+0002c780: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+0002c790: 4c5f 4f50 5f52 4d53 5f4e 4f52 4d3b 0a20  L_OP_RMS_NORM;. 
+0002c7a0: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
+0002c7b0: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
+0002c7c0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+0002c7d0: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
+0002c7e0: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+0002c7f0: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
+0002c800: 742d 3e73 7263 3120 3d20 4e55 4c4c 3b20  t->src1 = NULL; 
+0002c810: 2f2f 2054 4f44 4f3a 206d 6179 6265 2073  // TODO: maybe s
+0002c820: 746f 7265 2065 7073 696c 6f6e 2068 6572  tore epsilon her
+0002c830: 653f 0a0a 2020 2020 7265 7475 726e 2072  e?..    return r
+0002c840: 6573 756c 743b 0a7d 0a0a 7374 7275 6374  esult;.}..struct
+0002c850: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+0002c860: 676d 6c5f 726d 735f 6e6f 726d 280a 2020  gml_rms_norm(.  
+0002c870: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002c880: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002c890: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002c8a0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+0002c8b0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0002c8c0: 676d 6c5f 726d 735f 6e6f 726d 5f69 6d70  gml_rms_norm_imp
+0002c8d0: 6c28 6374 782c 2061 2c20 6661 6c73 6529  l(ctx, a, false)
+0002c8e0: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0002c8f0: 5f74 656e 736f 7220 2a20 6767 6d6c 5f72  _tensor * ggml_r
+0002c900: 6d73 5f6e 6f72 6d5f 696e 706c 6163 6528  ms_norm_inplace(
+0002c910: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002c920: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0002c930: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0002c940: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+0002c950: 2a20 6129 207b 0a20 2020 2072 6574 7572  * a) {.    retur
+0002c960: 6e20 6767 6d6c 5f72 6d73 5f6e 6f72 6d5f  n ggml_rms_norm_
+0002c970: 696d 706c 2863 7478 2c20 612c 2074 7275  impl(ctx, a, tru
+0002c980: 6529 3b0a 7d0a 0a73 7472 7563 7420 6767  e);.}..struct gg
+0002c990: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+0002c9a0: 5f72 6d73 5f6e 6f72 6d5f 6261 636b 280a  _rms_norm_back(.
+0002c9b0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0002c9c0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0002c9d0: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0002c9e0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+0002c9f0: 2061 2c0a 2020 2020 2020 2020 7374 7275   a,.        stru
+0002ca00: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+0002ca10: 2a20 6229 207b 0a20 2020 2062 6f6f 6c20  * b) {.    bool 
+0002ca20: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
+0002ca30: 0a0a 2020 2020 6966 2028 612d 3e67 7261  ..    if (a->gra
+0002ca40: 6429 207b 0a20 2020 2020 2020 202f 2f20  d) {.        // 
+0002ca50: 544f 444f 3a20 696d 706c 656d 656e 7420  TODO: implement 
+0002ca60: 6261 636b 7761 7264 0a20 2020 2020 2020  backward.       
+0002ca70: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
+0002ca80: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
+0002ca90: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0002caa0: 2072 6573 756c 7420 3d20 6767 6d6c 5f64   result = ggml_d
+0002cab0: 7570 5f74 656e 736f 7228 6374 782c 2061  up_tensor(ctx, a
+0002cac0: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
+0002cad0: 6f70 2020 203d 2047 474d 4c5f 4f50 5f52  op   = GGML_OP_R
+0002cae0: 4d53 5f4e 4f52 4d5f 4241 434b 3b0a 2020  MS_NORM_BACK;.  
+0002caf0: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
+0002cb00: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
+0002cb10: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+0002cb20: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
+0002cb30: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
+0002cb40: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
+0002cb50: 2d3e 7372 6331 203d 2062 3b0a 0a20 2020  ->src1 = b;..   
+0002cb60: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+0002cb70: 7d0a 0a0a 2f2f 2067 676d 6c5f 6d75 6c5f  }...// ggml_mul_
+0002cb80: 6d61 740a 0a73 7472 7563 7420 6767 6d6c  mat..struct ggml
+0002cb90: 5f74 656e 736f 7220 2a20 6767 6d6c 5f6d  _tensor * ggml_m
+0002cba0: 756c 5f6d 6174 280a 2020 2020 2020 2020  ul_mat(.        
+0002cbb0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+0002cbc0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+0002cbd0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0002cbe0: 656e 736f 7220 202a 2061 2c0a 2020 2020  ensor  * a,.    
+0002cbf0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002cc00: 7465 6e73 6f72 2020 2a20 6229 207b 0a20  tensor  * b) {. 
+0002cc10: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+0002cc20: 676d 6c5f 6361 6e5f 6d75 6c5f 6d61 7428  gml_can_mul_mat(
+0002cc30: 612c 2062 2929 3b0a 2020 2020 4747 4d4c  a, b));.    GGML
+0002cc40: 5f41 5353 4552 5428 2167 676d 6c5f 6973  _ASSERT(!ggml_is
+0002cc50: 5f74 7261 6e73 706f 7365 6428 6129 293b  _transposed(a));
+0002cc60: 0a0a 2020 2020 626f 6f6c 2069 735f 6e6f  ..    bool is_no
+0002cc70: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
+0002cc80: 2069 6620 2861 2d3e 6772 6164 207c 7c20   if (a->grad || 
+0002cc90: 622d 3e67 7261 6429 207b 0a20 2020 2020  b->grad) {.     
+0002cca0: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
+0002ccb0: 653b 0a20 2020 207d 0a0a 2020 2020 636f  e;.    }..    co
+0002ccc0: 6e73 7420 696e 7436 345f 7420 6e65 5b34  nst int64_t ne[4
+0002ccd0: 5d20 3d20 7b20 612d 3e6e 655b 315d 2c20  ] = { a->ne[1], 
+0002cce0: 622d 3e6e 655b 315d 2c20 612d 3e6e 655b  b->ne[1], a->ne[
+0002ccf0: 325d 2c20 622d 3e6e 655b 335d 207d 3b0a  2], b->ne[3] };.
+0002cd00: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002cd10: 7465 6e73 6f72 202a 2072 6573 756c 7420  tensor * result 
+0002cd20: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
+0002cd30: 7228 6374 782c 2047 474d 4c5f 5459 5045  r(ctx, GGML_TYPE
+0002cd40: 5f46 3332 2c20 4d49 4e28 612d 3e6e 5f64  _F32, MIN(a->n_d
+0002cd50: 696d 732c 2062 2d3e 6e5f 6469 6d73 292c  ims, b->n_dims),
+0002cd60: 206e 6529 3b0a 0a20 2020 2072 6573 756c   ne);..    resul
+0002cd70: 742d 3e6f 7020 2020 3d20 4747 4d4c 5f4f  t->op   = GGML_O
+0002cd80: 505f 4d55 4c5f 4d41 543b 0a20 2020 2072  P_MUL_MAT;.    r
+0002cd90: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
+0002cda0: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
+0002cdb0: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
+0002cdc0: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
+0002cdd0: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
+0002cde0: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
+0002cdf0: 7263 3120 3d20 623b 0a0a 2020 2020 7265  rc1 = b;..    re
+0002ce00: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+0002ce10: 2f2f 2067 676d 6c5f 6f75 745f 7072 6f64  // ggml_out_prod
+0002ce20: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+0002ce30: 6e73 6f72 202a 2067 676d 6c5f 6f75 745f  nsor * ggml_out_
+0002ce40: 7072 6f64 280a 2020 2020 2020 2020 7374  prod(.        st
+0002ce50: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+0002ce60: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+0002ce70: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0002ce80: 736f 7220 202a 2061 2c0a 2020 2020 2020  sor  * a,.      
+0002ce90: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0002cea0: 6e73 6f72 2020 2a20 6229 207b 0a20 2020  nsor  * b) {.   
+0002ceb0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+0002cec0: 6c5f 6361 6e5f 6f75 745f 7072 6f64 2861  l_can_out_prod(a
+0002ced0: 2c20 6229 293b 0a20 2020 2047 474d 4c5f  , b));.    GGML_
+0002cee0: 4153 5345 5254 2821 6767 6d6c 5f69 735f  ASSERT(!ggml_is_
+0002cef0: 7472 616e 7370 6f73 6564 2861 2929 3b0a  transposed(a));.
+0002cf00: 0a20 2020 2062 6f6f 6c20 6973 5f6e 6f64  .    bool is_nod
+0002cf10: 6520 3d20 6661 6c73 653b 0a0a 2020 2020  e = false;..    
+0002cf20: 6966 2028 612d 3e67 7261 6420 7c7c 2062  if (a->grad || b
+0002cf30: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0002cf40: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+0002cf50: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
+0002cf60: 7374 2069 6e74 3634 5f74 206e 655b 345d  st int64_t ne[4]
+0002cf70: 203d 207b 2061 2d3e 6e65 5b30 5d2c 2062   = { a->ne[0], b
+0002cf80: 2d3e 6e65 5b30 5d2c 2061 2d3e 6e65 5b32  ->ne[0], a->ne[2
+0002cf90: 5d2c 2062 2d3e 6e65 5b33 5d20 7d3b 0a20  ], b->ne[3] };. 
+0002cfa0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0002cfb0: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
+0002cfc0: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+0002cfd0: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
+0002cfe0: 4633 322c 204d 494e 2861 2d3e 6e5f 6469  F32, MIN(a->n_di
+0002cff0: 6d73 2c20 622d 3e6e 5f64 696d 7329 2c20  ms, b->n_dims), 
+0002d000: 6e65 293b 0a0a 2020 2020 7265 7375 6c74  ne);..    result
+0002d010: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
+0002d020: 5f4f 5554 5f50 524f 443b 0a20 2020 2072  _OUT_PROD;.    r
+0002d030: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
+0002d040: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
+0002d050: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
+0002d060: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
+0002d070: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
+0002d080: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
+0002d090: 7263 3120 3d20 623b 0a0a 2020 2020 7265  rc1 = b;..    re
+0002d0a0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+0002d0b0: 2f2f 2067 676d 6c5f 7363 616c 650a 0a73  // ggml_scale..s
+0002d0c0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002d0d0: 7220 2a20 6767 6d6c 5f73 6361 6c65 5f69  r * ggml_scale_i
+0002d0e0: 6d70 6c28 0a20 2020 2020 2020 2073 7472  mpl(.        str
+0002d0f0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0002d100: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0002d110: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002d120: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
+0002d130: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0002d140: 736f 7220 202a 2062 2c0a 2020 2020 2020  sor  * b,.      
+0002d150: 2020 626f 6f6c 2069 6e70 6c61 6365 2920    bool inplace) 
+0002d160: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
+0002d170: 5428 6767 6d6c 5f69 735f 7363 616c 6172  T(ggml_is_scalar
+0002d180: 2862 2929 3b0a 2020 2020 4747 4d4c 5f41  (b));.    GGML_A
+0002d190: 5353 4552 5428 6767 6d6c 5f69 735f 7061  SSERT(ggml_is_pa
+0002d1a0: 6464 6564 5f31 6428 6129 293b 0a0a 2020  dded_1d(a));..  
+0002d1b0: 2020 626f 6f6c 2069 735f 6e6f 6465 203d    bool is_node =
+0002d1c0: 2066 616c 7365 3b0a 0a20 2020 2069 6620   false;..    if 
+0002d1d0: 2861 2d3e 6772 6164 207c 7c20 622d 3e67  (a->grad || b->g
+0002d1e0: 7261 6429 207b 0a20 2020 2020 2020 2069  rad) {.        i
+0002d1f0: 735f 6e6f 6465 203d 2074 7275 653b 0a20  s_node = true;. 
+0002d200: 2020 207d 0a0a 2020 2020 7374 7275 6374     }..    struct
+0002d210: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
+0002d220: 6573 756c 7420 3d20 696e 706c 6163 6520  esult = inplace 
+0002d230: 3f20 6767 6d6c 5f76 6965 775f 7465 6e73  ? ggml_view_tens
+0002d240: 6f72 2863 7478 2c20 6129 203a 2067 676d  or(ctx, a) : ggm
+0002d250: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
+0002d260: 2c20 6129 3b0a 0a20 2020 2072 6573 756c  , a);..    resul
+0002d270: 742d 3e6f 7020 2020 3d20 4747 4d4c 5f4f  t->op   = GGML_O
+0002d280: 505f 5343 414c 453b 0a20 2020 2072 6573  P_SCALE;.    res
+0002d290: 756c 742d 3e67 7261 6420 3d20 6973 5f6e  ult->grad = is_n
+0002d2a0: 6f64 6520 3f20 6767 6d6c 5f64 7570 5f74  ode ? ggml_dup_t
+0002d2b0: 656e 736f 7228 6374 782c 2072 6573 756c  ensor(ctx, resul
+0002d2c0: 7429 203a 204e 554c 4c3b 0a20 2020 2072  t) : NULL;.    r
+0002d2d0: 6573 756c 742d 3e73 7263 3020 3d20 613b  esult->src0 = a;
+0002d2e0: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+0002d2f0: 3120 3d20 623b 0a0a 2020 2020 7265 7475  1 = b;..    retu
+0002d300: 726e 2072 6573 756c 743b 0a7d 0a0a 7374  rn result;.}..st
+0002d310: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002d320: 202a 2067 676d 6c5f 7363 616c 6528 0a20   * ggml_scale(. 
+0002d330: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0002d340: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+0002d350: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0002d360: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
+0002d370: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0002d380: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
+0002d390: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0002d3a0: 676d 6c5f 7363 616c 655f 696d 706c 2863  gml_scale_impl(c
+0002d3b0: 7478 2c20 612c 2062 2c20 6661 6c73 6529  tx, a, b, false)
+0002d3c0: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0002d3d0: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
+0002d3e0: 6361 6c65 5f69 6e70 6c61 6365 280a 2020  cale_inplace(.  
+0002d3f0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002d400: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002d410: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002d420: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
+0002d430: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002d440: 6767 6d6c 5f74 656e 736f 7220 2a20 6229  ggml_tensor * b)
+0002d450: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
+0002d460: 6d6c 5f73 6361 6c65 5f69 6d70 6c28 6374  ml_scale_impl(ct
+0002d470: 782c 2061 2c20 622c 2074 7275 6529 3b0a  x, a, b, true);.
+0002d480: 7d0a 0a2f 2f20 6767 6d6c 5f73 6574 0a0a  }..// ggml_set..
+0002d490: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002d4a0: 6f72 202a 2067 676d 6c5f 7365 745f 696d  or * ggml_set_im
+0002d4b0: 706c 280a 2020 2020 2020 2020 7374 7275  pl(.        stru
+0002d4c0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0002d4d0: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+0002d4e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002d4f0: 7220 202a 2061 2c0a 2020 2020 2020 2020  r  * a,.        
+0002d500: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002d510: 6f72 2020 2a20 622c 0a20 2020 2020 2020  or  * b,.       
+0002d520: 2073 697a 655f 7420 2020 2020 2020 2020   size_t         
+0002d530: 2020 2020 2020 206e 6231 2c0a 2020 2020         nb1,.    
+0002d540: 2020 2020 7369 7a65 5f74 2020 2020 2020      size_t      
+0002d550: 2020 2020 2020 2020 2020 6e62 322c 0a20            nb2,. 
+0002d560: 2020 2020 2020 2073 697a 655f 7420 2020         size_t   
+0002d570: 2020 2020 2020 2020 2020 2020 206e 6233               nb3
+0002d580: 2c0a 2020 2020 2020 2020 7369 7a65 5f74  ,.        size_t
+0002d590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d5a0: 6f66 6673 6574 2c0a 2020 2020 2020 2020  offset,.        
+0002d5b0: 626f 6f6c 2069 6e70 6c61 6365 2920 7b0a  bool inplace) {.
+0002d5c0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0002d5d0: 6767 6d6c 5f6e 656c 656d 656e 7473 2861  ggml_nelements(a
+0002d5e0: 2920 3e3d 2067 676d 6c5f 6e65 6c65 6d65  ) >= ggml_neleme
+0002d5f0: 6e74 7328 6229 293b 0a0a 2020 2020 626f  nts(b));..    bo
+0002d600: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
+0002d610: 7365 3b0a 0a20 2020 2069 6620 2861 2d3e  se;..    if (a->
+0002d620: 6772 6164 207c 7c20 622d 3e67 7261 6429  grad || b->grad)
+0002d630: 207b 0a20 2020 2020 2020 2069 735f 6e6f   {.        is_no
+0002d640: 6465 203d 2074 7275 653b 0a20 2020 207d  de = true;.    }
+0002d650: 0a0a 2020 2020 2f2f 206d 616b 6520 6120  ..    // make a 
+0002d660: 7669 6577 206f 6620 7468 6520 6465 7374  view of the dest
+0002d670: 696e 6174 696f 6e0a 2020 2020 7374 7275  ination.    stru
+0002d680: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0002d690: 2072 6573 756c 7420 3d20 696e 706c 6163   result = inplac
+0002d6a0: 6520 3f20 6767 6d6c 5f76 6965 775f 7465  e ? ggml_view_te
+0002d6b0: 6e73 6f72 2863 7478 2c20 6129 203a 2067  nsor(ctx, a) : g
+0002d6c0: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
+0002d6d0: 7478 2c20 6129 3b0a 0a20 2020 2067 676d  tx, a);..    ggm
+0002d6e0: 6c5f 7363 7261 7463 685f 7361 7665 2863  l_scratch_save(c
+0002d6f0: 7478 293b 0a0a 2020 2020 7374 7275 6374  tx);..    struct
+0002d700: 2067 676d 6c5f 7465 6e73 6f72 202a 2063   ggml_tensor * c
+0002d710: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+0002d720: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+0002d730: 5459 5045 5f49 3332 2c20 3529 3b0a 0a20  TYPE_I32, 5);.. 
+0002d740: 2020 2028 2820 696e 7433 325f 7420 2a20     (( int32_t * 
+0002d750: 2920 632d 3e64 6174 6129 5b30 5d20 3d20  ) c->data)[0] = 
+0002d760: 6e62 313b 0a20 2020 2028 2820 696e 7433  nb1;.    (( int3
+0002d770: 325f 7420 2a20 2920 632d 3e64 6174 6129  2_t * ) c->data)
+0002d780: 5b31 5d20 3d20 6e62 323b 0a20 2020 2028  [1] = nb2;.    (
+0002d790: 2820 696e 7433 325f 7420 2a20 2920 632d  ( int32_t * ) c-
+0002d7a0: 3e64 6174 6129 5b32 5d20 3d20 6e62 333b  >data)[2] = nb3;
+0002d7b0: 0a20 2020 2028 2820 696e 7433 325f 7420  .    (( int32_t 
+0002d7c0: 2a20 2920 632d 3e64 6174 6129 5b33 5d20  * ) c->data)[3] 
+0002d7d0: 3d20 6f66 6673 6574 3b0a 2020 2020 2828  = offset;.    ((
+0002d7e0: 2069 6e74 3332 5f74 202a 2029 2063 2d3e   int32_t * ) c->
+0002d7f0: 6461 7461 295b 345d 203d 2069 6e70 6c61  data)[4] = inpla
+0002d800: 6365 203f 2031 203a 2030 3b0a 0a20 2020  ce ? 1 : 0;..   
+0002d810: 2067 676d 6c5f 7363 7261 7463 685f 6c6f   ggml_scratch_lo
+0002d820: 6164 2863 7478 293b 0a0a 2020 2020 7265  ad(ctx);..    re
+0002d830: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+0002d840: 4c5f 4f50 5f53 4554 3b0a 2020 2020 7265  L_OP_SET;.    re
+0002d850: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
+0002d860: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
+0002d870: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
+0002d880: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
+0002d890: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
+0002d8a0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+0002d8b0: 6331 203d 2062 3b0a 2020 2020 7265 7375  c1 = b;.    resu
+0002d8c0: 6c74 2d3e 6f70 745b 305d 203d 2063 3b0a  lt->opt[0] = c;.
+0002d8d0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+0002d8e0: 6c74 3b0a 7d0a 0a73 7472 7563 7420 6767  lt;.}..struct gg
+0002d8f0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+0002d900: 5f73 6574 280a 2020 2020 2020 2020 7374  _set(.        st
+0002d910: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+0002d920: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+0002d930: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0002d940: 736f 7220 2a20 2061 2c0a 2020 2020 2020  sor *  a,.      
+0002d950: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0002d960: 6e73 6f72 202a 2020 622c 0a20 2020 2020  nsor *  b,.     
+0002d970: 2020 2073 697a 655f 7420 2020 2020 2020     size_t       
+0002d980: 2020 2020 2020 2020 206e 6231 2c0a 2020           nb1,.  
+0002d990: 2020 2020 2020 7369 7a65 5f74 2020 2020        size_t    
+0002d9a0: 2020 2020 2020 2020 2020 2020 6e62 322c              nb2,
+0002d9b0: 0a20 2020 2020 2020 2073 697a 655f 7420  .        size_t 
+0002d9c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0002d9d0: 6233 2c0a 2020 2020 2020 2020 7369 7a65  b3,.        size
+0002d9e0: 5f74 2020 2020 2020 2020 2020 2020 2020  _t              
+0002d9f0: 2020 6f66 6673 6574 2920 7b0a 2020 2020    offset) {.    
+0002da00: 7265 7475 726e 2067 676d 6c5f 7365 745f  return ggml_set_
+0002da10: 696d 706c 2863 7478 2c20 612c 2062 2c20  impl(ctx, a, b, 
+0002da20: 6e62 312c 206e 6232 2c20 6e62 332c 206f  nb1, nb2, nb3, o
+0002da30: 6666 7365 742c 2066 616c 7365 293b 0a7d  ffset, false);.}
+0002da40: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+0002da50: 6e73 6f72 202a 2067 676d 6c5f 7365 745f  nsor * ggml_set_
+0002da60: 696e 706c 6163 6528 0a20 2020 2020 2020  inplace(.       
+0002da70: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+0002da80: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+0002da90: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002daa0: 7465 6e73 6f72 202a 2020 612c 0a20 2020  tensor *  a,.   
+0002dab0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0002dac0: 5f74 656e 736f 7220 2a20 2062 2c0a 2020  _tensor *  b,.  
+0002dad0: 2020 2020 2020 7369 7a65 5f74 2020 2020        size_t    
+0002dae0: 2020 2020 2020 2020 2020 2020 6e62 312c              nb1,
+0002daf0: 0a20 2020 2020 2020 2073 697a 655f 7420  .        size_t 
+0002db00: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0002db10: 6232 2c0a 2020 2020 2020 2020 7369 7a65  b2,.        size
+0002db20: 5f74 2020 2020 2020 2020 2020 2020 2020  _t              
+0002db30: 2020 6e62 332c 0a20 2020 2020 2020 2073    nb3,.        s
+0002db40: 697a 655f 7420 2020 2020 2020 2020 2020  ize_t           
+0002db50: 2020 2020 206f 6666 7365 7429 207b 0a20       offset) {. 
+0002db60: 2020 2072 6574 7572 6e20 6767 6d6c 5f73     return ggml_s
+0002db70: 6574 5f69 6d70 6c28 6374 782c 2061 2c20  et_impl(ctx, a, 
+0002db80: 622c 206e 6231 2c20 6e62 322c 206e 6233  b, nb1, nb2, nb3
+0002db90: 2c20 6f66 6673 6574 2c20 7472 7565 293b  , offset, true);
+0002dba0: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
+0002dbb0: 7465 6e73 6f72 202a 2067 676d 6c5f 7365  tensor * ggml_se
+0002dbc0: 745f 3164 280a 2020 2020 2020 2020 7374  t_1d(.        st
+0002dbd0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+0002dbe0: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+0002dbf0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0002dc00: 736f 7220 2a20 2061 2c0a 2020 2020 2020  sor *  a,.      
+0002dc10: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0002dc20: 6e73 6f72 202a 2020 622c 0a20 2020 2020  nsor *  b,.     
+0002dc30: 2020 2073 697a 655f 7420 2020 2020 2020     size_t       
+0002dc40: 2020 2020 2020 2020 206f 6666 7365 7429           offset)
+0002dc50: 207b 0a20 2020 2072 6574 7572 6e20 6767   {.    return gg
+0002dc60: 6d6c 5f73 6574 5f69 6d70 6c28 6374 782c  ml_set_impl(ctx,
+0002dc70: 2061 2c20 622c 2061 2d3e 6e62 5b31 5d2c   a, b, a->nb[1],
+0002dc80: 2061 2d3e 6e62 5b32 5d2c 2061 2d3e 6e62   a->nb[2], a->nb
+0002dc90: 5b33 5d2c 206f 6666 7365 742c 2066 616c  [3], offset, fal
+0002dca0: 7365 293b 0a7d 0a0a 7374 7275 6374 2067  se);.}..struct g
+0002dcb0: 676d 6c5f 7465 6e73 6f72 202a 2067 676d  gml_tensor * ggm
+0002dcc0: 6c5f 7365 745f 3164 5f69 6e70 6c61 6365  l_set_1d_inplace
+0002dcd0: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+0002dce0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+0002dcf0: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+0002dd00: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002dd10: 2a20 2061 2c0a 2020 2020 2020 2020 7374  *  a,.        st
+0002dd20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002dd30: 202a 2020 622c 0a20 2020 2020 2020 2073   *  b,.        s
+0002dd40: 697a 655f 7420 2020 2020 2020 2020 2020  ize_t           
+0002dd50: 2020 2020 206f 6666 7365 7429 207b 0a20       offset) {. 
+0002dd60: 2020 2072 6574 7572 6e20 6767 6d6c 5f73     return ggml_s
+0002dd70: 6574 5f69 6d70 6c28 6374 782c 2061 2c20  et_impl(ctx, a, 
+0002dd80: 622c 2061 2d3e 6e62 5b31 5d2c 2061 2d3e  b, a->nb[1], a->
+0002dd90: 6e62 5b32 5d2c 2061 2d3e 6e62 5b33 5d2c  nb[2], a->nb[3],
+0002dda0: 206f 6666 7365 742c 2074 7275 6529 3b0a   offset, true);.
+0002ddb0: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f74  }..struct ggml_t
+0002ddc0: 656e 736f 7220 2a20 6767 6d6c 5f73 6574  ensor * ggml_set
+0002ddd0: 5f32 6428 0a20 2020 2020 2020 2073 7472  _2d(.        str
+0002dde0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0002ddf0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0002de00: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002de10: 6f72 202a 2020 612c 0a20 2020 2020 2020  or *  a,.       
+0002de20: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0002de30: 736f 7220 2a20 2062 2c0a 2020 2020 2020  sor *  b,.      
+0002de40: 2020 7369 7a65 5f74 2020 2020 2020 2020    size_t        
+0002de50: 2020 2020 2020 2020 6e62 312c 0a20 2020          nb1,.   
+0002de60: 2020 2020 2073 697a 655f 7420 2020 2020       size_t     
+0002de70: 2020 2020 2020 2020 2020 206f 6666 7365             offse
+0002de80: 7429 207b 0a20 2020 2072 6574 7572 6e20  t) {.    return 
+0002de90: 6767 6d6c 5f73 6574 5f69 6d70 6c28 6374  ggml_set_impl(ct
+0002dea0: 782c 2061 2c20 622c 206e 6231 2c20 612d  x, a, b, nb1, a-
+0002deb0: 3e6e 625b 325d 2c20 612d 3e6e 625b 335d  >nb[2], a->nb[3]
+0002dec0: 2c20 6f66 6673 6574 2c20 6661 6c73 6529  , offset, false)
+0002ded0: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0002dee0: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
+0002def0: 6574 5f32 645f 696e 706c 6163 6528 0a20  et_2d_inplace(. 
+0002df00: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0002df10: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+0002df20: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0002df30: 2067 676d 6c5f 7465 6e73 6f72 202a 2020   ggml_tensor *  
+0002df40: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
+0002df50: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0002df60: 2062 2c0a 2020 2020 2020 2020 7369 7a65   b,.        size
+0002df70: 5f74 2020 2020 2020 2020 2020 2020 2020  _t              
+0002df80: 2020 6e62 312c 0a20 2020 2020 2020 2073    nb1,.        s
+0002df90: 697a 655f 7420 2020 2020 2020 2020 2020  ize_t           
+0002dfa0: 2020 2020 206f 6666 7365 7429 207b 0a20       offset) {. 
+0002dfb0: 2020 2072 6574 7572 6e20 6767 6d6c 5f73     return ggml_s
+0002dfc0: 6574 5f69 6d70 6c28 6374 782c 2061 2c20  et_impl(ctx, a, 
+0002dfd0: 622c 206e 6231 2c20 612d 3e6e 625b 325d  b, nb1, a->nb[2]
+0002dfe0: 2c20 612d 3e6e 625b 335d 2c20 6f66 6673  , a->nb[3], offs
+0002dff0: 6574 2c20 6661 6c73 6529 3b0a 7d0a 0a0a  et, false);.}...
+0002e000: 2f2f 2067 676d 6c5f 6370 790a 0a73 7472  // ggml_cpy..str
+0002e010: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002e020: 2a20 6767 6d6c 5f63 7079 5f69 6d70 6c28  * ggml_cpy_impl(
+0002e030: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002e040: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+0002e050: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+0002e060: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+0002e070: 2a20 612c 0a20 2020 2020 2020 2073 7472  * a,.        str
+0002e080: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002e090: 202a 2062 2c0a 2020 2020 2020 2020 626f   * b,.        bo
+0002e0a0: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
+0002e0b0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0002e0c0: 6d6c 5f6e 656c 656d 656e 7473 2861 2920  ml_nelements(a) 
+0002e0d0: 3d3d 2067 676d 6c5f 6e65 6c65 6d65 6e74  == ggml_nelement
+0002e0e0: 7328 6229 293b 0a0a 2020 2020 626f 6f6c  s(b));..    bool
+0002e0f0: 2069 735f 6e6f 6465 203d 2066 616c 7365   is_node = false
+0002e100: 3b0a 0a20 2020 2069 6620 2821 696e 706c  ;..    if (!inpl
+0002e110: 6163 6520 2626 2028 612d 3e67 7261 6420  ace && (a->grad 
+0002e120: 7c7c 2062 2d3e 6772 6164 2929 207b 0a20  || b->grad)) {. 
+0002e130: 2020 2020 2020 2069 735f 6e6f 6465 203d         is_node =
+0002e140: 2074 7275 653b 0a20 2020 207d 0a0a 2020   true;.    }..  
+0002e150: 2020 2f2f 206d 616b 6520 6120 7669 6577    // make a view
+0002e160: 206f 6620 7468 6520 6465 7374 696e 6174   of the destinat
+0002e170: 696f 6e0a 2020 2020 7374 7275 6374 2067  ion.    struct g
+0002e180: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+0002e190: 756c 7420 3d20 6767 6d6c 5f76 6965 775f  ult = ggml_view_
+0002e1a0: 7465 6e73 6f72 2863 7478 2c20 6229 3b0a  tensor(ctx, b);.
+0002e1b0: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+0002e1c0: 2020 3d20 4747 4d4c 5f4f 505f 4350 593b    = GGML_OP_CPY;
+0002e1d0: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+0002e1e0: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+0002e1f0: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+0002e200: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+0002e210: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+0002e220: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+0002e230: 756c 742d 3e73 7263 3120 3d20 623b 0a0a  ult->src1 = b;..
+0002e240: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0002e250: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
+0002e260: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+0002e270: 6370 7928 0a20 2020 2020 2020 2073 7472  cpy(.        str
+0002e280: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0002e290: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0002e2a0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002e2b0: 6f72 202a 2061 2c0a 2020 2020 2020 2020  or * a,.        
+0002e2c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002e2d0: 6f72 202a 2062 2920 7b0a 2020 2020 7265  or * b) {.    re
+0002e2e0: 7475 726e 2067 676d 6c5f 6370 795f 696d  turn ggml_cpy_im
+0002e2f0: 706c 2863 7478 2c20 612c 2062 2c20 6661  pl(ctx, a, b, fa
+0002e300: 6c73 6529 3b0a 7d0a 0a73 7472 7563 7420  lse);.}..struct 
+0002e310: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0002e320: 6d6c 5f63 7079 5f69 6e70 6c61 6365 280a  ml_cpy_inplace(.
+0002e330: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0002e340: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+0002e350: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+0002e360: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0002e370: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
+0002e380: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0002e390: 6229 207b 0a20 2020 2072 6574 7572 6e20  b) {.    return 
+0002e3a0: 6767 6d6c 5f63 7079 5f69 6d70 6c28 6374  ggml_cpy_impl(ct
+0002e3b0: 782c 2061 2c20 622c 2074 7275 6529 3b0a  x, a, b, true);.
+0002e3c0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6e 740a  }..// ggml_cont.
+0002e3d0: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0002e3e0: 736f 7220 2a20 6767 6d6c 5f63 6f6e 745f  sor * ggml_cont_
+0002e3f0: 696d 706c 280a 2020 2020 2020 2020 7374  impl(.        st
+0002e400: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+0002e410: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+0002e420: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0002e430: 736f 7220 202a 2061 2c0a 2020 2020 2020  sor  * a,.      
+0002e440: 2020 626f 6f6c 2069 6e70 6c61 6365 2920    bool inplace) 
+0002e450: 7b0a 2020 2020 626f 6f6c 2069 735f 6e6f  {.    bool is_no
+0002e460: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
+0002e470: 2069 6620 2821 696e 706c 6163 6520 2626   if (!inplace &&
+0002e480: 2061 2d3e 6772 6164 2920 7b0a 2020 2020   a->grad) {.    
+0002e490: 2020 2020 6973 5f6e 6f64 6520 3d20 7472      is_node = tr
+0002e4a0: 7565 3b0a 2020 2020 7d0a 0a20 2020 2073  ue;.    }..    s
+0002e4b0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002e4c0: 7220 2a20 7265 7375 6c74 203d 2069 6e70  r * result = inp
+0002e4d0: 6c61 6365 203f 2067 676d 6c5f 7669 6577  lace ? ggml_view
+0002e4e0: 5f74 656e 736f 7228 6374 782c 2061 2920  _tensor(ctx, a) 
+0002e4f0: 3a20 6767 6d6c 5f64 7570 5f74 656e 736f  : ggml_dup_tenso
+0002e500: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
+0002e510: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+0002e520: 474d 4c5f 4f50 5f43 4f4e 543b 0a20 2020  GML_OP_CONT;.   
+0002e530: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
+0002e540: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
+0002e550: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
+0002e560: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
+0002e570: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
+0002e580: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
+0002e590: 3e73 7263 3120 3d20 4e55 4c4c 3b0a 0a20  >src1 = NULL;.. 
+0002e5a0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0002e5b0: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0002e5c0: 5f74 656e 736f 7220 2a20 6767 6d6c 5f63  _tensor * ggml_c
+0002e5d0: 6f6e 7428 0a20 2020 2020 2020 2073 7472  ont(.        str
+0002e5e0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0002e5f0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0002e600: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002e610: 6f72 202a 2061 2920 7b0a 2020 2020 7265  or * a) {.    re
+0002e620: 7475 726e 2067 676d 6c5f 636f 6e74 5f69  turn ggml_cont_i
+0002e630: 6d70 6c28 6374 782c 2061 2c20 6661 6c73  mpl(ctx, a, fals
+0002e640: 6529 3b0a 7d0a 0a73 7472 7563 7420 6767  e);.}..struct gg
+0002e650: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+0002e660: 5f63 6f6e 745f 696e 706c 6163 6528 0a20  _cont_inplace(. 
+0002e670: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0002e680: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+0002e690: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0002e6a0: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
+0002e6b0: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+0002e6c0: 676d 6c5f 636f 6e74 5f69 6d70 6c28 6374  gml_cont_impl(ct
+0002e6d0: 782c 2061 2c20 7472 7565 293b 0a7d 0a0a  x, a, true);.}..
+0002e6e0: 2f2f 2067 676d 6c5f 7265 7368 6170 650a  // ggml_reshape.
+0002e6f0: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+0002e700: 736f 7220 2a20 6767 6d6c 5f72 6573 6861  sor * ggml_resha
+0002e710: 7065 280a 2020 2020 2020 2020 7374 7275  pe(.        stru
+0002e720: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0002e730: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+0002e740: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002e750: 7220 2a20 612c 0a20 2020 2020 2020 2073  r * a,.        s
+0002e760: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002e770: 7220 2a20 6229 207b 0a20 2020 2047 474d  r * b) {.    GGM
+0002e780: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
+0002e790: 5f63 6f6e 7469 6775 6f75 7328 6129 293b  _contiguous(a));
+0002e7a0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0002e7b0: 2867 676d 6c5f 6973 5f63 6f6e 7469 6775  (ggml_is_contigu
+0002e7c0: 6f75 7328 6229 293b 0a20 2020 2047 474d  ous(b));.    GGM
+0002e7d0: 4c5f 4153 5345 5254 2867 676d 6c5f 6e65  L_ASSERT(ggml_ne
+0002e7e0: 6c65 6d65 6e74 7328 6129 203d 3d20 6767  lements(a) == gg
+0002e7f0: 6d6c 5f6e 656c 656d 656e 7473 2862 2929  ml_nelements(b))
+0002e800: 3b0a 0a20 2020 2062 6f6f 6c20 6973 5f6e  ;..    bool is_n
+0002e810: 6f64 6520 3d20 6661 6c73 653b 0a0a 2020  ode = false;..  
+0002e820: 2020 6966 2028 612d 3e67 7261 6429 207b    if (a->grad) {
+0002e830: 0a20 2020 2020 2020 2069 735f 6e6f 6465  .        is_node
+0002e840: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
+0002e850: 2020 2020 6966 2028 622d 3e67 7261 6429      if (b->grad)
+0002e860: 207b 0a20 2020 2020 2020 202f 2f20 6772   {.        // gr
+0002e870: 6164 6965 6e74 2070 726f 7061 6761 7469  adient propagati
+0002e880: 6f6e 2069 7320 6e6f 7420 7375 7070 6f72  on is not suppor
+0002e890: 7465 640a 2020 2020 2020 2020 2f2f 4747  ted.        //GG
+0002e8a0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+0002e8b0: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+0002e8c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002e8d0: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+0002e8e0: 6e65 775f 7465 6e73 6f72 5f69 6d70 6c28  new_tensor_impl(
+0002e8f0: 6374 782c 2061 2d3e 7479 7065 2c20 622d  ctx, a->type, b-
+0002e900: 3e6e 5f64 696d 732c 2062 2d3e 6e65 2c20  >n_dims, b->ne, 
+0002e910: 612d 3e64 6174 6129 3b0a 0a20 2020 2072  a->data);..    r
+0002e920: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
+0002e930: 4d4c 5f4f 505f 5245 5348 4150 453b 0a20  ML_OP_RESHAPE;. 
+0002e940: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
+0002e950: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
+0002e960: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+0002e970: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
+0002e980: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+0002e990: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
+0002e9a0: 742d 3e73 7263 3120 3d20 4e55 4c4c 3b0a  t->src1 = NULL;.
+0002e9b0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+0002e9c0: 6c74 3b0a 7d0a 0a73 7472 7563 7420 6767  lt;.}..struct gg
+0002e9d0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+0002e9e0: 5f72 6573 6861 7065 5f31 6428 0a20 2020  _reshape_1d(.   
+0002e9f0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0002ea00: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+0002ea10: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0002ea20: 676d 6c5f 7465 6e73 6f72 2020 2a20 612c  gml_tensor  * a,
+0002ea30: 0a20 2020 2020 2020 2069 6e74 3634 5f74  .        int64_t
+0002ea40: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0002ea50: 6530 2920 7b0a 2020 2020 4747 4d4c 5f41  e0) {.    GGML_A
+0002ea60: 5353 4552 5428 6767 6d6c 5f69 735f 636f  SSERT(ggml_is_co
+0002ea70: 6e74 6967 756f 7573 2861 2929 3b0a 2020  ntiguous(a));.  
+0002ea80: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0002ea90: 6d6c 5f6e 656c 656d 656e 7473 2861 2920  ml_nelements(a) 
+0002eaa0: 3d3d 206e 6530 293b 0a0a 2020 2020 626f  == ne0);..    bo
+0002eab0: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
+0002eac0: 7365 3b0a 0a20 2020 2069 6620 2861 2d3e  se;..    if (a->
+0002ead0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+0002eae0: 6973 5f6e 6f64 6520 3d20 7472 7565 3b0a  is_node = true;.
+0002eaf0: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
+0002eb00: 2069 6e74 3634 5f74 206e 655b 315d 203d   int64_t ne[1] =
+0002eb10: 207b 206e 6530 207d 3b0a 2020 2020 7374   { ne0 };.    st
+0002eb20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002eb30: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
+0002eb40: 5f6e 6577 5f74 656e 736f 725f 696d 706c  _new_tensor_impl
+0002eb50: 2863 7478 2c20 612d 3e74 7970 652c 2031  (ctx, a->type, 1
+0002eb60: 2c20 6e65 2c20 612d 3e64 6174 6129 3b0a  , ne, a->data);.
+0002eb70: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+0002eb80: 2020 3d20 4747 4d4c 5f4f 505f 5245 5348    = GGML_OP_RESH
+0002eb90: 4150 453b 0a20 2020 2072 6573 756c 742d  APE;.    result-
+0002eba0: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
+0002ebb0: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
+0002ebc0: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
+0002ebd0: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
+0002ebe0: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
+0002ebf0: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
+0002ec00: 4e55 4c4c 3b0a 0a20 2020 2072 6574 7572  NULL;..    retur
+0002ec10: 6e20 7265 7375 6c74 3b0a 7d0a 0a73 7472  n result;.}..str
+0002ec20: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002ec30: 2a20 6767 6d6c 5f72 6573 6861 7065 5f32  * ggml_reshape_2
+0002ec40: 6428 0a20 2020 2020 2020 2073 7472 7563  d(.        struc
+0002ec50: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+0002ec60: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+0002ec70: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002ec80: 2020 2a20 612c 0a20 2020 2020 2020 2069    * a,.        i
+0002ec90: 6e74 3634 5f74 2020 2020 2020 2020 2020  nt64_t          
+0002eca0: 2020 2020 206e 6530 2c0a 2020 2020 2020       ne0,.      
+0002ecb0: 2020 696e 7436 345f 7420 2020 2020 2020    int64_t       
+0002ecc0: 2020 2020 2020 2020 6e65 3129 207b 0a20          ne1) {. 
+0002ecd0: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+0002ece0: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
+0002ecf0: 7328 6129 293b 0a20 2020 2047 474d 4c5f  s(a));.    GGML_
+0002ed00: 4153 5345 5254 2867 676d 6c5f 6e65 6c65  ASSERT(ggml_nele
+0002ed10: 6d65 6e74 7328 6129 203d 3d20 6e65 302a  ments(a) == ne0*
+0002ed20: 6e65 3129 3b0a 0a20 2020 2062 6f6f 6c20  ne1);..    bool 
+0002ed30: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
+0002ed40: 0a0a 2020 2020 6966 2028 612d 3e67 7261  ..    if (a->gra
+0002ed50: 6429 207b 0a20 2020 2020 2020 2069 735f  d) {.        is_
+0002ed60: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+0002ed70: 207d 0a0a 2020 2020 636f 6e73 7420 696e   }..    const in
+0002ed80: 7436 345f 7420 6e65 5b32 5d20 3d20 7b20  t64_t ne[2] = { 
+0002ed90: 6e65 302c 206e 6531 207d 3b0a 2020 2020  ne0, ne1 };.    
+0002eda0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002edb0: 6f72 202a 2072 6573 756c 7420 3d20 6767  or * result = gg
+0002edc0: 6d6c 5f6e 6577 5f74 656e 736f 725f 696d  ml_new_tensor_im
+0002edd0: 706c 2863 7478 2c20 612d 3e74 7970 652c  pl(ctx, a->type,
+0002ede0: 2032 2c20 6e65 2c20 612d 3e64 6174 6129   2, ne, a->data)
+0002edf0: 3b0a 0a20 2020 2072 6573 756c 742d 3e6f  ;..    result->o
+0002ee00: 7020 2020 3d20 4747 4d4c 5f4f 505f 5245  p   = GGML_OP_RE
+0002ee10: 5348 4150 453b 0a20 2020 2072 6573 756c  SHAPE;.    resul
+0002ee20: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
+0002ee30: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
+0002ee40: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
+0002ee50: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
+0002ee60: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
+0002ee70: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
+0002ee80: 3d20 4e55 4c4c 3b0a 0a20 2020 2072 6574  = NULL;..    ret
+0002ee90: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a73  urn result;.}..s
+0002eea0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002eeb0: 7220 2a20 6767 6d6c 5f72 6573 6861 7065  r * ggml_reshape
+0002eec0: 5f33 6428 0a20 2020 2020 2020 2073 7472  _3d(.        str
+0002eed0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0002eee0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0002eef0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002ef00: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
+0002ef10: 2069 6e74 3634 5f74 2020 2020 2020 2020   int64_t        
+0002ef20: 2020 2020 2020 206e 6530 2c0a 2020 2020         ne0,.    
+0002ef30: 2020 2020 696e 7436 345f 7420 2020 2020      int64_t     
+0002ef40: 2020 2020 2020 2020 2020 6e65 312c 0a20            ne1,. 
+0002ef50: 2020 2020 2020 2069 6e74 3634 5f74 2020         int64_t  
+0002ef60: 2020 2020 2020 2020 2020 2020 206e 6532               ne2
+0002ef70: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+0002ef80: 4552 5428 6767 6d6c 5f69 735f 636f 6e74  ERT(ggml_is_cont
+0002ef90: 6967 756f 7573 2861 2929 3b0a 2020 2020  iguous(a));.    
+0002efa0: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
+0002efb0: 5f6e 656c 656d 656e 7473 2861 2920 3d3d  _nelements(a) ==
+0002efc0: 206e 6530 2a6e 6531 2a6e 6532 293b 0a0a   ne0*ne1*ne2);..
+0002efd0: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
+0002efe0: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
+0002eff0: 6620 2861 2d3e 6772 6164 2920 7b0a 2020  f (a->grad) {.  
+0002f000: 2020 2020 2020 6973 5f6e 6f64 6520 3d20        is_node = 
+0002f010: 7472 7565 3b0a 2020 2020 7d0a 0a20 2020  true;.    }..   
+0002f020: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0002f030: 655b 335d 203d 207b 206e 6530 2c20 6e65  e[3] = { ne0, ne
+0002f040: 312c 206e 6532 207d 3b0a 2020 2020 7374  1, ne2 };.    st
+0002f050: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002f060: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
+0002f070: 5f6e 6577 5f74 656e 736f 725f 696d 706c  _new_tensor_impl
+0002f080: 2863 7478 2c20 612d 3e74 7970 652c 2033  (ctx, a->type, 3
+0002f090: 2c20 6e65 2c20 612d 3e64 6174 6129 3b0a  , ne, a->data);.
+0002f0a0: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+0002f0b0: 2020 3d20 4747 4d4c 5f4f 505f 5245 5348    = GGML_OP_RESH
+0002f0c0: 4150 453b 0a20 2020 2072 6573 756c 742d  APE;.    result-
+0002f0d0: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
+0002f0e0: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
+0002f0f0: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
+0002f100: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
+0002f110: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
+0002f120: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
+0002f130: 4e55 4c4c 3b0a 0a20 2020 2072 6574 7572  NULL;..    retur
+0002f140: 6e20 7265 7375 6c74 3b0a 7d0a 0a0a 7374  n result;.}...st
+0002f150: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002f160: 202a 2067 676d 6c5f 7265 7368 6170 655f   * ggml_reshape_
+0002f170: 3464 280a 2020 2020 2020 2020 7374 7275  4d(.        stru
+0002f180: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0002f190: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+0002f1a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0002f1b0: 7220 202a 2061 2c0a 2020 2020 2020 2020  r  * a,.        
+0002f1c0: 696e 7436 345f 7420 2020 2020 2020 2020  int64_t         
+0002f1d0: 2020 2020 2020 6e65 302c 0a20 2020 2020        ne0,.     
+0002f1e0: 2020 2069 6e74 3634 5f74 2020 2020 2020     int64_t      
+0002f1f0: 2020 2020 2020 2020 206e 6531 2c0a 2020           ne1,.  
+0002f200: 2020 2020 2020 696e 7436 345f 7420 2020        int64_t   
+0002f210: 2020 2020 2020 2020 2020 2020 6e65 322c              ne2,
+0002f220: 0a20 2020 2020 2020 2069 6e74 3634 5f74  .        int64_t
+0002f230: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0002f240: 6533 2920 7b0a 2020 2020 4747 4d4c 5f41  e3) {.    GGML_A
+0002f250: 5353 4552 5428 6767 6d6c 5f69 735f 636f  SSERT(ggml_is_co
+0002f260: 6e74 6967 756f 7573 2861 2929 3b0a 2020  ntiguous(a));.  
+0002f270: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0002f280: 6d6c 5f6e 656c 656d 656e 7473 2861 2920  ml_nelements(a) 
+0002f290: 3d3d 206e 6530 2a6e 6531 2a6e 6532 2a6e  == ne0*ne1*ne2*n
+0002f2a0: 6533 293b 0a0a 2020 2020 626f 6f6c 2069  e3);..    bool i
+0002f2b0: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
+0002f2c0: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
+0002f2d0: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
+0002f2e0: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
+0002f2f0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
+0002f300: 3634 5f74 206e 655b 345d 203d 207b 206e  64_t ne[4] = { n
+0002f310: 6530 2c20 6e65 312c 206e 6532 2c20 6e65  e0, ne1, ne2, ne
+0002f320: 3320 7d3b 0a20 2020 2073 7472 7563 7420  3 };.    struct 
+0002f330: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
+0002f340: 7375 6c74 203d 2067 676d 6c5f 6e65 775f  sult = ggml_new_
+0002f350: 7465 6e73 6f72 5f69 6d70 6c28 6374 782c  tensor_impl(ctx,
+0002f360: 2061 2d3e 7479 7065 2c20 342c 206e 652c   a->type, 4, ne,
+0002f370: 2061 2d3e 6461 7461 293b 0a0a 2020 2020   a->data);..    
+0002f380: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+0002f390: 474d 4c5f 4f50 5f52 4553 4841 5045 3b0a  GML_OP_RESHAPE;.
+0002f3a0: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
+0002f3b0: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
+0002f3c0: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
+0002f3d0: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
+0002f3e0: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+0002f3f0: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
+0002f400: 6c74 2d3e 7372 6331 203d 204e 554c 4c3b  lt->src1 = NULL;
+0002f410: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
+0002f420: 756c 743b 0a7d 0a0a 2f2f 2067 676d 6c5f  ult;.}..// ggml_
+0002f430: 7669 6577 5f31 640a 0a73 7472 7563 7420  view_1d..struct 
+0002f440: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0002f450: 6d6c 5f76 6965 775f 3164 280a 2020 2020  ml_view_1d(.    
+0002f460: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0002f470: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+0002f480: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0002f490: 6d6c 5f74 656e 736f 7220 202a 2061 2c0a  ml_tensor  * a,.
+0002f4a0: 2020 2020 2020 2020 696e 7436 345f 7420          int64_t 
+0002f4b0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+0002f4c0: 302c 0a20 2020 2020 2020 2073 697a 655f  0,.        size_
+0002f4d0: 7420 2020 2020 2020 2020 2020 2020 2020  t               
+0002f4e0: 206f 6666 7365 7429 207b 0a0a 2020 2020   offset) {..    
+0002f4f0: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
+0002f500: 616c 7365 3b0a 0a20 2020 2069 6620 2861  alse;..    if (a
+0002f510: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0002f520: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+0002f530: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+0002f540: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002f550: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+0002f560: 6e65 775f 7465 6e73 6f72 5f69 6d70 6c28  new_tensor_impl(
+0002f570: 6374 782c 2061 2d3e 7479 7065 2c20 312c  ctx, a->type, 1,
+0002f580: 2026 6e65 302c 2028 6368 6172 202a 2920   &ne0, (char *) 
+0002f590: 612d 3e64 6174 6120 2b20 6f66 6673 6574  a->data + offset
+0002f5a0: 293b 0a0a 2020 2020 6767 6d6c 5f73 6372  );..    ggml_scr
+0002f5b0: 6174 6368 5f73 6176 6528 6374 7829 3b0a  atch_save(ctx);.
+0002f5c0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+0002f5d0: 5f74 656e 736f 7220 2a20 6f66 6673 203d  _tensor * offs =
+0002f5e0: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+0002f5f0: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
+0002f600: 5045 5f49 3332 2c20 3229 3b0a 2020 2020  PE_I32, 2);.    
+0002f610: 6d65 6d63 7079 286f 6666 732d 3e64 6174  memcpy(offs->dat
+0002f620: 612c 2026 6f66 6673 6574 2c20 322a 7369  a, &offset, 2*si
+0002f630: 7a65 6f66 2869 6e74 3332 5f74 2929 3b0a  zeof(int32_t));.
+0002f640: 0a20 2020 2067 676d 6c5f 7363 7261 7463  .    ggml_scratc
+0002f650: 685f 6c6f 6164 2863 7478 293b 0a0a 2020  h_load(ctx);..  
+0002f660: 2020 7265 7375 6c74 2d3e 6f70 2020 203d    result->op   =
+0002f670: 2047 474d 4c5f 4f50 5f56 4945 573b 0a20   GGML_OP_VIEW;. 
+0002f680: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
+0002f690: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
+0002f6a0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+0002f6b0: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
+0002f6c0: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+0002f6d0: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
+0002f6e0: 742d 3e73 7263 3120 3d20 4e55 4c4c 3b0a  t->src1 = NULL;.
+0002f6f0: 2020 2020 7265 7375 6c74 2d3e 6f70 745b      result->opt[
+0002f700: 305d 203d 206f 6666 733b 0a0a 2020 2020  0] = offs;..    
+0002f710: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+0002f720: 0a0a 2f2f 2067 676d 6c5f 7669 6577 5f32  ..// ggml_view_2
+0002f730: 640a 0a73 7472 7563 7420 6767 6d6c 5f74  d..struct ggml_t
+0002f740: 656e 736f 7220 2a20 6767 6d6c 5f76 6965  ensor * ggml_vie
+0002f750: 775f 3264 280a 2020 2020 2020 2020 7374  w_2d(.        st
+0002f760: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+0002f770: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
+0002f780: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0002f790: 736f 7220 202a 2061 2c0a 2020 2020 2020  sor  * a,.      
+0002f7a0: 2020 696e 7436 345f 7420 2020 2020 2020    int64_t       
+0002f7b0: 2020 2020 2020 2020 6e65 302c 0a20 2020          ne0,.   
+0002f7c0: 2020 2020 2069 6e74 3634 5f74 2020 2020       int64_t    
+0002f7d0: 2020 2020 2020 2020 2020 206e 6531 2c0a             ne1,.
+0002f7e0: 2020 2020 2020 2020 7369 7a65 5f74 2020          size_t  
+0002f7f0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+0002f800: 312c 0a20 2020 2020 2020 2073 697a 655f  1,.        size_
+0002f810: 7420 2020 2020 2020 2020 2020 2020 2020  t               
+0002f820: 206f 6666 7365 7429 207b 0a0a 2020 2020   offset) {..    
+0002f830: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
+0002f840: 616c 7365 3b0a 0a20 2020 2069 6620 2861  alse;..    if (a
+0002f850: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0002f860: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+0002f870: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
+0002f880: 7374 2069 6e74 3634 5f74 206e 655b 4747  st int64_t ne[GG
+0002f890: 4d4c 5f4d 4158 5f44 494d 535d 203d 207b  ML_MAX_DIMS] = {
+0002f8a0: 206e 6530 2c20 6e65 312c 2031 2c20 3120   ne0, ne1, 1, 1 
+0002f8b0: 7d3b 0a0a 2020 2020 7374 7275 6374 2067  };..    struct g
+0002f8c0: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+0002f8d0: 756c 7420 3d20 6767 6d6c 5f6e 6577 5f74  ult = ggml_new_t
+0002f8e0: 656e 736f 725f 696d 706c 2863 7478 2c20  ensor_impl(ctx, 
+0002f8f0: 612d 3e74 7970 652c 2032 2c20 6e65 2c20  a->type, 2, ne, 
+0002f900: 2863 6861 7220 2a29 2061 2d3e 6461 7461  (char *) a->data
+0002f910: 202b 206f 6666 7365 7429 3b0a 0a20 2020   + offset);..   
+0002f920: 2067 676d 6c5f 7363 7261 7463 685f 7361   ggml_scratch_sa
+0002f930: 7665 2863 7478 293b 0a0a 2020 2020 7374  ve(ctx);..    st
+0002f940: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002f950: 202a 206f 6666 7320 3d20 6767 6d6c 5f6e   * offs = ggml_n
+0002f960: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
+0002f970: 2c20 4747 4d4c 5f54 5950 455f 4933 322c  , GGML_TYPE_I32,
+0002f980: 2032 293b 0a20 2020 206d 656d 6370 7928   2);.    memcpy(
+0002f990: 6f66 6673 2d3e 6461 7461 2c20 266f 6666  offs->data, &off
+0002f9a0: 7365 742c 2032 2a73 697a 656f 6628 696e  set, 2*sizeof(in
+0002f9b0: 7433 325f 7429 293b 0a0a 2020 2020 6767  t32_t));..    gg
+0002f9c0: 6d6c 5f73 6372 6174 6368 5f6c 6f61 6428  ml_scratch_load(
+0002f9d0: 6374 7829 3b0a 0a20 2020 2072 6573 756c  ctx);..    resul
+0002f9e0: 742d 3e6e 625b 315d 203d 206e 6231 3b0a  t->nb[1] = nb1;.
+0002f9f0: 2020 2020 7265 7375 6c74 2d3e 6e62 5b32      result->nb[2
+0002fa00: 5d20 3d20 7265 7375 6c74 2d3e 6e62 5b31  ] = result->nb[1
+0002fa10: 5d2a 6e65 313b 0a20 2020 2072 6573 756c  ]*ne1;.    resul
+0002fa20: 742d 3e6e 625b 335d 203d 2072 6573 756c  t->nb[3] = resul
+0002fa30: 742d 3e6e 625b 325d 3b0a 0a20 2020 2072  t->nb[2];..    r
+0002fa40: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
+0002fa50: 4d4c 5f4f 505f 5649 4557 3b0a 2020 2020  ML_OP_VIEW;.    
+0002fa60: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
+0002fa70: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
+0002fa80: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
+0002fa90: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
+0002faa0: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
+0002fab0: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
+0002fac0: 7372 6331 203d 204e 554c 4c3b 0a20 2020  src1 = NULL;.   
+0002fad0: 2072 6573 756c 742d 3e6f 7074 5b30 5d20   result->opt[0] 
+0002fae0: 3d20 6f66 6673 3b0a 0a20 2020 2072 6574  = offs;..    ret
+0002faf0: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
+0002fb00: 2f20 6767 6d6c 5f76 6965 775f 3364 0a0a  / ggml_view_3d..
+0002fb10: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0002fb20: 6f72 202a 2067 676d 6c5f 7669 6577 5f33  or * ggml_view_3
+0002fb30: 6428 0a20 2020 2020 2020 2073 7472 7563  d(.        struc
+0002fb40: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+0002fb50: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+0002fb60: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0002fb70: 2020 2a20 612c 0a20 2020 2020 2020 2069    * a,.        i
+0002fb80: 6e74 3634 5f74 2020 2020 2020 2020 2020  nt64_t          
+0002fb90: 2020 2020 206e 6530 2c0a 2020 2020 2020       ne0,.      
+0002fba0: 2020 696e 7436 345f 7420 2020 2020 2020    int64_t       
+0002fbb0: 2020 2020 2020 2020 6e65 312c 0a20 2020          ne1,.   
+0002fbc0: 2020 2020 2069 6e74 3634 5f74 2020 2020       int64_t    
+0002fbd0: 2020 2020 2020 2020 2020 206e 6532 2c0a             ne2,.
+0002fbe0: 2020 2020 2020 2020 7369 7a65 5f74 2020          size_t  
+0002fbf0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+0002fc00: 312c 0a20 2020 2020 2020 2073 697a 655f  1,.        size_
+0002fc10: 7420 2020 2020 2020 2020 2020 2020 2020  t               
+0002fc20: 206e 6232 2c0a 2020 2020 2020 2020 7369   nb2,.        si
+0002fc30: 7a65 5f74 2020 2020 2020 2020 2020 2020  ze_t            
+0002fc40: 2020 2020 6f66 6673 6574 2920 7b0a 0a20      offset) {.. 
+0002fc50: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
+0002fc60: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
+0002fc70: 2028 612d 3e67 7261 6429 207b 0a20 2020   (a->grad) {.   
+0002fc80: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
+0002fc90: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
+0002fca0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0002fcb0: 5b47 474d 4c5f 4d41 585f 4449 4d53 5d20  [GGML_MAX_DIMS] 
+0002fcc0: 3d20 7b20 6e65 302c 206e 6531 2c20 6e65  = { ne0, ne1, ne
+0002fcd0: 322c 2031 207d 3b0a 0a20 2020 2073 7472  2, 1 };..    str
+0002fce0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0002fcf0: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+0002fd00: 6e65 775f 7465 6e73 6f72 5f69 6d70 6c28  new_tensor_impl(
+0002fd10: 6374 782c 2061 2d3e 7479 7065 2c20 332c  ctx, a->type, 3,
+0002fd20: 206e 652c 2028 6368 6172 202a 2920 612d   ne, (char *) a-
+0002fd30: 3e64 6174 6120 2b20 6f66 6673 6574 293b  >data + offset);
+0002fd40: 0a0a 2020 2020 6767 6d6c 5f73 6372 6174  ..    ggml_scrat
+0002fd50: 6368 5f73 6176 6528 6374 7829 3b0a 0a20  ch_save(ctx);.. 
+0002fd60: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0002fd70: 656e 736f 7220 2a20 6f66 6673 203d 2067  ensor * offs = g
+0002fd80: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
+0002fd90: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
+0002fda0: 5f49 3332 2c20 3229 3b0a 2020 2020 6d65  _I32, 2);.    me
+0002fdb0: 6d63 7079 286f 6666 732d 3e64 6174 612c  mcpy(offs->data,
+0002fdc0: 2026 6f66 6673 6574 2c20 322a 7369 7a65   &offset, 2*size
+0002fdd0: 6f66 2869 6e74 3332 5f74 2929 3b0a 0a20  of(int32_t));.. 
+0002fde0: 2020 2067 676d 6c5f 7363 7261 7463 685f     ggml_scratch_
+0002fdf0: 6c6f 6164 2863 7478 293b 0a0a 2020 2020  load(ctx);..    
+0002fe00: 7265 7375 6c74 2d3e 6e62 5b31 5d20 3d20  result->nb[1] = 
+0002fe10: 6e62 313b 0a20 2020 2072 6573 756c 742d  nb1;.    result-
+0002fe20: 3e6e 625b 325d 203d 206e 6232 3b0a 2020  >nb[2] = nb2;.  
+0002fe30: 2020 7265 7375 6c74 2d3e 6e62 5b33 5d20    result->nb[3] 
+0002fe40: 3d20 7265 7375 6c74 2d3e 6e62 5b32 5d2a  = result->nb[2]*
+0002fe50: 6e65 323b 0a0a 2020 2020 7265 7375 6c74  ne2;..    result
+0002fe60: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
+0002fe70: 5f56 4945 573b 0a20 2020 2072 6573 756c  _VIEW;.    resul
+0002fe80: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
+0002fe90: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
+0002fea0: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
+0002feb0: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
+0002fec0: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
+0002fed0: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
+0002fee0: 3d20 4e55 4c4c 3b0a 2020 2020 7265 7375  = NULL;.    resu
+0002fef0: 6c74 2d3e 6f70 745b 305d 203d 206f 6666  lt->opt[0] = off
+0002ff00: 733b 0a0a 2020 2020 7265 7475 726e 2072  s;..    return r
+0002ff10: 6573 756c 743b 0a7d 0a0a 2f2f 2067 676d  esult;.}..// ggm
+0002ff20: 6c5f 7669 6577 5f34 640a 0a73 7472 7563  l_view_4d..struc
+0002ff30: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0002ff40: 6767 6d6c 5f76 6965 775f 3464 280a 2020  ggml_view_4d(.  
+0002ff50: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0002ff60: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0002ff70: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0002ff80: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+0002ff90: 2c0a 2020 2020 2020 2020 696e 7436 345f  ,.        int64_
+0002ffa0: 7420 2020 2020 2020 2020 2020 2020 2020  t               
+0002ffb0: 6e65 302c 0a20 2020 2020 2020 2069 6e74  ne0,.        int
+0002ffc0: 3634 5f74 2020 2020 2020 2020 2020 2020  64_t            
+0002ffd0: 2020 206e 6531 2c0a 2020 2020 2020 2020     ne1,.        
+0002ffe0: 696e 7436 345f 7420 2020 2020 2020 2020  int64_t         
+0002fff0: 2020 2020 2020 6e65 322c 0a20 2020 2020        ne2,.     
+00030000: 2020 2069 6e74 3634 5f74 2020 2020 2020     int64_t      
+00030010: 2020 2020 2020 2020 206e 6533 2c0a 2020           ne3,.  
+00030020: 2020 2020 2020 7369 7a65 5f74 2020 2020        size_t    
+00030030: 2020 2020 2020 2020 2020 2020 6e62 312c              nb1,
+00030040: 0a20 2020 2020 2020 2073 697a 655f 7420  .        size_t 
+00030050: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00030060: 6232 2c0a 2020 2020 2020 2020 7369 7a65  b2,.        size
+00030070: 5f74 2020 2020 2020 2020 2020 2020 2020  _t              
+00030080: 2020 6e62 332c 0a20 2020 2020 2020 2073    nb3,.        s
+00030090: 697a 655f 7420 2020 2020 2020 2020 2020  ize_t           
+000300a0: 2020 2020 206f 6666 7365 7429 207b 0a0a       offset) {..
+000300b0: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
+000300c0: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
+000300d0: 6620 2861 2d3e 6772 6164 2920 7b0a 2020  f (a->grad) {.  
+000300e0: 2020 2020 2020 6973 5f6e 6f64 6520 3d20        is_node = 
+000300f0: 7472 7565 3b0a 2020 2020 7d0a 0a20 2020  true;.    }..   
+00030100: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00030110: 655b 4747 4d4c 5f4d 4158 5f44 494d 535d  e[GGML_MAX_DIMS]
+00030120: 203d 207b 206e 6530 2c20 6e65 312c 206e   = { ne0, ne1, n
+00030130: 6532 2c20 6e65 3320 7d3b 0a0a 2020 2020  e2, ne3 };..    
+00030140: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00030150: 6f72 202a 2072 6573 756c 7420 3d20 6767  or * result = gg
+00030160: 6d6c 5f6e 6577 5f74 656e 736f 725f 696d  ml_new_tensor_im
+00030170: 706c 2863 7478 2c20 612d 3e74 7970 652c  pl(ctx, a->type,
+00030180: 2034 2c20 6e65 2c20 2863 6861 7220 2a29   4, ne, (char *)
+00030190: 2061 2d3e 6461 7461 202b 206f 6666 7365   a->data + offse
+000301a0: 7429 3b0a 0a20 2020 2067 676d 6c5f 7363  t);..    ggml_sc
+000301b0: 7261 7463 685f 7361 7665 2863 7478 293b  ratch_save(ctx);
+000301c0: 0a0a 2020 2020 7374 7275 6374 2067 676d  ..    struct ggm
+000301d0: 6c5f 7465 6e73 6f72 202a 206f 6666 7320  l_tensor * offs 
+000301e0: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
+000301f0: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
+00030200: 5950 455f 4933 322c 2032 293b 0a20 2020  YPE_I32, 2);.   
+00030210: 206d 656d 6370 7928 6f66 6673 2d3e 6461   memcpy(offs->da
+00030220: 7461 2c20 266f 6666 7365 742c 2032 2a73  ta, &offset, 2*s
+00030230: 697a 656f 6628 696e 7433 325f 7429 293b  izeof(int32_t));
+00030240: 0a0a 2020 2020 6767 6d6c 5f73 6372 6174  ..    ggml_scrat
+00030250: 6368 5f6c 6f61 6428 6374 7829 3b0a 0a20  ch_load(ctx);.. 
+00030260: 2020 2072 6573 756c 742d 3e6e 625b 315d     result->nb[1]
+00030270: 203d 206e 6231 3b0a 2020 2020 7265 7375   = nb1;.    resu
+00030280: 6c74 2d3e 6e62 5b32 5d20 3d20 6e62 323b  lt->nb[2] = nb2;
+00030290: 0a20 2020 2072 6573 756c 742d 3e6e 625b  .    result->nb[
+000302a0: 335d 203d 206e 6233 3b0a 0a20 2020 2072  3] = nb3;..    r
+000302b0: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
+000302c0: 4d4c 5f4f 505f 5649 4557 3b0a 2020 2020  ML_OP_VIEW;.    
+000302d0: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
+000302e0: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
+000302f0: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
+00030300: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
+00030310: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
+00030320: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
+00030330: 7372 6331 203d 204e 554c 4c3b 0a20 2020  src1 = NULL;.   
+00030340: 2072 6573 756c 742d 3e6f 7074 5b30 5d20   result->opt[0] 
+00030350: 3d20 6f66 6673 3b0a 0a20 2020 2072 6574  = offs;..    ret
+00030360: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
+00030370: 2f20 6767 6d6c 5f70 6572 6d75 7465 0a0a  / ggml_permute..
+00030380: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00030390: 6f72 202a 2067 676d 6c5f 7065 726d 7574  or * ggml_permut
+000303a0: 6528 0a20 2020 2020 2020 2073 7472 7563  e(.        struc
+000303b0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+000303c0: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+000303d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000303e0: 2020 2a20 612c 0a20 2020 2020 2020 2069    * a,.        i
+000303f0: 6e74 2020 2020 2020 2020 2020 2020 2020  nt              
+00030400: 2020 2020 2061 7869 7330 2c0a 2020 2020       axis0,.    
+00030410: 2020 2020 696e 7420 2020 2020 2020 2020      int         
+00030420: 2020 2020 2020 2020 2020 6178 6973 312c            axis1,
+00030430: 0a20 2020 2020 2020 2069 6e74 2020 2020  .        int    
+00030440: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00030450: 7869 7332 2c0a 2020 2020 2020 2020 696e  xis2,.        in
+00030460: 7420 2020 2020 2020 2020 2020 2020 2020  t               
+00030470: 2020 2020 6178 6973 3329 207b 0a20 2020      axis3) {.   
+00030480: 2047 474d 4c5f 4153 5345 5254 2861 7869   GGML_ASSERT(axi
+00030490: 7330 203e 3d20 3020 2626 2061 7869 7330  s0 >= 0 && axis0
+000304a0: 203c 2047 474d 4c5f 4d41 585f 4449 4d53   < GGML_MAX_DIMS
+000304b0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+000304c0: 5254 2861 7869 7331 203e 3d20 3020 2626  RT(axis1 >= 0 &&
+000304d0: 2061 7869 7331 203c 2047 474d 4c5f 4d41   axis1 < GGML_MA
+000304e0: 585f 4449 4d53 293b 0a20 2020 2047 474d  X_DIMS);.    GGM
+000304f0: 4c5f 4153 5345 5254 2861 7869 7332 203e  L_ASSERT(axis2 >
+00030500: 3d20 3020 2626 2061 7869 7332 203c 2047  = 0 && axis2 < G
+00030510: 474d 4c5f 4d41 585f 4449 4d53 293b 0a20  GML_MAX_DIMS);. 
+00030520: 2020 2047 474d 4c5f 4153 5345 5254 2861     GGML_ASSERT(a
+00030530: 7869 7333 203e 3d20 3020 2626 2061 7869  xis3 >= 0 && axi
+00030540: 7333 203c 2047 474d 4c5f 4d41 585f 4449  s3 < GGML_MAX_DI
+00030550: 4d53 293b 0a0a 2020 2020 4747 4d4c 5f41  MS);..    GGML_A
+00030560: 5353 4552 5428 6178 6973 3020 213d 2061  SSERT(axis0 != a
+00030570: 7869 7331 293b 0a20 2020 2047 474d 4c5f  xis1);.    GGML_
+00030580: 4153 5345 5254 2861 7869 7330 2021 3d20  ASSERT(axis0 != 
+00030590: 6178 6973 3229 3b0a 2020 2020 4747 4d4c  axis2);.    GGML
+000305a0: 5f41 5353 4552 5428 6178 6973 3020 213d  _ASSERT(axis0 !=
+000305b0: 2061 7869 7333 293b 0a20 2020 2047 474d   axis3);.    GGM
+000305c0: 4c5f 4153 5345 5254 2861 7869 7331 2021  L_ASSERT(axis1 !
+000305d0: 3d20 6178 6973 3229 3b0a 2020 2020 4747  = axis2);.    GG
+000305e0: 4d4c 5f41 5353 4552 5428 6178 6973 3120  ML_ASSERT(axis1 
+000305f0: 213d 2061 7869 7333 293b 0a20 2020 2047  != axis3);.    G
+00030600: 474d 4c5f 4153 5345 5254 2861 7869 7332  GML_ASSERT(axis2
+00030610: 2021 3d20 6178 6973 3329 3b0a 0a20 2020   != axis3);..   
+00030620: 2062 6f6f 6c20 6973 5f6e 6f64 6520 3d20   bool is_node = 
+00030630: 6661 6c73 653b 0a0a 2020 2020 6966 2028  false;..    if (
+00030640: 612d 3e67 7261 6429 207b 0a20 2020 2020  a->grad) {.     
+00030650: 2020 2069 735f 6e6f 6465 203d 2074 7275     is_node = tru
+00030660: 653b 0a20 2020 207d 0a0a 2020 2020 7374  e;.    }..    st
+00030670: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00030680: 202a 2072 6573 756c 7420 3d20 6767 6d6c   * result = ggml
+00030690: 5f76 6965 775f 7465 6e73 6f72 2863 7478  _view_tensor(ctx
+000306a0: 2c20 6129 3b0a 0a20 2020 2069 6e74 206e  , a);..    int n
+000306b0: 655b 4747 4d4c 5f4d 4158 5f44 494d 535d  e[GGML_MAX_DIMS]
+000306c0: 3b0a 2020 2020 696e 7420 6e62 5b47 474d  ;.    int nb[GGM
+000306d0: 4c5f 4d41 585f 4449 4d53 5d3b 0a0a 2020  L_MAX_DIMS];..  
+000306e0: 2020 6e65 5b61 7869 7330 5d20 3d20 612d    ne[axis0] = a-
+000306f0: 3e6e 655b 305d 3b0a 2020 2020 6e65 5b61  >ne[0];.    ne[a
+00030700: 7869 7331 5d20 3d20 612d 3e6e 655b 315d  xis1] = a->ne[1]
+00030710: 3b0a 2020 2020 6e65 5b61 7869 7332 5d20  ;.    ne[axis2] 
+00030720: 3d20 612d 3e6e 655b 325d 3b0a 2020 2020  = a->ne[2];.    
+00030730: 6e65 5b61 7869 7333 5d20 3d20 612d 3e6e  ne[axis3] = a->n
+00030740: 655b 335d 3b0a 0a20 2020 206e 625b 6178  e[3];..    nb[ax
+00030750: 6973 305d 203d 2061 2d3e 6e62 5b30 5d3b  is0] = a->nb[0];
+00030760: 0a20 2020 206e 625b 6178 6973 315d 203d  .    nb[axis1] =
+00030770: 2061 2d3e 6e62 5b31 5d3b 0a20 2020 206e   a->nb[1];.    n
+00030780: 625b 6178 6973 325d 203d 2061 2d3e 6e62  b[axis2] = a->nb
+00030790: 5b32 5d3b 0a20 2020 206e 625b 6178 6973  [2];.    nb[axis
+000307a0: 335d 203d 2061 2d3e 6e62 5b33 5d3b 0a0a  3] = a->nb[3];..
+000307b0: 2020 2020 7265 7375 6c74 2d3e 6e65 5b30      result->ne[0
+000307c0: 5d20 3d20 6e65 5b30 5d3b 0a20 2020 2072  ] = ne[0];.    r
+000307d0: 6573 756c 742d 3e6e 655b 315d 203d 206e  esult->ne[1] = n
+000307e0: 655b 315d 3b0a 2020 2020 7265 7375 6c74  e[1];.    result
+000307f0: 2d3e 6e65 5b32 5d20 3d20 6e65 5b32 5d3b  ->ne[2] = ne[2];
+00030800: 0a20 2020 2072 6573 756c 742d 3e6e 655b  .    result->ne[
+00030810: 335d 203d 206e 655b 335d 3b0a 0a20 2020  3] = ne[3];..   
+00030820: 2072 6573 756c 742d 3e6e 625b 305d 203d   result->nb[0] =
+00030830: 206e 625b 305d 3b0a 2020 2020 7265 7375   nb[0];.    resu
+00030840: 6c74 2d3e 6e62 5b31 5d20 3d20 6e62 5b31  lt->nb[1] = nb[1
+00030850: 5d3b 0a20 2020 2072 6573 756c 742d 3e6e  ];.    result->n
+00030860: 625b 325d 203d 206e 625b 325d 3b0a 2020  b[2] = nb[2];.  
+00030870: 2020 7265 7375 6c74 2d3e 6e62 5b33 5d20    result->nb[3] 
+00030880: 3d20 6e62 5b33 5d3b 0a0a 2020 2020 7265  = nb[3];..    re
+00030890: 7375 6c74 2d3e 6f70 2020 203d 2047 474d  sult->op   = GGM
+000308a0: 4c5f 4f50 5f50 4552 4d55 5445 3b0a 2020  L_OP_PERMUTE;.  
+000308b0: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
+000308c0: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
+000308d0: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+000308e0: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
+000308f0: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
+00030900: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
+00030910: 2d3e 7372 6331 203d 204e 554c 4c3b 0a0a  ->src1 = NULL;..
+00030920: 2020 2020 6966 2028 6973 5f6e 6f64 6529      if (is_node)
+00030930: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
+00030940: 7363 7261 7463 685f 7361 7665 2863 7478  scratch_save(ctx
+00030950: 293b 0a0a 2020 2020 2020 2020 7374 7275  );..        stru
+00030960: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00030970: 2062 203d 2067 676d 6c5f 6e65 775f 7465   b = ggml_new_te
+00030980: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
+00030990: 4c5f 5459 5045 5f49 3332 2c20 3429 3b0a  L_TYPE_I32, 4);.
+000309a0: 0a20 2020 2020 2020 2028 2869 6e74 3332  .        ((int32
+000309b0: 5f74 202a 2920 622d 3e64 6174 6129 5b30  _t *) b->data)[0
+000309c0: 5d20 3d20 6178 6973 303b 0a20 2020 2020  ] = axis0;.     
+000309d0: 2020 2028 2869 6e74 3332 5f74 202a 2920     ((int32_t *) 
+000309e0: 622d 3e64 6174 6129 5b31 5d20 3d20 6178  b->data)[1] = ax
+000309f0: 6973 313b 0a20 2020 2020 2020 2028 2869  is1;.        ((i
+00030a00: 6e74 3332 5f74 202a 2920 622d 3e64 6174  nt32_t *) b->dat
+00030a10: 6129 5b32 5d20 3d20 6178 6973 323b 0a20  a)[2] = axis2;. 
+00030a20: 2020 2020 2020 2028 2869 6e74 3332 5f74         ((int32_t
+00030a30: 202a 2920 622d 3e64 6174 6129 5b33 5d20   *) b->data)[3] 
+00030a40: 3d20 6178 6973 333b 0a0a 2020 2020 2020  = axis3;..      
+00030a50: 2020 6767 6d6c 5f73 6372 6174 6368 5f6c    ggml_scratch_l
+00030a60: 6f61 6428 6374 7829 3b0a 0a20 2020 2020  oad(ctx);..     
+00030a70: 2020 2072 6573 756c 742d 3e6f 7074 5b30     result->opt[0
+00030a80: 5d20 3d20 623b 0a20 2020 207d 0a0a 2020  ] = b;.    }..  
+00030a90: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
+00030aa0: 0a7d 0a0a 2f2f 2067 676d 6c5f 7472 616e  .}..// ggml_tran
+00030ab0: 7370 6f73 650a 0a73 7472 7563 7420 6767  spose..struct gg
+00030ac0: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+00030ad0: 5f74 7261 6e73 706f 7365 280a 2020 2020  _transpose(.    
+00030ae0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00030af0: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+00030b00: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00030b10: 6d6c 5f74 656e 736f 7220 202a 2061 2920  ml_tensor  * a) 
+00030b20: 7b0a 2020 2020 626f 6f6c 2069 735f 6e6f  {.    bool is_no
+00030b30: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
+00030b40: 2069 6620 2861 2d3e 6772 6164 2920 7b0a   if (a->grad) {.
+00030b50: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
+00030b60: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
+00030b70: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00030b80: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
+00030b90: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
+00030ba0: 7228 6374 782c 2061 293b 0a0a 2020 2020  r(ctx, a);..    
+00030bb0: 7265 7375 6c74 2d3e 6e65 5b30 5d20 3d20  result->ne[0] = 
+00030bc0: 612d 3e6e 655b 315d 3b0a 2020 2020 7265  a->ne[1];.    re
+00030bd0: 7375 6c74 2d3e 6e65 5b31 5d20 3d20 612d  sult->ne[1] = a-
+00030be0: 3e6e 655b 305d 3b0a 0a20 2020 2072 6573  >ne[0];..    res
+00030bf0: 756c 742d 3e6e 625b 305d 203d 2061 2d3e  ult->nb[0] = a->
+00030c00: 6e62 5b31 5d3b 0a20 2020 2072 6573 756c  nb[1];.    resul
+00030c10: 742d 3e6e 625b 315d 203d 2061 2d3e 6e62  t->nb[1] = a->nb
+00030c20: 5b30 5d3b 0a0a 2020 2020 7265 7375 6c74  [0];..    result
+00030c30: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
+00030c40: 5f54 5241 4e53 504f 5345 3b0a 2020 2020  _TRANSPOSE;.    
+00030c50: 7265 7375 6c74 2d3e 6772 6164 203d 2069  result->grad = i
+00030c60: 735f 6e6f 6465 203f 2067 676d 6c5f 6475  s_node ? ggml_du
+00030c70: 705f 7465 6e73 6f72 2863 7478 2c20 7265  p_tensor(ctx, re
+00030c80: 7375 6c74 2920 3a20 4e55 4c4c 3b0a 2020  sult) : NULL;.  
+00030c90: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
+00030ca0: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
+00030cb0: 7372 6331 203d 204e 554c 4c3b 0a0a 2020  src1 = NULL;..  
+00030cc0: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
+00030cd0: 0a7d 0a0a 2f2f 2067 676d 6c5f 6765 745f  .}..// ggml_get_
+00030ce0: 726f 7773 0a0a 7374 7275 6374 2067 676d  rows..struct ggm
+00030cf0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+00030d00: 6765 745f 726f 7773 280a 2020 2020 2020  get_rows(.      
+00030d10: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+00030d20: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+00030d30: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00030d40: 5f74 656e 736f 7220 202a 2061 2c0a 2020  _tensor  * a,.  
+00030d50: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00030d60: 6c5f 7465 6e73 6f72 2020 2a20 6229 207b  l_tensor  * b) {
+00030d70: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00030d80: 2867 676d 6c5f 6973 5f6d 6174 7269 7828  (ggml_is_matrix(
+00030d90: 6129 2026 2620 6767 6d6c 5f69 735f 7665  a) && ggml_is_ve
+00030da0: 6374 6f72 2862 2920 2626 2062 2d3e 7479  ctor(b) && b->ty
+00030db0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+00030dc0: 4933 3229 3b0a 0a20 2020 2062 6f6f 6c20  I32);..    bool 
+00030dd0: 6973 5f6e 6f64 6520 3d20 6661 6c73 653b  is_node = false;
+00030de0: 0a0a 2020 2020 6966 2028 612d 3e67 7261  ..    if (a->gra
+00030df0: 6420 7c7c 2062 2d3e 6772 6164 2920 7b0a  d || b->grad) {.
+00030e00: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
+00030e10: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
+00030e20: 2020 202f 2f20 544f 444f 3a20 696d 706c     // TODO: impl
+00030e30: 656d 656e 7420 6e6f 6e20 4633 3220 7265  ement non F32 re
+00030e40: 7475 726e 0a20 2020 202f 2f73 7472 7563  turn.    //struc
+00030e50: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00030e60: 7265 7375 6c74 203d 2067 676d 6c5f 6e65  result = ggml_ne
+00030e70: 775f 7465 6e73 6f72 5f32 6428 6374 782c  w_tensor_2d(ctx,
+00030e80: 2061 2d3e 7479 7065 2c20 612d 3e6e 655b   a->type, a->ne[
+00030e90: 305d 2c20 622d 3e6e 655b 305d 293b 0a20  0], b->ne[0]);. 
+00030ea0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00030eb0: 656e 736f 7220 2a20 7265 7375 6c74 203d  ensor * result =
+00030ec0: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+00030ed0: 5f32 6428 6374 782c 2047 474d 4c5f 5459  _2d(ctx, GGML_TY
+00030ee0: 5045 5f46 3332 2c20 612d 3e6e 655b 305d  PE_F32, a->ne[0]
+00030ef0: 2c20 622d 3e6e 655b 305d 293b 0a0a 2020  , b->ne[0]);..  
+00030f00: 2020 7265 7375 6c74 2d3e 6f70 2020 203d    result->op   =
+00030f10: 2047 474d 4c5f 4f50 5f47 4554 5f52 4f57   GGML_OP_GET_ROW
+00030f20: 533b 0a20 2020 2072 6573 756c 742d 3e67  S;.    result->g
+00030f30: 7261 6420 3d20 6973 5f6e 6f64 6520 3f20  rad = is_node ? 
+00030f40: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00030f50: 6374 782c 2072 6573 756c 7429 203a 204e  ctx, result) : N
+00030f60: 554c 4c3b 0a20 2020 2072 6573 756c 742d  ULL;.    result-
+00030f70: 3e73 7263 3020 3d20 613b 0a20 2020 2072  >src0 = a;.    r
+00030f80: 6573 756c 742d 3e73 7263 3120 3d20 623b  esult->src1 = b;
+00030f90: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
+00030fa0: 756c 743b 0a7d 0a0a 2f2f 2067 676d 6c5f  ult;.}..// ggml_
+00030fb0: 6765 745f 726f 7773 5f62 6163 6b0a 0a73  get_rows_back..s
+00030fc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00030fd0: 7220 2a20 6767 6d6c 5f67 6574 5f72 6f77  r * ggml_get_row
+00030fe0: 735f 6261 636b 280a 2020 2020 2020 2020  s_back(.        
+00030ff0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+00031000: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+00031010: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00031020: 656e 736f 7220 202a 2061 2c0a 2020 2020  ensor  * a,.    
+00031030: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00031040: 7465 6e73 6f72 2020 2a20 622c 0a20 2020  tensor  * b,.   
+00031050: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00031060: 5f74 656e 736f 7220 202a 2063 2920 7b0a  _tensor  * c) {.
+00031070: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00031080: 6767 6d6c 5f69 735f 6d61 7472 6978 2861  ggml_is_matrix(a
+00031090: 2920 2626 2067 676d 6c5f 6973 5f76 6563  ) && ggml_is_vec
+000310a0: 746f 7228 6229 2026 2620 622d 3e74 7970  tor(b) && b->typ
+000310b0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
+000310c0: 3332 293b 0a20 2020 2047 474d 4c5f 4153  32);.    GGML_AS
+000310d0: 5345 5254 2867 676d 6c5f 6973 5f6d 6174  SERT(ggml_is_mat
+000310e0: 7269 7828 6329 2026 2620 2861 2d3e 6e65  rix(c) && (a->ne
+000310f0: 5b30 5d20 3d3d 2063 2d3e 6e65 5b30 5d29  [0] == c->ne[0])
+00031100: 293b 0a0a 2020 2020 626f 6f6c 2069 735f  );..    bool is_
+00031110: 6e6f 6465 203d 2066 616c 7365 3b0a 0a20  node = false;.. 
+00031120: 2020 2069 6620 2861 2d3e 6772 6164 207c     if (a->grad |
+00031130: 7c20 622d 3e67 7261 6429 207b 0a20 2020  | b->grad) {.   
+00031140: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
+00031150: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
+00031160: 2f2f 2054 4f44 4f3a 2069 6d70 6c65 6d65  // TODO: impleme
+00031170: 6e74 206e 6f6e 2046 3332 2072 6574 7572  nt non F32 retur
+00031180: 6e0a 2020 2020 2f2f 7374 7275 6374 2067  n.    //struct g
+00031190: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+000311a0: 756c 7420 3d20 6767 6d6c 5f6e 6577 5f74  ult = ggml_new_t
+000311b0: 656e 736f 725f 3264 2863 7478 2c20 612d  ensor_2d(ctx, a-
+000311c0: 3e74 7970 652c 2061 2d3e 6e65 5b30 5d2c  >type, a->ne[0],
+000311d0: 2062 2d3e 6e65 5b30 5d29 3b0a 2020 2020   b->ne[0]);.    
+000311e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000311f0: 6f72 202a 2072 6573 756c 7420 3d20 6767  or * result = gg
+00031200: 6d6c 5f6e 6577 5f74 656e 736f 725f 3264  ml_new_tensor_2d
+00031210: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
+00031220: 4633 322c 2063 2d3e 6e65 5b30 5d2c 2063  F32, c->ne[0], c
+00031230: 2d3e 6e65 5b31 5d29 3b0a 0a20 2020 2072  ->ne[1]);..    r
+00031240: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
+00031250: 4d4c 5f4f 505f 4745 545f 524f 5753 5f42  ML_OP_GET_ROWS_B
+00031260: 4143 4b3b 0a20 2020 2072 6573 756c 742d  ACK;.    result-
+00031270: 3e67 7261 6420 3d20 6973 5f6e 6f64 6520  >grad = is_node 
+00031280: 3f20 6767 6d6c 5f64 7570 5f74 656e 736f  ? ggml_dup_tenso
+00031290: 7228 6374 782c 2072 6573 756c 7429 203a  r(ctx, result) :
+000312a0: 204e 554c 4c3b 0a20 2020 2072 6573 756c   NULL;.    resul
+000312b0: 742d 3e73 7263 3020 3d20 613b 0a20 2020  t->src0 = a;.   
+000312c0: 2072 6573 756c 742d 3e73 7263 3120 3d20   result->src1 = 
+000312d0: 623b 0a20 2020 2072 6573 756c 742d 3e6f  b;.    result->o
+000312e0: 7074 5b30 5d20 3d20 633b 0a0a 2020 2020  pt[0] = c;..    
+000312f0: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+00031300: 0a0a 2f2f 2067 676d 6c5f 6469 6167 0a0a  ..// ggml_diag..
+00031310: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00031320: 6f72 202a 2067 676d 6c5f 6469 6167 280a  or * ggml_diag(.
+00031330: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00031340: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00031350: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+00031360: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+00031370: 2061 2920 7b0a 2020 2020 4747 4d4c 5f41   a) {.    GGML_A
+00031380: 5353 4552 5428 612d 3e6e 655b 315d 203d  SSERT(a->ne[1] =
+00031390: 3d20 3129 3b0a 2020 2020 626f 6f6c 2069  = 1);.    bool i
+000313a0: 735f 6e6f 6465 203d 2066 616c 7365 3b0a  s_node = false;.
+000313b0: 0a20 2020 2069 6620 2861 2d3e 6772 6164  .    if (a->grad
+000313c0: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
+000313d0: 6f64 6520 3d20 7472 7565 3b0a 2020 2020  ode = true;.    
+000313e0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
+000313f0: 3634 5f74 206e 655b 345d 203d 207b 2061  64_t ne[4] = { a
+00031400: 2d3e 6e65 5b30 5d2c 2061 2d3e 6e65 5b30  ->ne[0], a->ne[0
+00031410: 5d2c 2061 2d3e 6e65 5b32 5d2c 2061 2d3e  ], a->ne[2], a->
+00031420: 6e65 5b33 5d20 7d3b 0a20 2020 2073 7472  ne[3] };.    str
+00031430: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00031440: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+00031450: 6e65 775f 7465 6e73 6f72 2863 7478 2c20  new_tensor(ctx, 
+00031460: 612d 3e74 7970 652c 204d 4158 2861 2d3e  a->type, MAX(a->
+00031470: 6e5f 6469 6d73 2c20 3229 2c20 6e65 293b  n_dims, 2), ne);
+00031480: 0a0a 2020 2020 7265 7375 6c74 2d3e 6f70  ..    result->op
+00031490: 2020 203d 2047 474d 4c5f 4f50 5f44 4941     = GGML_OP_DIA
+000314a0: 473b 0a20 2020 2072 6573 756c 742d 3e67  G;.    result->g
+000314b0: 7261 6420 3d20 6973 5f6e 6f64 6520 3f20  rad = is_node ? 
+000314c0: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+000314d0: 6374 782c 2072 6573 756c 7429 203a 204e  ctx, result) : N
+000314e0: 554c 4c3b 0a20 2020 2072 6573 756c 742d  ULL;.    result-
+000314f0: 3e73 7263 3020 3d20 613b 0a20 2020 2072  >src0 = a;.    r
+00031500: 6573 756c 742d 3e73 7263 3120 3d20 4e55  esult->src1 = NU
+00031510: 4c4c 3b0a 0a20 2020 2072 6574 7572 6e20  LL;..    return 
+00031520: 7265 7375 6c74 3b0a 7d0a 0a0a 2f2f 2067  result;.}...// g
+00031530: 676d 6c5f 6469 6167 5f6d 6173 6b5f 696e  gml_diag_mask_in
+00031540: 660a 0a73 7472 7563 7420 6767 6d6c 5f74  f..struct ggml_t
+00031550: 656e 736f 7220 2a20 6767 6d6c 5f64 6961  ensor * ggml_dia
+00031560: 675f 6d61 736b 5f69 6e66 5f69 6d70 6c28  g_mask_inf_impl(
+00031570: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00031580: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+00031590: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+000315a0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+000315b0: 2a20 612c 0a20 2020 2020 2020 2069 6e74  * a,.        int
+000315c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000315d0: 2020 206e 5f70 6173 742c 0a20 2020 2020     n_past,.     
+000315e0: 2020 2062 6f6f 6c20 2020 2020 2020 2020     bool         
+000315f0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+00031600: 2920 7b0a 2020 2020 626f 6f6c 2069 735f  ) {.    bool is_
+00031610: 6e6f 6465 203d 2066 616c 7365 3b0a 0a20  node = false;.. 
+00031620: 2020 2069 6620 2861 2d3e 6772 6164 2920     if (a->grad) 
+00031630: 7b0a 2020 2020 2020 2020 6973 5f6e 6f64  {.        is_nod
+00031640: 6520 3d20 7472 7565 3b0a 2020 2020 7d0a  e = true;.    }.
+00031650: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00031660: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
+00031670: 203d 2069 6e70 6c61 6365 203f 2067 676d   = inplace ? ggm
+00031680: 6c5f 7669 6577 5f74 656e 736f 7228 6374  l_view_tensor(ct
+00031690: 782c 2061 2920 3a20 6767 6d6c 5f64 7570  x, a) : ggml_dup
+000316a0: 5f74 656e 736f 7228 6374 782c 2061 293b  _tensor(ctx, a);
+000316b0: 0a0a 2020 2020 6767 6d6c 5f73 6372 6174  ..    ggml_scrat
+000316c0: 6368 5f73 6176 6528 6374 7829 3b0a 0a20  ch_save(ctx);.. 
+000316d0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+000316e0: 656e 736f 7220 2a20 6220 3d20 6767 6d6c  ensor * b = ggml
+000316f0: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
+00031700: 7478 2c20 4747 4d4c 5f54 5950 455f 4933  tx, GGML_TYPE_I3
+00031710: 322c 2032 293b 0a0a 2020 2020 2828 696e  2, 2);..    ((in
+00031720: 7433 325f 7420 2a29 2062 2d3e 6461 7461  t32_t *) b->data
+00031730: 295b 305d 203d 206e 5f70 6173 743b 0a20  )[0] = n_past;. 
+00031740: 2020 2028 2869 6e74 3332 5f74 202a 2920     ((int32_t *) 
+00031750: 622d 3e64 6174 6129 5b31 5d20 3d20 696e  b->data)[1] = in
+00031760: 706c 6163 6520 3f20 3120 3a20 303b 0a0a  place ? 1 : 0;..
+00031770: 2020 2020 6767 6d6c 5f73 6372 6174 6368      ggml_scratch
+00031780: 5f6c 6f61 6428 6374 7829 3b0a 0a20 2020  _load(ctx);..   
+00031790: 2072 6573 756c 742d 3e6f 7020 2020 3d20   result->op   = 
+000317a0: 4747 4d4c 5f4f 505f 4449 4147 5f4d 4153  GGML_OP_DIAG_MAS
+000317b0: 4b5f 494e 463b 0a20 2020 2072 6573 756c  K_INF;.    resul
+000317c0: 742d 3e67 7261 6420 3d20 6973 5f6e 6f64  t->grad = is_nod
+000317d0: 6520 3f20 6767 6d6c 5f64 7570 5f74 656e  e ? ggml_dup_ten
+000317e0: 736f 7228 6374 782c 2072 6573 756c 7429  sor(ctx, result)
+000317f0: 203a 204e 554c 4c3b 0a20 2020 2072 6573   : NULL;.    res
+00031800: 756c 742d 3e73 7263 3020 3d20 613b 0a20  ult->src0 = a;. 
+00031810: 2020 2072 6573 756c 742d 3e73 7263 3120     result->src1 
+00031820: 3d20 623b 0a0a 2020 2020 7265 7475 726e  = b;..    return
+00031830: 2072 6573 756c 743b 0a7d 0a0a 7374 7275   result;.}..stru
+00031840: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00031850: 2067 676d 6c5f 6469 6167 5f6d 6173 6b5f   ggml_diag_mask_
+00031860: 696e 6628 0a20 2020 2020 2020 2073 7472  inf(.        str
+00031870: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00031880: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+00031890: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000318a0: 6f72 2020 2a20 612c 0a20 2020 2020 2020  or  * a,.       
+000318b0: 2069 6e74 2020 2020 2020 2020 2020 2020   int            
+000318c0: 2020 2020 2020 206e 5f70 6173 7429 207b         n_past) {
+000318d0: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
+000318e0: 5f64 6961 675f 6d61 736b 5f69 6e66 5f69  _diag_mask_inf_i
+000318f0: 6d70 6c28 6374 782c 2061 2c20 6e5f 7061  mpl(ctx, a, n_pa
+00031900: 7374 2c20 6661 6c73 6529 3b0a 7d0a 0a0a  st, false);.}...
+00031910: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00031920: 6f72 202a 2067 676d 6c5f 6469 6167 5f6d  or * ggml_diag_m
+00031930: 6173 6b5f 696e 665f 696e 706c 6163 6528  ask_inf_inplace(
+00031940: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00031950: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+00031960: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+00031970: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+00031980: 2a20 612c 0a20 2020 2020 2020 2069 6e74  * a,.        int
+00031990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000319a0: 2020 206e 5f70 6173 7429 207b 0a20 2020     n_past) {.   
+000319b0: 2072 6574 7572 6e20 6767 6d6c 5f64 6961   return ggml_dia
+000319c0: 675f 6d61 736b 5f69 6e66 5f69 6d70 6c28  g_mask_inf_impl(
+000319d0: 6374 782c 2061 2c20 6e5f 7061 7374 2c20  ctx, a, n_past, 
+000319e0: 7472 7565 293b 0a7d 0a0a 2f2f 2067 676d  true);.}..// ggm
+000319f0: 6c5f 6469 6167 5f6d 6173 6b5f 7a65 726f  l_diag_mask_zero
+00031a00: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+00031a10: 6e73 6f72 202a 2067 676d 6c5f 6469 6167  nsor * ggml_diag
+00031a20: 5f6d 6173 6b5f 7a65 726f 5f69 6d70 6c28  _mask_zero_impl(
+00031a30: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00031a40: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+00031a50: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+00031a60: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+00031a70: 2a20 612c 0a20 2020 2020 2020 2069 6e74  * a,.        int
+00031a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031a90: 2020 206e 5f70 6173 742c 0a20 2020 2020     n_past,.     
+00031aa0: 2020 2062 6f6f 6c20 2020 2020 2020 2020     bool         
+00031ab0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+00031ac0: 2920 7b0a 2020 2020 626f 6f6c 2069 735f  ) {.    bool is_
+00031ad0: 6e6f 6465 203d 2066 616c 7365 3b0a 0a20  node = false;.. 
+00031ae0: 2020 2069 6620 2861 2d3e 6772 6164 2920     if (a->grad) 
+00031af0: 7b0a 2020 2020 2020 2020 6973 5f6e 6f64  {.        is_nod
+00031b00: 6520 3d20 7472 7565 3b0a 2020 2020 7d0a  e = true;.    }.
+00031b10: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00031b20: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
+00031b30: 203d 2069 6e70 6c61 6365 203f 2067 676d   = inplace ? ggm
+00031b40: 6c5f 7669 6577 5f74 656e 736f 7228 6374  l_view_tensor(ct
+00031b50: 782c 2061 2920 3a20 6767 6d6c 5f64 7570  x, a) : ggml_dup
+00031b60: 5f74 656e 736f 7228 6374 782c 2061 293b  _tensor(ctx, a);
+00031b70: 0a0a 2020 2020 6767 6d6c 5f73 6372 6174  ..    ggml_scrat
+00031b80: 6368 5f73 6176 6528 6374 7829 3b0a 0a20  ch_save(ctx);.. 
+00031b90: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00031ba0: 656e 736f 7220 2a20 6220 3d20 6767 6d6c  ensor * b = ggml
+00031bb0: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
+00031bc0: 7478 2c20 4747 4d4c 5f54 5950 455f 4933  tx, GGML_TYPE_I3
+00031bd0: 322c 2032 293b 0a20 2020 2067 676d 6c5f  2, 2);.    ggml_
+00031be0: 7365 745f 6e61 6d65 2862 2c20 226e 5f70  set_name(b, "n_p
+00031bf0: 6173 742c 2069 6e70 6c61 6365 2229 3b0a  ast, inplace");.
+00031c00: 0a20 2020 2028 2869 6e74 3332 5f74 202a  .    ((int32_t *
+00031c10: 2920 622d 3e64 6174 6129 5b30 5d20 3d20  ) b->data)[0] = 
+00031c20: 6e5f 7061 7374 3b0a 2020 2020 2828 696e  n_past;.    ((in
+00031c30: 7433 325f 7420 2a29 2062 2d3e 6461 7461  t32_t *) b->data
+00031c40: 295b 315d 203d 2069 6e70 6c61 6365 203f  )[1] = inplace ?
+00031c50: 2031 203a 2030 3b0a 0a20 2020 2067 676d   1 : 0;..    ggm
+00031c60: 6c5f 7363 7261 7463 685f 6c6f 6164 2863  l_scratch_load(c
+00031c70: 7478 293b 0a0a 2020 2020 7265 7375 6c74  tx);..    result
+00031c80: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
+00031c90: 5f44 4941 475f 4d41 534b 5f5a 4552 4f3b  _DIAG_MASK_ZERO;
+00031ca0: 0a20 2020 2072 6573 756c 742d 3e67 7261  .    result->gra
+00031cb0: 6420 3d20 6973 5f6e 6f64 6520 3f20 6767  d = is_node ? gg
+00031cc0: 6d6c 5f64 7570 5f74 656e 736f 7228 6374  ml_dup_tensor(ct
+00031cd0: 782c 2072 6573 756c 7429 203a 204e 554c  x, result) : NUL
+00031ce0: 4c3b 0a20 2020 2072 6573 756c 742d 3e73  L;.    result->s
+00031cf0: 7263 3020 3d20 613b 0a20 2020 2072 6573  rc0 = a;.    res
+00031d00: 756c 742d 3e73 7263 3120 3d20 623b 0a0a  ult->src1 = b;..
+00031d10: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00031d20: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
+00031d30: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+00031d40: 6469 6167 5f6d 6173 6b5f 7a65 726f 280a  diag_mask_zero(.
+00031d50: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00031d60: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00031d70: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+00031d80: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+00031d90: 2061 2c0a 2020 2020 2020 2020 696e 7420   a,.        int 
+00031da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031db0: 2020 6e5f 7061 7374 2920 7b0a 2020 2020    n_past) {.    
+00031dc0: 7265 7475 726e 2067 676d 6c5f 6469 6167  return ggml_diag
+00031dd0: 5f6d 6173 6b5f 7a65 726f 5f69 6d70 6c28  _mask_zero_impl(
+00031de0: 6374 782c 2061 2c20 6e5f 7061 7374 2c20  ctx, a, n_past, 
+00031df0: 6661 6c73 6529 3b0a 7d0a 0a73 7472 7563  false);.}..struc
+00031e00: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00031e10: 6767 6d6c 5f64 6961 675f 6d61 736b 5f7a  ggml_diag_mask_z
+00031e20: 6572 6f5f 696e 706c 6163 6528 0a20 2020  ero_inplace(.   
+00031e30: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00031e40: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+00031e50: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00031e60: 676d 6c5f 7465 6e73 6f72 2020 2a20 612c  gml_tensor  * a,
+00031e70: 0a20 2020 2020 2020 2069 6e74 2020 2020  .        int    
+00031e80: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00031e90: 5f70 6173 7429 207b 0a20 2020 2072 6574  _past) {.    ret
+00031ea0: 7572 6e20 6767 6d6c 5f64 6961 675f 6d61  urn ggml_diag_ma
+00031eb0: 736b 5f7a 6572 6f5f 696d 706c 2863 7478  sk_zero_impl(ctx
+00031ec0: 2c20 612c 206e 5f70 6173 742c 2074 7275  , a, n_past, tru
+00031ed0: 6529 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f73  e);.}..// ggml_s
+00031ee0: 6f66 745f 6d61 780a 0a73 7472 7563 7420  oft_max..struct 
+00031ef0: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+00031f00: 6d6c 5f73 6f66 745f 6d61 785f 696d 706c  ml_soft_max_impl
+00031f10: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+00031f20: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00031f30: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+00031f40: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00031f50: 202a 2061 2c0a 2020 2020 2020 2020 626f   * a,.        bo
+00031f60: 6f6c 2020 2020 2020 2020 2020 2020 2020  ol              
+00031f70: 2020 2020 696e 706c 6163 6529 207b 0a20      inplace) {. 
+00031f80: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
+00031f90: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
+00031fa0: 2028 612d 3e67 7261 6429 207b 0a20 2020   (a->grad) {.   
+00031fb0: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
+00031fc0: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
+00031fd0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00031fe0: 6f72 202a 2072 6573 756c 7420 3d20 696e  or * result = in
+00031ff0: 706c 6163 6520 3f20 6767 6d6c 5f76 6965  place ? ggml_vie
+00032000: 775f 7465 6e73 6f72 2863 7478 2c20 6129  w_tensor(ctx, a)
+00032010: 203a 2067 676d 6c5f 6475 705f 7465 6e73   : ggml_dup_tens
+00032020: 6f72 2863 7478 2c20 6129 3b0a 0a20 2020  or(ctx, a);..   
+00032030: 2072 6573 756c 742d 3e6f 7020 2020 3d20   result->op   = 
+00032040: 4747 4d4c 5f4f 505f 534f 4654 5f4d 4158  GGML_OP_SOFT_MAX
+00032050: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
+00032060: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
+00032070: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
+00032080: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
+00032090: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
+000320a0: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
+000320b0: 7375 6c74 2d3e 7372 6331 203d 204e 554c  sult->src1 = NUL
+000320c0: 4c3b 0a0a 2020 2020 7265 7475 726e 2072  L;..    return r
+000320d0: 6573 756c 743b 0a7d 0a0a 7374 7275 6374  esult;.}..struct
+000320e0: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+000320f0: 676d 6c5f 736f 6674 5f6d 6178 280a 2020  gml_soft_max(.  
+00032100: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00032110: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+00032120: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00032130: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+00032140: 2920 7b0a 2020 2020 7265 7475 726e 2067  ) {.    return g
+00032150: 676d 6c5f 736f 6674 5f6d 6178 5f69 6d70  gml_soft_max_imp
+00032160: 6c28 6374 782c 2061 2c20 6661 6c73 6529  l(ctx, a, false)
+00032170: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+00032180: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
+00032190: 6f66 745f 6d61 785f 696e 706c 6163 6528  oft_max_inplace(
+000321a0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000321b0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+000321c0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+000321d0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+000321e0: 2a20 6129 207b 0a20 2020 2072 6574 7572  * a) {.    retur
+000321f0: 6e20 6767 6d6c 5f73 6f66 745f 6d61 785f  n ggml_soft_max_
+00032200: 696d 706c 2863 7478 2c20 612c 2074 7275  impl(ctx, a, tru
+00032210: 6529 3b0a 7d0a 0a0a 2f2f 2067 676d 6c5f  e);.}...// ggml_
+00032220: 736f 6674 5f6d 6178 5f62 6163 6b0a 0a73  soft_max_back..s
+00032230: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00032240: 7220 2a20 6767 6d6c 5f73 6f66 745f 6d61  r * ggml_soft_ma
+00032250: 785f 6261 636b 5f69 6d70 6c28 0a20 2020  x_back_impl(.   
+00032260: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00032270: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+00032280: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00032290: 676d 6c5f 7465 6e73 6f72 2020 2a20 612c  gml_tensor  * a,
+000322a0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000322b0: 6767 6d6c 5f74 656e 736f 7220 202a 2062  ggml_tensor  * b
+000322c0: 2c0a 2020 2020 2020 2020 626f 6f6c 2020  ,.        bool  
+000322d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322e0: 696e 706c 6163 6529 207b 0a20 2020 2062  inplace) {.    b
+000322f0: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
+00032300: 6c73 653b 0a0a 2020 2020 6966 2028 612d  lse;..    if (a-
+00032310: 3e67 7261 6420 7c7c 2062 2d3e 6772 6164  >grad || b->grad
+00032320: 2920 7b0a 2020 2020 2020 2020 6973 5f6e  ) {.        is_n
+00032330: 6f64 6520 3d20 7472 7565 3b20 2f2f 2054  ode = true; // T
+00032340: 4f44 4f20 3a20 696d 706c 656d 656e 7420  ODO : implement 
+00032350: 6261 636b 7761 7264 2070 6173 730a 2020  backward pass.  
+00032360: 2020 7d0a 0a20 2020 2073 7472 7563 7420    }..    struct 
+00032370: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
+00032380: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
+00032390: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
+000323a0: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
+000323b0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+000323c0: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
+000323d0: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
+000323e0: 5f53 4f46 545f 4d41 585f 4241 434b 3b0a  _SOFT_MAX_BACK;.
+000323f0: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
+00032400: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
+00032410: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
+00032420: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
+00032430: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+00032440: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
+00032450: 6c74 2d3e 7372 6331 203d 2062 3b0a 0a20  lt->src1 = b;.. 
+00032460: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00032470: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+00032480: 5f74 656e 736f 7220 2a20 6767 6d6c 5f73  _tensor * ggml_s
+00032490: 6f66 745f 6d61 785f 6261 636b 280a 2020  oft_max_back(.  
+000324a0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+000324b0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+000324c0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000324d0: 6767 6d6c 5f74 656e 736f 7220 202a 2061  ggml_tensor  * a
+000324e0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+000324f0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
+00032500: 6229 207b 0a20 2020 2072 6574 7572 6e20  b) {.    return 
+00032510: 6767 6d6c 5f73 6f66 745f 6d61 785f 6261  ggml_soft_max_ba
+00032520: 636b 5f69 6d70 6c28 6374 782c 2061 2c20  ck_impl(ctx, a, 
+00032530: 622c 2066 616c 7365 293b 0a7d 0a0a 7374  b, false);.}..st
+00032540: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00032550: 202a 2067 676d 6c5f 736f 6674 5f6d 6178   * ggml_soft_max
+00032560: 5f62 6163 6b5f 696e 706c 6163 6528 0a20  _back_inplace(. 
+00032570: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00032580: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
+00032590: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+000325a0: 2067 676d 6c5f 7465 6e73 6f72 2020 2a20   ggml_tensor  * 
+000325b0: 612c 0a20 2020 2020 2020 2073 7472 7563  a,.        struc
+000325c0: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+000325d0: 2062 2920 7b0a 2020 2020 7265 7475 726e   b) {.    return
+000325e0: 2067 676d 6c5f 736f 6674 5f6d 6178 5f62   ggml_soft_max_b
+000325f0: 6163 6b5f 696d 706c 2863 7478 2c20 612c  ack_impl(ctx, a,
+00032600: 2062 2c20 7472 7565 293b 0a7d 0a0a 2f2f   b, true);.}..//
+00032610: 2067 676d 6c5f 726f 7065 0a0a 7374 7275   ggml_rope..stru
+00032620: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00032630: 2067 676d 6c5f 726f 7065 5f69 6d70 6c28   ggml_rope_impl(
+00032640: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00032650: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+00032660: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+00032670: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+00032680: 2a20 612c 0a20 2020 2020 2020 2069 6e74  * a,.        int
+00032690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000326a0: 2020 206e 5f70 6173 742c 0a20 2020 2020     n_past,.     
+000326b0: 2020 2069 6e74 2020 2020 2020 2020 2020     int          
+000326c0: 2020 2020 2020 2020 206e 5f64 696d 732c           n_dims,
+000326d0: 0a20 2020 2020 2020 2069 6e74 2020 2020  .        int    
+000326e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000326f0: 6f64 652c 0a20 2020 2020 2020 2062 6f6f  ode,.        boo
+00032700: 6c20 2020 2020 2020 2020 2020 2020 2020  l               
+00032710: 2020 2069 6e70 6c61 6365 2920 7b0a 2020     inplace) {.  
+00032720: 2020 4747 4d4c 5f41 5353 4552 5428 6e5f    GGML_ASSERT(n_
+00032730: 7061 7374 203e 3d20 3029 3b0a 2020 2020  past >= 0);.    
+00032740: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
+00032750: 616c 7365 3b0a 0a20 2020 2069 6620 2861  alse;..    if (a
+00032760: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00032770: 2020 6973 5f6e 6f64 6520 3d20 7472 7565    is_node = true
+00032780: 3b0a 2020 2020 7d0a 0a20 2020 2073 7472  ;.    }..    str
+00032790: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000327a0: 2a20 7265 7375 6c74 203d 2069 6e70 6c61  * result = inpla
+000327b0: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
+000327c0: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
+000327d0: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+000327e0: 6374 782c 2061 293b 0a0a 2020 2020 6767  ctx, a);..    gg
+000327f0: 6d6c 5f73 6372 6174 6368 5f73 6176 6528  ml_scratch_save(
+00032800: 6374 7829 3b0a 0a20 2020 2073 7472 7563  ctx);..    struc
+00032810: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00032820: 6220 3d20 6767 6d6c 5f6e 6577 5f74 656e  b = ggml_new_ten
+00032830: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
+00032840: 5f54 5950 455f 4933 322c 2033 293b 0a0a  _TYPE_I32, 3);..
+00032850: 2020 2020 2828 696e 7433 325f 7420 2a29      ((int32_t *)
+00032860: 2062 2d3e 6461 7461 295b 305d 203d 206e   b->data)[0] = n
+00032870: 5f70 6173 743b 0a20 2020 2028 2869 6e74  _past;.    ((int
+00032880: 3332 5f74 202a 2920 622d 3e64 6174 6129  32_t *) b->data)
+00032890: 5b31 5d20 3d20 6e5f 6469 6d73 3b0a 2020  [1] = n_dims;.  
+000328a0: 2020 2828 696e 7433 325f 7420 2a29 2062    ((int32_t *) b
+000328b0: 2d3e 6461 7461 295b 325d 203d 206d 6f64  ->data)[2] = mod
+000328c0: 653b 0a0a 2020 2020 6767 6d6c 5f73 6372  e;..    ggml_scr
+000328d0: 6174 6368 5f6c 6f61 6428 6374 7829 3b0a  atch_load(ctx);.
+000328e0: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+000328f0: 2020 3d20 4747 4d4c 5f4f 505f 524f 5045    = GGML_OP_ROPE
+00032900: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
+00032910: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
+00032920: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
+00032930: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
+00032940: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
+00032950: 7372 6330 203d 2061 3b0a 2020 2020 7265  src0 = a;.    re
+00032960: 7375 6c74 2d3e 7372 6331 203d 2062 3b0a  sult->src1 = b;.
+00032970: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+00032980: 6c74 3b0a 7d0a 0a73 7472 7563 7420 6767  lt;.}..struct gg
+00032990: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+000329a0: 5f72 6f70 6528 0a20 2020 2020 2020 2073  _rope(.        s
+000329b0: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+000329c0: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+000329d0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+000329e0: 6e73 6f72 2020 2a20 612c 0a20 2020 2020  nsor  * a,.     
+000329f0: 2020 2069 6e74 2020 2020 2020 2020 2020     int          
+00032a00: 2020 2020 2020 2020 206e 5f70 6173 742c           n_past,
+00032a10: 0a20 2020 2020 2020 2069 6e74 2020 2020  .        int    
+00032a20: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00032a30: 5f64 696d 732c 0a20 2020 2020 2020 2069  _dims,.        i
+00032a40: 6e74 2020 2020 2020 2020 2020 2020 2020  nt              
+00032a50: 2020 2020 206d 6f64 6529 207b 0a20 2020       mode) {.   
+00032a60: 2072 6574 7572 6e20 6767 6d6c 5f72 6f70   return ggml_rop
+00032a70: 655f 696d 706c 2863 7478 2c20 612c 206e  e_impl(ctx, a, n
+00032a80: 5f70 6173 742c 206e 5f64 696d 732c 206d  _past, n_dims, m
+00032a90: 6f64 652c 2066 616c 7365 293b 0a7d 0a0a  ode, false);.}..
+00032aa0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00032ab0: 6f72 202a 2067 676d 6c5f 726f 7065 5f69  or * ggml_rope_i
+00032ac0: 6e70 6c61 6365 280a 2020 2020 2020 2020  nplace(.        
+00032ad0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+00032ae0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+00032af0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00032b00: 656e 736f 7220 202a 2061 2c0a 2020 2020  ensor  * a,.    
+00032b10: 2020 2020 696e 7420 2020 2020 2020 2020      int         
+00032b20: 2020 2020 2020 2020 2020 6e5f 7061 7374            n_past
+00032b30: 2c0a 2020 2020 2020 2020 696e 7420 2020  ,.        int   
+00032b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b50: 6e5f 6469 6d73 2c0a 2020 2020 2020 2020  n_dims,.        
+00032b60: 696e 7420 2020 2020 2020 2020 2020 2020  int             
+00032b70: 2020 2020 2020 6d6f 6465 2920 7b0a 2020        mode) {.  
+00032b80: 2020 7265 7475 726e 2067 676d 6c5f 726f    return ggml_ro
+00032b90: 7065 5f69 6d70 6c28 6374 782c 2061 2c20  pe_impl(ctx, a, 
+00032ba0: 6e5f 7061 7374 2c20 6e5f 6469 6d73 2c20  n_past, n_dims, 
+00032bb0: 6d6f 6465 2c20 7472 7565 293b 0a7d 0a0a  mode, true);.}..
+00032bc0: 2f2f 2067 676d 6c5f 726f 7065 5f62 6163  // ggml_rope_bac
+00032bd0: 6b0a 0a73 7472 7563 7420 6767 6d6c 5f74  k..struct ggml_t
+00032be0: 656e 736f 7220 2a20 6767 6d6c 5f72 6f70  ensor * ggml_rop
+00032bf0: 655f 6261 636b 280a 2020 2020 2020 2020  e_back(.        
+00032c00: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+00032c10: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
+00032c20: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00032c30: 656e 736f 7220 202a 2061 2c0a 2020 2020  ensor  * a,.    
+00032c40: 2020 2020 696e 7420 2020 2020 2020 2020      int         
+00032c50: 2020 2020 2020 2020 2020 6e5f 7061 7374            n_past
+00032c60: 2c0a 2020 2020 2020 2020 696e 7420 2020  ,.        int   
+00032c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032c80: 6e5f 6469 6d73 2c0a 2020 2020 2020 2020  n_dims,.        
+00032c90: 696e 7420 2020 2020 2020 2020 2020 2020  int             
+00032ca0: 2020 2020 2020 6d6f 6465 2920 7b0a 2020        mode) {.  
+00032cb0: 2020 4747 4d4c 5f41 5353 4552 5428 6e5f    GGML_ASSERT(n_
+00032cc0: 7061 7374 203e 3d20 3029 3b0a 2020 2020  past >= 0);.    
+00032cd0: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
+00032ce0: 616c 7365 3b0a 0a20 2020 2069 6620 2861  alse;..    if (a
+00032cf0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00032d00: 2020 6973 5f6e 6f64 6520 3d20 6661 6c73    is_node = fals
+00032d10: 653b 202f 2f20 544f 444f 3a20 696d 706c  e; // TODO: impl
+00032d20: 656d 656e 7420 6261 636b 7761 7264 0a20  ement backward. 
+00032d30: 2020 207d 0a0a 2020 2020 7374 7275 6374     }..    struct
+00032d40: 2067 676d 6c5f 7465 6e73 6f72 202a 2072   ggml_tensor * r
+00032d50: 6573 756c 7420 3d20 6767 6d6c 5f64 7570  esult = ggml_dup
+00032d60: 5f74 656e 736f 7228 6374 782c 2061 293b  _tensor(ctx, a);
+00032d70: 0a0a 2020 2020 6767 6d6c 5f73 6372 6174  ..    ggml_scrat
+00032d80: 6368 5f73 6176 6528 6374 7829 3b0a 0a20  ch_save(ctx);.. 
+00032d90: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00032da0: 656e 736f 7220 2a20 6220 3d20 6767 6d6c  ensor * b = ggml
+00032db0: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
+00032dc0: 7478 2c20 4747 4d4c 5f54 5950 455f 4933  tx, GGML_TYPE_I3
+00032dd0: 322c 2033 293b 0a20 2020 2067 676d 6c5f  2, 3);.    ggml_
+00032de0: 7365 745f 6e61 6d65 2862 2c20 226e 5f70  set_name(b, "n_p
+00032df0: 6173 742c 206e 5f64 696d 732c 206d 6f64  ast, n_dims, mod
+00032e00: 6522 293b 0a0a 2020 2020 2828 696e 7433  e");..    ((int3
+00032e10: 325f 7420 2a29 2062 2d3e 6461 7461 295b  2_t *) b->data)[
+00032e20: 305d 203d 206e 5f70 6173 743b 0a20 2020  0] = n_past;.   
+00032e30: 2028 2869 6e74 3332 5f74 202a 2920 622d   ((int32_t *) b-
+00032e40: 3e64 6174 6129 5b31 5d20 3d20 6e5f 6469  >data)[1] = n_di
+00032e50: 6d73 3b0a 2020 2020 2828 696e 7433 325f  ms;.    ((int32_
+00032e60: 7420 2a29 2062 2d3e 6461 7461 295b 325d  t *) b->data)[2]
+00032e70: 203d 206d 6f64 653b 0a0a 2020 2020 6767   = mode;..    gg
+00032e80: 6d6c 5f73 6372 6174 6368 5f6c 6f61 6428  ml_scratch_load(
+00032e90: 6374 7829 3b0a 0a20 2020 2072 6573 756c  ctx);..    resul
+00032ea0: 742d 3e6f 7020 2020 3d20 4747 4d4c 5f4f  t->op   = GGML_O
+00032eb0: 505f 524f 5045 5f42 4143 4b3b 0a20 2020  P_ROPE_BACK;.   
+00032ec0: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
+00032ed0: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
+00032ee0: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
+00032ef0: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
+00032f00: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
+00032f10: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
+00032f20: 3e73 7263 3120 3d20 623b 0a0a 2020 2020  >src1 = b;..    
+00032f30: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+00032f40: 0a0a 2f2f 2067 676d 6c5f 616c 6962 690a  ..// ggml_alibi.
+00032f50: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
+00032f60: 736f 7220 2a20 6767 6d6c 5f61 6c69 6269  sor * ggml_alibi
+00032f70: 280a 2020 2020 2020 2020 7374 7275 6374  (.        struct
+00032f80: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
+00032f90: 6374 782c 0a20 2020 2020 2020 2073 7472  ctx,.        str
+00032fa0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00032fb0: 202a 2061 2c0a 2020 2020 2020 2020 696e   * a,.        in
+00032fc0: 7420 2020 2020 2020 2020 2020 2020 2020  t               
+00032fd0: 2020 2020 6e5f 7061 7374 2c0a 2020 2020      n_past,.    
+00032fe0: 2020 2020 696e 7420 2020 2020 2020 2020      int         
+00032ff0: 2020 2020 2020 2020 2020 6e5f 6865 6164            n_head
+00033000: 2c0a 2020 2020 2020 2020 666c 6f61 7420  ,.        float 
+00033010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033020: 6269 6173 5f6d 6178 2920 7b0a 2020 2020  bias_max) {.    
+00033030: 4747 4d4c 5f41 5353 4552 5428 6e5f 7061  GGML_ASSERT(n_pa
+00033040: 7374 203e 3d20 3029 3b0a 2020 2020 626f  st >= 0);.    bo
+00033050: 6f6c 2069 735f 6e6f 6465 203d 2066 616c  ol is_node = fal
+00033060: 7365 3b0a 0a20 2020 2069 6620 2861 2d3e  se;..    if (a->
+00033070: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00033080: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00033090: 6529 3b20 2f2f 2054 4f44 4f3a 2069 6d70  e); // TODO: imp
+000330a0: 6c65 6d65 6e74 2062 6163 6b77 6172 640a  lement backward.
+000330b0: 2020 2020 2020 2020 6973 5f6e 6f64 6520          is_node 
+000330c0: 3d20 7472 7565 3b0a 2020 2020 7d0a 0a20  = true;.    }.. 
+000330d0: 2020 202f 2f20 544f 444f 3a20 7768 656e     // TODO: when
+000330e0: 2069 6d70 6c65 6d65 6e74 2062 6163 6b77   implement backw
+000330f0: 6172 642c 2066 6978 2074 6869 733a 0a20  ard, fix this:. 
+00033100: 2020 202f 2f73 7472 7563 7420 6767 6d6c     //struct ggml
+00033110: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
+00033120: 203d 2069 6e70 6c61 6365 203f 2067 676d   = inplace ? ggm
+00033130: 6c5f 7669 6577 5f74 656e 736f 7228 6374  l_view_tensor(ct
+00033140: 782c 2061 2920 3a20 6767 6d6c 5f64 7570  x, a) : ggml_dup
+00033150: 5f74 656e 736f 7228 6374 782c 2061 293b  _tensor(ctx, a);
+00033160: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00033170: 5f74 656e 736f 7220 2a20 7265 7375 6c74  _tensor * result
+00033180: 203d 2067 676d 6c5f 7669 6577 5f74 656e   = ggml_view_ten
+00033190: 736f 7228 6374 782c 2061 293b 0a0a 2020  sor(ctx, a);..  
+000331a0: 2020 6767 6d6c 5f73 6372 6174 6368 5f73    ggml_scratch_s
+000331b0: 6176 6528 6374 7829 3b0a 0a20 2020 2073  ave(ctx);..    s
+000331c0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000331d0: 7220 2a20 6220 3d20 6767 6d6c 5f6e 6577  r * b = ggml_new
+000331e0: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
+000331f0: 4747 4d4c 5f54 5950 455f 4933 322c 2033  GGML_TYPE_I32, 3
+00033200: 293b 0a0a 2020 2020 2828 696e 7433 325f  );..    ((int32_
+00033210: 7420 2a29 2062 2d3e 6461 7461 295b 305d  t *) b->data)[0]
+00033220: 203d 206e 5f70 6173 743b 0a20 2020 2028   = n_past;.    (
+00033230: 2869 6e74 3332 5f74 202a 2920 622d 3e64  (int32_t *) b->d
+00033240: 6174 6129 5b31 5d20 3d20 6e5f 6865 6164  ata)[1] = n_head
+00033250: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00033260: 5428 7369 7a65 6f66 2866 6c6f 6174 2920  T(sizeof(float) 
+00033270: 3d3d 2073 697a 656f 6628 696e 7433 325f  == sizeof(int32_
+00033280: 7429 293b 0a20 2020 2028 2828 666c 6f61  t));.    (((floa
+00033290: 7420 2a29 2062 2d3e 6461 7461 295b 325d  t *) b->data)[2]
+000332a0: 2920 3d20 6269 6173 5f6d 6178 3b0a 0a20  ) = bias_max;.. 
+000332b0: 2020 2067 676d 6c5f 7363 7261 7463 685f     ggml_scratch_
+000332c0: 6c6f 6164 2863 7478 293b 0a0a 2020 2020  load(ctx);..    
+000332d0: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+000332e0: 474d 4c5f 4f50 5f41 4c49 4249 3b0a 2020  GML_OP_ALIBI;.  
+000332f0: 2020 7265 7375 6c74 2d3e 6772 6164 203d    result->grad =
+00033300: 2069 735f 6e6f 6465 203f 2067 676d 6c5f   is_node ? ggml_
+00033310: 6475 705f 7465 6e73 6f72 2863 7478 2c20  dup_tensor(ctx, 
+00033320: 7265 7375 6c74 2920 3a20 4e55 4c4c 3b0a  result) : NULL;.
+00033330: 2020 2020 7265 7375 6c74 2d3e 7372 6330      result->src0
+00033340: 203d 2061 3b0a 2020 2020 7265 7375 6c74   = a;.    result
+00033350: 2d3e 7372 6331 203d 2062 3b0a 0a20 2020  ->src1 = b;..   
+00033360: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+00033370: 7d0a 0a2f 2f20 6767 6d6c 5f63 6c61 6d70  }..// ggml_clamp
+00033380: 0a0a 7374 7275 6374 2067 676d 6c5f 7465  ..struct ggml_te
+00033390: 6e73 6f72 202a 2067 676d 6c5f 636c 616d  nsor * ggml_clam
+000333a0: 7028 0a20 2020 2020 2020 2073 7472 7563  p(.        struc
+000333b0: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
+000333c0: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+000333d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000333e0: 2020 2a20 612c 0a20 2020 2020 2020 2066    * a,.        f
+000333f0: 6c6f 6174 2020 2020 2020 2020 2020 2020  loat            
+00033400: 2020 2020 206d 696e 2c0a 2020 2020 2020       min,.      
+00033410: 2020 666c 6f61 7420 2020 2020 2020 2020    float         
+00033420: 2020 2020 2020 2020 6d61 7829 207b 0a20          max) {. 
+00033430: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
+00033440: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
+00033450: 2028 612d 3e67 7261 6429 207b 0a20 2020   (a->grad) {.   
+00033460: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00033470: 2866 616c 7365 293b 202f 2f20 544f 444f  (false); // TODO
+00033480: 3a20 696d 706c 656d 656e 7420 6261 636b  : implement back
+00033490: 7761 7264 0a20 2020 2020 2020 2069 735f  ward.        is_
+000334a0: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+000334b0: 207d 0a0a 2020 2020 2f2f 2054 4f44 4f3a   }..    // TODO:
+000334c0: 2077 6865 6e20 696d 706c 656d 656e 7420   when implement 
+000334d0: 6261 636b 7761 7264 2c20 6669 7820 7468  backward, fix th
+000334e0: 6973 3a0a 2020 2020 7374 7275 6374 2067  is:.    struct g
+000334f0: 676d 6c5f 7465 6e73 6f72 202a 2072 6573  gml_tensor * res
+00033500: 756c 7420 3d20 6767 6d6c 5f76 6965 775f  ult = ggml_view_
+00033510: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
+00033520: 0a20 2020 2067 676d 6c5f 7363 7261 7463  .    ggml_scratc
+00033530: 685f 7361 7665 2863 7478 293b 0a0a 2020  h_save(ctx);..  
+00033540: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00033550: 6e73 6f72 202a 2062 203d 2067 676d 6c5f  nsor * b = ggml_
+00033560: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
+00033570: 782c 2047 474d 4c5f 5459 5045 5f49 3332  x, GGML_TYPE_I32
+00033580: 2c20 3329 3b0a 0a20 2020 2028 2866 6c6f  , 3);..    ((flo
+00033590: 6174 202a 2920 622d 3e64 6174 6129 5b30  at *) b->data)[0
+000335a0: 5d20 3d20 6d69 6e3b 0a20 2020 2028 2866  ] = min;.    ((f
+000335b0: 6c6f 6174 202a 2920 622d 3e64 6174 6129  loat *) b->data)
+000335c0: 5b31 5d20 3d20 6d61 783b 0a0a 2020 2020  [1] = max;..    
+000335d0: 6767 6d6c 5f73 6372 6174 6368 5f6c 6f61  ggml_scratch_loa
+000335e0: 6428 6374 7829 3b0a 0a20 2020 2072 6573  d(ctx);..    res
+000335f0: 756c 742d 3e6f 7020 2020 3d20 4747 4d4c  ult->op   = GGML
+00033600: 5f4f 505f 434c 414d 503b 0a20 2020 2072  _OP_CLAMP;.    r
+00033610: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
+00033620: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
+00033630: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
+00033640: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
+00033650: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
+00033660: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
+00033670: 7263 3120 3d20 623b 0a0a 2020 2020 7265  rc1 = b;..    re
+00033680: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+00033690: 2f2f 2067 676d 6c5f 636f 6e76 5f31 645f  // ggml_conv_1d_
+000336a0: 3173 0a0a 7374 7275 6374 2067 676d 6c5f  1s..struct ggml_
+000336b0: 7465 6e73 6f72 202a 2067 676d 6c5f 636f  tensor * ggml_co
+000336c0: 6e76 5f31 645f 3173 280a 2020 2020 2020  nv_1d_1s(.      
+000336d0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+000336e0: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+000336f0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00033700: 5f74 656e 736f 7220 202a 2061 2c0a 2020  _tensor  * a,.  
+00033710: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00033720: 6c5f 7465 6e73 6f72 2020 2a20 6229 207b  l_tensor  * b) {
+00033730: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00033740: 2867 676d 6c5f 6973 5f6d 6174 7269 7828  (ggml_is_matrix(
+00033750: 6229 293b 0a20 2020 2047 474d 4c5f 4153  b));.    GGML_AS
+00033760: 5345 5254 2861 2d3e 6e65 5b31 5d20 3d3d  SERT(a->ne[1] ==
+00033770: 2062 2d3e 6e65 5b31 5d29 3b0a 2020 2020   b->ne[1]);.    
+00033780: 4747 4d4c 5f41 5353 4552 5428 612d 3e6e  GGML_ASSERT(a->n
+00033790: 655b 335d 203d 3d20 3129 3b0a 2020 2020  e[3] == 1);.    
+000337a0: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
+000337b0: 616c 7365 3b0a 0a20 2020 2069 6620 2861  alse;..    if (a
+000337c0: 2d3e 6772 6164 207c 7c20 622d 3e67 7261  ->grad || b->gra
+000337d0: 6429 207b 0a20 2020 2020 2020 2047 474d  d) {.        GGM
+000337e0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+000337f0: 202f 2f20 544f 444f 3a20 696d 706c 656d   // TODO: implem
+00033800: 656e 7420 6261 636b 7761 7264 0a20 2020  ent backward.   
+00033810: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
+00033820: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
+00033830: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00033840: 5b34 5d20 3d20 7b20 622d 3e6e 655b 305d  [4] = { b->ne[0]
+00033850: 2c20 612d 3e6e 655b 325d 2c20 312c 2031  , a->ne[2], 1, 1
+00033860: 2c20 7d3b 0a20 2020 2073 7472 7563 7420  , };.    struct 
+00033870: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
+00033880: 7375 6c74 203d 2067 676d 6c5f 6e65 775f  sult = ggml_new_
+00033890: 7465 6e73 6f72 2863 7478 2c20 4747 4d4c  tensor(ctx, GGML
+000338a0: 5f54 5950 455f 4633 322c 2032 2c20 6e65  _TYPE_F32, 2, ne
+000338b0: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
+000338c0: 6f70 2020 203d 2047 474d 4c5f 4f50 5f43  op   = GGML_OP_C
+000338d0: 4f4e 565f 3144 5f31 533b 0a20 2020 2072  ONV_1D_1S;.    r
+000338e0: 6573 756c 742d 3e67 7261 6420 3d20 6973  esult->grad = is
+000338f0: 5f6e 6f64 6520 3f20 6767 6d6c 5f64 7570  _node ? ggml_dup
+00033900: 5f74 656e 736f 7228 6374 782c 2072 6573  _tensor(ctx, res
+00033910: 756c 7429 203a 204e 554c 4c3b 0a20 2020  ult) : NULL;.   
+00033920: 2072 6573 756c 742d 3e73 7263 3020 3d20   result->src0 = 
+00033930: 613b 0a20 2020 2072 6573 756c 742d 3e73  a;.    result->s
+00033940: 7263 3120 3d20 623b 0a0a 2020 2020 7265  rc1 = b;..    re
+00033950: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+00033960: 2f2f 2067 676d 6c5f 636f 6e76 5f31 645f  // ggml_conv_1d_
+00033970: 3273 0a0a 7374 7275 6374 2067 676d 6c5f  2s..struct ggml_
+00033980: 7465 6e73 6f72 202a 2067 676d 6c5f 636f  tensor * ggml_co
+00033990: 6e76 5f31 645f 3273 280a 2020 2020 2020  nv_1d_2s(.      
+000339a0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+000339b0: 6e74 6578 7420 2a20 6374 782c 0a20 2020  ntext * ctx,.   
+000339c0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+000339d0: 5f74 656e 736f 7220 202a 2061 2c0a 2020  _tensor  * a,.  
+000339e0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+000339f0: 6c5f 7465 6e73 6f72 2020 2a20 6229 207b  l_tensor  * b) {
+00033a00: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00033a10: 2867 676d 6c5f 6973 5f6d 6174 7269 7828  (ggml_is_matrix(
+00033a20: 6229 293b 0a20 2020 2047 474d 4c5f 4153  b));.    GGML_AS
+00033a30: 5345 5254 2861 2d3e 6e65 5b31 5d20 3d3d  SERT(a->ne[1] ==
+00033a40: 2062 2d3e 6e65 5b31 5d29 3b0a 2020 2020   b->ne[1]);.    
+00033a50: 4747 4d4c 5f41 5353 4552 5428 612d 3e6e  GGML_ASSERT(a->n
+00033a60: 655b 335d 203d 3d20 3129 3b0a 2020 2020  e[3] == 1);.    
+00033a70: 626f 6f6c 2069 735f 6e6f 6465 203d 2066  bool is_node = f
+00033a80: 616c 7365 3b0a 0a20 2020 2069 6620 2861  alse;..    if (a
+00033a90: 2d3e 6772 6164 207c 7c20 622d 3e67 7261  ->grad || b->gra
+00033aa0: 6429 207b 0a20 2020 2020 2020 2047 474d  d) {.        GGM
+00033ab0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+00033ac0: 202f 2f20 544f 444f 3a20 696d 706c 656d   // TODO: implem
+00033ad0: 656e 7420 6261 636b 7761 7264 0a20 2020  ent backward.   
+00033ae0: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
+00033af0: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
+00033b00: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00033b10: 5b34 5d20 3d20 7b20 622d 3e6e 655b 305d  [4] = { b->ne[0]
+00033b20: 2f32 2c20 612d 3e6e 655b 325d 2c20 312c  /2, a->ne[2], 1,
+00033b30: 2031 2c20 7d3b 0a20 2020 2073 7472 7563   1, };.    struc
+00033b40: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00033b50: 7265 7375 6c74 203d 2067 676d 6c5f 6e65  result = ggml_ne
+00033b60: 775f 7465 6e73 6f72 2863 7478 2c20 4747  w_tensor(ctx, GG
+00033b70: 4d4c 5f54 5950 455f 4633 322c 2032 2c20  ML_TYPE_F32, 2, 
+00033b80: 6e65 293b 0a0a 2020 2020 7265 7375 6c74  ne);..    result
+00033b90: 2d3e 6f70 2020 203d 2047 474d 4c5f 4f50  ->op   = GGML_OP
+00033ba0: 5f43 4f4e 565f 3144 5f32 533b 0a20 2020  _CONV_1D_2S;.   
+00033bb0: 2072 6573 756c 742d 3e67 7261 6420 3d20   result->grad = 
+00033bc0: 6973 5f6e 6f64 6520 3f20 6767 6d6c 5f64  is_node ? ggml_d
+00033bd0: 7570 5f74 656e 736f 7228 6374 782c 2072  up_tensor(ctx, r
+00033be0: 6573 756c 7429 203a 204e 554c 4c3b 0a20  esult) : NULL;. 
+00033bf0: 2020 2072 6573 756c 742d 3e73 7263 3020     result->src0 
+00033c00: 3d20 613b 0a20 2020 2072 6573 756c 742d  = a;.    result-
+00033c10: 3e73 7263 3120 3d20 623b 0a0a 2020 2020  >src1 = b;..    
+00033c20: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+00033c30: 0a0a 2f2f 2067 676d 6c5f 666c 6173 685f  ..// ggml_flash_
+00033c40: 6174 746e 0a0a 7374 7275 6374 2067 676d  attn..struct ggm
+00033c50: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+00033c60: 666c 6173 685f 6174 746e 280a 2020 2020  flash_attn(.    
+00033c70: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00033c80: 636f 6e74 6578 7420 2a20 6374 782c 0a20  context * ctx,. 
+00033c90: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00033ca0: 6d6c 5f74 656e 736f 7220 202a 2071 2c0a  ml_tensor  * q,.
+00033cb0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00033cc0: 676d 6c5f 7465 6e73 6f72 2020 2a20 6b2c  gml_tensor  * k,
+00033cd0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00033ce0: 6767 6d6c 5f74 656e 736f 7220 202a 2076  ggml_tensor  * v
+00033cf0: 2c0a 2020 2020 2020 2020 626f 6f6c 2020  ,.        bool  
+00033d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033d10: 6d61 736b 6564 2920 7b0a 2020 2020 4747  masked) {.    GG
+00033d20: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f63  ML_ASSERT(ggml_c
+00033d30: 616e 5f6d 756c 5f6d 6174 286b 2c20 7129  an_mul_mat(k, q)
+00033d40: 293b 0a20 2020 202f 2f20 544f 444f 3a20  );.    // TODO: 
+00033d50: 6368 6563 6b20 6966 2076 5420 6361 6e20  check if vT can 
+00033d60: 6265 206d 756c 7469 706c 6965 6420 6279  be multiplied by
+00033d70: 2028 6b2a 7154 290a 0a20 2020 2062 6f6f   (k*qT)..    boo
+00033d80: 6c20 6973 5f6e 6f64 6520 3d20 6661 6c73  l is_node = fals
+00033d90: 653b 0a0a 2020 2020 6966 2028 712d 3e67  e;..    if (q->g
+00033da0: 7261 6420 7c7c 206b 2d3e 6772 6164 207c  rad || k->grad |
+00033db0: 7c20 762d 3e67 7261 6429 207b 0a20 2020  | v->grad) {.   
+00033dc0: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
+00033dd0: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
+00033de0: 2f2f 7374 7275 6374 2067 676d 6c5f 7465  //struct ggml_te
+00033df0: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
+00033e00: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00033e10: 6374 782c 2071 293b 0a20 2020 2073 7472  ctx, q);.    str
+00033e20: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00033e30: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+00033e40: 6e65 775f 7465 6e73 6f72 2863 7478 2c20  new_tensor(ctx, 
+00033e50: 4747 4d4c 5f54 5950 455f 4633 322c 2034  GGML_TYPE_F32, 4
+00033e60: 2c20 712d 3e6e 6529 3b0a 0a20 2020 2072  , q->ne);..    r
+00033e70: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
+00033e80: 4d4c 5f4f 505f 464c 4153 485f 4154 544e  ML_OP_FLASH_ATTN
+00033e90: 3b0a 2020 2020 7265 7375 6c74 2d3e 6772  ;.    result->gr
+00033ea0: 6164 203d 2069 735f 6e6f 6465 203f 2067  ad = is_node ? g
+00033eb0: 676d 6c5f 6475 705f 7465 6e73 6f72 2863  gml_dup_tensor(c
+00033ec0: 7478 2c20 7265 7375 6c74 2920 3a20 4e55  tx, result) : NU
+00033ed0: 4c4c 3b0a 2020 2020 7265 7375 6c74 2d3e  LL;.    result->
+00033ee0: 7372 6330 203d 2071 3b0a 2020 2020 7265  src0 = q;.    re
+00033ef0: 7375 6c74 2d3e 7372 6331 203d 206b 3b0a  sult->src1 = k;.
+00033f00: 2020 2020 7265 7375 6c74 2d3e 6f70 745b      result->opt[
+00033f10: 305d 203d 2076 3b0a 2020 2020 7265 7375  0] = v;.    resu
+00033f20: 6c74 2d3e 6f70 745b 315d 203d 2067 676d  lt->opt[1] = ggm
+00033f30: 6c5f 6e65 775f 6933 3228 6374 782c 206d  l_new_i32(ctx, m
+00033f40: 6173 6b65 6420 3f20 3120 3a20 3029 3b0a  asked ? 1 : 0);.
+00033f50: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+00033f60: 6c74 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f66  lt;.}..// ggml_f
+00033f70: 6c61 7368 5f66 660a 0a73 7472 7563 7420  lash_ff..struct 
+00033f80: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+00033f90: 6d6c 5f66 6c61 7368 5f66 6628 0a20 2020  ml_flash_ff(.   
+00033fa0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00033fb0: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+00033fc0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00033fd0: 676d 6c5f 7465 6e73 6f72 2020 2a20 612c  gml_tensor  * a,
+00033fe0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00033ff0: 6767 6d6c 5f74 656e 736f 7220 202a 2062  ggml_tensor  * b
+00034000: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
+00034010: 7420 6767 6d6c 5f74 656e 736f 7220 202a  t ggml_tensor  *
+00034020: 2062 312c 0a20 2020 2020 2020 2073 7472   b1,.        str
+00034030: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00034040: 202a 2063 302c 0a20 2020 2020 2020 2073   * c0,.        s
+00034050: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00034060: 7220 202a 2063 3129 207b 0a20 2020 2047  r  * c1) {.    G
+00034070: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+00034080: 6361 6e5f 6d75 6c5f 6d61 7428 6230 2c20  can_mul_mat(b0, 
+00034090: 6129 293b 0a20 2020 202f 2f20 544f 444f  a));.    // TODO
+000340a0: 3a20 6d6f 7265 2063 6865 636b 730a 0a20  : more checks.. 
+000340b0: 2020 2062 6f6f 6c20 6973 5f6e 6f64 6520     bool is_node 
+000340c0: 3d20 6661 6c73 653b 0a0a 2020 2020 6966  = false;..    if
+000340d0: 2028 612d 3e67 7261 6420 7c7c 2062 302d   (a->grad || b0-
+000340e0: 3e67 7261 6420 7c7c 2062 312d 3e67 7261  >grad || b1->gra
+000340f0: 6420 7c7c 2063 302d 3e67 7261 6420 7c7c  d || c0->grad ||
+00034100: 2063 312d 3e67 7261 6429 207b 0a20 2020   c1->grad) {.   
+00034110: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
+00034120: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
+00034130: 2f2f 7374 7275 6374 2067 676d 6c5f 7465  //struct ggml_te
+00034140: 6e73 6f72 202a 2072 6573 756c 7420 3d20  nsor * result = 
+00034150: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00034160: 6374 782c 2061 293b 0a20 2020 2073 7472  ctx, a);.    str
+00034170: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00034180: 2a20 7265 7375 6c74 203d 2067 676d 6c5f  * result = ggml_
+00034190: 6e65 775f 7465 6e73 6f72 2863 7478 2c20  new_tensor(ctx, 
+000341a0: 4747 4d4c 5f54 5950 455f 4633 322c 2034  GGML_TYPE_F32, 4
+000341b0: 2c20 612d 3e6e 6529 3b0a 0a20 2020 2072  , a->ne);..    r
+000341c0: 6573 756c 742d 3e6f 7020 2020 3d20 4747  esult->op   = GG
+000341d0: 4d4c 5f4f 505f 464c 4153 485f 4646 3b0a  ML_OP_FLASH_FF;.
+000341e0: 2020 2020 7265 7375 6c74 2d3e 6772 6164      result->grad
+000341f0: 203d 2069 735f 6e6f 6465 203f 2067 676d   = is_node ? ggm
+00034200: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
+00034210: 2c20 7265 7375 6c74 2920 3a20 4e55 4c4c  , result) : NULL
+00034220: 3b0a 2020 2020 7265 7375 6c74 2d3e 7372  ;.    result->sr
+00034230: 6330 203d 2061 3b0a 2020 2020 7265 7375  c0 = a;.    resu
+00034240: 6c74 2d3e 7372 6331 203d 2062 303b 0a20  lt->src1 = b0;. 
+00034250: 2020 2072 6573 756c 742d 3e6f 7074 5b30     result->opt[0
+00034260: 5d20 3d20 6231 3b0a 2020 2020 7265 7375  ] = b1;.    resu
+00034270: 6c74 2d3e 6f70 745b 315d 203d 2063 303b  lt->opt[1] = c0;
+00034280: 0a20 2020 2072 6573 756c 742d 3e6f 7074  .    result->opt
+00034290: 5b32 5d20 3d20 6331 3b0a 0a20 2020 2072  [2] = c1;..    r
+000342a0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
+000342b0: 0a2f 2f20 6767 6d6c 5f66 6c61 7368 5f61  .// ggml_flash_a
+000342c0: 7474 6e5f 6261 636b 0a0a 7374 7275 6374  ttn_back..struct
+000342d0: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+000342e0: 676d 6c5f 666c 6173 685f 6174 746e 5f62  gml_flash_attn_b
+000342f0: 6163 6b28 0a20 2020 2020 2020 2073 7472  ack(.        str
+00034300: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00034310: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+00034320: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00034330: 6f72 2020 2a20 712c 0a20 2020 2020 2020  or  * q,.       
+00034340: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00034350: 736f 7220 202a 206b 2c0a 2020 2020 2020  sor  * k,.      
+00034360: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00034370: 6e73 6f72 2020 2a20 762c 0a20 2020 2020  nsor  * v,.     
+00034380: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00034390: 656e 736f 7220 202a 2064 2c0a 2020 2020  ensor  * d,.    
+000343a0: 2020 2020 626f 6f6c 2020 2020 2020 2020      bool        
+000343b0: 2020 2020 2020 2020 2020 6d61 736b 6564            masked
+000343c0: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+000343d0: 4552 5428 6767 6d6c 5f63 616e 5f6d 756c  ERT(ggml_can_mul
+000343e0: 5f6d 6174 286b 2c20 7129 293b 0a20 2020  _mat(k, q));.   
+000343f0: 202f 2f20 544f 444f 3a20 6368 6563 6b20   // TODO: check 
+00034400: 6966 2076 5420 6361 6e20 6265 206d 756c  if vT can be mul
+00034410: 7469 706c 6965 6420 6279 2028 6b2a 7154  tiplied by (k*qT
+00034420: 290a 0a20 2020 202f 2f20 6420 7368 6170  )..    // d shap
+00034430: 6520 5b44 2c4e 2c6e 6532 2c6e 6533 5d0a  e [D,N,ne2,ne3].
+00034440: 2020 2020 2f2f 2071 2073 6861 7065 205b      // q shape [
+00034450: 442c 4e2c 6e65 322c 6e65 335d 0a20 2020  D,N,ne2,ne3].   
+00034460: 202f 2f20 6b20 7368 6170 6520 5b44 2c4d   // k shape [D,M
+00034470: 2c6e 6532 2c6e 6533 5d0a 2020 2020 2f2f  ,ne2,ne3].    //
+00034480: 2076 2073 6861 7065 205b 4d2c 442c 6e65   v shape [M,D,ne
+00034490: 322c 6e65 335d 0a0a 2020 2020 636f 6e73  2,ne3]..    cons
+000344a0: 7420 696e 7436 345f 7420 2020 4420 3d20  t int64_t   D = 
+000344b0: 712d 3e6e 655b 305d 3b0a 2020 2020 636f  q->ne[0];.    co
+000344c0: 6e73 7420 696e 7436 345f 7420 2020 4e20  nst int64_t   N 
+000344d0: 3d20 712d 3e6e 655b 315d 3b0a 2020 2020  = q->ne[1];.    
+000344e0: 636f 6e73 7420 696e 7436 345f 7420 2020  const int64_t   
+000344f0: 4d20 3d20 6b2d 3e6e 655b 315d 3b0a 2020  M = k->ne[1];.  
+00034500: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00034510: 6e65 3220 3d20 712d 3e6e 655b 325d 3b0a  ne2 = q->ne[2];.
+00034520: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00034530: 7420 6e65 3320 3d20 712d 3e6e 655b 335d  t ne3 = q->ne[3]
+00034540: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00034550: 5254 286b 2d3e 6e65 5b30 5d20 3d3d 2044  RT(k->ne[0] == D
+00034560: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00034570: 5254 2876 2d3e 6e65 5b30 5d20 3d3d 204d  RT(v->ne[0] == M
+00034580: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00034590: 5254 2876 2d3e 6e65 5b31 5d20 3d3d 2044  RT(v->ne[1] == D
+000345a0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+000345b0: 5254 2864 2d3e 6e65 5b30 5d20 3d3d 2044  RT(d->ne[0] == D
+000345c0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+000345d0: 5254 2864 2d3e 6e65 5b31 5d20 3d3d 204e  RT(d->ne[1] == N
+000345e0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+000345f0: 5254 286b 2d3e 6e65 5b32 5d20 3d3d 206e  RT(k->ne[2] == n
+00034600: 6532 293b 0a20 2020 2047 474d 4c5f 4153  e2);.    GGML_AS
+00034610: 5345 5254 286b 2d3e 6e65 5b33 5d20 3d3d  SERT(k->ne[3] ==
+00034620: 206e 6533 293b 0a20 2020 2047 474d 4c5f   ne3);.    GGML_
+00034630: 4153 5345 5254 2876 2d3e 6e65 5b32 5d20  ASSERT(v->ne[2] 
+00034640: 3d3d 206e 6532 293b 0a20 2020 2047 474d  == ne2);.    GGM
+00034650: 4c5f 4153 5345 5254 2876 2d3e 6e65 5b33  L_ASSERT(v->ne[3
+00034660: 5d20 3d3d 206e 6533 293b 0a20 2020 2047  ] == ne3);.    G
+00034670: 474d 4c5f 4153 5345 5254 2864 2d3e 6e65  GML_ASSERT(d->ne
+00034680: 5b32 5d20 3d3d 206e 6532 293b 0a20 2020  [2] == ne2);.   
+00034690: 2047 474d 4c5f 4153 5345 5254 2864 2d3e   GGML_ASSERT(d->
+000346a0: 6e65 5b33 5d20 3d3d 206e 6533 293b 0a0a  ne[3] == ne3);..
+000346b0: 2020 2020 626f 6f6c 2069 735f 6e6f 6465      bool is_node
+000346c0: 203d 2066 616c 7365 3b0a 0a20 2020 2069   = false;..    i
+000346d0: 6620 2871 2d3e 6772 6164 207c 7c20 6b2d  f (q->grad || k-
+000346e0: 3e67 7261 6420 7c7c 2076 2d3e 6772 6164  >grad || v->grad
+000346f0: 2920 7b0a 2020 2020 2020 2020 2f2f 2077  ) {.        // w
+00034700: 6865 6e20 7573 696e 6720 7468 6973 206f  hen using this o
+00034710: 7065 7261 7469 6f6e 2028 696e 2062 6163  peration (in bac
+00034720: 6b77 6172 6473 2070 6173 7329 2074 6865  kwards pass) the
+00034730: 7365 2067 7261 6473 2061 7265 2073 6574  se grads are set
+00034740: 2e0a 2020 2020 2020 2020 2f2f 2077 6520  ..        // we 
+00034750: 646f 6e27 7420 7761 6e74 2074 6f20 6372  don't want to cr
+00034760: 6561 7465 2028 6269 6729 2067 7261 6420  eate (big) grad 
+00034770: 6f66 206f 7572 2072 6573 756c 742c 2073  of our result, s
+00034780: 6f20 6973 5f6e 6f64 6520 6973 2066 616c  o is_node is fal
+00034790: 7365 2e0a 2020 2020 2020 2020 6973 5f6e  se..        is_n
+000347a0: 6f64 6520 3d20 6661 6c73 653b 0a20 2020  ode = false;.   
+000347b0: 207d 0a0a 2020 2020 2f2f 2073 746f 7265   }..    // store
+000347c0: 2067 7261 6469 656e 7473 206f 6620 712c   gradients of q,
+000347d0: 206b 2061 6e64 2076 2061 7320 636f 6e74   k and v as cont
+000347e0: 696e 756f 7573 2074 656e 736f 7273 2063  inuous tensors c
+000347f0: 6f6e 6361 7465 6e61 7465 6420 696e 2072  oncatenated in r
+00034800: 6573 756c 742e 0a20 2020 202f 2f20 7120  esult..    // q 
+00034810: 7368 6170 655b 442c 4e2c 6e65 322c 6e65  shape[D,N,ne2,ne
+00034820: 335d 203b 206b 2073 6861 7065 205b 442c  3] ; k shape [D,
+00034830: 4d2c 6e65 322c 6e65 335d 203b 2076 2073  M,ne2,ne3] ; v s
+00034840: 6861 7065 205b 4d2c 442c 6e65 322c 6e65  hape [M,D,ne2,ne
+00034850: 335d 0a20 2020 202f 2f20 6772 6164 712d  3].    // gradq-
+00034860: 3e64 6174 6120 3d20 7265 7375 6c74 2d3e  >data = result->
+00034870: 6461 7461 0a20 2020 202f 2f20 6772 6164  data.    // grad
+00034880: 6b2d 3e64 6174 6120 3d20 7265 7375 6c74  k->data = result
+00034890: 2d3e 6461 7461 202b 206e 6230 2a44 2a4e  ->data + nb0*D*N
+000348a0: 2a6e 6532 2a6e 6533 0a20 2020 202f 2f20  *ne2*ne3.    // 
+000348b0: 6772 6164 762d 3e64 6174 6120 3d20 7265  gradv->data = re
+000348c0: 7375 6c74 2d3e 6461 7461 202b 206e 6230  sult->data + nb0
+000348d0: 2a44 2a4e 2a6e 6532 2a6e 6533 202b 206e  *D*N*ne2*ne3 + n
+000348e0: 6230 2a44 2a4d 2a6e 6532 2a6e 6533 0a20  b0*D*M*ne2*ne3. 
+000348f0: 2020 202f 2f20 6e6f 7465 3a20 7620 616e     // note: v an
+00034900: 6420 6772 6164 7620 6172 6520 6163 7475  d gradv are actu
+00034910: 616c 6c79 2074 7261 6e73 706f 7365 642c  ally transposed,
+00034920: 2069 2e65 2e20 762d 3e6e 655b 305d 2021   i.e. v->ne[0] !
+00034930: 3d20 442e 0a20 2020 2069 6e74 3634 5f74  = D..    int64_t
+00034940: 206e 655b 345d 203d 207b 442c 4d2b 4e2b   ne[4] = {D,M+N+
+00034950: 4d2c 6e65 322c 6e65 337d 3b0a 0a20 2020  M,ne2,ne3};..   
+00034960: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00034970: 736f 7220 2a20 7265 7375 6c74 203d 2067  sor * result = g
+00034980: 676d 6c5f 6e65 775f 7465 6e73 6f72 2863  gml_new_tensor(c
+00034990: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
+000349a0: 322c 2034 2c20 6e65 293b 0a0a 2020 2020  2, 4, ne);..    
+000349b0: 7265 7375 6c74 2d3e 6f70 2020 203d 2047  result->op   = G
+000349c0: 474d 4c5f 4f50 5f46 4c41 5348 5f41 5454  GML_OP_FLASH_ATT
+000349d0: 4e5f 4241 434b 3b0a 2020 2020 7265 7375  N_BACK;.    resu
+000349e0: 6c74 2d3e 6772 6164 203d 2069 735f 6e6f  lt->grad = is_no
+000349f0: 6465 203f 2067 676d 6c5f 6475 705f 7465  de ? ggml_dup_te
+00034a00: 6e73 6f72 2863 7478 2c20 7265 7375 6c74  nsor(ctx, result
+00034a10: 2920 3a20 4e55 4c4c 3b0a 2020 2020 7265  ) : NULL;.    re
+00034a20: 7375 6c74 2d3e 7372 6330 203d 2071 3b0a  sult->src0 = q;.
+00034a30: 2020 2020 7265 7375 6c74 2d3e 7372 6331      result->src1
+00034a40: 203d 206b 3b0a 2020 2020 7265 7375 6c74   = k;.    result
+00034a50: 2d3e 6f70 745b 305d 203d 2076 3b0a 2020  ->opt[0] = v;.  
+00034a60: 2020 7265 7375 6c74 2d3e 6f70 745b 315d    result->opt[1]
+00034a70: 203d 2064 3b0a 2020 2020 7265 7375 6c74   = d;.    result
+00034a80: 2d3e 6f70 745b 325d 203d 2067 676d 6c5f  ->opt[2] = ggml_
+00034a90: 6e65 775f 6933 3228 6374 782c 206d 6173  new_i32(ctx, mas
+00034aa0: 6b65 6420 3f20 3120 3a20 3029 3b0a 0a20  ked ? 1 : 0);.. 
+00034ab0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00034ac0: 3b0a 7d0a 0a0a 2f2f 2067 676d 6c5f 6d61  ;.}...// ggml_ma
+00034ad0: 705f 756e 6172 790a 0a73 7472 7563 7420  p_unary..struct 
+00034ae0: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+00034af0: 6d6c 5f6d 6170 5f75 6e61 7279 5f69 6d70  ml_map_unary_imp
+00034b00: 6c5f 6633 3228 0a20 2020 2020 2020 2073  l_f32(.        s
+00034b10: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+00034b20: 7874 2020 2020 2020 2020 2a20 6374 782c  xt        * ctx,
+00034b30: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00034b40: 6767 6d6c 5f74 656e 736f 7220 2020 2020  ggml_tensor     
+00034b50: 2020 2020 2a20 612c 0a20 2020 2020 2020      * a,.       
+00034b60: 2063 6f6e 7374 2020 6767 6d6c 5f75 6e61   const  ggml_una
+00034b70: 7279 5f6f 705f 6633 325f 7420 6675 6e2c  ry_op_f32_t fun,
+00034b80: 0a20 2020 2020 2020 2062 6f6f 6c20 2020  .        bool   
+00034b90: 696e 706c 6163 6529 207b 0a20 2020 2062  inplace) {.    b
+00034ba0: 6f6f 6c20 6973 5f6e 6f64 6520 3d20 6661  ool is_node = fa
+00034bb0: 6c73 653b 0a0a 2020 2020 6966 2028 2169  lse;..    if (!i
+00034bc0: 6e70 6c61 6365 2026 2620 612d 3e67 7261  nplace && a->gra
+00034bd0: 6429 207b 0a20 2020 2020 2020 2069 735f  d) {.        is_
+00034be0: 6e6f 6465 203d 2074 7275 653b 0a20 2020  node = true;.   
+00034bf0: 207d 0a0a 2020 2020 7374 7275 6374 2067   }..    struct g
+00034c00: 676d 6c5f 7465 6e73 6f72 202a 2061 6464  gml_tensor * add
+00034c10: 725f 7465 6e73 6f72 203d 2067 676d 6c5f  r_tensor = ggml_
+00034c20: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
+00034c30: 782c 2047 474d 4c5f 5459 5045 5f49 3332  x, GGML_TYPE_I32
+00034c40: 2c20 7369 7a65 6f66 2876 6f69 6420 2a29  , sizeof(void *)
+00034c50: 202f 2073 697a 656f 6628 696e 7433 325f   / sizeof(int32_
+00034c60: 7429 293b 0a20 2020 202a 2828 766f 6964  t));.    *((void
+00034c70: 2028 2a2a 2928 766f 6964 2929 6164 6472   (**)(void))addr
+00034c80: 5f74 656e 736f 722d 3e64 6174 6129 203d  _tensor->data) =
+00034c90: 2028 766f 6964 2028 2a29 2876 6f69 6429   (void (*)(void)
+00034ca0: 2966 756e 3b0a 2020 2020 7374 7275 6374  )fun;.    struct
+00034cb0: 2067 676d 6c5f 7465 6e73 6f72 202a 7265   ggml_tensor *re
+00034cc0: 7375 6c74 203d 2069 6e70 6c61 6365 203f  sult = inplace ?
+00034cd0: 2067 676d 6c5f 7669 6577 5f74 656e 736f   ggml_view_tenso
+00034ce0: 7228 6374 782c 2061 2920 3a20 6767 6d6c  r(ctx, a) : ggml
+00034cf0: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+00034d00: 2061 293b 0a0a 2020 2020 7265 7375 6c74   a);..    result
+00034d10: 2d3e 6f70 203d 2047 474d 4c5f 4f50 5f4d  ->op = GGML_OP_M
+00034d20: 4150 5f55 4e41 5259 3b0a 2020 2020 7265  AP_UNARY;.    re
+00034d30: 7375 6c74 2d3e 6772 6164 203d 2069 735f  sult->grad = is_
+00034d40: 6e6f 6465 203f 2067 676d 6c5f 6475 705f  node ? ggml_dup_
+00034d50: 7465 6e73 6f72 2863 7478 2c20 7265 7375  tensor(ctx, resu
+00034d60: 6c74 2920 3a20 4e55 4c4c 3b0a 2020 2020  lt) : NULL;.    
+00034d70: 7265 7375 6c74 2d3e 7372 6330 203d 2061  result->src0 = a
+00034d80: 3b0a 2020 2020 7265 7375 6c74 2d3e 6f70  ;.    result->op
+00034d90: 745b 305d 203d 2061 6464 725f 7465 6e73  t[0] = addr_tens
+00034da0: 6f72 3b0a 0a20 2020 2072 6574 7572 6e20  or;..    return 
+00034db0: 7265 7375 6c74 3b0a 7d0a 0a73 7472 7563  result;.}..struc
+00034dc0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00034dd0: 6767 6d6c 5f6d 6170 5f75 6e61 7279 5f66  ggml_map_unary_f
+00034de0: 3332 280a 2020 2020 2020 2020 7374 7275  32(.        stru
+00034df0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+00034e00: 2020 2020 2020 202a 2063 7478 2c0a 2020         * ctx,.  
+00034e10: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00034e20: 6c5f 7465 6e73 6f72 2020 2020 2020 2020  l_tensor        
+00034e30: 202a 2061 2c0a 2020 2020 2020 2020 636f   * a,.        co
+00034e40: 6e73 7420 2067 676d 6c5f 756e 6172 795f  nst  ggml_unary_
+00034e50: 6f70 5f66 3332 5f74 2066 756e 2920 7b0a  op_f32_t fun) {.
+00034e60: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
+00034e70: 6d61 705f 756e 6172 795f 696d 706c 5f66  map_unary_impl_f
+00034e80: 3332 2863 7478 2c20 612c 2066 756e 2c20  32(ctx, a, fun, 
+00034e90: 6661 6c73 6529 3b0a 7d0a 0a73 7472 7563  false);.}..struc
+00034ea0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00034eb0: 6767 6d6c 5f6d 6170 5f75 6e61 7279 5f69  ggml_map_unary_i
+00034ec0: 6e70 6c61 6365 5f66 3332 280a 2020 2020  nplace_f32(.    
+00034ed0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00034ee0: 636f 6e74 6578 7420 2020 2020 2020 202a  context        *
+00034ef0: 2063 7478 2c0a 2020 2020 2020 2020 7374   ctx,.        st
+00034f00: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00034f10: 2020 2020 2020 2020 202a 2061 2c0a 2020           * a,.  
+00034f20: 2020 2020 2020 636f 6e73 7420 2067 676d        const  ggm
+00034f30: 6c5f 756e 6172 795f 6f70 5f66 3332 5f74  l_unary_op_f32_t
+00034f40: 2066 756e 2920 7b0a 2020 2020 7265 7475   fun) {.    retu
+00034f50: 726e 2067 676d 6c5f 6d61 705f 756e 6172  rn ggml_map_unar
+00034f60: 795f 696d 706c 5f66 3332 2863 7478 2c20  y_impl_f32(ctx, 
+00034f70: 612c 2066 756e 2c20 7472 7565 293b 0a7d  a, fun, true);.}
+00034f80: 0a0a 2f2f 2067 676d 6c5f 6d61 705f 6269  ..// ggml_map_bi
+00034f90: 6e61 7279 0a0a 7374 7275 6374 2067 676d  nary..struct ggm
+00034fa0: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+00034fb0: 6d61 705f 6269 6e61 7279 5f69 6d70 6c5f  map_binary_impl_
+00034fc0: 6633 3228 0a20 2020 2020 2020 2073 7472  f32(.        str
+00034fd0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00034fe0: 2020 2020 2020 2020 202a 2063 7478 2c0a           * ctx,.
+00034ff0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00035000: 676d 6c5f 7465 6e73 6f72 2020 2020 2020  gml_tensor      
+00035010: 2020 2020 2a20 612c 0a20 2020 2020 2020      * a,.       
+00035020: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00035030: 736f 7220 2020 2020 2020 2020 202a 2062  sor          * b
+00035040: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00035050: 2067 676d 6c5f 6269 6e61 7279 5f6f 705f   ggml_binary_op_
+00035060: 6633 325f 7420 6675 6e2c 0a20 2020 2020  f32_t fun,.     
+00035070: 2020 2062 6f6f 6c20 2020 696e 706c 6163     bool   inplac
+00035080: 6529 207b 0a20 2020 2047 474d 4c5f 4153  e) {.    GGML_AS
+00035090: 5345 5254 2867 676d 6c5f 6172 655f 7361  SERT(ggml_are_sa
+000350a0: 6d65 5f73 6861 7065 2861 2c20 6229 293b  me_shape(a, b));
+000350b0: 0a0a 2020 2020 626f 6f6c 2069 735f 6e6f  ..    bool is_no
+000350c0: 6465 203d 2066 616c 7365 3b0a 0a20 2020  de = false;..   
+000350d0: 2069 6620 2821 696e 706c 6163 6520 2626   if (!inplace &&
+000350e0: 2028 612d 3e67 7261 6420 7c7c 2062 2d3e   (a->grad || b->
+000350f0: 6772 6164 2929 207b 0a20 2020 2020 2020  grad)) {.       
+00035100: 2069 735f 6e6f 6465 203d 2074 7275 653b   is_node = true;
+00035110: 0a20 2020 207d 0a0a 2020 2020 7374 7275  .    }..    stru
+00035120: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00035130: 2061 6464 725f 7465 6e73 6f72 203d 2067   addr_tensor = g
+00035140: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
+00035150: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
+00035160: 5f49 3332 2c20 7369 7a65 6f66 2876 6f69  _I32, sizeof(voi
+00035170: 6420 2a29 202f 2073 697a 656f 6628 696e  d *) / sizeof(in
+00035180: 7433 325f 7429 293b 0a20 2020 202a 2828  t32_t));.    *((
+00035190: 766f 6964 2028 2a2a 2928 766f 6964 2929  void (**)(void))
+000351a0: 6164 6472 5f74 656e 736f 722d 3e64 6174  addr_tensor->dat
+000351b0: 6129 203d 2028 766f 6964 2028 2a29 2876  a) = (void (*)(v
+000351c0: 6f69 6429 2966 756e 3b0a 2020 2020 7374  oid))fun;.    st
+000351d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000351e0: 202a 7265 7375 6c74 203d 2069 6e70 6c61   *result = inpla
+000351f0: 6365 203f 2067 676d 6c5f 7669 6577 5f74  ce ? ggml_view_t
+00035200: 656e 736f 7228 6374 782c 2061 2920 3a20  ensor(ctx, a) : 
+00035210: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00035220: 6374 782c 2061 293b 0a0a 2020 2020 7265  ctx, a);..    re
+00035230: 7375 6c74 2d3e 6f70 203d 2047 474d 4c5f  sult->op = GGML_
+00035240: 4f50 5f4d 4150 5f42 494e 4152 593b 0a20  OP_MAP_BINARY;. 
+00035250: 2020 2072 6573 756c 742d 3e67 7261 6420     result->grad 
+00035260: 3d20 6973 5f6e 6f64 6520 3f20 6767 6d6c  = is_node ? ggml
+00035270: 5f64 7570 5f74 656e 736f 7228 6374 782c  _dup_tensor(ctx,
+00035280: 2072 6573 756c 7429 203a 204e 554c 4c3b   result) : NULL;
+00035290: 0a20 2020 2072 6573 756c 742d 3e73 7263  .    result->src
+000352a0: 3020 3d20 613b 0a20 2020 2072 6573 756c  0 = a;.    resul
+000352b0: 742d 3e73 7263 3120 3d20 623b 0a20 2020  t->src1 = b;.   
+000352c0: 2072 6573 756c 742d 3e6f 7074 5b30 5d20   result->opt[0] 
+000352d0: 3d20 6164 6472 5f74 656e 736f 723b 0a0a  = addr_tensor;..
+000352e0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+000352f0: 743b 0a7d 0a0a 7374 7275 6374 2067 676d  t;.}..struct ggm
+00035300: 6c5f 7465 6e73 6f72 202a 2067 676d 6c5f  l_tensor * ggml_
+00035310: 6d61 705f 6269 6e61 7279 5f66 3332 280a  map_binary_f32(.
+00035320: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00035330: 676d 6c5f 636f 6e74 6578 7420 2020 2020  gml_context     
+00035340: 2020 2020 2a20 6374 782c 0a20 2020 2020      * ctx,.     
+00035350: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00035360: 656e 736f 7220 2020 2020 2020 2020 202a  ensor          *
+00035370: 2061 2c0a 2020 2020 2020 2020 7374 7275   a,.        stru
+00035380: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+00035390: 2020 2020 2020 2020 2a20 622c 0a20 2020          * b,.   
+000353a0: 2020 2020 2063 6f6e 7374 2020 6767 6d6c       const  ggml
+000353b0: 5f62 696e 6172 795f 6f70 5f66 3332 5f74  _binary_op_f32_t
+000353c0: 2066 756e 2920 7b0a 2020 2020 7265 7475   fun) {.    retu
+000353d0: 726e 2067 676d 6c5f 6d61 705f 6269 6e61  rn ggml_map_bina
+000353e0: 7279 5f69 6d70 6c5f 6633 3228 6374 782c  ry_impl_f32(ctx,
+000353f0: 2061 2c20 622c 2066 756e 2c20 6661 6c73   a, b, fun, fals
+00035400: 6529 3b0a 7d0a 0a73 7472 7563 7420 6767  e);.}..struct gg
+00035410: 6d6c 5f74 656e 736f 7220 2a20 6767 6d6c  ml_tensor * ggml
+00035420: 5f6d 6170 5f62 696e 6172 795f 696e 706c  _map_binary_inpl
+00035430: 6163 655f 6633 3228 0a20 2020 2020 2020  ace_f32(.       
+00035440: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+00035450: 7465 7874 2020 2020 2020 2020 202a 2063  text         * c
+00035460: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+00035470: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+00035480: 2020 2020 2020 2020 2a20 612c 0a20 2020          * a,.   
+00035490: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+000354a0: 5f74 656e 736f 7220 2020 2020 2020 2020  _tensor         
+000354b0: 202a 2062 2c0a 2020 2020 2020 2020 636f   * b,.        co
+000354c0: 6e73 7420 2067 676d 6c5f 6269 6e61 7279  nst  ggml_binary
+000354d0: 5f6f 705f 6633 325f 7420 6675 6e29 207b  _op_f32_t fun) {
+000354e0: 0a20 2020 2072 6574 7572 6e20 6767 6d6c  .    return ggml
+000354f0: 5f6d 6170 5f62 696e 6172 795f 696d 706c  _map_binary_impl
+00035500: 5f66 3332 2863 7478 2c20 612c 2062 2c20  _f32(ctx, a, b, 
+00035510: 6675 6e2c 2074 7275 6529 3b0a 7d0a 0a2f  fun, true);.}../
+00035520: 2f20 6767 6d6c 5f63 726f 7373 5f65 6e74  / ggml_cross_ent
+00035530: 726f 7079 5f6c 6f73 730a 0a73 7472 7563  ropy_loss..struc
+00035540: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00035550: 6767 6d6c 5f63 726f 7373 5f65 6e74 726f  ggml_cross_entro
+00035560: 7079 5f6c 6f73 7328 0a20 2020 2020 2020  py_loss(.       
+00035570: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+00035580: 7465 7874 2020 2020 2020 2020 202a 2063  text         * c
+00035590: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
+000355a0: 6374 2067 676d 6c5f 7465 6e73 6f72 2020  ct ggml_tensor  
+000355b0: 2020 2020 2020 2020 2a20 612c 0a20 2020          * a,.   
+000355c0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+000355d0: 5f74 656e 736f 7220 2020 2020 2020 2020  _tensor         
+000355e0: 202a 2062 2920 7b0a 2020 2020 4747 4d4c   * b) {.    GGML
+000355f0: 5f41 5353 4552 5428 6767 6d6c 5f61 7265  _ASSERT(ggml_are
+00035600: 5f73 616d 655f 7368 6170 6528 612c 2062  _same_shape(a, b
+00035610: 2929 3b0a 2020 2020 626f 6f6c 2069 735f  ));.    bool is_
+00035620: 6e6f 6465 203d 2066 616c 7365 3b0a 0a20  node = false;.. 
+00035630: 2020 2069 6620 2861 2d3e 6772 6164 207c     if (a->grad |
+00035640: 7c20 622d 3e67 7261 6429 207b 0a20 2020  | b->grad) {.   
+00035650: 2020 2020 2069 735f 6e6f 6465 203d 2074       is_node = t
+00035660: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
+00035670: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00035680: 6f72 202a 2072 6573 756c 7420 3d20 6767  or * result = gg
+00035690: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
+000356a0: 2863 7478 2c20 612d 3e74 7970 652c 2031  (ctx, a->type, 1
+000356b0: 293b 0a0a 2020 2020 7265 7375 6c74 2d3e  );..    result->
+000356c0: 6f70 2020 203d 2047 474d 4c5f 4f50 5f43  op   = GGML_OP_C
+000356d0: 524f 5353 5f45 4e54 524f 5059 5f4c 4f53  ROSS_ENTROPY_LOS
+000356e0: 533b 0a20 2020 2072 6573 756c 742d 3e67  S;.    result->g
+000356f0: 7261 6420 3d20 6973 5f6e 6f64 6520 3f20  rad = is_node ? 
+00035700: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
+00035710: 6374 782c 2072 6573 756c 7429 203a 204e  ctx, result) : N
+00035720: 554c 4c3b 0a20 2020 2072 6573 756c 742d  ULL;.    result-
+00035730: 3e73 7263 3020 3d20 613b 0a20 2020 2072  >src0 = a;.    r
+00035740: 6573 756c 742d 3e73 7263 3120 3d20 623b  esult->src1 = b;
+00035750: 0a0a 2020 2020 7265 7475 726e 2072 6573  ..    return res
+00035760: 756c 743b 0a7d 0a0a 2f2f 2067 676d 6c5f  ult;.}..// ggml_
+00035770: 6372 6f73 735f 656e 7472 6f70 795f 6c6f  cross_entropy_lo
+00035780: 7373 5f62 6163 6b0a 0a73 7472 7563 7420  ss_back..struct 
+00035790: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+000357a0: 6d6c 5f63 726f 7373 5f65 6e74 726f 7079  ml_cross_entropy
+000357b0: 5f6c 6f73 735f 6261 636b 280a 2020 2020  _loss_back(.    
+000357c0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000357d0: 636f 6e74 6578 7420 2020 2020 2020 2020  context         
+000357e0: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+000357f0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00035800: 7220 2020 2020 2020 2020 202a 2061 2c0a  r          * a,.
+00035810: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00035820: 676d 6c5f 7465 6e73 6f72 2020 2020 2020  gml_tensor      
+00035830: 2020 2020 2a20 622c 0a20 2020 2020 2020      * b,.       
+00035840: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00035850: 736f 7220 2020 2020 2020 2020 202a 2063  sor          * c
+00035860: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+00035870: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
+00035880: 655f 7368 6170 6528 612c 2062 2929 3b0a  e_shape(a, b));.
+00035890: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000358a0: 6767 6d6c 5f69 735f 7363 616c 6172 2863  ggml_is_scalar(c
+000358b0: 2929 3b0a 0a20 2020 2073 7472 7563 7420  ));..    struct 
+000358c0: 6767 6d6c 5f74 656e 736f 7220 2a20 7265  ggml_tensor * re
+000358d0: 7375 6c74 203d 2067 676d 6c5f 6475 705f  sult = ggml_dup_
+000358e0: 7465 6e73 6f72 2863 7478 2c20 6129 3b0a  tensor(ctx, a);.
+000358f0: 0a20 2020 2072 6573 756c 742d 3e6f 7020  .    result->op 
+00035900: 2020 3d20 4747 4d4c 5f4f 505f 4352 4f53    = GGML_OP_CROS
+00035910: 535f 454e 5452 4f50 595f 4c4f 5353 5f42  S_ENTROPY_LOSS_B
+00035920: 4143 4b3b 0a20 2020 2072 6573 756c 742d  ACK;.    result-
+00035930: 3e67 7261 6420 3d20 4e55 4c4c 3b0a 2020  >grad = NULL;.  
+00035940: 2020 7265 7375 6c74 2d3e 7372 6330 203d    result->src0 =
+00035950: 2061 3b0a 2020 2020 7265 7375 6c74 2d3e   a;.    result->
+00035960: 7372 6331 203d 2062 3b0a 2020 2020 7265  src1 = b;.    re
+00035970: 7375 6c74 2d3e 6f70 745b 305d 203d 2063  sult->opt[0] = c
+00035980: 3b0a 0a20 2020 2072 6574 7572 6e20 7265  ;..    return re
+00035990: 7375 6c74 3b0a 7d0a 0a2f 2f2f 2f2f 2f2f  sult;.}..///////
+000359a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000359b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000359c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000359d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000359e0: 2f2f 2f2f 2f2f 2f2f 2f0a 0a76 6f69 6420  /////////..void 
+000359f0: 6767 6d6c 5f73 6574 5f70 6172 616d 280a  ggml_set_param(.
+00035a00: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00035a10: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00035a20: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+00035a30: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00035a40: 7465 6e73 6f72 2920 7b0a 2020 2020 7465  tensor) {.    te
+00035a50: 6e73 6f72 2d3e 6973 5f70 6172 616d 203d  nsor->is_param =
+00035a60: 2074 7275 653b 0a0a 2020 2020 4747 4d4c   true;..    GGML
+00035a70: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
+00035a80: 6772 6164 203d 3d20 4e55 4c4c 293b 0a20  grad == NULL);. 
+00035a90: 2020 2074 656e 736f 722d 3e67 7261 6420     tensor->grad 
+00035aa0: 3d20 6767 6d6c 5f64 7570 5f74 656e 736f  = ggml_dup_tenso
+00035ab0: 7228 6374 782c 2074 656e 736f 7229 3b0a  r(ctx, tensor);.
+00035ac0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00035ad0: 7465 5f66 6f72 7761 7264 5f64 7570 0a0a  te_forward_dup..
+00035ae0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00035af0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00035b00: 5f64 7570 5f73 616d 655f 636f 6e74 280a  _dup_same_cont(.
+00035b10: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00035b20: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00035b30: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00035b40: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00035b50: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00035b60: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+00035b70: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00035b80: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+00035b90: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00035ba0: 6767 6d6c 5f6e 656c 656d 656e 7473 2864  ggml_nelements(d
+00035bb0: 7374 2920 3d3d 2067 676d 6c5f 6e65 6c65  st) == ggml_nele
+00035bc0: 6d65 6e74 7328 7372 6330 2929 3b0a 2020  ments(src0));.  
+00035bd0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+00035be0: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
+00035bf0: 2864 7374 2920 2626 2067 676d 6c5f 6973  (dst) && ggml_is
+00035c00: 5f63 6f6e 7469 6775 6f75 7328 7372 6330  _contiguous(src0
+00035c10: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+00035c20: 4552 5428 7372 6330 2d3e 7479 7065 203d  ERT(src0->type =
+00035c30: 3d20 6473 742d 3e74 7970 6529 3b0a 0a20  = dst->type);.. 
+00035c40: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+00035c50: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+00035c60: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
+00035c70: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00035c80: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
+00035c90: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+00035ca0: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
+00035cb0: 7369 7a65 5f74 206e 6230 3020 3d20 7372  size_t nb00 = sr
+00035cc0: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
+00035cd0: 6f6e 7374 2073 697a 655f 7420 6e62 3020  onst size_t nb0 
+00035ce0: 3d20 6473 742d 3e6e 625b 305d 3b0a 0a20  = dst->nb[0];.. 
+00035cf0: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
+00035d00: 203d 2070 6172 616d 732d 3e69 7468 3b20   = params->ith; 
+00035d10: 2f2f 2074 6872 6561 6420 696e 6465 780a  // thread index.
+00035d20: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
+00035d30: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
+00035d40: 202f 2f20 6e75 6d62 6572 206f 6620 7468   // number of th
+00035d50: 7265 6164 730a 0a20 2020 202f 2f20 7061  reads..    // pa
+00035d60: 7261 6c6c 656c 697a 6520 6279 2065 6c65  rallelize by ele
+00035d70: 6d65 6e74 730a 2020 2020 636f 6e73 7420  ments.    const 
+00035d80: 696e 7420 6e65 203d 2067 676d 6c5f 6e65  int ne = ggml_ne
+00035d90: 6c65 6d65 6e74 7328 6473 7429 3b0a 2020  lements(dst);.  
+00035da0: 2020 636f 6e73 7420 696e 7420 6472 203d    const int dr =
+00035db0: 2028 6e65 202b 206e 7468 202d 2031 2920   (ne + nth - 1) 
+00035dc0: 2f20 6e74 683b 0a20 2020 2063 6f6e 7374  / nth;.    const
+00035dd0: 2069 6e74 2069 6530 203d 2064 7220 2a20   int ie0 = dr * 
+00035de0: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+00035df0: 6e74 2069 6531 203d 204d 494e 2869 6530  nt ie1 = MIN(ie0
+00035e00: 202b 2064 722c 206e 6529 3b0a 0a20 2020   + dr, ne);..   
+00035e10: 2069 6620 2869 6530 203c 2069 6531 2920   if (ie0 < ie1) 
+00035e20: 7b0a 2020 2020 2020 2020 6d65 6d63 7079  {.        memcpy
+00035e30: 280a 2020 2020 2020 2020 2020 2020 2828  (.            ((
+00035e40: 6368 6172 202a 2920 2064 7374 2d3e 6461  char *)  dst->da
+00035e50: 7461 202b 2069 6530 2a6e 6230 292c 0a20  ta + ie0*nb0),. 
+00035e60: 2020 2020 2020 2020 2020 2028 2863 6861             ((cha
+00035e70: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+00035e80: 2b20 6965 302a 6e62 3030 292c 0a20 2020  + ie0*nb00),.   
+00035e90: 2020 2020 2020 2020 2028 6965 3120 2d20           (ie1 - 
+00035ea0: 6965 3029 202a 2047 474d 4c5f 5459 5045  ie0) * GGML_TYPE
+00035eb0: 5f53 495a 455b 7372 6330 2d3e 7479 7065  _SIZE[src0->type
+00035ec0: 5d29 3b0a 2020 2020 7d0a 0a7d 0a73 7461  ]);.    }..}.sta
+00035ed0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00035ee0: 6d70 7574 655f 666f 7277 6172 645f 6475  mpute_forward_du
+00035ef0: 705f 6631 3628 0a20 2020 2020 2020 2063  p_f16(.        c
+00035f00: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00035f10: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+00035f20: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+00035f30: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00035f40: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00035f50: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
+00035f60: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00035f70: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
+00035f80: 4153 5345 5254 2867 676d 6c5f 6e65 6c65  ASSERT(ggml_nele
+00035f90: 6d65 6e74 7328 6473 7429 203d 3d20 6767  ments(dst) == gg
+00035fa0: 6d6c 5f6e 656c 656d 656e 7473 2873 7263  ml_nelements(src
+00035fb0: 3029 293b 0a0a 2020 2020 6966 2028 7061  0));..    if (pa
+00035fc0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00035fd0: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
+00035fe0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00035ff0: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
+00036000: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
+00036010: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+00036020: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00036030: 6530 3020 3d20 7372 6330 2d3e 6e65 5b30  e00 = src0->ne[0
+00036040: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00036050: 3634 5f74 206e 6530 3120 3d20 7372 6330  64_t ne01 = src0
+00036060: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
+00036070: 7374 2069 6e74 3634 5f74 206e 6530 3220  st int64_t ne02 
+00036080: 3d20 7372 6330 2d3e 6e65 5b32 5d3b 0a20  = src0->ne[2];. 
+00036090: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+000360a0: 206e 6530 3320 3d20 7372 6330 2d3e 6e65   ne03 = src0->ne
+000360b0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+000360c0: 696e 7436 345f 7420 6e65 3020 3d20 6473  int64_t ne0 = ds
+000360d0: 742d 3e6e 655b 305d 3b0a 2020 2020 636f  t->ne[0];.    co
+000360e0: 6e73 7420 696e 7436 345f 7420 6e65 3120  nst int64_t ne1 
+000360f0: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
+00036100: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00036110: 6e65 3220 3d20 6473 742d 3e6e 655b 325d  ne2 = dst->ne[2]
+00036120: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+00036130: 345f 7420 6e65 3320 3d20 6473 742d 3e6e  4_t ne3 = dst->n
+00036140: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
+00036150: 2073 697a 655f 7420 6e62 3030 203d 2073   size_t nb00 = s
+00036160: 7263 302d 3e6e 625b 305d 3b0a 2020 2020  rc0->nb[0];.    
+00036170: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+00036180: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
+00036190: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+000361a0: 7420 6e62 3032 203d 2073 7263 302d 3e6e  t nb02 = src0->n
+000361b0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+000361c0: 7369 7a65 5f74 206e 6230 3320 3d20 7372  size_t nb03 = sr
+000361d0: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
+000361e0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+000361f0: 203d 2064 7374 2d3e 6e62 5b30 5d3b 0a20   = dst->nb[0];. 
+00036200: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+00036210: 6e62 3120 3d20 6473 742d 3e6e 625b 315d  nb1 = dst->nb[1]
+00036220: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
+00036230: 5f74 206e 6232 203d 2064 7374 2d3e 6e62  _t nb2 = dst->nb
+00036240: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
+00036250: 697a 655f 7420 6e62 3320 3d20 6473 742d  ize_t nb3 = dst-
+00036260: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
+00036270: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00036280: 616d 732d 3e69 7468 3b20 2f2f 2074 6872  ams->ith; // thr
+00036290: 6561 6420 696e 6465 780a 2020 2020 636f  ead index.    co
+000362a0: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+000362b0: 7261 6d73 2d3e 6e74 683b 202f 2f20 6e75  rams->nth; // nu
+000362c0: 6d62 6572 206f 6620 7468 7265 6164 730a  mber of threads.
+000362d0: 0a20 2020 2069 6620 2867 676d 6c5f 6973  .    if (ggml_is
+000362e0: 5f63 6f6e 7469 6775 6f75 7328 7372 6330  _contiguous(src0
+000362f0: 2920 2626 2067 676d 6c5f 6973 5f63 6f6e  ) && ggml_is_con
+00036300: 7469 6775 6f75 7328 6473 7429 2026 2620  tiguous(dst) && 
+00036310: 7372 6330 2d3e 7479 7065 203d 3d20 6473  src0->type == ds
+00036320: 742d 3e74 7970 6529 207b 0a20 2020 2020  t->type) {.     
+00036330: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00036340: 666f 7277 6172 645f 6475 705f 7361 6d65  forward_dup_same
+00036350: 5f63 6f6e 7428 7061 7261 6d73 2c20 7372  _cont(params, sr
+00036360: 6330 2c20 6473 7429 3b0a 2020 2020 2020  c0, dst);.      
+00036370: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00036380: 0a20 2020 202f 2f20 7061 7261 6c6c 656c  .    // parallel
+00036390: 697a 6520 6279 2072 6f77 730a 2020 2020  ize by rows.    
+000363a0: 636f 6e73 7420 696e 7420 6e72 203d 206e  const int nr = n
+000363b0: 6530 313b 0a20 2020 202f 2f20 6e75 6d62  e01;.    // numb
+000363c0: 6572 206f 6620 726f 7773 2070 6572 2074  er of rows per t
+000363d0: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
+000363e0: 696e 7420 6472 203d 2028 6e72 202b 206e  int dr = (nr + n
+000363f0: 7468 202d 2031 2920 2f20 6e74 683b 0a20  th - 1) / nth;. 
+00036400: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
+00036410: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
+00036420: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+00036430: 3020 3d20 6472 202a 2069 7468 3b0a 2020  0 = dr * ith;.  
+00036440: 2020 636f 6e73 7420 696e 7420 6972 3120    const int ir1 
+00036450: 3d20 4d49 4e28 6972 3020 2b20 6472 2c20  = MIN(ir0 + dr, 
+00036460: 6e72 293b 0a0a 2020 2020 6966 2028 7372  nr);..    if (sr
+00036470: 6330 2d3e 7479 7065 203d 3d20 6473 742d  c0->type == dst-
+00036480: 3e74 7970 6520 2626 0a20 2020 2020 2020  >type &&.       
+00036490: 206e 6530 3020 3d3d 206e 6530 2026 260a   ne00 == ne0 &&.
+000364a0: 2020 2020 2020 2020 6e62 3030 203d 3d20          nb00 == 
+000364b0: 4747 4d4c 5f54 5950 455f 5349 5a45 5b73  GGML_TYPE_SIZE[s
+000364c0: 7263 302d 3e74 7970 655d 2026 2620 6e62  rc0->type] && nb
+000364d0: 3020 3d3d 2047 474d 4c5f 5459 5045 5f53  0 == GGML_TYPE_S
+000364e0: 495a 455b 6473 742d 3e74 7970 655d 2920  IZE[dst->type]) 
+000364f0: 7b0a 2020 2020 2020 2020 2f2f 2063 6f70  {.        // cop
+00036500: 7920 6279 2072 6f77 730a 2020 2020 2020  y by rows.      
+00036510: 2020 636f 6e73 7420 7369 7a65 5f74 2072    const size_t r
+00036520: 7320 3d20 6e65 3030 2a6e 6230 303b 0a20  s = ne00*nb00;. 
+00036530: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00036540: 345f 7420 6930 3320 3d20 303b 2069 3033  4_t i03 = 0; i03
+00036550: 203c 206e 6530 333b 2069 3033 2b2b 2920   < ne03; i03++) 
+00036560: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
+00036570: 7220 2869 6e74 3634 5f74 2069 3032 203d  r (int64_t i02 =
+00036580: 2030 3b20 6930 3220 3c20 6e65 3032 3b20   0; i02 < ne02; 
+00036590: 6930 322b 2b29 207b 0a20 2020 2020 2020  i02++) {.       
+000365a0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+000365b0: 7436 345f 7420 6930 3120 3d20 6972 303b  t64_t i01 = ir0;
+000365c0: 2069 3031 203c 2069 7231 3b20 6930 312b   i01 < ir1; i01+
+000365d0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000365e0: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
+000365f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036600: 2020 2020 2020 2020 2028 2863 6861 7220           ((char 
+00036610: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
+00036620: 6930 312a 6e62 3120 202b 2069 3032 2a6e  i01*nb1  + i02*n
+00036630: 6232 2020 2b20 6930 332a 6e62 3329 2c0a  b2  + i03*nb3),.
+00036640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036650: 2020 2020 2020 2020 2828 6368 6172 202a          ((char *
+00036660: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
+00036670: 3031 2a6e 6230 3120 2b20 6930 322a 6e62  01*nb01 + i02*nb
+00036680: 3032 202b 2069 3033 2a6e 6230 3329 2c0a  02 + i03*nb03),.
+00036690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000366a0: 2020 2020 2020 2020 7273 293b 0a20 2020          rs);.   
+000366b0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000366c0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000366d0: 2020 2020 207d 0a20 2020 2020 2020 2072       }.        r
+000366e0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+000366f0: 2020 2f2f 2054 4f44 4f3a 2061 6464 206d    // TODO: add m
+00036700: 6f72 6520 7370 6563 6961 6c2d 6361 7365  ore special-case
+00036710: 2069 6d70 6c65 6d65 6e74 6174 696f 6e73   implementations
+00036720: 2066 6f72 2074 656e 736f 7220 7368 6170   for tensor shap
+00036730: 6573 2f73 7472 6964 6573 2074 6861 7420  es/strides that 
+00036740: 6361 6e20 6265 6e65 6669 7420 6672 6f6d  can benefit from
+00036750: 206d 656d 6370 790a 0a20 2020 2069 6620   memcpy..    if 
+00036760: 2867 676d 6c5f 6973 5f63 6f6e 7469 6775  (ggml_is_contigu
+00036770: 6f75 7328 6473 7429 2920 7b0a 2020 2020  ous(dst)) {.    
+00036780: 2020 2020 6966 2028 6e62 3030 203d 3d20      if (nb00 == 
+00036790: 7369 7a65 6f66 2867 676d 6c5f 6670 3136  sizeof(ggml_fp16
+000367a0: 5f74 2929 207b 0a20 2020 2020 2020 2020  _t)) {.         
+000367b0: 2020 2069 6620 2864 7374 2d3e 7479 7065     if (dst->type
+000367c0: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
+000367d0: 3629 207b 0a20 2020 2020 2020 2020 2020  6) {.           
+000367e0: 2020 2020 2073 697a 655f 7420 6964 203d       size_t id =
+000367f0: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00036800: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00036810: 2072 7320 3d20 6e65 3030 202a 206e 6230   rs = ne00 * nb0
+00036820: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+00036830: 2020 2063 6861 7220 2a20 6473 745f 7074     char * dst_pt
+00036840: 7220 3d20 2863 6861 7220 2a29 2064 7374  r = (char *) dst
+00036850: 2d3e 6461 7461 3b0a 0a20 2020 2020 2020  ->data;..       
+00036860: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00036870: 7420 6930 3320 3d20 303b 2069 3033 203c  t i03 = 0; i03 <
+00036880: 206e 6530 333b 2069 3033 2b2b 2920 7b0a   ne03; i03++) {.
+00036890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000368a0: 2020 2020 666f 7220 2869 6e74 2069 3032      for (int i02
+000368b0: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
+000368c0: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
 000368d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000368e0: 2020 2066 6f72 2028 696e 7420 6930 3220     for (int i02 
-000368f0: 3d20 303b 2069 3032 203c 206e 6530 323b  = 0; i02 < ne02;
-00036900: 2069 3032 2b2b 2920 7b0a 2020 2020 2020   i02++) {.      
-00036910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036920: 2020 6964 202b 3d20 7273 202a 2069 7230    id += rs * ir0
-00036930: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00036940: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00036950: 6e74 2069 3031 203d 2069 7230 3b20 6930  nt i01 = ir0; i0
-00036960: 3120 3c20 6972 313b 2069 3031 2b2b 2920  1 < ir1; i01++) 
-00036970: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00036980: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00036990: 6e73 7420 6368 6172 202a 2073 7263 305f  nst char * src0_
-000369a0: 7074 7220 3d20 2863 6861 7220 2a29 2073  ptr = (char *) s
-000369b0: 7263 302d 3e64 6174 6120 2b20 6930 312a  rc0->data + i01*
-000369c0: 6e62 3031 202b 2069 3032 2a6e 6230 3220  nb01 + i02*nb02 
-000369d0: 2b20 6930 332a 6e62 3033 3b0a 2020 2020  + i03*nb03;.    
+000368e0: 2020 2069 6420 2b3d 2072 7320 2a20 6972     id += rs * ir
+000368f0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+00036900: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00036910: 696e 7420 6930 3120 3d20 6972 303b 2069  int i01 = ir0; i
+00036920: 3031 203c 2069 7231 3b20 6930 312b 2b29  01 < ir1; i01++)
+00036930: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00036940: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00036950: 6f6e 7374 2063 6861 7220 2a20 7372 6330  onst char * src0
+00036960: 5f70 7472 203d 2028 6368 6172 202a 2920  _ptr = (char *) 
+00036970: 7372 6330 2d3e 6461 7461 202b 2069 3031  src0->data + i01
+00036980: 2a6e 6230 3120 2b20 6930 322a 6e62 3032  *nb01 + i02*nb02
+00036990: 202b 2069 3033 2a6e 6230 333b 0a20 2020   + i03*nb03;.   
+000369a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000369b0: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
+000369c0: 6473 745f 7074 7220 2b20 6964 2c20 7372  dst_ptr + id, sr
+000369d0: 6330 5f70 7472 2c20 7273 293b 0a20 2020  c0_ptr, rs);.   
 000369e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000369f0: 2020 2020 2020 2020 6d65 6d63 7079 2864          memcpy(d
-00036a00: 7374 5f70 7472 202b 2069 642c 2073 7263  st_ptr + id, src
-00036a10: 305f 7074 722c 2072 7329 3b0a 2020 2020  0_ptr, rs);.    
+000369f0: 2020 2020 2020 2020 2069 6420 2b3d 2072           id += r
+00036a00: 733b 0a20 2020 2020 2020 2020 2020 2020  s;.             
+00036a10: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
 00036a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036a30: 2020 2020 2020 2020 6964 202b 3d20 7273          id += rs
-00036a40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00036a50: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00036a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036a70: 2020 2020 6964 202b 3d20 7273 202a 2028      id += rs * (
-00036a80: 6e65 3031 202d 2069 7231 293b 0a20 2020  ne01 - ir1);.   
-00036a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036aa0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00036ab0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00036ac0: 207d 2065 6c73 6520 6966 2028 6473 742d   } else if (dst-
-00036ad0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00036ae0: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
-00036af0: 2020 2020 2020 2020 2020 7369 7a65 5f74            size_t
-00036b00: 2069 6420 3d20 303b 0a20 2020 2020 2020   id = 0;.       
-00036b10: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-00036b20: 2064 7374 5f70 7472 203d 2028 666c 6f61   dst_ptr = (floa
-00036b30: 7420 2a29 2064 7374 2d3e 6461 7461 3b0a  t *) dst->data;.
-00036b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036b50: 2066 6f72 2028 696e 7420 6930 3320 3d20   for (int i03 = 
-00036b60: 303b 2069 3033 203c 206e 6530 333b 2069  0; i03 < ne03; i
-00036b70: 3033 2b2b 2920 7b0a 2020 2020 2020 2020  03++) {.        
-00036b80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00036b90: 2869 6e74 2069 3032 203d 2030 3b20 6930  (int i02 = 0; i0
-00036ba0: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
-00036bb0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00036bc0: 2020 2020 2020 2020 2020 2069 6420 2b3d             id +=
-00036bd0: 206e 6530 3020 2a20 6972 303b 0a20 2020   ne00 * ir0;.   
+00036a30: 2020 2020 2069 6420 2b3d 2072 7320 2a20       id += rs * 
+00036a40: 286e 6530 3120 2d20 6972 3129 3b0a 2020  (ne01 - ir1);.  
+00036a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036a60: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00036a70: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00036a80: 2020 7d20 656c 7365 2069 6620 2864 7374    } else if (dst
+00036a90: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00036aa0: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
+00036ab0: 2020 2020 2020 2020 2020 2073 697a 655f             size_
+00036ac0: 7420 6964 203d 2030 3b0a 2020 2020 2020  t id = 0;.      
+00036ad0: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00036ae0: 2a20 6473 745f 7074 7220 3d20 2866 6c6f  * dst_ptr = (flo
+00036af0: 6174 202a 2920 6473 742d 3e64 6174 613b  at *) dst->data;
+00036b00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00036b10: 2020 666f 7220 2869 6e74 2069 3033 203d    for (int i03 =
+00036b20: 2030 3b20 6930 3320 3c20 6e65 3033 3b20   0; i03 < ne03; 
+00036b30: 6930 332b 2b29 207b 0a20 2020 2020 2020  i03++) {.       
+00036b40: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00036b50: 2028 696e 7420 6930 3220 3d20 303b 2069   (int i02 = 0; i
+00036b60: 3032 203c 206e 6530 323b 2069 3032 2b2b  02 < ne02; i02++
+00036b70: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00036b80: 2020 2020 2020 2020 2020 2020 6964 202b              id +
+00036b90: 3d20 6e65 3030 202a 2069 7230 3b0a 2020  = ne00 * ir0;.  
+00036ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036bb0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00036bc0: 3031 203d 2069 7230 3b20 6930 3120 3c20  01 = ir0; i01 < 
+00036bd0: 6972 313b 2069 3031 2b2b 2920 7b0a 2020  ir1; i01++) {.  
 00036be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036bf0: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
-00036c00: 3120 3d20 6972 303b 2069 3031 203c 2069  1 = ir0; i01 < i
-00036c10: 7231 3b20 6930 312b 2b29 207b 0a20 2020  r1; i01++) {.   
-00036c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036c30: 2020 2020 2020 2020 2063 6f6e 7374 2067           const g
-00036c40: 676d 6c5f 6670 3136 5f74 202a 2073 7263  gml_fp16_t * src
-00036c50: 305f 7074 7220 3d20 2867 676d 6c5f 6670  0_ptr = (ggml_fp
-00036c60: 3136 5f74 202a 2920 2828 6368 6172 202a  16_t *) ((char *
-00036c70: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
-00036c80: 3031 2a6e 6230 3120 2b20 6930 322a 6e62  01*nb01 + i02*nb
-00036c90: 3032 202b 2069 3033 2a6e 6230 3329 3b0a  02 + i03*nb03);.
-00036ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036cb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00036cc0: 2869 6e74 2069 3030 203d 2030 3b20 6930  (int i00 = 0; i0
-00036cd0: 3020 3c20 6e65 3030 3b20 6930 302b 2b29  0 < ne00; i00++)
-00036ce0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00036cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036d00: 2020 2064 7374 5f70 7472 5b69 645d 203d     dst_ptr[id] =
-00036d10: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
-00036d20: 3332 2873 7263 305f 7074 725b 6930 305d  32(src0_ptr[i00]
-00036d30: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00036bf0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00036c00: 6767 6d6c 5f66 7031 365f 7420 2a20 7372  ggml_fp16_t * sr
+00036c10: 6330 5f70 7472 203d 2028 6767 6d6c 5f66  c0_ptr = (ggml_f
+00036c20: 7031 365f 7420 2a29 2028 2863 6861 7220  p16_t *) ((char 
+00036c30: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+00036c40: 6930 312a 6e62 3031 202b 2069 3032 2a6e  i01*nb01 + i02*n
+00036c50: 6230 3220 2b20 6930 332a 6e62 3033 293b  b02 + i03*nb03);
+00036c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036c70: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00036c80: 2028 696e 7420 6930 3020 3d20 303b 2069   (int i00 = 0; i
+00036c90: 3030 203c 206e 6530 303b 2069 3030 2b2b  00 < ne00; i00++
+00036ca0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00036cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036cc0: 2020 2020 6473 745f 7074 725b 6964 5d20      dst_ptr[id] 
+00036cd0: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
+00036ce0: 5033 3228 7372 6330 5f70 7472 5b69 3030  P32(src0_ptr[i00
+00036cf0: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
+00036d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036d10: 2020 2020 6964 2b2b 3b0a 2020 2020 2020      id++;.      
+00036d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036d30: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
 00036d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036d50: 2020 2069 642b 2b3b 0a20 2020 2020 2020     id++;.       
-00036d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036d70: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00036d80: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00036d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036da0: 2020 2020 2020 2020 2069 6420 2b3d 206e           id += n
-00036db0: 6530 3020 2a20 286e 6530 3120 2d20 6972  e00 * (ne01 - ir
-00036dc0: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-00036dd0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00036de0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00036df0: 2020 2020 2020 2020 7d20 656c 7365 2069          } else i
-00036e00: 6620 2867 676d 6c5f 6973 5f71 7561 6e74  f (ggml_is_quant
-00036e10: 697a 6564 2864 7374 2d3e 7479 7065 2929  ized(dst->type))
-00036e20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00036e30: 2020 2071 7561 6e74 697a 655f 726f 775f     quantize_row_
-00036e40: 715f 7420 636f 6e73 7420 7175 616e 7469  q_t const quanti
-00036e50: 7a65 5f72 6f77 5f71 203d 2071 7561 6e74  ze_row_q = quant
-00036e60: 697a 655f 666e 735b 6473 742d 3e74 7970  ize_fns[dst->typ
-00036e70: 655d 2e71 7561 6e74 697a 655f 726f 775f  e].quantize_row_
-00036e80: 713b 0a20 2020 2020 2020 2020 2020 2020  q;.             
-00036e90: 2020 2066 6c6f 6174 202a 2073 7263 305f     float * src0_
-00036ea0: 6633 3220 3d20 2866 6c6f 6174 202a 2920  f32 = (float *) 
-00036eb0: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
-00036ec0: 286e 6530 3020 2b20 4341 4348 455f 4c49  (ne00 + CACHE_LI
-00036ed0: 4e45 5f53 495a 455f 4633 3229 202a 2069  NE_SIZE_F32) * i
-00036ee0: 7468 3b0a 0a20 2020 2020 2020 2020 2020  th;..           
-00036ef0: 2020 2020 2073 697a 655f 7420 6964 203d       size_t id =
-00036f00: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
-00036f10: 2020 2020 7369 7a65 5f74 2072 7320 3d20      size_t rs = 
-00036f20: 6e62 3020 2a20 286e 6530 3020 2f20 4747  nb0 * (ne00 / GG
-00036f30: 4d4c 5f42 4c43 4b5f 5349 5a45 5b64 7374  ML_BLCK_SIZE[dst
-00036f40: 2d3e 7479 7065 5d29 3b0a 2020 2020 2020  ->type]);.      
-00036f50: 2020 2020 2020 2020 2020 6368 6172 202a            char *
-00036f60: 2064 7374 5f70 7472 203d 2028 6368 6172   dst_ptr = (char
-00036f70: 202a 2920 6473 742d 3e64 6174 613b 0a0a   *) dst->data;..
-00036f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036f90: 666f 7220 2869 6e74 2069 3033 203d 2030  for (int i03 = 0
-00036fa0: 3b20 6930 3320 3c20 6e65 3033 3b20 6930  ; i03 < ne03; i0
-00036fb0: 332b 2b29 207b 0a20 2020 2020 2020 2020  3++) {.         
-00036fc0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00036fd0: 696e 7420 6930 3220 3d20 303b 2069 3032  int i02 = 0; i02
-00036fe0: 203c 206e 6530 323b 2069 3032 2b2b 2920   < ne02; i02++) 
-00036ff0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00037000: 2020 2020 2020 2020 2020 6964 202b 3d20            id += 
-00037010: 7273 202a 2069 7230 3b0a 2020 2020 2020  rs * ir0;.      
+00036d50: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00036d60: 2020 2020 2020 2020 2020 6964 202b 3d20            id += 
+00036d70: 6e65 3030 202a 2028 6e65 3031 202d 2069  ne00 * (ne01 - i
+00036d80: 7231 293b 0a20 2020 2020 2020 2020 2020  r1);.           
+00036d90: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00036da0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00036db0: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+00036dc0: 6966 2028 6767 6d6c 5f69 735f 7175 616e  if (ggml_is_quan
+00036dd0: 7469 7a65 6428 6473 742d 3e74 7970 6529  tized(dst->type)
+00036de0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00036df0: 2020 2020 7175 616e 7469 7a65 5f72 6f77      quantize_row
+00036e00: 5f71 5f74 2063 6f6e 7374 2071 7561 6e74  _q_t const quant
+00036e10: 697a 655f 726f 775f 7120 3d20 7175 616e  ize_row_q = quan
+00036e20: 7469 7a65 5f66 6e73 5b64 7374 2d3e 7479  tize_fns[dst->ty
+00036e30: 7065 5d2e 7175 616e 7469 7a65 5f72 6f77  pe].quantize_row
+00036e40: 5f71 3b0a 2020 2020 2020 2020 2020 2020  _q;.            
+00036e50: 2020 2020 666c 6f61 7420 2a20 7372 6330      float * src0
+00036e60: 5f66 3332 203d 2028 666c 6f61 7420 2a29  _f32 = (float *)
+00036e70: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+00036e80: 2028 6e65 3030 202b 2043 4143 4845 5f4c   (ne00 + CACHE_L
+00036e90: 494e 455f 5349 5a45 5f46 3332 2920 2a20  INE_SIZE_F32) * 
+00036ea0: 6974 683b 0a0a 2020 2020 2020 2020 2020  ith;..          
+00036eb0: 2020 2020 2020 7369 7a65 5f74 2069 6420        size_t id 
+00036ec0: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+00036ed0: 2020 2020 2073 697a 655f 7420 7273 203d       size_t rs =
+00036ee0: 206e 6230 202a 2028 6e65 3030 202f 2047   nb0 * (ne00 / G
+00036ef0: 474d 4c5f 424c 434b 5f53 495a 455b 6473  GML_BLCK_SIZE[ds
+00036f00: 742d 3e74 7970 655d 293b 0a20 2020 2020  t->type]);.     
+00036f10: 2020 2020 2020 2020 2020 2063 6861 7220             char 
+00036f20: 2a20 6473 745f 7074 7220 3d20 2863 6861  * dst_ptr = (cha
+00036f30: 7220 2a29 2064 7374 2d3e 6461 7461 3b0a  r *) dst->data;.
+00036f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036f50: 2066 6f72 2028 696e 7420 6930 3320 3d20   for (int i03 = 
+00036f60: 303b 2069 3033 203c 206e 6530 333b 2069  0; i03 < ne03; i
+00036f70: 3033 2b2b 2920 7b0a 2020 2020 2020 2020  03++) {.        
+00036f80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00036f90: 2869 6e74 2069 3032 203d 2030 3b20 6930  (int i02 = 0; i0
+00036fa0: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
+00036fb0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00036fc0: 2020 2020 2020 2020 2020 2069 6420 2b3d             id +=
+00036fd0: 2072 7320 2a20 6972 303b 0a20 2020 2020   rs * ir0;.     
+00036fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036ff0: 2020 2066 6f72 2028 696e 7420 6930 3120     for (int i01 
+00037000: 3d20 6972 303b 2069 3031 203c 2069 7231  = ir0; i01 < ir1
+00037010: 3b20 6930 312b 2b29 207b 0a20 2020 2020  ; i01++) {.     
 00037020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037030: 2020 666f 7220 2869 6e74 2069 3031 203d    for (int i01 =
-00037040: 2069 7230 3b20 6930 3120 3c20 6972 313b   ir0; i01 < ir1;
-00037050: 2069 3031 2b2b 2920 7b0a 2020 2020 2020   i01++) {.      
-00037060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037070: 2020 2020 2020 636f 6e73 7420 6767 6d6c        const ggml
-00037080: 5f66 7031 365f 7420 2a20 7372 6330 5f70  _fp16_t * src0_p
-00037090: 7472 203d 2028 6767 6d6c 5f66 7031 365f  tr = (ggml_fp16_
-000370a0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-000370b0: 7263 302d 3e64 6174 6120 2b20 6930 312a  rc0->data + i01*
-000370c0: 6e62 3031 202b 2069 3032 2a6e 6230 3220  nb01 + i02*nb02 
-000370d0: 2b20 6930 332a 6e62 3033 293b 0a0a 2020  + i03*nb03);..  
-000370e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000370f0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00037100: 6e74 2069 3030 203d 2030 3b20 6930 3020  nt i00 = 0; i00 
-00037110: 3c20 6e65 3030 3b20 6930 302b 2b29 207b  < ne00; i00++) {
-00037120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037140: 2073 7263 305f 6633 325b 6930 305d 203d   src0_f32[i00] =
-00037150: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
-00037160: 3332 2873 7263 305f 7074 725b 6930 305d  32(src0_ptr[i00]
-00037170: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00037180: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00037190: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000371a0: 2020 2020 2020 2020 2020 2020 2020 7175                qu
-000371b0: 616e 7469 7a65 5f72 6f77 5f71 2873 7263  antize_row_q(src
-000371c0: 305f 6633 322c 2064 7374 5f70 7472 202b  0_f32, dst_ptr +
-000371d0: 2069 642c 206e 6530 3029 3b0a 2020 2020   id, ne00);.    
+00037030: 2020 2020 2020 2063 6f6e 7374 2067 676d         const ggm
+00037040: 6c5f 6670 3136 5f74 202a 2073 7263 305f  l_fp16_t * src0_
+00037050: 7074 7220 3d20 2867 676d 6c5f 6670 3136  ptr = (ggml_fp16
+00037060: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
+00037070: 7372 6330 2d3e 6461 7461 202b 2069 3031  src0->data + i01
+00037080: 2a6e 6230 3120 2b20 6930 322a 6e62 3032  *nb01 + i02*nb02
+00037090: 202b 2069 3033 2a6e 6230 3329 3b0a 0a20   + i03*nb03);.. 
+000370a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000370b0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+000370c0: 696e 7420 6930 3020 3d20 303b 2069 3030  int i00 = 0; i00
+000370d0: 203c 206e 6530 303b 2069 3030 2b2b 2920   < ne00; i00++) 
+000370e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000370f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037100: 2020 7372 6330 5f66 3332 5b69 3030 5d20    src0_f32[i00] 
+00037110: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
+00037120: 5033 3228 7372 6330 5f70 7472 5b69 3030  P32(src0_ptr[i00
+00037130: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
+00037140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037150: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00037160: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+00037170: 7561 6e74 697a 655f 726f 775f 7128 7372  uantize_row_q(sr
+00037180: 6330 5f66 3332 2c20 6473 745f 7074 7220  c0_f32, dst_ptr 
+00037190: 2b20 6964 2c20 6e65 3030 293b 0a20 2020  + id, ne00);.   
+000371a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000371b0: 2020 2020 2020 2020 2069 6420 2b3d 2072           id += r
+000371c0: 733b 0a20 2020 2020 2020 2020 2020 2020  s;.             
+000371d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
 000371e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000371f0: 2020 2020 2020 2020 6964 202b 3d20 7273          id += rs
-00037200: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00037210: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00037220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037230: 2020 2020 6964 202b 3d20 7273 202a 2028      id += rs * (
-00037240: 6e65 3031 202d 2069 7231 293b 0a20 2020  ne01 - ir1);.   
-00037250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037260: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00037270: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00037280: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-00037290: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-000372a0: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
-000372b0: 2054 4f44 4f3a 2069 6d70 6c65 6d65 6e74   TODO: implement
-000372c0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-000372d0: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-000372e0: 2020 2020 2020 2020 2020 2020 2f2f 7072              //pr
-000372f0: 696e 7466 2822 2573 3a20 7468 6973 2069  intf("%s: this i
-00037300: 7320 6e6f 7420 6f70 7469 6d61 6c20 2d20  s not optimal - 
-00037310: 6669 7820 6d65 5c6e 222c 205f 5f66 756e  fix me\n", __fun
-00037320: 635f 5f29 3b0a 0a20 2020 2020 2020 2020  c__);..         
-00037330: 2020 2069 6620 2864 7374 2d3e 7479 7065     if (dst->type
-00037340: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
-00037350: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
-00037360: 2020 2020 2073 697a 655f 7420 6964 203d       size_t id =
-00037370: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
-00037380: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
-00037390: 7074 7220 3d20 2866 6c6f 6174 202a 2920  ptr = (float *) 
-000373a0: 6473 742d 3e64 6174 613b 0a0a 2020 2020  dst->data;..    
-000373b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000373c0: 2869 6e74 2069 3033 203d 2030 3b20 6930  (int i03 = 0; i0
-000373d0: 3320 3c20 6e65 3033 3b20 6930 332b 2b29  3 < ne03; i03++)
-000373e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000373f0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00037400: 6930 3220 3d20 303b 2069 3032 203c 206e  i02 = 0; i02 < n
-00037410: 6530 323b 2069 3032 2b2b 2920 7b0a 2020  e02; i02++) {.  
-00037420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037430: 2020 2020 2020 6964 202b 3d20 6e65 3030        id += ne00
-00037440: 202a 2069 7230 3b0a 2020 2020 2020 2020   * ir0;.        
+000371f0: 2020 2020 2069 6420 2b3d 2072 7320 2a20       id += rs * 
+00037200: 286e 6530 3120 2d20 6972 3129 3b0a 2020  (ne01 - ir1);.  
+00037210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037220: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00037230: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00037240: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00037250: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00037260: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
+00037270: 2f20 544f 444f 3a20 696d 706c 656d 656e  / TODO: implemen
+00037280: 740a 2020 2020 2020 2020 2020 2020 7d0a  t.            }.
+00037290: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+000372a0: 0a20 2020 2020 2020 2020 2020 202f 2f70  .            //p
+000372b0: 7269 6e74 6628 2225 733a 2074 6869 7320  rintf("%s: this 
+000372c0: 6973 206e 6f74 206f 7074 696d 616c 202d  is not optimal -
+000372d0: 2066 6978 206d 655c 6e22 2c20 5f5f 6675   fix me\n", __fu
+000372e0: 6e63 5f5f 293b 0a0a 2020 2020 2020 2020  nc__);..        
+000372f0: 2020 2020 6966 2028 6473 742d 3e74 7970      if (dst->typ
+00037300: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+00037310: 3332 2920 7b0a 2020 2020 2020 2020 2020  32) {.          
+00037320: 2020 2020 2020 7369 7a65 5f74 2069 6420        size_t id 
+00037330: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+00037340: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
+00037350: 5f70 7472 203d 2028 666c 6f61 7420 2a29  _ptr = (float *)
+00037360: 2064 7374 2d3e 6461 7461 3b0a 0a20 2020   dst->data;..   
+00037370: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00037380: 2028 696e 7420 6930 3320 3d20 303b 2069   (int i03 = 0; i
+00037390: 3033 203c 206e 6530 333b 2069 3033 2b2b  03 < ne03; i03++
+000373a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000373b0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+000373c0: 2069 3032 203d 2030 3b20 6930 3220 3c20   i02 = 0; i02 < 
+000373d0: 6e65 3032 3b20 6930 322b 2b29 207b 0a20  ne02; i02++) {. 
+000373e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000373f0: 2020 2020 2020 2069 6420 2b3d 206e 6530         id += ne0
+00037400: 3020 2a20 6972 303b 0a20 2020 2020 2020  0 * ir0;.       
+00037410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037420: 2066 6f72 2028 696e 7420 6930 3120 3d20   for (int i01 = 
+00037430: 6972 303b 2069 3031 203c 2069 7231 3b20  ir0; i01 < ir1; 
+00037440: 6930 312b 2b29 207b 0a20 2020 2020 2020  i01++) {.       
 00037450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037460: 666f 7220 2869 6e74 2069 3031 203d 2069  for (int i01 = i
-00037470: 7230 3b20 6930 3120 3c20 6972 313b 2069  r0; i01 < ir1; i
-00037480: 3031 2b2b 2920 7b0a 2020 2020 2020 2020  01++) {.        
+00037460: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+00037470: 3020 3d20 303b 2069 3030 203c 206e 6530  0 = 0; i00 < ne0
+00037480: 303b 2069 3030 2b2b 2920 7b0a 2020 2020  0; i00++) {.    
 00037490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000374a0: 2020 2020 666f 7220 2869 6e74 2069 3030      for (int i00
-000374b0: 203d 2030 3b20 6930 3020 3c20 6e65 3030   = 0; i00 < ne00
-000374c0: 3b20 6930 302b 2b29 207b 0a20 2020 2020  ; i00++) {.     
-000374d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000374e0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-000374f0: 2067 676d 6c5f 6670 3136 5f74 202a 2073   ggml_fp16_t * s
-00037500: 7263 305f 7074 7220 3d20 2867 676d 6c5f  rc0_ptr = (ggml_
-00037510: 6670 3136 5f74 202a 2920 2828 6368 6172  fp16_t *) ((char
-00037520: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-00037530: 2069 3030 2a6e 6230 3020 2b20 6930 312a   i00*nb00 + i01*
-00037540: 6e62 3031 202b 2069 3032 2a6e 6230 3220  nb01 + i02*nb02 
-00037550: 2b20 6930 332a 6e62 3033 293b 0a0a 2020  + i03*nb03);..  
-00037560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037570: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-00037580: 745f 7074 725b 6964 5d20 3d20 4747 4d4c  t_ptr[id] = GGML
-00037590: 5f46 5031 365f 544f 5f46 5033 3228 2a73  _FP16_TO_FP32(*s
-000375a0: 7263 305f 7074 7229 3b0a 2020 2020 2020  rc0_ptr);.      
+000374a0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000374b0: 7420 6767 6d6c 5f66 7031 365f 7420 2a20  t ggml_fp16_t * 
+000374c0: 7372 6330 5f70 7472 203d 2028 6767 6d6c  src0_ptr = (ggml
+000374d0: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
+000374e0: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+000374f0: 2b20 6930 302a 6e62 3030 202b 2069 3031  + i00*nb00 + i01
+00037500: 2a6e 6230 3120 2b20 6930 322a 6e62 3032  *nb01 + i02*nb02
+00037510: 202b 2069 3033 2a6e 6230 3329 3b0a 0a20   + i03*nb03);.. 
+00037520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037530: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00037540: 7374 5f70 7472 5b69 645d 203d 2047 474d  st_ptr[id] = GGM
+00037550: 4c5f 4650 3136 5f54 4f5f 4650 3332 282a  L_FP16_TO_FP32(*
+00037560: 7372 6330 5f70 7472 293b 0a20 2020 2020  src0_ptr);.     
+00037570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037580: 2020 2020 2020 2020 2020 2069 642b 2b3b             id++;
+00037590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000375a0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
 000375b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000375c0: 2020 2020 2020 2020 2020 6964 2b2b 3b0a            id++;.
+000375c0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
 000375d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000375e0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000375f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037600: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00037610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037620: 6964 202b 3d20 6e65 3030 202a 2028 6e65  id += ne00 * (ne
-00037630: 3031 202d 2069 7231 293b 0a20 2020 2020  01 - ir1);.     
-00037640: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00037650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037660: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-00037670: 2065 6c73 6520 6966 2028 6473 742d 3e74   else if (dst->t
-00037680: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00037690: 5f46 3136 2920 7b0a 2020 2020 2020 2020  _F16) {.        
-000376a0: 2020 2020 2020 2020 7369 7a65 5f74 2069          size_t i
-000376b0: 6420 3d20 303b 0a20 2020 2020 2020 2020  d = 0;.         
-000376c0: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
-000376d0: 5f74 202a 2064 7374 5f70 7472 203d 2028  _t * dst_ptr = (
-000376e0: 6767 6d6c 5f66 7031 365f 7420 2a29 2064  ggml_fp16_t *) d
-000376f0: 7374 2d3e 6461 7461 3b0a 0a20 2020 2020  st->data;..     
-00037700: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00037710: 696e 7420 6930 3320 3d20 303b 2069 3033  int i03 = 0; i03
-00037720: 203c 206e 6530 333b 2069 3033 2b2b 2920   < ne03; i03++) 
-00037730: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00037740: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-00037750: 3032 203d 2030 3b20 6930 3220 3c20 6e65  02 = 0; i02 < ne
-00037760: 3032 3b20 6930 322b 2b29 207b 0a20 2020  02; i02++) {.   
-00037770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037780: 2020 2020 2069 6420 2b3d 206e 6530 3020       id += ne00 
-00037790: 2a20 6972 303b 0a20 2020 2020 2020 2020  * ir0;.         
-000377a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000377b0: 6f72 2028 696e 7420 6930 3120 3d20 6972  or (int i01 = ir
-000377c0: 303b 2069 3031 203c 2069 7231 3b20 6930  0; i01 < ir1; i0
-000377d0: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
+000375e0: 2069 6420 2b3d 206e 6530 3020 2a20 286e   id += ne00 * (n
+000375f0: 6530 3120 2d20 6972 3129 3b0a 2020 2020  e01 - ir1);.    
+00037600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037610: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00037620: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00037630: 7d20 656c 7365 2069 6620 2864 7374 2d3e  } else if (dst->
+00037640: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+00037650: 455f 4631 3629 207b 0a20 2020 2020 2020  E_F16) {.       
+00037660: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+00037670: 6964 203d 2030 3b0a 2020 2020 2020 2020  id = 0;.        
+00037680: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
+00037690: 365f 7420 2a20 6473 745f 7074 7220 3d20  6_t * dst_ptr = 
+000376a0: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
+000376b0: 6473 742d 3e64 6174 613b 0a0a 2020 2020  dst->data;..    
+000376c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000376d0: 2869 6e74 2069 3033 203d 2030 3b20 6930  (int i03 = 0; i0
+000376e0: 3320 3c20 6e65 3033 3b20 6930 332b 2b29  3 < ne03; i03++)
+000376f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00037700: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00037710: 6930 3220 3d20 303b 2069 3032 203c 206e  i02 = 0; i02 < n
+00037720: 6530 323b 2069 3032 2b2b 2920 7b0a 2020  e02; i02++) {.  
+00037730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037740: 2020 2020 2020 6964 202b 3d20 6e65 3030        id += ne00
+00037750: 202a 2069 7230 3b0a 2020 2020 2020 2020   * ir0;.        
+00037760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037770: 666f 7220 2869 6e74 2069 3031 203d 2069  for (int i01 = i
+00037780: 7230 3b20 6930 3120 3c20 6972 313b 2069  r0; i01 < ir1; i
+00037790: 3031 2b2b 2920 7b0a 2020 2020 2020 2020  01++) {.        
+000377a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000377b0: 2020 2020 666f 7220 2869 6e74 2069 3030      for (int i00
+000377c0: 203d 2030 3b20 6930 3020 3c20 6e65 3030   = 0; i00 < ne00
+000377d0: 3b20 6930 302b 2b29 207b 0a20 2020 2020  ; i00++) {.     
 000377e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000377f0: 2020 2066 6f72 2028 696e 7420 6930 3020     for (int i00 
-00037800: 3d20 303b 2069 3030 203c 206e 6530 303b  = 0; i00 < ne00;
-00037810: 2069 3030 2b2b 2920 7b0a 2020 2020 2020   i00++) {.      
-00037820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037830: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00037840: 6767 6d6c 5f66 7031 365f 7420 2a20 7372  ggml_fp16_t * sr
-00037850: 6330 5f70 7472 203d 2028 6767 6d6c 5f66  c0_ptr = (ggml_f
-00037860: 7031 365f 7420 2a29 2028 2863 6861 7220  p16_t *) ((char 
-00037870: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00037880: 6930 302a 6e62 3030 202b 2069 3031 2a6e  i00*nb00 + i01*n
-00037890: 6230 3120 2b20 6930 322a 6e62 3032 202b  b01 + i02*nb02 +
-000378a0: 2069 3033 2a6e 6230 3329 3b0a 0a20 2020   i03*nb03);..   
+000377f0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00037800: 2067 676d 6c5f 6670 3136 5f74 202a 2073   ggml_fp16_t * s
+00037810: 7263 305f 7074 7220 3d20 2867 676d 6c5f  rc0_ptr = (ggml_
+00037820: 6670 3136 5f74 202a 2920 2828 6368 6172  fp16_t *) ((char
+00037830: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00037840: 2069 3030 2a6e 6230 3020 2b20 6930 312a   i00*nb00 + i01*
+00037850: 6e62 3031 202b 2069 3032 2a6e 6230 3220  nb01 + i02*nb02 
+00037860: 2b20 6930 332a 6e62 3033 293b 0a0a 2020  + i03*nb03);..  
+00037870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037880: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+00037890: 745f 7074 725b 6964 5d20 3d20 2a73 7263  t_ptr[id] = *src
+000378a0: 305f 7074 723b 0a20 2020 2020 2020 2020  0_ptr;.         
 000378b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000378c0: 2020 2020 2020 2020 2020 2020 2064 7374               dst
-000378d0: 5f70 7472 5b69 645d 203d 202a 7372 6330  _ptr[id] = *src0
-000378e0: 5f70 7472 3b0a 2020 2020 2020 2020 2020  _ptr;.          
+000378c0: 2020 2020 2020 2069 642b 2b3b 0a20 2020         id++;.   
+000378d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000378e0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
 000378f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037900: 2020 2020 2020 6964 2b2b 3b0a 2020 2020        id++;.    
-00037910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037920: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00037930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037940: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00037950: 2020 2020 2020 2020 2020 2020 6964 202b              id +
-00037960: 3d20 6e65 3030 202a 2028 6e65 3031 202d  = ne00 * (ne01 -
-00037970: 2069 7231 293b 0a20 2020 2020 2020 2020   ir1);.         
-00037980: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00037990: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-000379a0: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-000379b0: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
-000379c0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-000379d0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-000379e0: 2069 6d70 6c65 6d65 6e74 0a20 2020 2020   implement.     
-000379f0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00037a00: 207d 0a20 2020 2020 2020 2072 6574 7572   }.        retur
-00037a10: 6e3b 0a20 2020 207d 0a0a 2020 2020 2f2f  n;.    }..    //
-00037a20: 2064 7374 2063 6f75 6e74 6572 730a 2020   dst counters.  
-00037a30: 2020 696e 7436 345f 7420 6931 3020 3d20    int64_t i10 = 
-00037a40: 303b 0a20 2020 2069 6e74 3634 5f74 2069  0;.    int64_t i
-00037a50: 3131 203d 2030 3b0a 2020 2020 696e 7436  11 = 0;.    int6
-00037a60: 345f 7420 6931 3220 3d20 303b 0a20 2020  4_t i12 = 0;.   
-00037a70: 2069 6e74 3634 5f74 2069 3133 203d 2030   int64_t i13 = 0
-00037a80: 3b0a 0a20 2020 2069 6620 2864 7374 2d3e  ;..    if (dst->
-00037a90: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-00037aa0: 455f 4631 3629 207b 0a20 2020 2020 2020  E_F16) {.       
-00037ab0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
-00037ac0: 3320 3d20 303b 2069 3033 203c 206e 6530  3 = 0; i03 < ne0
-00037ad0: 333b 2069 3033 2b2b 2920 7b0a 2020 2020  3; i03++) {.    
-00037ae0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00037af0: 3634 5f74 2069 3032 203d 2030 3b20 6930  64_t i02 = 0; i0
-00037b00: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
-00037b10: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00037b20: 2020 2069 3130 202b 3d20 6e65 3030 202a     i10 += ne00 *
-00037b30: 2069 7230 3b0a 2020 2020 2020 2020 2020   ir0;.          
-00037b40: 2020 2020 2020 7768 696c 6520 2869 3130        while (i10
-00037b50: 203e 3d20 6e65 3029 207b 0a20 2020 2020   >= ne0) {.     
-00037b60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00037b70: 3130 202d 3d20 6e65 303b 0a20 2020 2020  10 -= ne0;.     
-00037b80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00037b90: 6620 282b 2b69 3131 203d 3d20 6e65 3129  f (++i11 == ne1)
-00037ba0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00037bb0: 2020 2020 2020 2020 2020 2069 3131 203d             i11 =
-00037bc0: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
-00037bd0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00037be0: 2b2b 6931 3220 3d3d 206e 6532 2920 7b0a  ++i12 == ne2) {.
-00037bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037c00: 2020 2020 2020 2020 2020 2020 6931 3220              i12 
-00037c10: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-00037c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037c30: 2069 6620 282b 2b69 3133 203d 3d20 6e65   if (++i13 == ne
-00037c40: 3329 207b 0a20 2020 2020 2020 2020 2020  3) {.           
+00037900: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00037910: 2020 2020 2020 2020 2020 2020 2069 6420               id 
+00037920: 2b3d 206e 6530 3020 2a20 286e 6530 3120  += ne00 * (ne01 
+00037930: 2d20 6972 3129 3b0a 2020 2020 2020 2020  - ir1);.        
+00037940: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00037950: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00037960: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00037970: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+00037980: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00037990: 2866 616c 7365 293b 202f 2f20 544f 444f  (false); // TODO
+000379a0: 3a20 696d 706c 656d 656e 740a 2020 2020  : implement.    
+000379b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000379c0: 2020 7d0a 2020 2020 2020 2020 7265 7475    }.        retu
+000379d0: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
+000379e0: 2f20 6473 7420 636f 756e 7465 7273 0a20  / dst counters. 
+000379f0: 2020 2069 6e74 3634 5f74 2069 3130 203d     int64_t i10 =
+00037a00: 2030 3b0a 2020 2020 696e 7436 345f 7420   0;.    int64_t 
+00037a10: 6931 3120 3d20 303b 0a20 2020 2069 6e74  i11 = 0;.    int
+00037a20: 3634 5f74 2069 3132 203d 2030 3b0a 2020  64_t i12 = 0;.  
+00037a30: 2020 696e 7436 345f 7420 6931 3320 3d20    int64_t i13 = 
+00037a40: 303b 0a0a 2020 2020 6966 2028 6473 742d  0;..    if (dst-
+00037a50: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00037a60: 5045 5f46 3136 2920 7b0a 2020 2020 2020  PE_F16) {.      
+00037a70: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+00037a80: 3033 203d 2030 3b20 6930 3320 3c20 6e65  03 = 0; i03 < ne
+00037a90: 3033 3b20 6930 332b 2b29 207b 0a20 2020  03; i03++) {.   
+00037aa0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00037ab0: 7436 345f 7420 6930 3220 3d20 303b 2069  t64_t i02 = 0; i
+00037ac0: 3032 203c 206e 6530 323b 2069 3032 2b2b  02 < ne02; i02++
+00037ad0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00037ae0: 2020 2020 6931 3020 2b3d 206e 6530 3020      i10 += ne00 
+00037af0: 2a20 6972 303b 0a20 2020 2020 2020 2020  * ir0;.         
+00037b00: 2020 2020 2020 2077 6869 6c65 2028 6931         while (i1
+00037b10: 3020 3e3d 206e 6530 2920 7b0a 2020 2020  0 >= ne0) {.    
+00037b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037b30: 6931 3020 2d3d 206e 6530 3b0a 2020 2020  i10 -= ne0;.    
+00037b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037b50: 6966 2028 2b2b 6931 3120 3d3d 206e 6531  if (++i11 == ne1
+00037b60: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00037b70: 2020 2020 2020 2020 2020 2020 6931 3120              i11 
+00037b80: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+00037b90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00037ba0: 282b 2b69 3132 203d 3d20 6e65 3229 207b  (++i12 == ne2) {
+00037bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037bc0: 2020 2020 2020 2020 2020 2020 2069 3132               i12
+00037bd0: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+00037be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037bf0: 2020 6966 2028 2b2b 6931 3320 3d3d 206e    if (++i13 == n
+00037c00: 6533 2920 7b0a 2020 2020 2020 2020 2020  e3) {.          
+00037c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037c20: 2020 2020 2020 6931 3320 3d20 303b 0a20        i13 = 0;. 
+00037c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037c40: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
 00037c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037c60: 2020 2020 2069 3133 203d 2030 3b0a 2020       i13 = 0;.  
-00037c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037c80: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00037c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037ca0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00037cb0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00037cc0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00037cd0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00037ce0: 7220 2869 6e74 3634 5f74 2069 3031 203d  r (int64_t i01 =
-00037cf0: 2069 7230 3b20 6930 3120 3c20 6972 313b   ir0; i01 < ir1;
-00037d00: 2069 3031 2b2b 2920 7b0a 2020 2020 2020   i01++) {.      
-00037d10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00037d20: 7220 2869 6e74 3634 5f74 2069 3030 203d  r (int64_t i00 =
-00037d30: 2030 3b20 6930 3020 3c20 6e65 3030 3b20   0; i00 < ne00; 
-00037d40: 6930 302b 2b29 207b 0a20 2020 2020 2020  i00++) {.       
-00037d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037d60: 2063 6f6e 7374 2063 6861 7220 2a20 7372   const char * sr
-00037d70: 6330 5f70 7472 203d 2028 2863 6861 7220  c0_ptr = ((char 
-00037d80: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00037d90: 6930 302a 6e62 3030 202b 2069 3031 2a6e  i00*nb00 + i01*n
-00037da0: 6230 3120 2b20 6930 322a 6e62 3032 202b  b01 + i02*nb02 +
-00037db0: 2069 3033 2a6e 6230 3329 3b0a 2020 2020   i03*nb03);.    
-00037dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037dd0: 2020 2020 2020 2020 2020 6368 6172 202a            char *
-00037de0: 2064 7374 5f70 7472 2020 3d20 2828 6368   dst_ptr  = ((ch
-00037df0: 6172 202a 2920 2064 7374 2d3e 6461 7461  ar *)  dst->data
-00037e00: 202b 2069 3130 2a6e 6230 2020 2b20 6931   + i10*nb0  + i1
-00037e10: 312a 6e62 3120 202b 2069 3132 2a6e 6232  1*nb1  + i12*nb2
-00037e20: 2020 2b20 6931 332a 6e62 3329 3b0a 0a20    + i13*nb3);.. 
-00037e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037e40: 2020 2020 2020 206d 656d 6370 7928 6473         memcpy(ds
-00037e50: 745f 7074 722c 2073 7263 305f 7074 722c  t_ptr, src0_ptr,
-00037e60: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
-00037e70: 365f 7429 293b 0a0a 2020 2020 2020 2020  6_t));..        
-00037e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037e90: 6966 2028 2b2b 6931 3020 3d3d 206e 6530  if (++i10 == ne0
-00037ea0: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
-00037eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037ec0: 2069 3130 203d 2030 3b0a 2020 2020 2020   i10 = 0;.      
-00037ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037ee0: 2020 2020 2020 6966 2028 2b2b 6931 3120        if (++i11 
-00037ef0: 3d3d 206e 6530 3129 207b 0a20 2020 2020  == ne01) {.     
-00037f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f10: 2020 2020 2020 2020 2020 2069 3131 203d             i11 =
-00037f20: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
-00037f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f40: 2020 2020 6966 2028 2b2b 6931 3220 3d3d      if (++i12 ==
-00037f50: 206e 6530 3229 207b 0a20 2020 2020 2020   ne02) {.       
-00037f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f70: 2020 2020 2020 2020 2020 2020 2069 3132               i12
-00037f80: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+00037c60: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00037c70: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00037c80: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00037c90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00037ca0: 6f72 2028 696e 7436 345f 7420 6930 3120  or (int64_t i01 
+00037cb0: 3d20 6972 303b 2069 3031 203c 2069 7231  = ir0; i01 < ir1
+00037cc0: 3b20 6930 312b 2b29 207b 0a20 2020 2020  ; i01++) {.     
+00037cd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00037ce0: 6f72 2028 696e 7436 345f 7420 6930 3020  or (int64_t i00 
+00037cf0: 3d20 303b 2069 3030 203c 206e 6530 303b  = 0; i00 < ne00;
+00037d00: 2069 3030 2b2b 2920 7b0a 2020 2020 2020   i00++) {.      
+00037d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037d20: 2020 636f 6e73 7420 6368 6172 202a 2073    const char * s
+00037d30: 7263 305f 7074 7220 3d20 2828 6368 6172  rc0_ptr = ((char
+00037d40: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00037d50: 2069 3030 2a6e 6230 3020 2b20 6930 312a   i00*nb00 + i01*
+00037d60: 6e62 3031 202b 2069 3032 2a6e 6230 3220  nb01 + i02*nb02 
+00037d70: 2b20 6930 332a 6e62 3033 293b 0a20 2020  + i03*nb03);.   
+00037d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037d90: 2020 2020 2020 2020 2020 2063 6861 7220             char 
+00037da0: 2a20 6473 745f 7074 7220 203d 2028 2863  * dst_ptr  = ((c
+00037db0: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
+00037dc0: 6120 2b20 6931 302a 6e62 3020 202b 2069  a + i10*nb0  + i
+00037dd0: 3131 2a6e 6231 2020 2b20 6931 322a 6e62  11*nb1  + i12*nb
+00037de0: 3220 202b 2069 3133 2a6e 6233 293b 0a0a  2  + i13*nb3);..
+00037df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037e00: 2020 2020 2020 2020 6d65 6d63 7079 2864          memcpy(d
+00037e10: 7374 5f70 7472 2c20 7372 6330 5f70 7472  st_ptr, src0_ptr
+00037e20: 2c20 7369 7a65 6f66 2867 676d 6c5f 6670  , sizeof(ggml_fp
+00037e30: 3136 5f74 2929 3b0a 0a20 2020 2020 2020  16_t));..       
+00037e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037e50: 2069 6620 282b 2b69 3130 203d 3d20 6e65   if (++i10 == ne
+00037e60: 3030 2920 7b0a 2020 2020 2020 2020 2020  00) {.          
+00037e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037e80: 2020 6931 3020 3d20 303b 0a20 2020 2020    i10 = 0;.     
+00037e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037ea0: 2020 2020 2020 2069 6620 282b 2b69 3131         if (++i11
+00037eb0: 203d 3d20 6e65 3031 2920 7b0a 2020 2020   == ne01) {.    
+00037ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037ed0: 2020 2020 2020 2020 2020 2020 6931 3120              i11 
+00037ee0: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+00037ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037f00: 2020 2020 2069 6620 282b 2b69 3132 203d       if (++i12 =
+00037f10: 3d20 6e65 3032 2920 7b0a 2020 2020 2020  = ne02) {.      
+00037f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037f30: 2020 2020 2020 2020 2020 2020 2020 6931                i1
+00037f40: 3220 3d20 303b 0a20 2020 2020 2020 2020  2 = 0;.         
+00037f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037f60: 2020 2020 2020 2020 2020 2069 6620 282b             if (+
+00037f70: 2b69 3133 203d 3d20 6e65 3033 2920 7b0a  +i13 == ne03) {.
+00037f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00037f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037fa0: 2020 2020 2020 2020 2020 6966 2028 2b2b            if (++
-00037fb0: 6931 3320 3d3d 206e 6530 3329 207b 0a20  i13 == ne03) {. 
+00037fa0: 2020 2020 2020 2020 6931 3320 3d20 303b          i13 = 0;
+00037fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00037fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037fe0: 2020 2020 2020 2069 3133 203d 2030 3b0a         i13 = 0;.
-00037ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037fd0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00037fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037ff0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
 00038000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038010: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00038020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038030: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00038040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038050: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00038060: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00038070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038080: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00038090: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000380a0: 2020 2020 2020 2020 6931 3020 2b3d 206e          i10 += n
-000380b0: 6530 3020 2a20 286e 6530 3120 2d20 6972  e00 * (ne01 - ir
-000380c0: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-000380d0: 2020 2020 7768 696c 6520 2869 3130 203e      while (i10 >
-000380e0: 3d20 6e65 3029 207b 0a20 2020 2020 2020  = ne0) {.       
-000380f0: 2020 2020 2020 2020 2020 2020 2069 3130               i10
-00038100: 202d 3d20 6e65 303b 0a20 2020 2020 2020   -= ne0;.       
-00038110: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00038120: 282b 2b69 3131 203d 3d20 6e65 3129 207b  (++i11 == ne1) {
-00038130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038140: 2020 2020 2020 2020 2069 3131 203d 2030           i11 = 0
-00038150: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00038160: 2020 2020 2020 2020 2020 6966 2028 2b2b            if (++
-00038170: 6931 3220 3d3d 206e 6532 2920 7b0a 2020  i12 == ne2) {.  
-00038180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038190: 2020 2020 2020 2020 2020 6931 3220 3d20            i12 = 
-000381a0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-000381b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000381c0: 6620 282b 2b69 3133 203d 3d20 6e65 3329  f (++i13 == ne3)
-000381d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00038010: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00038020: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00038030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038040: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00038050: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00038060: 2020 2020 2020 2020 2069 3130 202b 3d20           i10 += 
+00038070: 6e65 3030 202a 2028 6e65 3031 202d 2069  ne00 * (ne01 - i
+00038080: 7231 293b 0a20 2020 2020 2020 2020 2020  r1);.           
+00038090: 2020 2020 2077 6869 6c65 2028 6931 3020       while (i10 
+000380a0: 3e3d 206e 6530 2920 7b0a 2020 2020 2020  >= ne0) {.      
+000380b0: 2020 2020 2020 2020 2020 2020 2020 6931                i1
+000380c0: 3020 2d3d 206e 6530 3b0a 2020 2020 2020  0 -= ne0;.      
+000380d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000380e0: 2028 2b2b 6931 3120 3d3d 206e 6531 2920   (++i11 == ne1) 
+000380f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00038100: 2020 2020 2020 2020 2020 6931 3120 3d20            i11 = 
+00038110: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+00038120: 2020 2020 2020 2020 2020 2069 6620 282b             if (+
+00038130: 2b69 3132 203d 3d20 6e65 3229 207b 0a20  +i12 == ne2) {. 
+00038140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038150: 2020 2020 2020 2020 2020 2069 3132 203d             i12 =
+00038160: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00038170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038180: 6966 2028 2b2b 6931 3320 3d3d 206e 6533  if (++i13 == ne3
+00038190: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000381a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000381b0: 2020 2020 6931 3320 3d20 303b 0a20 2020      i13 = 0;.   
+000381c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000381d0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
 000381e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000381f0: 2020 2069 3133 203d 2030 3b0a 2020 2020     i13 = 0;.    
-00038200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038210: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00038220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038230: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00038240: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00038250: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00038260: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00038270: 2020 7d0a 2020 2020 7d20 656c 7365 2069    }.    } else i
-00038280: 6620 2864 7374 2d3e 7479 7065 203d 3d20  f (dst->type == 
-00038290: 4747 4d4c 5f54 5950 455f 4633 3229 207b  GGML_TYPE_F32) {
-000382a0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-000382b0: 7436 345f 7420 6930 3320 3d20 303b 2069  t64_t i03 = 0; i
-000382c0: 3033 203c 206e 6530 333b 2069 3033 2b2b  03 < ne03; i03++
-000382d0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000382e0: 666f 7220 2869 6e74 3634 5f74 2069 3032  for (int64_t i02
-000382f0: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
-00038300: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
-00038310: 2020 2020 2020 2020 2020 2069 3130 202b             i10 +
-00038320: 3d20 6e65 3030 202a 2069 7230 3b0a 2020  = ne00 * ir0;.  
-00038330: 2020 2020 2020 2020 2020 2020 2020 7768                wh
-00038340: 696c 6520 2869 3130 203e 3d20 6e65 3029  ile (i10 >= ne0)
-00038350: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00038360: 2020 2020 2020 2069 3130 202d 3d20 6e65         i10 -= ne
-00038370: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-00038380: 2020 2020 2020 2069 6620 282b 2b69 3131         if (++i11
-00038390: 203d 3d20 6e65 3129 207b 0a20 2020 2020   == ne1) {.     
-000383a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000383b0: 2020 2069 3131 203d 2030 3b0a 2020 2020     i11 = 0;.    
-000383c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000383d0: 2020 2020 6966 2028 2b2b 6931 3220 3d3d      if (++i12 ==
-000383e0: 206e 6532 2920 7b0a 2020 2020 2020 2020   ne2) {.        
-000383f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038400: 2020 2020 6931 3220 3d20 303b 0a20 2020      i12 = 0;.   
-00038410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038420: 2020 2020 2020 2020 2069 6620 282b 2b69           if (++i
-00038430: 3133 203d 3d20 6e65 3329 207b 0a20 2020  13 == ne3) {.   
-00038440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038450: 2020 2020 2020 2020 2020 2020 2069 3133               i13
-00038460: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
-00038470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038480: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00038490: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000384a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000384b0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-000384c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000384d0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-000384e0: 5f74 2069 3031 203d 2069 7230 3b20 6930  _t i01 = ir0; i0
-000384f0: 3120 3c20 6972 313b 2069 3031 2b2b 2920  1 < ir1; i01++) 
+000381f0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00038200: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00038210: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00038220: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00038230: 2020 207d 0a20 2020 207d 2065 6c73 6520     }.    } else 
+00038240: 6966 2028 6473 742d 3e74 7970 6520 3d3d  if (dst->type ==
+00038250: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
+00038260: 7b0a 2020 2020 2020 2020 666f 7220 2869  {.        for (i
+00038270: 6e74 3634 5f74 2069 3033 203d 2030 3b20  nt64_t i03 = 0; 
+00038280: 6930 3320 3c20 6e65 3033 3b20 6930 332b  i03 < ne03; i03+
+00038290: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000382a0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+000382b0: 3220 3d20 303b 2069 3032 203c 206e 6530  2 = 0; i02 < ne0
+000382c0: 323b 2069 3032 2b2b 2920 7b0a 2020 2020  2; i02++) {.    
+000382d0: 2020 2020 2020 2020 2020 2020 6931 3020              i10 
+000382e0: 2b3d 206e 6530 3020 2a20 6972 303b 0a20  += ne00 * ir0;. 
+000382f0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00038300: 6869 6c65 2028 6931 3020 3e3d 206e 6530  hile (i10 >= ne0
+00038310: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00038320: 2020 2020 2020 2020 6931 3020 2d3d 206e          i10 -= n
+00038330: 6530 3b0a 2020 2020 2020 2020 2020 2020  e0;.            
+00038340: 2020 2020 2020 2020 6966 2028 2b2b 6931          if (++i1
+00038350: 3120 3d3d 206e 6531 2920 7b0a 2020 2020  1 == ne1) {.    
+00038360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038370: 2020 2020 6931 3120 3d20 303b 0a20 2020      i11 = 0;.   
+00038380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038390: 2020 2020 2069 6620 282b 2b69 3132 203d       if (++i12 =
+000383a0: 3d20 6e65 3229 207b 0a20 2020 2020 2020  = ne2) {.       
+000383b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000383c0: 2020 2020 2069 3132 203d 2030 3b0a 2020       i12 = 0;.  
+000383d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000383e0: 2020 2020 2020 2020 2020 6966 2028 2b2b            if (++
+000383f0: 6931 3320 3d3d 206e 6533 2920 7b0a 2020  i13 == ne3) {.  
+00038400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038410: 2020 2020 2020 2020 2020 2020 2020 6931                i1
+00038420: 3320 3d20 303b 0a20 2020 2020 2020 2020  3 = 0;.         
+00038430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038440: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00038450: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00038460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038470: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00038480: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00038490: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+000384a0: 345f 7420 6930 3120 3d20 6972 303b 2069  4_t i01 = ir0; i
+000384b0: 3031 203c 2069 7231 3b20 6930 312b 2b29  01 < ir1; i01++)
+000384c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000384d0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+000384e0: 345f 7420 6930 3020 3d20 303b 2069 3030  4_t i00 = 0; i00
+000384f0: 203c 206e 6530 303b 2069 3030 2b2b 2920   < ne00; i00++) 
 00038500: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00038510: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00038520: 5f74 2069 3030 203d 2030 3b20 6930 3020  _t i00 = 0; i00 
-00038530: 3c20 6e65 3030 3b20 6930 302b 2b29 207b  < ne00; i00++) {
-00038540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038550: 2020 2020 2020 2020 2063 6f6e 7374 2063           const c
-00038560: 6861 7220 2a20 7372 6330 5f70 7472 203d  har * src0_ptr =
-00038570: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-00038580: 3e64 6174 6120 2b20 6930 302a 6e62 3030  >data + i00*nb00
-00038590: 202b 2069 3031 2a6e 6230 3120 2b20 6930   + i01*nb01 + i0
-000385a0: 322a 6e62 3032 202b 2069 3033 2a6e 6230  2*nb02 + i03*nb0
-000385b0: 3329 3b0a 2020 2020 2020 2020 2020 2020  3);.            
-000385c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000385d0: 2020 6368 6172 202a 2064 7374 5f70 7472    char * dst_ptr
-000385e0: 2020 3d20 2828 6368 6172 202a 2920 2064    = ((char *)  d
-000385f0: 7374 2d3e 6461 7461 202b 2069 3130 2a6e  st->data + i10*n
-00038600: 6230 2020 2b20 6931 312a 6e62 3120 202b  b0  + i11*nb1  +
-00038610: 2069 3132 2a6e 6232 2020 2b20 6931 332a   i12*nb2  + i13*
-00038620: 6e62 3329 3b0a 0a20 2020 2020 2020 2020  nb3);..         
-00038630: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-00038640: 2866 6c6f 6174 202a 2920 6473 745f 7074  (float *) dst_pt
-00038650: 7220 3d20 4747 4d4c 5f46 5031 365f 544f  r = GGML_FP16_TO
-00038660: 5f46 5033 3228 2a28 636f 6e73 7420 6767  _FP32(*(const gg
-00038670: 6d6c 5f66 7031 365f 7420 2a29 2073 7263  ml_fp16_t *) src
-00038680: 305f 7074 7229 3b0a 0a20 2020 2020 2020  0_ptr);..       
-00038690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000386a0: 2069 6620 282b 2b69 3130 203d 3d20 6e65   if (++i10 == ne
-000386b0: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
-000386c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000386d0: 2069 3130 203d 2030 3b0a 2020 2020 2020   i10 = 0;.      
-000386e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000386f0: 2020 2020 2020 6966 2028 2b2b 6931 3120        if (++i11 
-00038700: 3d3d 206e 6531 2920 7b0a 2020 2020 2020  == ne1) {.      
-00038710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038720: 2020 2020 2020 2020 2020 6931 3120 3d20            i11 = 
-00038730: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-00038740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038750: 2020 2069 6620 282b 2b69 3132 203d 3d20     if (++i12 == 
-00038760: 6e65 3229 207b 0a20 2020 2020 2020 2020  ne2) {.         
-00038770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038780: 2020 2020 2020 2020 2020 2069 3132 203d             i12 =
-00038790: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00038510: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00038520: 6368 6172 202a 2073 7263 305f 7074 7220  char * src0_ptr 
+00038530: 3d20 2828 6368 6172 202a 2920 7372 6330  = ((char *) src0
+00038540: 2d3e 6461 7461 202b 2069 3030 2a6e 6230  ->data + i00*nb0
+00038550: 3020 2b20 6930 312a 6e62 3031 202b 2069  0 + i01*nb01 + i
+00038560: 3032 2a6e 6230 3220 2b20 6930 332a 6e62  02*nb02 + i03*nb
+00038570: 3033 293b 0a20 2020 2020 2020 2020 2020  03);.           
+00038580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038590: 2020 2063 6861 7220 2a20 6473 745f 7074     char * dst_pt
+000385a0: 7220 203d 2028 2863 6861 7220 2a29 2020  r  = ((char *)  
+000385b0: 6473 742d 3e64 6174 6120 2b20 6931 302a  dst->data + i10*
+000385c0: 6e62 3020 202b 2069 3131 2a6e 6231 2020  nb0  + i11*nb1  
+000385d0: 2b20 6931 322a 6e62 3220 202b 2069 3133  + i12*nb2  + i13
+000385e0: 2a6e 6233 293b 0a0a 2020 2020 2020 2020  *nb3);..        
+000385f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038600: 2a28 666c 6f61 7420 2a29 2064 7374 5f70  *(float *) dst_p
+00038610: 7472 203d 2047 474d 4c5f 4650 3136 5f54  tr = GGML_FP16_T
+00038620: 4f5f 4650 3332 282a 2863 6f6e 7374 2067  O_FP32(*(const g
+00038630: 676d 6c5f 6670 3136 5f74 202a 2920 7372  gml_fp16_t *) sr
+00038640: 6330 5f70 7472 293b 0a0a 2020 2020 2020  c0_ptr);..      
+00038650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038660: 2020 6966 2028 2b2b 6931 3020 3d3d 206e    if (++i10 == n
+00038670: 6530 2920 7b0a 2020 2020 2020 2020 2020  e0) {.          
+00038680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038690: 2020 6931 3020 3d20 303b 0a20 2020 2020    i10 = 0;.     
+000386a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000386b0: 2020 2020 2020 2069 6620 282b 2b69 3131         if (++i11
+000386c0: 203d 3d20 6e65 3129 207b 0a20 2020 2020   == ne1) {.     
+000386d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000386e0: 2020 2020 2020 2020 2020 2069 3131 203d             i11 =
+000386f0: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00038700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038710: 2020 2020 6966 2028 2b2b 6931 3220 3d3d      if (++i12 ==
+00038720: 206e 6532 2920 7b0a 2020 2020 2020 2020   ne2) {.        
+00038730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038740: 2020 2020 2020 2020 2020 2020 6931 3220              i12 
+00038750: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+00038760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038770: 2020 2020 2020 2020 2069 6620 282b 2b69           if (++i
+00038780: 3133 203d 3d20 6e65 3329 207b 0a20 2020  13 == ne3) {.   
+00038790: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000387a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000387b0: 2020 2020 2020 2020 6966 2028 2b2b 6931          if (++i1
-000387c0: 3320 3d3d 206e 6533 2920 7b0a 2020 2020  3 == ne3) {.    
+000387b0: 2020 2020 2069 3133 203d 2030 3b0a 2020       i13 = 0;.  
+000387c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000387d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000387e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000387f0: 2020 2020 6931 3320 3d20 303b 0a20 2020      i13 = 0;.   
-00038800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000387e0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+000387f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038800: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
 00038810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038820: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00038830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038840: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00038850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038860: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00038870: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00038880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038890: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-000388a0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000388b0: 2020 2020 2069 3130 202b 3d20 6e65 3030       i10 += ne00
-000388c0: 202a 2028 6e65 3031 202d 2069 7231 293b   * (ne01 - ir1);
-000388d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000388e0: 2077 6869 6c65 2028 6931 3020 3e3d 206e   while (i10 >= n
-000388f0: 6530 2920 7b0a 2020 2020 2020 2020 2020  e0) {.          
-00038900: 2020 2020 2020 2020 2020 6931 3020 2d3d            i10 -=
-00038910: 206e 6530 3b0a 2020 2020 2020 2020 2020   ne0;.          
-00038920: 2020 2020 2020 2020 2020 6966 2028 2b2b            if (++
-00038930: 6931 3120 3d3d 206e 6531 2920 7b0a 2020  i11 == ne1) {.  
-00038940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038950: 2020 2020 2020 6931 3120 3d20 303b 0a20        i11 = 0;. 
-00038960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038970: 2020 2020 2020 2069 6620 282b 2b69 3132         if (++i12
-00038980: 203d 3d20 6e65 3229 207b 0a20 2020 2020   == ne2) {.     
-00038990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000389a0: 2020 2020 2020 2069 3132 203d 2030 3b0a         i12 = 0;.
+00038820: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00038830: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00038840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038850: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00038860: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00038870: 2020 2020 2020 6931 3020 2b3d 206e 6530        i10 += ne0
+00038880: 3020 2a20 286e 6530 3120 2d20 6972 3129  0 * (ne01 - ir1)
+00038890: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000388a0: 2020 7768 696c 6520 2869 3130 203e 3d20    while (i10 >= 
+000388b0: 6e65 3029 207b 0a20 2020 2020 2020 2020  ne0) {.         
+000388c0: 2020 2020 2020 2020 2020 2069 3130 202d             i10 -
+000388d0: 3d20 6e65 303b 0a20 2020 2020 2020 2020  = ne0;.         
+000388e0: 2020 2020 2020 2020 2020 2069 6620 282b             if (+
+000388f0: 2b69 3131 203d 3d20 6e65 3129 207b 0a20  +i11 == ne1) {. 
+00038900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038910: 2020 2020 2020 2069 3131 203d 2030 3b0a         i11 = 0;.
+00038920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038930: 2020 2020 2020 2020 6966 2028 2b2b 6931          if (++i1
+00038940: 3220 3d3d 206e 6532 2920 7b0a 2020 2020  2 == ne2) {.    
+00038950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038960: 2020 2020 2020 2020 6931 3220 3d20 303b          i12 = 0;
+00038970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038980: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00038990: 282b 2b69 3133 203d 3d20 6e65 3329 207b  (++i13 == ne3) {
+000389a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000389b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000389c0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-000389d0: 2b2b 6931 3320 3d3d 206e 6533 2920 7b0a  ++i13 == ne3) {.
-000389e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000389c0: 2069 3133 203d 2030 3b0a 2020 2020 2020   i13 = 0;.      
+000389d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000389e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
 000389f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038a00: 6931 3320 3d20 303b 0a20 2020 2020 2020  i13 = 0;.       
-00038a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038a20: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00038a30: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00038a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038a50: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00038a60: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00038a70: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00038a80: 0a20 2020 207d 2065 6c73 6520 7b0a 2020  .    } else {.  
-00038a90: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00038aa0: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
-00038ab0: 4f3a 2069 6d70 6c65 6d65 6e74 0a20 2020  O: implement.   
-00038ac0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
-00038ad0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00038ae0: 6f72 7761 7264 5f64 7570 5f66 3332 280a  orward_dup_f32(.
-00038af0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00038b00: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00038b10: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00038b20: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00038b30: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00038b40: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00038b50: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00038b60: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00038b70: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00038b80: 6767 6d6c 5f6e 656c 656d 656e 7473 2864  ggml_nelements(d
-00038b90: 7374 2920 3d3d 2067 676d 6c5f 6e65 6c65  st) == ggml_nele
-00038ba0: 6d65 6e74 7328 7372 6330 2929 3b0a 0a20  ments(src0));.. 
-00038bb0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-00038bc0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-00038bd0: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
-00038be0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00038bf0: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
-00038c00: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-00038c10: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
-00038c20: 696e 7436 345f 7420 6e65 3030 203d 2073  int64_t ne00 = s
-00038c30: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
-00038c40: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00038c50: 3031 203d 2073 7263 302d 3e6e 655b 315d  01 = src0->ne[1]
-00038c60: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00038c70: 345f 7420 6e65 3032 203d 2073 7263 302d  4_t ne02 = src0-
-00038c80: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-00038c90: 7420 696e 7436 345f 7420 6e65 3033 203d  t int64_t ne03 =
-00038ca0: 2073 7263 302d 3e6e 655b 335d 3b0a 0a20   src0->ne[3];.. 
-00038cb0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00038cc0: 206e 6530 203d 2064 7374 2d3e 6e65 5b30   ne0 = dst->ne[0
-00038cd0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00038ce0: 3634 5f74 206e 6531 203d 2064 7374 2d3e  64_t ne1 = dst->
-00038cf0: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
-00038d00: 2069 6e74 3634 5f74 206e 6532 203d 2064   int64_t ne2 = d
-00038d10: 7374 2d3e 6e65 5b32 5d3b 0a20 2020 2063  st->ne[2];.    c
-00038d20: 6f6e 7374 2069 6e74 3634 5f74 206e 6533  onst int64_t ne3
-00038d30: 203d 2064 7374 2d3e 6e65 5b33 5d3b 0a0a   = dst->ne[3];..
-00038d40: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00038d50: 206e 6230 3020 3d20 7372 6330 2d3e 6e62   nb00 = src0->nb
-00038d60: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
-00038d70: 697a 655f 7420 6e62 3031 203d 2073 7263  ize_t nb01 = src
-00038d80: 302d 3e6e 625b 315d 3b0a 2020 2020 636f  0->nb[1];.    co
-00038d90: 6e73 7420 7369 7a65 5f74 206e 6230 3220  nst size_t nb02 
-00038da0: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
-00038db0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00038dc0: 6e62 3033 203d 2073 7263 302d 3e6e 625b  nb03 = src0->nb[
-00038dd0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2073  3];..    const s
-00038de0: 697a 655f 7420 6e62 3020 3d20 6473 742d  ize_t nb0 = dst-
-00038df0: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-00038e00: 7420 7369 7a65 5f74 206e 6231 203d 2064  t size_t nb1 = d
-00038e10: 7374 2d3e 6e62 5b31 5d3b 0a20 2020 2063  st->nb[1];.    c
-00038e20: 6f6e 7374 2073 697a 655f 7420 6e62 3220  onst size_t nb2 
-00038e30: 3d20 6473 742d 3e6e 625b 325d 3b0a 2020  = dst->nb[2];.  
-00038e40: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00038e50: 6233 203d 2064 7374 2d3e 6e62 5b33 5d3b  b3 = dst->nb[3];
-00038e60: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00038e70: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
-00038e80: 683b 202f 2f20 7468 7265 6164 2069 6e64  h; // thread ind
-00038e90: 6578 0a20 2020 2063 6f6e 7374 2069 6e74  ex.    const int
-00038ea0: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
-00038eb0: 7468 3b20 2f2f 206e 756d 6265 7220 6f66  th; // number of
-00038ec0: 2074 6872 6561 6473 0a0a 2020 2020 6966   threads..    if
-00038ed0: 2028 6767 6d6c 5f69 735f 636f 6e74 6967   (ggml_is_contig
-00038ee0: 756f 7573 2873 7263 3029 2026 2620 6767  uous(src0) && gg
-00038ef0: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-00038f00: 2864 7374 2920 2626 2073 7263 302d 3e74  (dst) && src0->t
-00038f10: 7970 6520 3d3d 2064 7374 2d3e 7479 7065  ype == dst->type
-00038f20: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
-00038f30: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00038f40: 5f64 7570 5f73 616d 655f 636f 6e74 2870  _dup_same_cont(p
-00038f50: 6172 616d 732c 2073 7263 302c 2064 7374  arams, src0, dst
-00038f60: 293b 0a20 2020 2020 2020 2072 6574 7572  );.        retur
-00038f70: 6e3b 0a20 2020 207d 0a0a 2020 2020 2f2f  n;.    }..    //
-00038f80: 2070 6172 616c 6c65 6c69 7a65 2062 7920   parallelize by 
-00038f90: 726f 7773 0a20 2020 2063 6f6e 7374 2069  rows.    const i
-00038fa0: 6e74 206e 7220 3d20 6e65 3031 3b0a 2020  nt nr = ne01;.  
-00038fb0: 2020 2f2f 206e 756d 6265 7220 6f66 2072    // number of r
-00038fc0: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
-00038fd0: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
-00038fe0: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
-00038ff0: 202f 206e 7468 3b0a 2020 2020 2f2f 2072   / nth;.    // r
-00039000: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
-00039010: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
-00039020: 7374 2069 6e74 2069 7230 203d 2064 7220  st int ir0 = dr 
-00039030: 2a20 6974 683b 0a20 2020 2063 6f6e 7374  * ith;.    const
-00039040: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-00039050: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-00039060: 2020 2069 6620 2873 7263 302d 3e74 7970     if (src0->typ
-00039070: 6520 3d3d 2064 7374 2d3e 7479 7065 2026  e == dst->type &
-00039080: 260a 2020 2020 2020 2020 6e65 3030 203d  &.        ne00 =
-00039090: 3d20 6e65 3020 2626 0a20 2020 2020 2020  = ne0 &&.       
-000390a0: 206e 6230 3020 3d3d 2047 474d 4c5f 5459   nb00 == GGML_TY
-000390b0: 5045 5f53 495a 455b 7372 6330 2d3e 7479  PE_SIZE[src0->ty
-000390c0: 7065 5d20 2626 206e 6230 203d 3d20 4747  pe] && nb0 == GG
-000390d0: 4d4c 5f54 5950 455f 5349 5a45 5b64 7374  ML_TYPE_SIZE[dst
-000390e0: 2d3e 7479 7065 5d29 207b 0a20 2020 2020  ->type]) {.     
-000390f0: 2020 202f 2f20 636f 7079 2062 7920 726f     // copy by ro
-00039100: 7773 0a20 2020 2020 2020 2063 6f6e 7374  ws.        const
-00039110: 2073 697a 655f 7420 7273 203d 206e 6530   size_t rs = ne0
-00039120: 302a 6e62 3030 3b0a 2020 2020 2020 2020  0*nb00;.        
-00039130: 666f 7220 2869 6e74 3634 5f74 2069 3033  for (int64_t i03
-00039140: 203d 2030 3b20 6930 3320 3c20 6e65 3033   = 0; i03 < ne03
-00039150: 3b20 6930 332b 2b29 207b 0a20 2020 2020  ; i03++) {.     
-00039160: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00039170: 345f 7420 6930 3220 3d20 303b 2069 3032  4_t i02 = 0; i02
-00039180: 203c 206e 6530 323b 2069 3032 2b2b 2920   < ne02; i02++) 
-00039190: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000391a0: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-000391b0: 3031 203d 2069 7230 3b20 6930 3120 3c20  01 = ir0; i01 < 
-000391c0: 6972 313b 2069 3031 2b2b 2920 7b0a 2020  ir1; i01++) {.  
-000391d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000391e0: 2020 6d65 6d63 7079 280a 2020 2020 2020    memcpy(.      
-000391f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039200: 2020 2828 6368 6172 202a 2920 2064 7374    ((char *)  dst
-00039210: 2d3e 6461 7461 202b 2069 3031 2a6e 6231  ->data + i01*nb1
-00039220: 2020 2b20 6930 322a 6e62 3220 202b 2069    + i02*nb2  + i
-00039230: 3033 2a6e 6233 292c 0a20 2020 2020 2020  03*nb3),.       
-00039240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039250: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-00039260: 3e64 6174 6120 2b20 6930 312a 6e62 3031  >data + i01*nb01
-00039270: 202b 2069 3032 2a6e 6230 3220 2b20 6930   + i02*nb02 + i0
-00039280: 332a 6e62 3033 292c 0a20 2020 2020 2020  3*nb03),.       
-00039290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000392a0: 2072 7329 3b0a 2020 2020 2020 2020 2020   rs);.          
-000392b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000392c0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-000392d0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-000392e0: 2020 2020 7d0a 0a20 2020 2069 6620 2867      }..    if (g
-000392f0: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
-00039300: 7328 6473 7429 2920 7b0a 2020 2020 2020  s(dst)) {.      
-00039310: 2020 2f2f 2054 4f44 4f3a 2073 696d 706c    // TODO: simpl
-00039320: 6966 790a 2020 2020 2020 2020 6966 2028  ify.        if (
-00039330: 6e62 3030 203d 3d20 7369 7a65 6f66 2866  nb00 == sizeof(f
-00039340: 6c6f 6174 2929 207b 0a20 2020 2020 2020  loat)) {.       
-00039350: 2020 2020 2069 6620 2864 7374 2d3e 7479       if (dst->ty
-00039360: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-00039370: 4633 3229 207b 0a20 2020 2020 2020 2020  F32) {.         
-00039380: 2020 2020 2020 2073 697a 655f 7420 6964         size_t id
-00039390: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
-000393a0: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
-000393b0: 5f74 2072 7320 3d20 6e65 3030 202a 206e  _t rs = ne00 * n
-000393c0: 6230 303b 0a20 2020 2020 2020 2020 2020  b00;.           
-000393d0: 2020 2020 2063 6861 7220 2a20 6473 745f       char * dst_
-000393e0: 7074 7220 3d20 2863 6861 7220 2a29 2064  ptr = (char *) d
-000393f0: 7374 2d3e 6461 7461 3b0a 0a20 2020 2020  st->data;..     
-00039400: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00039410: 696e 7420 6930 3320 3d20 303b 2069 3033  int i03 = 0; i03
-00039420: 203c 206e 6530 333b 2069 3033 2b2b 2920   < ne03; i03++) 
-00039430: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00039440: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-00039450: 3032 203d 2030 3b20 6930 3220 3c20 6e65  02 = 0; i02 < ne
-00039460: 3032 3b20 6930 322b 2b29 207b 0a20 2020  02; i02++) {.   
-00039470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039480: 2020 2020 2069 6420 2b3d 2072 7320 2a20       id += rs * 
-00039490: 6972 303b 0a20 2020 2020 2020 2020 2020  ir0;.           
-000394a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000394b0: 2028 696e 7420 6930 3120 3d20 6972 303b   (int i01 = ir0;
-000394c0: 2069 3031 203c 2069 7231 3b20 6930 312b   i01 < ir1; i01+
-000394d0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-000394e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394f0: 2063 6f6e 7374 2063 6861 7220 2a20 7372   const char * sr
-00039500: 6330 5f70 7472 203d 2028 6368 6172 202a  c0_ptr = (char *
-00039510: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
-00039520: 3031 2a6e 6230 3120 2b20 6930 322a 6e62  01*nb01 + i02*nb
-00039530: 3032 202b 2069 3033 2a6e 6230 333b 0a20  02 + i03*nb03;. 
+00038a00: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00038a10: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00038a20: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00038a30: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00038a40: 7d0a 2020 2020 7d20 656c 7365 207b 0a20  }.    } else {. 
+00038a50: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00038a60: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
+00038a70: 444f 3a20 696d 706c 656d 656e 740a 2020  DO: implement.  
+00038a80: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+00038a90: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+00038aa0: 666f 7277 6172 645f 6475 705f 6633 3228  forward_dup_f32(
+00038ab0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00038ac0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00038ad0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00038ae0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00038af0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00038b00: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00038b10: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00038b20: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+00038b30: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00038b40: 2867 676d 6c5f 6e65 6c65 6d65 6e74 7328  (ggml_nelements(
+00038b50: 6473 7429 203d 3d20 6767 6d6c 5f6e 656c  dst) == ggml_nel
+00038b60: 656d 656e 7473 2873 7263 3029 293b 0a0a  ements(src0));..
+00038b70: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+00038b80: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00038b90: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
+00038ba0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00038bb0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+00038bc0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00038bd0: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
+00038be0: 2069 6e74 3634 5f74 206e 6530 3020 3d20   int64_t ne00 = 
+00038bf0: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
+00038c00: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00038c10: 6530 3120 3d20 7372 6330 2d3e 6e65 5b31  e01 = src0->ne[1
+00038c20: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00038c30: 3634 5f74 206e 6530 3220 3d20 7372 6330  64_t ne02 = src0
+00038c40: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
+00038c50: 7374 2069 6e74 3634 5f74 206e 6530 3320  st int64_t ne03 
+00038c60: 3d20 7372 6330 2d3e 6e65 5b33 5d3b 0a0a  = src0->ne[3];..
+00038c70: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00038c80: 7420 6e65 3020 3d20 6473 742d 3e6e 655b  t ne0 = dst->ne[
+00038c90: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00038ca0: 7436 345f 7420 6e65 3120 3d20 6473 742d  t64_t ne1 = dst-
+00038cb0: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
+00038cc0: 7420 696e 7436 345f 7420 6e65 3220 3d20  t int64_t ne2 = 
+00038cd0: 6473 742d 3e6e 655b 325d 3b0a 2020 2020  dst->ne[2];.    
+00038ce0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00038cf0: 3320 3d20 6473 742d 3e6e 655b 335d 3b0a  3 = dst->ne[3];.
+00038d00: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00038d10: 7420 6e62 3030 203d 2073 7263 302d 3e6e  t nb00 = src0->n
+00038d20: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+00038d30: 7369 7a65 5f74 206e 6230 3120 3d20 7372  size_t nb01 = sr
+00038d40: 6330 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c0->nb[1];.    c
+00038d50: 6f6e 7374 2073 697a 655f 7420 6e62 3032  onst size_t nb02
+00038d60: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
+00038d70: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00038d80: 206e 6230 3320 3d20 7372 6330 2d3e 6e62   nb03 = src0->nb
+00038d90: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+00038da0: 7369 7a65 5f74 206e 6230 203d 2064 7374  size_t nb0 = dst
+00038db0: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+00038dc0: 7374 2073 697a 655f 7420 6e62 3120 3d20  st size_t nb1 = 
+00038dd0: 6473 742d 3e6e 625b 315d 3b0a 2020 2020  dst->nb[1];.    
+00038de0: 636f 6e73 7420 7369 7a65 5f74 206e 6232  const size_t nb2
+00038df0: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
+00038e00: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+00038e10: 6e62 3320 3d20 6473 742d 3e6e 625b 335d  nb3 = dst->nb[3]
+00038e20: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00038e30: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
+00038e40: 7468 3b20 2f2f 2074 6872 6561 6420 696e  th; // thread in
+00038e50: 6465 780a 2020 2020 636f 6e73 7420 696e  dex.    const in
+00038e60: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
+00038e70: 6e74 683b 202f 2f20 6e75 6d62 6572 206f  nth; // number o
+00038e80: 6620 7468 7265 6164 730a 0a20 2020 2069  f threads..    i
+00038e90: 6620 2867 676d 6c5f 6973 5f63 6f6e 7469  f (ggml_is_conti
+00038ea0: 6775 6f75 7328 7372 6330 2920 2626 2067  guous(src0) && g
+00038eb0: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
+00038ec0: 7328 6473 7429 2026 2620 7372 6330 2d3e  s(dst) && src0->
+00038ed0: 7479 7065 203d 3d20 6473 742d 3e74 7970  type == dst->typ
+00038ee0: 6529 207b 0a20 2020 2020 2020 2067 676d  e) {.        ggm
+00038ef0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00038f00: 645f 6475 705f 7361 6d65 5f63 6f6e 7428  d_dup_same_cont(
+00038f10: 7061 7261 6d73 2c20 7372 6330 2c20 6473  params, src0, ds
+00038f20: 7429 3b0a 2020 2020 2020 2020 7265 7475  t);.        retu
+00038f30: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
+00038f40: 2f20 7061 7261 6c6c 656c 697a 6520 6279  / parallelize by
+00038f50: 2072 6f77 730a 2020 2020 636f 6e73 7420   rows.    const 
+00038f60: 696e 7420 6e72 203d 206e 6530 313b 0a20  int nr = ne01;. 
+00038f70: 2020 202f 2f20 6e75 6d62 6572 206f 6620     // number of 
+00038f80: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
+00038f90: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
+00038fa0: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
+00038fb0: 2920 2f20 6e74 683b 0a20 2020 202f 2f20  ) / nth;.    // 
+00038fc0: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
+00038fd0: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
+00038fe0: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
+00038ff0: 202a 2069 7468 3b0a 2020 2020 636f 6e73   * ith;.    cons
+00039000: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
+00039010: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
+00039020: 2020 2020 6966 2028 7372 6330 2d3e 7479      if (src0->ty
+00039030: 7065 203d 3d20 6473 742d 3e74 7970 6520  pe == dst->type 
+00039040: 2626 0a20 2020 2020 2020 206e 6530 3020  &&.        ne00 
+00039050: 3d3d 206e 6530 2026 260a 2020 2020 2020  == ne0 &&.      
+00039060: 2020 6e62 3030 203d 3d20 4747 4d4c 5f54    nb00 == GGML_T
+00039070: 5950 455f 5349 5a45 5b73 7263 302d 3e74  YPE_SIZE[src0->t
+00039080: 7970 655d 2026 2620 6e62 3020 3d3d 2047  ype] && nb0 == G
+00039090: 474d 4c5f 5459 5045 5f53 495a 455b 6473  GML_TYPE_SIZE[ds
+000390a0: 742d 3e74 7970 655d 2920 7b0a 2020 2020  t->type]) {.    
+000390b0: 2020 2020 2f2f 2063 6f70 7920 6279 2072      // copy by r
+000390c0: 6f77 730a 2020 2020 2020 2020 636f 6e73  ows.        cons
+000390d0: 7420 7369 7a65 5f74 2072 7320 3d20 6e65  t size_t rs = ne
+000390e0: 3030 2a6e 6230 303b 0a20 2020 2020 2020  00*nb00;.       
+000390f0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+00039100: 3320 3d20 303b 2069 3033 203c 206e 6530  3 = 0; i03 < ne0
+00039110: 333b 2069 3033 2b2b 2920 7b0a 2020 2020  3; i03++) {.    
+00039120: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00039130: 3634 5f74 2069 3032 203d 2030 3b20 6930  64_t i02 = 0; i0
+00039140: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
+00039150: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00039160: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+00039170: 6930 3120 3d20 6972 303b 2069 3031 203c  i01 = ir0; i01 <
+00039180: 2069 7231 3b20 6930 312b 2b29 207b 0a20   ir1; i01++) {. 
+00039190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000391a0: 2020 206d 656d 6370 7928 0a20 2020 2020     memcpy(.     
+000391b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000391c0: 2020 2028 2863 6861 7220 2a29 2020 6473     ((char *)  ds
+000391d0: 742d 3e64 6174 6120 2b20 6930 312a 6e62  t->data + i01*nb
+000391e0: 3120 202b 2069 3032 2a6e 6232 2020 2b20  1  + i02*nb2  + 
+000391f0: 6930 332a 6e62 3329 2c0a 2020 2020 2020  i03*nb3),.      
+00039200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039210: 2020 2828 6368 6172 202a 2920 7372 6330    ((char *) src0
+00039220: 2d3e 6461 7461 202b 2069 3031 2a6e 6230  ->data + i01*nb0
+00039230: 3120 2b20 6930 322a 6e62 3032 202b 2069  1 + i02*nb02 + i
+00039240: 3033 2a6e 6230 3329 2c0a 2020 2020 2020  03*nb03),.      
+00039250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039260: 2020 7273 293b 0a20 2020 2020 2020 2020    rs);.         
+00039270: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00039280: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00039290: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+000392a0: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
+000392b0: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
+000392c0: 7573 2864 7374 2929 207b 0a20 2020 2020  us(dst)) {.     
+000392d0: 2020 202f 2f20 544f 444f 3a20 7369 6d70     // TODO: simp
+000392e0: 6c69 6679 0a20 2020 2020 2020 2069 6620  lify.        if 
+000392f0: 286e 6230 3020 3d3d 2073 697a 656f 6628  (nb00 == sizeof(
+00039300: 666c 6f61 7429 2920 7b0a 2020 2020 2020  float)) {.      
+00039310: 2020 2020 2020 6966 2028 6473 742d 3e74        if (dst->t
+00039320: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00039330: 5f46 3332 2920 7b0a 2020 2020 2020 2020  _F32) {.        
+00039340: 2020 2020 2020 2020 7369 7a65 5f74 2069          size_t i
+00039350: 6420 3d20 303b 0a20 2020 2020 2020 2020  d = 0;.         
+00039360: 2020 2020 2020 2063 6f6e 7374 2073 697a         const siz
+00039370: 655f 7420 7273 203d 206e 6530 3020 2a20  e_t rs = ne00 * 
+00039380: 6e62 3030 3b0a 2020 2020 2020 2020 2020  nb00;.          
+00039390: 2020 2020 2020 6368 6172 202a 2064 7374        char * dst
+000393a0: 5f70 7472 203d 2028 6368 6172 202a 2920  _ptr = (char *) 
+000393b0: 6473 742d 3e64 6174 613b 0a0a 2020 2020  dst->data;..    
+000393c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000393d0: 2869 6e74 2069 3033 203d 2030 3b20 6930  (int i03 = 0; i0
+000393e0: 3320 3c20 6e65 3033 3b20 6930 332b 2b29  3 < ne03; i03++)
+000393f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00039400: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00039410: 6930 3220 3d20 303b 2069 3032 203c 206e  i02 = 0; i02 < n
+00039420: 6530 323b 2069 3032 2b2b 2920 7b0a 2020  e02; i02++) {.  
+00039430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039440: 2020 2020 2020 6964 202b 3d20 7273 202a        id += rs *
+00039450: 2069 7230 3b0a 2020 2020 2020 2020 2020   ir0;.          
+00039460: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00039470: 7220 2869 6e74 2069 3031 203d 2069 7230  r (int i01 = ir0
+00039480: 3b20 6930 3120 3c20 6972 313b 2069 3031  ; i01 < ir1; i01
+00039490: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+000394a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000394b0: 2020 636f 6e73 7420 6368 6172 202a 2073    const char * s
+000394c0: 7263 305f 7074 7220 3d20 2863 6861 7220  rc0_ptr = (char 
+000394d0: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+000394e0: 6930 312a 6e62 3031 202b 2069 3032 2a6e  i01*nb01 + i02*n
+000394f0: 6230 3220 2b20 6930 332a 6e62 3033 3b0a  b02 + i03*nb03;.
+00039500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039510: 2020 2020 2020 2020 2020 2020 6d65 6d63              memc
+00039520: 7079 2864 7374 5f70 7472 202b 2069 642c  py(dst_ptr + id,
+00039530: 2073 7263 305f 7074 722c 2072 7329 3b0a   src0_ptr, rs);.
 00039540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039550: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
-00039560: 7928 6473 745f 7074 7220 2b20 6964 2c20  y(dst_ptr + id, 
-00039570: 7372 6330 5f70 7472 2c20 7273 293b 0a20  src0_ptr, rs);. 
+00039550: 2020 2020 2020 2020 2020 2020 6964 202b              id +
+00039560: 3d20 7273 3b0a 2020 2020 2020 2020 2020  = rs;.          
+00039570: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
 00039580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039590: 2020 2020 2020 2020 2020 2069 6420 2b3d             id +=
-000395a0: 2072 733b 0a20 2020 2020 2020 2020 2020   rs;.           
-000395b0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-000395c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000395d0: 2020 2020 2020 2069 6420 2b3d 2072 7320         id += rs 
-000395e0: 2a20 286e 6530 3120 2d20 6972 3129 3b0a  * (ne01 - ir1);.
-000395f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039600: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00039610: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00039620: 2020 2020 7d20 656c 7365 2069 6620 2864      } else if (d
-00039630: 7374 2d3e 7479 7065 203d 3d20 4747 4d4c  st->type == GGML
-00039640: 5f54 5950 455f 4631 3629 207b 0a20 2020  _TYPE_F16) {.   
-00039650: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-00039660: 655f 7420 6964 203d 2030 3b0a 2020 2020  e_t id = 0;.    
-00039670: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00039680: 5f66 7031 365f 7420 2a20 6473 745f 7074  _fp16_t * dst_pt
-00039690: 7220 3d20 2867 676d 6c5f 6670 3136 5f74  r = (ggml_fp16_t
-000396a0: 202a 2920 6473 742d 3e64 6174 613b 0a0a   *) dst->data;..
-000396b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000396c0: 666f 7220 2869 6e74 2069 3033 203d 2030  for (int i03 = 0
-000396d0: 3b20 6930 3320 3c20 6e65 3033 3b20 6930  ; i03 < ne03; i0
-000396e0: 332b 2b29 207b 0a20 2020 2020 2020 2020  3++) {.         
-000396f0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00039700: 696e 7420 6930 3220 3d20 303b 2069 3032  int i02 = 0; i02
-00039710: 203c 206e 6530 323b 2069 3032 2b2b 2920   < ne02; i02++) 
-00039720: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00039730: 2020 2020 2020 2020 2020 6964 202b 3d20            id += 
-00039740: 6e65 3030 202a 2069 7230 3b0a 2020 2020  ne00 * ir0;.    
+00039590: 2020 2020 2020 2020 6964 202b 3d20 7273          id += rs
+000395a0: 202a 2028 6e65 3031 202d 2069 7231 293b   * (ne01 - ir1);
+000395b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000395c0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000395d0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000395e0: 2020 2020 207d 2065 6c73 6520 6966 2028       } else if (
+000395f0: 6473 742d 3e74 7970 6520 3d3d 2047 474d  dst->type == GGM
+00039600: 4c5f 5459 5045 5f46 3136 2920 7b0a 2020  L_TYPE_F16) {.  
+00039610: 2020 2020 2020 2020 2020 2020 2020 7369                si
+00039620: 7a65 5f74 2069 6420 3d20 303b 0a20 2020  ze_t id = 0;.   
+00039630: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00039640: 6c5f 6670 3136 5f74 202a 2064 7374 5f70  l_fp16_t * dst_p
+00039650: 7472 203d 2028 6767 6d6c 5f66 7031 365f  tr = (ggml_fp16_
+00039660: 7420 2a29 2064 7374 2d3e 6461 7461 3b0a  t *) dst->data;.
+00039670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039680: 2066 6f72 2028 696e 7420 6930 3320 3d20   for (int i03 = 
+00039690: 303b 2069 3033 203c 206e 6530 333b 2069  0; i03 < ne03; i
+000396a0: 3033 2b2b 2920 7b0a 2020 2020 2020 2020  03++) {.        
+000396b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000396c0: 2869 6e74 2069 3032 203d 2030 3b20 6930  (int i02 = 0; i0
+000396d0: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
+000396e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000396f0: 2020 2020 2020 2020 2020 2069 6420 2b3d             id +=
+00039700: 206e 6530 3020 2a20 6972 303b 0a20 2020   ne00 * ir0;.   
+00039710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039720: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+00039730: 3120 3d20 6972 303b 2069 3031 203c 2069  1 = ir0; i01 < i
+00039740: 7231 3b20 6930 312b 2b29 207b 0a20 2020  r1; i01++) {.   
 00039750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039760: 2020 2020 666f 7220 2869 6e74 2069 3031      for (int i01
-00039770: 203d 2069 7230 3b20 6930 3120 3c20 6972   = ir0; i01 < ir
-00039780: 313b 2069 3031 2b2b 2920 7b0a 2020 2020  1; i01++) {.    
+00039760: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00039770: 7420 6930 3020 3d20 303b 2069 3030 203c  t i00 = 0; i00 <
+00039780: 206e 6530 303b 2069 3030 2b2b 2920 7b0a   ne00; i00++) {.
 00039790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000397a0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-000397b0: 2069 3030 203d 2030 3b20 6930 3020 3c20   i00 = 0; i00 < 
-000397c0: 6e65 3030 3b20 6930 302b 2b29 207b 0a20  ne00; i00++) {. 
-000397d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000397e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000397f0: 6f6e 7374 2066 6c6f 6174 202a 2073 7263  onst float * src
-00039800: 305f 7074 7220 3d20 2866 6c6f 6174 202a  0_ptr = (float *
-00039810: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
-00039820: 2d3e 6461 7461 202b 2069 3030 2a6e 6230  ->data + i00*nb0
-00039830: 3020 2b20 6930 312a 6e62 3031 202b 2069  0 + i01*nb01 + i
-00039840: 3032 2a6e 6230 3220 2b20 6930 332a 6e62  02*nb02 + i03*nb
-00039850: 3033 293b 0a0a 2020 2020 2020 2020 2020  03);..          
-00039860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039870: 2020 2020 2020 6473 745f 7074 725b 6964        dst_ptr[id
-00039880: 5d20 3d20 4747 4d4c 5f46 5033 325f 544f  ] = GGML_FP32_TO
-00039890: 5f46 5031 3628 2a73 7263 305f 7074 7229  _FP16(*src0_ptr)
-000398a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000398b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000398c0: 2020 6964 2b2b 3b0a 2020 2020 2020 2020    id++;.        
-000398d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000398e0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000398f0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00039900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039910: 2020 2020 2020 2020 6964 202b 3d20 6e65          id += ne
-00039920: 3030 202a 2028 6e65 3031 202d 2069 7231  00 * (ne01 - ir1
-00039930: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00039940: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00039950: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00039960: 2020 2020 2020 207d 2065 6c73 6520 6966         } else if
-00039970: 2028 6767 6d6c 5f69 735f 7175 616e 7469   (ggml_is_quanti
-00039980: 7a65 6428 6473 742d 3e74 7970 6529 2920  zed(dst->type)) 
-00039990: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000399a0: 2020 7175 616e 7469 7a65 5f72 6f77 5f71    quantize_row_q
-000399b0: 5f74 2063 6f6e 7374 2071 7561 6e74 697a  _t const quantiz
-000399c0: 655f 726f 775f 7120 3d20 7175 616e 7469  e_row_q = quanti
-000399d0: 7a65 5f66 6e73 5b64 7374 2d3e 7479 7065  ze_fns[dst->type
-000399e0: 5d2e 7175 616e 7469 7a65 5f72 6f77 5f71  ].quantize_row_q
-000399f0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00039a00: 2020 2073 697a 655f 7420 6964 203d 2030     size_t id = 0
-00039a10: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00039a20: 2020 7369 7a65 5f74 2072 7320 3d20 6e62    size_t rs = nb
-00039a30: 3020 2a20 286e 6530 3020 2f20 4747 4d4c  0 * (ne00 / GGML
-00039a40: 5f42 4c43 4b5f 5349 5a45 5b64 7374 2d3e  _BLCK_SIZE[dst->
-00039a50: 7479 7065 5d29 3b0a 2020 2020 2020 2020  type]);.        
-00039a60: 2020 2020 2020 2020 6368 6172 202a 2064          char * d
-00039a70: 7374 5f70 7472 203d 2028 6368 6172 202a  st_ptr = (char *
-00039a80: 2920 6473 742d 3e64 6174 613b 0a0a 2020  ) dst->data;..  
-00039a90: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00039aa0: 7220 2869 6e74 2069 3033 203d 2030 3b20  r (int i03 = 0; 
-00039ab0: 6930 3320 3c20 6e65 3033 3b20 6930 332b  i03 < ne03; i03+
-00039ac0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00039ad0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00039ae0: 7420 6930 3220 3d20 303b 2069 3032 203c  t i02 = 0; i02 <
-00039af0: 206e 6530 323b 2069 3032 2b2b 2920 7b0a   ne02; i02++) {.
-00039b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039b10: 2020 2020 2020 2020 6964 202b 3d20 7273          id += rs
-00039b20: 202a 2069 7230 3b0a 2020 2020 2020 2020   * ir0;.        
+000397a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000397b0: 636f 6e73 7420 666c 6f61 7420 2a20 7372  const float * sr
+000397c0: 6330 5f70 7472 203d 2028 666c 6f61 7420  c0_ptr = (float 
+000397d0: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+000397e0: 302d 3e64 6174 6120 2b20 6930 302a 6e62  0->data + i00*nb
+000397f0: 3030 202b 2069 3031 2a6e 6230 3120 2b20  00 + i01*nb01 + 
+00039800: 6930 322a 6e62 3032 202b 2069 3033 2a6e  i02*nb02 + i03*n
+00039810: 6230 3329 3b0a 0a20 2020 2020 2020 2020  b03);..         
+00039820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039830: 2020 2020 2020 2064 7374 5f70 7472 5b69         dst_ptr[i
+00039840: 645d 203d 2047 474d 4c5f 4650 3332 5f54  d] = GGML_FP32_T
+00039850: 4f5f 4650 3136 282a 7372 6330 5f70 7472  O_FP16(*src0_ptr
+00039860: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00039870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039880: 2020 2069 642b 2b3b 0a20 2020 2020 2020     id++;.       
+00039890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000398a0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000398b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000398c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000398d0: 2020 2020 2020 2020 2069 6420 2b3d 206e           id += n
+000398e0: 6530 3020 2a20 286e 6530 3120 2d20 6972  e00 * (ne01 - ir
+000398f0: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
+00039900: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00039910: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00039920: 2020 2020 2020 2020 7d20 656c 7365 2069          } else i
+00039930: 6620 2867 676d 6c5f 6973 5f71 7561 6e74  f (ggml_is_quant
+00039940: 697a 6564 2864 7374 2d3e 7479 7065 2929  ized(dst->type))
+00039950: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00039960: 2020 2071 7561 6e74 697a 655f 726f 775f     quantize_row_
+00039970: 715f 7420 636f 6e73 7420 7175 616e 7469  q_t const quanti
+00039980: 7a65 5f72 6f77 5f71 203d 2071 7561 6e74  ze_row_q = quant
+00039990: 697a 655f 666e 735b 6473 742d 3e74 7970  ize_fns[dst->typ
+000399a0: 655d 2e71 7561 6e74 697a 655f 726f 775f  e].quantize_row_
+000399b0: 713b 0a0a 2020 2020 2020 2020 2020 2020  q;..            
+000399c0: 2020 2020 7369 7a65 5f74 2069 6420 3d20      size_t id = 
+000399d0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+000399e0: 2020 2073 697a 655f 7420 7273 203d 206e     size_t rs = n
+000399f0: 6230 202a 2028 6e65 3030 202f 2047 474d  b0 * (ne00 / GGM
+00039a00: 4c5f 424c 434b 5f53 495a 455b 6473 742d  L_BLCK_SIZE[dst-
+00039a10: 3e74 7970 655d 293b 0a20 2020 2020 2020  >type]);.       
+00039a20: 2020 2020 2020 2020 2063 6861 7220 2a20           char * 
+00039a30: 6473 745f 7074 7220 3d20 2863 6861 7220  dst_ptr = (char 
+00039a40: 2a29 2064 7374 2d3e 6461 7461 3b0a 0a20  *) dst->data;.. 
+00039a50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00039a60: 6f72 2028 696e 7420 6930 3320 3d20 303b  or (int i03 = 0;
+00039a70: 2069 3033 203c 206e 6530 333b 2069 3033   i03 < ne03; i03
+00039a80: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00039a90: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00039aa0: 6e74 2069 3032 203d 2030 3b20 6930 3220  nt i02 = 0; i02 
+00039ab0: 3c20 6e65 3032 3b20 6930 322b 2b29 207b  < ne02; i02++) {
+00039ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039ad0: 2020 2020 2020 2020 2069 6420 2b3d 2072           id += r
+00039ae0: 7320 2a20 6972 303b 0a20 2020 2020 2020  s * ir0;.       
+00039af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039b00: 2066 6f72 2028 696e 7420 6930 3120 3d20   for (int i01 = 
+00039b10: 6972 303b 2069 3031 203c 2069 7231 3b20  ir0; i01 < ir1; 
+00039b20: 6930 312b 2b29 207b 0a20 2020 2020 2020  i01++) {.       
 00039b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039b40: 666f 7220 2869 6e74 2069 3031 203d 2069  for (int i01 = i
-00039b50: 7230 3b20 6930 3120 3c20 6972 313b 2069  r0; i01 < ir1; i
-00039b60: 3031 2b2b 2920 7b0a 2020 2020 2020 2020  01++) {.        
-00039b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039b80: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00039b90: 2a20 7372 6330 5f70 7472 203d 2028 666c  * src0_ptr = (fl
-00039ba0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00039bb0: 2073 7263 302d 3e64 6174 6120 2b20 6930   src0->data + i0
-00039bc0: 312a 6e62 3031 202b 2069 3032 2a6e 6230  1*nb01 + i02*nb0
-00039bd0: 3220 2b20 6930 332a 6e62 3033 293b 0a20  2 + i03*nb03);. 
-00039be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039bf0: 2020 2020 2020 2020 2020 2071 7561 6e74             quant
-00039c00: 697a 655f 726f 775f 7128 7372 6330 5f70  ize_row_q(src0_p
-00039c10: 7472 2c20 6473 745f 7074 7220 2b20 6964  tr, dst_ptr + id
-00039c20: 2c20 6e65 3030 293b 0a20 2020 2020 2020  , ne00);.       
+00039b40: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00039b50: 202a 2073 7263 305f 7074 7220 3d20 2866   * src0_ptr = (f
+00039b60: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00039b70: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
+00039b80: 3031 2a6e 6230 3120 2b20 6930 322a 6e62  01*nb01 + i02*nb
+00039b90: 3032 202b 2069 3033 2a6e 6230 3329 3b0a  02 + i03*nb03);.
+00039ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039bb0: 2020 2020 2020 2020 2020 2020 7175 616e              quan
+00039bc0: 7469 7a65 5f72 6f77 5f71 2873 7263 305f  tize_row_q(src0_
+00039bd0: 7074 722c 2064 7374 5f70 7472 202b 2069  ptr, dst_ptr + i
+00039be0: 642c 206e 6530 3029 3b0a 2020 2020 2020  d, ne00);.      
+00039bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039c00: 2020 2020 2020 6964 202b 3d20 7273 3b0a        id += rs;.
+00039c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039c20: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
 00039c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039c40: 2020 2020 2069 6420 2b3d 2072 733b 0a20       id += rs;. 
-00039c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039c60: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00039c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039c80: 2069 6420 2b3d 2072 7320 2a20 286e 6530   id += rs * (ne0
-00039c90: 3120 2d20 6972 3129 3b0a 2020 2020 2020  1 - ir1);.      
-00039ca0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00039cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039cc0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-00039cd0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-00039ce0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00039cf0: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-00039d00: 444f 3a20 696d 706c 656d 656e 740a 2020  DO: implement.  
-00039d10: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00039d20: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-00039d30: 2020 2020 2020 2020 202f 2f70 7269 6e74           //print
-00039d40: 6628 2225 733a 2074 6869 7320 6973 206e  f("%s: this is n
-00039d50: 6f74 206f 7074 696d 616c 202d 2066 6978  ot optimal - fix
-00039d60: 206d 655c 6e22 2c20 5f5f 6675 6e63 5f5f   me\n", __func__
-00039d70: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00039d80: 6966 2028 6473 742d 3e74 7970 6520 3d3d  if (dst->type ==
-00039d90: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
-00039da0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00039db0: 2020 7369 7a65 5f74 2069 6420 3d20 303b    size_t id = 0;
-00039dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039dd0: 2066 6c6f 6174 202a 2064 7374 5f70 7472   float * dst_ptr
-00039de0: 203d 2028 666c 6f61 7420 2a29 2064 7374   = (float *) dst
-00039df0: 2d3e 6461 7461 3b0a 0a20 2020 2020 2020  ->data;..       
-00039e00: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00039e10: 7420 6930 3320 3d20 303b 2069 3033 203c  t i03 = 0; i03 <
-00039e20: 206e 6530 333b 2069 3033 2b2b 2920 7b0a   ne03; i03++) {.
+00039c40: 2020 6964 202b 3d20 7273 202a 2028 6e65    id += rs * (ne
+00039c50: 3031 202d 2069 7231 293b 0a20 2020 2020  01 - ir1);.     
+00039c60: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00039c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039c80: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00039c90: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+00039ca0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00039cb0: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
+00039cc0: 4f44 4f3a 2069 6d70 6c65 6d65 6e74 0a20  ODO: implement. 
+00039cd0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00039ce0: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
+00039cf0: 2020 2020 2020 2020 2020 2f2f 7072 696e            //prin
+00039d00: 7466 2822 2573 3a20 7468 6973 2069 7320  tf("%s: this is 
+00039d10: 6e6f 7420 6f70 7469 6d61 6c20 2d20 6669  not optimal - fi
+00039d20: 7820 6d65 5c6e 222c 205f 5f66 756e 635f  x me\n", __func_
+00039d30: 5f29 3b0a 0a20 2020 2020 2020 2020 2020  _);..           
+00039d40: 2069 6620 2864 7374 2d3e 7479 7065 203d   if (dst->type =
+00039d50: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
+00039d60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00039d70: 2020 2073 697a 655f 7420 6964 203d 2030     size_t id = 0
+00039d80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00039d90: 2020 666c 6f61 7420 2a20 6473 745f 7074    float * dst_pt
+00039da0: 7220 3d20 2866 6c6f 6174 202a 2920 6473  r = (float *) ds
+00039db0: 742d 3e64 6174 613b 0a0a 2020 2020 2020  t->data;..      
+00039dc0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00039dd0: 6e74 2069 3033 203d 2030 3b20 6930 3320  nt i03 = 0; i03 
+00039de0: 3c20 6e65 3033 3b20 6930 332b 2b29 207b  < ne03; i03++) {
+00039df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039e00: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+00039e10: 3220 3d20 303b 2069 3032 203c 206e 6530  2 = 0; i02 < ne0
+00039e20: 323b 2069 3032 2b2b 2920 7b0a 2020 2020  2; i02++) {.    
 00039e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039e40: 2020 2020 666f 7220 2869 6e74 2069 3032      for (int i02
-00039e50: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
-00039e60: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
-00039e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039e80: 2020 2069 6420 2b3d 206e 6530 3020 2a20     id += ne00 * 
-00039e90: 6972 303b 0a20 2020 2020 2020 2020 2020  ir0;.           
-00039ea0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00039eb0: 2028 696e 7420 6930 3120 3d20 6972 303b   (int i01 = ir0;
-00039ec0: 2069 3031 203c 2069 7231 3b20 6930 312b   i01 < ir1; i01+
-00039ed0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00039e40: 2020 2020 6964 202b 3d20 6e65 3030 202a      id += ne00 *
+00039e50: 2069 7230 3b0a 2020 2020 2020 2020 2020   ir0;.          
+00039e60: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00039e70: 7220 2869 6e74 2069 3031 203d 2069 7230  r (int i01 = ir0
+00039e80: 3b20 6930 3120 3c20 6972 313b 2069 3031  ; i01 < ir1; i01
+00039e90: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00039ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039eb0: 2020 666f 7220 2869 6e74 2069 3030 203d    for (int i00 =
+00039ec0: 2030 3b20 6930 3020 3c20 6e65 3030 3b20   0; i00 < ne00; 
+00039ed0: 6930 302b 2b29 207b 0a20 2020 2020 2020  i00++) {.       
 00039ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039ef0: 2066 6f72 2028 696e 7420 6930 3020 3d20   for (int i00 = 
-00039f00: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
-00039f10: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
-00039f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039f30: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-00039f40: 6f61 7420 2a20 7372 6330 5f70 7472 203d  oat * src0_ptr =
-00039f50: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-00039f60: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00039f70: 2b20 6930 302a 6e62 3030 202b 2069 3031  + i00*nb00 + i01
-00039f80: 2a6e 6230 3120 2b20 6930 322a 6e62 3032  *nb01 + i02*nb02
-00039f90: 202b 2069 3033 2a6e 6230 3329 3b0a 0a20   + i03*nb03);.. 
+00039ef0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00039f00: 6c6f 6174 202a 2073 7263 305f 7074 7220  loat * src0_ptr 
+00039f10: 3d20 2866 6c6f 6174 202a 2920 2828 6368  = (float *) ((ch
+00039f20: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+00039f30: 202b 2069 3030 2a6e 6230 3020 2b20 6930   + i00*nb00 + i0
+00039f40: 312a 6e62 3031 202b 2069 3032 2a6e 6230  1*nb01 + i02*nb0
+00039f50: 3220 2b20 6930 332a 6e62 3033 293b 0a0a  2 + i03*nb03);..
+00039f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039f80: 6473 745f 7074 725b 6964 5d20 3d20 2a73  dst_ptr[id] = *s
+00039f90: 7263 305f 7074 723b 0a20 2020 2020 2020  rc0_ptr;.       
 00039fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039fb0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00039fc0: 7374 5f70 7472 5b69 645d 203d 202a 7372  st_ptr[id] = *sr
-00039fd0: 6330 5f70 7472 3b0a 2020 2020 2020 2020  c0_ptr;.        
+00039fb0: 2020 2020 2020 2020 2069 642b 2b3b 0a20           id++;. 
+00039fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039fd0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
 00039fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039ff0: 2020 2020 2020 2020 6964 2b2b 3b0a 2020          id++;.  
-0003a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a010: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0003a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a030: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0003a040: 2020 2020 2020 2020 2020 2020 2020 6964                id
-0003a050: 202b 3d20 6e65 3030 202a 2028 6e65 3031   += ne00 * (ne01
-0003a060: 202d 2069 7231 293b 0a20 2020 2020 2020   - ir1);.       
-0003a070: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0003a080: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0003a090: 0a20 2020 2020 2020 2020 2020 207d 2065  .            } e
-0003a0a0: 6c73 6520 6966 2028 6473 742d 3e74 7970  lse if (dst->typ
-0003a0b0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-0003a0c0: 3136 2920 7b0a 2020 2020 2020 2020 2020  16) {.          
-0003a0d0: 2020 2020 2020 7369 7a65 5f74 2069 6420        size_t id 
-0003a0e0: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-0003a0f0: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
-0003a100: 202a 2064 7374 5f70 7472 203d 2028 6767   * dst_ptr = (gg
-0003a110: 6d6c 5f66 7031 365f 7420 2a29 2064 7374  ml_fp16_t *) dst
-0003a120: 2d3e 6461 7461 3b0a 0a20 2020 2020 2020  ->data;..       
-0003a130: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0003a140: 7420 6930 3320 3d20 303b 2069 3033 203c  t i03 = 0; i03 <
-0003a150: 206e 6530 333b 2069 3033 2b2b 2920 7b0a   ne03; i03++) {.
+00039ff0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0003a000: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003a010: 6420 2b3d 206e 6530 3020 2a20 286e 6530  d += ne00 * (ne0
+0003a020: 3120 2d20 6972 3129 3b0a 2020 2020 2020  1 - ir1);.      
+0003a030: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0003a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a050: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
+0003a060: 656c 7365 2069 6620 2864 7374 2d3e 7479  else if (dst->ty
+0003a070: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+0003a080: 4631 3629 207b 0a20 2020 2020 2020 2020  F16) {.         
+0003a090: 2020 2020 2020 2073 697a 655f 7420 6964         size_t id
+0003a0a0: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+0003a0b0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
+0003a0c0: 7420 2a20 6473 745f 7074 7220 3d20 2867  t * dst_ptr = (g
+0003a0d0: 676d 6c5f 6670 3136 5f74 202a 2920 6473  gml_fp16_t *) ds
+0003a0e0: 742d 3e64 6174 613b 0a0a 2020 2020 2020  t->data;..      
+0003a0f0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0003a100: 6e74 2069 3033 203d 2030 3b20 6930 3320  nt i03 = 0; i03 
+0003a110: 3c20 6e65 3033 3b20 6930 332b 2b29 207b  < ne03; i03++) {
+0003a120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a130: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+0003a140: 3220 3d20 303b 2069 3032 203c 206e 6530  2 = 0; i02 < ne0
+0003a150: 323b 2069 3032 2b2b 2920 7b0a 2020 2020  2; i02++) {.    
 0003a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a170: 2020 2020 666f 7220 2869 6e74 2069 3032      for (int i02
-0003a180: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
-0003a190: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
-0003a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a1b0: 2020 2069 6420 2b3d 206e 6530 3020 2a20     id += ne00 * 
-0003a1c0: 6972 303b 0a20 2020 2020 2020 2020 2020  ir0;.           
-0003a1d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003a1e0: 2028 696e 7420 6930 3120 3d20 6972 303b   (int i01 = ir0;
-0003a1f0: 2069 3031 203c 2069 7231 3b20 6930 312b   i01 < ir1; i01+
-0003a200: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0003a170: 2020 2020 6964 202b 3d20 6e65 3030 202a      id += ne00 *
+0003a180: 2069 7230 3b0a 2020 2020 2020 2020 2020   ir0;.          
+0003a190: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0003a1a0: 7220 2869 6e74 2069 3031 203d 2069 7230  r (int i01 = ir0
+0003a1b0: 3b20 6930 3120 3c20 6972 313b 2069 3031  ; i01 < ir1; i01
+0003a1c0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0003a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a1e0: 2020 666f 7220 2869 6e74 2069 3030 203d    for (int i00 =
+0003a1f0: 2030 3b20 6930 3020 3c20 6e65 3030 3b20   0; i00 < ne00; 
+0003a200: 6930 302b 2b29 207b 0a20 2020 2020 2020  i00++) {.       
 0003a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a220: 2066 6f72 2028 696e 7420 6930 3020 3d20   for (int i00 = 
-0003a230: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
-0003a240: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
-0003a250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a260: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0003a270: 6f61 7420 2a20 7372 6330 5f70 7472 203d  oat * src0_ptr =
-0003a280: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-0003a290: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-0003a2a0: 2b20 6930 302a 6e62 3030 202b 2069 3031  + i00*nb00 + i01
-0003a2b0: 2a6e 6230 3120 2b20 6930 322a 6e62 3032  *nb01 + i02*nb02
-0003a2c0: 202b 2069 3033 2a6e 6230 3329 3b0a 0a20   + i03*nb03);.. 
-0003a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a2e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0003a2f0: 7374 5f70 7472 5b69 645d 203d 2047 474d  st_ptr[id] = GGM
-0003a300: 4c5f 4650 3332 5f54 4f5f 4650 3136 282a  L_FP32_TO_FP16(*
-0003a310: 7372 6330 5f70 7472 293b 0a20 2020 2020  src0_ptr);.     
+0003a220: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+0003a230: 6c6f 6174 202a 2073 7263 305f 7074 7220  loat * src0_ptr 
+0003a240: 3d20 2866 6c6f 6174 202a 2920 2828 6368  = (float *) ((ch
+0003a250: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+0003a260: 202b 2069 3030 2a6e 6230 3020 2b20 6930   + i00*nb00 + i0
+0003a270: 312a 6e62 3031 202b 2069 3032 2a6e 6230  1*nb01 + i02*nb0
+0003a280: 3220 2b20 6930 332a 6e62 3033 293b 0a0a  2 + i03*nb03);..
+0003a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a2b0: 6473 745f 7074 725b 6964 5d20 3d20 4747  dst_ptr[id] = GG
+0003a2c0: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
+0003a2d0: 2a73 7263 305f 7074 7229 3b0a 2020 2020  *src0_ptr);.    
+0003a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a2f0: 2020 2020 2020 2020 2020 2020 6964 2b2b              id++
+0003a300: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003a310: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
 0003a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a330: 2020 2020 2020 2020 2020 2069 642b 2b3b             id++;
-0003a340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a350: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0003a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a370: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0003a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a390: 2069 6420 2b3d 206e 6530 3020 2a20 286e   id += ne00 * (n
-0003a3a0: 6530 3120 2d20 6972 3129 3b0a 2020 2020  e01 - ir1);.    
-0003a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a3c0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0003a3d0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0003a3e0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-0003a3f0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-0003a400: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
-0003a410: 544f 444f 3a20 696d 706c 656d 656e 740a  TODO: implement.
-0003a420: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0003a430: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0003a440: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-0003a450: 2020 2020 2f2f 2064 7374 2063 6f75 6e74      // dst count
-0003a460: 6572 730a 0a20 2020 2069 6e74 3634 5f74  ers..    int64_t
-0003a470: 2069 3130 203d 2030 3b0a 2020 2020 696e   i10 = 0;.    in
-0003a480: 7436 345f 7420 6931 3120 3d20 303b 0a20  t64_t i11 = 0;. 
-0003a490: 2020 2069 6e74 3634 5f74 2069 3132 203d     int64_t i12 =
-0003a4a0: 2030 3b0a 2020 2020 696e 7436 345f 7420   0;.    int64_t 
-0003a4b0: 6931 3320 3d20 303b 0a0a 2020 2020 6966  i13 = 0;..    if
-0003a4c0: 2028 6473 742d 3e74 7970 6520 3d3d 2047   (dst->type == G
-0003a4d0: 474d 4c5f 5459 5045 5f46 3332 2920 7b0a  GML_TYPE_F32) {.
-0003a4e0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0003a4f0: 3634 5f74 2069 3033 203d 2030 3b20 6930  64_t i03 = 0; i0
-0003a500: 3320 3c20 6e65 3033 3b20 6930 332b 2b29  3 < ne03; i03++)
-0003a510: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-0003a520: 6f72 2028 696e 7436 345f 7420 6930 3220  or (int64_t i02 
-0003a530: 3d20 303b 2069 3032 203c 206e 6530 323b  = 0; i02 < ne02;
-0003a540: 2069 3032 2b2b 2920 7b0a 2020 2020 2020   i02++) {.      
-0003a550: 2020 2020 2020 2020 2020 6931 3020 2b3d            i10 +=
-0003a560: 206e 6530 3020 2a20 6972 303b 0a20 2020   ne00 * ir0;.   
-0003a570: 2020 2020 2020 2020 2020 2020 2077 6869               whi
-0003a580: 6c65 2028 6931 3020 3e3d 206e 6530 2920  le (i10 >= ne0) 
-0003a590: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003a5a0: 2020 2020 2020 6931 3020 2d3d 206e 6530        i10 -= ne0
-0003a5b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0003a5c0: 2020 2020 2020 6966 2028 2b2b 6931 3120        if (++i11 
-0003a5d0: 3d3d 206e 6531 2920 7b0a 2020 2020 2020  == ne1) {.      
-0003a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a5f0: 2020 6931 3120 3d20 303b 0a20 2020 2020    i11 = 0;.     
-0003a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a610: 2020 2069 6620 282b 2b69 3132 203d 3d20     if (++i12 == 
-0003a620: 6e65 3229 207b 0a20 2020 2020 2020 2020  ne2) {.         
-0003a630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a640: 2020 2069 3132 203d 2030 3b0a 2020 2020     i12 = 0;.    
-0003a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a660: 2020 2020 2020 2020 6966 2028 2b2b 6931          if (++i1
-0003a670: 3320 3d3d 206e 6533 2920 7b0a 2020 2020  3 == ne3) {.    
-0003a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a690: 2020 2020 2020 2020 2020 2020 6931 3320              i13 
-0003a6a0: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-0003a6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a6c0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0003a6d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0003a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a6f0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0003a700: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0003a710: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-0003a720: 7420 6930 3120 3d20 6972 303b 2069 3031  t i01 = ir0; i01
-0003a730: 203c 2069 7231 3b20 6930 312b 2b29 207b   < ir1; i01++) {
+0003a330: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0003a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a350: 2020 6964 202b 3d20 6e65 3030 202a 2028    id += ne00 * (
+0003a360: 6e65 3031 202d 2069 7231 293b 0a20 2020  ne01 - ir1);.   
+0003a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a380: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0003a390: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0003a3a0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
+0003a3b0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0003a3c0: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+0003a3d0: 2054 4f44 4f3a 2069 6d70 6c65 6d65 6e74   TODO: implement
+0003a3e0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0003a3f0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0003a400: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+0003a410: 0a20 2020 202f 2f20 6473 7420 636f 756e  .    // dst coun
+0003a420: 7465 7273 0a0a 2020 2020 696e 7436 345f  ters..    int64_
+0003a430: 7420 6931 3020 3d20 303b 0a20 2020 2069  t i10 = 0;.    i
+0003a440: 6e74 3634 5f74 2069 3131 203d 2030 3b0a  nt64_t i11 = 0;.
+0003a450: 2020 2020 696e 7436 345f 7420 6931 3220      int64_t i12 
+0003a460: 3d20 303b 0a20 2020 2069 6e74 3634 5f74  = 0;.    int64_t
+0003a470: 2069 3133 203d 2030 3b0a 0a20 2020 2069   i13 = 0;..    i
+0003a480: 6620 2864 7374 2d3e 7479 7065 203d 3d20  f (dst->type == 
+0003a490: 4747 4d4c 5f54 5950 455f 4633 3229 207b  GGML_TYPE_F32) {
+0003a4a0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+0003a4b0: 7436 345f 7420 6930 3320 3d20 303b 2069  t64_t i03 = 0; i
+0003a4c0: 3033 203c 206e 6530 333b 2069 3033 2b2b  03 < ne03; i03++
+0003a4d0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0003a4e0: 666f 7220 2869 6e74 3634 5f74 2069 3032  for (int64_t i02
+0003a4f0: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
+0003a500: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
+0003a510: 2020 2020 2020 2020 2020 2069 3130 202b             i10 +
+0003a520: 3d20 6e65 3030 202a 2069 7230 3b0a 2020  = ne00 * ir0;.  
+0003a530: 2020 2020 2020 2020 2020 2020 2020 7768                wh
+0003a540: 696c 6520 2869 3130 203e 3d20 6e65 3029  ile (i10 >= ne0)
+0003a550: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0003a560: 2020 2020 2020 2069 3130 202d 3d20 6e65         i10 -= ne
+0003a570: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+0003a580: 2020 2020 2020 2069 6620 282b 2b69 3131         if (++i11
+0003a590: 203d 3d20 6e65 3129 207b 0a20 2020 2020   == ne1) {.     
+0003a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a5b0: 2020 2069 3131 203d 2030 3b0a 2020 2020     i11 = 0;.    
+0003a5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a5d0: 2020 2020 6966 2028 2b2b 6931 3220 3d3d      if (++i12 ==
+0003a5e0: 206e 6532 2920 7b0a 2020 2020 2020 2020   ne2) {.        
+0003a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a600: 2020 2020 6931 3220 3d20 303b 0a20 2020      i12 = 0;.   
+0003a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a620: 2020 2020 2020 2020 2069 6620 282b 2b69           if (++i
+0003a630: 3133 203d 3d20 6e65 3329 207b 0a20 2020  13 == ne3) {.   
+0003a640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a650: 2020 2020 2020 2020 2020 2020 2069 3133               i13
+0003a660: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+0003a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a680: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003a690: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0003a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a6b0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003a6c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0003a6d0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0003a6e0: 5f74 2069 3031 203d 2069 7230 3b20 6930  _t i01 = ir0; i0
+0003a6f0: 3120 3c20 6972 313b 2069 3031 2b2b 2920  1 < ir1; i01++) 
+0003a700: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003a710: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0003a720: 5f74 2069 3030 203d 2030 3b20 6930 3020  _t i00 = 0; i00 
+0003a730: 3c20 6e65 3030 3b20 6930 302b 2b29 207b  < ne00; i00++) {
 0003a740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a750: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-0003a760: 7420 6930 3020 3d20 303b 2069 3030 203c  t i00 = 0; i00 <
-0003a770: 206e 6530 303b 2069 3030 2b2b 2920 7b0a   ne00; i00++) {.
-0003a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a790: 2020 2020 2020 2020 636f 6e73 7420 6368          const ch
-0003a7a0: 6172 202a 2073 7263 305f 7074 7220 3d20  ar * src0_ptr = 
-0003a7b0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
-0003a7c0: 6461 7461 202b 2069 3030 2a6e 6230 3020  data + i00*nb00 
-0003a7d0: 2b20 6930 312a 6e62 3031 202b 2069 3032  + i01*nb01 + i02
-0003a7e0: 2a6e 6230 3220 2b20 6930 332a 6e62 3033  *nb02 + i03*nb03
-0003a7f0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0003a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a810: 2063 6861 7220 2a20 6473 745f 7074 7220   char * dst_ptr 
-0003a820: 203d 2028 2863 6861 7220 2a29 2020 6473   = ((char *)  ds
-0003a830: 742d 3e64 6174 6120 2b20 6931 302a 6e62  t->data + i10*nb
-0003a840: 3020 202b 2069 3131 2a6e 6231 2020 2b20  0  + i11*nb1  + 
-0003a850: 6931 322a 6e62 3220 202b 2069 3133 2a6e  i12*nb2  + i13*n
-0003a860: 6233 293b 0a0a 2020 2020 2020 2020 2020  b3);..          
-0003a870: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-0003a880: 6d63 7079 2864 7374 5f70 7472 2c20 7372  mcpy(dst_ptr, sr
-0003a890: 6330 5f70 7472 2c20 7369 7a65 6f66 2866  c0_ptr, sizeof(f
-0003a8a0: 6c6f 6174 2929 3b0a 0a20 2020 2020 2020  loat));..       
-0003a8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a8c0: 2069 6620 282b 2b69 3130 203d 3d20 6e65   if (++i10 == ne
-0003a8d0: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
-0003a8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a8f0: 2069 3130 203d 2030 3b0a 2020 2020 2020   i10 = 0;.      
-0003a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a910: 2020 2020 2020 6966 2028 2b2b 6931 3120        if (++i11 
-0003a920: 3d3d 206e 6531 2920 7b0a 2020 2020 2020  == ne1) {.      
-0003a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a940: 2020 2020 2020 2020 2020 6931 3120 3d20            i11 = 
-0003a950: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-0003a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a970: 2020 2069 6620 282b 2b69 3132 203d 3d20     if (++i12 == 
-0003a980: 6e65 3229 207b 0a20 2020 2020 2020 2020  ne2) {.         
-0003a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a9a0: 2020 2020 2020 2020 2020 2069 3132 203d             i12 =
-0003a9b0: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+0003a750: 2020 2020 2020 2020 2063 6f6e 7374 2063           const c
+0003a760: 6861 7220 2a20 7372 6330 5f70 7472 203d  har * src0_ptr =
+0003a770: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
+0003a780: 3e64 6174 6120 2b20 6930 302a 6e62 3030  >data + i00*nb00
+0003a790: 202b 2069 3031 2a6e 6230 3120 2b20 6930   + i01*nb01 + i0
+0003a7a0: 322a 6e62 3032 202b 2069 3033 2a6e 6230  2*nb02 + i03*nb0
+0003a7b0: 3329 3b0a 2020 2020 2020 2020 2020 2020  3);.            
+0003a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a7d0: 2020 6368 6172 202a 2064 7374 5f70 7472    char * dst_ptr
+0003a7e0: 2020 3d20 2828 6368 6172 202a 2920 2064    = ((char *)  d
+0003a7f0: 7374 2d3e 6461 7461 202b 2069 3130 2a6e  st->data + i10*n
+0003a800: 6230 2020 2b20 6931 312a 6e62 3120 202b  b0  + i11*nb1  +
+0003a810: 2069 3132 2a6e 6232 2020 2b20 6931 332a   i12*nb2  + i13*
+0003a820: 6e62 3329 3b0a 0a20 2020 2020 2020 2020  nb3);..         
+0003a830: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0003a840: 656d 6370 7928 6473 745f 7074 722c 2073  emcpy(dst_ptr, s
+0003a850: 7263 305f 7074 722c 2073 697a 656f 6628  rc0_ptr, sizeof(
+0003a860: 666c 6f61 7429 293b 0a0a 2020 2020 2020  float));..      
+0003a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a880: 2020 6966 2028 2b2b 6931 3020 3d3d 206e    if (++i10 == n
+0003a890: 6530 2920 7b0a 2020 2020 2020 2020 2020  e0) {.          
+0003a8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a8b0: 2020 6931 3020 3d20 303b 0a20 2020 2020    i10 = 0;.     
+0003a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a8d0: 2020 2020 2020 2069 6620 282b 2b69 3131         if (++i11
+0003a8e0: 203d 3d20 6e65 3129 207b 0a20 2020 2020   == ne1) {.     
+0003a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a900: 2020 2020 2020 2020 2020 2069 3131 203d             i11 =
+0003a910: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+0003a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a930: 2020 2020 6966 2028 2b2b 6931 3220 3d3d      if (++i12 ==
+0003a940: 206e 6532 2920 7b0a 2020 2020 2020 2020   ne2) {.        
+0003a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a960: 2020 2020 2020 2020 2020 2020 6931 3220              i12 
+0003a970: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+0003a980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a990: 2020 2020 2020 2020 2069 6620 282b 2b69           if (++i
+0003a9a0: 3133 203d 3d20 6e65 3329 207b 0a20 2020  13 == ne3) {.   
+0003a9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0003a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a9d0: 2020 2020 2020 2020 6966 2028 2b2b 6931          if (++i1
-0003a9e0: 3320 3d3d 206e 6533 2920 7b0a 2020 2020  3 == ne3) {.    
+0003a9d0: 2020 2020 2069 3133 203d 2030 3b0a 2020       i13 = 0;.  
+0003a9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0003a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa10: 2020 2020 6931 3320 3d20 303b 0a20 2020      i13 = 0;.   
-0003aa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aa00: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aa20: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
 0003aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa40: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0003aa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa60: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0003aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa80: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0003aa90: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0003aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aab0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0003aac0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0003aad0: 2020 2020 2069 3130 202b 3d20 6e65 3030       i10 += ne00
-0003aae0: 202a 2028 6e65 3031 202d 2069 7231 293b   * (ne01 - ir1);
-0003aaf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ab00: 2077 6869 6c65 2028 6931 3020 3e3d 206e   while (i10 >= n
-0003ab10: 6530 2920 7b0a 2020 2020 2020 2020 2020  e0) {.          
-0003ab20: 2020 2020 2020 2020 2020 6931 3020 2d3d            i10 -=
-0003ab30: 206e 6530 3b0a 2020 2020 2020 2020 2020   ne0;.          
-0003ab40: 2020 2020 2020 2020 2020 6966 2028 2b2b            if (++
-0003ab50: 6931 3120 3d3d 206e 6531 2920 7b0a 2020  i11 == ne1) {.  
-0003ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ab70: 2020 2020 2020 6931 3120 3d20 303b 0a20        i11 = 0;. 
-0003ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ab90: 2020 2020 2020 2069 6620 282b 2b69 3132         if (++i12
-0003aba0: 203d 3d20 6e65 3229 207b 0a20 2020 2020   == ne2) {.     
-0003abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003abc0: 2020 2020 2020 2069 3132 203d 2030 3b0a         i12 = 0;.
+0003aa40: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003aa50: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0003aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aa70: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003aa80: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0003aa90: 2020 2020 2020 6931 3020 2b3d 206e 6530        i10 += ne0
+0003aaa0: 3020 2a20 286e 6530 3120 2d20 6972 3129  0 * (ne01 - ir1)
+0003aab0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003aac0: 2020 7768 696c 6520 2869 3130 203e 3d20    while (i10 >= 
+0003aad0: 6e65 3029 207b 0a20 2020 2020 2020 2020  ne0) {.         
+0003aae0: 2020 2020 2020 2020 2020 2069 3130 202d             i10 -
+0003aaf0: 3d20 6e65 303b 0a20 2020 2020 2020 2020  = ne0;.         
+0003ab00: 2020 2020 2020 2020 2020 2069 6620 282b             if (+
+0003ab10: 2b69 3131 203d 3d20 6e65 3129 207b 0a20  +i11 == ne1) {. 
+0003ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ab30: 2020 2020 2020 2069 3131 203d 2030 3b0a         i11 = 0;.
+0003ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ab50: 2020 2020 2020 2020 6966 2028 2b2b 6931          if (++i1
+0003ab60: 3220 3d3d 206e 6532 2920 7b0a 2020 2020  2 == ne2) {.    
+0003ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ab80: 2020 2020 2020 2020 6931 3220 3d20 303b          i12 = 0;
+0003ab90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003aba0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0003abb0: 282b 2b69 3133 203d 3d20 6e65 3329 207b  (++i13 == ne3) {
+0003abc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0003abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003abe0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0003abf0: 2b2b 6931 3320 3d3d 206e 6533 2920 7b0a  ++i13 == ne3) {.
-0003ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003abe0: 2069 3133 203d 2030 3b0a 2020 2020 2020   i13 = 0;.      
+0003abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ac00: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
 0003ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ac20: 6931 3320 3d20 303b 0a20 2020 2020 2020  i13 = 0;.       
-0003ac30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ac40: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0003ac50: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0003ac60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ac70: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0003ac80: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0003ac90: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-0003aca0: 0a20 2020 207d 2065 6c73 6520 6966 2028  .    } else if (
-0003acb0: 6473 742d 3e74 7970 6520 3d3d 2047 474d  dst->type == GGM
-0003acc0: 4c5f 5459 5045 5f46 3136 2920 7b0a 2020  L_TYPE_F16) {.  
-0003acd0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-0003ace0: 5f74 2069 3033 203d 2030 3b20 6930 3320  _t i03 = 0; i03 
-0003acf0: 3c20 6e65 3033 3b20 6930 332b 2b29 207b  < ne03; i03++) {
-0003ad00: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0003ad10: 2028 696e 7436 345f 7420 6930 3220 3d20   (int64_t i02 = 
-0003ad20: 303b 2069 3032 203c 206e 6530 323b 2069  0; i02 < ne02; i
-0003ad30: 3032 2b2b 2920 7b0a 2020 2020 2020 2020  02++) {.        
-0003ad40: 2020 2020 2020 2020 6931 3020 2b3d 206e          i10 += n
-0003ad50: 6530 3020 2a20 6972 303b 0a20 2020 2020  e00 * ir0;.     
-0003ad60: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-0003ad70: 2028 6931 3020 3e3d 206e 6530 2920 7b0a   (i10 >= ne0) {.
-0003ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ad90: 2020 2020 6931 3020 2d3d 206e 6530 3b0a      i10 -= ne0;.
-0003ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003adb0: 2020 2020 6966 2028 2b2b 6931 3120 3d3d      if (++i11 ==
-0003adc0: 206e 6531 2920 7b0a 2020 2020 2020 2020   ne1) {.        
-0003add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ade0: 6931 3120 3d20 303b 0a20 2020 2020 2020  i11 = 0;.       
-0003adf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ae00: 2069 6620 282b 2b69 3132 203d 3d20 6e65   if (++i12 == ne
-0003ae10: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
-0003ae20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ae30: 2069 3132 203d 2030 3b0a 2020 2020 2020   i12 = 0;.      
-0003ae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ae50: 2020 2020 2020 6966 2028 2b2b 6931 3320        if (++i13 
-0003ae60: 3d3d 206e 6533 2920 7b0a 2020 2020 2020  == ne3) {.      
-0003ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ae80: 2020 2020 2020 2020 2020 6931 3320 3d20            i13 = 
-0003ae90: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-0003aea0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0003aeb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003aec0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0003aed0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0003aee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003aef0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0003af00: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-0003af10: 6930 3120 3d20 6972 303b 2069 3031 203c  i01 = ir0; i01 <
-0003af20: 2069 7231 3b20 6930 312b 2b29 207b 0a20   ir1; i01++) {. 
+0003ac20: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0003ac30: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0003ac40: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0003ac50: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0003ac60: 7d0a 2020 2020 7d20 656c 7365 2069 6620  }.    } else if 
+0003ac70: 2864 7374 2d3e 7479 7065 203d 3d20 4747  (dst->type == GG
+0003ac80: 4d4c 5f54 5950 455f 4631 3629 207b 0a20  ML_TYPE_F16) {. 
+0003ac90: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+0003aca0: 345f 7420 6930 3320 3d20 303b 2069 3033  4_t i03 = 0; i03
+0003acb0: 203c 206e 6530 333b 2069 3033 2b2b 2920   < ne03; i03++) 
+0003acc0: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
+0003acd0: 7220 2869 6e74 3634 5f74 2069 3032 203d  r (int64_t i02 =
+0003ace0: 2030 3b20 6930 3220 3c20 6e65 3032 3b20   0; i02 < ne02; 
+0003acf0: 6930 322b 2b29 207b 0a20 2020 2020 2020  i02++) {.       
+0003ad00: 2020 2020 2020 2020 2069 3130 202b 3d20           i10 += 
+0003ad10: 6e65 3030 202a 2069 7230 3b0a 2020 2020  ne00 * ir0;.    
+0003ad20: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+0003ad30: 6520 2869 3130 203e 3d20 6e65 3029 207b  e (i10 >= ne0) {
+0003ad40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ad50: 2020 2020 2069 3130 202d 3d20 6e65 303b       i10 -= ne0;
+0003ad60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ad70: 2020 2020 2069 6620 282b 2b69 3131 203d       if (++i11 =
+0003ad80: 3d20 6e65 3129 207b 0a20 2020 2020 2020  = ne1) {.       
+0003ad90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ada0: 2069 3131 203d 2030 3b0a 2020 2020 2020   i11 = 0;.      
+0003adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003adc0: 2020 6966 2028 2b2b 6931 3220 3d3d 206e    if (++i12 == n
+0003add0: 6532 2920 7b0a 2020 2020 2020 2020 2020  e2) {.          
+0003ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003adf0: 2020 6931 3220 3d20 303b 0a20 2020 2020    i12 = 0;.     
+0003ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ae10: 2020 2020 2020 2069 6620 282b 2b69 3133         if (++i13
+0003ae20: 203d 3d20 6e65 3329 207b 0a20 2020 2020   == ne3) {.     
+0003ae30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ae40: 2020 2020 2020 2020 2020 2069 3133 203d             i13 =
+0003ae50: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+0003ae60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ae70: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0003ae80: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0003ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aea0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0003aeb0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003aec0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+0003aed0: 2069 3031 203d 2069 7230 3b20 6930 3120   i01 = ir0; i01 
+0003aee0: 3c20 6972 313b 2069 3031 2b2b 2920 7b0a  < ir1; i01++) {.
+0003aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003af00: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+0003af10: 2069 3030 203d 2030 3b20 6930 3020 3c20   i00 = 0; i00 < 
+0003af20: 6e65 3030 3b20 6930 302b 2b29 207b 0a20  ne00; i00++) {. 
 0003af30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003af40: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-0003af50: 6930 3020 3d20 303b 2069 3030 203c 206e  i00 = 0; i00 < n
-0003af60: 6530 303b 2069 3030 2b2b 2920 7b0a 2020  e00; i00++) {.  
-0003af70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003af80: 2020 2020 2020 636f 6e73 7420 6368 6172        const char
-0003af90: 202a 2073 7263 305f 7074 7220 3d20 2828   * src0_ptr = ((
-0003afa0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-0003afb0: 7461 202b 2069 3030 2a6e 6230 3020 2b20  ta + i00*nb00 + 
-0003afc0: 6930 312a 6e62 3031 202b 2069 3032 2a6e  i01*nb01 + i02*n
-0003afd0: 6230 3220 2b20 6930 332a 6e62 3033 293b  b02 + i03*nb03);
-0003afe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003aff0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0003b000: 6861 7220 2a20 6473 745f 7074 7220 203d  har * dst_ptr  =
-0003b010: 2028 2863 6861 7220 2a29 2020 6473 742d   ((char *)  dst-
-0003b020: 3e64 6174 6120 2b20 6931 302a 6e62 3020  >data + i10*nb0 
-0003b030: 202b 2069 3131 2a6e 6231 2020 2b20 6931   + i11*nb1  + i1
-0003b040: 322a 6e62 3220 202b 2069 3133 2a6e 6233  2*nb2  + i13*nb3
-0003b050: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0003b060: 2020 2020 2020 2020 2020 2020 2a28 6767              *(gg
-0003b070: 6d6c 5f66 7031 365f 7420 2a29 2064 7374  ml_fp16_t *) dst
-0003b080: 5f70 7472 203d 2047 474d 4c5f 4650 3332  _ptr = GGML_FP32
-0003b090: 5f54 4f5f 4650 3136 282a 2863 6f6e 7374  _TO_FP16(*(const
-0003b0a0: 2066 6c6f 6174 202a 2920 7372 6330 5f70   float *) src0_p
-0003b0b0: 7472 293b 0a0a 2020 2020 2020 2020 2020  tr);..          
-0003b0c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0003b0d0: 2028 2b2b 6931 3020 3d3d 206e 6530 2920   (++i10 == ne0) 
-0003b0e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003b0f0: 2020 2020 2020 2020 2020 2020 2020 6931                i1
-0003b100: 3020 3d20 303b 0a20 2020 2020 2020 2020  0 = 0;.         
-0003b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b120: 2020 2069 6620 282b 2b69 3131 203d 3d20     if (++i11 == 
-0003b130: 6e65 3129 207b 0a20 2020 2020 2020 2020  ne1) {.         
-0003b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b150: 2020 2020 2020 2069 3131 203d 2030 3b0a         i11 = 0;.
+0003af40: 2020 2020 2020 2063 6f6e 7374 2063 6861         const cha
+0003af50: 7220 2a20 7372 6330 5f70 7472 203d 2028  r * src0_ptr = (
+0003af60: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
+0003af70: 6174 6120 2b20 6930 302a 6e62 3030 202b  ata + i00*nb00 +
+0003af80: 2069 3031 2a6e 6230 3120 2b20 6930 322a   i01*nb01 + i02*
+0003af90: 6e62 3032 202b 2069 3033 2a6e 6230 3329  nb02 + i03*nb03)
+0003afa0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003afb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003afc0: 6368 6172 202a 2064 7374 5f70 7472 2020  char * dst_ptr  
+0003afd0: 3d20 2828 6368 6172 202a 2920 2064 7374  = ((char *)  dst
+0003afe0: 2d3e 6461 7461 202b 2069 3130 2a6e 6230  ->data + i10*nb0
+0003aff0: 2020 2b20 6931 312a 6e62 3120 202b 2069    + i11*nb1  + i
+0003b000: 3132 2a6e 6232 2020 2b20 6931 332a 6e62  12*nb2  + i13*nb
+0003b010: 3329 3b0a 0a20 2020 2020 2020 2020 2020  3);..           
+0003b020: 2020 2020 2020 2020 2020 2020 202a 2867               *(g
+0003b030: 676d 6c5f 6670 3136 5f74 202a 2920 6473  gml_fp16_t *) ds
+0003b040: 745f 7074 7220 3d20 4747 4d4c 5f46 5033  t_ptr = GGML_FP3
+0003b050: 325f 544f 5f46 5031 3628 2a28 636f 6e73  2_TO_FP16(*(cons
+0003b060: 7420 666c 6f61 7420 2a29 2073 7263 305f  t float *) src0_
+0003b070: 7074 7229 3b0a 0a20 2020 2020 2020 2020  ptr);..         
+0003b080: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003b090: 6620 282b 2b69 3130 203d 3d20 6e65 3029  f (++i10 == ne0)
+0003b0a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0003b0b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003b0c0: 3130 203d 2030 3b0a 2020 2020 2020 2020  10 = 0;.        
+0003b0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b0e0: 2020 2020 6966 2028 2b2b 6931 3120 3d3d      if (++i11 ==
+0003b0f0: 206e 6531 2920 7b0a 2020 2020 2020 2020   ne1) {.        
+0003b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b110: 2020 2020 2020 2020 6931 3120 3d20 303b          i11 = 0;
+0003b120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b140: 2069 6620 282b 2b69 3132 203d 3d20 6e65   if (++i12 == ne
+0003b150: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
 0003b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b180: 6966 2028 2b2b 6931 3220 3d3d 206e 6532  if (++i12 == ne2
-0003b190: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0003b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b1b0: 2020 2020 2020 2020 6931 3220 3d20 303b          i12 = 0;
-0003b1c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b170: 2020 2020 2020 2020 2069 3132 203d 2030           i12 = 0
+0003b180: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0003b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b1a0: 2020 2020 2020 6966 2028 2b2b 6931 3320        if (++i13 
+0003b1b0: 3d3d 206e 6533 2920 7b0a 2020 2020 2020  == ne3) {.      
+0003b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0003b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b1e0: 2020 2020 2069 6620 282b 2b69 3133 203d       if (++i13 =
-0003b1f0: 3d20 6e65 3329 207b 0a20 2020 2020 2020  = ne3) {.       
-0003b200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b220: 2069 3133 203d 2030 3b0a 2020 2020 2020   i13 = 0;.      
-0003b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b240: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0003b250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b270: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0003b280: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0003b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b2a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0003b2b0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0003b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b2d0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0003b2e0: 2020 6931 3020 2b3d 206e 6530 3020 2a20    i10 += ne00 * 
-0003b2f0: 286e 6530 3120 2d20 6972 3129 3b0a 2020  (ne01 - ir1);.  
-0003b300: 2020 2020 2020 2020 2020 2020 2020 7768                wh
-0003b310: 696c 6520 2869 3130 203e 3d20 6e65 3029  ile (i10 >= ne0)
-0003b320: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0003b330: 2020 2020 2020 2069 3130 202d 3d20 6e65         i10 -= ne
-0003b340: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-0003b350: 2020 2020 2020 2069 6620 282b 2b69 3131         if (++i11
-0003b360: 203d 3d20 6e65 3129 207b 0a20 2020 2020   == ne1) {.     
-0003b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b380: 2020 2069 3131 203d 2030 3b0a 2020 2020     i11 = 0;.    
-0003b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b3a0: 2020 2020 6966 2028 2b2b 6931 3220 3d3d      if (++i12 ==
-0003b3b0: 206e 6532 2920 7b0a 2020 2020 2020 2020   ne2) {.        
-0003b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b3d0: 2020 2020 6931 3220 3d20 303b 0a20 2020      i12 = 0;.   
-0003b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b3f0: 2020 2020 2020 2020 2069 6620 282b 2b69           if (++i
-0003b400: 3133 203d 3d20 6e65 3329 207b 0a20 2020  13 == ne3) {.   
-0003b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b420: 2020 2020 2020 2020 2020 2020 2069 3133               i13
-0003b430: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
-0003b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b450: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0003b460: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0003b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b480: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0003b490: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0003b4a0: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
-0003b4b0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-0003b4c0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-0003b4d0: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
-0003b4e0: 696d 706c 656d 656e 740a 2020 2020 7d0a  implement.    }.
-0003b4f0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-0003b500: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-0003b510: 6172 645f 6475 7028 0a20 2020 2020 2020  ard_dup(.       
-0003b520: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0003b530: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-0003b540: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-0003b550: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0003b560: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-0003b570: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
-0003b580: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0003b590: 2a20 6473 7429 207b 0a20 2020 2069 6620  * dst) {.    if 
-0003b5a0: 2867 676d 6c5f 6973 5f63 6f6e 7469 6775  (ggml_is_contigu
-0003b5b0: 6f75 7328 7372 6330 2920 2626 2067 676d  ous(src0) && ggm
-0003b5c0: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
-0003b5d0: 6473 7429 2026 2620 7372 6330 2d3e 7479  dst) && src0->ty
-0003b5e0: 7065 203d 3d20 6473 742d 3e74 7970 6529  pe == dst->type)
-0003b5f0: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
-0003b600: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0003b610: 6475 705f 7361 6d65 5f63 6f6e 7428 7061  dup_same_cont(pa
-0003b620: 7261 6d73 2c20 7372 6330 2c20 6473 7429  rams, src0, dst)
-0003b630: 3b0a 2020 2020 2020 2020 7265 7475 726e  ;.        return
-0003b640: 3b0a 2020 2020 7d0a 2020 2020 7377 6974  ;.    }.    swit
-0003b650: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-0003b660: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-0003b670: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-0003b680: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0003b690: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0003b6a0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0003b6b0: 5f64 7570 5f66 3136 2870 6172 616d 732c  _dup_f16(params,
-0003b6c0: 2073 7263 302c 2064 7374 293b 0a20 2020   src0, dst);.   
-0003b6d0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0003b6e0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0003b6f0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
-0003b700: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0003b710: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0003b720: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0003b730: 5f64 7570 5f66 3332 2870 6172 616d 732c  _dup_f32(params,
-0003b740: 2073 7263 302c 2064 7374 293b 0a20 2020   src0, dst);.   
-0003b750: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0003b760: 3b0a 2020 2020 2020 2020 6465 6661 756c  ;.        defaul
-0003b770: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
-0003b780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b790: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-0003b7a0: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-0003b7b0: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-0003b7c0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-0003b7d0: 7465 5f66 6f72 7761 7264 5f61 6464 0a0a  te_forward_add..
-0003b7e0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-0003b7f0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0003b800: 5f61 6464 5f66 3332 280a 2020 2020 2020  _add_f32(.      
-0003b810: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0003b820: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0003b830: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0003b840: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0003b850: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0003b860: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-0003b870: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0003b880: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-0003b890: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0003b8a0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0003b8b0: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-0003b8c0: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-0003b8d0: 5f73 6861 7065 2873 7263 302c 2073 7263  _shape(src0, src
-0003b8e0: 3129 2026 2620 6767 6d6c 5f61 7265 5f73  1) && ggml_are_s
-0003b8f0: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-0003b900: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
-0003b910: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-0003b920: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
-0003b930: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
-0003b940: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-0003b950: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-0003b960: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-0003b970: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-0003b980: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-0003b990: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-0003b9a0: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-0003b9b0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0003b9c0: 6e72 2020 3d20 6767 6d6c 5f6e 726f 7773  nr  = ggml_nrows
-0003b9d0: 2873 7263 3029 3b0a 2020 2020 636f 6e73  (src0);.    cons
-0003b9e0: 7420 696e 7436 345f 7420 6e65 3020 3d20  t int64_t ne0 = 
-0003b9f0: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
-0003ba00: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-0003ba10: 6531 203d 2073 7263 302d 3e6e 655b 315d  e1 = src0->ne[1]
-0003ba20: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-0003ba30: 345f 7420 6e65 3220 3d20 7372 6330 2d3e  4_t ne2 = src0->
-0003ba40: 6e65 5b32 5d3b 0a0a 2020 2020 636f 6e73  ne[2];..    cons
-0003ba50: 7420 7369 7a65 5f74 206e 6230 3020 3d20  t size_t nb00 = 
-0003ba60: 7372 6330 2d3e 6e62 5b30 5d3b 0a20 2020  src0->nb[0];.   
-0003ba70: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0003ba80: 3031 203d 2073 7263 302d 3e6e 625b 315d  01 = src0->nb[1]
-0003ba90: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-0003baa0: 5f74 206e 6230 3220 3d20 7372 6330 2d3e  _t nb02 = src0->
-0003bab0: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
-0003bac0: 2073 697a 655f 7420 6e62 3033 203d 2073   size_t nb03 = s
-0003bad0: 7263 302d 3e6e 625b 335d 3b0a 0a20 2020  rc0->nb[3];..   
-0003bae0: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0003baf0: 3130 203d 2073 7263 312d 3e6e 625b 305d  10 = src1->nb[0]
-0003bb00: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-0003bb10: 5f74 206e 6231 3120 3d20 7372 6331 2d3e  _t nb11 = src1->
-0003bb20: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-0003bb30: 2073 697a 655f 7420 6e62 3132 203d 2073   size_t nb12 = s
-0003bb40: 7263 312d 3e6e 625b 325d 3b0a 2020 2020  rc1->nb[2];.    
-0003bb50: 636f 6e73 7420 7369 7a65 5f74 206e 6231  const size_t nb1
-0003bb60: 3320 3d20 7372 6331 2d3e 6e62 5b33 5d3b  3 = src1->nb[3];
-0003bb70: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
-0003bb80: 5f74 206e 6230 203d 2064 7374 2d3e 6e62  _t nb0 = dst->nb
-0003bb90: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
-0003bba0: 697a 655f 7420 6e62 3120 3d20 6473 742d  ize_t nb1 = dst-
-0003bbb0: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-0003bbc0: 7420 7369 7a65 5f74 206e 6232 203d 2064  t size_t nb2 = d
-0003bbd0: 7374 2d3e 6e62 5b32 5d3b 0a20 2020 2063  st->nb[2];.    c
-0003bbe0: 6f6e 7374 2073 697a 655f 7420 6e62 3320  onst size_t nb3 
-0003bbf0: 3d20 6473 742d 3e6e 625b 335d 3b0a 0a20  = dst->nb[3];.. 
-0003bc00: 2020 2047 474d 4c5f 4153 5345 5254 2820     GGML_ASSERT( 
-0003bc10: 6e62 3020 3d3d 2073 697a 656f 6628 666c  nb0 == sizeof(fl
-0003bc20: 6f61 7429 293b 0a20 2020 2047 474d 4c5f  oat));.    GGML_
-0003bc30: 4153 5345 5254 286e 6230 3020 3d3d 2073  ASSERT(nb00 == s
-0003bc40: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
-0003bc50: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
-0003bc60: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-0003bc70: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
-0003bc80: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
-0003bc90: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
-0003bca0: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
-0003bcb0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
-0003bcc0: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
-0003bcd0: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
-0003bce0: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
-0003bcf0: 293b 0a0a 2020 2020 6966 2028 6e62 3130  );..    if (nb10
-0003bd00: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-0003bd10: 2929 207b 0a20 2020 2020 2020 2066 6f72  )) {.        for
-0003bd20: 2028 696e 7420 6972 203d 2069 7230 3b20   (int ir = ir0; 
-0003bd30: 6972 203c 2069 7231 3b20 2b2b 6972 2920  ir < ir1; ++ir) 
-0003bd40: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
-0003bd50: 2073 7263 302c 2073 7263 3120 616e 6420   src0, src1 and 
-0003bd60: 6473 7420 6172 6520 7361 6d65 2073 6861  dst are same sha
-0003bd70: 7065 203d 3e20 7361 6d65 2069 6e64 6963  pe => same indic
-0003bd80: 6573 0a20 2020 2020 2020 2020 2020 2063  es.            c
-0003bd90: 6f6e 7374 2069 6e74 2069 3320 3d20 6972  onst int i3 = ir
-0003bda0: 2f28 6e65 322a 6e65 3129 3b0a 2020 2020  /(ne2*ne1);.    
-0003bdb0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0003bdc0: 7420 6932 203d 2028 6972 202d 2069 332a  t i2 = (ir - i3*
-0003bdd0: 6e65 322a 6e65 3129 2f6e 6531 3b0a 2020  ne2*ne1)/ne1;.  
-0003bde0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0003bdf0: 696e 7420 6931 203d 2028 6972 202d 2069  int i1 = (ir - i
-0003be00: 332a 6e65 322a 6e65 3120 2d20 6932 2a6e  3*ne2*ne1 - i2*n
-0003be10: 6531 293b 0a0a 0a23 6966 6465 6620 4747  e1);...#ifdef GG
-0003be20: 4d4c 5f55 5345 5f41 4343 454c 4552 4154  ML_USE_ACCELERAT
-0003be30: 450a 2020 2020 2020 2020 2020 2020 7644  E.            vD
-0003be40: 5350 5f76 6164 6428 0a20 2020 2020 2020  SP_vadd(.       
-0003be50: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-0003be60: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-0003be70: 2073 7263 302d 3e64 6174 6120 2b20 6933   src0->data + i3
-0003be80: 2a6e 6230 3320 2b20 6932 2a6e 6230 3220  *nb03 + i2*nb02 
-0003be90: 2b20 6931 2a6e 6230 3129 2c20 312c 0a20  + i1*nb01), 1,. 
-0003bea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003beb0: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-0003bec0: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
-0003bed0: 6120 2b20 6933 2a6e 6231 3320 2b20 6932  a + i3*nb13 + i2
-0003bee0: 2a6e 6231 3220 2b20 6931 2a6e 6231 3129  *nb12 + i1*nb11)
-0003bef0: 2c20 312c 0a20 2020 2020 2020 2020 2020  , 1,.           
-0003bf00: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-0003bf10: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
-0003bf20: 2d3e 6461 7461 2020 2b20 6933 2a6e 6233  ->data  + i3*nb3
-0003bf30: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
-0003bf40: 2a6e 6231 2029 2c20 312c 0a20 2020 2020  *nb1 ), 1,.     
-0003bf50: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0003bf60: 6530 293b 0a23 656c 7365 0a20 2020 2020  e0);.#else.     
-0003bf70: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0003bf80: 6164 645f 6633 3228 6e65 302c 0a20 2020  add_f32(ne0,.   
-0003bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bfa0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-0003bfb0: 7220 2a29 2064 7374 2d3e 6461 7461 2020  r *) dst->data  
-0003bfc0: 2b20 6933 2a6e 6233 2020 2b20 6932 2a6e  + i3*nb3  + i2*n
-0003bfd0: 6232 2020 2b20 6931 2a6e 6231 2029 2c0a  b2  + i1*nb1 ),.
-0003bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bff0: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-0003c000: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-0003c010: 7461 202b 2069 332a 6e62 3033 202b 2069  ta + i3*nb03 + i
-0003c020: 322a 6e62 3032 202b 2069 312a 6e62 3031  2*nb02 + i1*nb01
-0003c030: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0003c040: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-0003c050: 2028 2863 6861 7220 2a29 2073 7263 312d   ((char *) src1-
-0003c060: 3e64 6174 6120 2b20 6933 2a6e 6231 3320  >data + i3*nb13 
-0003c070: 2b20 6932 2a6e 6231 3220 2b20 6931 2a6e  + i2*nb12 + i1*n
-0003c080: 6231 3129 293b 0a23 656e 6469 660a 2020  b11));.#endif.  
-0003c090: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0003c0a0: 207d 0a20 2020 2020 2020 2020 2020 202f   }.            /
-0003c0b0: 2f20 7d0a 2020 2020 2020 2020 7d0a 2020  / }.        }.  
-0003c0c0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-0003c0d0: 2020 202f 2f20 7372 6331 2069 7320 6e6f     // src1 is no
-0003c0e0: 7420 636f 6e74 6967 756f 7573 0a20 2020  t contiguous.   
-0003c0f0: 2020 2020 2066 6f72 2028 696e 7420 6972       for (int ir
-0003c100: 203d 2069 7230 3b20 6972 203c 2069 7231   = ir0; ir < ir1
-0003c110: 3b20 2b2b 6972 2920 7b0a 2020 2020 2020  ; ++ir) {.      
-0003c120: 2020 2020 2020 2f2f 2073 7263 302c 2073        // src0, s
-0003c130: 7263 3120 616e 6420 6473 7420 6172 6520  rc1 and dst are 
-0003c140: 7361 6d65 2073 6861 7065 203d 3e20 7361  same shape => sa
-0003c150: 6d65 2069 6e64 6963 6573 0a20 2020 2020  me indices.     
-0003c160: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0003c170: 2069 3320 3d20 6972 2f28 6e65 322a 6e65   i3 = ir/(ne2*ne
-0003c180: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-0003c190: 636f 6e73 7420 696e 7420 6932 203d 2028  const int i2 = (
-0003c1a0: 6972 202d 2069 332a 6e65 322a 6e65 3129  ir - i3*ne2*ne1)
-0003c1b0: 2f6e 6531 3b0a 2020 2020 2020 2020 2020  /ne1;.          
-0003c1c0: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
-0003c1d0: 2028 6972 202d 2069 332a 6e65 322a 6e65   (ir - i3*ne2*ne
-0003c1e0: 3120 2d20 6932 2a6e 6531 293b 0a0a 2020  1 - i2*ne1);..  
-0003c1f0: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-0003c200: 2a20 6473 745f 7074 7220 203d 2028 666c  * dst_ptr  = (fl
-0003c210: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-0003c220: 2064 7374 2d3e 6461 7461 2020 2b20 6933   dst->data  + i3
-0003c230: 2a6e 6233 2020 2b20 6932 2a6e 6232 2020  *nb3  + i2*nb2  
-0003c240: 2b20 6931 2a6e 6231 2029 3b0a 2020 2020  + i1*nb1 );.    
-0003c250: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-0003c260: 7372 6330 5f70 7472 203d 2028 666c 6f61  src0_ptr = (floa
-0003c270: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-0003c280: 7263 302d 3e64 6174 6120 2b20 6933 2a6e  rc0->data + i3*n
-0003c290: 6230 3320 2b20 6932 2a6e 6230 3220 2b20  b03 + i2*nb02 + 
-0003c2a0: 6931 2a6e 6230 3129 3b0a 2020 2020 2020  i1*nb01);.      
-0003c2b0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0003c2c0: 3020 3d20 303b 2069 3020 3c20 6e65 303b  0 = 0; i0 < ne0;
-0003c2d0: 2069 302b 2b29 207b 0a20 2020 2020 2020   i0++) {.       
-0003c2e0: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-0003c2f0: 2073 7263 315f 7074 7220 3d20 2866 6c6f   src1_ptr = (flo
-0003c300: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-0003c310: 7372 6331 2d3e 6461 7461 202b 2069 332a  src1->data + i3*
-0003c320: 6e62 3133 202b 2069 322a 6e62 3132 202b  nb13 + i2*nb12 +
-0003c330: 2069 312a 6e62 3131 202b 2069 302a 6e62   i1*nb11 + i0*nb
-0003c340: 3130 293b 0a0a 2020 2020 2020 2020 2020  10);..          
-0003c350: 2020 2020 2020 6473 745f 7074 725b 6930        dst_ptr[i0
-0003c360: 5d20 3d20 7372 6330 5f70 7472 5b69 305d  ] = src0_ptr[i0]
-0003c370: 202b 202a 7372 6331 5f70 7472 3b0a 2020   + *src1_ptr;.  
-0003c380: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0003c390: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
-0003c3a0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0003c3b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0003c3c0: 6164 645f 6631 365f 6633 3228 0a20 2020  add_f16_f32(.   
-0003c3d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0003c3e0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-0003c3f0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-0003c400: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0003c410: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0003c420: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-0003c430: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0003c440: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-0003c450: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0003c460: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-0003c470: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-0003c480: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
-0003c490: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-0003c4a0: 7372 6331 2920 2626 2067 676d 6c5f 6172  src1) && ggml_ar
-0003c4b0: 655f 7361 6d65 5f73 6861 7065 2873 7263  e_same_shape(src
-0003c4c0: 302c 2064 7374 2929 3b0a 0a20 2020 2069  0, dst));..    i
-0003c4d0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-0003c4e0: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-0003c4f0: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
-0003c500: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-0003c510: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-0003c520: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-0003c530: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0003c540: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
-0003c550: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-0003c560: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
-0003c570: 7468 3b0a 0a20 2020 2063 6f6e 7374 2069  th;..    const i
-0003c580: 6e74 206e 7220 203d 2067 676d 6c5f 6e72  nt nr  = ggml_nr
-0003c590: 6f77 7328 7372 6330 293b 0a20 2020 2063  ows(src0);.    c
-0003c5a0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
-0003c5b0: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
-0003c5c0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0003c5d0: 7420 6e65 3120 3d20 7372 6330 2d3e 6e65  t ne1 = src0->ne
-0003c5e0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-0003c5f0: 6e74 3634 5f74 206e 6532 203d 2073 7263  nt64_t ne2 = src
-0003c600: 302d 3e6e 655b 325d 3b0a 0a20 2020 2063  0->ne[2];..    c
-0003c610: 6f6e 7374 2073 697a 655f 7420 6e62 3030  onst size_t nb00
-0003c620: 203d 2073 7263 302d 3e6e 625b 305d 3b0a   = src0->nb[0];.
-0003c630: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0003c640: 206e 6230 3120 3d20 7372 6330 2d3e 6e62   nb01 = src0->nb
-0003c650: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2073  [1];.    const s
-0003c660: 697a 655f 7420 6e62 3032 203d 2073 7263  ize_t nb02 = src
-0003c670: 302d 3e6e 625b 325d 3b0a 2020 2020 636f  0->nb[2];.    co
-0003c680: 6e73 7420 7369 7a65 5f74 206e 6230 3320  nst size_t nb03 
-0003c690: 3d20 7372 6330 2d3e 6e62 5b33 5d3b 0a0a  = src0->nb[3];..
-0003c6a0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0003c6b0: 206e 6231 3020 3d20 7372 6331 2d3e 6e62   nb10 = src1->nb
-0003c6c0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
-0003c6d0: 697a 655f 7420 6e62 3131 203d 2073 7263  ize_t nb11 = src
-0003c6e0: 312d 3e6e 625b 315d 3b0a 2020 2020 636f  1->nb[1];.    co
-0003c6f0: 6e73 7420 7369 7a65 5f74 206e 6231 3220  nst size_t nb12 
-0003c700: 3d20 7372 6331 2d3e 6e62 5b32 5d3b 0a20  = src1->nb[2];. 
-0003c710: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0003c720: 6e62 3133 203d 2073 7263 312d 3e6e 625b  nb13 = src1->nb[
-0003c730: 335d 3b0a 0a20 2020 2063 6f6e 7374 2073  3];..    const s
-0003c740: 697a 655f 7420 6e62 3020 3d20 6473 742d  ize_t nb0 = dst-
-0003c750: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-0003c760: 7420 7369 7a65 5f74 206e 6231 203d 2064  t size_t nb1 = d
-0003c770: 7374 2d3e 6e62 5b31 5d3b 0a20 2020 2063  st->nb[1];.    c
-0003c780: 6f6e 7374 2073 697a 655f 7420 6e62 3220  onst size_t nb2 
-0003c790: 3d20 6473 742d 3e6e 625b 325d 3b0a 2020  = dst->nb[2];.  
-0003c7a0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0003c7b0: 6233 203d 2064 7374 2d3e 6e62 5b33 5d3b  b3 = dst->nb[3];
-0003c7c0: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-0003c7d0: 5428 7372 6330 2d3e 7479 7065 203d 3d20  T(src0->type == 
-0003c7e0: 4747 4d4c 5f54 5950 455f 4631 3629 3b0a  GGML_TYPE_F16);.
-0003c7f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0003c800: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-0003c810: 4d4c 5f54 5950 455f 4633 3229 3b0a 2020  ML_TYPE_F32);.  
-0003c820: 2020 4747 4d4c 5f41 5353 4552 5428 6473    GGML_ASSERT(ds
-0003c830: 742d 3e74 7970 6520 3d3d 2047 474d 4c5f  t->type == GGML_
-0003c840: 5459 5045 5f46 3136 293b 0a0a 2020 2020  TYPE_F16);..    
-0003c850: 4747 4d4c 5f41 5353 4552 5428 206e 6230  GGML_ASSERT( nb0
-0003c860: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
-0003c870: 6670 3136 5f74 2929 3b0a 2020 2020 4747  fp16_t));.    GG
-0003c880: 4d4c 5f41 5353 4552 5428 6e62 3030 203d  ML_ASSERT(nb00 =
-0003c890: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
-0003c8a0: 3136 5f74 2929 3b0a 0a20 2020 202f 2f20  16_t));..    // 
-0003c8b0: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
-0003c8c0: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
-0003c8d0: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
-0003c8e0: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
-0003c8f0: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
-0003c900: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
-0003c910: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
-0003c920: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-0003c930: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
-0003c940: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
-0003c950: 2069 6620 286e 6231 3020 3d3d 2073 697a   if (nb10 == siz
-0003c960: 656f 6628 666c 6f61 7429 2920 7b0a 2020  eof(float)) {.  
-0003c970: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0003c980: 7220 3d20 6972 303b 2069 7220 3c20 6972  r = ir0; ir < ir
-0003c990: 313b 202b 2b69 7229 207b 0a20 2020 2020  1; ++ir) {.     
-0003c9a0: 2020 2020 2020 202f 2f20 7372 6330 2c20         // src0, 
-0003c9b0: 7372 6331 2061 6e64 2064 7374 2061 7265  src1 and dst are
-0003c9c0: 2073 616d 6520 7368 6170 6520 3d3e 2073   same shape => s
-0003c9d0: 616d 6520 696e 6469 6365 730a 2020 2020  ame indices.    
-0003c9e0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0003c9f0: 7420 6933 203d 2069 722f 286e 6532 2a6e  t i3 = ir/(ne2*n
-0003ca00: 6531 293b 0a20 2020 2020 2020 2020 2020  e1);.           
-0003ca10: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
-0003ca20: 2869 7220 2d20 6933 2a6e 6532 2a6e 6531  (ir - i3*ne2*ne1
-0003ca30: 292f 6e65 313b 0a20 2020 2020 2020 2020  )/ne1;.         
-0003ca40: 2020 2063 6f6e 7374 2069 6e74 2069 3120     const int i1 
-0003ca50: 3d20 2869 7220 2d20 6933 2a6e 6532 2a6e  = (ir - i3*ne2*n
-0003ca60: 6531 202d 2069 322a 6e65 3129 3b0a 0a20  e1 - i2*ne1);.. 
-0003ca70: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0003ca80: 6670 3136 5f74 202a 2064 7374 5f70 7472  fp16_t * dst_ptr
-0003ca90: 2020 3d20 2867 676d 6c5f 6670 3136 5f74    = (ggml_fp16_t
-0003caa0: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-0003cab0: 742d 3e64 6174 6120 202b 2069 332a 6e62  t->data  + i3*nb
-0003cac0: 3320 202b 2069 322a 6e62 3220 202b 2069  3  + i2*nb2  + i
-0003cad0: 312a 6e62 3129 3b0a 2020 2020 2020 2020  1*nb1);.        
-0003cae0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-0003caf0: 2a20 7372 6330 5f70 7472 203d 2028 6767  * src0_ptr = (gg
-0003cb00: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
-0003cb10: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-0003cb20: 6120 2b20 6933 2a6e 6230 3320 2b20 6932  a + i3*nb03 + i2
-0003cb30: 2a6e 6230 3220 2b20 6931 2a6e 6230 3129  *nb02 + i1*nb01)
-0003cb40: 3b0a 2020 2020 2020 2020 2020 2020 666c  ;.            fl
-0003cb50: 6f61 7420 2a20 2020 2020 2020 7372 6331  oat *       src1
-0003cb60: 5f70 7472 203d 2028 666c 6f61 7420 2a29  _ptr = (float *)
-0003cb70: 2020 2020 2020 2028 2863 6861 7220 2a29         ((char *)
-0003cb80: 2073 7263 312d 3e64 6174 6120 2b20 6933   src1->data + i3
-0003cb90: 2a6e 6231 3320 2b20 6932 2a6e 6231 3220  *nb13 + i2*nb12 
-0003cba0: 2b20 6931 2a6e 6231 3129 3b0a 0a20 2020  + i1*nb11);..   
-0003cbb0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0003cbc0: 7420 6920 3d20 303b 2069 203c 206e 6530  t i = 0; i < ne0
-0003cbd0: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-0003cbe0: 2020 2020 2020 2020 2064 7374 5f70 7472           dst_ptr
-0003cbf0: 5b69 5d20 3d20 4747 4d4c 5f46 5033 325f  [i] = GGML_FP32_
-0003cc00: 544f 5f46 5031 3628 4747 4d4c 5f46 5031  TO_FP16(GGML_FP1
-0003cc10: 365f 544f 5f46 5033 3228 7372 6330 5f70  6_TO_FP32(src0_p
-0003cc20: 7472 5b69 5d29 202b 2073 7263 315f 7074  tr[i]) + src1_pt
-0003cc30: 725b 695d 293b 0a20 2020 2020 2020 2020  r[i]);.         
-0003cc40: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-0003cc50: 2020 207d 0a20 2020 2065 6c73 6520 7b0a     }.    else {.
-0003cc60: 2020 2020 2020 2020 2f2f 2073 7263 3120          // src1 
-0003cc70: 6973 206e 6f74 2063 6f6e 7469 6775 6f75  is not contiguou
-0003cc80: 730a 2020 2020 2020 2020 4747 4d4c 5f41  s.        GGML_A
-0003cc90: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
-0003cca0: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-0003ccb0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-0003ccc0: 666f 7277 6172 645f 6164 645f 6631 365f  forward_add_f16_
-0003ccd0: 6631 3628 0a20 2020 2020 2020 2063 6f6e  f16(.        con
-0003cce0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-0003ccf0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-0003cd00: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-0003cd10: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0003cd20: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-0003cd30: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0003cd40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0003cd50: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-0003cd60: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0003cd70: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-0003cd80: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-0003cd90: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-0003cda0: 6528 7372 6330 2c20 7372 6331 2920 2626  e(src0, src1) &&
-0003cdb0: 2067 676d 6c5f 6172 655f 7361 6d65 5f73   ggml_are_same_s
-0003cdc0: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
-0003cdd0: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
-0003cde0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-0003cdf0: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
-0003ce00: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-0003ce10: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
-0003ce20: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-0003ce30: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
-0003ce40: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
-0003ce50: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
-0003ce60: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
-0003ce70: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
-0003ce80: 2063 6f6e 7374 2069 6e74 206e 7220 203d   const int nr  =
-0003ce90: 2067 676d 6c5f 6e72 6f77 7328 7372 6330   ggml_nrows(src0
-0003cea0: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
-0003ceb0: 3634 5f74 206e 6530 203d 2073 7263 302d  64_t ne0 = src0-
-0003cec0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-0003ced0: 7420 696e 7436 345f 7420 6e65 3120 3d20  t int64_t ne1 = 
-0003cee0: 7372 6330 2d3e 6e65 5b31 5d3b 0a20 2020  src0->ne[1];.   
-0003cef0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-0003cf00: 6532 203d 2073 7263 302d 3e6e 655b 325d  e2 = src0->ne[2]
-0003cf10: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
-0003cf20: 655f 7420 6e62 3030 203d 2073 7263 302d  e_t nb00 = src0-
-0003cf30: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-0003cf40: 7420 7369 7a65 5f74 206e 6230 3120 3d20  t size_t nb01 = 
-0003cf50: 7372 6330 2d3e 6e62 5b31 5d3b 0a20 2020  src0->nb[1];.   
-0003cf60: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0003cf70: 3032 203d 2073 7263 302d 3e6e 625b 325d  02 = src0->nb[2]
-0003cf80: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-0003cf90: 5f74 206e 6230 3320 3d20 7372 6330 2d3e  _t nb03 = src0->
-0003cfa0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-0003cfb0: 7420 7369 7a65 5f74 206e 6231 3020 3d20  t size_t nb10 = 
-0003cfc0: 7372 6331 2d3e 6e62 5b30 5d3b 0a20 2020  src1->nb[0];.   
-0003cfd0: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0003cfe0: 3131 203d 2073 7263 312d 3e6e 625b 315d  11 = src1->nb[1]
-0003cff0: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-0003d000: 5f74 206e 6231 3220 3d20 7372 6331 2d3e  _t nb12 = src1->
-0003d010: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
-0003d020: 2073 697a 655f 7420 6e62 3133 203d 2073   size_t nb13 = s
-0003d030: 7263 312d 3e6e 625b 335d 3b0a 0a20 2020  rc1->nb[3];..   
-0003d040: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0003d050: 3020 3d20 6473 742d 3e6e 625b 305d 3b0a  0 = dst->nb[0];.
-0003d060: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0003d070: 206e 6231 203d 2064 7374 2d3e 6e62 5b31   nb1 = dst->nb[1
-0003d080: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-0003d090: 655f 7420 6e62 3220 3d20 6473 742d 3e6e  e_t nb2 = dst->n
-0003d0a0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-0003d0b0: 7369 7a65 5f74 206e 6233 203d 2064 7374  size_t nb3 = dst
-0003d0c0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 4747  ->nb[3];..    GG
-0003d0d0: 4d4c 5f41 5353 4552 5428 7372 6330 2d3e  ML_ASSERT(src0->
-0003d0e0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-0003d0f0: 455f 4631 3629 3b0a 2020 2020 4747 4d4c  E_F16);.    GGML
-0003d100: 5f41 5353 4552 5428 7372 6331 2d3e 7479  _ASSERT(src1->ty
-0003d110: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-0003d120: 4631 3629 3b0a 2020 2020 4747 4d4c 5f41  F16);.    GGML_A
-0003d130: 5353 4552 5428 6473 742d 3e74 7970 6520  SSERT(dst->type 
-0003d140: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
-0003d150: 3629 3b0a 0a20 2020 2047 474d 4c5f 4153  6);..    GGML_AS
-0003d160: 5345 5254 2820 6e62 3020 3d3d 2073 697a  SERT( nb0 == siz
-0003d170: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
-0003d180: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0003d190: 5254 286e 6230 3020 3d3d 2073 697a 656f  RT(nb00 == sizeo
-0003d1a0: 6628 6767 6d6c 5f66 7031 365f 7429 293b  f(ggml_fp16_t));
-0003d1b0: 0a0a 2020 2020 2f2f 2072 6f77 7320 7065  ..    // rows pe
-0003d1c0: 7220 7468 7265 6164 0a20 2020 2063 6f6e  r thread.    con
-0003d1d0: 7374 2069 6e74 2064 7220 3d20 286e 7220  st int dr = (nr 
-0003d1e0: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
-0003d1f0: 0a20 2020 202f 2f20 726f 7720 7261 6e67  .    // row rang
-0003d200: 6520 666f 7220 7468 6973 2074 6872 6561  e for this threa
-0003d210: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-0003d220: 6972 3020 3d20 6472 2a69 7468 3b0a 2020  ir0 = dr*ith;.  
-0003d230: 2020 636f 6e73 7420 696e 7420 6972 3120    const int ir1 
-0003d240: 3d20 4d49 4e28 6972 3020 2b20 6472 2c20  = MIN(ir0 + dr, 
-0003d250: 6e72 293b 0a0a 2020 2020 6966 2028 6e62  nr);..    if (nb
-0003d260: 3130 203d 3d20 7369 7a65 6f66 2867 676d  10 == sizeof(ggm
-0003d270: 6c5f 6670 3136 5f74 2929 207b 0a20 2020  l_fp16_t)) {.   
-0003d280: 2020 2020 2066 6f72 2028 696e 7420 6972       for (int ir
-0003d290: 203d 2069 7230 3b20 6972 203c 2069 7231   = ir0; ir < ir1
-0003d2a0: 3b20 2b2b 6972 2920 7b0a 2020 2020 2020  ; ++ir) {.      
-0003d2b0: 2020 2020 2020 2f2f 2073 7263 302c 2073        // src0, s
-0003d2c0: 7263 3120 616e 6420 6473 7420 6172 6520  rc1 and dst are 
-0003d2d0: 7361 6d65 2073 6861 7065 203d 3e20 7361  same shape => sa
-0003d2e0: 6d65 2069 6e64 6963 6573 0a20 2020 2020  me indices.     
-0003d2f0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0003d300: 2069 3320 3d20 6972 2f28 6e65 322a 6e65   i3 = ir/(ne2*ne
-0003d310: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-0003d320: 636f 6e73 7420 696e 7420 6932 203d 2028  const int i2 = (
-0003d330: 6972 202d 2069 332a 6e65 322a 6e65 3129  ir - i3*ne2*ne1)
-0003d340: 2f6e 6531 3b0a 2020 2020 2020 2020 2020  /ne1;.          
-0003d350: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
-0003d360: 2028 6972 202d 2069 332a 6e65 322a 6e65   (ir - i3*ne2*ne
-0003d370: 3120 2d20 6932 2a6e 6531 293b 0a0a 2020  1 - i2*ne1);..  
-0003d380: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
-0003d390: 7031 365f 7420 2a20 6473 745f 7074 7220  p16_t * dst_ptr 
-0003d3a0: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
-0003d3b0: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
-0003d3c0: 2d3e 6461 7461 2020 2b20 6933 2a6e 6233  ->data  + i3*nb3
-0003d3d0: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
-0003d3e0: 2a6e 6231 293b 0a20 2020 2020 2020 2020  *nb1);.         
-0003d3f0: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
-0003d400: 2073 7263 305f 7074 7220 3d20 2867 676d   src0_ptr = (ggm
-0003d410: 6c5f 6670 3136 5f74 202a 2920 2828 6368  l_fp16_t *) ((ch
-0003d420: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-0003d430: 202b 2069 332a 6e62 3033 202b 2069 322a   + i3*nb03 + i2*
-0003d440: 6e62 3032 202b 2069 312a 6e62 3031 293b  nb02 + i1*nb01);
-0003d450: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-0003d460: 6c5f 6670 3136 5f74 202a 2073 7263 315f  l_fp16_t * src1_
-0003d470: 7074 7220 3d20 2867 676d 6c5f 6670 3136  ptr = (ggml_fp16
-0003d480: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
-0003d490: 7372 6331 2d3e 6461 7461 202b 2069 332a  src1->data + i3*
-0003d4a0: 6e62 3133 202b 2069 322a 6e62 3132 202b  nb13 + i2*nb12 +
-0003d4b0: 2069 312a 6e62 3131 293b 0a0a 2020 2020   i1*nb11);..    
-0003d4c0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0003d4d0: 2069 203d 2030 3b20 6920 3c20 6e65 303b   i = 0; i < ne0;
-0003d4e0: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-0003d4f0: 2020 2020 2020 2020 6473 745f 7074 725b          dst_ptr[
-0003d500: 695d 203d 2047 474d 4c5f 4650 3332 5f54  i] = GGML_FP32_T
-0003d510: 4f5f 4650 3136 2847 474d 4c5f 4650 3136  O_FP16(GGML_FP16
-0003d520: 5f54 4f5f 4650 3332 2873 7263 305f 7074  _TO_FP32(src0_pt
-0003d530: 725b 695d 2920 2b20 4747 4d4c 5f46 5031  r[i]) + GGML_FP1
-0003d540: 365f 544f 5f46 5033 3228 7372 6331 5f70  6_TO_FP32(src1_p
-0003d550: 7472 5b69 5d29 293b 0a20 2020 2020 2020  tr[i]));.       
-0003d560: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-0003d570: 0a20 2020 207d 0a20 2020 2065 6c73 6520  .    }.    else 
-0003d580: 7b0a 2020 2020 2020 2020 2f2f 2073 7263  {.        // src
-0003d590: 3120 6973 206e 6f74 2063 6f6e 7469 6775  1 is not contigu
-0003d5a0: 6f75 730a 2020 2020 2020 2020 4747 4d4c  ous.        GGML
-0003d5b0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-0003d5c0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-0003d5d0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-0003d5e0: 655f 666f 7277 6172 645f 6164 645f 715f  e_forward_add_q_
-0003d5f0: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
-0003d600: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-0003d610: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-0003d620: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-0003d630: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0003d640: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-0003d650: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0003d660: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0003d670: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-0003d680: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0003d690: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-0003d6a0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-0003d6b0: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-0003d6c0: 6528 7372 6330 2c20 7372 6331 2920 2626  e(src0, src1) &&
-0003d6d0: 2067 676d 6c5f 6172 655f 7361 6d65 5f73   ggml_are_same_s
-0003d6e0: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
-0003d6f0: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
-0003d700: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-0003d710: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
-0003d720: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-0003d730: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
-0003d740: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-0003d750: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
-0003d760: 6e73 7420 696e 7420 6e72 2020 3d20 6767  nst int nr  = gg
-0003d770: 6d6c 5f6e 726f 7773 2873 7263 3029 3b0a  ml_nrows(src0);.
-0003d780: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0003d790: 7420 6e65 3030 203d 2073 7263 302d 3e6e  t ne00 = src0->n
-0003d7a0: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-0003d7b0: 696e 7436 345f 7420 6e65 3031 203d 2073  int64_t ne01 = s
-0003d7c0: 7263 302d 3e6e 655b 315d 3b0a 2020 2020  rc0->ne[1];.    
-0003d7d0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0003d7e0: 3032 203d 2073 7263 302d 3e6e 655b 325d  02 = src0->ne[2]
-0003d7f0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0003d800: 7436 345f 7420 6e65 3033 203d 2073 7263  t64_t ne03 = src
-0003d810: 302d 3e6e 655b 335d 3b0a 0a20 2020 2063  0->ne[3];..    c
-0003d820: 6f6e 7374 2073 697a 655f 7420 6e62 3030  onst size_t nb00
-0003d830: 203d 2073 7263 302d 3e6e 625b 305d 3b0a   = src0->nb[0];.
-0003d840: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0003d850: 206e 6230 3120 3d20 7372 6330 2d3e 6e62   nb01 = src0->nb
-0003d860: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2073  [1];.    const s
-0003d870: 697a 655f 7420 6e62 3032 203d 2073 7263  ize_t nb02 = src
-0003d880: 302d 3e6e 625b 325d 3b0a 2020 2020 636f  0->nb[2];.    co
-0003d890: 6e73 7420 7369 7a65 5f74 206e 6230 3320  nst size_t nb03 
-0003d8a0: 3d20 7372 6330 2d3e 6e62 5b33 5d3b 0a0a  = src0->nb[3];..
-0003d8b0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0003d8c0: 206e 6231 3020 3d20 7372 6331 2d3e 6e62   nb10 = src1->nb
-0003d8d0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
-0003d8e0: 697a 655f 7420 6e62 3131 203d 2073 7263  ize_t nb11 = src
-0003d8f0: 312d 3e6e 625b 315d 3b0a 2020 2020 636f  1->nb[1];.    co
-0003d900: 6e73 7420 7369 7a65 5f74 206e 6231 3220  nst size_t nb12 
-0003d910: 3d20 7372 6331 2d3e 6e62 5b32 5d3b 0a20  = src1->nb[2];. 
-0003d920: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0003d930: 6e62 3133 203d 2073 7263 312d 3e6e 625b  nb13 = src1->nb[
-0003d940: 335d 3b0a 0a20 2020 2063 6f6e 7374 2073  3];..    const s
-0003d950: 697a 655f 7420 6e62 3020 203d 2064 7374  ize_t nb0  = dst
-0003d960: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-0003d970: 7374 2073 697a 655f 7420 6e62 3120 203d  st size_t nb1  =
-0003d980: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
-0003d990: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0003d9a0: 3220 203d 2064 7374 2d3e 6e62 5b32 5d3b  2  = dst->nb[2];
-0003d9b0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-0003d9c0: 7420 6e62 3320 203d 2064 7374 2d3e 6e62  t nb3  = dst->nb
-0003d9d0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-0003d9e0: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
-0003d9f0: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-0003da00: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
-0003da10: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
-0003da20: 7374 2065 6e75 6d20 6767 6d6c 5f74 7970  st enum ggml_typ
-0003da30: 6520 7479 7065 203d 2073 7263 302d 3e74  e type = src0->t
-0003da40: 7970 653b 0a20 2020 2064 6571 7561 6e74  ype;.    dequant
-0003da50: 697a 655f 726f 775f 715f 7420 636f 6e73  ize_row_q_t cons
-0003da60: 7420 6465 7175 616e 7469 7a65 5f72 6f77  t dequantize_row
-0003da70: 5f71 203d 2071 7561 6e74 697a 655f 666e  _q = quantize_fn
-0003da80: 735b 7479 7065 5d2e 6465 7175 616e 7469  s[type].dequanti
-0003da90: 7a65 5f72 6f77 5f71 3b0a 2020 2020 7175  ze_row_q;.    qu
-0003daa0: 616e 7469 7a65 5f72 6f77 5f71 5f74 2063  antize_row_q_t c
-0003dab0: 6f6e 7374 2071 7561 6e74 697a 655f 726f  onst quantize_ro
-0003dac0: 775f 7120 3d20 7175 616e 7469 7a65 5f66  w_q = quantize_f
-0003dad0: 6e73 5b74 7970 655d 2e71 7561 6e74 697a  ns[type].quantiz
-0003dae0: 655f 726f 775f 713b 0a0a 2020 2020 2f2f  e_row_q;..    //
-0003daf0: 2077 6520 646f 6e27 7420 7375 7070 6f72   we don't suppor
-0003db00: 7420 7065 726d 7574 6564 2073 7263 3020  t permuted src0 
-0003db10: 6f72 2073 7263 310a 2020 2020 4747 4d4c  or src1.    GGML
-0003db20: 5f41 5353 4552 5428 6e62 3030 203d 3d20  _ASSERT(nb00 == 
-0003db30: 4747 4d4c 5f54 5950 455f 5349 5a45 5b74  GGML_TYPE_SIZE[t
-0003db40: 7970 655d 293b 0a20 2020 2047 474d 4c5f  ype]);.    GGML_
-0003db50: 4153 5345 5254 286e 6231 3020 3d3d 2073  ASSERT(nb10 == s
-0003db60: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
-0003db70: 2020 2020 2f2f 2064 7374 2063 616e 6e6f      // dst canno
-0003db80: 7420 6265 2074 7261 6e73 706f 7365 6420  t be transposed 
-0003db90: 6f72 2070 6572 6d75 7465 640a 2020 2020  or permuted.    
-0003dba0: 4747 4d4c 5f41 5353 4552 5428 6e62 3020  GGML_ASSERT(nb0 
-0003dbb0: 3c3d 206e 6231 293b 0a20 2020 2047 474d  <= nb1);.    GGM
-0003dbc0: 4c5f 4153 5345 5254 286e 6231 203c 3d20  L_ASSERT(nb1 <= 
-0003dbd0: 6e62 3229 3b0a 2020 2020 4747 4d4c 5f41  nb2);.    GGML_A
-0003dbe0: 5353 4552 5428 6e62 3220 3c3d 206e 6233  SSERT(nb2 <= nb3
-0003dbf0: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
-0003dc00: 4552 5428 6767 6d6c 5f69 735f 7175 616e  ERT(ggml_is_quan
-0003dc10: 7469 7a65 6428 7372 6330 2d3e 7479 7065  tized(src0->type
-0003dc20: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-0003dc30: 4552 5428 6473 742d 3e74 7970 6520 3d3d  ERT(dst->type ==
-0003dc40: 2073 7263 302d 3e74 7970 6529 3b0a 2020   src0->type);.  
-0003dc50: 2020 4747 4d4c 5f41 5353 4552 5428 7372    GGML_ASSERT(sr
-0003dc60: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
-0003dc70: 5f54 5950 455f 4633 3229 3b0a 0a20 2020  _TYPE_F32);..   
-0003dc80: 202f 2f20 726f 7773 2070 6572 2074 6872   // rows per thr
-0003dc90: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
-0003dca0: 7420 6472 203d 2028 6e72 202b 206e 7468  t dr = (nr + nth
-0003dcb0: 202d 2031 292f 6e74 683b 0a0a 2020 2020   - 1)/nth;..    
-0003dcc0: 2f2f 2072 6f77 2072 616e 6765 2066 6f72  // row range for
-0003dcd0: 2074 6869 7320 7468 7265 6164 0a20 2020   this thread.   
-0003dce0: 2063 6f6e 7374 2069 6e74 2069 7230 203d   const int ir0 =
-0003dcf0: 2064 722a 6974 683b 0a20 2020 2063 6f6e   dr*ith;.    con
-0003dd00: 7374 2069 6e74 2069 7231 203d 204d 494e  st int ir1 = MIN
-0003dd10: 2869 7230 202b 2064 722c 206e 7229 3b0a  (ir0 + dr, nr);.
-0003dd20: 0a20 2020 2066 6c6f 6174 202a 2077 6461  .    float * wda
-0003dd30: 7461 203d 2028 666c 6f61 7420 2a29 2070  ta = (float *) p
-0003dd40: 6172 616d 732d 3e77 6461 7461 202b 2028  arams->wdata + (
-0003dd50: 6e65 3030 202b 2043 4143 4845 5f4c 494e  ne00 + CACHE_LIN
-0003dd60: 455f 5349 5a45 5f46 3332 2920 2a20 6974  E_SIZE_F32) * it
-0003dd70: 683b 0a0a 2020 2020 666f 7220 2869 6e74  h;..    for (int
-0003dd80: 2069 7220 3d20 6972 303b 2069 7220 3c20   ir = ir0; ir < 
-0003dd90: 6972 313b 202b 2b69 7229 207b 0a20 2020  ir1; ++ir) {.   
-0003dda0: 2020 2020 202f 2f20 7372 6330 2069 6e64       // src0 ind
-0003ddb0: 6963 6573 0a20 2020 2020 2020 2063 6f6e  ices.        con
-0003ddc0: 7374 2069 6e74 2069 3033 203d 2069 722f  st int i03 = ir/
-0003ddd0: 286e 6530 322a 6e65 3031 293b 0a20 2020  (ne02*ne01);.   
-0003dde0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0003ddf0: 3032 203d 2028 6972 202d 2069 3033 2a6e  02 = (ir - i03*n
-0003de00: 6530 322a 6e65 3031 292f 6e65 3031 3b0a  e02*ne01)/ne01;.
-0003de10: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0003de20: 7420 6930 3120 3d20 2869 7220 2d20 6930  t i01 = (ir - i0
-0003de30: 332a 6e65 3032 2a6e 6530 3120 2d20 6930  3*ne02*ne01 - i0
-0003de40: 322a 6e65 3031 293b 0a0a 2020 2020 2020  2*ne01);..      
-0003de50: 2020 2f2f 2073 7263 3120 616e 6420 6473    // src1 and ds
-0003de60: 7420 6172 6520 7361 6d65 2073 6861 7065  t are same shape
-0003de70: 2061 7320 7372 6330 203d 3e20 7361 6d65   as src0 => same
-0003de80: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-0003de90: 2063 6f6e 7374 2069 6e74 2069 3133 203d   const int i13 =
-0003dea0: 2069 3033 3b0a 2020 2020 2020 2020 636f   i03;.        co
-0003deb0: 6e73 7420 696e 7420 6931 3220 3d20 6930  nst int i12 = i0
-0003dec0: 323b 0a20 2020 2020 2020 2063 6f6e 7374  2;.        const
-0003ded0: 2069 6e74 2069 3131 203d 2069 3031 3b0a   int i11 = i01;.
-0003dee0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-0003def0: 6e74 2069 3320 3d20 6930 333b 0a20 2020  nt i3 = i03;.   
-0003df00: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0003df10: 3220 3d20 6930 323b 0a20 2020 2020 2020  2 = i02;.       
-0003df20: 2063 6f6e 7374 2069 6e74 2069 3120 3d20   const int i1 = 
-0003df30: 6930 313b 0a0a 2020 2020 2020 2020 766f  i01;..        vo
-0003df40: 6964 2020 2a20 7372 6330 5f72 6f77 203d  id  * src0_row =
-0003df50: 2028 766f 6964 202a 2920 2828 6368 6172   (void *) ((char
-0003df60: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-0003df70: 2028 6930 312a 6e62 3031 202b 2069 3032   (i01*nb01 + i02
-0003df80: 2a6e 6230 3220 2b20 6930 332a 6e62 3033  *nb02 + i03*nb03
-0003df90: 2929 3b0a 2020 2020 2020 2020 666c 6f61  ));.        floa
-0003dfa0: 7420 2a20 7372 6331 5f72 6f77 203d 2028  t * src1_row = (
-0003dfb0: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-0003dfc0: 2920 7372 6331 2d3e 6461 7461 202b 2028  ) src1->data + (
-0003dfd0: 6931 312a 6e62 3131 202b 2069 3132 2a6e  i11*nb11 + i12*n
-0003dfe0: 6231 3220 2b20 6931 332a 6e62 3133 2929  b12 + i13*nb13))
-0003dff0: 3b0a 2020 2020 2020 2020 766f 6964 2020  ;.        void  
-0003e000: 2a20 6473 745f 726f 7720 203d 2028 766f  * dst_row  = (vo
-0003e010: 6964 202a 2920 2828 6368 6172 202a 2920  id *) ((char *) 
-0003e020: 2064 7374 2d3e 6461 7461 202b 2028 2069   dst->data + ( i
-0003e030: 312a 6e62 3120 202b 2020 6932 2a6e 6232  1*nb1  +  i2*nb2
-0003e040: 2020 2b20 2069 332a 6e62 3329 293b 0a0a    +  i3*nb3));..
-0003e050: 2020 2020 2020 2020 6173 7365 7274 286e          assert(n
-0003e060: 6530 3020 2520 3332 203d 3d20 3029 3b0a  e00 % 32 == 0);.
-0003e070: 0a20 2020 2020 2020 202f 2f20 756e 7175  .        // unqu
-0003e080: 616e 7469 7a65 2072 6f77 2066 726f 6d20  antize row from 
-0003e090: 7372 6330 2074 6f20 7465 6d70 2062 7566  src0 to temp buf
-0003e0a0: 6665 720a 2020 2020 2020 2020 6465 7175  fer.        dequ
-0003e0b0: 616e 7469 7a65 5f72 6f77 5f71 2873 7263  antize_row_q(src
-0003e0c0: 305f 726f 772c 2077 6461 7461 2c20 6e65  0_row, wdata, ne
-0003e0d0: 3030 293b 0a20 2020 2020 2020 202f 2f20  00);.        // 
-0003e0e0: 6164 6420 7372 6331 0a20 2020 2020 2020  add src1.       
-0003e0f0: 2067 676d 6c5f 7665 635f 6163 635f 6633   ggml_vec_acc_f3
-0003e100: 3228 6e65 3030 2c20 7764 6174 612c 2073  2(ne00, wdata, s
-0003e110: 7263 315f 726f 7729 3b0a 2020 2020 2020  rc1_row);.      
-0003e120: 2020 2f2f 2071 7561 6e74 697a 6520 726f    // quantize ro
-0003e130: 7720 746f 2064 7374 0a20 2020 2020 2020  w to dst.       
-0003e140: 2071 7561 6e74 697a 655f 726f 775f 7128   quantize_row_q(
-0003e150: 7764 6174 612c 2064 7374 5f72 6f77 2c20  wdata, dst_row, 
-0003e160: 6e65 3030 293b 0a20 2020 207d 0a7d 0a0a  ne00);.    }.}..
-0003e170: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-0003e180: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0003e190: 5f61 6464 280a 2020 2020 2020 2020 636f  _add(.        co
-0003e1a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0003e1b0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-0003e1c0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-0003e1d0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0003e1e0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-0003e1f0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-0003e200: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0003e210: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
-0003e220: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0003e230: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-0003e240: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
-0003e250: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
-0003e260: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-0003e270: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
-0003e280: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0003e290: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-0003e2a0: 666f 7277 6172 645f 6164 645f 6633 3228  forward_add_f32(
-0003e2b0: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-0003e2c0: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-0003e2d0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0003e2e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0003e2f0: 5f54 5950 455f 4631 363a 0a20 2020 2020  _TYPE_F16:.     
-0003e300: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0003e310: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-0003e320: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
-0003e330: 5459 5045 5f46 3136 2920 7b0a 2020 2020  TYPE_F16) {.    
-0003e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e350: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-0003e360: 7761 7264 5f61 6464 5f66 3136 5f66 3136  ward_add_f16_f16
-0003e370: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
-0003e380: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
-0003e390: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0003e3a0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0003e3b0: 6520 6966 2028 7372 6331 2d3e 7479 7065  e if (src1->type
-0003e3c0: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
-0003e3d0: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
-0003e3e0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-0003e3f0: 6d70 7574 655f 666f 7277 6172 645f 6164  mpute_forward_ad
-0003e400: 645f 6631 365f 6633 3228 7061 7261 6d73  d_f16_f32(params
-0003e410: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
-0003e420: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-0003e430: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0003e440: 2020 2020 2020 656c 7365 207b 0a20 2020        else {.   
-0003e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e460: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-0003e470: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-0003e480: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0003e490: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0003e4a0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-0003e4b0: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
-0003e4c0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-0003e4d0: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
-0003e4e0: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
-0003e4f0: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
-0003e500: 4747 4d4c 5f54 5950 455f 5135 5f31 3a0a  GGML_TYPE_Q5_1:.
-0003e510: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0003e520: 4c5f 5459 5045 5f51 385f 303a 0a20 2020  L_TYPE_Q8_0:.   
-0003e530: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0003e540: 5950 455f 5132 5f4b 3a0a 2020 2020 2020  YPE_Q2_K:.      
-0003e550: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-0003e560: 5f51 335f 4b3a 0a20 2020 2020 2020 2063  _Q3_K:.        c
-0003e570: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
-0003e580: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
-0003e590: 2047 474d 4c5f 5459 5045 5f51 355f 4b3a   GGML_TYPE_Q5_K:
-0003e5a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0003e5b0: 4d4c 5f54 5950 455f 5136 5f4b 3a0a 2020  ML_TYPE_Q6_K:.  
-0003e5c0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0003e5d0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0003e5e0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0003e5f0: 5f61 6464 5f71 5f66 3332 2870 6172 616d  _add_q_f32(param
-0003e600: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-0003e610: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-0003e620: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0003e630: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
-0003e640: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0003e650: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-0003e660: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-0003e670: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0003e680: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
-0003e690: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0003e6a0: 7264 5f61 6464 310a 0a73 7461 7469 6320  rd_add1..static 
-0003e6b0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-0003e6c0: 655f 666f 7277 6172 645f 6164 6431 5f66  e_forward_add1_f
-0003e6d0: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
-0003e6e0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-0003e6f0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-0003e700: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-0003e710: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0003e720: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-0003e730: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0003e740: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0003e750: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-0003e760: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0003e770: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-0003e780: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-0003e790: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
-0003e7a0: 2873 7263 302c 2064 7374 2929 3b0a 2020  (src0, dst));.  
-0003e7b0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-0003e7c0: 6d6c 5f69 735f 7363 616c 6172 2873 7263  ml_is_scalar(src
-0003e7d0: 3129 293b 0a0a 2020 2020 6966 2028 7061  1));..    if (pa
-0003e7e0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-0003e7f0: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-0003e800: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-0003e810: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-0003e820: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-0003e830: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-0003e840: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
-0003e850: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
-0003e860: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
-0003e870: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
-0003e880: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-0003e890: 2020 3d20 6767 6d6c 5f6e 726f 7773 2873    = ggml_nrows(s
-0003e8a0: 7263 3029 3b0a 2020 2020 636f 6e73 7420  rc0);.    const 
-0003e8b0: 696e 7436 345f 7420 6e65 3020 3d20 7372  int64_t ne0 = sr
-0003e8c0: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
-0003e8d0: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-0003e8e0: 203d 2073 7263 302d 3e6e 655b 315d 3b0a   = src0->ne[1];.
-0003e8f0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0003e900: 7420 6e65 3220 3d20 7372 6330 2d3e 6e65  t ne2 = src0->ne
-0003e910: 5b32 5d3b 0a0a 2020 2020 636f 6e73 7420  [2];..    const 
-0003e920: 7369 7a65 5f74 206e 6230 3020 3d20 7372  size_t nb00 = sr
-0003e930: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
-0003e940: 6f6e 7374 2073 697a 655f 7420 6e62 3031  onst size_t nb01
-0003e950: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
-0003e960: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0003e970: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
-0003e980: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
-0003e990: 697a 655f 7420 6e62 3033 203d 2073 7263  ize_t nb03 = src
-0003e9a0: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
-0003e9b0: 6f6e 7374 2073 697a 655f 7420 6e62 3020  onst size_t nb0 
-0003e9c0: 3d20 6473 742d 3e6e 625b 305d 3b0a 2020  = dst->nb[0];.  
-0003e9d0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0003e9e0: 6231 203d 2064 7374 2d3e 6e62 5b31 5d3b  b1 = dst->nb[1];
-0003e9f0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-0003ea00: 7420 6e62 3220 3d20 6473 742d 3e6e 625b  t nb2 = dst->nb[
-0003ea10: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
-0003ea20: 7a65 5f74 206e 6233 203d 2064 7374 2d3e  ze_t nb3 = dst->
-0003ea30: 6e62 5b33 5d3b 0a0a 2020 2020 4747 4d4c  nb[3];..    GGML
-0003ea40: 5f41 5353 4552 5428 206e 6230 203d 3d20  _ASSERT( nb0 == 
-0003ea50: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-0003ea60: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0003ea70: 6e62 3030 203d 3d20 7369 7a65 6f66 2866  nb00 == sizeof(f
-0003ea80: 6c6f 6174 2929 3b0a 0a20 2020 202f 2f20  loat));..    // 
-0003ea90: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
-0003eaa0: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
-0003eab0: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
-0003eac0: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
-0003ead0: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
-0003eae0: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
-0003eaf0: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
-0003eb00: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-0003eb10: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
-0003eb20: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
-0003eb30: 2066 6f72 2028 696e 7420 6972 203d 2069   for (int ir = i
-0003eb40: 7230 3b20 6972 203c 2069 7231 3b20 2b2b  r0; ir < ir1; ++
-0003eb50: 6972 2920 7b0a 2020 2020 2020 2020 2f2f  ir) {.        //
-0003eb60: 2073 7263 3020 616e 6420 6473 7420 6172   src0 and dst ar
-0003eb70: 6520 7361 6d65 2073 6861 7065 203d 3e20  e same shape => 
-0003eb80: 7361 6d65 2069 6e64 6963 6573 0a20 2020  same indices.   
-0003eb90: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0003eba0: 3320 3d20 6972 2f28 6e65 322a 6e65 3129  3 = ir/(ne2*ne1)
-0003ebb0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-0003ebc0: 696e 7420 6932 203d 2028 6972 202d 2069  int i2 = (ir - i
-0003ebd0: 332a 6e65 322a 6e65 3129 2f6e 6531 3b0a  3*ne2*ne1)/ne1;.
-0003ebe0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0003ebf0: 7420 6931 203d 2028 6972 202d 2069 332a  t i1 = (ir - i3*
-0003ec00: 6e65 322a 6e65 3120 2d20 6932 2a6e 6531  ne2*ne1 - i2*ne1
-0003ec10: 293b 0a0a 2369 6664 6566 2047 474d 4c5f  );..#ifdef GGML_
-0003ec20: 5553 455f 4143 4345 4c45 5241 5445 0a20  USE_ACCELERATE. 
-0003ec30: 2020 2020 2020 2055 4e55 5345 4428 6767         UNUSED(gg
-0003ec40: 6d6c 5f76 6563 5f61 6464 315f 6633 3229  ml_vec_add1_f32)
-0003ec50: 3b0a 0a20 2020 2020 2020 2076 4453 505f  ;..        vDSP_
-0003ec60: 7661 6464 280a 2020 2020 2020 2020 2020  vadd(.          
-0003ec70: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-0003ec80: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
-0003ec90: 6461 7461 202b 2069 332a 6e62 3033 202b  data + i3*nb03 +
-0003eca0: 2069 322a 6e62 3032 202b 2069 312a 6e62   i2*nb02 + i1*nb
-0003ecb0: 3031 292c 2031 2c0a 2020 2020 2020 2020  01), 1,.        
-0003ecc0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-0003ecd0: 2920 2828 6368 6172 202a 2920 7372 6331  ) ((char *) src1
-0003ece0: 2d3e 6461 7461 292c 2030 2c0a 2020 2020  ->data), 0,.    
-0003ecf0: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
-0003ed00: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-0003ed10: 6473 742d 3e64 6174 6120 202b 2069 332a  dst->data  + i3*
-0003ed20: 6e62 3320 202b 2069 322a 6e62 3220 202b  nb3  + i2*nb2  +
-0003ed30: 2069 312a 6e62 3120 292c 2031 2c0a 2020   i1*nb1 ), 1,.  
-0003ed40: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0003ed50: 3029 3b0a 2365 6c73 650a 2020 2020 2020  0);.#else.      
-0003ed60: 2020 6767 6d6c 5f76 6563 5f61 6464 315f    ggml_vec_add1_
-0003ed70: 6633 3228 6e65 302c 0a20 2020 2020 2020  f32(ne0,.       
-0003ed80: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-0003ed90: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
-0003eda0: 2d3e 6461 7461 2020 2b20 6933 2a6e 6233  ->data  + i3*nb3
-0003edb0: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
-0003edc0: 2a6e 6231 2029 2c0a 2020 2020 2020 2020  *nb1 ),.        
-0003edd0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-0003ede0: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
-0003edf0: 2d3e 6461 7461 202b 2069 332a 6e62 3033  ->data + i3*nb03
-0003ee00: 202b 2069 322a 6e62 3032 202b 2069 312a   + i2*nb02 + i1*
-0003ee10: 6e62 3031 292c 0a20 2020 2020 2020 2020  nb01),.         
-0003ee20: 2020 2020 2020 2a28 666c 6f61 7420 2a29        *(float *)
-0003ee30: 2073 7263 312d 3e64 6174 6129 3b0a 2365   src1->data);.#e
-0003ee40: 6e64 6966 0a20 2020 207d 0a7d 0a0a 7374  ndif.    }.}..st
-0003ee50: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-0003ee60: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
-0003ee70: 6464 315f 6631 365f 6633 3228 0a20 2020  dd1_f16_f32(.   
-0003ee80: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0003ee90: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-0003eea0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-0003eeb0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0003eec0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0003eed0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-0003eee0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0003eef0: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-0003ef00: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0003ef10: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-0003ef20: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-0003ef30: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
-0003ef40: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-0003ef50: 6473 7429 293b 0a20 2020 2047 474d 4c5f  dst));.    GGML_
-0003ef60: 4153 5345 5254 2867 676d 6c5f 6973 5f73  ASSERT(ggml_is_s
-0003ef70: 6361 6c61 7228 7372 6331 2929 3b0a 0a20  calar(src1));.. 
-0003ef80: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-0003ef90: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0003efa0: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
-0003efb0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-0003efc0: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
-0003efd0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-0003efe0: 2020 207d 0a0a 2020 2020 2f2f 2073 6361     }..    // sca
-0003eff0: 6c61 7220 746f 2061 6464 0a20 2020 2063  lar to add.    c
-0003f000: 6f6e 7374 2066 6c6f 6174 2076 203d 202a  onst float v = *
-0003f010: 2866 6c6f 6174 202a 2920 7372 6331 2d3e  (float *) src1->
-0003f020: 6461 7461 3b0a 0a20 2020 2063 6f6e 7374  data;..    const
-0003f030: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
-0003f040: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
-0003f050: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
-0003f060: 6d73 2d3e 6e74 683b 0a0a 2020 2020 636f  ms->nth;..    co
-0003f070: 6e73 7420 696e 7420 6e72 2020 3d20 6767  nst int nr  = gg
-0003f080: 6d6c 5f6e 726f 7773 2873 7263 3029 3b0a  ml_nrows(src0);.
-0003f090: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0003f0a0: 7420 6e65 3020 3d20 7372 6330 2d3e 6e65  t ne0 = src0->ne
-0003f0b0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-0003f0c0: 6e74 3634 5f74 206e 6531 203d 2073 7263  nt64_t ne1 = src
-0003f0d0: 302d 3e6e 655b 315d 3b0a 2020 2020 636f  0->ne[1];.    co
-0003f0e0: 6e73 7420 696e 7436 345f 7420 6e65 3220  nst int64_t ne2 
-0003f0f0: 3d20 7372 6330 2d3e 6e65 5b32 5d3b 0a0a  = src0->ne[2];..
-0003f100: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0003f110: 206e 6230 3020 3d20 7372 6330 2d3e 6e62   nb00 = src0->nb
-0003f120: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
-0003f130: 697a 655f 7420 6e62 3031 203d 2073 7263  ize_t nb01 = src
-0003f140: 302d 3e6e 625b 315d 3b0a 2020 2020 636f  0->nb[1];.    co
-0003f150: 6e73 7420 7369 7a65 5f74 206e 6230 3220  nst size_t nb02 
-0003f160: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
-0003f170: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0003f180: 6e62 3033 203d 2073 7263 302d 3e6e 625b  nb03 = src0->nb[
-0003f190: 335d 3b0a 0a20 2020 2063 6f6e 7374 2073  3];..    const s
-0003f1a0: 697a 655f 7420 6e62 3020 3d20 6473 742d  ize_t nb0 = dst-
-0003f1b0: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-0003f1c0: 7420 7369 7a65 5f74 206e 6231 203d 2064  t size_t nb1 = d
-0003f1d0: 7374 2d3e 6e62 5b31 5d3b 0a20 2020 2063  st->nb[1];.    c
-0003f1e0: 6f6e 7374 2073 697a 655f 7420 6e62 3220  onst size_t nb2 
-0003f1f0: 3d20 6473 742d 3e6e 625b 325d 3b0a 2020  = dst->nb[2];.  
-0003f200: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0003f210: 6233 203d 2064 7374 2d3e 6e62 5b33 5d3b  b3 = dst->nb[3];
-0003f220: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-0003f230: 5428 7372 6330 2d3e 7479 7065 203d 3d20  T(src0->type == 
-0003f240: 4747 4d4c 5f54 5950 455f 4631 3629 3b0a  GGML_TYPE_F16);.
-0003f250: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0003f260: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-0003f270: 4d4c 5f54 5950 455f 4633 3229 3b0a 2020  ML_TYPE_F32);.  
-0003f280: 2020 4747 4d4c 5f41 5353 4552 5428 6473    GGML_ASSERT(ds
-0003f290: 742d 3e74 7970 6520 3d3d 2047 474d 4c5f  t->type == GGML_
-0003f2a0: 5459 5045 5f46 3136 293b 0a0a 2020 2020  TYPE_F16);..    
-0003f2b0: 4747 4d4c 5f41 5353 4552 5428 206e 6230  GGML_ASSERT( nb0
-0003f2c0: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
-0003f2d0: 6670 3136 5f74 2929 3b0a 2020 2020 4747  fp16_t));.    GG
-0003f2e0: 4d4c 5f41 5353 4552 5428 6e62 3030 203d  ML_ASSERT(nb00 =
-0003f2f0: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
-0003f300: 3136 5f74 2929 3b0a 0a20 2020 202f 2f20  16_t));..    // 
-0003f310: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
-0003f320: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
-0003f330: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
-0003f340: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
-0003f350: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
-0003f360: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
-0003f370: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
-0003f380: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-0003f390: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
-0003f3a0: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
-0003f3b0: 2066 6f72 2028 696e 7420 6972 203d 2069   for (int ir = i
-0003f3c0: 7230 3b20 6972 203c 2069 7231 3b20 2b2b  r0; ir < ir1; ++
-0003f3d0: 6972 2920 7b0a 2020 2020 2020 2020 2f2f  ir) {.        //
-0003f3e0: 2073 7263 3020 616e 6420 6473 7420 6172   src0 and dst ar
-0003f3f0: 6520 7361 6d65 2073 6861 7065 203d 3e20  e same shape => 
-0003f400: 7361 6d65 2069 6e64 6963 6573 0a20 2020  same indices.   
-0003f410: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0003f420: 3320 3d20 6972 2f28 6e65 322a 6e65 3129  3 = ir/(ne2*ne1)
-0003f430: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-0003f440: 696e 7420 6932 203d 2028 6972 202d 2069  int i2 = (ir - i
-0003f450: 332a 6e65 322a 6e65 3129 2f6e 6531 3b0a  3*ne2*ne1)/ne1;.
-0003f460: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0003f470: 7420 6931 203d 2028 6972 202d 2069 332a  t i1 = (ir - i3*
-0003f480: 6e65 322a 6e65 3120 2d20 6932 2a6e 6531  ne2*ne1 - i2*ne1
-0003f490: 293b 0a0a 2020 2020 2020 2020 6767 6d6c  );..        ggml
-0003f4a0: 5f66 7031 365f 7420 2a20 6473 745f 7074  _fp16_t * dst_pt
-0003f4b0: 7220 203d 2028 6767 6d6c 5f66 7031 365f  r  = (ggml_fp16_
-0003f4c0: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
-0003f4d0: 7374 2d3e 6461 7461 2020 2b20 6933 2a6e  st->data  + i3*n
-0003f4e0: 6233 2020 2b20 6932 2a6e 6232 2020 2b20  b3  + i2*nb2  + 
-0003f4f0: 6931 2a6e 6231 2029 3b0a 2020 2020 2020  i1*nb1 );.      
-0003f500: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
-0003f510: 7372 6330 5f70 7472 203d 2028 6767 6d6c  src0_ptr = (ggml
-0003f520: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
-0003f530: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-0003f540: 2b20 6933 2a6e 6230 3320 2b20 6932 2a6e  + i3*nb03 + i2*n
-0003f550: 6230 3220 2b20 6931 2a6e 6230 3129 3b0a  b02 + i1*nb01);.
-0003f560: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0003f570: 2069 203d 2030 3b20 6920 3c20 6e65 303b   i = 0; i < ne0;
-0003f580: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-0003f590: 2020 2020 6473 745f 7074 725b 695d 203d      dst_ptr[i] =
-0003f5a0: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
-0003f5b0: 3136 2847 474d 4c5f 4650 3136 5f54 4f5f  16(GGML_FP16_TO_
-0003f5c0: 4650 3332 2873 7263 305f 7074 725b 695d  FP32(src0_ptr[i]
-0003f5d0: 2920 2b20 7629 3b0a 2020 2020 2020 2020  ) + v);.        
-0003f5e0: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
-0003f5f0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-0003f600: 7574 655f 666f 7277 6172 645f 6164 6431  ute_forward_add1
-0003f610: 5f66 3136 5f66 3136 280a 2020 2020 2020  _f16_f16(.      
-0003f620: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0003f630: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0003f640: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0003f650: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0003f660: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0003f670: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-0003f680: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0003f690: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-0003f6a0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0003f6b0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0003f6c0: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-0003f6d0: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-0003f6e0: 5f73 6861 7065 2873 7263 302c 2064 7374  _shape(src0, dst
-0003f6f0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-0003f700: 4552 5428 6767 6d6c 5f69 735f 7363 616c  ERT(ggml_is_scal
-0003f710: 6172 2873 7263 3129 293b 0a0a 2020 2020  ar(src1));..    
-0003f720: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-0003f730: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-0003f740: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
-0003f750: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-0003f760: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-0003f770: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-0003f780: 7d0a 0a20 2020 202f 2f20 7363 616c 6172  }..    // scalar
-0003f790: 2074 6f20 6164 640a 2020 2020 636f 6e73   to add.    cons
-0003f7a0: 7420 666c 6f61 7420 7620 3d20 4747 4d4c  t float v = GGML
-0003f7b0: 5f46 5031 365f 544f 5f46 5033 3228 2a28  _FP16_TO_FP32(*(
-0003f7c0: 6767 6d6c 5f66 7031 365f 7420 2a29 2073  ggml_fp16_t *) s
-0003f7d0: 7263 312d 3e64 6174 6129 3b0a 0a20 2020  rc1->data);..   
-0003f7e0: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
-0003f7f0: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
-0003f800: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
-0003f810: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
-0003f820: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-0003f830: 2020 3d20 6767 6d6c 5f6e 726f 7773 2873    = ggml_nrows(s
-0003f840: 7263 3029 3b0a 2020 2020 636f 6e73 7420  rc0);.    const 
-0003f850: 696e 7436 345f 7420 6e65 3020 3d20 7372  int64_t ne0 = sr
-0003f860: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
-0003f870: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-0003f880: 203d 2073 7263 302d 3e6e 655b 315d 3b0a   = src0->ne[1];.
-0003f890: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0003f8a0: 7420 6e65 3220 3d20 7372 6330 2d3e 6e65  t ne2 = src0->ne
-0003f8b0: 5b32 5d3b 0a0a 2020 2020 636f 6e73 7420  [2];..    const 
-0003f8c0: 7369 7a65 5f74 206e 6230 3020 3d20 7372  size_t nb00 = sr
-0003f8d0: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
-0003f8e0: 6f6e 7374 2073 697a 655f 7420 6e62 3031  onst size_t nb01
-0003f8f0: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
-0003f900: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0003f910: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
-0003f920: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
-0003f930: 697a 655f 7420 6e62 3033 203d 2073 7263  ize_t nb03 = src
-0003f940: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
-0003f950: 6f6e 7374 2073 697a 655f 7420 6e62 3020  onst size_t nb0 
-0003f960: 3d20 6473 742d 3e6e 625b 305d 3b0a 2020  = dst->nb[0];.  
-0003f970: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0003f980: 6231 203d 2064 7374 2d3e 6e62 5b31 5d3b  b1 = dst->nb[1];
-0003f990: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-0003f9a0: 7420 6e62 3220 3d20 6473 742d 3e6e 625b  t nb2 = dst->nb[
-0003f9b0: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
-0003f9c0: 7a65 5f74 206e 6233 203d 2064 7374 2d3e  ze_t nb3 = dst->
-0003f9d0: 6e62 5b33 5d3b 0a0a 2020 2020 4747 4d4c  nb[3];..    GGML
-0003f9e0: 5f41 5353 4552 5428 7372 6330 2d3e 7479  _ASSERT(src0->ty
-0003f9f0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-0003fa00: 4631 3629 3b0a 2020 2020 4747 4d4c 5f41  F16);.    GGML_A
-0003fa10: 5353 4552 5428 7372 6331 2d3e 7479 7065  SSERT(src1->type
-0003fa20: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
-0003fa30: 3629 3b0a 2020 2020 4747 4d4c 5f41 5353  6);.    GGML_ASS
-0003fa40: 4552 5428 6473 742d 3e74 7970 6520 3d3d  ERT(dst->type ==
-0003fa50: 2047 474d 4c5f 5459 5045 5f46 3136 293b   GGML_TYPE_F16);
-0003fa60: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-0003fa70: 5428 206e 6230 203d 3d20 7369 7a65 6f66  T( nb0 == sizeof
-0003fa80: 2867 676d 6c5f 6670 3136 5f74 2929 3b0a  (ggml_fp16_t));.
-0003fa90: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0003faa0: 6e62 3030 203d 3d20 7369 7a65 6f66 2867  nb00 == sizeof(g
-0003fab0: 676d 6c5f 6670 3136 5f74 2929 3b0a 0a20  gml_fp16_t));.. 
-0003fac0: 2020 202f 2f20 726f 7773 2070 6572 2074     // rows per t
-0003fad0: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
-0003fae0: 696e 7420 6472 203d 2028 6e72 202b 206e  int dr = (nr + n
-0003faf0: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-0003fb00: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
-0003fb10: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
-0003fb20: 2020 2063 6f6e 7374 2069 6e74 2069 7230     const int ir0
-0003fb30: 203d 2064 722a 6974 683b 0a20 2020 2063   = dr*ith;.    c
-0003fb40: 6f6e 7374 2069 6e74 2069 7231 203d 204d  onst int ir1 = M
-0003fb50: 494e 2869 7230 202b 2064 722c 206e 7229  IN(ir0 + dr, nr)
-0003fb60: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-0003fb70: 6972 203d 2069 7230 3b20 6972 203c 2069  ir = ir0; ir < i
-0003fb80: 7231 3b20 2b2b 6972 2920 7b0a 2020 2020  r1; ++ir) {.    
-0003fb90: 2020 2020 2f2f 2073 7263 3020 616e 6420      // src0 and 
-0003fba0: 6473 7420 6172 6520 7361 6d65 2073 6861  dst are same sha
-0003fbb0: 7065 203d 3e20 7361 6d65 2069 6e64 6963  pe => same indic
-0003fbc0: 6573 0a20 2020 2020 2020 2063 6f6e 7374  es.        const
-0003fbd0: 2069 6e74 2069 3320 3d20 6972 2f28 6e65   int i3 = ir/(ne
-0003fbe0: 322a 6e65 3129 3b0a 2020 2020 2020 2020  2*ne1);.        
-0003fbf0: 636f 6e73 7420 696e 7420 6932 203d 2028  const int i2 = (
-0003fc00: 6972 202d 2069 332a 6e65 322a 6e65 3129  ir - i3*ne2*ne1)
-0003fc10: 2f6e 6531 3b0a 2020 2020 2020 2020 636f  /ne1;.        co
-0003fc20: 6e73 7420 696e 7420 6931 203d 2028 6972  nst int i1 = (ir
-0003fc30: 202d 2069 332a 6e65 322a 6e65 3120 2d20   - i3*ne2*ne1 - 
-0003fc40: 6932 2a6e 6531 293b 0a0a 2020 2020 2020  i2*ne1);..      
-0003fc50: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
-0003fc60: 6473 745f 7074 7220 203d 2028 6767 6d6c  dst_ptr  = (ggml
-0003fc70: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
-0003fc80: 7220 2a29 2064 7374 2d3e 6461 7461 2020  r *) dst->data  
-0003fc90: 2b20 6933 2a6e 6233 2020 2b20 6932 2a6e  + i3*nb3  + i2*n
-0003fca0: 6232 2020 2b20 6931 2a6e 6231 2029 3b0a  b2  + i1*nb1 );.
-0003fcb0: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
-0003fcc0: 365f 7420 2a20 7372 6330 5f70 7472 203d  6_t * src0_ptr =
-0003fcd0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-0003fce0: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-0003fcf0: 3e64 6174 6120 2b20 6933 2a6e 6230 3320  >data + i3*nb03 
-0003fd00: 2b20 6932 2a6e 6230 3220 2b20 6931 2a6e  + i2*nb02 + i1*n
-0003fd10: 6230 3129 3b0a 2020 2020 2020 2020 666f  b01);.        fo
-0003fd20: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0003fd30: 3c20 6e65 303b 2069 2b2b 2920 7b0a 2020  < ne0; i++) {.  
-0003fd40: 2020 2020 2020 2020 2020 6473 745f 7074            dst_pt
-0003fd50: 725b 695d 203d 2047 474d 4c5f 4650 3332  r[i] = GGML_FP32
-0003fd60: 5f54 4f5f 4650 3136 2847 474d 4c5f 4650  _TO_FP16(GGML_FP
-0003fd70: 3136 5f54 4f5f 4650 3332 2873 7263 305f  16_TO_FP32(src0_
-0003fd80: 7074 725b 695d 2920 2b20 7629 3b0a 2020  ptr[i]) + v);.  
-0003fd90: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
-0003fda0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-0003fdb0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0003fdc0: 645f 6164 6431 5f71 5f66 3332 280a 2020  d_add1_q_f32(.  
-0003fdd0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0003fde0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-0003fdf0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-0003fe00: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0003fe10: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0003fe20: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-0003fe30: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0003fe40: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-0003fe50: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
-0003fe60: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0003fe70: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
-0003fe80: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
-0003fe90: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
-0003fea0: 2064 7374 2929 3b0a 2020 2020 4747 4d4c   dst));.    GGML
-0003feb0: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
-0003fec0: 7363 616c 6172 2873 7263 3129 293b 0a0a  scalar(src1));..
-0003fed0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-0003fee0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-0003fef0: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-0003ff00: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0003ff10: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-0003ff20: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-0003ff30: 2020 2020 7d0a 0a20 2020 202f 2f20 7363      }..    // sc
-0003ff40: 616c 6172 2074 6f20 6164 640a 2020 2020  alar to add.    
-0003ff50: 636f 6e73 7420 666c 6f61 7420 7620 3d20  const float v = 
-0003ff60: 2a28 666c 6f61 7420 2a29 2073 7263 312d  *(float *) src1-
-0003ff70: 3e64 6174 613b 0a0a 2020 2020 636f 6e73  >data;..    cons
-0003ff80: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
-0003ff90: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
-0003ffa0: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
-0003ffb0: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
-0003ffc0: 6f6e 7374 2069 6e74 206e 7220 203d 2067  onst int nr  = g
-0003ffd0: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
-0003ffe0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-0003fff0: 5f74 206e 6530 203d 2073 7263 302d 3e6e  _t ne0 = src0->n
-00040000: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-00040010: 696e 7436 345f 7420 6e65 3120 3d20 7372  int64_t ne1 = sr
-00040020: 6330 2d3e 6e65 5b31 5d3b 0a20 2020 2063  c0->ne[1];.    c
-00040030: 6f6e 7374 2069 6e74 3634 5f74 206e 6532  onst int64_t ne2
-00040040: 203d 2073 7263 302d 3e6e 655b 325d 3b0a   = src0->ne[2];.
-00040050: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00040060: 7420 6e62 3030 203d 2073 7263 302d 3e6e  t nb00 = src0->n
-00040070: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-00040080: 7369 7a65 5f74 206e 6230 3120 3d20 7372  size_t nb01 = sr
-00040090: 6330 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c0->nb[1];.    c
-000400a0: 6f6e 7374 2073 697a 655f 7420 6e62 3032  onst size_t nb02
-000400b0: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
-000400c0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-000400d0: 206e 6230 3320 3d20 7372 6330 2d3e 6e62   nb03 = src0->nb
-000400e0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-000400f0: 7369 7a65 5f74 206e 6230 203d 2064 7374  size_t nb0 = dst
-00040100: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-00040110: 7374 2073 697a 655f 7420 6e62 3120 3d20  st size_t nb1 = 
-00040120: 6473 742d 3e6e 625b 315d 3b0a 2020 2020  dst->nb[1];.    
-00040130: 636f 6e73 7420 7369 7a65 5f74 206e 6232  const size_t nb2
-00040140: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
-00040150: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00040160: 6e62 3320 3d20 6473 742d 3e6e 625b 335d  nb3 = dst->nb[3]
-00040170: 3b0a 0a20 2020 2063 6f6e 7374 2065 6e75  ;..    const enu
-00040180: 6d20 6767 6d6c 5f74 7970 6520 7479 7065  m ggml_type type
-00040190: 203d 2073 7263 302d 3e74 7970 653b 0a20   = src0->type;. 
-000401a0: 2020 2064 6571 7561 6e74 697a 655f 726f     dequantize_ro
-000401b0: 775f 715f 7420 636f 6e73 7420 6465 7175  w_q_t const dequ
-000401c0: 616e 7469 7a65 5f72 6f77 5f71 203d 2071  antize_row_q = q
-000401d0: 7561 6e74 697a 655f 666e 735b 7479 7065  uantize_fns[type
-000401e0: 5d2e 6465 7175 616e 7469 7a65 5f72 6f77  ].dequantize_row
-000401f0: 5f71 3b0a 2020 2020 7175 616e 7469 7a65  _q;.    quantize
-00040200: 5f72 6f77 5f71 5f74 2063 6f6e 7374 2071  _row_q_t const q
-00040210: 7561 6e74 697a 655f 726f 775f 7120 3d20  uantize_row_q = 
-00040220: 7175 616e 7469 7a65 5f66 6e73 5b74 7970  quantize_fns[typ
-00040230: 655d 2e71 7561 6e74 697a 655f 726f 775f  e].quantize_row_
-00040240: 713b 0a0a 2020 2020 2f2f 2077 6520 646f  q;..    // we do
-00040250: 6e27 7420 7375 7070 6f72 7420 7065 726d  n't support perm
-00040260: 7574 6564 2073 7263 300a 2020 2020 4747  uted src0.    GG
-00040270: 4d4c 5f41 5353 4552 5428 6e62 3030 203d  ML_ASSERT(nb00 =
-00040280: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
-00040290: 5b74 7970 655d 293b 0a0a 2020 2020 2f2f  [type]);..    //
-000402a0: 2064 7374 2063 616e 6e6f 7420 6265 2074   dst cannot be t
-000402b0: 7261 6e73 706f 7365 6420 6f72 2070 6572  ransposed or per
-000402c0: 6d75 7465 640a 2020 2020 4747 4d4c 5f41  muted.    GGML_A
-000402d0: 5353 4552 5428 6e62 3020 3c3d 206e 6231  SSERT(nb0 <= nb1
-000402e0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000402f0: 5254 286e 6231 203c 3d20 6e62 3229 3b0a  RT(nb1 <= nb2);.
-00040300: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00040310: 6e62 3220 3c3d 206e 6233 293b 0a0a 2020  nb2 <= nb3);..  
-00040320: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00040330: 6d6c 5f69 735f 7175 616e 7469 7a65 6428  ml_is_quantized(
-00040340: 7372 6330 2d3e 7479 7065 2929 3b0a 2020  src0->type));.  
-00040350: 2020 4747 4d4c 5f41 5353 4552 5428 6473    GGML_ASSERT(ds
-00040360: 742d 3e74 7970 6520 3d3d 2073 7263 302d  t->type == src0-
-00040370: 3e74 7970 6529 3b0a 2020 2020 4747 4d4c  >type);.    GGML
-00040380: 5f41 5353 4552 5428 7372 6331 2d3e 7479  _ASSERT(src1->ty
-00040390: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-000403a0: 4633 3229 3b0a 0a20 2020 202f 2f20 726f  F32);..    // ro
-000403b0: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
-000403c0: 2020 636f 6e73 7420 696e 7420 6472 203d    const int dr =
-000403d0: 2028 6e72 202b 206e 7468 202d 2031 292f   (nr + nth - 1)/
-000403e0: 6e74 683b 0a0a 2020 2020 2f2f 2072 6f77  nth;..    // row
-000403f0: 2072 616e 6765 2066 6f72 2074 6869 7320   range for this 
-00040400: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-00040410: 2069 6e74 2069 7230 203d 2064 722a 6974   int ir0 = dr*it
-00040420: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-00040430: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
-00040440: 2064 722c 206e 7229 3b0a 0a20 2020 2066   dr, nr);..    f
-00040450: 6c6f 6174 202a 2077 6461 7461 203d 2028  loat * wdata = (
-00040460: 666c 6f61 7420 2a29 2070 6172 616d 732d  float *) params-
-00040470: 3e77 6461 7461 202b 2028 6e65 3020 2b20  >wdata + (ne0 + 
-00040480: 4341 4348 455f 4c49 4e45 5f53 495a 455f  CACHE_LINE_SIZE_
-00040490: 4633 3229 202a 2069 7468 3b0a 0a20 2020  F32) * ith;..   
-000404a0: 2066 6f72 2028 696e 7420 6972 203d 2069   for (int ir = i
-000404b0: 7230 3b20 6972 203c 2069 7231 3b20 2b2b  r0; ir < ir1; ++
-000404c0: 6972 2920 7b0a 2020 2020 2020 2020 2f2f  ir) {.        //
-000404d0: 2073 7263 3020 616e 6420 6473 7420 6172   src0 and dst ar
-000404e0: 6520 7361 6d65 2073 6861 7065 203d 3e20  e same shape => 
-000404f0: 7361 6d65 2069 6e64 6963 6573 0a20 2020  same indices.   
-00040500: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00040510: 3320 3d20 6972 2f28 6e65 322a 6e65 3129  3 = ir/(ne2*ne1)
-00040520: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-00040530: 696e 7420 6932 203d 2028 6972 202d 2069  int i2 = (ir - i
-00040540: 332a 6e65 322a 6e65 3129 2f6e 6531 3b0a  3*ne2*ne1)/ne1;.
-00040550: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-00040560: 7420 6931 203d 2028 6972 202d 2069 332a  t i1 = (ir - i3*
-00040570: 6e65 322a 6e65 3120 2d20 6932 2a6e 6531  ne2*ne1 - i2*ne1
-00040580: 293b 0a0a 2020 2020 2020 2020 766f 6964  );..        void
-00040590: 2020 2a20 7372 6330 5f72 6f77 203d 2028    * src0_row = (
-000405a0: 766f 6964 202a 2920 2828 6368 6172 202a  void *) ((char *
-000405b0: 2920 7372 6330 2d3e 6461 7461 202b 2028  ) src0->data + (
-000405c0: 6931 2a6e 6230 3120 2b20 6932 2a6e 6230  i1*nb01 + i2*nb0
-000405d0: 3220 2b20 6933 2a6e 6230 3329 293b 0a20  2 + i3*nb03));. 
-000405e0: 2020 2020 2020 2076 6f69 6420 202a 2064         void  * d
-000405f0: 7374 5f72 6f77 2020 3d20 2876 6f69 6420  st_row  = (void 
-00040600: 2a29 2028 2863 6861 7220 2a29 2020 6473  *) ((char *)  ds
-00040610: 742d 3e64 6174 6120 2b20 2869 312a 6e62  t->data + (i1*nb
-00040620: 3120 202b 2069 322a 6e62 3220 202b 2069  1  + i2*nb2  + i
-00040630: 332a 6e62 3020 2929 3b0a 0a20 2020 2020  3*nb0 ));..     
-00040640: 2020 2061 7373 6572 7428 6e65 3020 2520     assert(ne0 % 
-00040650: 3332 203d 3d20 3029 3b0a 0a20 2020 2020  32 == 0);..     
-00040660: 2020 202f 2f20 756e 7175 616e 7469 7a65     // unquantize
-00040670: 2072 6f77 2066 726f 6d20 7372 6330 2074   row from src0 t
-00040680: 6f20 7465 6d70 2062 7566 6665 720a 2020  o temp buffer.  
-00040690: 2020 2020 2020 6465 7175 616e 7469 7a65        dequantize
-000406a0: 5f72 6f77 5f71 2873 7263 305f 726f 772c  _row_q(src0_row,
-000406b0: 2077 6461 7461 2c20 6e65 3029 3b0a 2020   wdata, ne0);.  
-000406c0: 2020 2020 2020 2f2f 2061 6464 2073 7263        // add src
-000406d0: 310a 2020 2020 2020 2020 6767 6d6c 5f76  1.        ggml_v
-000406e0: 6563 5f61 6363 315f 6633 3228 6e65 302c  ec_acc1_f32(ne0,
-000406f0: 2077 6461 7461 2c20 7629 3b0a 2020 2020   wdata, v);.    
-00040700: 2020 2020 2f2f 2071 7561 6e74 697a 6520      // quantize 
-00040710: 726f 7720 746f 2064 7374 0a20 2020 2020  row to dst.     
-00040720: 2020 2071 7561 6e74 697a 655f 726f 775f     quantize_row_
-00040730: 7128 7764 6174 612c 2064 7374 5f72 6f77  q(wdata, dst_row
-00040740: 2c20 6e65 3029 3b0a 2020 2020 7d0a 7d0a  , ne0);.    }.}.
-00040750: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00040760: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00040770: 645f 6164 6431 280a 2020 2020 2020 2020  d_add1(.        
-00040780: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00040790: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-000407a0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-000407b0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000407c0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-000407d0: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-000407e0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000407f0: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-00040800: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00040810: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00040820: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-00040830: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-00040840: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00040850: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-00040860: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00040870: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00040880: 655f 666f 7277 6172 645f 6164 6431 5f66  e_forward_add1_f
-00040890: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-000408a0: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-000408b0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000408c0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000408d0: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-000408e0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000408f0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00040900: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-00040910: 4d4c 5f54 5950 455f 4631 3629 207b 0a20  ML_TYPE_F16) {. 
-00040920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040930: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00040940: 666f 7277 6172 645f 6164 6431 5f66 3136  forward_add1_f16
-00040950: 5f66 3136 2870 6172 616d 732c 2073 7263  _f16(params, src
-00040960: 302c 2073 7263 312c 2064 7374 293b 0a20  0, src1, dst);. 
-00040970: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00040980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040990: 2065 6c73 6520 6966 2028 7372 6331 2d3e   else if (src1->
-000409a0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-000409b0: 455f 4633 3229 207b 0a20 2020 2020 2020  E_F32) {.       
-000409c0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-000409d0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000409e0: 645f 6164 6431 5f66 3136 5f66 3332 2870  d_add1_f16_f32(p
-000409f0: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
-00040a00: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
-00040a10: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00040a20: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
-00040a30: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00040a40: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00040a50: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-00040a60: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00040a70: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00040a80: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00040a90: 4d4c 5f54 5950 455f 5134 5f30 3a0a 2020  ML_TYPE_Q4_0:.  
-00040aa0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00040ab0: 5459 5045 5f51 345f 313a 0a20 2020 2020  TYPE_Q4_1:.     
-00040ac0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00040ad0: 455f 5135 5f30 3a0a 2020 2020 2020 2020  E_Q5_0:.        
-00040ae0: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00040af0: 355f 313a 0a20 2020 2020 2020 2063 6173  5_1:.        cas
-00040b00: 6520 4747 4d4c 5f54 5950 455f 5138 5f30  e GGML_TYPE_Q8_0
-00040b10: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00040b20: 474d 4c5f 5459 5045 5f51 385f 313a 0a20  GML_TYPE_Q8_1:. 
-00040b30: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00040b40: 5f54 5950 455f 5132 5f4b 3a0a 2020 2020  _TYPE_Q2_K:.    
-00040b50: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00040b60: 5045 5f51 335f 4b3a 0a20 2020 2020 2020  PE_Q3_K:.       
-00040b70: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00040b80: 5134 5f4b 3a0a 2020 2020 2020 2020 6361  Q4_K:.        ca
-00040b90: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
-00040ba0: 4b3a 0a20 2020 2020 2020 2063 6173 6520  K:.        case 
-00040bb0: 4747 4d4c 5f54 5950 455f 5136 5f4b 3a0a  GGML_TYPE_Q6_K:.
-00040bc0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00040bd0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00040be0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00040bf0: 7264 5f61 6464 315f 715f 6633 3228 7061  rd_add1_q_f32(pa
-00040c00: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
-00040c10: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-00040c20: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00040c30: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
-00040c40: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00040c50: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00040c60: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-00040c70: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00040c80: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 0a2f  eak;.    }.}.../
-00040c90: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00040ca0: 6f72 7761 7264 5f61 6363 0a0a 7374 6174  orward_acc..stat
-00040cb0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00040cc0: 7075 7465 5f66 6f72 7761 7264 5f61 6363  pute_forward_acc
-00040cd0: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
-00040ce0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00040cf0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00040d00: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00040d10: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00040d20: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00040d30: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00040d40: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00040d50: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
-00040d60: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00040d70: 6767 6d6c 5f74 656e 736f 7220 2a20 6f70  ggml_tensor * op
-00040d80: 7430 2c0a 2020 2020 2020 2020 7374 7275  t0,.        stru
-00040d90: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00040da0: 2064 7374 2920 7b0a 2020 2020 4747 4d4c   dst) {.    GGML
-00040db0: 5f41 5353 4552 5428 6767 6d6c 5f61 7265  _ASSERT(ggml_are
-00040dc0: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
-00040dd0: 2c20 6473 7429 293b 0a20 2020 2047 474d  , dst));.    GGM
-00040de0: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
-00040df0: 5f63 6f6e 7469 6775 6f75 7328 6473 7429  _contiguous(dst)
-00040e00: 2026 2620 6767 6d6c 5f69 735f 636f 6e74   && ggml_is_cont
-00040e10: 6967 756f 7573 2873 7263 3029 293b 0a0a  iguous(src0));..
-00040e20: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00040e30: 6f70 7430 2d3e 7479 7065 203d 3d20 4747  opt0->type == GG
-00040e40: 4d4c 5f54 5950 455f 4933 3229 3b0a 2020  ML_TYPE_I32);.  
-00040e50: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00040e60: 6d6c 5f6e 656c 656d 656e 7473 286f 7074  ml_nelements(opt
-00040e70: 3029 203d 3d20 3529 3b0a 0a20 2020 202f  0) == 5);..    /
-00040e80: 2f20 7669 6577 2073 7263 3020 616e 6420  / view src0 and 
-00040e90: 6473 7420 7769 7468 2074 6865 7365 2073  dst with these s
-00040ea0: 7472 6964 6573 2061 6e64 2064 6174 6120  trides and data 
-00040eb0: 6f66 6673 6574 2069 6e62 7974 6573 2064  offset inbytes d
-00040ec0: 7572 696e 6720 6163 630a 2020 2020 2f2f  uring acc.    //
-00040ed0: 206e 6230 2069 7320 696d 706c 6963 6974   nb0 is implicit
-00040ee0: 656c 7920 656c 656d 656e 745f 7369 7a65  ely element_size
-00040ef0: 2062 6563 6175 7365 2073 7263 3020 616e   because src0 an
-00040f00: 6420 6473 7420 6172 6520 636f 6e74 6967  d dst are contig
-00040f10: 756f 7573 0a20 2020 2073 697a 655f 7420  uous.    size_t 
-00040f20: 6e62 3120 2020 2020 3d20 2828 696e 7433  nb1     = ((int3
-00040f30: 325f 7420 2a29 206f 7074 302d 3e64 6174  2_t *) opt0->dat
-00040f40: 6129 5b30 5d3b 0a20 2020 2073 697a 655f  a)[0];.    size_
-00040f50: 7420 6e62 3220 2020 2020 3d20 2828 696e  t nb2     = ((in
-00040f60: 7433 325f 7420 2a29 206f 7074 302d 3e64  t32_t *) opt0->d
-00040f70: 6174 6129 5b31 5d3b 0a20 2020 2073 697a  ata)[1];.    siz
-00040f80: 655f 7420 6e62 3320 2020 2020 3d20 2828  e_t nb3     = ((
-00040f90: 696e 7433 325f 7420 2a29 206f 7074 302d  int32_t *) opt0-
-00040fa0: 3e64 6174 6129 5b32 5d3b 0a20 2020 2073  >data)[2];.    s
-00040fb0: 697a 655f 7420 6f66 6673 6574 2020 3d20  ize_t offset  = 
-00040fc0: 2828 696e 7433 325f 7420 2a29 206f 7074  ((int32_t *) opt
-00040fd0: 302d 3e64 6174 6129 5b33 5d3b 0a20 2020  0->data)[3];.   
-00040fe0: 2062 6f6f 6c20 2020 696e 706c 6163 6520   bool   inplace 
-00040ff0: 3d20 2862 6f6f 6c29 2028 2869 6e74 3332  = (bool) ((int32
-00041000: 5f74 202a 2920 6f70 7430 2d3e 6461 7461  _t *) opt0->data
-00041010: 295b 345d 3b0a 0a20 2020 2069 6620 2821  )[4];..    if (!
-00041020: 696e 706c 6163 6520 2626 2028 7061 7261  inplace && (para
-00041030: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-00041040: 5f54 4153 4b5f 494e 4954 2929 207b 0a20  _TASK_INIT)) {. 
-00041050: 2020 2020 2020 202f 2f20 6d65 6d63 7079         // memcpy
-00041060: 206e 6565 6473 2074 6f20 6265 2073 796e   needs to be syn
-00041070: 6368 726f 6e69 7a65 6420 6163 726f 7373  chronized across
-00041080: 2074 6872 6561 6473 2074 6f20 6176 6f69   threads to avoi
-00041090: 6420 7261 6365 2063 6f6e 6469 7469 6f6e  d race condition
-000410a0: 732e 0a20 2020 2020 2020 202f 2f20 3d3e  s..        // =>
-000410b0: 2064 6f20 6974 2069 6e20 494e 4954 2070   do it in INIT p
-000410c0: 6861 7365 0a20 2020 2020 2020 206d 656d  hase.        mem
-000410d0: 6370 7928 0a20 2020 2020 2020 2020 2020  cpy(.           
-000410e0: 2028 2863 6861 7220 2a29 2020 6473 742d   ((char *)  dst-
-000410f0: 3e64 6174 6129 2c0a 2020 2020 2020 2020  >data),.        
-00041100: 2020 2020 2828 6368 6172 202a 2920 7372      ((char *) sr
-00041110: 6330 2d3e 6461 7461 292c 0a20 2020 2020  c0->data),.     
-00041120: 2020 2020 2020 2067 676d 6c5f 6e62 7974         ggml_nbyt
-00041130: 6573 2864 7374 2929 3b0a 2020 2020 7d0a  es(dst));.    }.
-00041140: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00041150: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00041160: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
-00041170: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00041180: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-00041190: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-000411a0: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
-000411b0: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
-000411c0: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
-000411d0: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
-000411e0: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
-000411f0: 6f6e 7374 2069 6e74 206e 7220 3d20 6767  onst int nr = gg
-00041200: 6d6c 5f6e 726f 7773 2873 7263 3129 3b0a  ml_nrows(src1);.
-00041210: 2020 2020 636f 6e73 7420 696e 7420 6e63      const int nc
-00041220: 203d 2073 7263 312d 3e6e 655b 305d 3b0a   = src1->ne[0];.
-00041230: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00041240: 5f74 206e 6531 3020 3d20 7372 6331 2d3e  _t ne10 = src1->
-00041250: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-00041260: 2069 6e74 3634 5f74 206e 6531 3120 3d20   int64_t ne11 = 
-00041270: 7372 6331 2d3e 6e65 5b31 5d3b 0a20 2020  src1->ne[1];.   
-00041280: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00041290: 6531 3220 3d20 7372 6331 2d3e 6e65 5b32  e12 = src1->ne[2
-000412a0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-000412b0: 3634 5f74 206e 6531 3320 3d20 7372 6331  64_t ne13 = src1
-000412c0: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
-000412d0: 6e73 7420 7369 7a65 5f74 206e 6231 3020  nst size_t nb10 
-000412e0: 3d20 7372 6331 2d3e 6e62 5b30 5d3b 0a20  = src1->nb[0];. 
-000412f0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00041300: 6e62 3131 203d 2073 7263 312d 3e6e 625b  nb11 = src1->nb[
-00041310: 315d 3b0a 2020 2020 636f 6e73 7420 7369  1];.    const si
-00041320: 7a65 5f74 206e 6231 3220 3d20 7372 6331  ze_t nb12 = src1
-00041330: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-00041340: 7374 2073 697a 655f 7420 6e62 3133 203d  st size_t nb13 =
-00041350: 2073 7263 312d 3e6e 625b 335d 3b0a 0a20   src1->nb[3];.. 
-00041360: 2020 202f 2f20 7372 6330 2061 6e64 2064     // src0 and d
-00041370: 7374 2061 7320 7669 6577 6564 2064 7572  st as viewed dur
-00041380: 696e 6720 6163 630a 2020 2020 636f 6e73  ing acc.    cons
-00041390: 7420 7369 7a65 5f74 206e 6230 203d 2067  t size_t nb0 = g
-000413a0: 676d 6c5f 656c 656d 656e 745f 7369 7a65  gml_element_size
-000413b0: 2873 7263 3029 3b0a 0a20 2020 2063 6f6e  (src0);..    con
-000413c0: 7374 2073 697a 655f 7420 6e62 3030 203d  st size_t nb00 =
-000413d0: 206e 6230 3b0a 2020 2020 636f 6e73 7420   nb0;.    const 
-000413e0: 7369 7a65 5f74 206e 6230 3120 3d20 6e62  size_t nb01 = nb
-000413f0: 313b 0a20 2020 2063 6f6e 7374 2073 697a  1;.    const siz
-00041400: 655f 7420 6e62 3032 203d 206e 6232 3b0a  e_t nb02 = nb2;.
-00041410: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00041420: 206e 6230 3320 3d20 6e62 333b 0a0a 2020   nb03 = nb3;..  
-00041430: 2020 4747 4d4c 5f41 5353 4552 5428 6f66    GGML_ASSERT(of
-00041440: 6673 6574 202b 2028 6e65 3130 203d 3d20  fset + (ne10 == 
-00041450: 3020 3f20 3020 3a20 6e65 3130 2d31 292a  0 ? 0 : ne10-1)*
-00041460: 6e62 3020 202b 2028 6e65 3131 203d 3d20  nb0  + (ne11 == 
-00041470: 3020 3f20 3020 3a20 6e65 3131 2d31 292a  0 ? 0 : ne11-1)*
-00041480: 6e62 3120 202b 2028 6e65 3132 203d 3d20  nb1  + (ne12 == 
-00041490: 3020 3f20 3020 3a20 6e65 3132 2d31 292a  0 ? 0 : ne12-1)*
-000414a0: 6e62 3220 202b 2028 6e65 3133 203d 3d20  nb2  + (ne13 == 
-000414b0: 3020 3f20 3020 3a20 6e65 3133 2d31 292a  0 ? 0 : ne13-1)*
-000414c0: 6e62 3320 203c 2067 676d 6c5f 6e62 7974  nb3  < ggml_nbyt
-000414d0: 6573 2864 7374 2929 3b0a 2020 2020 4747  es(dst));.    GG
-000414e0: 4d4c 5f41 5353 4552 5428 6f66 6673 6574  ML_ASSERT(offset
-000414f0: 202b 2028 6e65 3130 203d 3d20 3020 3f20   + (ne10 == 0 ? 
-00041500: 3020 3a20 6e65 3130 2d31 292a 6e62 3030  0 : ne10-1)*nb00
-00041510: 202b 2028 6e65 3131 203d 3d20 3020 3f20   + (ne11 == 0 ? 
-00041520: 3020 3a20 6e65 3131 2d31 292a 6e62 3031  0 : ne11-1)*nb01
-00041530: 202b 2028 6e65 3132 203d 3d20 3020 3f20   + (ne12 == 0 ? 
-00041540: 3020 3a20 6e65 3132 2d31 292a 6e62 3032  0 : ne12-1)*nb02
-00041550: 202b 2028 6e65 3133 203d 3d20 3020 3f20   + (ne13 == 0 ? 
-00041560: 3020 3a20 6e65 3133 2d31 292a 6e62 3033  0 : ne13-1)*nb03
-00041570: 203c 2067 676d 6c5f 6e62 7974 6573 2873   < ggml_nbytes(s
-00041580: 7263 3029 293b 0a0a 2020 2020 4747 4d4c  rc0));..    GGML
-00041590: 5f41 5353 4552 5428 6e62 3130 203d 3d20  _ASSERT(nb10 == 
-000415a0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-000415b0: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
-000415c0: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-000415d0: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
-000415e0: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
-000415f0: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
-00041600: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
-00041610: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-00041620: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
-00041630: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
-00041640: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
-00041650: 7229 3b0a 0a20 2020 2066 6f72 2028 696e  r);..    for (in
-00041660: 7420 6972 203d 2069 7230 3b20 6972 203c  t ir = ir0; ir <
-00041670: 2069 7231 3b20 2b2b 6972 2920 7b0a 2020   ir1; ++ir) {.  
-00041680: 2020 2020 2020 2f2f 2073 7263 3020 616e        // src0 an
-00041690: 6420 6473 7420 6172 6520 7669 6577 6564  d dst are viewed
-000416a0: 2077 6974 6820 7368 6170 6520 6f66 2073   with shape of s
-000416b0: 7263 3120 616e 6420 6f66 6673 6574 0a20  rc1 and offset. 
-000416c0: 2020 2020 2020 202f 2f20 3d3e 2073 616d         // => sam
-000416d0: 6520 696e 6469 6365 730a 2020 2020 2020  e indices.      
-000416e0: 2020 636f 6e73 7420 696e 7420 6933 203d    const int i3 =
-000416f0: 2069 722f 286e 6531 322a 6e65 3131 293b   ir/(ne12*ne11);
-00041700: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-00041710: 6e74 2069 3220 3d20 2869 7220 2d20 6933  nt i2 = (ir - i3
-00041720: 2a6e 6531 322a 6e65 3131 292f 6e65 3131  *ne12*ne11)/ne11
-00041730: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-00041740: 696e 7420 6931 203d 2028 6972 202d 2069  int i1 = (ir - i
-00041750: 332a 6e65 3132 2a6e 6531 3120 2d20 6932  3*ne12*ne11 - i2
-00041760: 2a6e 6531 3129 3b0a 0a23 6966 6465 6620  *ne11);..#ifdef 
-00041770: 4747 4d4c 5f55 5345 5f41 4343 454c 4552  GGML_USE_ACCELER
-00041780: 4154 450a 2020 2020 2020 2020 7644 5350  ATE.        vDSP
-00041790: 5f76 6164 6428 0a20 2020 2020 2020 2020  _vadd(.         
-000417a0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-000417b0: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-000417c0: 3e64 6174 6120 2b20 6933 2a6e 6230 3320  >data + i3*nb03 
-000417d0: 2b20 6932 2a6e 6230 3220 2b20 6931 2a6e  + i2*nb02 + i1*n
-000417e0: 6230 3120 2b20 6f66 6673 6574 292c 2031  b01 + offset), 1
-000417f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00041800: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-00041810: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
-00041820: 202b 2069 332a 6e62 3133 202b 2069 322a   + i3*nb13 + i2*
-00041830: 6e62 3132 202b 2069 312a 6e62 3131 292c  nb12 + i1*nb11),
-00041840: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
-00041850: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00041860: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
-00041870: 6120 202b 2069 332a 6e62 3320 202b 2069  a  + i3*nb3  + i
-00041880: 322a 6e62 3220 202b 2069 312a 6e62 3120  2*nb2  + i1*nb1 
-00041890: 202b 206f 6666 7365 7429 2c20 312c 206e   + offset), 1, n
-000418a0: 6329 3b0a 2365 6c73 650a 2020 2020 2020  c);.#else.      
-000418b0: 2020 6767 6d6c 5f76 6563 5f61 6464 5f66    ggml_vec_add_f
-000418c0: 3332 286e 632c 0a20 2020 2020 2020 2020  32(nc,.         
-000418d0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-000418e0: 2028 2863 6861 7220 2a29 2020 6473 742d   ((char *)  dst-
-000418f0: 3e64 6174 6120 2b20 6933 2a6e 6233 2020  >data + i3*nb3  
-00041900: 2b20 6932 2a6e 6232 2020 2b20 6931 2a6e  + i2*nb2  + i1*n
-00041910: 6231 2020 2b20 6f66 6673 6574 292c 0a20  b1  + offset),. 
-00041920: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00041930: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00041940: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00041950: 6933 2a6e 6230 3320 2b20 6932 2a6e 6230  i3*nb03 + i2*nb0
-00041960: 3220 2b20 6931 2a6e 6230 3120 2b20 6f66  2 + i1*nb01 + of
-00041970: 6673 6574 292c 0a20 2020 2020 2020 2020  fset),.         
-00041980: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-00041990: 2028 2863 6861 7220 2a29 2073 7263 312d   ((char *) src1-
-000419a0: 3e64 6174 6120 2b20 6933 2a6e 6231 3320  >data + i3*nb13 
-000419b0: 2b20 6932 2a6e 6231 3220 2b20 6931 2a6e  + i2*nb12 + i1*n
-000419c0: 6231 3129 293b 0a23 656e 6469 660a 2020  b11));.#endif.  
-000419d0: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-000419e0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-000419f0: 666f 7277 6172 645f 6163 6328 0a20 2020  forward_acc(.   
-00041a00: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00041a10: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-00041a20: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00041a30: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00041a40: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00041a50: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00041a60: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00041a70: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-00041a80: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00041a90: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00041aa0: 6f72 202a 206f 7074 302c 0a20 2020 2020  or * opt0,.     
-00041ab0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00041ac0: 656e 736f 7220 2a20 6473 7429 207b 0a0a  ensor * dst) {..
-00041ad0: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
-00041ae0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-00041af0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00041b00: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-00041b10: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00041b20: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00041b30: 5f66 6f72 7761 7264 5f61 6363 5f66 3332  _forward_acc_f32
-00041b40: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
-00041b50: 7263 312c 206f 7074 302c 2064 7374 293b  rc1, opt0, dst);
-00041b60: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00041b70: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00041b80: 7365 2047 474d 4c5f 5459 5045 5f46 3136  se GGML_TYPE_F16
-00041b90: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00041ba0: 474d 4c5f 5459 5045 5f51 345f 303a 0a20  GML_TYPE_Q4_0:. 
-00041bb0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00041bc0: 5f54 5950 455f 5134 5f31 3a0a 2020 2020  _TYPE_Q4_1:.    
-00041bd0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00041be0: 5045 5f51 355f 303a 0a20 2020 2020 2020  PE_Q5_0:.       
-00041bf0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00041c00: 5135 5f31 3a0a 2020 2020 2020 2020 6361  Q5_1:.        ca
-00041c10: 7365 2047 474d 4c5f 5459 5045 5f51 385f  se GGML_TYPE_Q8_
-00041c20: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
-00041c30: 4747 4d4c 5f54 5950 455f 5138 5f31 3a0a  GGML_TYPE_Q8_1:.
-00041c40: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00041c50: 4c5f 5459 5045 5f51 325f 4b3a 0a20 2020  L_TYPE_Q2_K:.   
-00041c60: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00041c70: 5950 455f 5133 5f4b 3a0a 2020 2020 2020  YPE_Q3_K:.      
-00041c80: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00041c90: 5f51 345f 4b3a 0a20 2020 2020 2020 2063  _Q4_K:.        c
-00041ca0: 6173 6520 4747 4d4c 5f54 5950 455f 5135  ase GGML_TYPE_Q5
-00041cb0: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
-00041cc0: 2047 474d 4c5f 5459 5045 5f51 365f 4b3a   GGML_TYPE_Q6_K:
-00041cd0: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
-00041ce0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00041cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041d00: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-00041d10: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00041d20: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
-00041d30: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-00041d40: 655f 666f 7277 6172 645f 7375 620a 0a73  e_forward_sub..s
-00041d50: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00041d60: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00041d70: 7375 625f 6633 3228 0a20 2020 2020 2020  sub_f32(.       
-00041d80: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00041d90: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00041da0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00041db0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00041dc0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00041dd0: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
-00041de0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00041df0: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
-00041e00: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00041e10: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-00041e20: 7b0a 2020 2020 6173 7365 7274 2870 6172  {.    assert(par
-00041e30: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
-00041e40: 2020 2020 6173 7365 7274 2867 676d 6c5f      assert(ggml_
-00041e50: 6172 655f 7361 6d65 5f73 6861 7065 2873  are_same_shape(s
-00041e60: 7263 302c 2073 7263 3129 2026 2620 6767  rc0, src1) && gg
-00041e70: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-00041e80: 6528 7372 6330 2c20 6473 7429 293b 0a0a  e(src0, dst));..
-00041e90: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00041ea0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00041eb0: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-00041ec0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00041ed0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-00041ee0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00041ef0: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
-00041f00: 2069 6e74 206e 7220 203d 2067 676d 6c5f   int nr  = ggml_
-00041f10: 6e72 6f77 7328 7372 6330 293b 0a20 2020  nrows(src0);.   
-00041f20: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00041f30: 6530 203d 2073 7263 302d 3e6e 655b 305d  e0 = src0->ne[0]
-00041f40: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00041f50: 345f 7420 6e65 3120 3d20 7372 6330 2d3e  4_t ne1 = src0->
-00041f60: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
-00041f70: 2069 6e74 3634 5f74 206e 6532 203d 2073   int64_t ne2 = s
-00041f80: 7263 302d 3e6e 655b 325d 3b0a 0a20 2020  rc0->ne[2];..   
-00041f90: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-00041fa0: 3030 203d 2073 7263 302d 3e6e 625b 305d  00 = src0->nb[0]
-00041fb0: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00041fc0: 5f74 206e 6230 3120 3d20 7372 6330 2d3e  _t nb01 = src0->
-00041fd0: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-00041fe0: 2073 697a 655f 7420 6e62 3032 203d 2073   size_t nb02 = s
-00041ff0: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
-00042000: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
-00042010: 3320 3d20 7372 6330 2d3e 6e62 5b33 5d3b  3 = src0->nb[3];
-00042020: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
-00042030: 5f74 206e 6231 3020 3d20 7372 6331 2d3e  _t nb10 = src1->
-00042040: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-00042050: 2073 697a 655f 7420 6e62 3131 203d 2073   size_t nb11 = s
-00042060: 7263 312d 3e6e 625b 315d 3b0a 2020 2020  rc1->nb[1];.    
-00042070: 636f 6e73 7420 7369 7a65 5f74 206e 6231  const size_t nb1
-00042080: 3220 3d20 7372 6331 2d3e 6e62 5b32 5d3b  2 = src1->nb[2];
-00042090: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-000420a0: 7420 6e62 3133 203d 2073 7263 312d 3e6e  t nb13 = src1->n
-000420b0: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
-000420c0: 2073 697a 655f 7420 6e62 3020 3d20 6473   size_t nb0 = ds
-000420d0: 742d 3e6e 625b 305d 3b0a 2020 2020 636f  t->nb[0];.    co
-000420e0: 6e73 7420 7369 7a65 5f74 206e 6231 203d  nst size_t nb1 =
-000420f0: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
-00042100: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-00042110: 3220 3d20 6473 742d 3e6e 625b 325d 3b0a  2 = dst->nb[2];.
-00042120: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00042130: 206e 6233 203d 2064 7374 2d3e 6e62 5b33   nb3 = dst->nb[3
-00042140: 5d3b 0a0a 2020 2020 4747 4d4c 5f41 5353  ];..    GGML_ASS
-00042150: 4552 5428 206e 6230 203d 3d20 7369 7a65  ERT( nb0 == size
-00042160: 6f66 2866 6c6f 6174 2929 3b0a 2020 2020  of(float));.    
-00042170: 4747 4d4c 5f41 5353 4552 5428 6e62 3030  GGML_ASSERT(nb00
-00042180: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-00042190: 2929 3b0a 0a20 2020 2069 6620 286e 6231  ));..    if (nb1
-000421a0: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-000421b0: 7429 2920 7b0a 2020 2020 2020 2020 666f  t)) {.        fo
-000421c0: 7220 2869 6e74 2069 7220 3d20 303b 2069  r (int ir = 0; i
-000421d0: 7220 3c20 6e72 3b20 2b2b 6972 2920 7b0a  r < nr; ++ir) {.
-000421e0: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
-000421f0: 7263 302c 2073 7263 3120 616e 6420 6473  rc0, src1 and ds
-00042200: 7420 6172 6520 7361 6d65 2073 6861 7065  t are same shape
-00042210: 203d 3e20 7361 6d65 2069 6e64 6963 6573   => same indices
-00042220: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00042230: 7374 2069 6e74 2069 3320 3d20 6972 2f28  st int i3 = ir/(
-00042240: 6e65 322a 6e65 3129 3b0a 2020 2020 2020  ne2*ne1);.      
-00042250: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00042260: 6932 203d 2028 6972 202d 2069 332a 6e65  i2 = (ir - i3*ne
-00042270: 322a 6e65 3129 2f6e 6531 3b0a 2020 2020  2*ne1)/ne1;.    
-00042280: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-00042290: 7420 6931 203d 2028 6972 202d 2069 332a  t i1 = (ir - i3*
-000422a0: 6e65 322a 6e65 3120 2d20 6932 2a6e 6531  ne2*ne1 - i2*ne1
-000422b0: 293b 0a0a 0a23 6966 6465 6620 4747 4d4c  );...#ifdef GGML
-000422c0: 5f55 5345 5f41 4343 454c 4552 4154 450a  _USE_ACCELERATE.
-000422d0: 2020 2020 2020 2020 2020 2020 7644 5350              vDSP
-000422e0: 5f76 7375 6228 0a20 2020 2020 2020 2020  _vsub(.         
-000422f0: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
-00042300: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-00042310: 7263 312d 3e64 6174 6120 2b20 6933 2a6e  rc1->data + i3*n
-00042320: 6231 3320 2b20 6932 2a6e 6231 3220 2b20  b13 + i2*nb12 + 
-00042330: 6931 2a6e 6231 3129 2c20 312c 0a20 2020  i1*nb11), 1,.   
-00042340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042350: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-00042360: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00042370: 2b20 6933 2a6e 6230 3320 2b20 6932 2a6e  + i3*nb03 + i2*n
-00042380: 6230 3220 2b20 6931 2a6e 6230 3129 2c20  b02 + i1*nb01), 
-00042390: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-000423a0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-000423b0: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
-000423c0: 6461 7461 2020 2b20 6933 2a6e 6233 2020  data  + i3*nb3  
-000423d0: 2b20 6932 2a6e 6232 2020 2b20 6931 2a6e  + i2*nb2  + i1*n
-000423e0: 6231 2029 2c20 312c 0a20 2020 2020 2020  b1 ), 1,.       
-000423f0: 2020 2020 2020 2020 2020 2020 206e 6530               ne0
-00042400: 293b 0a23 656c 7365 0a20 2020 2020 2020  );.#else.       
-00042410: 2020 2020 2067 676d 6c5f 7665 635f 7375       ggml_vec_su
-00042420: 625f 6633 3228 6e65 302c 0a20 2020 2020  b_f32(ne0,.     
-00042430: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00042440: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00042450: 2a29 2064 7374 2d3e 6461 7461 2020 2b20  *) dst->data  + 
-00042460: 6933 2a6e 6233 2020 2b20 6932 2a6e 6232  i3*nb3  + i2*nb2
-00042470: 2020 2b20 6931 2a6e 6231 2029 2c0a 2020    + i1*nb1 ),.  
-00042480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042490: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-000424a0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-000424b0: 202b 2069 332a 6e62 3033 202b 2069 322a   + i3*nb03 + i2*
-000424c0: 6e62 3032 202b 2069 312a 6e62 3031 292c  nb02 + i1*nb01),
-000424d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000424e0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-000424f0: 2863 6861 7220 2a29 2073 7263 312d 3e64  (char *) src1->d
-00042500: 6174 6120 2b20 6933 2a6e 6231 3320 2b20  ata + i3*nb13 + 
-00042510: 6932 2a6e 6231 3220 2b20 6931 2a6e 6231  i2*nb12 + i1*nb1
-00042520: 3129 293b 0a23 656e 6469 660a 2020 2020  1));.#endif.    
-00042530: 2020 2020 2020 2020 2020 2020 2f2f 207d              // }
-00042540: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-00042550: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
-00042560: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-00042570: 202f 2f20 7372 6331 2069 7320 6e6f 7420   // src1 is not 
-00042580: 636f 6e74 6967 756f 7573 0a20 2020 2020  contiguous.     
-00042590: 2020 2066 6f72 2028 696e 7420 6972 203d     for (int ir =
-000425a0: 2030 3b20 6972 203c 206e 723b 202b 2b69   0; ir < nr; ++i
-000425b0: 7229 207b 0a20 2020 2020 2020 2020 2020  r) {.           
-000425c0: 202f 2f20 7372 6330 2c20 7372 6331 2061   // src0, src1 a
-000425d0: 6e64 2064 7374 2061 7265 2073 616d 6520  nd dst are same 
-000425e0: 7368 6170 6520 3d3e 2073 616d 6520 696e  shape => same in
-000425f0: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
-00042600: 2020 636f 6e73 7420 696e 7420 6933 203d    const int i3 =
-00042610: 2069 722f 286e 6532 2a6e 6531 293b 0a20   ir/(ne2*ne1);. 
-00042620: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00042630: 2069 6e74 2069 3220 3d20 2869 7220 2d20   int i2 = (ir - 
-00042640: 6933 2a6e 6532 2a6e 6531 292f 6e65 313b  i3*ne2*ne1)/ne1;
-00042650: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00042660: 7374 2069 6e74 2069 3120 3d20 2869 7220  st int i1 = (ir 
-00042670: 2d20 6933 2a6e 6532 2a6e 6531 202d 2069  - i3*ne2*ne1 - i
-00042680: 322a 6e65 3129 3b0a 0a20 2020 2020 2020  2*ne1);..       
-00042690: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
-000426a0: 5f70 7472 2020 3d20 2866 6c6f 6174 202a  _ptr  = (float *
-000426b0: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
-000426c0: 3e64 6174 6120 202b 2069 332a 6e62 3320  >data  + i3*nb3 
-000426d0: 202b 2069 322a 6e62 3220 202b 2069 312a   + i2*nb2  + i1*
-000426e0: 6e62 3120 293b 0a20 2020 2020 2020 2020  nb1 );.         
-000426f0: 2020 2066 6c6f 6174 202a 2073 7263 305f     float * src0_
-00042700: 7074 7220 3d20 2866 6c6f 6174 202a 2920  ptr = (float *) 
-00042710: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
-00042720: 6461 7461 202b 2069 332a 6e62 3033 202b  data + i3*nb03 +
-00042730: 2069 322a 6e62 3032 202b 2069 312a 6e62   i2*nb02 + i1*nb
-00042740: 3031 293b 0a20 2020 2020 2020 2020 2020  01);.           
-00042750: 2066 6f72 2028 696e 7420 6930 203d 2030   for (int i0 = 0
-00042760: 3b20 6930 203c 206e 6530 3b20 6930 2b2b  ; i0 < ne0; i0++
-00042770: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00042780: 2020 2020 666c 6f61 7420 2a20 7372 6331      float * src1
-00042790: 5f70 7472 203d 2028 666c 6f61 7420 2a29  _ptr = (float *)
-000427a0: 2028 2863 6861 7220 2a29 2073 7263 312d   ((char *) src1-
-000427b0: 3e64 6174 6120 2b20 6933 2a6e 6231 3320  >data + i3*nb13 
-000427c0: 2b20 6932 2a6e 6231 3220 2b20 6931 2a6e  + i2*nb12 + i1*n
-000427d0: 6231 3120 2b20 6930 2a6e 6231 3029 3b0a  b11 + i0*nb10);.
-000427e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000427f0: 2064 7374 5f70 7472 5b69 305d 203d 2073   dst_ptr[i0] = s
-00042800: 7263 305f 7074 725b 6930 5d20 2d20 2a73  rc0_ptr[i0] - *s
-00042810: 7263 315f 7074 723b 0a20 2020 2020 2020  rc1_ptr;.       
-00042820: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00042830: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-00042840: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00042850: 7465 5f66 6f72 7761 7264 5f73 7562 280a  te_forward_sub(.
-00042860: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00042870: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00042880: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00042890: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-000428a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000428b0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-000428c0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-000428d0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-000428e0: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
-000428f0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00042900: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
-00042910: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
-00042920: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-00042930: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
-00042940: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00042950: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00042960: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00042970: 645f 7375 625f 6633 3228 7061 7261 6d73  d_sub_f32(params
-00042980: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
-00042990: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-000429a0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-000429b0: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
-000429c0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000429d0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-000429e0: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
-000429f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00042a00: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
-00042a10: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00042a20: 645f 6d75 6c0a 0a73 7461 7469 6320 766f  d_mul..static vo
-00042a30: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00042a40: 666f 7277 6172 645f 6d75 6c5f 6633 3228  forward_mul_f32(
-00042a50: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00042a60: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00042a70: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00042a80: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00042a90: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00042aa0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-00042ab0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00042ac0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00042ad0: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
-00042ae0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00042af0: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
-00042b00: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f63  ML_ASSERT(ggml_c
-00042b10: 616e 5f72 6570 6561 745f 726f 7773 2873  an_repeat_rows(s
-00042b20: 7263 312c 2073 7263 3029 2026 2620 6767  rc1, src0) && gg
-00042b30: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-00042b40: 6528 7372 6330 2c20 6473 7429 293b 0a0a  e(src0, dst));..
-00042b50: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00042b60: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00042b70: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-00042b80: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00042b90: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-00042ba0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00042bb0: 2020 2020 7d0a 2020 2020 636f 6e73 7420      }.    const 
-00042bc0: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
-00042bd0: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-00042be0: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
-00042bf0: 732d 3e6e 7468 3b0a 0a23 6966 6465 6620  s->nth;..#ifdef 
-00042c00: 4747 4d4c 5f55 5345 5f43 4c42 4c41 5354  GGML_USE_CLBLAST
-00042c10: 0a20 2020 2069 6620 2873 7263 312d 3e62  .    if (src1->b
-00042c20: 6163 6b65 6e64 203d 3d20 4747 4d4c 5f42  ackend == GGML_B
-00042c30: 4143 4b45 4e44 5f47 5055 2920 7b0a 2020  ACKEND_GPU) {.  
-00042c40: 2020 2020 2020 6966 2028 6974 6820 3d3d        if (ith ==
-00042c50: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
-00042c60: 2020 6767 6d6c 5f63 6c5f 6d75 6c28 7372    ggml_cl_mul(sr
-00042c70: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
-00042c80: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00042c90: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-00042ca0: 2365 6e64 6966 0a0a 2020 2020 636f 6e73  #endif..    cons
-00042cb0: 7420 696e 7436 345f 7420 6e72 203d 2067  t int64_t nr = g
-00042cc0: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
-00042cd0: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-00042ce0: 345f 7420 6e65 3030 203d 2073 7263 302d  4_t ne00 = src0-
-00042cf0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-00042d00: 7420 696e 7436 345f 7420 6e65 3031 203d  t int64_t ne01 =
-00042d10: 2073 7263 302d 3e6e 655b 315d 3b0a 2020   src0->ne[1];.  
-00042d20: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00042d30: 6e65 3032 203d 2073 7263 302d 3e6e 655b  ne02 = src0->ne[
-00042d40: 325d 3b0a 0a20 2020 2063 6f6e 7374 2069  2];..    const i
-00042d50: 6e74 3634 5f74 206e 6531 3020 3d20 7372  nt64_t ne10 = sr
-00042d60: 6331 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c1->ne[0];.    c
-00042d70: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-00042d80: 3120 3d20 7372 6331 2d3e 6e65 5b31 5d3b  1 = src1->ne[1];
-00042d90: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00042da0: 5f74 206e 6531 3220 3d20 7372 6331 2d3e  _t ne12 = src1->
-00042db0: 6e65 5b32 5d3b 0a20 2020 2063 6f6e 7374  ne[2];.    const
-00042dc0: 2069 6e74 3634 5f74 206e 6531 3320 3d20   int64_t ne13 = 
-00042dd0: 7372 6331 2d3e 6e65 5b33 5d3b 0a0a 2020  src1->ne[3];..  
-00042de0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00042df0: 6230 3020 3d20 7372 6330 2d3e 6e62 5b30  b00 = src0->nb[0
-00042e00: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-00042e10: 655f 7420 6e62 3031 203d 2073 7263 302d  e_t nb01 = src0-
-00042e20: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-00042e30: 7420 7369 7a65 5f74 206e 6230 3220 3d20  t size_t nb02 = 
-00042e40: 7372 6330 2d3e 6e62 5b32 5d3b 0a20 2020  src0->nb[2];.   
-00042e50: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-00042e60: 3033 203d 2073 7263 302d 3e6e 625b 335d  03 = src0->nb[3]
-00042e70: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
-00042e80: 655f 7420 6e62 3130 203d 2073 7263 312d  e_t nb10 = src1-
-00042e90: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-00042ea0: 7420 7369 7a65 5f74 206e 6231 3120 3d20  t size_t nb11 = 
-00042eb0: 7372 6331 2d3e 6e62 5b31 5d3b 0a20 2020  src1->nb[1];.   
-00042ec0: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-00042ed0: 3132 203d 2073 7263 312d 3e6e 625b 325d  12 = src1->nb[2]
-00042ee0: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00042ef0: 5f74 206e 6231 3320 3d20 7372 6331 2d3e  _t nb13 = src1->
-00042f00: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-00042f10: 7420 7369 7a65 5f74 206e 6230 203d 2064  t size_t nb0 = d
-00042f20: 7374 2d3e 6e62 5b30 5d3b 0a20 2020 2063  st->nb[0];.    c
-00042f30: 6f6e 7374 2073 697a 655f 7420 6e62 3120  onst size_t nb1 
-00042f40: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
-00042f50: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00042f60: 6232 203d 2064 7374 2d3e 6e62 5b32 5d3b  b2 = dst->nb[2];
-00042f70: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00042f80: 7420 6e62 3320 3d20 6473 742d 3e6e 625b  t nb3 = dst->nb[
-00042f90: 335d 3b0a 0a20 2020 2047 474d 4c5f 4153  3];..    GGML_AS
-00042fa0: 5345 5254 2820 6e62 3020 3d3d 2073 697a  SERT( nb0 == siz
-00042fb0: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-00042fc0: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
-00042fd0: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-00042fe0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
-00042ff0: 5345 5254 286e 6530 3020 3d3d 206e 6531  SERT(ne00 == ne1
-00043000: 3029 3b0a 0a20 2020 2069 6620 286e 6231  0);..    if (nb1
-00043010: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-00043020: 7429 2920 7b0a 2020 2020 2020 2020 666f  t)) {.        fo
-00043030: 7220 2869 6e74 3634 5f74 2069 7220 3d20  r (int64_t ir = 
-00043040: 6974 683b 2069 7220 3c20 6e72 3b20 6972  ith; ir < nr; ir
-00043050: 202b 3d20 6e74 6829 207b 0a20 2020 2020   += nth) {.     
-00043060: 2020 2020 2020 202f 2f20 7372 6330 2061         // src0 a
-00043070: 6e64 2064 7374 2061 7265 2073 616d 6520  nd dst are same 
-00043080: 7368 6170 6520 3d3e 2073 616d 6520 696e  shape => same in
-00043090: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
-000430a0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000430b0: 6930 3320 3d20 6972 2f28 6e65 3032 2a6e  i03 = ir/(ne02*n
-000430c0: 6530 3129 3b0a 2020 2020 2020 2020 2020  e01);.          
-000430d0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000430e0: 6930 3220 3d20 2869 7220 2d20 6930 332a  i02 = (ir - i03*
-000430f0: 6e65 3032 2a6e 6530 3129 2f6e 6530 313b  ne02*ne01)/ne01;
-00043100: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00043110: 7374 2069 6e74 3634 5f74 2069 3031 203d  st int64_t i01 =
-00043120: 2028 6972 202d 2069 3033 2a6e 6530 322a   (ir - i03*ne02*
-00043130: 6e65 3031 202d 2069 3032 2a6e 6530 3129  ne01 - i02*ne01)
-00043140: 3b0a 0a20 2020 2020 2020 2020 2020 2063  ;..            c
-00043150: 6f6e 7374 2069 6e74 3634 5f74 2069 3133  onst int64_t i13
-00043160: 203d 2069 3033 2025 206e 6531 333b 0a20   = i03 % ne13;. 
-00043170: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00043180: 2069 6e74 3634 5f74 2069 3132 203d 2069   int64_t i12 = i
-00043190: 3032 2025 206e 6531 323b 0a20 2020 2020  02 % ne12;.     
-000431a0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-000431b0: 3634 5f74 2069 3131 203d 2069 3031 2025  64_t i11 = i01 %
-000431c0: 206e 6531 313b 0a0a 2020 2020 2020 2020   ne11;..        
-000431d0: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
-000431e0: 7074 7220 203d 2028 666c 6f61 7420 2a29  ptr  = (float *)
-000431f0: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
-00043200: 6461 7461 2020 2b20 6930 332a 6e62 3320  data  + i03*nb3 
-00043210: 202b 2069 3032 2a6e 6232 2020 2b20 6930   + i02*nb2  + i0
-00043220: 312a 6e62 3120 293b 0a20 2020 2020 2020  1*nb1 );.       
-00043230: 2020 2020 2066 6c6f 6174 202a 2073 7263       float * src
-00043240: 305f 7074 7220 3d20 2866 6c6f 6174 202a  0_ptr = (float *
-00043250: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
-00043260: 2d3e 6461 7461 202b 2069 3033 2a6e 6230  ->data + i03*nb0
-00043270: 3320 2b20 6930 322a 6e62 3032 202b 2069  3 + i02*nb02 + i
-00043280: 3031 2a6e 6230 3129 3b0a 2020 2020 2020  01*nb01);.      
-00043290: 2020 2020 2020 666c 6f61 7420 2a20 7372        float * sr
-000432a0: 6331 5f70 7472 203d 2028 666c 6f61 7420  c1_ptr = (float 
-000432b0: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
-000432c0: 312d 3e64 6174 6120 2b20 6931 332a 6e62  1->data + i13*nb
-000432d0: 3133 202b 2069 3132 2a6e 6231 3220 2b20  13 + i12*nb12 + 
-000432e0: 6931 312a 6e62 3131 293b 0a0a 2369 6664  i11*nb11);..#ifd
-000432f0: 6566 2047 474d 4c5f 5553 455f 4143 4345  ef GGML_USE_ACCE
-00043300: 4c45 5241 5445 0a20 2020 2020 2020 2020  LERATE.         
-00043310: 2020 2055 4e55 5345 4428 6767 6d6c 5f76     UNUSED(ggml_v
-00043320: 6563 5f6d 756c 5f66 3332 293b 0a0a 2020  ec_mul_f32);..  
-00043330: 2020 2020 2020 2020 2020 7644 5350 5f76            vDSP_v
-00043340: 6d75 6c28 2073 7263 305f 7074 722c 2031  mul( src0_ptr, 1
-00043350: 2c20 7372 6331 5f70 7472 2c20 312c 2064  , src1_ptr, 1, d
-00043360: 7374 5f70 7472 2c20 2031 2c20 6e65 3030  st_ptr,  1, ne00
-00043370: 293b 0a23 656c 7365 0a20 2020 2020 2020  );.#else.       
-00043380: 2020 2020 2067 676d 6c5f 7665 635f 6d75       ggml_vec_mu
-00043390: 6c5f 6633 3228 6e65 3030 2c20 6473 745f  l_f32(ne00, dst_
-000433a0: 7074 722c 2073 7263 305f 7074 722c 2073  ptr, src0_ptr, s
-000433b0: 7263 315f 7074 7229 3b0a 2365 6e64 6966  rc1_ptr);.#endif
-000433c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000433d0: 202f 2f20 7d0a 2020 2020 2020 2020 2020   // }.          
-000433e0: 2020 2f2f 207d 0a20 2020 2020 2020 207d    // }.        }
-000433f0: 0a20 2020 207d 2065 6c73 6520 7b0a 2020  .    } else {.  
-00043400: 2020 2020 2020 2f2f 2073 7263 3120 6973        // src1 is
-00043410: 206e 6f74 2063 6f6e 7469 6775 6f75 730a   not contiguous.
-00043420: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00043430: 3634 5f74 2069 7220 3d20 6974 683b 2069  64_t ir = ith; i
-00043440: 7220 3c20 6e72 3b20 6972 202b 3d20 6e74  r < nr; ir += nt
-00043450: 6829 207b 0a20 2020 2020 2020 2020 2020  h) {.           
-00043460: 202f 2f20 7372 6330 2061 6e64 2064 7374   // src0 and dst
-00043470: 2061 7265 2073 616d 6520 7368 6170 6520   are same shape 
-00043480: 3d3e 2073 616d 6520 696e 6469 6365 730a  => same indices.
-00043490: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
-000434a0: 7263 3120 6973 2062 726f 6164 6361 7374  rc1 is broadcast
-000434b0: 6162 6c65 2061 6372 6f73 7320 7372 6330  able across src0
-000434c0: 2061 6e64 2064 7374 2069 6e20 6931 2c20   and dst in i1, 
-000434d0: 6932 2c20 6933 0a20 2020 2020 2020 2020  i2, i3.         
-000434e0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-000434f0: 2069 3033 203d 2069 722f 286e 6530 322a   i03 = ir/(ne02*
-00043500: 6e65 3031 293b 0a20 2020 2020 2020 2020  ne01);.         
-00043510: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00043520: 2069 3032 203d 2028 6972 202d 2069 3033   i02 = (ir - i03
-00043530: 2a6e 6530 322a 6e65 3031 292f 6e65 3031  *ne02*ne01)/ne01
-00043540: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-00043550: 6e73 7420 696e 7436 345f 7420 6930 3120  nst int64_t i01 
-00043560: 3d20 2869 7220 2d20 6930 332a 6e65 3032  = (ir - i03*ne02
-00043570: 2a6e 6530 3120 2d20 6930 322a 6e65 3031  *ne01 - i02*ne01
-00043580: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00043590: 636f 6e73 7420 696e 7436 345f 7420 6931  const int64_t i1
-000435a0: 3320 3d20 6930 3320 2520 6e65 3133 3b0a  3 = i03 % ne13;.
-000435b0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000435c0: 7420 696e 7436 345f 7420 6931 3220 3d20  t int64_t i12 = 
-000435d0: 6930 3220 2520 6e65 3132 3b0a 2020 2020  i02 % ne12;.    
-000435e0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000435f0: 7436 345f 7420 6931 3120 3d20 6930 3120  t64_t i11 = i01 
-00043600: 2520 6e65 3131 3b0a 0a20 2020 2020 2020  % ne11;..       
-00043610: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
-00043620: 5f70 7472 2020 3d20 2866 6c6f 6174 202a  _ptr  = (float *
-00043630: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
-00043640: 3e64 6174 6120 202b 2069 3033 2a6e 6233  >data  + i03*nb3
-00043650: 2020 2b20 6930 322a 6e62 3220 202b 2069    + i02*nb2  + i
-00043660: 3031 2a6e 6231 2029 3b0a 2020 2020 2020  01*nb1 );.      
-00043670: 2020 2020 2020 666c 6f61 7420 2a20 7372        float * sr
-00043680: 6330 5f70 7472 203d 2028 666c 6f61 7420  c0_ptr = (float 
-00043690: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
-000436a0: 302d 3e64 6174 6120 2b20 6930 332a 6e62  0->data + i03*nb
-000436b0: 3033 202b 2069 3032 2a6e 6230 3220 2b20  03 + i02*nb02 + 
-000436c0: 6930 312a 6e62 3031 293b 0a0a 2020 2020  i01*nb01);..    
-000436d0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-000436e0: 3634 5f74 2069 3020 3d20 303b 2069 3020  64_t i0 = 0; i0 
-000436f0: 3c20 6e65 3030 3b20 6930 2b2b 2920 7b0a  < ne00; i0++) {.
-00043700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043710: 666c 6f61 7420 2a20 7372 6331 5f70 7472  float * src1_ptr
-00043720: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
-00043730: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
-00043740: 6120 2b20 6931 332a 6e62 3133 202b 2069  a + i13*nb13 + i
-00043750: 3132 2a6e 6231 3220 2b20 6931 312a 6e62  12*nb12 + i11*nb
-00043760: 3131 202b 2069 302a 6e62 3130 293b 0a0a  11 + i0*nb10);..
-00043770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043780: 6473 745f 7074 725b 6930 5d20 3d20 7372  dst_ptr[i0] = sr
-00043790: 6330 5f70 7472 5b69 305d 202a 2028 2a73  c0_ptr[i0] * (*s
-000437a0: 7263 315f 7074 7229 3b0a 2020 2020 2020  rc1_ptr);.      
-000437b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000437c0: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
-000437d0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-000437e0: 7574 655f 666f 7277 6172 645f 6d75 6c28  ute_forward_mul(
-000437f0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00043800: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00043810: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00043820: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00043830: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00043840: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-00043850: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00043860: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00043870: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
-00043880: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00043890: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
-000438a0: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
-000438b0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-000438c0: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-000438d0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000438e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-000438f0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00043900: 7264 5f6d 756c 5f66 3332 2870 6172 616d  rd_mul_f32(param
-00043910: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00043920: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00043930: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00043940: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
-00043950: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00043960: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00043970: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00043980: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00043990: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
-000439a0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000439b0: 7264 5f64 6976 0a0a 7374 6174 6963 2076  rd_div..static v
-000439c0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-000439d0: 5f66 6f72 7761 7264 5f64 6976 5f66 3332  _forward_div_f32
-000439e0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-000439f0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00043a00: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00043a10: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-00043a20: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00043a30: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-00043a40: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00043a50: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00043a60: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
-00043a70: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00043a80: 7220 2a20 6473 7429 207b 0a20 2020 2061  r * dst) {.    a
-00043a90: 7373 6572 7428 7061 7261 6d73 2d3e 6974  ssert(params->it
-00043aa0: 6820 3d3d 2030 293b 0a20 2020 2061 7373  h == 0);.    ass
-00043ab0: 6572 7428 6767 6d6c 5f61 7265 5f73 616d  ert(ggml_are_sam
-00043ac0: 655f 7368 6170 6528 7372 6330 2c20 7372  e_shape(src0, sr
-00043ad0: 6331 2920 2626 2067 676d 6c5f 6172 655f  c1) && ggml_are_
-00043ae0: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
-00043af0: 2064 7374 2929 3b0a 0a20 2020 2069 6620   dst));..    if 
-00043b00: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00043b10: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-00043b20: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00043b30: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-00043b40: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-00043b50: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00043b60: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-00043b70: 2020 3d20 6767 6d6c 5f6e 726f 7773 2873    = ggml_nrows(s
-00043b80: 7263 3029 3b0a 2020 2020 636f 6e73 7420  rc0);.    const 
-00043b90: 696e 7436 345f 7420 6e65 3020 3d20 7372  int64_t ne0 = sr
-00043ba0: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
-00043bb0: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-00043bc0: 203d 2073 7263 302d 3e6e 655b 315d 3b0a   = src0->ne[1];.
-00043bd0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00043be0: 7420 6e65 3220 3d20 7372 6330 2d3e 6e65  t ne2 = src0->ne
-00043bf0: 5b32 5d3b 0a0a 2020 2020 636f 6e73 7420  [2];..    const 
-00043c00: 7369 7a65 5f74 206e 6230 3020 3d20 7372  size_t nb00 = sr
-00043c10: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
-00043c20: 6f6e 7374 2073 697a 655f 7420 6e62 3031  onst size_t nb01
-00043c30: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
-00043c40: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00043c50: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
-00043c60: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
-00043c70: 697a 655f 7420 6e62 3033 203d 2073 7263  ize_t nb03 = src
-00043c80: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
-00043c90: 6f6e 7374 2073 697a 655f 7420 6e62 3130  onst size_t nb10
-00043ca0: 203d 2073 7263 312d 3e6e 625b 305d 3b0a   = src1->nb[0];.
-00043cb0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00043cc0: 206e 6231 3120 3d20 7372 6331 2d3e 6e62   nb11 = src1->nb
-00043cd0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2073  [1];.    const s
-00043ce0: 697a 655f 7420 6e62 3132 203d 2073 7263  ize_t nb12 = src
-00043cf0: 312d 3e6e 625b 325d 3b0a 2020 2020 636f  1->nb[2];.    co
-00043d00: 6e73 7420 7369 7a65 5f74 206e 6231 3320  nst size_t nb13 
-00043d10: 3d20 7372 6331 2d3e 6e62 5b33 5d3b 0a0a  = src1->nb[3];..
-00043d20: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00043d30: 206e 6230 203d 2064 7374 2d3e 6e62 5b30   nb0 = dst->nb[0
-00043d40: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-00043d50: 655f 7420 6e62 3120 3d20 6473 742d 3e6e  e_t nb1 = dst->n
-00043d60: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
-00043d70: 7369 7a65 5f74 206e 6232 203d 2064 7374  size_t nb2 = dst
-00043d80: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-00043d90: 7374 2073 697a 655f 7420 6e62 3320 3d20  st size_t nb3 = 
-00043da0: 6473 742d 3e6e 625b 335d 3b0a 0a20 2020  dst->nb[3];..   
-00043db0: 2047 474d 4c5f 4153 5345 5254 2820 6e62   GGML_ASSERT( nb
-00043dc0: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-00043dd0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
-00043de0: 5345 5254 286e 6230 3020 3d3d 2073 697a  SERT(nb00 == siz
-00043df0: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
-00043e00: 2020 6966 2028 6e62 3130 203d 3d20 7369    if (nb10 == si
-00043e10: 7a65 6f66 2866 6c6f 6174 2929 207b 0a20  zeof(float)) {. 
-00043e20: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00043e30: 6972 203d 2030 3b20 6972 203c 206e 723b  ir = 0; ir < nr;
-00043e40: 202b 2b69 7229 207b 0a20 2020 2020 2020   ++ir) {.       
-00043e50: 2020 2020 202f 2f20 7372 6330 2c20 7372       // src0, sr
-00043e60: 6331 2061 6e64 2064 7374 2061 7265 2073  c1 and dst are s
-00043e70: 616d 6520 7368 6170 6520 3d3e 2073 616d  ame shape => sam
-00043e80: 6520 696e 6469 6365 730a 2020 2020 2020  e indices.      
-00043e90: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00043ea0: 6933 203d 2069 722f 286e 6532 2a6e 6531  i3 = ir/(ne2*ne1
-00043eb0: 293b 0a20 2020 2020 2020 2020 2020 2063  );.            c
-00043ec0: 6f6e 7374 2069 6e74 2069 3220 3d20 2869  onst int i2 = (i
-00043ed0: 7220 2d20 6933 2a6e 6532 2a6e 6531 292f  r - i3*ne2*ne1)/
-00043ee0: 6e65 313b 0a20 2020 2020 2020 2020 2020  ne1;.           
-00043ef0: 2063 6f6e 7374 2069 6e74 2069 3120 3d20   const int i1 = 
-00043f00: 2869 7220 2d20 6933 2a6e 6532 2a6e 6531  (ir - i3*ne2*ne1
-00043f10: 202d 2069 322a 6e65 3129 3b0a 0a0a 2369   - i2*ne1);...#i
-00043f20: 6664 6566 2047 474d 4c5f 5553 455f 4143  fdef GGML_USE_AC
-00043f30: 4345 4c45 5241 5445 0a20 2020 2020 2020  CELERATE.       
-00043f40: 2020 2020 2076 4453 505f 7664 6976 280a       vDSP_vdiv(.
-00043f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043f60: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00043f70: 6368 6172 202a 2920 7372 6331 2d3e 6461  char *) src1->da
-00043f80: 7461 202b 2069 332a 6e62 3133 202b 2069  ta + i3*nb13 + i
-00043f90: 322a 6e62 3132 202b 2069 312a 6e62 3131  2*nb12 + i1*nb11
-00043fa0: 292c 2031 2c0a 2020 2020 2020 2020 2020  ), 1,.          
-00043fb0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00043fc0: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
-00043fd0: 6330 2d3e 6461 7461 202b 2069 332a 6e62  c0->data + i3*nb
-00043fe0: 3033 202b 2069 322a 6e62 3032 202b 2069  03 + i2*nb02 + i
-00043ff0: 312a 6e62 3031 292c 2031 2c0a 2020 2020  1*nb01), 1,.    
-00044000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044010: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00044020: 202a 2920 6473 742d 3e64 6174 6120 202b   *) dst->data  +
-00044030: 2069 332a 6e62 3320 202b 2069 322a 6e62   i3*nb3  + i2*nb
-00044040: 3220 202b 2069 312a 6e62 3120 292c 2031  2  + i1*nb1 ), 1
-00044050: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00044060: 2020 2020 2020 6e65 3029 3b0a 2365 6c73        ne0);.#els
-00044070: 650a 2020 2020 2020 2020 2020 2020 6767  e.            gg
-00044080: 6d6c 5f76 6563 5f64 6976 5f66 3332 286e  ml_vec_div_f32(n
-00044090: 6530 2c0a 2020 2020 2020 2020 2020 2020  e0,.            
-000440a0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-000440b0: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
-000440c0: 3e64 6174 6120 202b 2069 332a 6e62 3320  >data  + i3*nb3 
-000440d0: 202b 2069 322a 6e62 3220 202b 2069 312a   + i2*nb2  + i1*
-000440e0: 6e62 3120 292c 0a20 2020 2020 2020 2020  nb1 ),.         
-000440f0: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
-00044100: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-00044110: 7263 302d 3e64 6174 6120 2b20 6933 2a6e  rc0->data + i3*n
-00044120: 6230 3320 2b20 6932 2a6e 6230 3220 2b20  b03 + i2*nb02 + 
-00044130: 6931 2a6e 6230 3129 2c0a 2020 2020 2020  i1*nb01),.      
-00044140: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-00044150: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-00044160: 2920 7372 6331 2d3e 6461 7461 202b 2069  ) src1->data + i
-00044170: 332a 6e62 3133 202b 2069 322a 6e62 3132  3*nb13 + i2*nb12
-00044180: 202b 2069 312a 6e62 3131 2929 3b0a 2365   + i1*nb11));.#e
-00044190: 6e64 6966 0a20 2020 2020 2020 2020 2020  ndif.           
-000441a0: 2020 2020 202f 2f20 7d0a 2020 2020 2020       // }.      
-000441b0: 2020 2020 2020 2f2f 207d 0a20 2020 2020        // }.     
-000441c0: 2020 207d 0a20 2020 207d 2065 6c73 6520     }.    } else 
-000441d0: 7b0a 2020 2020 2020 2020 2f2f 2073 7263  {.        // src
-000441e0: 3120 6973 206e 6f74 2063 6f6e 7469 6775  1 is not contigu
-000441f0: 6f75 730a 2020 2020 2020 2020 666f 7220  ous.        for 
-00044200: 2869 6e74 2069 7220 3d20 303b 2069 7220  (int ir = 0; ir 
-00044210: 3c20 6e72 3b20 2b2b 6972 2920 7b0a 2020  < nr; ++ir) {.  
-00044220: 2020 2020 2020 2020 2020 2f2f 2073 7263            // src
-00044230: 302c 2073 7263 3120 616e 6420 6473 7420  0, src1 and dst 
-00044240: 6172 6520 7361 6d65 2073 6861 7065 203d  are same shape =
-00044250: 3e20 7361 6d65 2069 6e64 6963 6573 0a20  > same indices. 
-00044260: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00044270: 2069 6e74 2069 3320 3d20 6972 2f28 6e65   int i3 = ir/(ne
-00044280: 322a 6e65 3129 3b0a 2020 2020 2020 2020  2*ne1);.        
-00044290: 2020 2020 636f 6e73 7420 696e 7420 6932      const int i2
-000442a0: 203d 2028 6972 202d 2069 332a 6e65 322a   = (ir - i3*ne2*
-000442b0: 6e65 3129 2f6e 6531 3b0a 2020 2020 2020  ne1)/ne1;.      
-000442c0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-000442d0: 6931 203d 2028 6972 202d 2069 332a 6e65  i1 = (ir - i3*ne
-000442e0: 322a 6e65 3120 2d20 6932 2a6e 6531 293b  2*ne1 - i2*ne1);
-000442f0: 0a0a 2020 2020 2020 2020 2020 2020 666c  ..            fl
-00044300: 6f61 7420 2a20 6473 745f 7074 7220 203d  oat * dst_ptr  =
-00044310: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-00044320: 7220 2a29 2064 7374 2d3e 6461 7461 2020  r *) dst->data  
-00044330: 2b20 6933 2a6e 6233 2020 2b20 6932 2a6e  + i3*nb3  + i2*n
-00044340: 6232 2020 2b20 6931 2a6e 6231 2029 3b0a  b2  + i1*nb1 );.
-00044350: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-00044360: 7420 2a20 7372 6330 5f70 7472 203d 2028  t * src0_ptr = (
-00044370: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00044380: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00044390: 6933 2a6e 6230 3320 2b20 6932 2a6e 6230  i3*nb03 + i2*nb0
-000443a0: 3220 2b20 6931 2a6e 6230 3129 3b0a 2020  2 + i1*nb01);.  
-000443b0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-000443c0: 6e74 2069 3020 3d20 303b 2069 3020 3c20  nt i0 = 0; i0 < 
-000443d0: 6e65 303b 2069 302b 2b29 207b 0a20 2020  ne0; i0++) {.   
-000443e0: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-000443f0: 6174 202a 2073 7263 315f 7074 7220 3d20  at * src1_ptr = 
-00044400: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00044410: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
-00044420: 2069 332a 6e62 3133 202b 2069 322a 6e62   i3*nb13 + i2*nb
-00044430: 3132 202b 2069 312a 6e62 3131 202b 2069  12 + i1*nb11 + i
-00044440: 302a 6e62 3130 293b 0a0a 2020 2020 2020  0*nb10);..      
-00044450: 2020 2020 2020 2020 2020 6473 745f 7074            dst_pt
-00044460: 725b 6930 5d20 3d20 7372 6330 5f70 7472  r[i0] = src0_ptr
-00044470: 5b69 305d 202f 2028 2a73 7263 315f 7074  [i0] / (*src1_pt
-00044480: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00044490: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
-000444a0: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-000444b0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-000444c0: 7277 6172 645f 6469 7628 0a20 2020 2020  rward_div(.     
-000444d0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000444e0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-000444f0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00044500: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00044510: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00044520: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-00044530: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00044540: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-00044550: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00044560: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00044570: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00044580: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00044590: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000445a0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-000445b0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000445c0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-000445d0: 7075 7465 5f66 6f72 7761 7264 5f64 6976  pute_forward_div
-000445e0: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
-000445f0: 302c 2073 7263 312c 2064 7374 293b 0a20  0, src1, dst);. 
-00044600: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00044610: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
-00044620: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-00044630: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00044640: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00044650: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-00044660: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00044670: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
-00044680: 7075 7465 5f66 6f72 7761 7264 5f73 7172  pute_forward_sqr
-00044690: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-000446a0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000446b0: 7264 5f73 7172 5f66 3332 280a 2020 2020  rd_sqr_f32(.    
-000446c0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-000446d0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-000446e0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-000446f0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00044700: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00044710: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00044720: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00044730: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-00044740: 6173 7365 7274 2870 6172 616d 732d 3e69  assert(params->i
-00044750: 7468 203d 3d20 3029 3b0a 2020 2020 6173  th == 0);.    as
-00044760: 7365 7274 2867 676d 6c5f 6172 655f 7361  sert(ggml_are_sa
-00044770: 6d65 5f73 6861 7065 2873 7263 302c 2064  me_shape(src0, d
-00044780: 7374 2929 3b0a 0a20 2020 2069 6620 2870  st));..    if (p
-00044790: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000447a0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
-000447b0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
-000447c0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-000447d0: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
-000447e0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-000447f0: 2020 636f 6e73 7420 696e 7420 6e20 2020    const int n   
-00044800: 2020 3d20 6767 6d6c 5f6e 726f 7773 2873    = ggml_nrows(s
-00044810: 7263 3029 3b0a 2020 2020 636f 6e73 7420  rc0);.    const 
-00044820: 696e 7420 6e63 2020 2020 3d20 7372 6330  int nc    = src0
-00044830: 2d3e 6e65 5b30 5d3b 0a0a 2020 2020 6173  ->ne[0];..    as
-00044840: 7365 7274 2820 6473 742d 3e6e 625b 305d  sert( dst->nb[0]
-00044850: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-00044860: 2929 3b0a 2020 2020 6173 7365 7274 2873  ));.    assert(s
-00044870: 7263 302d 3e6e 625b 305d 203d 3d20 7369  rc0->nb[0] == si
-00044880: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
-00044890: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-000448a0: 303b 2069 203c 206e 3b20 692b 2b29 207b  0; i < n; i++) {
-000448b0: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-000448c0: 635f 7371 725f 6633 3228 6e63 2c0a 2020  c_sqr_f32(nc,.  
-000448d0: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-000448e0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-000448f0: 2920 6473 742d 3e64 6174 6120 202b 2069  ) dst->data  + i
-00044900: 2a28 2064 7374 2d3e 6e62 5b31 5d29 292c  *( dst->nb[1])),
-00044910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044920: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-00044930: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00044940: 2b20 692a 2873 7263 302d 3e6e 625b 315d  + i*(src0->nb[1]
-00044950: 2929 293b 0a20 2020 207d 0a7d 0a0a 7374  )));.    }.}..st
-00044960: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00044970: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
-00044980: 7172 280a 2020 2020 2020 2020 636f 6e73  qr(.        cons
-00044990: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-000449a0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-000449b0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-000449c0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000449d0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-000449e0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000449f0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00044a00: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00044a10: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00044a20: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00044a30: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-00044a40: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00044a50: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00044a60: 7075 7465 5f66 6f72 7761 7264 5f73 7172  pute_forward_sqr
-00044a70: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
-00044a80: 302c 2064 7374 293b 0a20 2020 2020 2020  0, dst);.       
-00044a90: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00044aa0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
-00044ab0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00044ac0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00044ad0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00044ae0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00044af0: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
-00044b00: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00044b10: 6f72 7761 7264 5f73 7172 740a 0a73 7461  orward_sqrt..sta
-00044b20: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00044b30: 6d70 7574 655f 666f 7277 6172 645f 7371  mpute_forward_sq
-00044b40: 7274 5f66 3332 280a 2020 2020 2020 2020  rt_f32(.        
-00044b50: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00044b60: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00044b70: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00044b80: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00044b90: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00044ba0: 6330 2c0a 2020 2020 2020 2020 7374 7275  c0,.        stru
-00044bb0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00044bc0: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
-00044bd0: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
-00044be0: 3d20 3029 3b0a 2020 2020 6173 7365 7274  = 0);.    assert
-00044bf0: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
-00044c00: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
-00044c10: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
-00044c20: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00044c30: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
-00044c40: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00044c50: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
-00044c60: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-00044c70: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
-00044c80: 6e73 7420 696e 7420 6e20 203d 2067 676d  nst int n  = ggm
-00044c90: 6c5f 6e72 6f77 7328 7372 6330 293b 0a20  l_nrows(src0);. 
-00044ca0: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
-00044cb0: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a0a  = src0->ne[0];..
-00044cc0: 2020 2020 6173 7365 7274 2820 6473 742d      assert( dst-
-00044cd0: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-00044ce0: 2866 6c6f 6174 2929 3b0a 2020 2020 6173  (float));.    as
-00044cf0: 7365 7274 2873 7263 302d 3e6e 625b 305d  sert(src0->nb[0]
-00044d00: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-00044d10: 2929 3b0a 0a20 2020 2066 6f72 2028 696e  ));..    for (in
-00044d20: 7420 6920 3d20 303b 2069 203c 206e 3b20  t i = 0; i < n; 
-00044d30: 692b 2b29 207b 0a20 2020 2020 2020 2067  i++) {.        g
-00044d40: 676d 6c5f 7665 635f 7371 7274 5f66 3332  gml_vec_sqrt_f32
-00044d50: 286e 632c 0a20 2020 2020 2020 2020 2020  (nc,.           
-00044d60: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-00044d70: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
-00044d80: 7461 2020 2b20 692a 2820 6473 742d 3e6e  ta  + i*( dst->n
-00044d90: 625b 315d 2929 2c0a 2020 2020 2020 2020  b[1])),.        
-00044da0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-00044db0: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
-00044dc0: 2d3e 6461 7461 202b 2069 2a28 7372 6330  ->data + i*(src0
-00044dd0: 2d3e 6e62 5b31 5d29 2929 3b0a 2020 2020  ->nb[1])));.    
-00044de0: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-00044df0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00044e00: 7277 6172 645f 7371 7274 280a 2020 2020  rward_sqrt(.    
-00044e10: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00044e20: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00044e30: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00044e40: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00044e50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00044e60: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00044e70: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00044e80: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-00044e90: 7377 6974 6368 2028 7372 6330 2d3e 7479  switch (src0->ty
-00044ea0: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
-00044eb0: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
-00044ec0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00044ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044ee0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00044ef0: 7761 7264 5f73 7172 745f 6633 3228 7061  ward_sqrt_f32(pa
-00044f00: 7261 6d73 2c20 7372 6330 2c20 6473 7429  rams, src0, dst)
-00044f10: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00044f20: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
-00044f30: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-00044f40: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00044f50: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00044f60: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-00044f70: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00044f80: 2020 207d 0a7d 0a0a 0a2f 2f20 6767 6d6c     }.}...// ggml
-00044f90: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00044fa0: 5f6c 6f67 0a0a 7374 6174 6963 2076 6f69  _log..static voi
-00044fb0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00044fc0: 6f72 7761 7264 5f6c 6f67 5f66 3332 280a  orward_log_f32(.
-00044fd0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00044fe0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00044ff0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00045000: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00045010: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00045020: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00045030: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00045040: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00045050: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00045060: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
-00045070: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00045080: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-00045090: 5f73 6861 7065 2873 7263 302c 2064 7374  _shape(src0, dst
-000450a0: 2929 3b0a 0a20 2020 2069 6620 2870 6172  ));..    if (par
-000450b0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-000450c0: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-000450d0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000450e0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-000450f0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00045100: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00045110: 636f 6e73 7420 696e 7420 6e20 203d 2067  const int n  = g
-00045120: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
-00045130: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00045140: 6320 3d20 7372 6330 2d3e 6e65 5b30 5d3b  c = src0->ne[0];
-00045150: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00045160: 5428 2064 7374 2d3e 6e62 5b30 5d20 3d3d  T( dst->nb[0] ==
-00045170: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-00045180: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00045190: 2873 7263 302d 3e6e 625b 305d 203d 3d20  (src0->nb[0] == 
-000451a0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-000451b0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-000451c0: 3d20 303b 2069 203c 206e 3b20 692b 2b29  = 0; i < n; i++)
-000451d0: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
-000451e0: 7665 635f 6c6f 675f 6633 3228 6e63 2c0a  vec_log_f32(nc,.
-000451f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045200: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00045210: 202a 2920 6473 742d 3e64 6174 6120 202b   *) dst->data  +
-00045220: 2069 2a28 2064 7374 2d3e 6e62 5b31 5d29   i*( dst->nb[1])
-00045230: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00045240: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-00045250: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-00045260: 6120 2b20 692a 2873 7263 302d 3e6e 625b  a + i*(src0->nb[
-00045270: 315d 2929 293b 0a20 2020 207d 0a7d 0a0a  1])));.    }.}..
-00045280: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-00045290: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000452a0: 5f6c 6f67 280a 2020 2020 2020 2020 636f  _log(.        co
-000452b0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000452c0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-000452d0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-000452e0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-000452f0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00045300: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00045310: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00045320: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
-00045330: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
-00045340: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00045350: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
-00045360: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00045370: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00045380: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6c  ompute_forward_l
-00045390: 6f67 5f66 3332 2870 6172 616d 732c 2073  og_f32(params, s
-000453a0: 7263 302c 2064 7374 293b 0a20 2020 2020  rc0, dst);.     
-000453b0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-000453c0: 2020 2020 2020 2020 6465 6661 756c 743a          default:
-000453d0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000453e0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-000453f0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-00045400: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00045410: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-00045420: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
-00045430: 5f66 6f72 7761 7264 5f73 756d 0a0a 7374  _forward_sum..st
-00045440: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00045450: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
-00045460: 756d 5f66 3332 280a 2020 2020 2020 2020  um_f32(.        
-00045470: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00045480: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00045490: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-000454a0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000454b0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-000454c0: 6330 2c0a 2020 2020 2020 2020 7374 7275  c0,.        stru
-000454d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000454e0: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
-000454f0: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
-00045500: 3d20 3029 3b0a 2020 2020 6173 7365 7274  = 0);.    assert
-00045510: 2867 676d 6c5f 6973 5f73 6361 6c61 7228  (ggml_is_scalar(
-00045520: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
-00045530: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00045540: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
-00045550: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
-00045560: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00045570: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-00045580: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-00045590: 2020 2061 7373 6572 7428 6767 6d6c 5f69     assert(ggml_i
-000455a0: 735f 7363 616c 6172 2864 7374 2929 3b0a  s_scalar(dst));.
-000455b0: 2020 2020 6173 7365 7274 2873 7263 302d      assert(src0-
-000455c0: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-000455d0: 2866 6c6f 6174 2929 3b0a 0a20 2020 2063  (float));..    c
-000455e0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
-000455f0: 3020 3d20 7372 6330 2d3e 6e65 5b30 5d3b  0 = src0->ne[0];
-00045600: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00045610: 5f74 206e 6530 3120 3d20 7372 6330 2d3e  _t ne01 = src0->
-00045620: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
-00045630: 2069 6e74 3634 5f74 206e 6530 3220 3d20   int64_t ne02 = 
-00045640: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
-00045650: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00045660: 6530 3320 3d20 7372 6330 2d3e 6e65 5b33  e03 = src0->ne[3
-00045670: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
-00045680: 7a65 5f74 206e 6230 3120 3d20 7372 6330  ze_t nb01 = src0
-00045690: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
-000456a0: 7374 2073 697a 655f 7420 6e62 3032 203d  st size_t nb02 =
-000456b0: 2073 7263 302d 3e6e 625b 325d 3b0a 2020   src0->nb[2];.  
-000456c0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-000456d0: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
-000456e0: 5d3b 0a0a 2020 2020 6767 6d6c 5f66 6c6f  ];..    ggml_flo
-000456f0: 6174 2073 756d 2020 2020 203d 2030 3b0a  at sum     = 0;.
-00045700: 2020 2020 6767 6d6c 5f66 6c6f 6174 2072      ggml_float r
-00045710: 6f77 5f73 756d 203d 2030 3b0a 0a20 2020  ow_sum = 0;..   
-00045720: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
-00045730: 3320 3d20 303b 2069 3033 203c 206e 6530  3 = 0; i03 < ne0
-00045740: 333b 2069 3033 2b2b 2920 7b0a 2020 2020  3; i03++) {.    
-00045750: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-00045760: 2069 3032 203d 2030 3b20 6930 3220 3c20   i02 = 0; i02 < 
-00045770: 6e65 3032 3b20 6930 322b 2b29 207b 0a20  ne02; i02++) {. 
-00045780: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00045790: 696e 7436 345f 7420 6930 3120 3d20 303b  int64_t i01 = 0;
-000457a0: 2069 3031 203c 206e 6530 313b 2069 3031   i01 < ne01; i01
-000457b0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-000457c0: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-000457d0: 756d 5f67 6766 286e 6530 302c 0a20 2020  um_ggf(ne00,.   
-000457e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000457f0: 2020 2020 2026 726f 775f 7375 6d2c 0a20       &row_sum,. 
-00045800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045810: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-00045820: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-00045830: 3e64 6174 6120 2b20 6930 312a 6e62 3031  >data + i01*nb01
-00045840: 202b 2069 3032 2a6e 6230 3220 2b20 6930   + i02*nb02 + i0
-00045850: 332a 6e62 3033 2929 3b0a 2020 2020 2020  3*nb03));.      
-00045860: 2020 2020 2020 2020 2020 7375 6d20 2b3d            sum +=
-00045870: 2072 6f77 5f73 756d 3b0a 2020 2020 2020   row_sum;.      
-00045880: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00045890: 7d0a 2020 2020 7d0a 2020 2020 2828 666c  }.    }.    ((fl
-000458a0: 6f61 7420 2a29 2064 7374 2d3e 6461 7461  oat *) dst->data
-000458b0: 295b 305d 203d 2073 756d 3b0a 7d0a 0a73  )[0] = sum;.}..s
-000458c0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-000458d0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000458e0: 7375 6d28 0a20 2020 2020 2020 2063 6f6e  sum(.        con
-000458f0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00045900: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-00045910: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00045920: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00045930: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-00045940: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00045950: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00045960: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
-00045970: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
-00045980: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00045990: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-000459a0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000459b0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-000459c0: 6d70 7574 655f 666f 7277 6172 645f 7375  mpute_forward_su
-000459d0: 6d5f 6633 3228 7061 7261 6d73 2c20 7372  m_f32(params, sr
-000459e0: 6330 2c20 6473 7429 3b0a 2020 2020 2020  c0, dst);.      
-000459f0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00045a00: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
-00045a10: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00045a20: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00045a30: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00045a40: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00045a50: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-00045a60: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
-00045a70: 666f 7277 6172 645f 7375 6d5f 726f 7773  forward_sum_rows
-00045a80: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00045a90: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00045aa0: 7264 5f73 756d 5f72 6f77 735f 6633 3228  rd_sum_rows_f32(
-00045ab0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00045ac0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00045ad0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00045ae0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00045af0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00045b00: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-00045b10: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00045b20: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00045b30: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00045b40: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
-00045b50: 3029 3b0a 0a20 2020 2069 6620 2870 6172  0);..    if (par
-00045b60: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00045b70: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-00045b80: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00045b90: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-00045ba0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00045bb0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00045bc0: 4747 4d4c 5f41 5353 4552 5428 7372 6330  GGML_ASSERT(src0
-00045bd0: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
-00045be0: 6628 666c 6f61 7429 293b 0a20 2020 2047  f(float));.    G
-00045bf0: 474d 4c5f 4153 5345 5254 2864 7374 2d3e  GML_ASSERT(dst->
-00045c00: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
-00045c10: 666c 6f61 7429 293b 0a0a 2020 2020 636f  float));..    co
-00045c20: 6e73 7420 696e 7436 345f 7420 6e65 3030  nst int64_t ne00
-00045c30: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
-00045c40: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00045c50: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
-00045c60: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-00045c70: 696e 7436 345f 7420 6e65 3032 203d 2073  int64_t ne02 = s
-00045c80: 7263 302d 3e6e 655b 325d 3b0a 2020 2020  rc0->ne[2];.    
-00045c90: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00045ca0: 3033 203d 2073 7263 302d 3e6e 655b 335d  03 = src0->ne[3]
-00045cb0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00045cc0: 3634 5f74 206e 6530 203d 2064 7374 2d3e  64_t ne0 = dst->
-00045cd0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-00045ce0: 2069 6e74 3634 5f74 206e 6531 203d 2064   int64_t ne1 = d
-00045cf0: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 2063  st->ne[1];.    c
-00045d00: 6f6e 7374 2069 6e74 3634 5f74 206e 6532  onst int64_t ne2
-00045d10: 203d 2064 7374 2d3e 6e65 5b32 5d3b 0a20   = dst->ne[2];. 
-00045d20: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00045d30: 206e 6533 203d 2064 7374 2d3e 6e65 5b33   ne3 = dst->ne[3
-00045d40: 5d3b 0a0a 2020 2020 4747 4d4c 5f41 5353  ];..    GGML_ASS
-00045d50: 4552 5428 6e65 3020 3d3d 2031 293b 0a20  ERT(ne0 == 1);. 
-00045d60: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00045d70: 6531 203d 3d20 6e65 3031 293b 0a20 2020  e1 == ne01);.   
-00045d80: 2047 474d 4c5f 4153 5345 5254 286e 6532   GGML_ASSERT(ne2
-00045d90: 203d 3d20 6e65 3032 293b 0a20 2020 2047   == ne02);.    G
-00045da0: 474d 4c5f 4153 5345 5254 286e 6533 203d  GML_ASSERT(ne3 =
-00045db0: 3d20 6e65 3033 293b 0a0a 2020 2020 636f  = ne03);..    co
-00045dc0: 6e73 7420 7369 7a65 5f74 206e 6230 3120  nst size_t nb01 
-00045dd0: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a20  = src0->nb[1];. 
-00045de0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00045df0: 6e62 3032 203d 2073 7263 302d 3e6e 625b  nb02 = src0->nb[
-00045e00: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
-00045e10: 7a65 5f74 206e 6230 3320 3d20 7372 6330  ze_t nb03 = src0
-00045e20: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
-00045e30: 6e73 7420 7369 7a65 5f74 206e 6231 203d  nst size_t nb1 =
-00045e40: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
-00045e50: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-00045e60: 3220 3d20 6473 742d 3e6e 625b 325d 3b0a  2 = dst->nb[2];.
-00045e70: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00045e80: 206e 6233 203d 2064 7374 2d3e 6e62 5b33   nb3 = dst->nb[3
-00045e90: 5d3b 0a0a 2020 2020 666f 7220 2869 6e74  ];..    for (int
-00045ea0: 3634 5f74 2069 3320 3d20 303b 2069 3320  64_t i3 = 0; i3 
-00045eb0: 3c20 6e65 3033 3b20 6933 2b2b 2920 7b0a  < ne03; i3++) {.
-00045ec0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00045ed0: 3634 5f74 2069 3220 3d20 303b 2069 3220  64_t i2 = 0; i2 
-00045ee0: 3c20 6e65 3032 3b20 6932 2b2b 2920 7b0a  < ne02; i2++) {.
-00045ef0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00045f00: 2869 6e74 3634 5f74 2069 3120 3d20 303b  (int64_t i1 = 0;
-00045f10: 2069 3120 3c20 6e65 3031 3b20 6931 2b2b   i1 < ne01; i1++
-00045f20: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00045f30: 2020 2020 666c 6f61 742a 2073 7263 5f72      float* src_r
-00045f40: 6f77 203d 2028 666c 6f61 7420 2a29 2028  ow = (float *) (
-00045f50: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-00045f60: 6174 6120 2b20 6931 2a6e 6230 3120 2b20  ata + i1*nb01 + 
-00045f70: 6932 2a6e 6230 3220 2b20 6933 2a6e 6230  i2*nb02 + i3*nb0
-00045f80: 3329 3b0a 2020 2020 2020 2020 2020 2020  3);.            
-00045f90: 2020 2020 666c 6f61 742a 2064 7374 5f72      float* dst_r
-00045fa0: 6f77 203d 2028 666c 6f61 7420 2a29 2028  ow = (float *) (
-00045fb0: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
-00045fc0: 7461 2020 2b20 6931 2a6e 6231 2020 2b20  ta  + i1*nb1  + 
-00045fd0: 6932 2a6e 6232 2020 2b20 6933 2a6e 6233  i2*nb2  + i3*nb3
-00045fe0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00045ff0: 2020 2066 6c6f 6174 2072 6f77 5f73 756d     float row_sum
-00046000: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
-00046010: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-00046020: 756d 5f66 3332 286e 6530 302c 2026 726f  um_f32(ne00, &ro
-00046030: 775f 7375 6d2c 2073 7263 5f72 6f77 293b  w_sum, src_row);
-00046040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046050: 2064 7374 5f72 6f77 5b30 5d20 3d20 726f   dst_row[0] = ro
-00046060: 775f 7375 6d3b 0a20 2020 2020 2020 2020  w_sum;.         
-00046070: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-00046080: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
-00046090: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-000460a0: 5f66 6f72 7761 7264 5f73 756d 5f72 6f77  _forward_sum_row
-000460b0: 7328 0a20 2020 2020 2020 2063 6f6e 7374  s(.        const
-000460c0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-000460d0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-000460e0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-000460f0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00046100: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-00046110: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00046120: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-00046130: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
-00046140: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
-00046150: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00046160: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-00046170: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00046180: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00046190: 7574 655f 666f 7277 6172 645f 7375 6d5f  ute_forward_sum_
-000461a0: 726f 7773 5f66 3332 2870 6172 616d 732c  rows_f32(params,
-000461b0: 2073 7263 302c 2064 7374 293b 0a20 2020   src0, dst);.   
-000461c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000461d0: 3b0a 2020 2020 2020 2020 6465 6661 756c  ;.        defaul
-000461e0: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
-000461f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046200: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00046210: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00046220: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00046230: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-00046240: 7465 5f66 6f72 7761 7264 5f6d 6561 6e0a  te_forward_mean.
-00046250: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00046260: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00046270: 645f 6d65 616e 5f66 3332 280a 2020 2020  d_mean_f32(.    
-00046280: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00046290: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-000462a0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-000462b0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-000462c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000462d0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-000462e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000462f0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-00046300: 6173 7365 7274 2870 6172 616d 732d 3e69  assert(params->i
-00046310: 7468 203d 3d20 3029 3b0a 0a20 2020 2069  th == 0);..    i
-00046320: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-00046330: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-00046340: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
-00046350: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00046360: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00046370: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-00046380: 0a0a 2020 2020 6173 7365 7274 2873 7263  ..    assert(src
-00046390: 302d 3e6e 625b 305d 203d 3d20 7369 7a65  0->nb[0] == size
-000463a0: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-000463b0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-000463c0: 6530 3020 3d20 7372 6330 2d3e 6e65 5b30  e00 = src0->ne[0
-000463d0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-000463e0: 3634 5f74 206e 6530 3120 3d20 7372 6330  64_t ne01 = src0
-000463f0: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
-00046400: 7374 2069 6e74 3634 5f74 206e 6530 3220  st int64_t ne02 
-00046410: 3d20 7372 6330 2d3e 6e65 5b32 5d3b 0a20  = src0->ne[2];. 
-00046420: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00046430: 206e 6530 3320 3d20 7372 6330 2d3e 6e65   ne03 = src0->ne
-00046440: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-00046450: 7369 7a65 5f74 206e 6230 3120 3d20 7372  size_t nb01 = sr
-00046460: 6330 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c0->nb[1];.    c
-00046470: 6f6e 7374 2073 697a 655f 7420 6e62 3032  onst size_t nb02
-00046480: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
-00046490: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-000464a0: 206e 6230 3320 3d20 7372 6330 2d3e 6e62   nb03 = src0->nb
-000464b0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-000464c0: 696e 7436 345f 7420 6e65 3020 3d20 6473  int64_t ne0 = ds
-000464d0: 742d 3e6e 655b 305d 3b0a 2020 2020 636f  t->ne[0];.    co
-000464e0: 6e73 7420 696e 7436 345f 7420 6e65 3120  nst int64_t ne1 
-000464f0: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
-00046500: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00046510: 6e65 3220 3d20 6473 742d 3e6e 655b 325d  ne2 = dst->ne[2]
-00046520: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00046530: 345f 7420 6e65 3320 3d20 6473 742d 3e6e  4_t ne3 = dst->n
-00046540: 655b 335d 3b0a 0a20 2020 2061 7373 6572  e[3];..    asser
-00046550: 7428 6e65 3020 3d3d 2031 293b 0a20 2020  t(ne0 == 1);.   
-00046560: 2061 7373 6572 7428 6e65 3120 3d3d 206e   assert(ne1 == n
-00046570: 6530 3129 3b0a 2020 2020 6173 7365 7274  e01);.    assert
-00046580: 286e 6532 203d 3d20 6e65 3032 293b 0a20  (ne2 == ne02);. 
-00046590: 2020 2061 7373 6572 7428 6e65 3320 3d3d     assert(ne3 ==
-000465a0: 206e 6530 3329 3b0a 0a20 2020 2055 4e55   ne03);..    UNU
-000465b0: 5345 4428 6e65 3029 3b0a 2020 2020 554e  SED(ne0);.    UN
-000465c0: 5553 4544 286e 6531 293b 0a20 2020 2055  USED(ne1);.    U
-000465d0: 4e55 5345 4428 6e65 3229 3b0a 2020 2020  NUSED(ne2);.    
-000465e0: 554e 5553 4544 286e 6533 293b 0a0a 2020  UNUSED(ne3);..  
-000465f0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00046600: 6231 203d 2064 7374 2d3e 6e62 5b31 5d3b  b1 = dst->nb[1];
-00046610: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00046620: 7420 6e62 3220 3d20 6473 742d 3e6e 625b  t nb2 = dst->nb[
-00046630: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
-00046640: 7a65 5f74 206e 6233 203d 2064 7374 2d3e  ze_t nb3 = dst->
-00046650: 6e62 5b33 5d3b 0a0a 2020 2020 666f 7220  nb[3];..    for 
-00046660: 2869 6e74 3634 5f74 2069 3033 203d 2030  (int64_t i03 = 0
-00046670: 3b20 6930 3320 3c20 6e65 3033 3b20 6930  ; i03 < ne03; i0
-00046680: 332b 2b29 207b 0a20 2020 2020 2020 2066  3++) {.        f
-00046690: 6f72 2028 696e 7436 345f 7420 6930 3220  or (int64_t i02 
-000466a0: 3d20 303b 2069 3032 203c 206e 6530 323b  = 0; i02 < ne02;
-000466b0: 2069 3032 2b2b 2920 7b0a 2020 2020 2020   i02++) {.      
-000466c0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-000466d0: 5f74 2069 3031 203d 2030 3b20 6930 3120  _t i01 = 0; i01 
-000466e0: 3c20 6e65 3031 3b20 6930 312b 2b29 207b  < ne01; i01++) {
-000466f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046700: 2067 676d 6c5f 7665 635f 7375 6d5f 6633   ggml_vec_sum_f3
-00046710: 3228 6e65 3030 2c0a 2020 2020 2020 2020  2(ne00,.        
-00046720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046730: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00046740: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
-00046750: 2069 3031 2a6e 6231 2020 2b20 6930 322a   i01*nb1  + i02*
-00046760: 6e62 3220 202b 2069 3033 2a6e 6233 292c  nb2  + i03*nb3),
-00046770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046780: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-00046790: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
-000467a0: 302d 3e64 6174 6120 2b20 6930 312a 6e62  0->data + i01*nb
-000467b0: 3031 202b 2069 3032 2a6e 6230 3220 2b20  01 + i02*nb02 + 
-000467c0: 6930 332a 6e62 3033 2929 3b0a 0a20 2020  i03*nb03));..   
-000467d0: 2020 2020 2020 2020 2020 2020 202a 2866               *(f
-000467e0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-000467f0: 2920 6473 742d 3e64 6174 6120 2b20 6930  ) dst->data + i0
-00046800: 312a 6e62 3120 2b20 6930 322a 6e62 3220  1*nb1 + i02*nb2 
-00046810: 2b20 6930 332a 6e62 3329 202f 3d20 2866  + i03*nb3) /= (f
-00046820: 6c6f 6174 2920 6e65 3030 3b0a 2020 2020  loat) ne00;.    
-00046830: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00046840: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
-00046850: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00046860: 6d70 7574 655f 666f 7277 6172 645f 6d65  mpute_forward_me
-00046870: 616e 280a 2020 2020 2020 2020 636f 6e73  an(.        cons
-00046880: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00046890: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-000468a0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-000468b0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000468c0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-000468d0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000468e0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-000468f0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00046900: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00046910: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00046920: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-00046930: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00046940: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00046950: 7075 7465 5f66 6f72 7761 7264 5f6d 6561  pute_forward_mea
-00046960: 6e5f 6633 3228 7061 7261 6d73 2c20 7372  n_f32(params, sr
-00046970: 6330 2c20 6473 7429 3b0a 2020 2020 2020  c0, dst);.      
-00046980: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00046990: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
-000469a0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000469b0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-000469c0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-000469d0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000469e0: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-000469f0: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
-00046a00: 666f 7277 6172 645f 7265 7065 6174 0a0a  forward_repeat..
-00046a10: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-00046a20: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00046a30: 5f72 6570 6561 745f 6633 3228 0a20 2020  _repeat_f32(.   
-00046a40: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00046a50: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-00046a60: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00046a70: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00046a80: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00046a90: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00046aa0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00046ab0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00046ac0: 2047 474d 4c5f 4153 5345 5254 2870 6172   GGML_ASSERT(par
-00046ad0: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
-00046ae0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00046af0: 6767 6d6c 5f63 616e 5f72 6570 6561 7428  ggml_can_repeat(
-00046b00: 7372 6330 2c20 6473 7429 293b 0a0a 2020  src0, dst));..  
-00046b10: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-00046b20: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00046b30: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
-00046b40: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00046b50: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-00046b60: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00046b70: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
-00046b80: 6e74 3634 5f74 206e 6530 2020 3d20 6473  nt64_t ne0  = ds
-00046b90: 742d 3e6e 655b 305d 3b0a 2020 2020 636f  t->ne[0];.    co
-00046ba0: 6e73 7420 696e 7436 345f 7420 6e65 3120  nst int64_t ne1 
-00046bb0: 203d 2064 7374 2d3e 6e65 5b31 5d3b 0a20   = dst->ne[1];. 
-00046bc0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00046bd0: 206e 6532 2020 3d20 6473 742d 3e6e 655b   ne2  = dst->ne[
-00046be0: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
-00046bf0: 7436 345f 7420 6e65 3320 203d 2064 7374  t64_t ne3  = dst
-00046c00: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
-00046c10: 6e73 7420 696e 7436 345f 7420 6e65 3030  nst int64_t ne00
-00046c20: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
-00046c30: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00046c40: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
-00046c50: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-00046c60: 696e 7436 345f 7420 6e65 3032 203d 2073  int64_t ne02 = s
-00046c70: 7263 302d 3e6e 655b 325d 3b0a 2020 2020  rc0->ne[2];.    
-00046c80: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00046c90: 3033 203d 2073 7263 302d 3e6e 655b 335d  03 = src0->ne[3]
-00046ca0: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
-00046cb0: 655f 7420 6e62 3020 203d 2064 7374 2d3e  e_t nb0  = dst->
-00046cc0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-00046cd0: 2073 697a 655f 7420 6e62 3120 203d 2064   size_t nb1  = d
-00046ce0: 7374 2d3e 6e62 5b31 5d3b 0a20 2020 2063  st->nb[1];.    c
-00046cf0: 6f6e 7374 2073 697a 655f 7420 6e62 3220  onst size_t nb2 
-00046d00: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
-00046d10: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00046d20: 6e62 3320 203d 2064 7374 2d3e 6e62 5b33  nb3  = dst->nb[3
-00046d30: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
-00046d40: 7a65 5f74 206e 6230 3020 3d20 7372 6330  ze_t nb00 = src0
-00046d50: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-00046d60: 7374 2073 697a 655f 7420 6e62 3031 203d  st size_t nb01 =
-00046d70: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
-00046d80: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00046d90: 6230 3220 3d20 7372 6330 2d3e 6e62 5b32  b02 = src0->nb[2
-00046da0: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-00046db0: 655f 7420 6e62 3033 203d 2073 7263 302d  e_t nb03 = src0-
-00046dc0: 3e6e 625b 335d 3b0a 0a20 2020 202f 2f20  >nb[3];..    // 
-00046dd0: 6775 6172 616e 7465 6564 2074 6f20 6265  guaranteed to be
-00046de0: 2061 6e20 696e 7465 6765 7220 6475 6520   an integer due 
-00046df0: 746f 2074 6865 2063 6865 636b 2069 6e20  to the check in 
-00046e00: 6767 6d6c 5f63 616e 5f72 6570 6561 740a  ggml_can_repeat.
-00046e10: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-00046e20: 3020 3d20 2869 6e74 2928 6e65 302f 6e65  0 = (int)(ne0/ne
-00046e30: 3030 293b 0a20 2020 2063 6f6e 7374 2069  00);.    const i
-00046e40: 6e74 206e 7231 203d 2028 696e 7429 286e  nt nr1 = (int)(n
-00046e50: 6531 2f6e 6530 3129 3b0a 2020 2020 636f  e1/ne01);.    co
-00046e60: 6e73 7420 696e 7420 6e72 3220 3d20 2869  nst int nr2 = (i
-00046e70: 6e74 2928 6e65 322f 6e65 3032 293b 0a20  nt)(ne2/ne02);. 
-00046e80: 2020 2063 6f6e 7374 2069 6e74 206e 7233     const int nr3
-00046e90: 203d 2028 696e 7429 286e 6533 2f6e 6530   = (int)(ne3/ne0
-00046ea0: 3329 3b0a 0a20 2020 202f 2f20 544f 444f  3);..    // TODO
-00046eb0: 3a20 7375 7070 6f72 7420 666f 7220 7472  : support for tr
-00046ec0: 616e 7370 6f73 6564 202f 2070 6572 6d75  ansposed / permu
-00046ed0: 7465 6420 7465 6e73 6f72 730a 2020 2020  ted tensors.    
-00046ee0: 4747 4d4c 5f41 5353 4552 5428 6e62 3020  GGML_ASSERT(nb0 
-00046ef0: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-00046f00: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00046f10: 4552 5428 6e62 3030 203d 3d20 7369 7a65  ERT(nb00 == size
-00046f20: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-00046f30: 202f 2f20 544f 444f 3a20 6d61 7962 6520   // TODO: maybe 
-00046f40: 7468 6973 2069 7320 6e6f 7420 6f70 7469  this is not opti
-00046f50: 6d61 6c3f 0a20 2020 2066 6f72 2020 2020  mal?.    for    
-00046f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046f70: 2020 2020 2028 696e 7420 6933 203d 2030       (int i3 = 0
-00046f80: 3b20 6933 203c 206e 7233 3b20 2069 332b  ; i3 < nr3;  i3+
-00046f90: 2b29 207b 0a20 2020 2020 2020 2066 6f72  +) {.        for
-00046fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046fb0: 2020 2020 2028 696e 7420 6b33 203d 2030       (int k3 = 0
-00046fc0: 3b20 6b33 203c 206e 6530 333b 206b 332b  ; k3 < ne03; k3+
-00046fd0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00046fe0: 2066 6f72 2020 2020 2020 2020 2020 2020   for            
-00046ff0: 2020 2020 2028 696e 7420 6932 203d 2030       (int i2 = 0
-00047000: 3b20 6932 203c 206e 7232 3b20 2069 322b  ; i2 < nr2;  i2+
-00047010: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00047020: 2020 2020 2066 6f72 2020 2020 2020 2020       for        
-00047030: 2020 2020 2028 696e 7420 6b32 203d 2030       (int k2 = 0
-00047040: 3b20 6b32 203c 206e 6530 323b 206b 322b  ; k2 < ne02; k2+
-00047050: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00047060: 2020 2020 2020 2020 2066 6f72 2020 2020           for    
-00047070: 2020 2020 2028 696e 7420 6931 203d 2030       (int i1 = 0
-00047080: 3b20 6931 203c 206e 7231 3b20 2069 312b  ; i1 < nr1;  i1+
-00047090: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-000470a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000470b0: 2020 2020 2028 696e 7420 6b31 203d 2030       (int k1 = 0
-000470c0: 3b20 6b31 203c 206e 6530 313b 206b 312b  ; k1 < ne01; k1+
-000470d0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0003b1e0: 2020 6931 3320 3d20 303b 0a20 2020 2020    i13 = 0;.     
+0003b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b200: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0003b210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b230: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0003b240: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0003b250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b260: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0003b270: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0003b280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b290: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0003b2a0: 2020 2069 3130 202b 3d20 6e65 3030 202a     i10 += ne00 *
+0003b2b0: 2028 6e65 3031 202d 2069 7231 293b 0a20   (ne01 - ir1);. 
+0003b2c0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0003b2d0: 6869 6c65 2028 6931 3020 3e3d 206e 6530  hile (i10 >= ne0
+0003b2e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0003b2f0: 2020 2020 2020 2020 6931 3020 2d3d 206e          i10 -= n
+0003b300: 6530 3b0a 2020 2020 2020 2020 2020 2020  e0;.            
+0003b310: 2020 2020 2020 2020 6966 2028 2b2b 6931          if (++i1
+0003b320: 3120 3d3d 206e 6531 2920 7b0a 2020 2020  1 == ne1) {.    
+0003b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b340: 2020 2020 6931 3120 3d20 303b 0a20 2020      i11 = 0;.   
+0003b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b360: 2020 2020 2069 6620 282b 2b69 3132 203d       if (++i12 =
+0003b370: 3d20 6e65 3229 207b 0a20 2020 2020 2020  = ne2) {.       
+0003b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b390: 2020 2020 2069 3132 203d 2030 3b0a 2020       i12 = 0;.  
+0003b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b3b0: 2020 2020 2020 2020 2020 6966 2028 2b2b            if (++
+0003b3c0: 6931 3320 3d3d 206e 6533 2920 7b0a 2020  i13 == ne3) {.  
+0003b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b3e0: 2020 2020 2020 2020 2020 2020 2020 6931                i1
+0003b3f0: 3320 3d20 303b 0a20 2020 2020 2020 2020  3 = 0;.         
+0003b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b410: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0003b420: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0003b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b440: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0003b450: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0003b460: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
+0003b470: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0003b480: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0003b490: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
+0003b4a0: 2069 6d70 6c65 6d65 6e74 0a20 2020 207d   implement.    }
+0003b4b0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+0003b4c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+0003b4d0: 7761 7264 5f64 7570 280a 2020 2020 2020  ward_dup(.      
+0003b4e0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0003b4f0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+0003b500: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+0003b510: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0003b520: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0003b530: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
+0003b540: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0003b550: 202a 2064 7374 2920 7b0a 2020 2020 6966   * dst) {.    if
+0003b560: 2028 6767 6d6c 5f69 735f 636f 6e74 6967   (ggml_is_contig
+0003b570: 756f 7573 2873 7263 3029 2026 2620 6767  uous(src0) && gg
+0003b580: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
+0003b590: 2864 7374 2920 2626 2073 7263 302d 3e74  (dst) && src0->t
+0003b5a0: 7970 6520 3d3d 2064 7374 2d3e 7479 7065  ype == dst->type
+0003b5b0: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
+0003b5c0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0003b5d0: 5f64 7570 5f73 616d 655f 636f 6e74 2870  _dup_same_cont(p
+0003b5e0: 6172 616d 732c 2073 7263 302c 2064 7374  arams, src0, dst
+0003b5f0: 293b 0a20 2020 2020 2020 2072 6574 7572  );.        retur
+0003b600: 6e3b 0a20 2020 207d 0a20 2020 2073 7769  n;.    }.    swi
+0003b610: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
+0003b620: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+0003b630: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+0003b640: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0003b650: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0003b660: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0003b670: 645f 6475 705f 6631 3628 7061 7261 6d73  d_dup_f16(params
+0003b680: 2c20 7372 6330 2c20 6473 7429 3b0a 2020  , src0, dst);.  
+0003b690: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0003b6a0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0003b6b0: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
+0003b6c0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0003b6d0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0003b6e0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0003b6f0: 645f 6475 705f 6633 3228 7061 7261 6d73  d_dup_f32(params
+0003b700: 2c20 7372 6330 2c20 6473 7429 3b0a 2020  , src0, dst);.  
+0003b710: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0003b720: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
+0003b730: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+0003b740: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003b750: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0003b760: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+0003b770: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
+0003b780: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
+0003b790: 7574 655f 666f 7277 6172 645f 6164 640a  ute_forward_add.
+0003b7a0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+0003b7b0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0003b7c0: 645f 6164 645f 6633 3228 0a20 2020 2020  d_add_f32(.     
+0003b7d0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0003b7e0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+0003b7f0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+0003b800: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0003b810: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0003b820: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+0003b830: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0003b840: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+0003b850: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0003b860: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+0003b870: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+0003b880: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
+0003b890: 655f 7368 6170 6528 7372 6330 2c20 7372  e_shape(src0, sr
+0003b8a0: 6331 2920 2626 2067 676d 6c5f 6172 655f  c1) && ggml_are_
+0003b8b0: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
+0003b8c0: 2064 7374 2929 3b0a 0a20 2020 2069 6620   dst));..    if 
+0003b8d0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+0003b8e0: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
+0003b8f0: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
+0003b900: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+0003b910: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+0003b920: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+0003b930: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+0003b940: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+0003b950: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0003b960: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+0003b970: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0003b980: 206e 7220 203d 2067 676d 6c5f 6e72 6f77   nr  = ggml_nrow
+0003b990: 7328 7372 6330 293b 0a20 2020 2063 6f6e  s(src0);.    con
+0003b9a0: 7374 2069 6e74 3634 5f74 206e 6530 203d  st int64_t ne0 =
+0003b9b0: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
+0003b9c0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+0003b9d0: 6e65 3120 3d20 7372 6330 2d3e 6e65 5b31  ne1 = src0->ne[1
+0003b9e0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0003b9f0: 3634 5f74 206e 6532 203d 2073 7263 302d  64_t ne2 = src0-
+0003ba00: 3e6e 655b 325d 3b0a 0a20 2020 2063 6f6e  >ne[2];..    con
+0003ba10: 7374 2073 697a 655f 7420 6e62 3030 203d  st size_t nb00 =
+0003ba20: 2073 7263 302d 3e6e 625b 305d 3b0a 2020   src0->nb[0];.  
+0003ba30: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0003ba40: 6230 3120 3d20 7372 6330 2d3e 6e62 5b31  b01 = src0->nb[1
+0003ba50: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+0003ba60: 655f 7420 6e62 3032 203d 2073 7263 302d  e_t nb02 = src0-
+0003ba70: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
+0003ba80: 7420 7369 7a65 5f74 206e 6230 3320 3d20  t size_t nb03 = 
+0003ba90: 7372 6330 2d3e 6e62 5b33 5d3b 0a0a 2020  src0->nb[3];..  
+0003baa0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0003bab0: 6231 3020 3d20 7372 6331 2d3e 6e62 5b30  b10 = src1->nb[0
+0003bac0: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+0003bad0: 655f 7420 6e62 3131 203d 2073 7263 312d  e_t nb11 = src1-
+0003bae0: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+0003baf0: 7420 7369 7a65 5f74 206e 6231 3220 3d20  t size_t nb12 = 
+0003bb00: 7372 6331 2d3e 6e62 5b32 5d3b 0a20 2020  src1->nb[2];.   
+0003bb10: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+0003bb20: 3133 203d 2073 7263 312d 3e6e 625b 335d  13 = src1->nb[3]
+0003bb30: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
+0003bb40: 655f 7420 6e62 3020 3d20 6473 742d 3e6e  e_t nb0 = dst->n
+0003bb50: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+0003bb60: 7369 7a65 5f74 206e 6231 203d 2064 7374  size_t nb1 = dst
+0003bb70: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
+0003bb80: 7374 2073 697a 655f 7420 6e62 3220 3d20  st size_t nb2 = 
+0003bb90: 6473 742d 3e6e 625b 325d 3b0a 2020 2020  dst->nb[2];.    
+0003bba0: 636f 6e73 7420 7369 7a65 5f74 206e 6233  const size_t nb3
+0003bbb0: 203d 2064 7374 2d3e 6e62 5b33 5d3b 0a0a   = dst->nb[3];..
+0003bbc0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0003bbd0: 206e 6230 203d 3d20 7369 7a65 6f66 2866   nb0 == sizeof(f
+0003bbe0: 6c6f 6174 2929 3b0a 2020 2020 4747 4d4c  loat));.    GGML
+0003bbf0: 5f41 5353 4552 5428 6e62 3030 203d 3d20  _ASSERT(nb00 == 
+0003bc00: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+0003bc10: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
+0003bc20: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+0003bc30: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
+0003bc40: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
+0003bc50: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
+0003bc60: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
+0003bc70: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+0003bc80: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
+0003bc90: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
+0003bca0: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
+0003bcb0: 7229 3b0a 0a20 2020 2069 6620 286e 6231  r);..    if (nb1
+0003bcc0: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
+0003bcd0: 7429 2920 7b0a 2020 2020 2020 2020 666f  t)) {.        fo
+0003bce0: 7220 2869 6e74 2069 7220 3d20 6972 303b  r (int ir = ir0;
+0003bcf0: 2069 7220 3c20 6972 313b 202b 2b69 7229   ir < ir1; ++ir)
+0003bd00: 207b 0a20 2020 2020 2020 2020 2020 202f   {.            /
+0003bd10: 2f20 7372 6330 2c20 7372 6331 2061 6e64  / src0, src1 and
+0003bd20: 2064 7374 2061 7265 2073 616d 6520 7368   dst are same sh
+0003bd30: 6170 6520 3d3e 2073 616d 6520 696e 6469  ape => same indi
+0003bd40: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
+0003bd50: 636f 6e73 7420 696e 7420 6933 203d 2069  const int i3 = i
+0003bd60: 722f 286e 6532 2a6e 6531 293b 0a20 2020  r/(ne2*ne1);.   
+0003bd70: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+0003bd80: 6e74 2069 3220 3d20 2869 7220 2d20 6933  nt i2 = (ir - i3
+0003bd90: 2a6e 6532 2a6e 6531 292f 6e65 313b 0a20  *ne2*ne1)/ne1;. 
+0003bda0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0003bdb0: 2069 6e74 2069 3120 3d20 2869 7220 2d20   int i1 = (ir - 
+0003bdc0: 6933 2a6e 6532 2a6e 6531 202d 2069 322a  i3*ne2*ne1 - i2*
+0003bdd0: 6e65 3129 3b0a 0a0a 2369 6664 6566 2047  ne1);...#ifdef G
+0003bde0: 474d 4c5f 5553 455f 4143 4345 4c45 5241  GML_USE_ACCELERA
+0003bdf0: 5445 0a20 2020 2020 2020 2020 2020 2076  TE.            v
+0003be00: 4453 505f 7661 6464 280a 2020 2020 2020  DSP_vadd(.      
+0003be10: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+0003be20: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+0003be30: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
+0003be40: 332a 6e62 3033 202b 2069 322a 6e62 3032  3*nb03 + i2*nb02
+0003be50: 202b 2069 312a 6e62 3031 292c 2031 2c0a   + i1*nb01), 1,.
+0003be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003be70: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+0003be80: 6368 6172 202a 2920 7372 6331 2d3e 6461  char *) src1->da
+0003be90: 7461 202b 2069 332a 6e62 3133 202b 2069  ta + i3*nb13 + i
+0003bea0: 322a 6e62 3132 202b 2069 312a 6e62 3131  2*nb12 + i1*nb11
+0003beb0: 292c 2031 2c0a 2020 2020 2020 2020 2020  ), 1,.          
+0003bec0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+0003bed0: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
+0003bee0: 742d 3e64 6174 6120 202b 2069 332a 6e62  t->data  + i3*nb
+0003bef0: 3320 202b 2069 322a 6e62 3220 202b 2069  3  + i2*nb2  + i
+0003bf00: 312a 6e62 3120 292c 2031 2c0a 2020 2020  1*nb1 ), 1,.    
+0003bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bf20: 6e65 3029 3b0a 2365 6c73 650a 2020 2020  ne0);.#else.    
+0003bf30: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0003bf40: 5f61 6464 5f66 3332 286e 6530 2c0a 2020  _add_f32(ne0,.  
+0003bf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bf60: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+0003bf70: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+0003bf80: 202b 2069 332a 6e62 3320 202b 2069 322a   + i3*nb3  + i2*
+0003bf90: 6e62 3220 202b 2069 312a 6e62 3120 292c  nb2  + i1*nb1 ),
+0003bfa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bfb0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+0003bfc0: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
+0003bfd0: 6174 6120 2b20 6933 2a6e 6230 3320 2b20  ata + i3*nb03 + 
+0003bfe0: 6932 2a6e 6230 3220 2b20 6931 2a6e 6230  i2*nb02 + i1*nb0
+0003bff0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+0003c000: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+0003c010: 2920 2828 6368 6172 202a 2920 7372 6331  ) ((char *) src1
+0003c020: 2d3e 6461 7461 202b 2069 332a 6e62 3133  ->data + i3*nb13
+0003c030: 202b 2069 322a 6e62 3132 202b 2069 312a   + i2*nb12 + i1*
+0003c040: 6e62 3131 2929 3b0a 2365 6e64 6966 0a20  nb11));.#endif. 
+0003c050: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0003c060: 2f20 7d0a 2020 2020 2020 2020 2020 2020  / }.            
+0003c070: 2f2f 207d 0a20 2020 2020 2020 207d 0a20  // }.        }. 
+0003c080: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0003c090: 2020 2020 2f2f 2073 7263 3120 6973 206e      // src1 is n
+0003c0a0: 6f74 2063 6f6e 7469 6775 6f75 730a 2020  ot contiguous.  
+0003c0b0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0003c0c0: 7220 3d20 6972 303b 2069 7220 3c20 6972  r = ir0; ir < ir
+0003c0d0: 313b 202b 2b69 7229 207b 0a20 2020 2020  1; ++ir) {.     
+0003c0e0: 2020 2020 2020 202f 2f20 7372 6330 2c20         // src0, 
+0003c0f0: 7372 6331 2061 6e64 2064 7374 2061 7265  src1 and dst are
+0003c100: 2073 616d 6520 7368 6170 6520 3d3e 2073   same shape => s
+0003c110: 616d 6520 696e 6469 6365 730a 2020 2020  ame indices.    
+0003c120: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0003c130: 7420 6933 203d 2069 722f 286e 6532 2a6e  t i3 = ir/(ne2*n
+0003c140: 6531 293b 0a20 2020 2020 2020 2020 2020  e1);.           
+0003c150: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
+0003c160: 2869 7220 2d20 6933 2a6e 6532 2a6e 6531  (ir - i3*ne2*ne1
+0003c170: 292f 6e65 313b 0a20 2020 2020 2020 2020  )/ne1;.         
+0003c180: 2020 2063 6f6e 7374 2069 6e74 2069 3120     const int i1 
+0003c190: 3d20 2869 7220 2d20 6933 2a6e 6532 2a6e  = (ir - i3*ne2*n
+0003c1a0: 6531 202d 2069 322a 6e65 3129 3b0a 0a20  e1 - i2*ne1);.. 
+0003c1b0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+0003c1c0: 202a 2064 7374 5f70 7472 2020 3d20 2866   * dst_ptr  = (f
+0003c1d0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+0003c1e0: 2920 6473 742d 3e64 6174 6120 202b 2069  ) dst->data  + i
+0003c1f0: 332a 6e62 3320 202b 2069 322a 6e62 3220  3*nb3  + i2*nb2 
+0003c200: 202b 2069 312a 6e62 3120 293b 0a20 2020   + i1*nb1 );.   
+0003c210: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+0003c220: 2073 7263 305f 7074 7220 3d20 2866 6c6f   src0_ptr = (flo
+0003c230: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+0003c240: 7372 6330 2d3e 6461 7461 202b 2069 332a  src0->data + i3*
+0003c250: 6e62 3033 202b 2069 322a 6e62 3032 202b  nb03 + i2*nb02 +
+0003c260: 2069 312a 6e62 3031 293b 0a20 2020 2020   i1*nb01);.     
+0003c270: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+0003c280: 6930 203d 2030 3b20 6930 203c 206e 6530  i0 = 0; i0 < ne0
+0003c290: 3b20 6930 2b2b 2920 7b0a 2020 2020 2020  ; i0++) {.      
+0003c2a0: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+0003c2b0: 2a20 7372 6331 5f70 7472 203d 2028 666c  * src1_ptr = (fl
+0003c2c0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+0003c2d0: 2073 7263 312d 3e64 6174 6120 2b20 6933   src1->data + i3
+0003c2e0: 2a6e 6231 3320 2b20 6932 2a6e 6231 3220  *nb13 + i2*nb12 
+0003c2f0: 2b20 6931 2a6e 6231 3120 2b20 6930 2a6e  + i1*nb11 + i0*n
+0003c300: 6231 3029 3b0a 0a20 2020 2020 2020 2020  b10);..         
+0003c310: 2020 2020 2020 2064 7374 5f70 7472 5b69         dst_ptr[i
+0003c320: 305d 203d 2073 7263 305f 7074 725b 6930  0] = src0_ptr[i0
+0003c330: 5d20 2b20 2a73 7263 315f 7074 723b 0a20  ] + *src1_ptr;. 
+0003c340: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0003c350: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
+0003c360: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+0003c370: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0003c380: 5f61 6464 5f66 3136 5f66 3332 280a 2020  _add_f16_f32(.  
+0003c390: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0003c3a0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+0003c3b0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+0003c3c0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0003c3d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0003c3e0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+0003c3f0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0003c400: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+0003c410: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
+0003c420: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0003c430: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
+0003c440: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
+0003c450: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
+0003c460: 2073 7263 3129 2026 2620 6767 6d6c 5f61   src1) && ggml_a
+0003c470: 7265 5f73 616d 655f 7368 6170 6528 7372  re_same_shape(sr
+0003c480: 6330 2c20 6473 7429 293b 0a0a 2020 2020  c0, dst));..    
+0003c490: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+0003c4a0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+0003c4b0: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
+0003c4c0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+0003c4d0: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+0003c4e0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+0003c4f0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
+0003c500: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
+0003c510: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+0003c520: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
+0003c530: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
+0003c540: 696e 7420 6e72 2020 3d20 6767 6d6c 5f6e  int nr  = ggml_n
+0003c550: 726f 7773 2873 7263 3029 3b0a 2020 2020  rows(src0);.    
+0003c560: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0003c570: 3020 3d20 7372 6330 2d3e 6e65 5b30 5d3b  0 = src0->ne[0];
+0003c580: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0003c590: 5f74 206e 6531 203d 2073 7263 302d 3e6e  _t ne1 = src0->n
+0003c5a0: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
+0003c5b0: 696e 7436 345f 7420 6e65 3220 3d20 7372  int64_t ne2 = sr
+0003c5c0: 6330 2d3e 6e65 5b32 5d3b 0a0a 2020 2020  c0->ne[2];..    
+0003c5d0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+0003c5e0: 3020 3d20 7372 6330 2d3e 6e62 5b30 5d3b  0 = src0->nb[0];
+0003c5f0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0003c600: 7420 6e62 3031 203d 2073 7263 302d 3e6e  t nb01 = src0->n
+0003c610: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+0003c620: 7369 7a65 5f74 206e 6230 3220 3d20 7372  size_t nb02 = sr
+0003c630: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 2063  c0->nb[2];.    c
+0003c640: 6f6e 7374 2073 697a 655f 7420 6e62 3033  onst size_t nb03
+0003c650: 203d 2073 7263 302d 3e6e 625b 335d 3b0a   = src0->nb[3];.
+0003c660: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0003c670: 7420 6e62 3130 203d 2073 7263 312d 3e6e  t nb10 = src1->n
+0003c680: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+0003c690: 7369 7a65 5f74 206e 6231 3120 3d20 7372  size_t nb11 = sr
+0003c6a0: 6331 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c1->nb[1];.    c
+0003c6b0: 6f6e 7374 2073 697a 655f 7420 6e62 3132  onst size_t nb12
+0003c6c0: 203d 2073 7263 312d 3e6e 625b 325d 3b0a   = src1->nb[2];.
+0003c6d0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0003c6e0: 206e 6231 3320 3d20 7372 6331 2d3e 6e62   nb13 = src1->nb
+0003c6f0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+0003c700: 7369 7a65 5f74 206e 6230 203d 2064 7374  size_t nb0 = dst
+0003c710: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+0003c720: 7374 2073 697a 655f 7420 6e62 3120 3d20  st size_t nb1 = 
+0003c730: 6473 742d 3e6e 625b 315d 3b0a 2020 2020  dst->nb[1];.    
+0003c740: 636f 6e73 7420 7369 7a65 5f74 206e 6232  const size_t nb2
+0003c750: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
+0003c760: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0003c770: 6e62 3320 3d20 6473 742d 3e6e 625b 335d  nb3 = dst->nb[3]
+0003c780: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+0003c790: 5254 2873 7263 302d 3e74 7970 6520 3d3d  RT(src0->type ==
+0003c7a0: 2047 474d 4c5f 5459 5045 5f46 3136 293b   GGML_TYPE_F16);
+0003c7b0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0003c7c0: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
+0003c7d0: 474d 4c5f 5459 5045 5f46 3332 293b 0a20  GML_TYPE_F32);. 
+0003c7e0: 2020 2047 474d 4c5f 4153 5345 5254 2864     GGML_ASSERT(d
+0003c7f0: 7374 2d3e 7479 7065 203d 3d20 4747 4d4c  st->type == GGML
+0003c800: 5f54 5950 455f 4631 3629 3b0a 0a20 2020  _TYPE_F16);..   
+0003c810: 2047 474d 4c5f 4153 5345 5254 2820 6e62   GGML_ASSERT( nb
+0003c820: 3020 3d3d 2073 697a 656f 6628 6767 6d6c  0 == sizeof(ggml
+0003c830: 5f66 7031 365f 7429 293b 0a20 2020 2047  _fp16_t));.    G
+0003c840: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
+0003c850: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
+0003c860: 7031 365f 7429 293b 0a0a 2020 2020 2f2f  p16_t));..    //
+0003c870: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
+0003c880: 0a20 2020 2063 6f6e 7374 2069 6e74 2064  .    const int d
+0003c890: 7220 3d20 286e 7220 2b20 6e74 6820 2d20  r = (nr + nth - 
+0003c8a0: 3129 2f6e 7468 3b0a 0a20 2020 202f 2f20  1)/nth;..    // 
+0003c8b0: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
+0003c8c0: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
+0003c8d0: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
+0003c8e0: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
+0003c8f0: 696e 7420 6972 3120 3d20 4d49 4e28 6972  int ir1 = MIN(ir
+0003c900: 3020 2b20 6472 2c20 6e72 293b 0a0a 2020  0 + dr, nr);..  
+0003c910: 2020 6966 2028 6e62 3130 203d 3d20 7369    if (nb10 == si
+0003c920: 7a65 6f66 2866 6c6f 6174 2929 207b 0a20  zeof(float)) {. 
+0003c930: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+0003c940: 6972 203d 2069 7230 3b20 6972 203c 2069  ir = ir0; ir < i
+0003c950: 7231 3b20 2b2b 6972 2920 7b0a 2020 2020  r1; ++ir) {.    
+0003c960: 2020 2020 2020 2020 2f2f 2073 7263 302c          // src0,
+0003c970: 2073 7263 3120 616e 6420 6473 7420 6172   src1 and dst ar
+0003c980: 6520 7361 6d65 2073 6861 7065 203d 3e20  e same shape => 
+0003c990: 7361 6d65 2069 6e64 6963 6573 0a20 2020  same indices.   
+0003c9a0: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+0003c9b0: 6e74 2069 3320 3d20 6972 2f28 6e65 322a  nt i3 = ir/(ne2*
+0003c9c0: 6e65 3129 3b0a 2020 2020 2020 2020 2020  ne1);.          
+0003c9d0: 2020 636f 6e73 7420 696e 7420 6932 203d    const int i2 =
+0003c9e0: 2028 6972 202d 2069 332a 6e65 322a 6e65   (ir - i3*ne2*ne
+0003c9f0: 3129 2f6e 6531 3b0a 2020 2020 2020 2020  1)/ne1;.        
+0003ca00: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
+0003ca10: 203d 2028 6972 202d 2069 332a 6e65 322a   = (ir - i3*ne2*
+0003ca20: 6e65 3120 2d20 6932 2a6e 6531 293b 0a0a  ne1 - i2*ne1);..
+0003ca30: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0003ca40: 5f66 7031 365f 7420 2a20 6473 745f 7074  _fp16_t * dst_pt
+0003ca50: 7220 203d 2028 6767 6d6c 5f66 7031 365f  r  = (ggml_fp16_
+0003ca60: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
+0003ca70: 7374 2d3e 6461 7461 2020 2b20 6933 2a6e  st->data  + i3*n
+0003ca80: 6233 2020 2b20 6932 2a6e 6232 2020 2b20  b3  + i2*nb2  + 
+0003ca90: 6931 2a6e 6231 293b 0a20 2020 2020 2020  i1*nb1);.       
+0003caa0: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+0003cab0: 202a 2073 7263 305f 7074 7220 3d20 2867   * src0_ptr = (g
+0003cac0: 676d 6c5f 6670 3136 5f74 202a 2920 2828  gml_fp16_t *) ((
+0003cad0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
+0003cae0: 7461 202b 2069 332a 6e62 3033 202b 2069  ta + i3*nb03 + i
+0003caf0: 322a 6e62 3032 202b 2069 312a 6e62 3031  2*nb02 + i1*nb01
+0003cb00: 293b 0a20 2020 2020 2020 2020 2020 2066  );.            f
+0003cb10: 6c6f 6174 202a 2020 2020 2020 2073 7263  loat *       src
+0003cb20: 315f 7074 7220 3d20 2866 6c6f 6174 202a  1_ptr = (float *
+0003cb30: 2920 2020 2020 2020 2828 6368 6172 202a  )       ((char *
+0003cb40: 2920 7372 6331 2d3e 6461 7461 202b 2069  ) src1->data + i
+0003cb50: 332a 6e62 3133 202b 2069 322a 6e62 3132  3*nb13 + i2*nb12
+0003cb60: 202b 2069 312a 6e62 3131 293b 0a0a 2020   + i1*nb11);..  
+0003cb70: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0003cb80: 6e74 2069 203d 2030 3b20 6920 3c20 6e65  nt i = 0; i < ne
+0003cb90: 303b 2069 2b2b 2920 7b0a 2020 2020 2020  0; i++) {.      
+0003cba0: 2020 2020 2020 2020 2020 6473 745f 7074            dst_pt
+0003cbb0: 725b 695d 203d 2047 474d 4c5f 4650 3332  r[i] = GGML_FP32
+0003cbc0: 5f54 4f5f 4650 3136 2847 474d 4c5f 4650  _TO_FP16(GGML_FP
+0003cbd0: 3136 5f54 4f5f 4650 3332 2873 7263 305f  16_TO_FP32(src0_
+0003cbe0: 7074 725b 695d 2920 2b20 7372 6331 5f70  ptr[i]) + src1_p
+0003cbf0: 7472 5b69 5d29 3b0a 2020 2020 2020 2020  tr[i]);.        
+0003cc00: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+0003cc10: 2020 2020 7d0a 2020 2020 656c 7365 207b      }.    else {
+0003cc20: 0a20 2020 2020 2020 202f 2f20 7372 6331  .        // src1
+0003cc30: 2069 7320 6e6f 7420 636f 6e74 6967 756f   is not contiguo
+0003cc40: 7573 0a20 2020 2020 2020 2047 474d 4c5f  us.        GGML_
+0003cc50: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+0003cc60: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
+0003cc70: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+0003cc80: 5f66 6f72 7761 7264 5f61 6464 5f66 3136  _forward_add_f16
+0003cc90: 5f66 3136 280a 2020 2020 2020 2020 636f  _f16(.        co
+0003cca0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0003ccb0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+0003ccc0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+0003ccd0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0003cce0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+0003ccf0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0003cd00: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0003cd10: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+0003cd20: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0003cd30: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+0003cd40: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+0003cd50: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
+0003cd60: 7065 2873 7263 302c 2073 7263 3129 2026  pe(src0, src1) &
+0003cd70: 2620 6767 6d6c 5f61 7265 5f73 616d 655f  & ggml_are_same_
+0003cd80: 7368 6170 6528 7372 6330 2c20 6473 7429  shape(src0, dst)
+0003cd90: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
+0003cda0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+0003cdb0: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
+0003cdc0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+0003cdd0: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
+0003cde0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+0003cdf0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2063  rn;.    }..    c
+0003ce00: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
+0003ce10: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
+0003ce20: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
+0003ce30: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
+0003ce40: 2020 636f 6e73 7420 696e 7420 6e72 2020    const int nr  
+0003ce50: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
+0003ce60: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+0003ce70: 7436 345f 7420 6e65 3020 3d20 7372 6330  t64_t ne0 = src0
+0003ce80: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+0003ce90: 7374 2069 6e74 3634 5f74 206e 6531 203d  st int64_t ne1 =
+0003cea0: 2073 7263 302d 3e6e 655b 315d 3b0a 2020   src0->ne[1];.  
+0003ceb0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+0003cec0: 6e65 3220 3d20 7372 6330 2d3e 6e65 5b32  ne2 = src0->ne[2
+0003ced0: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
+0003cee0: 7a65 5f74 206e 6230 3020 3d20 7372 6330  ze_t nb00 = src0
+0003cef0: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+0003cf00: 7374 2073 697a 655f 7420 6e62 3031 203d  st size_t nb01 =
+0003cf10: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
+0003cf20: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0003cf30: 6230 3220 3d20 7372 6330 2d3e 6e62 5b32  b02 = src0->nb[2
+0003cf40: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+0003cf50: 655f 7420 6e62 3033 203d 2073 7263 302d  e_t nb03 = src0-
+0003cf60: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
+0003cf70: 7374 2073 697a 655f 7420 6e62 3130 203d  st size_t nb10 =
+0003cf80: 2073 7263 312d 3e6e 625b 305d 3b0a 2020   src1->nb[0];.  
+0003cf90: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0003cfa0: 6231 3120 3d20 7372 6331 2d3e 6e62 5b31  b11 = src1->nb[1
+0003cfb0: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+0003cfc0: 655f 7420 6e62 3132 203d 2073 7263 312d  e_t nb12 = src1-
+0003cfd0: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
+0003cfe0: 7420 7369 7a65 5f74 206e 6231 3320 3d20  t size_t nb13 = 
+0003cff0: 7372 6331 2d3e 6e62 5b33 5d3b 0a0a 2020  src1->nb[3];..  
+0003d000: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0003d010: 6230 203d 2064 7374 2d3e 6e62 5b30 5d3b  b0 = dst->nb[0];
+0003d020: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0003d030: 7420 6e62 3120 3d20 6473 742d 3e6e 625b  t nb1 = dst->nb[
+0003d040: 315d 3b0a 2020 2020 636f 6e73 7420 7369  1];.    const si
+0003d050: 7a65 5f74 206e 6232 203d 2064 7374 2d3e  ze_t nb2 = dst->
+0003d060: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+0003d070: 2073 697a 655f 7420 6e62 3320 3d20 6473   size_t nb3 = ds
+0003d080: 742d 3e6e 625b 335d 3b0a 0a20 2020 2047  t->nb[3];..    G
+0003d090: 474d 4c5f 4153 5345 5254 2873 7263 302d  GML_ASSERT(src0-
+0003d0a0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+0003d0b0: 5045 5f46 3136 293b 0a20 2020 2047 474d  PE_F16);.    GGM
+0003d0c0: 4c5f 4153 5345 5254 2873 7263 312d 3e74  L_ASSERT(src1->t
+0003d0d0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+0003d0e0: 5f46 3136 293b 0a20 2020 2047 474d 4c5f  _F16);.    GGML_
+0003d0f0: 4153 5345 5254 2864 7374 2d3e 7479 7065  ASSERT(dst->type
+0003d100: 2020 3d3d 2047 474d 4c5f 5459 5045 5f46    == GGML_TYPE_F
+0003d110: 3136 293b 0a0a 2020 2020 4747 4d4c 5f41  16);..    GGML_A
+0003d120: 5353 4552 5428 206e 6230 203d 3d20 7369  SSERT( nb0 == si
+0003d130: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
+0003d140: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+0003d150: 4552 5428 6e62 3030 203d 3d20 7369 7a65  ERT(nb00 == size
+0003d160: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
+0003d170: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
+0003d180: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
+0003d190: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
+0003d1a0: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
+0003d1b0: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
+0003d1c0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
+0003d1d0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+0003d1e0: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
+0003d1f0: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
+0003d200: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
+0003d210: 206e 7229 3b0a 0a20 2020 2069 6620 286e   nr);..    if (n
+0003d220: 6231 3020 3d3d 2073 697a 656f 6628 6767  b10 == sizeof(gg
+0003d230: 6d6c 5f66 7031 365f 7429 2920 7b0a 2020  ml_fp16_t)) {.  
+0003d240: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0003d250: 7220 3d20 6972 303b 2069 7220 3c20 6972  r = ir0; ir < ir
+0003d260: 313b 202b 2b69 7229 207b 0a20 2020 2020  1; ++ir) {.     
+0003d270: 2020 2020 2020 202f 2f20 7372 6330 2c20         // src0, 
+0003d280: 7372 6331 2061 6e64 2064 7374 2061 7265  src1 and dst are
+0003d290: 2073 616d 6520 7368 6170 6520 3d3e 2073   same shape => s
+0003d2a0: 616d 6520 696e 6469 6365 730a 2020 2020  ame indices.    
+0003d2b0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0003d2c0: 7420 6933 203d 2069 722f 286e 6532 2a6e  t i3 = ir/(ne2*n
+0003d2d0: 6531 293b 0a20 2020 2020 2020 2020 2020  e1);.           
+0003d2e0: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
+0003d2f0: 2869 7220 2d20 6933 2a6e 6532 2a6e 6531  (ir - i3*ne2*ne1
+0003d300: 292f 6e65 313b 0a20 2020 2020 2020 2020  )/ne1;.         
+0003d310: 2020 2063 6f6e 7374 2069 6e74 2069 3120     const int i1 
+0003d320: 3d20 2869 7220 2d20 6933 2a6e 6532 2a6e  = (ir - i3*ne2*n
+0003d330: 6531 202d 2069 322a 6e65 3129 3b0a 0a20  e1 - i2*ne1);.. 
+0003d340: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0003d350: 6670 3136 5f74 202a 2064 7374 5f70 7472  fp16_t * dst_ptr
+0003d360: 2020 3d20 2867 676d 6c5f 6670 3136 5f74    = (ggml_fp16_t
+0003d370: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
+0003d380: 742d 3e64 6174 6120 202b 2069 332a 6e62  t->data  + i3*nb
+0003d390: 3320 202b 2069 322a 6e62 3220 202b 2069  3  + i2*nb2  + i
+0003d3a0: 312a 6e62 3129 3b0a 2020 2020 2020 2020  1*nb1);.        
+0003d3b0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
+0003d3c0: 2a20 7372 6330 5f70 7472 203d 2028 6767  * src0_ptr = (gg
+0003d3d0: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
+0003d3e0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+0003d3f0: 6120 2b20 6933 2a6e 6230 3320 2b20 6932  a + i3*nb03 + i2
+0003d400: 2a6e 6230 3220 2b20 6931 2a6e 6230 3129  *nb02 + i1*nb01)
+0003d410: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
+0003d420: 6d6c 5f66 7031 365f 7420 2a20 7372 6331  ml_fp16_t * src1
+0003d430: 5f70 7472 203d 2028 6767 6d6c 5f66 7031  _ptr = (ggml_fp1
+0003d440: 365f 7420 2a29 2028 2863 6861 7220 2a29  6_t *) ((char *)
+0003d450: 2073 7263 312d 3e64 6174 6120 2b20 6933   src1->data + i3
+0003d460: 2a6e 6231 3320 2b20 6932 2a6e 6231 3220  *nb13 + i2*nb12 
+0003d470: 2b20 6931 2a6e 6231 3129 3b0a 0a20 2020  + i1*nb11);..   
+0003d480: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0003d490: 7420 6920 3d20 303b 2069 203c 206e 6530  t i = 0; i < ne0
+0003d4a0: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+0003d4b0: 2020 2020 2020 2020 2064 7374 5f70 7472           dst_ptr
+0003d4c0: 5b69 5d20 3d20 4747 4d4c 5f46 5033 325f  [i] = GGML_FP32_
+0003d4d0: 544f 5f46 5031 3628 4747 4d4c 5f46 5031  TO_FP16(GGML_FP1
+0003d4e0: 365f 544f 5f46 5033 3228 7372 6330 5f70  6_TO_FP32(src0_p
+0003d4f0: 7472 5b69 5d29 202b 2047 474d 4c5f 4650  tr[i]) + GGML_FP
+0003d500: 3136 5f54 4f5f 4650 3332 2873 7263 315f  16_TO_FP32(src1_
+0003d510: 7074 725b 695d 2929 3b0a 2020 2020 2020  ptr[i]));.      
+0003d520: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0003d530: 7d0a 2020 2020 7d0a 2020 2020 656c 7365  }.    }.    else
+0003d540: 207b 0a20 2020 2020 2020 202f 2f20 7372   {.        // sr
+0003d550: 6331 2069 7320 6e6f 7420 636f 6e74 6967  c1 is not contig
+0003d560: 756f 7573 0a20 2020 2020 2020 2047 474d  uous.        GGM
+0003d570: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+0003d580: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+0003d590: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+0003d5a0: 7465 5f66 6f72 7761 7264 5f61 6464 5f71  te_forward_add_q
+0003d5b0: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
+0003d5c0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0003d5d0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+0003d5e0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+0003d5f0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0003d600: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+0003d610: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0003d620: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0003d630: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+0003d640: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0003d650: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+0003d660: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+0003d670: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
+0003d680: 7065 2873 7263 302c 2073 7263 3129 2026  pe(src0, src1) &
+0003d690: 2620 6767 6d6c 5f61 7265 5f73 616d 655f  & ggml_are_same_
+0003d6a0: 7368 6170 6528 7372 6330 2c20 6473 7429  shape(src0, dst)
+0003d6b0: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
+0003d6c0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+0003d6d0: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
+0003d6e0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+0003d6f0: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
+0003d700: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+0003d710: 726e 3b0a 2020 2020 7d0a 0a20 2020 2063  rn;.    }..    c
+0003d720: 6f6e 7374 2069 6e74 206e 7220 203d 2067  onst int nr  = g
+0003d730: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
+0003d740: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0003d750: 5f74 206e 6530 3020 3d20 7372 6330 2d3e  _t ne00 = src0->
+0003d760: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+0003d770: 2069 6e74 3634 5f74 206e 6530 3120 3d20   int64_t ne01 = 
+0003d780: 7372 6330 2d3e 6e65 5b31 5d3b 0a20 2020  src0->ne[1];.   
+0003d790: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0003d7a0: 6530 3220 3d20 7372 6330 2d3e 6e65 5b32  e02 = src0->ne[2
+0003d7b0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+0003d7c0: 6e74 3634 5f74 206e 6530 3320 3d20 7372  nt64_t ne03 = sr
+0003d7d0: 6330 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c0->ne[3];..    
+0003d7e0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+0003d7f0: 3020 3d20 7372 6330 2d3e 6e62 5b30 5d3b  0 = src0->nb[0];
+0003d800: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0003d810: 7420 6e62 3031 203d 2073 7263 302d 3e6e  t nb01 = src0->n
+0003d820: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+0003d830: 7369 7a65 5f74 206e 6230 3220 3d20 7372  size_t nb02 = sr
+0003d840: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 2063  c0->nb[2];.    c
+0003d850: 6f6e 7374 2073 697a 655f 7420 6e62 3033  onst size_t nb03
+0003d860: 203d 2073 7263 302d 3e6e 625b 335d 3b0a   = src0->nb[3];.
+0003d870: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0003d880: 7420 6e62 3130 203d 2073 7263 312d 3e6e  t nb10 = src1->n
+0003d890: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+0003d8a0: 7369 7a65 5f74 206e 6231 3120 3d20 7372  size_t nb11 = sr
+0003d8b0: 6331 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c1->nb[1];.    c
+0003d8c0: 6f6e 7374 2073 697a 655f 7420 6e62 3132  onst size_t nb12
+0003d8d0: 203d 2073 7263 312d 3e6e 625b 325d 3b0a   = src1->nb[2];.
+0003d8e0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0003d8f0: 206e 6231 3320 3d20 7372 6331 2d3e 6e62   nb13 = src1->nb
+0003d900: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+0003d910: 7369 7a65 5f74 206e 6230 2020 3d20 6473  size_t nb0  = ds
+0003d920: 742d 3e6e 625b 305d 3b0a 2020 2020 636f  t->nb[0];.    co
+0003d930: 6e73 7420 7369 7a65 5f74 206e 6231 2020  nst size_t nb1  
+0003d940: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
+0003d950: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0003d960: 6232 2020 3d20 6473 742d 3e6e 625b 325d  b2  = dst->nb[2]
+0003d970: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
+0003d980: 5f74 206e 6233 2020 3d20 6473 742d 3e6e  _t nb3  = dst->n
+0003d990: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+0003d9a0: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
+0003d9b0: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
+0003d9c0: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
+0003d9d0: 6d73 2d3e 6e74 683b 0a0a 2020 2020 636f  ms->nth;..    co
+0003d9e0: 6e73 7420 656e 756d 2067 676d 6c5f 7479  nst enum ggml_ty
+0003d9f0: 7065 2074 7970 6520 3d20 7372 6330 2d3e  pe type = src0->
+0003da00: 7479 7065 3b0a 2020 2020 6465 7175 616e  type;.    dequan
+0003da10: 7469 7a65 5f72 6f77 5f71 5f74 2063 6f6e  tize_row_q_t con
+0003da20: 7374 2064 6571 7561 6e74 697a 655f 726f  st dequantize_ro
+0003da30: 775f 7120 3d20 7175 616e 7469 7a65 5f66  w_q = quantize_f
+0003da40: 6e73 5b74 7970 655d 2e64 6571 7561 6e74  ns[type].dequant
+0003da50: 697a 655f 726f 775f 713b 0a20 2020 2071  ize_row_q;.    q
+0003da60: 7561 6e74 697a 655f 726f 775f 715f 7420  uantize_row_q_t 
+0003da70: 636f 6e73 7420 7175 616e 7469 7a65 5f72  const quantize_r
+0003da80: 6f77 5f71 203d 2071 7561 6e74 697a 655f  ow_q = quantize_
+0003da90: 666e 735b 7479 7065 5d2e 7175 616e 7469  fns[type].quanti
+0003daa0: 7a65 5f72 6f77 5f71 3b0a 0a20 2020 202f  ze_row_q;..    /
+0003dab0: 2f20 7765 2064 6f6e 2774 2073 7570 706f  / we don't suppo
+0003dac0: 7274 2070 6572 6d75 7465 6420 7372 6330  rt permuted src0
+0003dad0: 206f 7220 7372 6331 0a20 2020 2047 474d   or src1.    GGM
+0003dae0: 4c5f 4153 5345 5254 286e 6230 3020 3d3d  L_ASSERT(nb00 ==
+0003daf0: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
+0003db00: 7479 7065 5d29 3b0a 2020 2020 4747 4d4c  type]);.    GGML
+0003db10: 5f41 5353 4552 5428 6e62 3130 203d 3d20  _ASSERT(nb10 == 
+0003db20: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+0003db30: 0a20 2020 202f 2f20 6473 7420 6361 6e6e  .    // dst cann
+0003db40: 6f74 2062 6520 7472 616e 7370 6f73 6564  ot be transposed
+0003db50: 206f 7220 7065 726d 7574 6564 0a20 2020   or permuted.   
+0003db60: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
+0003db70: 203c 3d20 6e62 3129 3b0a 2020 2020 4747   <= nb1);.    GG
+0003db80: 4d4c 5f41 5353 4552 5428 6e62 3120 3c3d  ML_ASSERT(nb1 <=
+0003db90: 206e 6232 293b 0a20 2020 2047 474d 4c5f   nb2);.    GGML_
+0003dba0: 4153 5345 5254 286e 6232 203c 3d20 6e62  ASSERT(nb2 <= nb
+0003dbb0: 3329 3b0a 0a20 2020 2047 474d 4c5f 4153  3);..    GGML_AS
+0003dbc0: 5345 5254 2867 676d 6c5f 6973 5f71 7561  SERT(ggml_is_qua
+0003dbd0: 6e74 697a 6564 2873 7263 302d 3e74 7970  ntized(src0->typ
+0003dbe0: 6529 293b 0a20 2020 2047 474d 4c5f 4153  e));.    GGML_AS
+0003dbf0: 5345 5254 2864 7374 2d3e 7479 7065 203d  SERT(dst->type =
+0003dc00: 3d20 7372 6330 2d3e 7479 7065 293b 0a20  = src0->type);. 
+0003dc10: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
+0003dc20: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
+0003dc30: 4c5f 5459 5045 5f46 3332 293b 0a0a 2020  L_TYPE_F32);..  
+0003dc40: 2020 2f2f 2072 6f77 7320 7065 7220 7468    // rows per th
+0003dc50: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+0003dc60: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
+0003dc70: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
+0003dc80: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
+0003dc90: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
+0003dca0: 2020 636f 6e73 7420 696e 7420 6972 3020    const int ir0 
+0003dcb0: 3d20 6472 2a69 7468 3b0a 2020 2020 636f  = dr*ith;.    co
+0003dcc0: 6e73 7420 696e 7420 6972 3120 3d20 4d49  nst int ir1 = MI
+0003dcd0: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
+0003dce0: 0a0a 2020 2020 666c 6f61 7420 2a20 7764  ..    float * wd
+0003dcf0: 6174 6120 3d20 2866 6c6f 6174 202a 2920  ata = (float *) 
+0003dd00: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
+0003dd10: 286e 6530 3020 2b20 4341 4348 455f 4c49  (ne00 + CACHE_LI
+0003dd20: 4e45 5f53 495a 455f 4633 3229 202a 2069  NE_SIZE_F32) * i
+0003dd30: 7468 3b0a 0a20 2020 2066 6f72 2028 696e  th;..    for (in
+0003dd40: 7420 6972 203d 2069 7230 3b20 6972 203c  t ir = ir0; ir <
+0003dd50: 2069 7231 3b20 2b2b 6972 2920 7b0a 2020   ir1; ++ir) {.  
+0003dd60: 2020 2020 2020 2f2f 2073 7263 3020 696e        // src0 in
+0003dd70: 6469 6365 730a 2020 2020 2020 2020 636f  dices.        co
+0003dd80: 6e73 7420 696e 7420 6930 3320 3d20 6972  nst int i03 = ir
+0003dd90: 2f28 6e65 3032 2a6e 6530 3129 3b0a 2020  /(ne02*ne01);.  
+0003dda0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0003ddb0: 6930 3220 3d20 2869 7220 2d20 6930 332a  i02 = (ir - i03*
+0003ddc0: 6e65 3032 2a6e 6530 3129 2f6e 6530 313b  ne02*ne01)/ne01;
+0003ddd0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+0003dde0: 6e74 2069 3031 203d 2028 6972 202d 2069  nt i01 = (ir - i
+0003ddf0: 3033 2a6e 6530 322a 6e65 3031 202d 2069  03*ne02*ne01 - i
+0003de00: 3032 2a6e 6530 3129 3b0a 0a20 2020 2020  02*ne01);..     
+0003de10: 2020 202f 2f20 7372 6331 2061 6e64 2064     // src1 and d
+0003de20: 7374 2061 7265 2073 616d 6520 7368 6170  st are same shap
+0003de30: 6520 6173 2073 7263 3020 3d3e 2073 616d  e as src0 => sam
+0003de40: 6520 696e 6469 6365 730a 2020 2020 2020  e indices.      
+0003de50: 2020 636f 6e73 7420 696e 7420 6931 3320    const int i13 
+0003de60: 3d20 6930 333b 0a20 2020 2020 2020 2063  = i03;.        c
+0003de70: 6f6e 7374 2069 6e74 2069 3132 203d 2069  onst int i12 = i
+0003de80: 3032 3b0a 2020 2020 2020 2020 636f 6e73  02;.        cons
+0003de90: 7420 696e 7420 6931 3120 3d20 6930 313b  t int i11 = i01;
+0003dea0: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
+0003deb0: 696e 7420 6933 203d 2069 3033 3b0a 2020  int i3 = i03;.  
+0003dec0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0003ded0: 6932 203d 2069 3032 3b0a 2020 2020 2020  i2 = i02;.      
+0003dee0: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
+0003def0: 2069 3031 3b0a 0a20 2020 2020 2020 2076   i01;..        v
+0003df00: 6f69 6420 202a 2073 7263 305f 726f 7720  oid  * src0_row 
+0003df10: 3d20 2876 6f69 6420 2a29 2028 2863 6861  = (void *) ((cha
+0003df20: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+0003df30: 2b20 2869 3031 2a6e 6230 3120 2b20 6930  + (i01*nb01 + i0
+0003df40: 322a 6e62 3032 202b 2069 3033 2a6e 6230  2*nb02 + i03*nb0
+0003df50: 3329 293b 0a20 2020 2020 2020 2066 6c6f  3));.        flo
+0003df60: 6174 202a 2073 7263 315f 726f 7720 3d20  at * src1_row = 
+0003df70: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
+0003df80: 2a29 2073 7263 312d 3e64 6174 6120 2b20  *) src1->data + 
+0003df90: 2869 3131 2a6e 6231 3120 2b20 6931 322a  (i11*nb11 + i12*
+0003dfa0: 6e62 3132 202b 2069 3133 2a6e 6231 3329  nb12 + i13*nb13)
+0003dfb0: 293b 0a20 2020 2020 2020 2076 6f69 6420  );.        void 
+0003dfc0: 202a 2064 7374 5f72 6f77 2020 3d20 2876   * dst_row  = (v
+0003dfd0: 6f69 6420 2a29 2028 2863 6861 7220 2a29  oid *) ((char *)
+0003dfe0: 2020 6473 742d 3e64 6174 6120 2b20 2820    dst->data + ( 
+0003dff0: 6931 2a6e 6231 2020 2b20 2069 322a 6e62  i1*nb1  +  i2*nb
+0003e000: 3220 202b 2020 6933 2a6e 6233 2929 3b0a  2  +  i3*nb3));.
+0003e010: 0a20 2020 2020 2020 2061 7373 6572 7428  .        assert(
+0003e020: 6e65 3030 2025 2033 3220 3d3d 2030 293b  ne00 % 32 == 0);
+0003e030: 0a0a 2020 2020 2020 2020 2f2f 2075 6e71  ..        // unq
+0003e040: 7561 6e74 697a 6520 726f 7720 6672 6f6d  uantize row from
+0003e050: 2073 7263 3020 746f 2074 656d 7020 6275   src0 to temp bu
+0003e060: 6666 6572 0a20 2020 2020 2020 2064 6571  ffer.        deq
+0003e070: 7561 6e74 697a 655f 726f 775f 7128 7372  uantize_row_q(sr
+0003e080: 6330 5f72 6f77 2c20 7764 6174 612c 206e  c0_row, wdata, n
+0003e090: 6530 3029 3b0a 2020 2020 2020 2020 2f2f  e00);.        //
+0003e0a0: 2061 6464 2073 7263 310a 2020 2020 2020   add src1.      
+0003e0b0: 2020 6767 6d6c 5f76 6563 5f61 6363 5f66    ggml_vec_acc_f
+0003e0c0: 3332 286e 6530 302c 2077 6461 7461 2c20  32(ne00, wdata, 
+0003e0d0: 7372 6331 5f72 6f77 293b 0a20 2020 2020  src1_row);.     
+0003e0e0: 2020 202f 2f20 7175 616e 7469 7a65 2072     // quantize r
+0003e0f0: 6f77 2074 6f20 6473 740a 2020 2020 2020  ow to dst.      
+0003e100: 2020 7175 616e 7469 7a65 5f72 6f77 5f71    quantize_row_q
+0003e110: 2877 6461 7461 2c20 6473 745f 726f 772c  (wdata, dst_row,
+0003e120: 206e 6530 3029 3b0a 2020 2020 7d0a 7d0a   ne00);.    }.}.
+0003e130: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+0003e140: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0003e150: 645f 6164 6428 0a20 2020 2020 2020 2063  d_add(.        c
+0003e160: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0003e170: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+0003e180: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+0003e190: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0003e1a0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+0003e1b0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
+0003e1c0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0003e1d0: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
+0003e1e0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0003e1f0: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+0003e200: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
+0003e210: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+0003e220: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0003e230: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
+0003e240: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0003e250: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+0003e260: 5f66 6f72 7761 7264 5f61 6464 5f66 3332  _forward_add_f32
+0003e270: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+0003e280: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+0003e290: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0003e2a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0003e2b0: 4c5f 5459 5045 5f46 3136 3a0a 2020 2020  L_TYPE_F16:.    
+0003e2c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003e2d0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+0003e2e0: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
+0003e2f0: 5f54 5950 455f 4631 3629 207b 0a20 2020  _TYPE_F16) {.   
+0003e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e310: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+0003e320: 7277 6172 645f 6164 645f 6631 365f 6631  rward_add_f16_f1
+0003e330: 3628 7061 7261 6d73 2c20 7372 6330 2c20  6(params, src0, 
+0003e340: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+0003e350: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0003e360: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0003e370: 7365 2069 6620 2873 7263 312d 3e74 7970  se if (src1->typ
+0003e380: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+0003e390: 3332 2920 7b0a 2020 2020 2020 2020 2020  32) {.          
+0003e3a0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+0003e3b0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
+0003e3c0: 6464 5f66 3136 5f66 3332 2870 6172 616d  dd_f16_f32(param
+0003e3d0: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
+0003e3e0: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
+0003e3f0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0003e400: 2020 2020 2020 2065 6c73 6520 7b0a 2020         else {.  
+0003e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e420: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0003e430: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+0003e440: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0003e450: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0003e460: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0003e470: 5950 455f 5134 5f30 3a0a 2020 2020 2020  YPE_Q4_0:.      
+0003e480: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0003e490: 5f51 345f 313a 0a20 2020 2020 2020 2063  _Q4_1:.        c
+0003e4a0: 6173 6520 4747 4d4c 5f54 5950 455f 5135  ase GGML_TYPE_Q5
+0003e4b0: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
+0003e4c0: 2047 474d 4c5f 5459 5045 5f51 355f 313a   GGML_TYPE_Q5_1:
+0003e4d0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0003e4e0: 4d4c 5f54 5950 455f 5138 5f30 3a0a 2020  ML_TYPE_Q8_0:.  
+0003e4f0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0003e500: 5459 5045 5f51 325f 4b3a 0a20 2020 2020  TYPE_Q2_K:.     
+0003e510: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+0003e520: 455f 5133 5f4b 3a0a 2020 2020 2020 2020  E_Q3_K:.        
+0003e530: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+0003e540: 345f 4b3a 0a20 2020 2020 2020 2063 6173  4_K:.        cas
+0003e550: 6520 4747 4d4c 5f54 5950 455f 5135 5f4b  e GGML_TYPE_Q5_K
+0003e560: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+0003e570: 474d 4c5f 5459 5045 5f51 365f 4b3a 0a20  GML_TYPE_Q6_K:. 
+0003e580: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0003e590: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0003e5a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0003e5b0: 645f 6164 645f 715f 6633 3228 7061 7261  d_add_q_f32(para
+0003e5c0: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+0003e5d0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+0003e5e0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0003e5f0: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+0003e600: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003e610: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0003e620: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+0003e630: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0003e640: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+0003e650: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0003e660: 6172 645f 6164 6431 0a0a 7374 6174 6963  ard_add1..static
+0003e670: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+0003e680: 7465 5f66 6f72 7761 7264 5f61 6464 315f  te_forward_add1_
+0003e690: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
+0003e6a0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+0003e6b0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+0003e6c0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0003e6d0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0003e6e0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+0003e6f0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0003e700: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0003e710: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+0003e720: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0003e730: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+0003e740: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0003e750: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
+0003e760: 6528 7372 6330 2c20 6473 7429 293b 0a20  e(src0, dst));. 
+0003e770: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+0003e780: 676d 6c5f 6973 5f73 6361 6c61 7228 7372  gml_is_scalar(sr
+0003e790: 6331 2929 3b0a 0a20 2020 2069 6620 2870  c1));..    if (p
+0003e7a0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0003e7b0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+0003e7c0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+0003e7d0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+0003e7e0: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+0003e7f0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0003e800: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
+0003e810: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
+0003e820: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
+0003e830: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
+0003e840: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0003e850: 7220 203d 2067 676d 6c5f 6e72 6f77 7328  r  = ggml_nrows(
+0003e860: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
+0003e870: 2069 6e74 3634 5f74 206e 6530 203d 2073   int64_t ne0 = s
+0003e880: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
+0003e890: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0003e8a0: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
+0003e8b0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0003e8c0: 5f74 206e 6532 203d 2073 7263 302d 3e6e  _t ne2 = src0->n
+0003e8d0: 655b 325d 3b0a 0a20 2020 2063 6f6e 7374  e[2];..    const
+0003e8e0: 2073 697a 655f 7420 6e62 3030 203d 2073   size_t nb00 = s
+0003e8f0: 7263 302d 3e6e 625b 305d 3b0a 2020 2020  rc0->nb[0];.    
+0003e900: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+0003e910: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
+0003e920: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0003e930: 7420 6e62 3032 203d 2073 7263 302d 3e6e  t nb02 = src0->n
+0003e940: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+0003e950: 7369 7a65 5f74 206e 6230 3320 3d20 7372  size_t nb03 = sr
+0003e960: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
+0003e970: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+0003e980: 203d 2064 7374 2d3e 6e62 5b30 5d3b 0a20   = dst->nb[0];. 
+0003e990: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0003e9a0: 6e62 3120 3d20 6473 742d 3e6e 625b 315d  nb1 = dst->nb[1]
+0003e9b0: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
+0003e9c0: 5f74 206e 6232 203d 2064 7374 2d3e 6e62  _t nb2 = dst->nb
+0003e9d0: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
+0003e9e0: 697a 655f 7420 6e62 3320 3d20 6473 742d  ize_t nb3 = dst-
+0003e9f0: 3e6e 625b 335d 3b0a 0a20 2020 2047 474d  >nb[3];..    GGM
+0003ea00: 4c5f 4153 5345 5254 2820 6e62 3020 3d3d  L_ASSERT( nb0 ==
+0003ea10: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+0003ea20: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0003ea30: 286e 6230 3020 3d3d 2073 697a 656f 6628  (nb00 == sizeof(
+0003ea40: 666c 6f61 7429 293b 0a0a 2020 2020 2f2f  float));..    //
+0003ea50: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
+0003ea60: 0a20 2020 2063 6f6e 7374 2069 6e74 2064  .    const int d
+0003ea70: 7220 3d20 286e 7220 2b20 6e74 6820 2d20  r = (nr + nth - 
+0003ea80: 3129 2f6e 7468 3b0a 0a20 2020 202f 2f20  1)/nth;..    // 
+0003ea90: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
+0003eaa0: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
+0003eab0: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
+0003eac0: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
+0003ead0: 696e 7420 6972 3120 3d20 4d49 4e28 6972  int ir1 = MIN(ir
+0003eae0: 3020 2b20 6472 2c20 6e72 293b 0a0a 2020  0 + dr, nr);..  
+0003eaf0: 2020 666f 7220 2869 6e74 2069 7220 3d20    for (int ir = 
+0003eb00: 6972 303b 2069 7220 3c20 6972 313b 202b  ir0; ir < ir1; +
+0003eb10: 2b69 7229 207b 0a20 2020 2020 2020 202f  +ir) {.        /
+0003eb20: 2f20 7372 6330 2061 6e64 2064 7374 2061  / src0 and dst a
+0003eb30: 7265 2073 616d 6520 7368 6170 6520 3d3e  re same shape =>
+0003eb40: 2073 616d 6520 696e 6469 6365 730a 2020   same indices.  
+0003eb50: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0003eb60: 6933 203d 2069 722f 286e 6532 2a6e 6531  i3 = ir/(ne2*ne1
+0003eb70: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+0003eb80: 2069 6e74 2069 3220 3d20 2869 7220 2d20   int i2 = (ir - 
+0003eb90: 6933 2a6e 6532 2a6e 6531 292f 6e65 313b  i3*ne2*ne1)/ne1;
+0003eba0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+0003ebb0: 6e74 2069 3120 3d20 2869 7220 2d20 6933  nt i1 = (ir - i3
+0003ebc0: 2a6e 6532 2a6e 6531 202d 2069 322a 6e65  *ne2*ne1 - i2*ne
+0003ebd0: 3129 3b0a 0a23 6966 6465 6620 4747 4d4c  1);..#ifdef GGML
+0003ebe0: 5f55 5345 5f41 4343 454c 4552 4154 450a  _USE_ACCELERATE.
+0003ebf0: 2020 2020 2020 2020 554e 5553 4544 2867          UNUSED(g
+0003ec00: 676d 6c5f 7665 635f 6164 6431 5f66 3332  gml_vec_add1_f32
+0003ec10: 293b 0a0a 2020 2020 2020 2020 7644 5350  );..        vDSP
+0003ec20: 5f76 6164 6428 0a20 2020 2020 2020 2020  _vadd(.         
+0003ec30: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+0003ec40: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
+0003ec50: 3e64 6174 6120 2b20 6933 2a6e 6230 3320  >data + i3*nb03 
+0003ec60: 2b20 6932 2a6e 6230 3220 2b20 6931 2a6e  + i2*nb02 + i1*n
+0003ec70: 6230 3129 2c20 312c 0a20 2020 2020 2020  b01), 1,.       
+0003ec80: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+0003ec90: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+0003eca0: 312d 3e64 6174 6129 2c20 302c 0a20 2020  1->data), 0,.   
+0003ecb0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+0003ecc0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+0003ecd0: 2064 7374 2d3e 6461 7461 2020 2b20 6933   dst->data  + i3
+0003ece0: 2a6e 6233 2020 2b20 6932 2a6e 6232 2020  *nb3  + i2*nb2  
+0003ecf0: 2b20 6931 2a6e 6231 2029 2c20 312c 0a20  + i1*nb1 ), 1,. 
+0003ed00: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0003ed10: 6530 293b 0a23 656c 7365 0a20 2020 2020  e0);.#else.     
+0003ed20: 2020 2067 676d 6c5f 7665 635f 6164 6431     ggml_vec_add1
+0003ed30: 5f66 3332 286e 6530 2c0a 2020 2020 2020  _f32(ne0,.      
+0003ed40: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+0003ed50: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
+0003ed60: 742d 3e64 6174 6120 202b 2069 332a 6e62  t->data  + i3*nb
+0003ed70: 3320 202b 2069 322a 6e62 3220 202b 2069  3  + i2*nb2  + i
+0003ed80: 312a 6e62 3120 292c 0a20 2020 2020 2020  1*nb1 ),.       
+0003ed90: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+0003eda0: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+0003edb0: 302d 3e64 6174 6120 2b20 6933 2a6e 6230  0->data + i3*nb0
+0003edc0: 3320 2b20 6932 2a6e 6230 3220 2b20 6931  3 + i2*nb02 + i1
+0003edd0: 2a6e 6230 3129 2c0a 2020 2020 2020 2020  *nb01),.        
+0003ede0: 2020 2020 2020 202a 2866 6c6f 6174 202a         *(float *
+0003edf0: 2920 7372 6331 2d3e 6461 7461 293b 0a23  ) src1->data);.#
+0003ee00: 656e 6469 660a 2020 2020 7d0a 7d0a 0a73  endif.    }.}..s
+0003ee10: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+0003ee20: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0003ee30: 6164 6431 5f66 3136 5f66 3332 280a 2020  add1_f16_f32(.  
+0003ee40: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0003ee50: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+0003ee60: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+0003ee70: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0003ee80: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0003ee90: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+0003eea0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0003eeb0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+0003eec0: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
+0003eed0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0003eee0: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
+0003eef0: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
+0003ef00: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
+0003ef10: 2064 7374 2929 3b0a 2020 2020 4747 4d4c   dst));.    GGML
+0003ef20: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
+0003ef30: 7363 616c 6172 2873 7263 3129 293b 0a0a  scalar(src1));..
+0003ef40: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+0003ef50: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+0003ef60: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
+0003ef70: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0003ef80: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+0003ef90: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+0003efa0: 2020 2020 7d0a 0a20 2020 202f 2f20 7363      }..    // sc
+0003efb0: 616c 6172 2074 6f20 6164 640a 2020 2020  alar to add.    
+0003efc0: 636f 6e73 7420 666c 6f61 7420 7620 3d20  const float v = 
+0003efd0: 2a28 666c 6f61 7420 2a29 2073 7263 312d  *(float *) src1-
+0003efe0: 3e64 6174 613b 0a0a 2020 2020 636f 6e73  >data;..    cons
+0003eff0: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
+0003f000: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
+0003f010: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
+0003f020: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
+0003f030: 6f6e 7374 2069 6e74 206e 7220 203d 2067  onst int nr  = g
+0003f040: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
+0003f050: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0003f060: 5f74 206e 6530 203d 2073 7263 302d 3e6e  _t ne0 = src0->n
+0003f070: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+0003f080: 696e 7436 345f 7420 6e65 3120 3d20 7372  int64_t ne1 = sr
+0003f090: 6330 2d3e 6e65 5b31 5d3b 0a20 2020 2063  c0->ne[1];.    c
+0003f0a0: 6f6e 7374 2069 6e74 3634 5f74 206e 6532  onst int64_t ne2
+0003f0b0: 203d 2073 7263 302d 3e6e 655b 325d 3b0a   = src0->ne[2];.
+0003f0c0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0003f0d0: 7420 6e62 3030 203d 2073 7263 302d 3e6e  t nb00 = src0->n
+0003f0e0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+0003f0f0: 7369 7a65 5f74 206e 6230 3120 3d20 7372  size_t nb01 = sr
+0003f100: 6330 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c0->nb[1];.    c
+0003f110: 6f6e 7374 2073 697a 655f 7420 6e62 3032  onst size_t nb02
+0003f120: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
+0003f130: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0003f140: 206e 6230 3320 3d20 7372 6330 2d3e 6e62   nb03 = src0->nb
+0003f150: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+0003f160: 7369 7a65 5f74 206e 6230 203d 2064 7374  size_t nb0 = dst
+0003f170: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+0003f180: 7374 2073 697a 655f 7420 6e62 3120 3d20  st size_t nb1 = 
+0003f190: 6473 742d 3e6e 625b 315d 3b0a 2020 2020  dst->nb[1];.    
+0003f1a0: 636f 6e73 7420 7369 7a65 5f74 206e 6232  const size_t nb2
+0003f1b0: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
+0003f1c0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0003f1d0: 6e62 3320 3d20 6473 742d 3e6e 625b 335d  nb3 = dst->nb[3]
+0003f1e0: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+0003f1f0: 5254 2873 7263 302d 3e74 7970 6520 3d3d  RT(src0->type ==
+0003f200: 2047 474d 4c5f 5459 5045 5f46 3136 293b   GGML_TYPE_F16);
+0003f210: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0003f220: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
+0003f230: 474d 4c5f 5459 5045 5f46 3332 293b 0a20  GML_TYPE_F32);. 
+0003f240: 2020 2047 474d 4c5f 4153 5345 5254 2864     GGML_ASSERT(d
+0003f250: 7374 2d3e 7479 7065 203d 3d20 4747 4d4c  st->type == GGML
+0003f260: 5f54 5950 455f 4631 3629 3b0a 0a20 2020  _TYPE_F16);..   
+0003f270: 2047 474d 4c5f 4153 5345 5254 2820 6e62   GGML_ASSERT( nb
+0003f280: 3020 3d3d 2073 697a 656f 6628 6767 6d6c  0 == sizeof(ggml
+0003f290: 5f66 7031 365f 7429 293b 0a20 2020 2047  _fp16_t));.    G
+0003f2a0: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
+0003f2b0: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
+0003f2c0: 7031 365f 7429 293b 0a0a 2020 2020 2f2f  p16_t));..    //
+0003f2d0: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
+0003f2e0: 0a20 2020 2063 6f6e 7374 2069 6e74 2064  .    const int d
+0003f2f0: 7220 3d20 286e 7220 2b20 6e74 6820 2d20  r = (nr + nth - 
+0003f300: 3129 2f6e 7468 3b0a 0a20 2020 202f 2f20  1)/nth;..    // 
+0003f310: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
+0003f320: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
+0003f330: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
+0003f340: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
+0003f350: 696e 7420 6972 3120 3d20 4d49 4e28 6972  int ir1 = MIN(ir
+0003f360: 3020 2b20 6472 2c20 6e72 293b 0a0a 2020  0 + dr, nr);..  
+0003f370: 2020 666f 7220 2869 6e74 2069 7220 3d20    for (int ir = 
+0003f380: 6972 303b 2069 7220 3c20 6972 313b 202b  ir0; ir < ir1; +
+0003f390: 2b69 7229 207b 0a20 2020 2020 2020 202f  +ir) {.        /
+0003f3a0: 2f20 7372 6330 2061 6e64 2064 7374 2061  / src0 and dst a
+0003f3b0: 7265 2073 616d 6520 7368 6170 6520 3d3e  re same shape =>
+0003f3c0: 2073 616d 6520 696e 6469 6365 730a 2020   same indices.  
+0003f3d0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0003f3e0: 6933 203d 2069 722f 286e 6532 2a6e 6531  i3 = ir/(ne2*ne1
+0003f3f0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+0003f400: 2069 6e74 2069 3220 3d20 2869 7220 2d20   int i2 = (ir - 
+0003f410: 6933 2a6e 6532 2a6e 6531 292f 6e65 313b  i3*ne2*ne1)/ne1;
+0003f420: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+0003f430: 6e74 2069 3120 3d20 2869 7220 2d20 6933  nt i1 = (ir - i3
+0003f440: 2a6e 6532 2a6e 6531 202d 2069 322a 6e65  *ne2*ne1 - i2*ne
+0003f450: 3129 3b0a 0a20 2020 2020 2020 2067 676d  1);..        ggm
+0003f460: 6c5f 6670 3136 5f74 202a 2064 7374 5f70  l_fp16_t * dst_p
+0003f470: 7472 2020 3d20 2867 676d 6c5f 6670 3136  tr  = (ggml_fp16
+0003f480: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
+0003f490: 6473 742d 3e64 6174 6120 202b 2069 332a  dst->data  + i3*
+0003f4a0: 6e62 3320 202b 2069 322a 6e62 3220 202b  nb3  + i2*nb2  +
+0003f4b0: 2069 312a 6e62 3120 293b 0a20 2020 2020   i1*nb1 );.     
+0003f4c0: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
+0003f4d0: 2073 7263 305f 7074 7220 3d20 2867 676d   src0_ptr = (ggm
+0003f4e0: 6c5f 6670 3136 5f74 202a 2920 2828 6368  l_fp16_t *) ((ch
+0003f4f0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+0003f500: 202b 2069 332a 6e62 3033 202b 2069 322a   + i3*nb03 + i2*
+0003f510: 6e62 3032 202b 2069 312a 6e62 3031 293b  nb02 + i1*nb01);
+0003f520: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+0003f530: 7420 6920 3d20 303b 2069 203c 206e 6530  t i = 0; i < ne0
+0003f540: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+0003f550: 2020 2020 2064 7374 5f70 7472 5b69 5d20       dst_ptr[i] 
+0003f560: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
+0003f570: 5031 3628 4747 4d4c 5f46 5031 365f 544f  P16(GGML_FP16_TO
+0003f580: 5f46 5033 3228 7372 6330 5f70 7472 5b69  _FP32(src0_ptr[i
+0003f590: 5d29 202b 2076 293b 0a20 2020 2020 2020  ]) + v);.       
+0003f5a0: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
+0003f5b0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+0003f5c0: 7075 7465 5f66 6f72 7761 7264 5f61 6464  pute_forward_add
+0003f5d0: 315f 6631 365f 6631 3628 0a20 2020 2020  1_f16_f16(.     
+0003f5e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0003f5f0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+0003f600: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+0003f610: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0003f620: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0003f630: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+0003f640: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0003f650: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+0003f660: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0003f670: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+0003f680: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+0003f690: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
+0003f6a0: 655f 7368 6170 6528 7372 6330 2c20 6473  e_shape(src0, ds
+0003f6b0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+0003f6c0: 5345 5254 2867 676d 6c5f 6973 5f73 6361  SERT(ggml_is_sca
+0003f6d0: 6c61 7228 7372 6331 2929 3b0a 0a20 2020  lar(src1));..   
+0003f6e0: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+0003f6f0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+0003f700: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
+0003f710: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+0003f720: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
+0003f730: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+0003f740: 207d 0a0a 2020 2020 2f2f 2073 6361 6c61   }..    // scala
+0003f750: 7220 746f 2061 6464 0a20 2020 2063 6f6e  r to add.    con
+0003f760: 7374 2066 6c6f 6174 2076 203d 2047 474d  st float v = GGM
+0003f770: 4c5f 4650 3136 5f54 4f5f 4650 3332 282a  L_FP16_TO_FP32(*
+0003f780: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
+0003f790: 7372 6331 2d3e 6461 7461 293b 0a0a 2020  src1->data);..  
+0003f7a0: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
+0003f7b0: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
+0003f7c0: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
+0003f7d0: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
+0003f7e0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0003f7f0: 7220 203d 2067 676d 6c5f 6e72 6f77 7328  r  = ggml_nrows(
+0003f800: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
+0003f810: 2069 6e74 3634 5f74 206e 6530 203d 2073   int64_t ne0 = s
+0003f820: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
+0003f830: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0003f840: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
+0003f850: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0003f860: 5f74 206e 6532 203d 2073 7263 302d 3e6e  _t ne2 = src0->n
+0003f870: 655b 325d 3b0a 0a20 2020 2063 6f6e 7374  e[2];..    const
+0003f880: 2073 697a 655f 7420 6e62 3030 203d 2073   size_t nb00 = s
+0003f890: 7263 302d 3e6e 625b 305d 3b0a 2020 2020  rc0->nb[0];.    
+0003f8a0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+0003f8b0: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
+0003f8c0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0003f8d0: 7420 6e62 3032 203d 2073 7263 302d 3e6e  t nb02 = src0->n
+0003f8e0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+0003f8f0: 7369 7a65 5f74 206e 6230 3320 3d20 7372  size_t nb03 = sr
+0003f900: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
+0003f910: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+0003f920: 203d 2064 7374 2d3e 6e62 5b30 5d3b 0a20   = dst->nb[0];. 
+0003f930: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0003f940: 6e62 3120 3d20 6473 742d 3e6e 625b 315d  nb1 = dst->nb[1]
+0003f950: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
+0003f960: 5f74 206e 6232 203d 2064 7374 2d3e 6e62  _t nb2 = dst->nb
+0003f970: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
+0003f980: 697a 655f 7420 6e62 3320 3d20 6473 742d  ize_t nb3 = dst-
+0003f990: 3e6e 625b 335d 3b0a 0a20 2020 2047 474d  >nb[3];..    GGM
+0003f9a0: 4c5f 4153 5345 5254 2873 7263 302d 3e74  L_ASSERT(src0->t
+0003f9b0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+0003f9c0: 5f46 3136 293b 0a20 2020 2047 474d 4c5f  _F16);.    GGML_
+0003f9d0: 4153 5345 5254 2873 7263 312d 3e74 7970  ASSERT(src1->typ
+0003f9e0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+0003f9f0: 3136 293b 0a20 2020 2047 474d 4c5f 4153  16);.    GGML_AS
+0003fa00: 5345 5254 2864 7374 2d3e 7479 7065 203d  SERT(dst->type =
+0003fa10: 3d20 4747 4d4c 5f54 5950 455f 4631 3629  = GGML_TYPE_F16)
+0003fa20: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+0003fa30: 5254 2820 6e62 3020 3d3d 2073 697a 656f  RT( nb0 == sizeo
+0003fa40: 6628 6767 6d6c 5f66 7031 365f 7429 293b  f(ggml_fp16_t));
+0003fa50: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0003fa60: 286e 6230 3020 3d3d 2073 697a 656f 6628  (nb00 == sizeof(
+0003fa70: 6767 6d6c 5f66 7031 365f 7429 293b 0a0a  ggml_fp16_t));..
+0003fa80: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
+0003fa90: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
+0003faa0: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
+0003fab0: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
+0003fac0: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
+0003fad0: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
+0003fae0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+0003faf0: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
+0003fb00: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
+0003fb10: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
+0003fb20: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
+0003fb30: 2069 7220 3d20 6972 303b 2069 7220 3c20   ir = ir0; ir < 
+0003fb40: 6972 313b 202b 2b69 7229 207b 0a20 2020  ir1; ++ir) {.   
+0003fb50: 2020 2020 202f 2f20 7372 6330 2061 6e64       // src0 and
+0003fb60: 2064 7374 2061 7265 2073 616d 6520 7368   dst are same sh
+0003fb70: 6170 6520 3d3e 2073 616d 6520 696e 6469  ape => same indi
+0003fb80: 6365 730a 2020 2020 2020 2020 636f 6e73  ces.        cons
+0003fb90: 7420 696e 7420 6933 203d 2069 722f 286e  t int i3 = ir/(n
+0003fba0: 6532 2a6e 6531 293b 0a20 2020 2020 2020  e2*ne1);.       
+0003fbb0: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
+0003fbc0: 2869 7220 2d20 6933 2a6e 6532 2a6e 6531  (ir - i3*ne2*ne1
+0003fbd0: 292f 6e65 313b 0a20 2020 2020 2020 2063  )/ne1;.        c
+0003fbe0: 6f6e 7374 2069 6e74 2069 3120 3d20 2869  onst int i1 = (i
+0003fbf0: 7220 2d20 6933 2a6e 6532 2a6e 6531 202d  r - i3*ne2*ne1 -
+0003fc00: 2069 322a 6e65 3129 3b0a 0a20 2020 2020   i2*ne1);..     
+0003fc10: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
+0003fc20: 2064 7374 5f70 7472 2020 3d20 2867 676d   dst_ptr  = (ggm
+0003fc30: 6c5f 6670 3136 5f74 202a 2920 2828 6368  l_fp16_t *) ((ch
+0003fc40: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+0003fc50: 202b 2069 332a 6e62 3320 202b 2069 322a   + i3*nb3  + i2*
+0003fc60: 6e62 3220 202b 2069 312a 6e62 3120 293b  nb2  + i1*nb1 );
+0003fc70: 0a20 2020 2020 2020 2067 676d 6c5f 6670  .        ggml_fp
+0003fc80: 3136 5f74 202a 2073 7263 305f 7074 7220  16_t * src0_ptr 
+0003fc90: 3d20 2867 676d 6c5f 6670 3136 5f74 202a  = (ggml_fp16_t *
+0003fca0: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+0003fcb0: 2d3e 6461 7461 202b 2069 332a 6e62 3033  ->data + i3*nb03
+0003fcc0: 202b 2069 322a 6e62 3032 202b 2069 312a   + i2*nb02 + i1*
+0003fcd0: 6e62 3031 293b 0a20 2020 2020 2020 2066  nb01);.        f
+0003fce0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+0003fcf0: 203c 206e 6530 3b20 692b 2b29 207b 0a20   < ne0; i++) {. 
+0003fd00: 2020 2020 2020 2020 2020 2064 7374 5f70             dst_p
+0003fd10: 7472 5b69 5d20 3d20 4747 4d4c 5f46 5033  tr[i] = GGML_FP3
+0003fd20: 325f 544f 5f46 5031 3628 4747 4d4c 5f46  2_TO_FP16(GGML_F
+0003fd30: 5031 365f 544f 5f46 5033 3228 7372 6330  P16_TO_FP32(src0
+0003fd40: 5f70 7472 5b69 5d29 202b 2076 293b 0a20  _ptr[i]) + v);. 
+0003fd50: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+0003fd60: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+0003fd70: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0003fd80: 7264 5f61 6464 315f 715f 6633 3228 0a20  rd_add1_q_f32(. 
+0003fd90: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0003fda0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+0003fdb0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+0003fdc0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0003fdd0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0003fde0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+0003fdf0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0003fe00: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+0003fe10: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+0003fe20: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0003fe30: 2064 7374 2920 7b0a 2020 2020 4747 4d4c   dst) {.    GGML
+0003fe40: 5f41 5353 4552 5428 6767 6d6c 5f61 7265  _ASSERT(ggml_are
+0003fe50: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
+0003fe60: 2c20 6473 7429 293b 0a20 2020 2047 474d  , dst));.    GGM
+0003fe70: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
+0003fe80: 5f73 6361 6c61 7228 7372 6331 2929 3b0a  _scalar(src1));.
+0003fe90: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+0003fea0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0003feb0: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+0003fec0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+0003fed0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+0003fee0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+0003fef0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2073  .    }..    // s
+0003ff00: 6361 6c61 7220 746f 2061 6464 0a20 2020  calar to add.   
+0003ff10: 2063 6f6e 7374 2066 6c6f 6174 2076 203d   const float v =
+0003ff20: 202a 2866 6c6f 6174 202a 2920 7372 6331   *(float *) src1
+0003ff30: 2d3e 6461 7461 3b0a 0a20 2020 2063 6f6e  ->data;..    con
+0003ff40: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+0003ff50: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+0003ff60: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+0003ff70: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+0003ff80: 636f 6e73 7420 696e 7420 6e72 2020 3d20  const int nr  = 
+0003ff90: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
+0003ffa0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+0003ffb0: 345f 7420 6e65 3020 3d20 7372 6330 2d3e  4_t ne0 = src0->
+0003ffc0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+0003ffd0: 2069 6e74 3634 5f74 206e 6531 203d 2073   int64_t ne1 = s
+0003ffe0: 7263 302d 3e6e 655b 315d 3b0a 2020 2020  rc0->ne[1];.    
+0003fff0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00040000: 3220 3d20 7372 6330 2d3e 6e65 5b32 5d3b  2 = src0->ne[2];
+00040010: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
+00040020: 5f74 206e 6230 3020 3d20 7372 6330 2d3e  _t nb00 = src0->
+00040030: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+00040040: 2073 697a 655f 7420 6e62 3031 203d 2073   size_t nb01 = s
+00040050: 7263 302d 3e6e 625b 315d 3b0a 2020 2020  rc0->nb[1];.    
+00040060: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+00040070: 3220 3d20 7372 6330 2d3e 6e62 5b32 5d3b  2 = src0->nb[2];
+00040080: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00040090: 7420 6e62 3033 203d 2073 7263 302d 3e6e  t nb03 = src0->n
+000400a0: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+000400b0: 2073 697a 655f 7420 6e62 3020 3d20 6473   size_t nb0 = ds
+000400c0: 742d 3e6e 625b 305d 3b0a 2020 2020 636f  t->nb[0];.    co
+000400d0: 6e73 7420 7369 7a65 5f74 206e 6231 203d  nst size_t nb1 =
+000400e0: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
+000400f0: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+00040100: 3220 3d20 6473 742d 3e6e 625b 325d 3b0a  2 = dst->nb[2];.
+00040110: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00040120: 206e 6233 203d 2064 7374 2d3e 6e62 5b33   nb3 = dst->nb[3
+00040130: 5d3b 0a0a 2020 2020 636f 6e73 7420 656e  ];..    const en
+00040140: 756d 2067 676d 6c5f 7479 7065 2074 7970  um ggml_type typ
+00040150: 6520 3d20 7372 6330 2d3e 7479 7065 3b0a  e = src0->type;.
+00040160: 2020 2020 6465 7175 616e 7469 7a65 5f72      dequantize_r
+00040170: 6f77 5f71 5f74 2063 6f6e 7374 2064 6571  ow_q_t const deq
+00040180: 7561 6e74 697a 655f 726f 775f 7120 3d20  uantize_row_q = 
+00040190: 7175 616e 7469 7a65 5f66 6e73 5b74 7970  quantize_fns[typ
+000401a0: 655d 2e64 6571 7561 6e74 697a 655f 726f  e].dequantize_ro
+000401b0: 775f 713b 0a20 2020 2071 7561 6e74 697a  w_q;.    quantiz
+000401c0: 655f 726f 775f 715f 7420 636f 6e73 7420  e_row_q_t const 
+000401d0: 7175 616e 7469 7a65 5f72 6f77 5f71 203d  quantize_row_q =
+000401e0: 2071 7561 6e74 697a 655f 666e 735b 7479   quantize_fns[ty
+000401f0: 7065 5d2e 7175 616e 7469 7a65 5f72 6f77  pe].quantize_row
+00040200: 5f71 3b0a 0a20 2020 202f 2f20 7765 2064  _q;..    // we d
+00040210: 6f6e 2774 2073 7570 706f 7274 2070 6572  on't support per
+00040220: 6d75 7465 6420 7372 6330 0a20 2020 2047  muted src0.    G
+00040230: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
+00040240: 3d3d 2047 474d 4c5f 5459 5045 5f53 495a  == GGML_TYPE_SIZ
+00040250: 455b 7479 7065 5d29 3b0a 0a20 2020 202f  E[type]);..    /
+00040260: 2f20 6473 7420 6361 6e6e 6f74 2062 6520  / dst cannot be 
+00040270: 7472 616e 7370 6f73 6564 206f 7220 7065  transposed or pe
+00040280: 726d 7574 6564 0a20 2020 2047 474d 4c5f  rmuted.    GGML_
+00040290: 4153 5345 5254 286e 6230 203c 3d20 6e62  ASSERT(nb0 <= nb
+000402a0: 3129 3b0a 2020 2020 4747 4d4c 5f41 5353  1);.    GGML_ASS
+000402b0: 4552 5428 6e62 3120 3c3d 206e 6232 293b  ERT(nb1 <= nb2);
+000402c0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000402d0: 286e 6232 203c 3d20 6e62 3329 3b0a 0a20  (nb2 <= nb3);.. 
+000402e0: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+000402f0: 676d 6c5f 6973 5f71 7561 6e74 697a 6564  gml_is_quantized
+00040300: 2873 7263 302d 3e74 7970 6529 293b 0a20  (src0->type));. 
+00040310: 2020 2047 474d 4c5f 4153 5345 5254 2864     GGML_ASSERT(d
+00040320: 7374 2d3e 7479 7065 203d 3d20 7372 6330  st->type == src0
+00040330: 2d3e 7479 7065 293b 0a20 2020 2047 474d  ->type);.    GGM
+00040340: 4c5f 4153 5345 5254 2873 7263 312d 3e74  L_ASSERT(src1->t
+00040350: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00040360: 5f46 3332 293b 0a0a 2020 2020 2f2f 2072  _F32);..    // r
+00040370: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
+00040380: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
+00040390: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
+000403a0: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
+000403b0: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
+000403c0: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+000403d0: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
+000403e0: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+000403f0: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
+00040400: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
+00040410: 666c 6f61 7420 2a20 7764 6174 6120 3d20  float * wdata = 
+00040420: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
+00040430: 2d3e 7764 6174 6120 2b20 286e 6530 202b  ->wdata + (ne0 +
+00040440: 2043 4143 4845 5f4c 494e 455f 5349 5a45   CACHE_LINE_SIZE
+00040450: 5f46 3332 2920 2a20 6974 683b 0a0a 2020  _F32) * ith;..  
+00040460: 2020 666f 7220 2869 6e74 2069 7220 3d20    for (int ir = 
+00040470: 6972 303b 2069 7220 3c20 6972 313b 202b  ir0; ir < ir1; +
+00040480: 2b69 7229 207b 0a20 2020 2020 2020 202f  +ir) {.        /
+00040490: 2f20 7372 6330 2061 6e64 2064 7374 2061  / src0 and dst a
+000404a0: 7265 2073 616d 6520 7368 6170 6520 3d3e  re same shape =>
+000404b0: 2073 616d 6520 696e 6469 6365 730a 2020   same indices.  
+000404c0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+000404d0: 6933 203d 2069 722f 286e 6532 2a6e 6531  i3 = ir/(ne2*ne1
+000404e0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
+000404f0: 2069 6e74 2069 3220 3d20 2869 7220 2d20   int i2 = (ir - 
+00040500: 6933 2a6e 6532 2a6e 6531 292f 6e65 313b  i3*ne2*ne1)/ne1;
+00040510: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+00040520: 6e74 2069 3120 3d20 2869 7220 2d20 6933  nt i1 = (ir - i3
+00040530: 2a6e 6532 2a6e 6531 202d 2069 322a 6e65  *ne2*ne1 - i2*ne
+00040540: 3129 3b0a 0a20 2020 2020 2020 2076 6f69  1);..        voi
+00040550: 6420 202a 2073 7263 305f 726f 7720 3d20  d  * src0_row = 
+00040560: 2876 6f69 6420 2a29 2028 2863 6861 7220  (void *) ((char 
+00040570: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+00040580: 2869 312a 6e62 3031 202b 2069 322a 6e62  (i1*nb01 + i2*nb
+00040590: 3032 202b 2069 332a 6e62 3033 2929 3b0a  02 + i3*nb03));.
+000405a0: 2020 2020 2020 2020 766f 6964 2020 2a20          void  * 
+000405b0: 6473 745f 726f 7720 203d 2028 766f 6964  dst_row  = (void
+000405c0: 202a 2920 2828 6368 6172 202a 2920 2064   *) ((char *)  d
+000405d0: 7374 2d3e 6461 7461 202b 2028 6931 2a6e  st->data + (i1*n
+000405e0: 6231 2020 2b20 6932 2a6e 6232 2020 2b20  b1  + i2*nb2  + 
+000405f0: 6933 2a6e 6230 2029 293b 0a0a 2020 2020  i3*nb0 ));..    
+00040600: 2020 2020 6173 7365 7274 286e 6530 2025      assert(ne0 %
+00040610: 2033 3220 3d3d 2030 293b 0a0a 2020 2020   32 == 0);..    
+00040620: 2020 2020 2f2f 2075 6e71 7561 6e74 697a      // unquantiz
+00040630: 6520 726f 7720 6672 6f6d 2073 7263 3020  e row from src0 
+00040640: 746f 2074 656d 7020 6275 6666 6572 0a20  to temp buffer. 
+00040650: 2020 2020 2020 2064 6571 7561 6e74 697a         dequantiz
+00040660: 655f 726f 775f 7128 7372 6330 5f72 6f77  e_row_q(src0_row
+00040670: 2c20 7764 6174 612c 206e 6530 293b 0a20  , wdata, ne0);. 
+00040680: 2020 2020 2020 202f 2f20 6164 6420 7372         // add sr
+00040690: 6331 0a20 2020 2020 2020 2067 676d 6c5f  c1.        ggml_
+000406a0: 7665 635f 6163 6331 5f66 3332 286e 6530  vec_acc1_f32(ne0
+000406b0: 2c20 7764 6174 612c 2076 293b 0a20 2020  , wdata, v);.   
+000406c0: 2020 2020 202f 2f20 7175 616e 7469 7a65       // quantize
+000406d0: 2072 6f77 2074 6f20 6473 740a 2020 2020   row to dst.    
+000406e0: 2020 2020 7175 616e 7469 7a65 5f72 6f77      quantize_row
+000406f0: 5f71 2877 6461 7461 2c20 6473 745f 726f  _q(wdata, dst_ro
+00040700: 772c 206e 6530 293b 0a20 2020 207d 0a7d  w, ne0);.    }.}
+00040710: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00040720: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00040730: 7264 5f61 6464 3128 0a20 2020 2020 2020  rd_add1(.       
+00040740: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00040750: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00040760: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00040770: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00040780: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00040790: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+000407a0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000407b0: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+000407c0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+000407d0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+000407e0: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
+000407f0: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
+00040800: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00040810: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+00040820: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00040830: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00040840: 7465 5f66 6f72 7761 7264 5f61 6464 315f  te_forward_add1_
+00040850: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+00040860: 2c20 7372 6331 2c20 6473 7429 3b0a 2020  , src1, dst);.  
+00040870: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00040880: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00040890: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+000408a0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000408b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000408c0: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
+000408d0: 474d 4c5f 5459 5045 5f46 3136 2920 7b0a  GML_TYPE_F16) {.
+000408e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000408f0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00040900: 5f66 6f72 7761 7264 5f61 6464 315f 6631  _forward_add1_f1
+00040910: 365f 6631 3628 7061 7261 6d73 2c20 7372  6_f16(params, sr
+00040920: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
+00040930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040940: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00040950: 2020 656c 7365 2069 6620 2873 7263 312d    else if (src1-
+00040960: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00040970: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
+00040980: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00040990: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000409a0: 7264 5f61 6464 315f 6631 365f 6633 3228  rd_add1_f16_f32(
+000409b0: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
+000409c0: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
+000409d0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000409e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000409f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00040a00: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00040a10: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+00040a20: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00040a30: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00040a40: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00040a50: 474d 4c5f 5459 5045 5f51 345f 303a 0a20  GML_TYPE_Q4_0:. 
+00040a60: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00040a70: 5f54 5950 455f 5134 5f31 3a0a 2020 2020  _TYPE_Q4_1:.    
+00040a80: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00040a90: 5045 5f51 355f 303a 0a20 2020 2020 2020  PE_Q5_0:.       
+00040aa0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00040ab0: 5135 5f31 3a0a 2020 2020 2020 2020 6361  Q5_1:.        ca
+00040ac0: 7365 2047 474d 4c5f 5459 5045 5f51 385f  se GGML_TYPE_Q8_
+00040ad0: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
+00040ae0: 4747 4d4c 5f54 5950 455f 5138 5f31 3a0a  GGML_TYPE_Q8_1:.
+00040af0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00040b00: 4c5f 5459 5045 5f51 325f 4b3a 0a20 2020  L_TYPE_Q2_K:.   
+00040b10: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00040b20: 5950 455f 5133 5f4b 3a0a 2020 2020 2020  YPE_Q3_K:.      
+00040b30: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00040b40: 5f51 345f 4b3a 0a20 2020 2020 2020 2063  _Q4_K:.        c
+00040b50: 6173 6520 4747 4d4c 5f54 5950 455f 5135  ase GGML_TYPE_Q5
+00040b60: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
+00040b70: 2047 474d 4c5f 5459 5045 5f51 365f 4b3a   GGML_TYPE_Q6_K:
+00040b80: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00040b90: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00040ba0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00040bb0: 6172 645f 6164 6431 5f71 5f66 3332 2870  ard_add1_q_f32(p
+00040bc0: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
+00040bd0: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
+00040be0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00040bf0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+00040c00: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00040c10: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00040c20: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+00040c30: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00040c40: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a0a  reak;.    }.}...
+00040c50: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
+00040c60: 666f 7277 6172 645f 6163 630a 0a73 7461  forward_acc..sta
+00040c70: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00040c80: 6d70 7574 655f 666f 7277 6172 645f 6163  mpute_forward_ac
+00040c90: 635f 6633 3228 0a20 2020 2020 2020 2063  c_f32(.        c
+00040ca0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00040cb0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+00040cc0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+00040cd0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00040ce0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00040cf0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
+00040d00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00040d10: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
+00040d20: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00040d30: 2067 676d 6c5f 7465 6e73 6f72 202a 206f   ggml_tensor * o
+00040d40: 7074 302c 0a20 2020 2020 2020 2073 7472  pt0,.        str
+00040d50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00040d60: 2a20 6473 7429 207b 0a20 2020 2047 474d  * dst) {.    GGM
+00040d70: 4c5f 4153 5345 5254 2867 676d 6c5f 6172  L_ASSERT(ggml_ar
+00040d80: 655f 7361 6d65 5f73 6861 7065 2873 7263  e_same_shape(src
+00040d90: 302c 2064 7374 2929 3b0a 2020 2020 4747  0, dst));.    GG
+00040da0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+00040db0: 735f 636f 6e74 6967 756f 7573 2864 7374  s_contiguous(dst
+00040dc0: 2920 2626 2067 676d 6c5f 6973 5f63 6f6e  ) && ggml_is_con
+00040dd0: 7469 6775 6f75 7328 7372 6330 2929 3b0a  tiguous(src0));.
+00040de0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00040df0: 286f 7074 302d 3e74 7970 6520 3d3d 2047  (opt0->type == G
+00040e00: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
+00040e10: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+00040e20: 676d 6c5f 6e65 6c65 6d65 6e74 7328 6f70  gml_nelements(op
+00040e30: 7430 2920 3d3d 2035 293b 0a0a 2020 2020  t0) == 5);..    
+00040e40: 2f2f 2076 6965 7720 7372 6330 2061 6e64  // view src0 and
+00040e50: 2064 7374 2077 6974 6820 7468 6573 6520   dst with these 
+00040e60: 7374 7269 6465 7320 616e 6420 6461 7461  strides and data
+00040e70: 206f 6666 7365 7420 696e 6279 7465 7320   offset inbytes 
+00040e80: 6475 7269 6e67 2061 6363 0a20 2020 202f  during acc.    /
+00040e90: 2f20 6e62 3020 6973 2069 6d70 6c69 6369  / nb0 is implici
+00040ea0: 7465 6c79 2065 6c65 6d65 6e74 5f73 697a  tely element_siz
+00040eb0: 6520 6265 6361 7573 6520 7372 6330 2061  e because src0 a
+00040ec0: 6e64 2064 7374 2061 7265 2063 6f6e 7469  nd dst are conti
+00040ed0: 6775 6f75 730a 2020 2020 7369 7a65 5f74  guous.    size_t
+00040ee0: 206e 6231 2020 2020 203d 2028 2869 6e74   nb1     = ((int
+00040ef0: 3332 5f74 202a 2920 6f70 7430 2d3e 6461  32_t *) opt0->da
+00040f00: 7461 295b 305d 3b0a 2020 2020 7369 7a65  ta)[0];.    size
+00040f10: 5f74 206e 6232 2020 2020 203d 2028 2869  _t nb2     = ((i
+00040f20: 6e74 3332 5f74 202a 2920 6f70 7430 2d3e  nt32_t *) opt0->
+00040f30: 6461 7461 295b 315d 3b0a 2020 2020 7369  data)[1];.    si
+00040f40: 7a65 5f74 206e 6233 2020 2020 203d 2028  ze_t nb3     = (
+00040f50: 2869 6e74 3332 5f74 202a 2920 6f70 7430  (int32_t *) opt0
+00040f60: 2d3e 6461 7461 295b 325d 3b0a 2020 2020  ->data)[2];.    
+00040f70: 7369 7a65 5f74 206f 6666 7365 7420 203d  size_t offset  =
+00040f80: 2028 2869 6e74 3332 5f74 202a 2920 6f70   ((int32_t *) op
+00040f90: 7430 2d3e 6461 7461 295b 335d 3b0a 2020  t0->data)[3];.  
+00040fa0: 2020 626f 6f6c 2020 2069 6e70 6c61 6365    bool   inplace
+00040fb0: 203d 2028 626f 6f6c 2920 2828 696e 7433   = (bool) ((int3
+00040fc0: 325f 7420 2a29 206f 7074 302d 3e64 6174  2_t *) opt0->dat
+00040fd0: 6129 5b34 5d3b 0a0a 2020 2020 6966 2028  a)[4];..    if (
+00040fe0: 2169 6e70 6c61 6365 2026 2620 2870 6172  !inplace && (par
+00040ff0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+00041000: 4c5f 5441 534b 5f49 4e49 5429 2920 7b0a  L_TASK_INIT)) {.
+00041010: 2020 2020 2020 2020 2f2f 206d 656d 6370          // memcp
+00041020: 7920 6e65 6564 7320 746f 2062 6520 7379  y needs to be sy
+00041030: 6e63 6872 6f6e 697a 6564 2061 6372 6f73  nchronized acros
+00041040: 7320 7468 7265 6164 7320 746f 2061 766f  s threads to avo
+00041050: 6964 2072 6163 6520 636f 6e64 6974 696f  id race conditio
+00041060: 6e73 2e0a 2020 2020 2020 2020 2f2f 203d  ns..        // =
+00041070: 3e20 646f 2069 7420 696e 2049 4e49 5420  > do it in INIT 
+00041080: 7068 6173 650a 2020 2020 2020 2020 6d65  phase.        me
+00041090: 6d63 7079 280a 2020 2020 2020 2020 2020  mcpy(.          
+000410a0: 2020 2828 6368 6172 202a 2920 2064 7374    ((char *)  dst
+000410b0: 2d3e 6461 7461 292c 0a20 2020 2020 2020  ->data),.       
+000410c0: 2020 2020 2028 2863 6861 7220 2a29 2073       ((char *) s
+000410d0: 7263 302d 3e64 6174 6129 2c0a 2020 2020  rc0->data),.    
+000410e0: 2020 2020 2020 2020 6767 6d6c 5f6e 6279          ggml_nby
+000410f0: 7465 7328 6473 7429 293b 0a20 2020 207d  tes(dst));.    }
+00041100: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+00041110: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00041120: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
+00041130: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+00041140: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+00041150: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+00041160: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
+00041170: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00041180: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+00041190: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+000411a0: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+000411b0: 636f 6e73 7420 696e 7420 6e72 203d 2067  const int nr = g
+000411c0: 676d 6c5f 6e72 6f77 7328 7372 6331 293b  gml_nrows(src1);
+000411d0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000411e0: 6320 3d20 7372 6331 2d3e 6e65 5b30 5d3b  c = src1->ne[0];
+000411f0: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
+00041200: 345f 7420 6e65 3130 203d 2073 7263 312d  4_t ne10 = src1-
+00041210: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+00041220: 7420 696e 7436 345f 7420 6e65 3131 203d  t int64_t ne11 =
+00041230: 2073 7263 312d 3e6e 655b 315d 3b0a 2020   src1->ne[1];.  
+00041240: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00041250: 6e65 3132 203d 2073 7263 312d 3e6e 655b  ne12 = src1->ne[
+00041260: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+00041270: 7436 345f 7420 6e65 3133 203d 2073 7263  t64_t ne13 = src
+00041280: 312d 3e6e 655b 335d 3b0a 0a20 2020 2063  1->ne[3];..    c
+00041290: 6f6e 7374 2073 697a 655f 7420 6e62 3130  onst size_t nb10
+000412a0: 203d 2073 7263 312d 3e6e 625b 305d 3b0a   = src1->nb[0];.
+000412b0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+000412c0: 206e 6231 3120 3d20 7372 6331 2d3e 6e62   nb11 = src1->nb
+000412d0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2073  [1];.    const s
+000412e0: 697a 655f 7420 6e62 3132 203d 2073 7263  ize_t nb12 = src
+000412f0: 312d 3e6e 625b 325d 3b0a 2020 2020 636f  1->nb[2];.    co
+00041300: 6e73 7420 7369 7a65 5f74 206e 6231 3320  nst size_t nb13 
+00041310: 3d20 7372 6331 2d3e 6e62 5b33 5d3b 0a0a  = src1->nb[3];..
+00041320: 2020 2020 2f2f 2073 7263 3020 616e 6420      // src0 and 
+00041330: 6473 7420 6173 2076 6965 7765 6420 6475  dst as viewed du
+00041340: 7269 6e67 2061 6363 0a20 2020 2063 6f6e  ring acc.    con
+00041350: 7374 2073 697a 655f 7420 6e62 3020 3d20  st size_t nb0 = 
+00041360: 6767 6d6c 5f65 6c65 6d65 6e74 5f73 697a  ggml_element_siz
+00041370: 6528 7372 6330 293b 0a0a 2020 2020 636f  e(src0);..    co
+00041380: 6e73 7420 7369 7a65 5f74 206e 6230 3020  nst size_t nb00 
+00041390: 3d20 6e62 303b 0a20 2020 2063 6f6e 7374  = nb0;.    const
+000413a0: 2073 697a 655f 7420 6e62 3031 203d 206e   size_t nb01 = n
+000413b0: 6231 3b0a 2020 2020 636f 6e73 7420 7369  b1;.    const si
+000413c0: 7a65 5f74 206e 6230 3220 3d20 6e62 323b  ze_t nb02 = nb2;
+000413d0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+000413e0: 7420 6e62 3033 203d 206e 6233 3b0a 0a20  t nb03 = nb3;.. 
+000413f0: 2020 2047 474d 4c5f 4153 5345 5254 286f     GGML_ASSERT(o
+00041400: 6666 7365 7420 2b20 286e 6531 3020 3d3d  ffset + (ne10 ==
+00041410: 2030 203f 2030 203a 206e 6531 302d 3129   0 ? 0 : ne10-1)
+00041420: 2a6e 6230 2020 2b20 286e 6531 3120 3d3d  *nb0  + (ne11 ==
+00041430: 2030 203f 2030 203a 206e 6531 312d 3129   0 ? 0 : ne11-1)
+00041440: 2a6e 6231 2020 2b20 286e 6531 3220 3d3d  *nb1  + (ne12 ==
+00041450: 2030 203f 2030 203a 206e 6531 322d 3129   0 ? 0 : ne12-1)
+00041460: 2a6e 6232 2020 2b20 286e 6531 3320 3d3d  *nb2  + (ne13 ==
+00041470: 2030 203f 2030 203a 206e 6531 332d 3129   0 ? 0 : ne13-1)
+00041480: 2a6e 6233 2020 3c20 6767 6d6c 5f6e 6279  *nb3  < ggml_nby
+00041490: 7465 7328 6473 7429 293b 0a20 2020 2047  tes(dst));.    G
+000414a0: 474d 4c5f 4153 5345 5254 286f 6666 7365  GML_ASSERT(offse
+000414b0: 7420 2b20 286e 6531 3020 3d3d 2030 203f  t + (ne10 == 0 ?
+000414c0: 2030 203a 206e 6531 302d 3129 2a6e 6230   0 : ne10-1)*nb0
+000414d0: 3020 2b20 286e 6531 3120 3d3d 2030 203f  0 + (ne11 == 0 ?
+000414e0: 2030 203a 206e 6531 312d 3129 2a6e 6230   0 : ne11-1)*nb0
+000414f0: 3120 2b20 286e 6531 3220 3d3d 2030 203f  1 + (ne12 == 0 ?
+00041500: 2030 203a 206e 6531 322d 3129 2a6e 6230   0 : ne12-1)*nb0
+00041510: 3220 2b20 286e 6531 3320 3d3d 2030 203f  2 + (ne13 == 0 ?
+00041520: 2030 203a 206e 6531 332d 3129 2a6e 6230   0 : ne13-1)*nb0
+00041530: 3320 3c20 6767 6d6c 5f6e 6279 7465 7328  3 < ggml_nbytes(
+00041540: 7372 6330 2929 3b0a 0a20 2020 2047 474d  src0));..    GGM
+00041550: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
+00041560: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00041570: 0a0a 2020 2020 2f2f 2072 6f77 7320 7065  ..    // rows pe
+00041580: 7220 7468 7265 6164 0a20 2020 2063 6f6e  r thread.    con
+00041590: 7374 2069 6e74 2064 7220 3d20 286e 7220  st int dr = (nr 
+000415a0: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
+000415b0: 0a20 2020 202f 2f20 726f 7720 7261 6e67  .    // row rang
+000415c0: 6520 666f 7220 7468 6973 2074 6872 6561  e for this threa
+000415d0: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
+000415e0: 6972 3020 3d20 6472 2a69 7468 3b0a 2020  ir0 = dr*ith;.  
+000415f0: 2020 636f 6e73 7420 696e 7420 6972 3120    const int ir1 
+00041600: 3d20 4d49 4e28 6972 3020 2b20 6472 2c20  = MIN(ir0 + dr, 
+00041610: 6e72 293b 0a0a 2020 2020 666f 7220 2869  nr);..    for (i
+00041620: 6e74 2069 7220 3d20 6972 303b 2069 7220  nt ir = ir0; ir 
+00041630: 3c20 6972 313b 202b 2b69 7229 207b 0a20  < ir1; ++ir) {. 
+00041640: 2020 2020 2020 202f 2f20 7372 6330 2061         // src0 a
+00041650: 6e64 2064 7374 2061 7265 2076 6965 7765  nd dst are viewe
+00041660: 6420 7769 7468 2073 6861 7065 206f 6620  d with shape of 
+00041670: 7372 6331 2061 6e64 206f 6666 7365 740a  src1 and offset.
+00041680: 2020 2020 2020 2020 2f2f 203d 3e20 7361          // => sa
+00041690: 6d65 2069 6e64 6963 6573 0a20 2020 2020  me indices.     
+000416a0: 2020 2063 6f6e 7374 2069 6e74 2069 3320     const int i3 
+000416b0: 3d20 6972 2f28 6e65 3132 2a6e 6531 3129  = ir/(ne12*ne11)
+000416c0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
+000416d0: 696e 7420 6932 203d 2028 6972 202d 2069  int i2 = (ir - i
+000416e0: 332a 6e65 3132 2a6e 6531 3129 2f6e 6531  3*ne12*ne11)/ne1
+000416f0: 313b 0a20 2020 2020 2020 2063 6f6e 7374  1;.        const
+00041700: 2069 6e74 2069 3120 3d20 2869 7220 2d20   int i1 = (ir - 
+00041710: 6933 2a6e 6531 322a 6e65 3131 202d 2069  i3*ne12*ne11 - i
+00041720: 322a 6e65 3131 293b 0a0a 2369 6664 6566  2*ne11);..#ifdef
+00041730: 2047 474d 4c5f 5553 455f 4143 4345 4c45   GGML_USE_ACCELE
+00041740: 5241 5445 0a20 2020 2020 2020 2076 4453  RATE.        vDS
+00041750: 505f 7661 6464 280a 2020 2020 2020 2020  P_vadd(.        
+00041760: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+00041770: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+00041780: 2d3e 6461 7461 202b 2069 332a 6e62 3033  ->data + i3*nb03
+00041790: 202b 2069 322a 6e62 3032 202b 2069 312a   + i2*nb02 + i1*
+000417a0: 6e62 3031 202b 206f 6666 7365 7429 2c20  nb01 + offset), 
+000417b0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+000417c0: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+000417d0: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
+000417e0: 6120 2b20 6933 2a6e 6231 3320 2b20 6932  a + i3*nb13 + i2
+000417f0: 2a6e 6231 3220 2b20 6931 2a6e 6231 3129  *nb12 + i1*nb11)
+00041800: 2c20 312c 0a20 2020 2020 2020 2020 2020  , 1,.           
+00041810: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00041820: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
+00041830: 7461 2020 2b20 6933 2a6e 6233 2020 2b20  ta  + i3*nb3  + 
+00041840: 6932 2a6e 6232 2020 2b20 6931 2a6e 6231  i2*nb2  + i1*nb1
+00041850: 2020 2b20 6f66 6673 6574 292c 2031 2c20    + offset), 1, 
+00041860: 6e63 293b 0a23 656c 7365 0a20 2020 2020  nc);.#else.     
+00041870: 2020 2067 676d 6c5f 7665 635f 6164 645f     ggml_vec_add_
+00041880: 6633 3228 6e63 2c0a 2020 2020 2020 2020  f32(nc,.        
+00041890: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+000418a0: 2920 2828 6368 6172 202a 2920 2064 7374  ) ((char *)  dst
+000418b0: 2d3e 6461 7461 202b 2069 332a 6e62 3320  ->data + i3*nb3 
+000418c0: 202b 2069 322a 6e62 3220 202b 2069 312a   + i2*nb2  + i1*
+000418d0: 6e62 3120 202b 206f 6666 7365 7429 2c0a  nb1  + offset),.
+000418e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000418f0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+00041900: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00041910: 2069 332a 6e62 3033 202b 2069 322a 6e62   i3*nb03 + i2*nb
+00041920: 3032 202b 2069 312a 6e62 3031 202b 206f  02 + i1*nb01 + o
+00041930: 6666 7365 7429 2c0a 2020 2020 2020 2020  ffset),.        
+00041940: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+00041950: 2920 2828 6368 6172 202a 2920 7372 6331  ) ((char *) src1
+00041960: 2d3e 6461 7461 202b 2069 332a 6e62 3133  ->data + i3*nb13
+00041970: 202b 2069 322a 6e62 3132 202b 2069 312a   + i2*nb12 + i1*
+00041980: 6e62 3131 2929 3b0a 2365 6e64 6966 0a20  nb11));.#endif. 
+00041990: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
+000419a0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+000419b0: 5f66 6f72 7761 7264 5f61 6363 280a 2020  _forward_acc(.  
+000419c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000419d0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+000419e0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+000419f0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00041a00: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00041a10: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00041a20: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00041a30: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00041a40: 312c 0a20 2020 2020 2020 2063 6f6e 7374  1,.        const
+00041a50: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00041a60: 736f 7220 2a20 6f70 7430 2c0a 2020 2020  sor * opt0,.    
+00041a70: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00041a80: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+00041a90: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
+00041aa0: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+00041ab0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00041ac0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
+00041ad0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00041ae0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00041af0: 655f 666f 7277 6172 645f 6163 635f 6633  e_forward_acc_f3
+00041b00: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+00041b10: 7372 6331 2c20 6f70 7430 2c20 6473 7429  src1, opt0, dst)
+00041b20: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00041b30: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00041b40: 6173 6520 4747 4d4c 5f54 5950 455f 4631  ase GGML_TYPE_F1
+00041b50: 363a 0a20 2020 2020 2020 2063 6173 6520  6:.        case 
+00041b60: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
+00041b70: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00041b80: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
+00041b90: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00041ba0: 5950 455f 5135 5f30 3a0a 2020 2020 2020  YPE_Q5_0:.      
+00041bb0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00041bc0: 5f51 355f 313a 0a20 2020 2020 2020 2063  _Q5_1:.        c
+00041bd0: 6173 6520 4747 4d4c 5f54 5950 455f 5138  ase GGML_TYPE_Q8
+00041be0: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
+00041bf0: 2047 474d 4c5f 5459 5045 5f51 385f 313a   GGML_TYPE_Q8_1:
+00041c00: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00041c10: 4d4c 5f54 5950 455f 5132 5f4b 3a0a 2020  ML_TYPE_Q2_K:.  
+00041c20: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00041c30: 5459 5045 5f51 335f 4b3a 0a20 2020 2020  TYPE_Q3_K:.     
+00041c40: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00041c50: 455f 5134 5f4b 3a0a 2020 2020 2020 2020  E_Q4_K:.        
+00041c60: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+00041c70: 355f 4b3a 0a20 2020 2020 2020 2063 6173  5_K:.        cas
+00041c80: 6520 4747 4d4c 5f54 5950 455f 5136 5f4b  e GGML_TYPE_Q6_K
+00041c90: 3a0a 2020 2020 2020 2020 6465 6661 756c  :.        defaul
+00041ca0: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
+00041cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041cc0: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+00041cd0: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
+00041ce0: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
+00041cf0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00041d00: 7465 5f66 6f72 7761 7264 5f73 7562 0a0a  te_forward_sub..
+00041d10: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00041d20: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00041d30: 5f73 7562 5f66 3332 280a 2020 2020 2020  _sub_f32(.      
+00041d40: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00041d50: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00041d60: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00041d70: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00041d80: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00041d90: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+00041da0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00041db0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+00041dc0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00041dd0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00041de0: 207b 0a20 2020 2061 7373 6572 7428 7061   {.    assert(pa
+00041df0: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
+00041e00: 0a20 2020 2061 7373 6572 7428 6767 6d6c  .    assert(ggml
+00041e10: 5f61 7265 5f73 616d 655f 7368 6170 6528  _are_same_shape(
+00041e20: 7372 6330 2c20 7372 6331 2920 2626 2067  src0, src1) && g
+00041e30: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
+00041e40: 7065 2873 7263 302c 2064 7374 2929 3b0a  pe(src0, dst));.
+00041e50: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00041e60: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00041e70: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+00041e80: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00041e90: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+00041ea0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+00041eb0: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
+00041ec0: 7420 696e 7420 6e72 2020 3d20 6767 6d6c  t int nr  = ggml
+00041ed0: 5f6e 726f 7773 2873 7263 3029 3b0a 2020  _nrows(src0);.  
+00041ee0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00041ef0: 6e65 3020 3d20 7372 6330 2d3e 6e65 5b30  ne0 = src0->ne[0
+00041f00: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00041f10: 3634 5f74 206e 6531 203d 2073 7263 302d  64_t ne1 = src0-
+00041f20: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
+00041f30: 7420 696e 7436 345f 7420 6e65 3220 3d20  t int64_t ne2 = 
+00041f40: 7372 6330 2d3e 6e65 5b32 5d3b 0a0a 2020  src0->ne[2];..  
+00041f50: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+00041f60: 6230 3020 3d20 7372 6330 2d3e 6e62 5b30  b00 = src0->nb[0
+00041f70: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+00041f80: 655f 7420 6e62 3031 203d 2073 7263 302d  e_t nb01 = src0-
+00041f90: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00041fa0: 7420 7369 7a65 5f74 206e 6230 3220 3d20  t size_t nb02 = 
+00041fb0: 7372 6330 2d3e 6e62 5b32 5d3b 0a20 2020  src0->nb[2];.   
+00041fc0: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+00041fd0: 3033 203d 2073 7263 302d 3e6e 625b 335d  03 = src0->nb[3]
+00041fe0: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
+00041ff0: 655f 7420 6e62 3130 203d 2073 7263 312d  e_t nb10 = src1-
+00042000: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
+00042010: 7420 7369 7a65 5f74 206e 6231 3120 3d20  t size_t nb11 = 
+00042020: 7372 6331 2d3e 6e62 5b31 5d3b 0a20 2020  src1->nb[1];.   
+00042030: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+00042040: 3132 203d 2073 7263 312d 3e6e 625b 325d  12 = src1->nb[2]
+00042050: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
+00042060: 5f74 206e 6231 3320 3d20 7372 6331 2d3e  _t nb13 = src1->
+00042070: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
+00042080: 7420 7369 7a65 5f74 206e 6230 203d 2064  t size_t nb0 = d
+00042090: 7374 2d3e 6e62 5b30 5d3b 0a20 2020 2063  st->nb[0];.    c
+000420a0: 6f6e 7374 2073 697a 655f 7420 6e62 3120  onst size_t nb1 
+000420b0: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
+000420c0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+000420d0: 6232 203d 2064 7374 2d3e 6e62 5b32 5d3b  b2 = dst->nb[2];
+000420e0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+000420f0: 7420 6e62 3320 3d20 6473 742d 3e6e 625b  t nb3 = dst->nb[
+00042100: 335d 3b0a 0a20 2020 2047 474d 4c5f 4153  3];..    GGML_AS
+00042110: 5345 5254 2820 6e62 3020 3d3d 2073 697a  SERT( nb0 == siz
+00042120: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
+00042130: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
+00042140: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
+00042150: 7429 293b 0a0a 2020 2020 6966 2028 6e62  t));..    if (nb
+00042160: 3130 203d 3d20 7369 7a65 6f66 2866 6c6f  10 == sizeof(flo
+00042170: 6174 2929 207b 0a20 2020 2020 2020 2066  at)) {.        f
+00042180: 6f72 2028 696e 7420 6972 203d 2030 3b20  or (int ir = 0; 
+00042190: 6972 203c 206e 723b 202b 2b69 7229 207b  ir < nr; ++ir) {
+000421a0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+000421b0: 7372 6330 2c20 7372 6331 2061 6e64 2064  src0, src1 and d
+000421c0: 7374 2061 7265 2073 616d 6520 7368 6170  st are same shap
+000421d0: 6520 3d3e 2073 616d 6520 696e 6469 6365  e => same indice
+000421e0: 730a 2020 2020 2020 2020 2020 2020 636f  s.            co
+000421f0: 6e73 7420 696e 7420 6933 203d 2069 722f  nst int i3 = ir/
+00042200: 286e 6532 2a6e 6531 293b 0a20 2020 2020  (ne2*ne1);.     
+00042210: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00042220: 2069 3220 3d20 2869 7220 2d20 6933 2a6e   i2 = (ir - i3*n
+00042230: 6532 2a6e 6531 292f 6e65 313b 0a20 2020  e2*ne1)/ne1;.   
+00042240: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+00042250: 6e74 2069 3120 3d20 2869 7220 2d20 6933  nt i1 = (ir - i3
+00042260: 2a6e 6532 2a6e 6531 202d 2069 322a 6e65  *ne2*ne1 - i2*ne
+00042270: 3129 3b0a 0a0a 2369 6664 6566 2047 474d  1);...#ifdef GGM
+00042280: 4c5f 5553 455f 4143 4345 4c45 5241 5445  L_USE_ACCELERATE
+00042290: 0a20 2020 2020 2020 2020 2020 2076 4453  .            vDS
+000422a0: 505f 7673 7562 280a 2020 2020 2020 2020  P_vsub(.        
+000422b0: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+000422c0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+000422d0: 7372 6331 2d3e 6461 7461 202b 2069 332a  src1->data + i3*
+000422e0: 6e62 3133 202b 2069 322a 6e62 3132 202b  nb13 + i2*nb12 +
+000422f0: 2069 312a 6e62 3131 292c 2031 2c0a 2020   i1*nb11), 1,.  
+00042300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042310: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+00042320: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+00042330: 202b 2069 332a 6e62 3033 202b 2069 322a   + i3*nb03 + i2*
+00042340: 6e62 3032 202b 2069 312a 6e62 3031 292c  nb02 + i1*nb01),
+00042350: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
+00042360: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+00042370: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
+00042380: 3e64 6174 6120 202b 2069 332a 6e62 3320  >data  + i3*nb3 
+00042390: 202b 2069 322a 6e62 3220 202b 2069 312a   + i2*nb2  + i1*
+000423a0: 6e62 3120 292c 2031 2c0a 2020 2020 2020  nb1 ), 1,.      
+000423b0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+000423c0: 3029 3b0a 2365 6c73 650a 2020 2020 2020  0);.#else.      
+000423d0: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+000423e0: 7562 5f66 3332 286e 6530 2c0a 2020 2020  ub_f32(ne0,.    
+000423f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042400: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+00042410: 202a 2920 6473 742d 3e64 6174 6120 202b   *) dst->data  +
+00042420: 2069 332a 6e62 3320 202b 2069 322a 6e62   i3*nb3  + i2*nb
+00042430: 3220 202b 2069 312a 6e62 3120 292c 0a20  2  + i1*nb1 ),. 
+00042440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042450: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+00042460: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+00042470: 6120 2b20 6933 2a6e 6230 3320 2b20 6932  a + i3*nb03 + i2
+00042480: 2a6e 6230 3220 2b20 6931 2a6e 6230 3129  *nb02 + i1*nb01)
+00042490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000424a0: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+000424b0: 2828 6368 6172 202a 2920 7372 6331 2d3e  ((char *) src1->
+000424c0: 6461 7461 202b 2069 332a 6e62 3133 202b  data + i3*nb13 +
+000424d0: 2069 322a 6e62 3132 202b 2069 312a 6e62   i2*nb12 + i1*nb
+000424e0: 3131 2929 3b0a 2365 6e64 6966 0a20 2020  11));.#endif.   
+000424f0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00042500: 7d0a 2020 2020 2020 2020 2020 2020 2f2f  }.            //
+00042510: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
+00042520: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
+00042530: 2020 2f2f 2073 7263 3120 6973 206e 6f74    // src1 is not
+00042540: 2063 6f6e 7469 6775 6f75 730a 2020 2020   contiguous.    
+00042550: 2020 2020 666f 7220 2869 6e74 2069 7220      for (int ir 
+00042560: 3d20 303b 2069 7220 3c20 6e72 3b20 2b2b  = 0; ir < nr; ++
+00042570: 6972 2920 7b0a 2020 2020 2020 2020 2020  ir) {.          
+00042580: 2020 2f2f 2073 7263 302c 2073 7263 3120    // src0, src1 
+00042590: 616e 6420 6473 7420 6172 6520 7361 6d65  and dst are same
+000425a0: 2073 6861 7065 203d 3e20 7361 6d65 2069   shape => same i
+000425b0: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
+000425c0: 2020 2063 6f6e 7374 2069 6e74 2069 3320     const int i3 
+000425d0: 3d20 6972 2f28 6e65 322a 6e65 3129 3b0a  = ir/(ne2*ne1);.
+000425e0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000425f0: 7420 696e 7420 6932 203d 2028 6972 202d  t int i2 = (ir -
+00042600: 2069 332a 6e65 322a 6e65 3129 2f6e 6531   i3*ne2*ne1)/ne1
+00042610: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+00042620: 6e73 7420 696e 7420 6931 203d 2028 6972  nst int i1 = (ir
+00042630: 202d 2069 332a 6e65 322a 6e65 3120 2d20   - i3*ne2*ne1 - 
+00042640: 6932 2a6e 6531 293b 0a0a 2020 2020 2020  i2*ne1);..      
+00042650: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
+00042660: 745f 7074 7220 203d 2028 666c 6f61 7420  t_ptr  = (float 
+00042670: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
+00042680: 2d3e 6461 7461 2020 2b20 6933 2a6e 6233  ->data  + i3*nb3
+00042690: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
+000426a0: 2a6e 6231 2029 3b0a 2020 2020 2020 2020  *nb1 );.        
+000426b0: 2020 2020 666c 6f61 7420 2a20 7372 6330      float * src0
+000426c0: 5f70 7472 203d 2028 666c 6f61 7420 2a29  _ptr = (float *)
+000426d0: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
+000426e0: 3e64 6174 6120 2b20 6933 2a6e 6230 3320  >data + i3*nb03 
+000426f0: 2b20 6932 2a6e 6230 3220 2b20 6931 2a6e  + i2*nb02 + i1*n
+00042700: 6230 3129 3b0a 2020 2020 2020 2020 2020  b01);.          
+00042710: 2020 666f 7220 2869 6e74 2069 3020 3d20    for (int i0 = 
+00042720: 303b 2069 3020 3c20 6e65 303b 2069 302b  0; i0 < ne0; i0+
+00042730: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00042740: 2020 2020 2066 6c6f 6174 202a 2073 7263       float * src
+00042750: 315f 7074 7220 3d20 2866 6c6f 6174 202a  1_ptr = (float *
+00042760: 2920 2828 6368 6172 202a 2920 7372 6331  ) ((char *) src1
+00042770: 2d3e 6461 7461 202b 2069 332a 6e62 3133  ->data + i3*nb13
+00042780: 202b 2069 322a 6e62 3132 202b 2069 312a   + i2*nb12 + i1*
+00042790: 6e62 3131 202b 2069 302a 6e62 3130 293b  nb11 + i0*nb10);
+000427a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000427b0: 2020 6473 745f 7074 725b 6930 5d20 3d20    dst_ptr[i0] = 
+000427c0: 7372 6330 5f70 7472 5b69 305d 202d 202a  src0_ptr[i0] - *
+000427d0: 7372 6331 5f70 7472 3b0a 2020 2020 2020  src1_ptr;.      
+000427e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000427f0: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
+00042800: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+00042810: 7574 655f 666f 7277 6172 645f 7375 6228  ute_forward_sub(
+00042820: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00042830: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00042840: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00042850: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00042860: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00042870: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00042880: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00042890: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000428a0: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
+000428b0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000428c0: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
+000428d0: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
+000428e0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+000428f0: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
+00042900: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00042910: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00042920: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00042930: 7264 5f73 7562 5f66 3332 2870 6172 616d  rd_sub_f32(param
+00042940: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
+00042950: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
+00042960: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00042970: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
+00042980: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00042990: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+000429a0: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
+000429b0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+000429c0: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
+000429d0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000429e0: 7264 5f6d 756c 0a0a 7374 6174 6963 2076  rd_mul..static v
+000429f0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+00042a00: 5f66 6f72 7761 7264 5f6d 756c 5f66 3332  _forward_mul_f32
+00042a10: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00042a20: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00042a30: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00042a40: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00042a50: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00042a60: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00042a70: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00042a80: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00042a90: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
+00042aa0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00042ab0: 7220 2a20 6473 7429 207b 0a20 2020 2047  r * dst) {.    G
+00042ac0: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+00042ad0: 6361 6e5f 7265 7065 6174 5f72 6f77 7328  can_repeat_rows(
+00042ae0: 7372 6331 2c20 7372 6330 2920 2626 2067  src1, src0) && g
+00042af0: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
+00042b00: 7065 2873 7263 302c 2064 7374 2929 3b0a  pe(src0, dst));.
+00042b10: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00042b20: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00042b30: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+00042b40: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00042b50: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+00042b60: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+00042b70: 0a20 2020 207d 0a20 2020 2063 6f6e 7374  .    }.    const
+00042b80: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
+00042b90: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
+00042ba0: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
+00042bb0: 6d73 2d3e 6e74 683b 0a0a 2369 6664 6566  ms->nth;..#ifdef
+00042bc0: 2047 474d 4c5f 5553 455f 434c 424c 4153   GGML_USE_CLBLAS
+00042bd0: 540a 2020 2020 6966 2028 7372 6331 2d3e  T.    if (src1->
+00042be0: 6261 636b 656e 6420 3d3d 2047 474d 4c5f  backend == GGML_
+00042bf0: 4241 434b 454e 445f 4750 5529 207b 0a20  BACKEND_GPU) {. 
+00042c00: 2020 2020 2020 2069 6620 2869 7468 203d         if (ith =
+00042c10: 3d20 3029 207b 0a20 2020 2020 2020 2020  = 0) {.         
+00042c20: 2020 2067 676d 6c5f 636c 5f6d 756c 2873     ggml_cl_mul(s
+00042c30: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
+00042c40: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00042c50: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+00042c60: 0a23 656e 6469 660a 0a20 2020 2063 6f6e  .#endif..    con
+00042c70: 7374 2069 6e74 3634 5f74 206e 7220 3d20  st int64_t nr = 
+00042c80: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
+00042c90: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00042ca0: 3634 5f74 206e 6530 3020 3d20 7372 6330  64_t ne00 = src0
+00042cb0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00042cc0: 7374 2069 6e74 3634 5f74 206e 6530 3120  st int64_t ne01 
+00042cd0: 3d20 7372 6330 2d3e 6e65 5b31 5d3b 0a20  = src0->ne[1];. 
+00042ce0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00042cf0: 206e 6530 3220 3d20 7372 6330 2d3e 6e65   ne02 = src0->ne
+00042d00: 5b32 5d3b 0a0a 2020 2020 636f 6e73 7420  [2];..    const 
+00042d10: 696e 7436 345f 7420 6e65 3130 203d 2073  int64_t ne10 = s
+00042d20: 7263 312d 3e6e 655b 305d 3b0a 2020 2020  rc1->ne[0];.    
+00042d30: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00042d40: 3131 203d 2073 7263 312d 3e6e 655b 315d  11 = src1->ne[1]
+00042d50: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+00042d60: 345f 7420 6e65 3132 203d 2073 7263 312d  4_t ne12 = src1-
+00042d70: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
+00042d80: 7420 696e 7436 345f 7420 6e65 3133 203d  t int64_t ne13 =
+00042d90: 2073 7263 312d 3e6e 655b 335d 3b0a 0a20   src1->ne[3];.. 
+00042da0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+00042db0: 6e62 3030 203d 2073 7263 302d 3e6e 625b  nb00 = src0->nb[
+00042dc0: 305d 3b0a 2020 2020 636f 6e73 7420 7369  0];.    const si
+00042dd0: 7a65 5f74 206e 6230 3120 3d20 7372 6330  ze_t nb01 = src0
+00042de0: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
+00042df0: 7374 2073 697a 655f 7420 6e62 3032 203d  st size_t nb02 =
+00042e00: 2073 7263 302d 3e6e 625b 325d 3b0a 2020   src0->nb[2];.  
+00042e10: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+00042e20: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
+00042e30: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
+00042e40: 7a65 5f74 206e 6231 3020 3d20 7372 6331  ze_t nb10 = src1
+00042e50: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+00042e60: 7374 2073 697a 655f 7420 6e62 3131 203d  st size_t nb11 =
+00042e70: 2073 7263 312d 3e6e 625b 315d 3b0a 2020   src1->nb[1];.  
+00042e80: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+00042e90: 6231 3220 3d20 7372 6331 2d3e 6e62 5b32  b12 = src1->nb[2
+00042ea0: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+00042eb0: 655f 7420 6e62 3133 203d 2073 7263 312d  e_t nb13 = src1-
+00042ec0: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
+00042ed0: 7374 2073 697a 655f 7420 6e62 3020 3d20  st size_t nb0 = 
+00042ee0: 6473 742d 3e6e 625b 305d 3b0a 2020 2020  dst->nb[0];.    
+00042ef0: 636f 6e73 7420 7369 7a65 5f74 206e 6231  const size_t nb1
+00042f00: 203d 2064 7374 2d3e 6e62 5b31 5d3b 0a20   = dst->nb[1];. 
+00042f10: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+00042f20: 6e62 3220 3d20 6473 742d 3e6e 625b 325d  nb2 = dst->nb[2]
+00042f30: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
+00042f40: 5f74 206e 6233 203d 2064 7374 2d3e 6e62  _t nb3 = dst->nb
+00042f50: 5b33 5d3b 0a0a 2020 2020 4747 4d4c 5f41  [3];..    GGML_A
+00042f60: 5353 4552 5428 206e 6230 203d 3d20 7369  SSERT( nb0 == si
+00042f70: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
+00042f80: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+00042f90: 3030 203d 3d20 7369 7a65 6f66 2866 6c6f  00 == sizeof(flo
+00042fa0: 6174 2929 3b0a 2020 2020 4747 4d4c 5f41  at));.    GGML_A
+00042fb0: 5353 4552 5428 6e65 3030 203d 3d20 6e65  SSERT(ne00 == ne
+00042fc0: 3130 293b 0a0a 2020 2020 6966 2028 6e62  10);..    if (nb
+00042fd0: 3130 203d 3d20 7369 7a65 6f66 2866 6c6f  10 == sizeof(flo
+00042fe0: 6174 2929 207b 0a20 2020 2020 2020 2066  at)) {.        f
+00042ff0: 6f72 2028 696e 7436 345f 7420 6972 203d  or (int64_t ir =
+00043000: 2069 7468 3b20 6972 203c 206e 723b 2069   ith; ir < nr; i
+00043010: 7220 2b3d 206e 7468 2920 7b0a 2020 2020  r += nth) {.    
+00043020: 2020 2020 2020 2020 2f2f 2073 7263 3020          // src0 
+00043030: 616e 6420 6473 7420 6172 6520 7361 6d65  and dst are same
+00043040: 2073 6861 7065 203d 3e20 7361 6d65 2069   shape => same i
+00043050: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
+00043060: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00043070: 2069 3033 203d 2069 722f 286e 6530 322a   i03 = ir/(ne02*
+00043080: 6e65 3031 293b 0a20 2020 2020 2020 2020  ne01);.         
+00043090: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+000430a0: 2069 3032 203d 2028 6972 202d 2069 3033   i02 = (ir - i03
+000430b0: 2a6e 6530 322a 6e65 3031 292f 6e65 3031  *ne02*ne01)/ne01
+000430c0: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+000430d0: 6e73 7420 696e 7436 345f 7420 6930 3120  nst int64_t i01 
+000430e0: 3d20 2869 7220 2d20 6930 332a 6e65 3032  = (ir - i03*ne02
+000430f0: 2a6e 6530 3120 2d20 6930 322a 6e65 3031  *ne01 - i02*ne01
+00043100: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00043110: 636f 6e73 7420 696e 7436 345f 7420 6931  const int64_t i1
+00043120: 3320 3d20 6930 3320 2520 6e65 3133 3b0a  3 = i03 % ne13;.
+00043130: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00043140: 7420 696e 7436 345f 7420 6931 3220 3d20  t int64_t i12 = 
+00043150: 6930 3220 2520 6e65 3132 3b0a 2020 2020  i02 % ne12;.    
+00043160: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00043170: 7436 345f 7420 6931 3120 3d20 6930 3120  t64_t i11 = i01 
+00043180: 2520 6e65 3131 3b0a 0a20 2020 2020 2020  % ne11;..       
+00043190: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
+000431a0: 5f70 7472 2020 3d20 2866 6c6f 6174 202a  _ptr  = (float *
+000431b0: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
+000431c0: 3e64 6174 6120 202b 2069 3033 2a6e 6233  >data  + i03*nb3
+000431d0: 2020 2b20 6930 322a 6e62 3220 202b 2069    + i02*nb2  + i
+000431e0: 3031 2a6e 6231 2029 3b0a 2020 2020 2020  01*nb1 );.      
+000431f0: 2020 2020 2020 666c 6f61 7420 2a20 7372        float * sr
+00043200: 6330 5f70 7472 203d 2028 666c 6f61 7420  c0_ptr = (float 
+00043210: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+00043220: 302d 3e64 6174 6120 2b20 6930 332a 6e62  0->data + i03*nb
+00043230: 3033 202b 2069 3032 2a6e 6230 3220 2b20  03 + i02*nb02 + 
+00043240: 6930 312a 6e62 3031 293b 0a20 2020 2020  i01*nb01);.     
+00043250: 2020 2020 2020 2066 6c6f 6174 202a 2073         float * s
+00043260: 7263 315f 7074 7220 3d20 2866 6c6f 6174  rc1_ptr = (float
+00043270: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
+00043280: 6331 2d3e 6461 7461 202b 2069 3133 2a6e  c1->data + i13*n
+00043290: 6231 3320 2b20 6931 322a 6e62 3132 202b  b13 + i12*nb12 +
+000432a0: 2069 3131 2a6e 6231 3129 3b0a 0a23 6966   i11*nb11);..#if
+000432b0: 6465 6620 4747 4d4c 5f55 5345 5f41 4343  def GGML_USE_ACC
+000432c0: 454c 4552 4154 450a 2020 2020 2020 2020  ELERATE.        
+000432d0: 2020 2020 554e 5553 4544 2867 676d 6c5f      UNUSED(ggml_
+000432e0: 7665 635f 6d75 6c5f 6633 3229 3b0a 0a20  vec_mul_f32);.. 
+000432f0: 2020 2020 2020 2020 2020 2076 4453 505f             vDSP_
+00043300: 766d 756c 2820 7372 6330 5f70 7472 2c20  vmul( src0_ptr, 
+00043310: 312c 2073 7263 315f 7074 722c 2031 2c20  1, src1_ptr, 1, 
+00043320: 6473 745f 7074 722c 2020 312c 206e 6530  dst_ptr,  1, ne0
+00043330: 3029 3b0a 2365 6c73 650a 2020 2020 2020  0);.#else.      
+00043340: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
+00043350: 756c 5f66 3332 286e 6530 302c 2064 7374  ul_f32(ne00, dst
+00043360: 5f70 7472 2c20 7372 6330 5f70 7472 2c20  _ptr, src0_ptr, 
+00043370: 7372 6331 5f70 7472 293b 0a23 656e 6469  src1_ptr);.#endi
+00043380: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
+00043390: 2020 2f2f 207d 0a20 2020 2020 2020 2020    // }.         
+000433a0: 2020 202f 2f20 7d0a 2020 2020 2020 2020     // }.        
+000433b0: 7d0a 2020 2020 7d20 656c 7365 207b 0a20  }.    } else {. 
+000433c0: 2020 2020 2020 202f 2f20 7372 6331 2069         // src1 i
+000433d0: 7320 6e6f 7420 636f 6e74 6967 756f 7573  s not contiguous
+000433e0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+000433f0: 7436 345f 7420 6972 203d 2069 7468 3b20  t64_t ir = ith; 
+00043400: 6972 203c 206e 723b 2069 7220 2b3d 206e  ir < nr; ir += n
+00043410: 7468 2920 7b0a 2020 2020 2020 2020 2020  th) {.          
+00043420: 2020 2f2f 2073 7263 3020 616e 6420 6473    // src0 and ds
+00043430: 7420 6172 6520 7361 6d65 2073 6861 7065  t are same shape
+00043440: 203d 3e20 7361 6d65 2069 6e64 6963 6573   => same indices
+00043450: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+00043460: 7372 6331 2069 7320 6272 6f61 6463 6173  src1 is broadcas
+00043470: 7461 626c 6520 6163 726f 7373 2073 7263  table across src
+00043480: 3020 616e 6420 6473 7420 696e 2069 312c  0 and dst in i1,
+00043490: 2069 322c 2069 330a 2020 2020 2020 2020   i2, i3.        
+000434a0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+000434b0: 7420 6930 3320 3d20 6972 2f28 6e65 3032  t i03 = ir/(ne02
+000434c0: 2a6e 6530 3129 3b0a 2020 2020 2020 2020  *ne01);.        
+000434d0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+000434e0: 7420 6930 3220 3d20 2869 7220 2d20 6930  t i02 = (ir - i0
+000434f0: 332a 6e65 3032 2a6e 6530 3129 2f6e 6530  3*ne02*ne01)/ne0
+00043500: 313b 0a20 2020 2020 2020 2020 2020 2063  1;.            c
+00043510: 6f6e 7374 2069 6e74 3634 5f74 2069 3031  onst int64_t i01
+00043520: 203d 2028 6972 202d 2069 3033 2a6e 6530   = (ir - i03*ne0
+00043530: 322a 6e65 3031 202d 2069 3032 2a6e 6530  2*ne01 - i02*ne0
+00043540: 3129 3b0a 0a20 2020 2020 2020 2020 2020  1);..           
+00043550: 2063 6f6e 7374 2069 6e74 3634 5f74 2069   const int64_t i
+00043560: 3133 203d 2069 3033 2025 206e 6531 333b  13 = i03 % ne13;
+00043570: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00043580: 7374 2069 6e74 3634 5f74 2069 3132 203d  st int64_t i12 =
+00043590: 2069 3032 2025 206e 6531 323b 0a20 2020   i02 % ne12;.   
+000435a0: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+000435b0: 6e74 3634 5f74 2069 3131 203d 2069 3031  nt64_t i11 = i01
+000435c0: 2025 206e 6531 313b 0a0a 2020 2020 2020   % ne11;..      
+000435d0: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
+000435e0: 745f 7074 7220 203d 2028 666c 6f61 7420  t_ptr  = (float 
+000435f0: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
+00043600: 2d3e 6461 7461 2020 2b20 6930 332a 6e62  ->data  + i03*nb
+00043610: 3320 202b 2069 3032 2a6e 6232 2020 2b20  3  + i02*nb2  + 
+00043620: 6930 312a 6e62 3120 293b 0a20 2020 2020  i01*nb1 );.     
+00043630: 2020 2020 2020 2066 6c6f 6174 202a 2073         float * s
+00043640: 7263 305f 7074 7220 3d20 2866 6c6f 6174  rc0_ptr = (float
+00043650: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
+00043660: 6330 2d3e 6461 7461 202b 2069 3033 2a6e  c0->data + i03*n
+00043670: 6230 3320 2b20 6930 322a 6e62 3032 202b  b03 + i02*nb02 +
+00043680: 2069 3031 2a6e 6230 3129 3b0a 0a20 2020   i01*nb01);..   
+00043690: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+000436a0: 7436 345f 7420 6930 203d 2030 3b20 6930  t64_t i0 = 0; i0
+000436b0: 203c 206e 6530 303b 2069 302b 2b29 207b   < ne00; i0++) {
+000436c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000436d0: 2066 6c6f 6174 202a 2073 7263 315f 7074   float * src1_pt
+000436e0: 7220 3d20 2866 6c6f 6174 202a 2920 2828  r = (float *) ((
+000436f0: 6368 6172 202a 2920 7372 6331 2d3e 6461  char *) src1->da
+00043700: 7461 202b 2069 3133 2a6e 6231 3320 2b20  ta + i13*nb13 + 
+00043710: 6931 322a 6e62 3132 202b 2069 3131 2a6e  i12*nb12 + i11*n
+00043720: 6231 3120 2b20 6930 2a6e 6231 3029 3b0a  b11 + i0*nb10);.
+00043730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043740: 2064 7374 5f70 7472 5b69 305d 203d 2073   dst_ptr[i0] = s
+00043750: 7263 305f 7074 725b 6930 5d20 2a20 282a  rc0_ptr[i0] * (*
+00043760: 7372 6331 5f70 7472 293b 0a20 2020 2020  src1_ptr);.     
+00043770: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00043780: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
+00043790: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+000437a0: 7075 7465 5f66 6f72 7761 7264 5f6d 756c  pute_forward_mul
+000437b0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+000437c0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+000437d0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+000437e0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+000437f0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00043800: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00043810: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00043820: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00043830: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
+00043840: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00043850: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+00043860: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+00043870: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+00043880: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+00043890: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000438a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000438b0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000438c0: 6172 645f 6d75 6c5f 6633 3228 7061 7261  ard_mul_f32(para
+000438d0: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+000438e0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+000438f0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00043900: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00043910: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00043920: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00043930: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00043940: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00043950: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+00043960: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00043970: 6172 645f 6469 760a 0a73 7461 7469 6320  ard_div..static 
+00043980: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+00043990: 655f 666f 7277 6172 645f 6469 765f 6633  e_forward_div_f3
+000439a0: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
+000439b0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+000439c0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+000439d0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+000439e0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000439f0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00043a00: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00043a10: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00043a20: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
+00043a30: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00043a40: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+00043a50: 6173 7365 7274 2870 6172 616d 732d 3e69  assert(params->i
+00043a60: 7468 203d 3d20 3029 3b0a 2020 2020 6173  th == 0);.    as
+00043a70: 7365 7274 2867 676d 6c5f 6172 655f 7361  sert(ggml_are_sa
+00043a80: 6d65 5f73 6861 7065 2873 7263 302c 2073  me_shape(src0, s
+00043a90: 7263 3129 2026 2620 6767 6d6c 5f61 7265  rc1) && ggml_are
+00043aa0: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
+00043ab0: 2c20 6473 7429 293b 0a0a 2020 2020 6966  , dst));..    if
+00043ac0: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00043ad0: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00043ae0: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+00043af0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00043b00: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00043b10: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00043b20: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00043b30: 7220 203d 2067 676d 6c5f 6e72 6f77 7328  r  = ggml_nrows(
+00043b40: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
+00043b50: 2069 6e74 3634 5f74 206e 6530 203d 2073   int64_t ne0 = s
+00043b60: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
+00043b70: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00043b80: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
+00043b90: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00043ba0: 5f74 206e 6532 203d 2073 7263 302d 3e6e  _t ne2 = src0->n
+00043bb0: 655b 325d 3b0a 0a20 2020 2063 6f6e 7374  e[2];..    const
+00043bc0: 2073 697a 655f 7420 6e62 3030 203d 2073   size_t nb00 = s
+00043bd0: 7263 302d 3e6e 625b 305d 3b0a 2020 2020  rc0->nb[0];.    
+00043be0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+00043bf0: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
+00043c00: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00043c10: 7420 6e62 3032 203d 2073 7263 302d 3e6e  t nb02 = src0->n
+00043c20: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+00043c30: 7369 7a65 5f74 206e 6230 3320 3d20 7372  size_t nb03 = sr
+00043c40: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
+00043c50: 636f 6e73 7420 7369 7a65 5f74 206e 6231  const size_t nb1
+00043c60: 3020 3d20 7372 6331 2d3e 6e62 5b30 5d3b  0 = src1->nb[0];
+00043c70: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00043c80: 7420 6e62 3131 203d 2073 7263 312d 3e6e  t nb11 = src1->n
+00043c90: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+00043ca0: 7369 7a65 5f74 206e 6231 3220 3d20 7372  size_t nb12 = sr
+00043cb0: 6331 2d3e 6e62 5b32 5d3b 0a20 2020 2063  c1->nb[2];.    c
+00043cc0: 6f6e 7374 2073 697a 655f 7420 6e62 3133  onst size_t nb13
+00043cd0: 203d 2073 7263 312d 3e6e 625b 335d 3b0a   = src1->nb[3];.
+00043ce0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00043cf0: 7420 6e62 3020 3d20 6473 742d 3e6e 625b  t nb0 = dst->nb[
+00043d00: 305d 3b0a 2020 2020 636f 6e73 7420 7369  0];.    const si
+00043d10: 7a65 5f74 206e 6231 203d 2064 7374 2d3e  ze_t nb1 = dst->
+00043d20: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
+00043d30: 2073 697a 655f 7420 6e62 3220 3d20 6473   size_t nb2 = ds
+00043d40: 742d 3e6e 625b 325d 3b0a 2020 2020 636f  t->nb[2];.    co
+00043d50: 6e73 7420 7369 7a65 5f74 206e 6233 203d  nst size_t nb3 =
+00043d60: 2064 7374 2d3e 6e62 5b33 5d3b 0a0a 2020   dst->nb[3];..  
+00043d70: 2020 4747 4d4c 5f41 5353 4552 5428 206e    GGML_ASSERT( n
+00043d80: 6230 203d 3d20 7369 7a65 6f66 2866 6c6f  b0 == sizeof(flo
+00043d90: 6174 2929 3b0a 2020 2020 4747 4d4c 5f41  at));.    GGML_A
+00043da0: 5353 4552 5428 6e62 3030 203d 3d20 7369  SSERT(nb00 == si
+00043db0: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
+00043dc0: 2020 2069 6620 286e 6231 3020 3d3d 2073     if (nb10 == s
+00043dd0: 697a 656f 6628 666c 6f61 7429 2920 7b0a  izeof(float)) {.
+00043de0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00043df0: 2069 7220 3d20 303b 2069 7220 3c20 6e72   ir = 0; ir < nr
+00043e00: 3b20 2b2b 6972 2920 7b0a 2020 2020 2020  ; ++ir) {.      
+00043e10: 2020 2020 2020 2f2f 2073 7263 302c 2073        // src0, s
+00043e20: 7263 3120 616e 6420 6473 7420 6172 6520  rc1 and dst are 
+00043e30: 7361 6d65 2073 6861 7065 203d 3e20 7361  same shape => sa
+00043e40: 6d65 2069 6e64 6963 6573 0a20 2020 2020  me indices.     
+00043e50: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00043e60: 2069 3320 3d20 6972 2f28 6e65 322a 6e65   i3 = ir/(ne2*ne
+00043e70: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
+00043e80: 636f 6e73 7420 696e 7420 6932 203d 2028  const int i2 = (
+00043e90: 6972 202d 2069 332a 6e65 322a 6e65 3129  ir - i3*ne2*ne1)
+00043ea0: 2f6e 6531 3b0a 2020 2020 2020 2020 2020  /ne1;.          
+00043eb0: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
+00043ec0: 2028 6972 202d 2069 332a 6e65 322a 6e65   (ir - i3*ne2*ne
+00043ed0: 3120 2d20 6932 2a6e 6531 293b 0a0a 0a23  1 - i2*ne1);...#
+00043ee0: 6966 6465 6620 4747 4d4c 5f55 5345 5f41  ifdef GGML_USE_A
+00043ef0: 4343 454c 4552 4154 450a 2020 2020 2020  CCELERATE.      
+00043f00: 2020 2020 2020 7644 5350 5f76 6469 7628        vDSP_vdiv(
+00043f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043f20: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00043f30: 2863 6861 7220 2a29 2073 7263 312d 3e64  (char *) src1->d
+00043f40: 6174 6120 2b20 6933 2a6e 6231 3320 2b20  ata + i3*nb13 + 
+00043f50: 6932 2a6e 6231 3220 2b20 6931 2a6e 6231  i2*nb12 + i1*nb1
+00043f60: 3129 2c20 312c 0a20 2020 2020 2020 2020  1), 1,.         
+00043f70: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00043f80: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+00043f90: 7263 302d 3e64 6174 6120 2b20 6933 2a6e  rc0->data + i3*n
+00043fa0: 6230 3320 2b20 6932 2a6e 6230 3220 2b20  b03 + i2*nb02 + 
+00043fb0: 6931 2a6e 6230 3129 2c20 312c 0a20 2020  i1*nb01), 1,.   
+00043fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043fd0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+00043fe0: 7220 2a29 2064 7374 2d3e 6461 7461 2020  r *) dst->data  
+00043ff0: 2b20 6933 2a6e 6233 2020 2b20 6932 2a6e  + i3*nb3  + i2*n
+00044000: 6232 2020 2b20 6931 2a6e 6231 2029 2c20  b2  + i1*nb1 ), 
+00044010: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+00044020: 2020 2020 2020 206e 6530 293b 0a23 656c         ne0);.#el
+00044030: 7365 0a20 2020 2020 2020 2020 2020 2067  se.            g
+00044040: 676d 6c5f 7665 635f 6469 765f 6633 3228  gml_vec_div_f32(
+00044050: 6e65 302c 0a20 2020 2020 2020 2020 2020  ne0,.           
+00044060: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+00044070: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
+00044080: 2d3e 6461 7461 2020 2b20 6933 2a6e 6233  ->data  + i3*nb3
+00044090: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
+000440a0: 2a6e 6231 2029 2c0a 2020 2020 2020 2020  *nb1 ),.        
+000440b0: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+000440c0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+000440d0: 7372 6330 2d3e 6461 7461 202b 2069 332a  src0->data + i3*
+000440e0: 6e62 3033 202b 2069 322a 6e62 3032 202b  nb03 + i2*nb02 +
+000440f0: 2069 312a 6e62 3031 292c 0a20 2020 2020   i1*nb01),.     
+00044100: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00044110: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+00044120: 2a29 2073 7263 312d 3e64 6174 6120 2b20  *) src1->data + 
+00044130: 6933 2a6e 6231 3320 2b20 6932 2a6e 6231  i3*nb13 + i2*nb1
+00044140: 3220 2b20 6931 2a6e 6231 3129 293b 0a23  2 + i1*nb11));.#
+00044150: 656e 6469 660a 2020 2020 2020 2020 2020  endif.          
+00044160: 2020 2020 2020 2f2f 207d 0a20 2020 2020        // }.     
+00044170: 2020 2020 2020 202f 2f20 7d0a 2020 2020         // }.    
+00044180: 2020 2020 7d0a 2020 2020 7d20 656c 7365      }.    } else
+00044190: 207b 0a20 2020 2020 2020 202f 2f20 7372   {.        // sr
+000441a0: 6331 2069 7320 6e6f 7420 636f 6e74 6967  c1 is not contig
+000441b0: 756f 7573 0a20 2020 2020 2020 2066 6f72  uous.        for
+000441c0: 2028 696e 7420 6972 203d 2030 3b20 6972   (int ir = 0; ir
+000441d0: 203c 206e 723b 202b 2b69 7229 207b 0a20   < nr; ++ir) {. 
+000441e0: 2020 2020 2020 2020 2020 202f 2f20 7372             // sr
+000441f0: 6330 2c20 7372 6331 2061 6e64 2064 7374  c0, src1 and dst
+00044200: 2061 7265 2073 616d 6520 7368 6170 6520   are same shape 
+00044210: 3d3e 2073 616d 6520 696e 6469 6365 730a  => same indices.
+00044220: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00044230: 7420 696e 7420 6933 203d 2069 722f 286e  t int i3 = ir/(n
+00044240: 6532 2a6e 6531 293b 0a20 2020 2020 2020  e2*ne1);.       
+00044250: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+00044260: 3220 3d20 2869 7220 2d20 6933 2a6e 6532  2 = (ir - i3*ne2
+00044270: 2a6e 6531 292f 6e65 313b 0a20 2020 2020  *ne1)/ne1;.     
+00044280: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00044290: 2069 3120 3d20 2869 7220 2d20 6933 2a6e   i1 = (ir - i3*n
+000442a0: 6532 2a6e 6531 202d 2069 322a 6e65 3129  e2*ne1 - i2*ne1)
+000442b0: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
+000442c0: 6c6f 6174 202a 2064 7374 5f70 7472 2020  loat * dst_ptr  
+000442d0: 3d20 2866 6c6f 6174 202a 2920 2828 6368  = (float *) ((ch
+000442e0: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+000442f0: 202b 2069 332a 6e62 3320 202b 2069 322a   + i3*nb3  + i2*
+00044300: 6e62 3220 202b 2069 312a 6e62 3120 293b  nb2  + i1*nb1 );
+00044310: 0a20 2020 2020 2020 2020 2020 2066 6c6f  .            flo
+00044320: 6174 202a 2073 7263 305f 7074 7220 3d20  at * src0_ptr = 
+00044330: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+00044340: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00044350: 2069 332a 6e62 3033 202b 2069 322a 6e62   i3*nb03 + i2*nb
+00044360: 3032 202b 2069 312a 6e62 3031 293b 0a20  02 + i1*nb01);. 
+00044370: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00044380: 696e 7420 6930 203d 2030 3b20 6930 203c  int i0 = 0; i0 <
+00044390: 206e 6530 3b20 6930 2b2b 2920 7b0a 2020   ne0; i0++) {.  
+000443a0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+000443b0: 6f61 7420 2a20 7372 6331 5f70 7472 203d  oat * src1_ptr =
+000443c0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+000443d0: 7220 2a29 2073 7263 312d 3e64 6174 6120  r *) src1->data 
+000443e0: 2b20 6933 2a6e 6231 3320 2b20 6932 2a6e  + i3*nb13 + i2*n
+000443f0: 6231 3220 2b20 6931 2a6e 6231 3120 2b20  b12 + i1*nb11 + 
+00044400: 6930 2a6e 6231 3029 3b0a 0a20 2020 2020  i0*nb10);..     
+00044410: 2020 2020 2020 2020 2020 2064 7374 5f70             dst_p
+00044420: 7472 5b69 305d 203d 2073 7263 305f 7074  tr[i0] = src0_pt
+00044430: 725b 6930 5d20 2f20 282a 7372 6331 5f70  r[i0] / (*src1_p
+00044440: 7472 293b 0a20 2020 2020 2020 2020 2020  tr);.           
+00044450: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
+00044460: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
+00044470: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00044480: 6f72 7761 7264 5f64 6976 280a 2020 2020  orward_div(.    
+00044490: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000444a0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+000444b0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+000444c0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000444d0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000444e0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+000444f0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00044500: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+00044510: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00044520: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00044530: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+00044540: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+00044550: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00044560: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
+00044570: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00044580: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00044590: 6d70 7574 655f 666f 7277 6172 645f 6469  mpute_forward_di
+000445a0: 765f 6633 3228 7061 7261 6d73 2c20 7372  v_f32(params, sr
+000445b0: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
+000445c0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000445d0: 6561 6b3b 0a20 2020 2020 2020 2064 6566  eak;.        def
+000445e0: 6175 6c74 3a0a 2020 2020 2020 2020 2020  ault:.          
+000445f0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00044600: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00044610: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00044620: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00044630: 207d 0a7d 0a0a 2f2f 2067 676d 6c5f 636f   }.}..// ggml_co
+00044640: 6d70 7574 655f 666f 7277 6172 645f 7371  mpute_forward_sq
+00044650: 720a 0a73 7461 7469 6320 766f 6964 2067  r..static void g
+00044660: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00044670: 6172 645f 7371 725f 6633 3228 0a20 2020  ard_sqr_f32(.   
+00044680: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00044690: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+000446a0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+000446b0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+000446c0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000446d0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+000446e0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000446f0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+00044700: 2061 7373 6572 7428 7061 7261 6d73 2d3e   assert(params->
+00044710: 6974 6820 3d3d 2030 293b 0a20 2020 2061  ith == 0);.    a
+00044720: 7373 6572 7428 6767 6d6c 5f61 7265 5f73  ssert(ggml_are_s
+00044730: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
+00044740: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
+00044750: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00044760: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
+00044770: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
+00044780: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+00044790: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+000447a0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+000447b0: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
+000447c0: 2020 203d 2067 676d 6c5f 6e72 6f77 7328     = ggml_nrows(
+000447d0: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
+000447e0: 2069 6e74 206e 6320 2020 203d 2073 7263   int nc    = src
+000447f0: 302d 3e6e 655b 305d 3b0a 0a20 2020 2061  0->ne[0];..    a
+00044800: 7373 6572 7428 2064 7374 2d3e 6e62 5b30  ssert( dst->nb[0
+00044810: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+00044820: 7429 293b 0a20 2020 2061 7373 6572 7428  t));.    assert(
+00044830: 7372 6330 2d3e 6e62 5b30 5d20 3d3d 2073  src0->nb[0] == s
+00044840: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
+00044850: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00044860: 2030 3b20 6920 3c20 6e3b 2069 2b2b 2920   0; i < n; i++) 
+00044870: 7b0a 2020 2020 2020 2020 6767 6d6c 5f76  {.        ggml_v
+00044880: 6563 5f73 7172 5f66 3332 286e 632c 0a20  ec_sqr_f32(nc,. 
+00044890: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+000448a0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+000448b0: 2a29 2064 7374 2d3e 6461 7461 2020 2b20  *) dst->data  + 
+000448c0: 692a 2820 6473 742d 3e6e 625b 315d 2929  i*( dst->nb[1]))
+000448d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000448e0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+000448f0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+00044900: 202b 2069 2a28 7372 6330 2d3e 6e62 5b31   + i*(src0->nb[1
+00044910: 5d29 2929 3b0a 2020 2020 7d0a 7d0a 0a73  ])));.    }.}..s
+00044920: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00044930: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00044940: 7371 7228 0a20 2020 2020 2020 2063 6f6e  sqr(.        con
+00044950: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00044960: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00044970: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00044980: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00044990: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+000449a0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000449b0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+000449c0: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+000449d0: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+000449e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000449f0: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
+00044a00: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00044a10: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00044a20: 6d70 7574 655f 666f 7277 6172 645f 7371  mpute_forward_sq
+00044a30: 725f 6633 3228 7061 7261 6d73 2c20 7372  r_f32(params, sr
+00044a40: 6330 2c20 6473 7429 3b0a 2020 2020 2020  c0, dst);.      
+00044a50: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00044a60: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
+00044a70: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00044a80: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00044a90: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+00044aa0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00044ab0: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
+00044ac0: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
+00044ad0: 666f 7277 6172 645f 7371 7274 0a0a 7374  forward_sqrt..st
+00044ae0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00044af0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00044b00: 7172 745f 6633 3228 0a20 2020 2020 2020  qrt_f32(.       
+00044b10: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00044b20: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00044b30: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00044b40: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00044b50: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00044b60: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
+00044b70: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00044b80: 2a20 6473 7429 207b 0a20 2020 2061 7373  * dst) {.    ass
+00044b90: 6572 7428 7061 7261 6d73 2d3e 6974 6820  ert(params->ith 
+00044ba0: 3d3d 2030 293b 0a20 2020 2061 7373 6572  == 0);.    asser
+00044bb0: 7428 6767 6d6c 5f61 7265 5f73 616d 655f  t(ggml_are_same_
+00044bc0: 7368 6170 6528 7372 6330 2c20 6473 7429  shape(src0, dst)
+00044bd0: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
+00044be0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+00044bf0: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
+00044c00: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00044c10: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
+00044c20: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+00044c30: 726e 3b0a 2020 2020 7d0a 0a20 2020 2063  rn;.    }..    c
+00044c40: 6f6e 7374 2069 6e74 206e 2020 3d20 6767  onst int n  = gg
+00044c50: 6d6c 5f6e 726f 7773 2873 7263 3029 3b0a  ml_nrows(src0);.
+00044c60: 2020 2020 636f 6e73 7420 696e 7420 6e63      const int nc
+00044c70: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
+00044c80: 0a20 2020 2061 7373 6572 7428 2064 7374  .    assert( dst
+00044c90: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+00044ca0: 6628 666c 6f61 7429 293b 0a20 2020 2061  f(float));.    a
+00044cb0: 7373 6572 7428 7372 6330 2d3e 6e62 5b30  ssert(src0->nb[0
+00044cc0: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+00044cd0: 7429 293b 0a0a 2020 2020 666f 7220 2869  t));..    for (i
+00044ce0: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
+00044cf0: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+00044d00: 6767 6d6c 5f76 6563 5f73 7172 745f 6633  ggml_vec_sqrt_f3
+00044d10: 3228 6e63 2c0a 2020 2020 2020 2020 2020  2(nc,.          
+00044d20: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+00044d30: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
+00044d40: 6174 6120 202b 2069 2a28 2064 7374 2d3e  ata  + i*( dst->
+00044d50: 6e62 5b31 5d29 292c 0a20 2020 2020 2020  nb[1])),.       
+00044d60: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+00044d70: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+00044d80: 302d 3e64 6174 6120 2b20 692a 2873 7263  0->data + i*(src
+00044d90: 302d 3e6e 625b 315d 2929 293b 0a20 2020  0->nb[1])));.   
+00044da0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
+00044db0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00044dc0: 6f72 7761 7264 5f73 7172 7428 0a20 2020  orward_sqrt(.   
+00044dd0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00044de0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00044df0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00044e00: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00044e10: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00044e20: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00044e30: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00044e40: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+00044e50: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
+00044e60: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
+00044e70: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
+00044e80: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
+00044e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044ea0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00044eb0: 7277 6172 645f 7371 7274 5f66 3332 2870  rward_sqrt_f32(p
+00044ec0: 6172 616d 732c 2073 7263 302c 2064 7374  arams, src0, dst
+00044ed0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00044ee0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00044ef0: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+00044f00: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00044f10: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00044f20: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+00044f30: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00044f40: 2020 2020 7d0a 7d0a 0a0a 2f2f 2067 676d      }.}...// ggm
+00044f50: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00044f60: 645f 6c6f 670a 0a73 7461 7469 6320 766f  d_log..static vo
+00044f70: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+00044f80: 666f 7277 6172 645f 6c6f 675f 6633 3228  forward_log_f32(
+00044f90: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00044fa0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00044fb0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00044fc0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00044fd0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00044fe0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00044ff0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00045000: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+00045010: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00045020: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
+00045030: 3029 3b0a 2020 2020 4747 4d4c 5f41 5353  0);.    GGML_ASS
+00045040: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
+00045050: 655f 7368 6170 6528 7372 6330 2c20 6473  e_shape(src0, ds
+00045060: 7429 293b 0a0a 2020 2020 6966 2028 7061  t));..    if (pa
+00045070: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00045080: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
+00045090: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+000450a0: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
+000450b0: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
+000450c0: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+000450d0: 2063 6f6e 7374 2069 6e74 206e 2020 3d20   const int n  = 
+000450e0: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
+000450f0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00045100: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
+00045110: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00045120: 5254 2820 6473 742d 3e6e 625b 305d 203d  RT( dst->nb[0] =
+00045130: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
+00045140: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00045150: 5428 7372 6330 2d3e 6e62 5b30 5d20 3d3d  T(src0->nb[0] ==
+00045160: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00045170: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00045180: 203d 2030 3b20 6920 3c20 6e3b 2069 2b2b   = 0; i < n; i++
+00045190: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
+000451a0: 5f76 6563 5f6c 6f67 5f66 3332 286e 632c  _vec_log_f32(nc,
+000451b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000451c0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+000451d0: 7220 2a29 2064 7374 2d3e 6461 7461 2020  r *) dst->data  
+000451e0: 2b20 692a 2820 6473 742d 3e6e 625b 315d  + i*( dst->nb[1]
+000451f0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00045200: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+00045210: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
+00045220: 7461 202b 2069 2a28 7372 6330 2d3e 6e62  ta + i*(src0->nb
+00045230: 5b31 5d29 2929 3b0a 2020 2020 7d0a 7d0a  [1])));.    }.}.
+00045240: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00045250: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00045260: 645f 6c6f 6728 0a20 2020 2020 2020 2063  d_log(.        c
+00045270: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00045280: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+00045290: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+000452a0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000452b0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+000452c0: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
+000452d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000452e0: 6473 7429 207b 0a20 2020 2073 7769 7463  dst) {.    switc
+000452f0: 6820 2873 7263 302d 3e74 7970 6529 207b  h (src0->type) {
+00045300: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00045310: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
+00045320: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00045330: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00045340: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00045350: 6c6f 675f 6633 3228 7061 7261 6d73 2c20  log_f32(params, 
+00045360: 7372 6330 2c20 6473 7429 3b0a 2020 2020  src0, dst);.    
+00045370: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00045380: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+00045390: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000453a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000453b0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+000453c0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+000453d0: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+000453e0: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
+000453f0: 655f 666f 7277 6172 645f 7375 6d0a 0a73  e_forward_sum..s
+00045400: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00045410: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00045420: 7375 6d5f 6633 3228 0a20 2020 2020 2020  sum_f32(.       
+00045430: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00045440: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00045450: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00045460: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00045470: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00045480: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
+00045490: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000454a0: 2a20 6473 7429 207b 0a20 2020 2061 7373  * dst) {.    ass
+000454b0: 6572 7428 7061 7261 6d73 2d3e 6974 6820  ert(params->ith 
+000454c0: 3d3d 2030 293b 0a20 2020 2061 7373 6572  == 0);.    asser
+000454d0: 7428 6767 6d6c 5f69 735f 7363 616c 6172  t(ggml_is_scalar
+000454e0: 2864 7374 2929 3b0a 0a20 2020 2069 6620  (dst));..    if 
+000454f0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00045500: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
+00045510: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
+00045520: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00045530: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+00045540: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00045550: 2020 2020 6173 7365 7274 2867 676d 6c5f      assert(ggml_
+00045560: 6973 5f73 6361 6c61 7228 6473 7429 293b  is_scalar(dst));
+00045570: 0a20 2020 2061 7373 6572 7428 7372 6330  .    assert(src0
+00045580: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+00045590: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+000455a0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+000455b0: 3030 203d 2073 7263 302d 3e6e 655b 305d  00 = src0->ne[0]
+000455c0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+000455d0: 345f 7420 6e65 3031 203d 2073 7263 302d  4_t ne01 = src0-
+000455e0: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
+000455f0: 7420 696e 7436 345f 7420 6e65 3032 203d  t int64_t ne02 =
+00045600: 2073 7263 302d 3e6e 655b 325d 3b0a 2020   src0->ne[2];.  
+00045610: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00045620: 6e65 3033 203d 2073 7263 302d 3e6e 655b  ne03 = src0->ne[
+00045630: 335d 3b0a 0a20 2020 2063 6f6e 7374 2073  3];..    const s
+00045640: 697a 655f 7420 6e62 3031 203d 2073 7263  ize_t nb01 = src
+00045650: 302d 3e6e 625b 315d 3b0a 2020 2020 636f  0->nb[1];.    co
+00045660: 6e73 7420 7369 7a65 5f74 206e 6230 3220  nst size_t nb02 
+00045670: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
+00045680: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+00045690: 6e62 3033 203d 2073 7263 302d 3e6e 625b  nb03 = src0->nb[
+000456a0: 335d 3b0a 0a20 2020 2067 676d 6c5f 666c  3];..    ggml_fl
+000456b0: 6f61 7420 7375 6d20 2020 2020 3d20 303b  oat sum     = 0;
+000456c0: 0a20 2020 2067 676d 6c5f 666c 6f61 7420  .    ggml_float 
+000456d0: 726f 775f 7375 6d20 3d20 303b 0a0a 2020  row_sum = 0;..  
+000456e0: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+000456f0: 3033 203d 2030 3b20 6930 3320 3c20 6e65  03 = 0; i03 < ne
+00045700: 3033 3b20 6930 332b 2b29 207b 0a20 2020  03; i03++) {.   
+00045710: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+00045720: 7420 6930 3220 3d20 303b 2069 3032 203c  t i02 = 0; i02 <
+00045730: 206e 6530 323b 2069 3032 2b2b 2920 7b0a   ne02; i02++) {.
+00045740: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00045750: 2869 6e74 3634 5f74 2069 3031 203d 2030  (int64_t i01 = 0
+00045760: 3b20 6930 3120 3c20 6e65 3031 3b20 6930  ; i01 < ne01; i0
+00045770: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
+00045780: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00045790: 7375 6d5f 6767 6628 6e65 3030 2c0a 2020  sum_ggf(ne00,.  
+000457a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000457b0: 2020 2020 2020 2672 6f77 5f73 756d 2c0a        &row_sum,.
+000457c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000457d0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+000457e0: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+000457f0: 2d3e 6461 7461 202b 2069 3031 2a6e 6230  ->data + i01*nb0
+00045800: 3120 2b20 6930 322a 6e62 3032 202b 2069  1 + i02*nb02 + i
+00045810: 3033 2a6e 6230 3329 293b 0a20 2020 2020  03*nb03));.     
+00045820: 2020 2020 2020 2020 2020 2073 756d 202b             sum +
+00045830: 3d20 726f 775f 7375 6d3b 0a20 2020 2020  = row_sum;.     
+00045840: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00045850: 207d 0a20 2020 207d 0a20 2020 2028 2866   }.    }.    ((f
+00045860: 6c6f 6174 202a 2920 6473 742d 3e64 6174  loat *) dst->dat
+00045870: 6129 5b30 5d20 3d20 7375 6d3b 0a7d 0a0a  a)[0] = sum;.}..
+00045880: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00045890: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+000458a0: 5f73 756d 280a 2020 2020 2020 2020 636f  _sum(.        co
+000458b0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000458c0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+000458d0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+000458e0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+000458f0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00045900: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00045910: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00045920: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
+00045930: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
+00045940: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00045950: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+00045960: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00045970: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00045980: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00045990: 756d 5f66 3332 2870 6172 616d 732c 2073  um_f32(params, s
+000459a0: 7263 302c 2064 7374 293b 0a20 2020 2020  rc0, dst);.     
+000459b0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000459c0: 2020 2020 2020 2020 6465 6661 756c 743a          default:
+000459d0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000459e0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+000459f0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00045a00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00045a10: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+00045a20: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+00045a30: 5f66 6f72 7761 7264 5f73 756d 5f72 6f77  _forward_sum_row
+00045a40: 730a 0a73 7461 7469 6320 766f 6964 2067  s..static void g
+00045a50: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00045a60: 6172 645f 7375 6d5f 726f 7773 5f66 3332  ard_sum_rows_f32
+00045a70: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00045a80: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00045a90: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00045aa0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00045ab0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00045ac0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00045ad0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00045ae0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00045af0: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
+00045b00: 5428 7061 7261 6d73 2d3e 6974 6820 3d3d  T(params->ith ==
+00045b10: 2030 293b 0a0a 2020 2020 6966 2028 7061   0);..    if (pa
+00045b20: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00045b30: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
+00045b40: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00045b50: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
+00045b60: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
+00045b70: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+00045b80: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
+00045b90: 302d 3e6e 625b 305d 203d 3d20 7369 7a65  0->nb[0] == size
+00045ba0: 6f66 2866 6c6f 6174 2929 3b0a 2020 2020  of(float));.    
+00045bb0: 4747 4d4c 5f41 5353 4552 5428 6473 742d  GGML_ASSERT(dst-
+00045bc0: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
+00045bd0: 2866 6c6f 6174 2929 3b0a 0a20 2020 2063  (float));..    c
+00045be0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+00045bf0: 3020 3d20 7372 6330 2d3e 6e65 5b30 5d3b  0 = src0->ne[0];
+00045c00: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00045c10: 5f74 206e 6530 3120 3d20 7372 6330 2d3e  _t ne01 = src0->
+00045c20: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
+00045c30: 2069 6e74 3634 5f74 206e 6530 3220 3d20   int64_t ne02 = 
+00045c40: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
+00045c50: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00045c60: 6530 3320 3d20 7372 6330 2d3e 6e65 5b33  e03 = src0->ne[3
+00045c70: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00045c80: 7436 345f 7420 6e65 3020 3d20 6473 742d  t64_t ne0 = dst-
+00045c90: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+00045ca0: 7420 696e 7436 345f 7420 6e65 3120 3d20  t int64_t ne1 = 
+00045cb0: 6473 742d 3e6e 655b 315d 3b0a 2020 2020  dst->ne[1];.    
+00045cc0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00045cd0: 3220 3d20 6473 742d 3e6e 655b 325d 3b0a  2 = dst->ne[2];.
+00045ce0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00045cf0: 7420 6e65 3320 3d20 6473 742d 3e6e 655b  t ne3 = dst->ne[
+00045d00: 335d 3b0a 0a20 2020 2047 474d 4c5f 4153  3];..    GGML_AS
+00045d10: 5345 5254 286e 6530 203d 3d20 3129 3b0a  SERT(ne0 == 1);.
+00045d20: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00045d30: 6e65 3120 3d3d 206e 6530 3129 3b0a 2020  ne1 == ne01);.  
+00045d40: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+00045d50: 3220 3d3d 206e 6530 3229 3b0a 2020 2020  2 == ne02);.    
+00045d60: 4747 4d4c 5f41 5353 4552 5428 6e65 3320  GGML_ASSERT(ne3 
+00045d70: 3d3d 206e 6530 3329 3b0a 0a20 2020 2063  == ne03);..    c
+00045d80: 6f6e 7374 2073 697a 655f 7420 6e62 3031  onst size_t nb01
+00045d90: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
+00045da0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00045db0: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
+00045dc0: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
+00045dd0: 697a 655f 7420 6e62 3033 203d 2073 7263  ize_t nb03 = src
+00045de0: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
+00045df0: 6f6e 7374 2073 697a 655f 7420 6e62 3120  onst size_t nb1 
+00045e00: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
+00045e10: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+00045e20: 6232 203d 2064 7374 2d3e 6e62 5b32 5d3b  b2 = dst->nb[2];
+00045e30: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00045e40: 7420 6e62 3320 3d20 6473 742d 3e6e 625b  t nb3 = dst->nb[
+00045e50: 335d 3b0a 0a20 2020 2066 6f72 2028 696e  3];..    for (in
+00045e60: 7436 345f 7420 6933 203d 2030 3b20 6933  t64_t i3 = 0; i3
+00045e70: 203c 206e 6530 333b 2069 332b 2b29 207b   < ne03; i3++) {
+00045e80: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00045e90: 7436 345f 7420 6932 203d 2030 3b20 6932  t64_t i2 = 0; i2
+00045ea0: 203c 206e 6530 323b 2069 322b 2b29 207b   < ne02; i2++) {
+00045eb0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00045ec0: 2028 696e 7436 345f 7420 6931 203d 2030   (int64_t i1 = 0
+00045ed0: 3b20 6931 203c 206e 6530 313b 2069 312b  ; i1 < ne01; i1+
+00045ee0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00045ef0: 2020 2020 2066 6c6f 6174 2a20 7372 635f       float* src_
+00045f00: 726f 7720 3d20 2866 6c6f 6174 202a 2920  row = (float *) 
+00045f10: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+00045f20: 6461 7461 202b 2069 312a 6e62 3031 202b  data + i1*nb01 +
+00045f30: 2069 322a 6e62 3032 202b 2069 332a 6e62   i2*nb02 + i3*nb
+00045f40: 3033 293b 0a20 2020 2020 2020 2020 2020  03);.           
+00045f50: 2020 2020 2066 6c6f 6174 2a20 6473 745f       float* dst_
+00045f60: 726f 7720 3d20 2866 6c6f 6174 202a 2920  row = (float *) 
+00045f70: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
+00045f80: 6174 6120 202b 2069 312a 6e62 3120 202b  ata  + i1*nb1  +
+00045f90: 2069 322a 6e62 3220 202b 2069 332a 6e62   i2*nb2  + i3*nb
+00045fa0: 3329 3b0a 2020 2020 2020 2020 2020 2020  3);.            
+00045fb0: 2020 2020 666c 6f61 7420 726f 775f 7375      float row_su
+00045fc0: 6d20 3d20 303b 0a20 2020 2020 2020 2020  m = 0;.         
+00045fd0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00045fe0: 7375 6d5f 6633 3228 6e65 3030 2c20 2672  sum_f32(ne00, &r
+00045ff0: 6f77 5f73 756d 2c20 7372 635f 726f 7729  ow_sum, src_row)
+00046000: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00046010: 2020 6473 745f 726f 775b 305d 203d 2072    dst_row[0] = r
+00046020: 6f77 5f73 756d 3b0a 2020 2020 2020 2020  ow_sum;.        
+00046030: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+00046040: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+00046050: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+00046060: 655f 666f 7277 6172 645f 7375 6d5f 726f  e_forward_sum_ro
+00046070: 7773 280a 2020 2020 2020 2020 636f 6e73  ws(.        cons
+00046080: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+00046090: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+000460a0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+000460b0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+000460c0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+000460d0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+000460e0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+000460f0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+00046100: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+00046110: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00046120: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00046130: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00046140: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00046150: 7075 7465 5f66 6f72 7761 7264 5f73 756d  pute_forward_sum
+00046160: 5f72 6f77 735f 6633 3228 7061 7261 6d73  _rows_f32(params
+00046170: 2c20 7372 6330 2c20 6473 7429 3b0a 2020  , src0, dst);.  
+00046180: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00046190: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
+000461a0: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+000461b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000461c0: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+000461d0: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+000461e0: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
+000461f0: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
+00046200: 7574 655f 666f 7277 6172 645f 6d65 616e  ute_forward_mean
+00046210: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00046220: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00046230: 7264 5f6d 6561 6e5f 6633 3228 0a20 2020  rd_mean_f32(.   
+00046240: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00046250: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00046260: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00046270: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00046280: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00046290: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+000462a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000462b0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+000462c0: 2061 7373 6572 7428 7061 7261 6d73 2d3e   assert(params->
+000462d0: 6974 6820 3d3d 2030 293b 0a0a 2020 2020  ith == 0);..    
+000462e0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+000462f0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+00046300: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
+00046310: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00046320: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+00046330: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+00046340: 7d0a 0a20 2020 2061 7373 6572 7428 7372  }..    assert(sr
+00046350: 6330 2d3e 6e62 5b30 5d20 3d3d 2073 697a  c0->nb[0] == siz
+00046360: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
+00046370: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00046380: 6e65 3030 203d 2073 7263 302d 3e6e 655b  ne00 = src0->ne[
+00046390: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+000463a0: 7436 345f 7420 6e65 3031 203d 2073 7263  t64_t ne01 = src
+000463b0: 302d 3e6e 655b 315d 3b0a 2020 2020 636f  0->ne[1];.    co
+000463c0: 6e73 7420 696e 7436 345f 7420 6e65 3032  nst int64_t ne02
+000463d0: 203d 2073 7263 302d 3e6e 655b 325d 3b0a   = src0->ne[2];.
+000463e0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+000463f0: 7420 6e65 3033 203d 2073 7263 302d 3e6e  t ne03 = src0->n
+00046400: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
+00046410: 2073 697a 655f 7420 6e62 3031 203d 2073   size_t nb01 = s
+00046420: 7263 302d 3e6e 625b 315d 3b0a 2020 2020  rc0->nb[1];.    
+00046430: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+00046440: 3220 3d20 7372 6330 2d3e 6e62 5b32 5d3b  2 = src0->nb[2];
+00046450: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00046460: 7420 6e62 3033 203d 2073 7263 302d 3e6e  t nb03 = src0->n
+00046470: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+00046480: 2069 6e74 3634 5f74 206e 6530 203d 2064   int64_t ne0 = d
+00046490: 7374 2d3e 6e65 5b30 5d3b 0a20 2020 2063  st->ne[0];.    c
+000464a0: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
+000464b0: 203d 2064 7374 2d3e 6e65 5b31 5d3b 0a20   = dst->ne[1];. 
+000464c0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+000464d0: 206e 6532 203d 2064 7374 2d3e 6e65 5b32   ne2 = dst->ne[2
+000464e0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+000464f0: 3634 5f74 206e 6533 203d 2064 7374 2d3e  64_t ne3 = dst->
+00046500: 6e65 5b33 5d3b 0a0a 2020 2020 6173 7365  ne[3];..    asse
+00046510: 7274 286e 6530 203d 3d20 3129 3b0a 2020  rt(ne0 == 1);.  
+00046520: 2020 6173 7365 7274 286e 6531 203d 3d20    assert(ne1 == 
+00046530: 6e65 3031 293b 0a20 2020 2061 7373 6572  ne01);.    asser
+00046540: 7428 6e65 3220 3d3d 206e 6530 3229 3b0a  t(ne2 == ne02);.
+00046550: 2020 2020 6173 7365 7274 286e 6533 203d      assert(ne3 =
+00046560: 3d20 6e65 3033 293b 0a0a 2020 2020 554e  = ne03);..    UN
+00046570: 5553 4544 286e 6530 293b 0a20 2020 2055  USED(ne0);.    U
+00046580: 4e55 5345 4428 6e65 3129 3b0a 2020 2020  NUSED(ne1);.    
+00046590: 554e 5553 4544 286e 6532 293b 0a20 2020  UNUSED(ne2);.   
+000465a0: 2055 4e55 5345 4428 6e65 3329 3b0a 0a20   UNUSED(ne3);.. 
+000465b0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+000465c0: 6e62 3120 3d20 6473 742d 3e6e 625b 315d  nb1 = dst->nb[1]
+000465d0: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
+000465e0: 5f74 206e 6232 203d 2064 7374 2d3e 6e62  _t nb2 = dst->nb
+000465f0: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
+00046600: 697a 655f 7420 6e62 3320 3d20 6473 742d  ize_t nb3 = dst-
+00046610: 3e6e 625b 335d 3b0a 0a20 2020 2066 6f72  >nb[3];..    for
+00046620: 2028 696e 7436 345f 7420 6930 3320 3d20   (int64_t i03 = 
+00046630: 303b 2069 3033 203c 206e 6530 333b 2069  0; i03 < ne03; i
+00046640: 3033 2b2b 2920 7b0a 2020 2020 2020 2020  03++) {.        
+00046650: 666f 7220 2869 6e74 3634 5f74 2069 3032  for (int64_t i02
+00046660: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
+00046670: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
+00046680: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00046690: 345f 7420 6930 3120 3d20 303b 2069 3031  4_t i01 = 0; i01
+000466a0: 203c 206e 6530 313b 2069 3031 2b2b 2920   < ne01; i01++) 
+000466b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000466c0: 2020 6767 6d6c 5f76 6563 5f73 756d 5f66    ggml_vec_sum_f
+000466d0: 3332 286e 6530 302c 0a20 2020 2020 2020  32(ne00,.       
+000466e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000466f0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+00046700: 7220 2a29 2020 6473 742d 3e64 6174 6120  r *)  dst->data 
+00046710: 2b20 6930 312a 6e62 3120 202b 2069 3032  + i01*nb1  + i02
+00046720: 2a6e 6232 2020 2b20 6930 332a 6e62 3329  *nb2  + i03*nb3)
+00046730: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00046740: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+00046750: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
+00046760: 6330 2d3e 6461 7461 202b 2069 3031 2a6e  c0->data + i01*n
+00046770: 6230 3120 2b20 6930 322a 6e62 3032 202b  b01 + i02*nb02 +
+00046780: 2069 3033 2a6e 6230 3329 293b 0a0a 2020   i03*nb03));..  
+00046790: 2020 2020 2020 2020 2020 2020 2020 2a28                *(
+000467a0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+000467b0: 2a29 2064 7374 2d3e 6461 7461 202b 2069  *) dst->data + i
+000467c0: 3031 2a6e 6231 202b 2069 3032 2a6e 6232  01*nb1 + i02*nb2
+000467d0: 202b 2069 3033 2a6e 6233 2920 2f3d 2028   + i03*nb3) /= (
+000467e0: 666c 6f61 7429 206e 6530 303b 0a20 2020  float) ne00;.   
+000467f0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00046800: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
+00046810: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00046820: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
+00046830: 6561 6e28 0a20 2020 2020 2020 2063 6f6e  ean(.        con
+00046840: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00046850: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00046860: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00046870: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00046880: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00046890: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000468a0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+000468b0: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+000468c0: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+000468d0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000468e0: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
+000468f0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00046900: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00046910: 6d70 7574 655f 666f 7277 6172 645f 6d65  mpute_forward_me
+00046920: 616e 5f66 3332 2870 6172 616d 732c 2073  an_f32(params, s
+00046930: 7263 302c 2064 7374 293b 0a20 2020 2020  rc0, dst);.     
+00046940: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00046950: 2020 2020 2020 2020 6465 6661 756c 743a          default:
+00046960: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00046970: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00046980: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00046990: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000469a0: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+000469b0: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+000469c0: 5f66 6f72 7761 7264 5f72 6570 6561 740a  _forward_repeat.
+000469d0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+000469e0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000469f0: 645f 7265 7065 6174 5f66 3332 280a 2020  d_repeat_f32(.  
+00046a00: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00046a10: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00046a20: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00046a30: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00046a40: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00046a50: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00046a60: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00046a70: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00046a80: 2020 4747 4d4c 5f41 5353 4552 5428 7061    GGML_ASSERT(pa
+00046a90: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
+00046aa0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00046ab0: 2867 676d 6c5f 6361 6e5f 7265 7065 6174  (ggml_can_repeat
+00046ac0: 2873 7263 302c 2064 7374 2929 3b0a 0a20  (src0, dst));.. 
+00046ad0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+00046ae0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+00046af0: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
+00046b00: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00046b10: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
+00046b20: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+00046b30: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
+00046b40: 696e 7436 345f 7420 6e65 3020 203d 2064  int64_t ne0  = d
+00046b50: 7374 2d3e 6e65 5b30 5d3b 0a20 2020 2063  st->ne[0];.    c
+00046b60: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
+00046b70: 2020 3d20 6473 742d 3e6e 655b 315d 3b0a    = dst->ne[1];.
+00046b80: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00046b90: 7420 6e65 3220 203d 2064 7374 2d3e 6e65  t ne2  = dst->ne
+00046ba0: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
+00046bb0: 6e74 3634 5f74 206e 6533 2020 3d20 6473  nt64_t ne3  = ds
+00046bc0: 742d 3e6e 655b 335d 3b0a 0a20 2020 2063  t->ne[3];..    c
+00046bd0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+00046be0: 3020 3d20 7372 6330 2d3e 6e65 5b30 5d3b  0 = src0->ne[0];
+00046bf0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00046c00: 5f74 206e 6530 3120 3d20 7372 6330 2d3e  _t ne01 = src0->
+00046c10: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
+00046c20: 2069 6e74 3634 5f74 206e 6530 3220 3d20   int64_t ne02 = 
+00046c30: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
+00046c40: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00046c50: 6530 3320 3d20 7372 6330 2d3e 6e65 5b33  e03 = src0->ne[3
+00046c60: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
+00046c70: 7a65 5f74 206e 6230 2020 3d20 6473 742d  ze_t nb0  = dst-
+00046c80: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
+00046c90: 7420 7369 7a65 5f74 206e 6231 2020 3d20  t size_t nb1  = 
+00046ca0: 6473 742d 3e6e 625b 315d 3b0a 2020 2020  dst->nb[1];.    
+00046cb0: 636f 6e73 7420 7369 7a65 5f74 206e 6232  const size_t nb2
+00046cc0: 2020 3d20 6473 742d 3e6e 625b 325d 3b0a    = dst->nb[2];.
+00046cd0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00046ce0: 206e 6233 2020 3d20 6473 742d 3e6e 625b   nb3  = dst->nb[
+00046cf0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2073  3];..    const s
+00046d00: 697a 655f 7420 6e62 3030 203d 2073 7263  ize_t nb00 = src
+00046d10: 302d 3e6e 625b 305d 3b0a 2020 2020 636f  0->nb[0];.    co
+00046d20: 6e73 7420 7369 7a65 5f74 206e 6230 3120  nst size_t nb01 
+00046d30: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a20  = src0->nb[1];. 
+00046d40: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+00046d50: 6e62 3032 203d 2073 7263 302d 3e6e 625b  nb02 = src0->nb[
+00046d60: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
+00046d70: 7a65 5f74 206e 6230 3320 3d20 7372 6330  ze_t nb03 = src0
+00046d80: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 2f2f  ->nb[3];..    //
+00046d90: 2067 7561 7261 6e74 6565 6420 746f 2062   guaranteed to b
+00046da0: 6520 616e 2069 6e74 6567 6572 2064 7565  e an integer due
+00046db0: 2074 6f20 7468 6520 6368 6563 6b20 696e   to the check in
+00046dc0: 2067 676d 6c5f 6361 6e5f 7265 7065 6174   ggml_can_repeat
+00046dd0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00046de0: 7230 203d 2028 696e 7429 286e 6530 2f6e  r0 = (int)(ne0/n
+00046df0: 6530 3029 3b0a 2020 2020 636f 6e73 7420  e00);.    const 
+00046e00: 696e 7420 6e72 3120 3d20 2869 6e74 2928  int nr1 = (int)(
+00046e10: 6e65 312f 6e65 3031 293b 0a20 2020 2063  ne1/ne01);.    c
+00046e20: 6f6e 7374 2069 6e74 206e 7232 203d 2028  onst int nr2 = (
+00046e30: 696e 7429 286e 6532 2f6e 6530 3229 3b0a  int)(ne2/ne02);.
+00046e40: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
+00046e50: 3320 3d20 2869 6e74 2928 6e65 332f 6e65  3 = (int)(ne3/ne
+00046e60: 3033 293b 0a0a 2020 2020 2f2f 2054 4f44  03);..    // TOD
+00046e70: 4f3a 2073 7570 706f 7274 2066 6f72 2074  O: support for t
+00046e80: 7261 6e73 706f 7365 6420 2f20 7065 726d  ransposed / perm
+00046e90: 7574 6564 2074 656e 736f 7273 0a20 2020  uted tensors.   
+00046ea0: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
+00046eb0: 2020 3d3d 2073 697a 656f 6628 666c 6f61    == sizeof(floa
+00046ec0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+00046ed0: 5345 5254 286e 6230 3020 3d3d 2073 697a  SERT(nb00 == siz
+00046ee0: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
+00046ef0: 2020 2f2f 2054 4f44 4f3a 206d 6179 6265    // TODO: maybe
+00046f00: 2074 6869 7320 6973 206e 6f74 206f 7074   this is not opt
+00046f10: 696d 616c 3f0a 2020 2020 666f 7220 2020  imal?.    for   
+00046f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046f30: 2020 2020 2020 2869 6e74 2069 3320 3d20        (int i3 = 
+00046f40: 303b 2069 3320 3c20 6e72 333b 2020 6933  0; i3 < nr3;  i3
+00046f50: 2b2b 2920 7b0a 2020 2020 2020 2020 666f  ++) {.        fo
+00046f60: 7220 2020 2020 2020 2020 2020 2020 2020  r               
+00046f70: 2020 2020 2020 2869 6e74 206b 3320 3d20        (int k3 = 
+00046f80: 303b 206b 3320 3c20 6e65 3033 3b20 6b33  0; k3 < ne03; k3
+00046f90: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00046fa0: 2020 666f 7220 2020 2020 2020 2020 2020    for           
+00046fb0: 2020 2020 2020 2869 6e74 2069 3220 3d20        (int i2 = 
+00046fc0: 303b 2069 3220 3c20 6e72 323b 2020 6932  0; i2 < nr2;  i2
+00046fd0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00046fe0: 2020 2020 2020 666f 7220 2020 2020 2020        for       
+00046ff0: 2020 2020 2020 2869 6e74 206b 3220 3d20        (int k2 = 
+00047000: 303b 206b 3220 3c20 6e65 3032 3b20 6b32  0; k2 < ne02; k2
+00047010: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00047020: 2020 2020 2020 2020 2020 666f 7220 2020            for   
+00047030: 2020 2020 2020 2869 6e74 2069 3120 3d20        (int i1 = 
+00047040: 303b 2069 3120 3c20 6e72 313b 2020 6931  0; i1 < nr1;  i1
+00047050: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00047060: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00047070: 7220 2020 2020 2869 6e74 206b 3120 3d20  r     (int k1 = 
+00047080: 303b 206b 3120 3c20 6e65 3031 3b20 6b31  0; k1 < ne01; k1
+00047090: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+000470a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000470b0: 2020 666f 7220 2869 6e74 2069 3020 3d20    for (int i0 = 
+000470c0: 303b 2069 3020 3c20 6e72 303b 2020 6930  0; i0 < nr0;  i0
+000470d0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
 000470e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000470f0: 2066 6f72 2028 696e 7420 6930 203d 2030   for (int i0 = 0
-00047100: 3b20 6930 203c 206e 7230 3b20 2069 302b  ; i0 < nr0;  i0+
-00047110: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000470f0: 2020 2020 2020 6767 6d6c 5f76 6563 5f63        ggml_vec_c
+00047100: 7079 5f66 3332 286e 6530 302c 0a20 2020  py_f32(ne00,.   
+00047110: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00047120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047130: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
-00047140: 795f 6633 3228 6e65 3030 2c0a 2020 2020  y_f32(ne00,.    
-00047150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047170: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00047180: 6368 6172 202a 2920 2064 7374 2d3e 6461  char *)  dst->da
-00047190: 7461 202b 2028 6933 2a6e 6530 3320 2b20  ta + (i3*ne03 + 
-000471a0: 6b33 292a 6e62 3320 202b 2028 6932 2a6e  k3)*nb3  + (i2*n
-000471b0: 6530 3220 2b20 6b32 292a 6e62 3220 202b  e02 + k2)*nb2  +
-000471c0: 2028 6931 2a6e 6530 3120 2b20 6b31 292a   (i1*ne01 + k1)*
-000471d0: 6e62 3120 202b 2028 6930 2a6e 6530 3029  nb1  + (i0*ne00)
-000471e0: 2a6e 6230 292c 0a20 2020 2020 2020 2020  *nb0),.         
-000471f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047200: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00047210: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00047220: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00047230: 2820 2020 2020 2020 2020 206b 3329 2a6e  (          k3)*n
-00047240: 6230 3320 2b20 2820 2020 2020 2020 2020  b03 + (         
-00047250: 206b 3229 2a6e 6230 3220 2b20 2820 2020   k2)*nb02 + (   
-00047260: 2020 2020 2020 206b 3129 2a6e 6230 3129         k1)*nb01)
-00047270: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00047280: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00047290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000472a0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000472b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000472c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000472d0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-000472e0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-000472f0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-00047300: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00047310: 7761 7264 5f72 6570 6561 7428 0a20 2020  ward_repeat(.   
-00047320: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00047330: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-00047340: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00047350: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00047360: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00047370: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00047380: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00047390: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-000473a0: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-000473b0: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-000473c0: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-000473d0: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-000473e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000473f0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00047400: 7277 6172 645f 7265 7065 6174 5f66 3332  rward_repeat_f32
-00047410: 2870 6172 616d 732c 2073 7263 302c 2064  (params, src0, d
-00047420: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00047430: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00047440: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
-00047450: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00047460: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00047470: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00047480: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00047490: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
-000474a0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000474b0: 7264 5f72 6570 6561 745f 6261 636b 0a0a  rd_repeat_back..
-000474c0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-000474d0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000474e0: 5f72 6570 6561 745f 6261 636b 5f66 3332  _repeat_back_f32
-000474f0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-00047500: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00047510: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00047520: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-00047530: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00047540: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-00047550: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00047560: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-00047570: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-00047580: 5428 7061 7261 6d73 2d3e 6974 6820 3d3d  T(params->ith ==
-00047590: 2030 293b 0a20 2020 2047 474d 4c5f 4153   0);.    GGML_AS
-000475a0: 5345 5254 2867 676d 6c5f 6361 6e5f 7265  SERT(ggml_can_re
-000475b0: 7065 6174 2864 7374 2c20 7372 6330 2929  peat(dst, src0))
-000475c0: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
-000475d0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-000475e0: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
-000475f0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00047600: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
-00047610: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-00047620: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
-00047630: 6e73 7420 696e 7436 345f 7420 6e65 3020  nst int64_t ne0 
-00047640: 203d 2064 7374 2d3e 6e65 5b30 5d3b 0a20   = dst->ne[0];. 
-00047650: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00047660: 206e 6531 2020 3d20 6473 742d 3e6e 655b   ne1  = dst->ne[
-00047670: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-00047680: 7436 345f 7420 6e65 3220 203d 2064 7374  t64_t ne2  = dst
-00047690: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
-000476a0: 7374 2069 6e74 3634 5f74 206e 6533 2020  st int64_t ne3  
-000476b0: 3d20 6473 742d 3e6e 655b 335d 3b0a 0a20  = dst->ne[3];.. 
-000476c0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-000476d0: 206e 6530 3020 3d20 7372 6330 2d3e 6e65   ne00 = src0->ne
-000476e0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-000476f0: 6e74 3634 5f74 206e 6530 3120 3d20 7372  nt64_t ne01 = sr
-00047700: 6330 2d3e 6e65 5b31 5d3b 0a20 2020 2063  c0->ne[1];.    c
-00047710: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
-00047720: 3220 3d20 7372 6330 2d3e 6e65 5b32 5d3b  2 = src0->ne[2];
-00047730: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00047740: 5f74 206e 6530 3320 3d20 7372 6330 2d3e  _t ne03 = src0->
-00047750: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
-00047760: 7420 7369 7a65 5f74 206e 6230 2020 3d20  t size_t nb0  = 
-00047770: 6473 742d 3e6e 625b 305d 3b0a 2020 2020  dst->nb[0];.    
-00047780: 636f 6e73 7420 7369 7a65 5f74 206e 6231  const size_t nb1
-00047790: 2020 3d20 6473 742d 3e6e 625b 315d 3b0a    = dst->nb[1];.
-000477a0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-000477b0: 206e 6232 2020 3d20 6473 742d 3e6e 625b   nb2  = dst->nb[
-000477c0: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
-000477d0: 7a65 5f74 206e 6233 2020 3d20 6473 742d  ze_t nb3  = dst-
-000477e0: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-000477f0: 7374 2073 697a 655f 7420 6e62 3030 203d  st size_t nb00 =
-00047800: 2073 7263 302d 3e6e 625b 305d 3b0a 2020   src0->nb[0];.  
-00047810: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00047820: 6230 3120 3d20 7372 6330 2d3e 6e62 5b31  b01 = src0->nb[1
-00047830: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-00047840: 655f 7420 6e62 3032 203d 2073 7263 302d  e_t nb02 = src0-
-00047850: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
-00047860: 7420 7369 7a65 5f74 206e 6230 3320 3d20  t size_t nb03 = 
-00047870: 7372 6330 2d3e 6e62 5b33 5d3b 0a0a 2020  src0->nb[3];..  
-00047880: 2020 2f2f 2067 7561 7261 6e74 6565 6420    // guaranteed 
-00047890: 746f 2062 6520 616e 2069 6e74 6567 6572  to be an integer
-000478a0: 2064 7565 2074 6f20 7468 6520 6368 6563   due to the chec
-000478b0: 6b20 696e 2067 676d 6c5f 6361 6e5f 7265  k in ggml_can_re
-000478c0: 7065 6174 0a20 2020 2063 6f6e 7374 2069  peat.    const i
-000478d0: 6e74 206e 7230 203d 2028 696e 7429 286e  nt nr0 = (int)(n
-000478e0: 6530 302f 6e65 3029 3b0a 2020 2020 636f  e00/ne0);.    co
-000478f0: 6e73 7420 696e 7420 6e72 3120 3d20 2869  nst int nr1 = (i
-00047900: 6e74 2928 6e65 3031 2f6e 6531 293b 0a20  nt)(ne01/ne1);. 
-00047910: 2020 2063 6f6e 7374 2069 6e74 206e 7232     const int nr2
-00047920: 203d 2028 696e 7429 286e 6530 322f 6e65   = (int)(ne02/ne
-00047930: 3229 3b0a 2020 2020 636f 6e73 7420 696e  2);.    const in
-00047940: 7420 6e72 3320 3d20 2869 6e74 2928 6e65  t nr3 = (int)(ne
-00047950: 3033 2f6e 6533 293b 0a0a 2020 2020 2f2f  03/ne3);..    //
-00047960: 2054 4f44 4f3a 2073 7570 706f 7274 2066   TODO: support f
-00047970: 6f72 2074 7261 6e73 706f 7365 6420 2f20  or transposed / 
-00047980: 7065 726d 7574 6564 2074 656e 736f 7273  permuted tensors
-00047990: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000479a0: 286e 6230 2020 3d3d 2073 697a 656f 6628  (nb0  == sizeof(
-000479b0: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
-000479c0: 4c5f 4153 5345 5254 286e 6230 3020 3d3d  L_ASSERT(nb00 ==
-000479d0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-000479e0: 0a0a 2020 2020 6966 2028 6767 6d6c 5f69  ..    if (ggml_i
-000479f0: 735f 636f 6e74 6967 756f 7573 2864 7374  s_contiguous(dst
-00047a00: 2929 207b 0a20 2020 2020 2020 2067 676d  )) {.        ggm
-00047a10: 6c5f 7665 635f 7365 745f 6633 3228 6e65  l_vec_set_f32(ne
-00047a20: 302a 6e65 312a 6e65 322a 6e65 332c 2064  0*ne1*ne2*ne3, d
-00047a30: 7374 2d3e 6461 7461 2c20 3029 3b0a 2020  st->data, 0);.  
-00047a40: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-00047a50: 2020 2066 6f72 2020 2020 2020 2020 2028     for         (
-00047a60: 696e 7420 6b33 203d 2030 3b20 6b33 203c  int k3 = 0; k3 <
-00047a70: 206e 6533 3b20 6b33 2b2b 2920 7b0a 2020   ne3; k3++) {.  
-00047a80: 2020 2020 2020 2020 2020 666f 7220 2020            for   
-00047a90: 2020 2869 6e74 206b 3220 3d20 303b 206b    (int k2 = 0; k
-00047aa0: 3220 3c20 6e65 323b 206b 322b 2b29 207b  2 < ne2; k2++) {
-00047ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047ac0: 2066 6f72 2028 696e 7420 6b31 203d 2030   for (int k1 = 0
-00047ad0: 3b20 6b31 203c 206e 6531 3b20 6b31 2b2b  ; k1 < ne1; k1++
-00047ae0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00047af0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-00047b00: 5f73 6574 5f66 3332 286e 6530 2c0a 2020  _set_f32(ne0,.  
-00047b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047b20: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-00047b30: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
-00047b40: 6174 6120 2b20 6b31 2a6e 6231 202b 206b  ata + k1*nb1 + k
-00047b50: 322a 6e62 3220 2b20 6b33 2a6e 6233 292c  2*nb2 + k3*nb3),
-00047b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047b70: 2020 2020 2020 2020 2030 293b 0a20 2020           0);.   
-00047b80: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00047b90: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00047ba0: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-00047bb0: 2020 2f2f 2054 4f44 4f3a 206d 6179 6265    // TODO: maybe
-00047bc0: 2074 6869 7320 6973 206e 6f74 206f 7074   this is not opt
-00047bd0: 696d 616c 3f0a 2020 2020 666f 7220 2020  imal?.    for   
-00047be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047bf0: 2020 2020 2020 2869 6e74 2069 3320 3d20        (int i3 = 
-00047c00: 303b 2069 3320 3c20 6e72 333b 2069 332b  0; i3 < nr3; i3+
-00047c10: 2b29 207b 0a20 2020 2020 2020 2066 6f72  +) {.        for
-00047c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047c30: 2020 2020 2028 696e 7420 6b33 203d 2030       (int k3 = 0
-00047c40: 3b20 6b33 203c 206e 6533 3b20 6b33 2b2b  ; k3 < ne3; k3++
+00047130: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00047140: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
+00047150: 6174 6120 2b20 2869 332a 6e65 3033 202b  ata + (i3*ne03 +
+00047160: 206b 3329 2a6e 6233 2020 2b20 2869 322a   k3)*nb3  + (i2*
+00047170: 6e65 3032 202b 206b 3229 2a6e 6232 2020  ne02 + k2)*nb2  
+00047180: 2b20 2869 312a 6e65 3031 202b 206b 3129  + (i1*ne01 + k1)
+00047190: 2a6e 6231 2020 2b20 2869 302a 6e65 3030  *nb1  + (i0*ne00
+000471a0: 292a 6e62 3029 2c0a 2020 2020 2020 2020  )*nb0),.        
+000471b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000471c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000471d0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+000471e0: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+000471f0: 2028 2020 2020 2020 2020 2020 6b33 292a   (          k3)*
+00047200: 6e62 3033 202b 2028 2020 2020 2020 2020  nb03 + (        
+00047210: 2020 6b32 292a 6e62 3032 202b 2028 2020    k2)*nb02 + (  
+00047220: 2020 2020 2020 2020 6b31 292a 6e62 3031          k1)*nb01
+00047230: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
+00047240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047250: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00047260: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00047270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047280: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00047290: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+000472a0: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
+000472b0: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+000472c0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000472d0: 7277 6172 645f 7265 7065 6174 280a 2020  rward_repeat(.  
+000472e0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000472f0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00047300: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00047310: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00047320: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00047330: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00047340: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00047350: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00047360: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
+00047370: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+00047380: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+00047390: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
+000473a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000473b0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+000473c0: 6f72 7761 7264 5f72 6570 6561 745f 6633  orward_repeat_f3
+000473d0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+000473e0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+000473f0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00047400: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00047410: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00047420: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00047430: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00047440: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00047450: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+00047460: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00047470: 6172 645f 7265 7065 6174 5f62 6163 6b0a  ard_repeat_back.
+00047480: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00047490: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000474a0: 645f 7265 7065 6174 5f62 6163 6b5f 6633  d_repeat_back_f3
+000474b0: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
+000474c0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+000474d0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+000474e0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+000474f0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00047500: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00047510: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00047520: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00047530: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
+00047540: 5254 2870 6172 616d 732d 3e69 7468 203d  RT(params->ith =
+00047550: 3d20 3029 3b0a 2020 2020 4747 4d4c 5f41  = 0);.    GGML_A
+00047560: 5353 4552 5428 6767 6d6c 5f63 616e 5f72  SSERT(ggml_can_r
+00047570: 6570 6561 7428 6473 742c 2073 7263 3029  epeat(dst, src0)
+00047580: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
+00047590: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+000475a0: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
+000475b0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+000475c0: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
+000475d0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+000475e0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2063  rn;.    }..    c
+000475f0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+00047600: 2020 3d20 6473 742d 3e6e 655b 305d 3b0a    = dst->ne[0];.
+00047610: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00047620: 7420 6e65 3120 203d 2064 7374 2d3e 6e65  t ne1  = dst->ne
+00047630: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+00047640: 6e74 3634 5f74 206e 6532 2020 3d20 6473  nt64_t ne2  = ds
+00047650: 742d 3e6e 655b 325d 3b0a 2020 2020 636f  t->ne[2];.    co
+00047660: 6e73 7420 696e 7436 345f 7420 6e65 3320  nst int64_t ne3 
+00047670: 203d 2064 7374 2d3e 6e65 5b33 5d3b 0a0a   = dst->ne[3];..
+00047680: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00047690: 7420 6e65 3030 203d 2073 7263 302d 3e6e  t ne00 = src0->n
+000476a0: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+000476b0: 696e 7436 345f 7420 6e65 3031 203d 2073  int64_t ne01 = s
+000476c0: 7263 302d 3e6e 655b 315d 3b0a 2020 2020  rc0->ne[1];.    
+000476d0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+000476e0: 3032 203d 2073 7263 302d 3e6e 655b 325d  02 = src0->ne[2]
+000476f0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+00047700: 345f 7420 6e65 3033 203d 2073 7263 302d  4_t ne03 = src0-
+00047710: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
+00047720: 7374 2073 697a 655f 7420 6e62 3020 203d  st size_t nb0  =
+00047730: 2064 7374 2d3e 6e62 5b30 5d3b 0a20 2020   dst->nb[0];.   
+00047740: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+00047750: 3120 203d 2064 7374 2d3e 6e62 5b31 5d3b  1  = dst->nb[1];
+00047760: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00047770: 7420 6e62 3220 203d 2064 7374 2d3e 6e62  t nb2  = dst->nb
+00047780: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
+00047790: 697a 655f 7420 6e62 3320 203d 2064 7374  ize_t nb3  = dst
+000477a0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
+000477b0: 6e73 7420 7369 7a65 5f74 206e 6230 3020  nst size_t nb00 
+000477c0: 3d20 7372 6330 2d3e 6e62 5b30 5d3b 0a20  = src0->nb[0];. 
+000477d0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+000477e0: 6e62 3031 203d 2073 7263 302d 3e6e 625b  nb01 = src0->nb[
+000477f0: 315d 3b0a 2020 2020 636f 6e73 7420 7369  1];.    const si
+00047800: 7a65 5f74 206e 6230 3220 3d20 7372 6330  ze_t nb02 = src0
+00047810: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
+00047820: 7374 2073 697a 655f 7420 6e62 3033 203d  st size_t nb03 =
+00047830: 2073 7263 302d 3e6e 625b 335d 3b0a 0a20   src0->nb[3];.. 
+00047840: 2020 202f 2f20 6775 6172 616e 7465 6564     // guaranteed
+00047850: 2074 6f20 6265 2061 6e20 696e 7465 6765   to be an intege
+00047860: 7220 6475 6520 746f 2074 6865 2063 6865  r due to the che
+00047870: 636b 2069 6e20 6767 6d6c 5f63 616e 5f72  ck in ggml_can_r
+00047880: 6570 6561 740a 2020 2020 636f 6e73 7420  epeat.    const 
+00047890: 696e 7420 6e72 3020 3d20 2869 6e74 2928  int nr0 = (int)(
+000478a0: 6e65 3030 2f6e 6530 293b 0a20 2020 2063  ne00/ne0);.    c
+000478b0: 6f6e 7374 2069 6e74 206e 7231 203d 2028  onst int nr1 = (
+000478c0: 696e 7429 286e 6530 312f 6e65 3129 3b0a  int)(ne01/ne1);.
+000478d0: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
+000478e0: 3220 3d20 2869 6e74 2928 6e65 3032 2f6e  2 = (int)(ne02/n
+000478f0: 6532 293b 0a20 2020 2063 6f6e 7374 2069  e2);.    const i
+00047900: 6e74 206e 7233 203d 2028 696e 7429 286e  nt nr3 = (int)(n
+00047910: 6530 332f 6e65 3329 3b0a 0a20 2020 202f  e03/ne3);..    /
+00047920: 2f20 544f 444f 3a20 7375 7070 6f72 7420  / TODO: support 
+00047930: 666f 7220 7472 616e 7370 6f73 6564 202f  for transposed /
+00047940: 2070 6572 6d75 7465 6420 7465 6e73 6f72   permuted tensor
+00047950: 730a 2020 2020 4747 4d4c 5f41 5353 4552  s.    GGML_ASSER
+00047960: 5428 6e62 3020 203d 3d20 7369 7a65 6f66  T(nb0  == sizeof
+00047970: 2866 6c6f 6174 2929 3b0a 2020 2020 4747  (float));.    GG
+00047980: 4d4c 5f41 5353 4552 5428 6e62 3030 203d  ML_ASSERT(nb00 =
+00047990: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
+000479a0: 3b0a 0a20 2020 2069 6620 2867 676d 6c5f  ;..    if (ggml_
+000479b0: 6973 5f63 6f6e 7469 6775 6f75 7328 6473  is_contiguous(ds
+000479c0: 7429 2920 7b0a 2020 2020 2020 2020 6767  t)) {.        gg
+000479d0: 6d6c 5f76 6563 5f73 6574 5f66 3332 286e  ml_vec_set_f32(n
+000479e0: 6530 2a6e 6531 2a6e 6532 2a6e 6533 2c20  e0*ne1*ne2*ne3, 
+000479f0: 6473 742d 3e64 6174 612c 2030 293b 0a20  dst->data, 0);. 
+00047a00: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+00047a10: 2020 2020 666f 7220 2020 2020 2020 2020      for         
+00047a20: 2869 6e74 206b 3320 3d20 303b 206b 3320  (int k3 = 0; k3 
+00047a30: 3c20 6e65 333b 206b 332b 2b29 207b 0a20  < ne3; k3++) {. 
+00047a40: 2020 2020 2020 2020 2020 2066 6f72 2020             for  
+00047a50: 2020 2028 696e 7420 6b32 203d 2030 3b20     (int k2 = 0; 
+00047a60: 6b32 203c 206e 6532 3b20 6b32 2b2b 2920  k2 < ne2; k2++) 
+00047a70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00047a80: 2020 666f 7220 2869 6e74 206b 3120 3d20    for (int k1 = 
+00047a90: 303b 206b 3120 3c20 6e65 313b 206b 312b  0; k1 < ne1; k1+
+00047aa0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00047ab0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+00047ac0: 635f 7365 745f 6633 3228 6e65 302c 0a20  c_set_f32(ne0,. 
+00047ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ae0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+00047af0: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
+00047b00: 6461 7461 202b 206b 312a 6e62 3120 2b20  data + k1*nb1 + 
+00047b10: 6b32 2a6e 6232 202b 206b 332a 6e62 3329  k2*nb2 + k3*nb3)
+00047b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00047b30: 2020 2020 2020 2020 2020 3029 3b0a 2020            0);.  
+00047b40: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00047b50: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00047b60: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
+00047b70: 2020 202f 2f20 544f 444f 3a20 6d61 7962     // TODO: mayb
+00047b80: 6520 7468 6973 2069 7320 6e6f 7420 6f70  e this is not op
+00047b90: 7469 6d61 6c3f 0a20 2020 2066 6f72 2020  timal?.    for  
+00047ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047bb0: 2020 2020 2020 2028 696e 7420 6933 203d         (int i3 =
+00047bc0: 2030 3b20 6933 203c 206e 7233 3b20 6933   0; i3 < nr3; i3
+00047bd0: 2b2b 2920 7b0a 2020 2020 2020 2020 666f  ++) {.        fo
+00047be0: 7220 2020 2020 2020 2020 2020 2020 2020  r               
+00047bf0: 2020 2020 2020 2869 6e74 206b 3320 3d20        (int k3 = 
+00047c00: 303b 206b 3320 3c20 6e65 333b 206b 332b  0; k3 < ne3; k3+
+00047c10: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00047c20: 2066 6f72 2020 2020 2020 2020 2020 2020   for            
+00047c30: 2020 2020 2028 696e 7420 6932 203d 2030       (int i2 = 0
+00047c40: 3b20 6932 203c 206e 7232 3b20 6932 2b2b  ; i2 < nr2; i2++
 00047c50: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00047c60: 666f 7220 2020 2020 2020 2020 2020 2020  for             
-00047c70: 2020 2020 2869 6e74 2069 3220 3d20 303b      (int i2 = 0;
-00047c80: 2069 3220 3c20 6e72 323b 2069 322b 2b29   i2 < nr2; i2++)
+00047c60: 2020 2020 666f 7220 2020 2020 2020 2020      for         
+00047c70: 2020 2020 2869 6e74 206b 3220 3d20 303b      (int k2 = 0;
+00047c80: 206b 3220 3c20 6e65 323b 206b 322b 2b29   k2 < ne2; k2++)
 00047c90: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00047ca0: 2020 2066 6f72 2020 2020 2020 2020 2020     for          
-00047cb0: 2020 2028 696e 7420 6b32 203d 2030 3b20     (int k2 = 0; 
-00047cc0: 6b32 203c 206e 6532 3b20 6b32 2b2b 2920  k2 < ne2; k2++) 
+00047ca0: 2020 2020 2020 2066 6f72 2020 2020 2020         for      
+00047cb0: 2020 2028 696e 7420 6931 203d 2030 3b20     (int i1 = 0; 
+00047cc0: 6931 203c 206e 7231 3b20 6931 2b2b 2920  i1 < nr1; i1++) 
 00047cd0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00047ce0: 2020 2020 2020 666f 7220 2020 2020 2020        for       
-00047cf0: 2020 2869 6e74 2069 3120 3d20 303b 2069    (int i1 = 0; i
-00047d00: 3120 3c20 6e72 313b 2069 312b 2b29 207b  1 < nr1; i1++) {
+00047ce0: 2020 2020 2020 2020 2020 666f 7220 2020            for   
+00047cf0: 2020 2869 6e74 206b 3120 3d20 303b 206b    (int k1 = 0; k
+00047d00: 3120 3c20 6e65 313b 206b 312b 2b29 207b  1 < ne1; k1++) {
 00047d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047d20: 2020 2020 2020 2020 2066 6f72 2020 2020           for    
-00047d30: 2028 696e 7420 6b31 203d 2030 3b20 6b31   (int k1 = 0; k1
-00047d40: 203c 206e 6531 3b20 6b31 2b2b 2920 7b0a   < ne1; k1++) {.
+00047d20: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00047d30: 2028 696e 7420 6930 203d 2030 3b20 6930   (int i0 = 0; i0
+00047d40: 203c 206e 7230 3b20 6930 2b2b 2920 7b0a   < nr0; i0++) {.
 00047d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047d60: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00047d70: 2869 6e74 2069 3020 3d20 303b 2069 3020  (int i0 = 0; i0 
-00047d80: 3c20 6e72 303b 2069 302b 2b29 207b 0a20  < nr0; i0++) {. 
+00047d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047d70: 6767 6d6c 5f76 6563 5f61 6363 5f66 3332  ggml_vec_acc_f32
+00047d80: 286e 6530 2c0a 2020 2020 2020 2020 2020  (ne0,.          
 00047d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047da0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00047db0: 676d 6c5f 7665 635f 6163 635f 6633 3228  gml_vec_acc_f32(
-00047dc0: 6e65 302c 0a20 2020 2020 2020 2020 2020  ne0,.           
-00047dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047de0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-00047df0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00047e00: 2020 6473 742d 3e64 6174 6120 2b20 2820    dst->data + ( 
-00047e10: 2020 2020 2020 2020 6b33 292a 6e62 3320          k3)*nb3 
-00047e20: 202b 2028 2020 2020 2020 2020 206b 3229   + (         k2)
-00047e30: 2a6e 6232 2020 2b20 2820 2020 2020 2020  *nb2  + (       
-00047e40: 2020 6b31 292a 6e62 3129 2c0a 2020 2020    k1)*nb1),.    
-00047e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047e70: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00047e80: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-00047e90: 7461 202b 2028 6933 2a6e 6533 202b 206b  ta + (i3*ne3 + k
-00047ea0: 3329 2a6e 6230 3320 2b20 2869 322a 6e65  3)*nb03 + (i2*ne
-00047eb0: 3220 2b20 6b32 292a 6e62 3032 202b 2028  2 + k2)*nb02 + (
-00047ec0: 6931 2a6e 6531 202b 206b 3129 2a6e 6230  i1*ne1 + k1)*nb0
-00047ed0: 3120 2b20 2869 302a 6e65 3029 2a6e 6230  1 + (i0*ne0)*nb0
-00047ee0: 3029 293b 0a20 2020 2020 2020 2020 2020  0));.           
-00047ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047f00: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00047f10: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00047f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047f30: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00047f40: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00047f50: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
-00047f60: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
-00047f70: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00047f80: 6f72 7761 7264 5f72 6570 6561 745f 6261  orward_repeat_ba
-00047f90: 636b 280a 2020 2020 2020 2020 636f 6e73  ck(.        cons
-00047fa0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00047fb0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00047fc0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00047fd0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00047fe0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00047ff0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00048000: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00048010: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00048020: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00048030: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00048040: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-00048050: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00048060: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00048070: 7075 7465 5f66 6f72 7761 7264 5f72 6570  pute_forward_rep
-00048080: 6561 745f 6261 636b 5f66 3332 2870 6172  eat_back_f32(par
-00048090: 616d 732c 2073 7263 302c 2064 7374 293b  ams, src0, dst);
-000480a0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-000480b0: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
-000480c0: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
-000480d0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000480e0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-000480f0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00048100: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00048110: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
-00048120: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
-00048130: 6273 0a0a 7374 6174 6963 2076 6f69 6420  bs..static void 
-00048140: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00048150: 7761 7264 5f61 6273 5f66 3332 280a 2020  ward_abs_f32(.  
-00048160: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00048170: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00048180: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00048190: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-000481a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000481b0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-000481c0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000481d0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-000481e0: 2020 6173 7365 7274 2870 6172 616d 732d    assert(params-
-000481f0: 3e69 7468 203d 3d20 3029 3b0a 2020 2020  >ith == 0);.    
-00048200: 6173 7365 7274 2867 676d 6c5f 6172 655f  assert(ggml_are_
-00048210: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
-00048220: 2064 7374 2929 3b0a 0a20 2020 2069 6620   dst));..    if 
-00048230: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00048240: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-00048250: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00048260: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-00048270: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-00048280: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00048290: 2020 2020 636f 6e73 7420 696e 7420 6e20      const int n 
-000482a0: 203d 2067 676d 6c5f 6e72 6f77 7328 7372   = ggml_nrows(sr
-000482b0: 6330 293b 0a20 2020 2063 6f6e 7374 2069  c0);.    const i
-000482c0: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
-000482d0: 5b30 5d3b 0a0a 2020 2020 6173 7365 7274  [0];..    assert
-000482e0: 2864 7374 2d3e 6e62 5b30 5d20 203d 3d20  (dst->nb[0]  == 
-000482f0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00048300: 2020 2020 6173 7365 7274 2873 7263 302d      assert(src0-
-00048310: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-00048320: 2866 6c6f 6174 2929 3b0a 0a20 2020 2066  (float));..    f
-00048330: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00048340: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
-00048350: 2020 2020 2067 676d 6c5f 7665 635f 6162       ggml_vec_ab
-00048360: 735f 6633 3228 6e63 2c0a 2020 2020 2020  s_f32(nc,.      
-00048370: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00048380: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-00048390: 742d 3e64 6174 6120 202b 2069 2a28 2064  t->data  + i*( d
-000483a0: 7374 2d3e 6e62 5b31 5d29 292c 0a20 2020  st->nb[1])),.   
-000483b0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-000483c0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-000483d0: 2073 7263 302d 3e64 6174 6120 2b20 692a   src0->data + i*
-000483e0: 2873 7263 302d 3e6e 625b 315d 2929 293b  (src0->nb[1])));
-000483f0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-00048400: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00048410: 7465 5f66 6f72 7761 7264 5f61 6273 280a  te_forward_abs(.
-00048420: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00048430: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00048440: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00048450: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00048460: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00048470: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00048480: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00048490: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-000484a0: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
-000484b0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-000484c0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000484d0: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-000484e0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000484f0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00048500: 5f66 6f72 7761 7264 5f61 6273 5f66 3332  _forward_abs_f32
-00048510: 2870 6172 616d 732c 2073 7263 302c 2064  (params, src0, d
-00048520: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00048530: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00048540: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
-00048550: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00048560: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00048570: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00048580: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00048590: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
-000485a0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000485b0: 7264 5f73 676e 0a0a 7374 6174 6963 2076  rd_sgn..static v
-000485c0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-000485d0: 5f66 6f72 7761 7264 5f73 676e 5f66 3332  _forward_sgn_f32
-000485e0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-000485f0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00048600: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00048610: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-00048620: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00048630: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-00048640: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00048650: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-00048660: 7b0a 2020 2020 6173 7365 7274 2870 6172  {.    assert(par
-00048670: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
-00048680: 2020 2020 6173 7365 7274 2867 676d 6c5f      assert(ggml_
-00048690: 6172 655f 7361 6d65 5f73 6861 7065 2873  are_same_shape(s
-000486a0: 7263 302c 2064 7374 2929 3b0a 0a20 2020  rc0, dst));..   
-000486b0: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-000486c0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-000486d0: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
-000486e0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-000486f0: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-00048700: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-00048710: 207d 0a0a 2020 2020 636f 6e73 7420 696e   }..    const in
-00048720: 7420 6e20 203d 2067 676d 6c5f 6e72 6f77  t n  = ggml_nrow
-00048730: 7328 7372 6330 293b 0a20 2020 2063 6f6e  s(src0);.    con
-00048740: 7374 2069 6e74 206e 6320 3d20 7372 6330  st int nc = src0
-00048750: 2d3e 6e65 5b30 5d3b 0a0a 2020 2020 6173  ->ne[0];..    as
-00048760: 7365 7274 2864 7374 2d3e 6e62 5b30 5d20  sert(dst->nb[0] 
-00048770: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-00048780: 2929 3b0a 2020 2020 6173 7365 7274 2873  ));.    assert(s
-00048790: 7263 302d 3e6e 625b 305d 203d 3d20 7369  rc0->nb[0] == si
-000487a0: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
-000487b0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-000487c0: 303b 2069 203c 206e 3b20 692b 2b29 207b  0; i < n; i++) {
-000487d0: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-000487e0: 635f 7367 6e5f 6633 3228 6e63 2c0a 2020  c_sgn_f32(nc,.  
-000487f0: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-00048800: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-00048810: 2920 6473 742d 3e64 6174 6120 202b 2069  ) dst->data  + i
-00048820: 2a28 2064 7374 2d3e 6e62 5b31 5d29 292c  *( dst->nb[1])),
-00048830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00048840: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-00048850: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00048860: 2b20 692a 2873 7263 302d 3e6e 625b 315d  + i*(src0->nb[1]
-00048870: 2929 293b 0a20 2020 207d 0a7d 0a0a 7374  )));.    }.}..st
-00048880: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00048890: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
-000488a0: 676e 280a 2020 2020 2020 2020 636f 6e73  gn(.        cons
-000488b0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-000488c0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-000488d0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-000488e0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000488f0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00048900: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00048910: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00048920: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00048930: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00048940: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00048950: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-00048960: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00048970: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00048980: 7075 7465 5f66 6f72 7761 7264 5f73 676e  pute_forward_sgn
-00048990: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
-000489a0: 302c 2064 7374 293b 0a20 2020 2020 2020  0, dst);.       
-000489b0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000489c0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
-000489d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000489e0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-000489f0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00048a00: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00048a10: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
-00048a20: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00048a30: 6f72 7761 7264 5f6e 6567 0a0a 7374 6174  orward_neg..stat
-00048a40: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00048a50: 7075 7465 5f66 6f72 7761 7264 5f6e 6567  pute_forward_neg
-00048a60: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
-00048a70: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00048a80: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00048a90: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00048aa0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00048ab0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00048ac0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00048ad0: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00048ae0: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
-00048af0: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
-00048b00: 3029 3b0a 2020 2020 6173 7365 7274 2867  0);.    assert(g
-00048b10: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
-00048b20: 7065 2873 7263 302c 2064 7374 2929 3b0a  pe(src0, dst));.
-00048b30: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00048b40: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00048b50: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
-00048b60: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00048b70: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-00048b80: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-00048b90: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
-00048ba0: 7420 696e 7420 6e20 203d 2067 676d 6c5f  t int n  = ggml_
-00048bb0: 6e72 6f77 7328 7372 6330 293b 0a20 2020  nrows(src0);.   
-00048bc0: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
-00048bd0: 7372 6330 2d3e 6e65 5b30 5d3b 0a0a 2020  src0->ne[0];..  
-00048be0: 2020 6173 7365 7274 2864 7374 2d3e 6e62    assert(dst->nb
-00048bf0: 5b30 5d20 203d 3d20 7369 7a65 6f66 2866  [0]  == sizeof(f
-00048c00: 6c6f 6174 2929 3b0a 2020 2020 6173 7365  loat));.    asse
-00048c10: 7274 2873 7263 302d 3e6e 625b 305d 203d  rt(src0->nb[0] =
-00048c20: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-00048c30: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-00048c40: 6920 3d20 303b 2069 203c 206e 3b20 692b  i = 0; i < n; i+
-00048c50: 2b29 207b 0a20 2020 2020 2020 2067 676d  +) {.        ggm
-00048c60: 6c5f 7665 635f 6e65 675f 6633 3228 6e63  l_vec_neg_f32(nc
-00048c70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00048c80: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-00048c90: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
-00048ca0: 202b 2069 2a28 2064 7374 2d3e 6e62 5b31   + i*( dst->nb[1
-00048cb0: 5d29 292c 0a20 2020 2020 2020 2020 2020  ])),.           
-00048cc0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-00048cd0: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-00048ce0: 6174 6120 2b20 692a 2873 7263 302d 3e6e  ata + i*(src0->n
-00048cf0: 625b 315d 2929 293b 0a20 2020 207d 0a7d  b[1])));.    }.}
-00048d00: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00048d10: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00048d20: 7264 5f6e 6567 280a 2020 2020 2020 2020  rd_neg(.        
-00048d30: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00048d40: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00048d50: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00048d60: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00048d70: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00048d80: 6330 2c0a 2020 2020 2020 2020 7374 7275  c0,.        stru
-00048d90: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00048da0: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
-00048db0: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-00048dc0: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-00048dd0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
-00048de0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00048df0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00048e00: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00048e10: 5f6e 6567 5f66 3332 2870 6172 616d 732c  _neg_f32(params,
-00048e20: 2073 7263 302c 2064 7374 293b 0a20 2020   src0, dst);.   
-00048e30: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00048e40: 3b0a 2020 2020 2020 2020 6465 6661 756c  ;.        defaul
-00048e50: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
-00048e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00048e70: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00048e80: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00048e90: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00048ea0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-00048eb0: 7465 5f66 6f72 7761 7264 5f73 7465 700a  te_forward_step.
-00048ec0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00048ed0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00048ee0: 645f 7374 6570 5f66 3332 280a 2020 2020  d_step_f32(.    
-00048ef0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00048f00: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00048f10: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00048f20: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00048f30: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00048f40: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00048f50: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00048f60: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-00048f70: 6173 7365 7274 2870 6172 616d 732d 3e69  assert(params->i
-00048f80: 7468 203d 3d20 3029 3b0a 2020 2020 6173  th == 0);.    as
-00048f90: 7365 7274 2867 676d 6c5f 6172 655f 7361  sert(ggml_are_sa
-00048fa0: 6d65 5f73 6861 7065 2873 7263 302c 2064  me_shape(src0, d
-00048fb0: 7374 2929 3b0a 0a20 2020 2069 6620 2870  st));..    if (p
-00048fc0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00048fd0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
-00048fe0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
-00048ff0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-00049000: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
-00049010: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-00049020: 2020 636f 6e73 7420 696e 7420 6e20 203d    const int n  =
-00049030: 2067 676d 6c5f 6e72 6f77 7328 7372 6330   ggml_nrows(src0
-00049040: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
-00049050: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
-00049060: 5d3b 0a0a 2020 2020 6173 7365 7274 2864  ];..    assert(d
-00049070: 7374 2d3e 6e62 5b30 5d20 203d 3d20 7369  st->nb[0]  == si
-00049080: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
-00049090: 2020 6173 7365 7274 2873 7263 302d 3e6e    assert(src0->n
-000490a0: 625b 305d 203d 3d20 7369 7a65 6f66 2866  b[0] == sizeof(f
-000490b0: 6c6f 6174 2929 3b0a 0a20 2020 2066 6f72  loat));..    for
-000490c0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-000490d0: 206e 3b20 692b 2b29 207b 0a20 2020 2020   n; i++) {.     
-000490e0: 2020 2067 676d 6c5f 7665 635f 7374 6570     ggml_vec_step
-000490f0: 5f66 3332 286e 632c 0a20 2020 2020 2020  _f32(nc,.       
-00049100: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-00049110: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
-00049120: 2d3e 6461 7461 2020 2b20 692a 2820 6473  ->data  + i*( ds
-00049130: 742d 3e6e 625b 315d 2929 2c0a 2020 2020  t->nb[1])),.    
-00049140: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
-00049150: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-00049160: 7372 6330 2d3e 6461 7461 202b 2069 2a28  src0->data + i*(
-00049170: 7372 6330 2d3e 6e62 5b31 5d29 2929 3b0a  src0->nb[1])));.
-00049180: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-00049190: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-000491a0: 655f 666f 7277 6172 645f 7374 6570 280a  e_forward_step(.
-000491b0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-000491c0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-000491d0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-000491e0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-000491f0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00049200: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00049210: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00049220: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00049230: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
-00049240: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-00049250: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00049260: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-00049270: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00049280: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00049290: 5f66 6f72 7761 7264 5f73 7465 705f 6633  _forward_step_f3
-000492a0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
-000492b0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
-000492c0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-000492d0: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
-000492e0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000492f0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-00049300: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
-00049310: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00049320: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
-00049330: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00049340: 6172 645f 7265 6c75 0a0a 7374 6174 6963  ard_relu..static
-00049350: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00049360: 7465 5f66 6f72 7761 7264 5f72 656c 755f  te_forward_relu_
-00049370: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
-00049380: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00049390: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-000493a0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-000493b0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000493c0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-000493d0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-000493e0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-000493f0: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
-00049400: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
-00049410: 293b 0a20 2020 2061 7373 6572 7428 6767  );.    assert(gg
-00049420: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-00049430: 6528 7372 6330 2c20 6473 7429 293b 0a0a  e(src0, dst));..
-00049440: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00049450: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00049460: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-00049470: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00049480: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-00049490: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-000494a0: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
-000494b0: 2069 6e74 206e 2020 3d20 6767 6d6c 5f6e   int n  = ggml_n
-000494c0: 726f 7773 2873 7263 3029 3b0a 2020 2020  rows(src0);.    
-000494d0: 636f 6e73 7420 696e 7420 6e63 203d 2073  const int nc = s
-000494e0: 7263 302d 3e6e 655b 305d 3b0a 0a20 2020  rc0->ne[0];..   
-000494f0: 2061 7373 6572 7428 6473 742d 3e6e 625b   assert(dst->nb[
-00049500: 305d 2020 3d3d 2073 697a 656f 6628 666c  0]  == sizeof(fl
-00049510: 6f61 7429 293b 0a20 2020 2061 7373 6572  oat));.    asser
-00049520: 7428 7372 6330 2d3e 6e62 5b30 5d20 3d3d  t(src0->nb[0] ==
-00049530: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-00049540: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
-00049550: 203d 2030 3b20 6920 3c20 6e3b 2069 2b2b   = 0; i < n; i++
-00049560: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
-00049570: 5f76 6563 5f72 656c 755f 6633 3228 6e63  _vec_relu_f32(nc
-00049580: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00049590: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-000495a0: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
-000495b0: 202b 2069 2a28 2064 7374 2d3e 6e62 5b31   + i*( dst->nb[1
-000495c0: 5d29 292c 0a20 2020 2020 2020 2020 2020  ])),.           
-000495d0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-000495e0: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-000495f0: 6174 6120 2b20 692a 2873 7263 302d 3e6e  ata + i*(src0->n
-00049600: 625b 315d 2929 293b 0a20 2020 207d 0a7d  b[1])));.    }.}
-00049610: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00049620: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00049630: 7264 5f72 656c 7528 0a20 2020 2020 2020  rd_relu(.       
-00049640: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00049650: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00049660: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00049670: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00049680: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00049690: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
-000496a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000496b0: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
-000496c0: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
-000496d0: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-000496e0: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
-000496f0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00049700: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00049710: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00049720: 645f 7265 6c75 5f66 3332 2870 6172 616d  d_relu_f32(param
-00049730: 732c 2073 7263 302c 2064 7374 293b 0a20  s, src0, dst);. 
-00049740: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00049750: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
-00049760: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-00049770: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00049780: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00049790: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-000497a0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000497b0: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
-000497c0: 7075 7465 5f66 6f72 7761 7264 5f67 656c  pute_forward_gel
-000497d0: 750a 0a73 7461 7469 6320 766f 6964 2067  u..static void g
-000497e0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000497f0: 6172 645f 6765 6c75 5f66 3332 280a 2020  ard_gelu_f32(.  
-00049800: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00049810: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00049820: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00049830: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00049840: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00049850: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00049860: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00049870: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00049880: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00049890: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-000498a0: 2873 7263 3029 293b 0a20 2020 2047 474d  (src0));.    GGM
-000498b0: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
-000498c0: 5f63 6f6e 7469 6775 6f75 7328 6473 7429  _contiguous(dst)
-000498d0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000498e0: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-000498f0: 5f73 6861 7065 2873 7263 302c 2064 7374  _shape(src0, dst
-00049900: 2929 3b0a 0a20 2020 2069 6620 2870 6172  ));..    if (par
-00049910: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00049920: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-00049930: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00049940: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-00049950: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00049960: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00049970: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
-00049980: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
-00049990: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
-000499a0: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
-000499b0: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
-000499c0: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
-000499d0: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
-000499e0: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
-000499f0: 3029 3b0a 0a20 2020 202f 2f20 726f 7773  0);..    // rows
-00049a00: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
-00049a10: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
-00049a20: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
-00049a30: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
-00049a40: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
-00049a50: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-00049a60: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
-00049a70: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-00049a80: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
-00049a90: 722c 206e 7229 3b0a 0a20 2020 2066 6f72  r, nr);..    for
-00049aa0: 2028 696e 7420 6931 203d 2069 7230 3b20   (int i1 = ir0; 
-00049ab0: 6931 203c 2069 7231 3b20 6931 2b2b 2920  i1 < ir1; i1++) 
-00049ac0: 7b0a 2020 2020 2020 2020 6767 6d6c 5f76  {.        ggml_v
-00049ad0: 6563 5f67 656c 755f 6633 3228 6e63 2c0a  ec_gelu_f32(nc,.
-00049ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049af0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00049b00: 202a 2920 6473 742d 3e64 6174 6120 202b   *) dst->data  +
-00049b10: 2069 312a 2820 6473 742d 3e6e 625b 315d   i1*( dst->nb[1]
-00049b20: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00049b30: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
-00049b40: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-00049b50: 7461 202b 2069 312a 2873 7263 302d 3e6e  ta + i1*(src0->n
-00049b60: 625b 315d 2929 293b 0a0a 2369 666e 6465  b[1])));..#ifnde
-00049b70: 6620 4e44 4542 5547 0a20 2020 2020 2020  f NDEBUG.       
-00049b80: 2066 6f72 2028 696e 7420 6b20 3d20 303b   for (int k = 0;
-00049b90: 206b 203c 206e 633b 206b 2b2b 2920 7b0a   k < nc; k++) {.
-00049ba0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00049bb0: 7420 666c 6f61 7420 7820 3d20 2828 666c  t float x = ((fl
-00049bc0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00049bd0: 2064 7374 2d3e 6461 7461 202b 2069 312a   dst->data + i1*
-00049be0: 2820 6473 742d 3e6e 625b 315d 2929 295b  ( dst->nb[1])))[
-00049bf0: 6b5d 3b0a 2020 2020 2020 2020 2020 2020  k];.            
-00049c00: 554e 5553 4544 2878 293b 0a20 2020 2020  UNUSED(x);.     
-00049c10: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
-00049c20: 736e 616e 2878 2929 3b0a 2020 2020 2020  snan(x));.      
-00049c30: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
-00049c40: 696e 6628 7829 293b 0a20 2020 2020 2020  inf(x));.       
-00049c50: 207d 0a23 656e 6469 660a 2020 2020 7d0a   }.#endif.    }.
-00049c60: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00049c70: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00049c80: 6172 645f 6765 6c75 280a 2020 2020 2020  ard_gelu(.      
-00049c90: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00049ca0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00049cb0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00049cc0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00049cd0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00049ce0: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
-00049cf0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00049d00: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
-00049d10: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
-00049d20: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-00049d30: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-00049d40: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00049d50: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00049d60: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00049d70: 7264 5f67 656c 755f 6633 3228 7061 7261  rd_gelu_f32(para
-00049d80: 6d73 2c20 7372 6330 2c20 6473 7429 3b0a  ms, src0, dst);.
-00049d90: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00049da0: 6561 6b3b 0a20 2020 2020 2020 2064 6566  eak;.        def
-00049db0: 6175 6c74 3a0a 2020 2020 2020 2020 2020  ault:.          
-00049dc0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00049dd0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00049de0: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-00049df0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00049e00: 207d 0a0a 2020 2020 2f2f 7072 696e 7466   }..    //printf
-00049e10: 2822 5858 5858 5858 5858 2067 656c 755c  ("XXXXXXXX gelu\
-00049e20: 6e22 293b 0a7d 0a0a 2f2f 2067 676d 6c5f  n");.}..// ggml_
-00049e30: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00049e40: 7369 6c75 0a0a 7374 6174 6963 2076 6f69  silu..static voi
-00049e50: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00049e60: 6f72 7761 7264 5f73 696c 755f 6633 3228  orward_silu_f32(
-00049e70: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00049e80: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00049e90: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00049ea0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00049eb0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00049ec0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-00049ed0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00049ee0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00049ef0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00049f00: 2867 676d 6c5f 6973 5f63 6f6e 7469 6775  (ggml_is_contigu
-00049f10: 6f75 7328 7372 6330 2929 3b0a 2020 2020  ous(src0));.    
-00049f20: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-00049f30: 5f69 735f 636f 6e74 6967 756f 7573 2864  _is_contiguous(d
-00049f40: 7374 2929 3b0a 2020 2020 4747 4d4c 5f41  st));.    GGML_A
-00049f50: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
-00049f60: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-00049f70: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
-00049f80: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00049f90: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
-00049fa0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
-00049fb0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00049fc0: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-00049fd0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-00049fe0: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-00049ff0: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-0004a000: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-0004a010: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-0004a020: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0004a030: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
-0004a040: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0004a050: 6e72 203d 2067 676d 6c5f 6e72 6f77 7328  nr = ggml_nrows(
-0004a060: 7372 6330 293b 0a0a 2020 2020 2f2f 2072  src0);..    // r
-0004a070: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
-0004a080: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
-0004a090: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
-0004a0a0: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
-0004a0b0: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
-0004a0c0: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-0004a0d0: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
-0004a0e0: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-0004a0f0: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
-0004a100: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
-0004a110: 666f 7220 2869 6e74 2069 3120 3d20 6972  for (int i1 = ir
-0004a120: 303b 2069 3120 3c20 6972 313b 2069 312b  0; i1 < ir1; i1+
-0004a130: 2b29 207b 0a20 2020 2020 2020 2067 676d  +) {.        ggm
-0004a140: 6c5f 7665 635f 7369 6c75 5f66 3332 286e  l_vec_silu_f32(n
-0004a150: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
-0004a160: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-0004a170: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
-0004a180: 2020 2b20 6931 2a28 2064 7374 2d3e 6e62    + i1*( dst->nb
-0004a190: 5b31 5d29 292c 0a20 2020 2020 2020 2020  [1])),.         
-0004a1a0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-0004a1b0: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-0004a1c0: 3e64 6174 6120 2b20 6931 2a28 7372 6330  >data + i1*(src0
-0004a1d0: 2d3e 6e62 5b31 5d29 2929 3b0a 0a23 6966  ->nb[1])));..#if
-0004a1e0: 6e64 6566 204e 4445 4255 470a 2020 2020  ndef NDEBUG.    
-0004a1f0: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
-0004a200: 2030 3b20 6b20 3c20 6e63 3b20 6b2b 2b29   0; k < nc; k++)
-0004a210: 207b 0a20 2020 2020 2020 2020 2020 2063   {.            c
-0004a220: 6f6e 7374 2066 6c6f 6174 2078 203d 2028  onst float x = (
-0004a230: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-0004a240: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
-0004a250: 6931 2a28 2064 7374 2d3e 6e62 5b31 5d29  i1*( dst->nb[1])
-0004a260: 2929 5b6b 5d3b 0a20 2020 2020 2020 2020  ))[k];.         
-0004a270: 2020 2055 4e55 5345 4428 7829 3b0a 2020     UNUSED(x);.  
-0004a280: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0004a290: 2821 6973 6e61 6e28 7829 293b 0a20 2020  (!isnan(x));.   
-0004a2a0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-0004a2b0: 2169 7369 6e66 2878 2929 3b0a 2020 2020  !isinf(x));.    
-0004a2c0: 2020 2020 7d0a 2365 6e64 6966 0a20 2020      }.#endif.   
-0004a2d0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
-0004a2e0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-0004a2f0: 6f72 7761 7264 5f73 696c 7528 0a20 2020  orward_silu(.   
-0004a300: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0004a310: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-0004a320: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-0004a330: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0004a340: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004a350: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-0004a360: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0004a370: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-0004a380: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-0004a390: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-0004a3a0: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-0004a3b0: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-0004a3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a3d0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-0004a3e0: 7277 6172 645f 7369 6c75 5f66 3332 2870  rward_silu_f32(p
-0004a3f0: 6172 616d 732c 2073 7263 302c 2064 7374  arams, src0, dst
-0004a400: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0004a410: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0004a420: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-0004a430: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0004a440: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0004a450: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-0004a460: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0004a470: 2020 2020 7d0a 7d0a 0a0a 2f2f 2067 676d      }.}...// ggm
-0004a480: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0004a490: 645f 7369 6c75 5f62 6163 6b0a 0a73 7461  d_silu_back..sta
-0004a4a0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-0004a4b0: 6d70 7574 655f 666f 7277 6172 645f 7369  mpute_forward_si
-0004a4c0: 6c75 5f62 6163 6b5f 6633 3228 0a20 2020  lu_back_f32(.   
-0004a4d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0004a4e0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-0004a4f0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-0004a500: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0004a510: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004a520: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-0004a530: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0004a540: 6d6c 5f74 656e 736f 7220 2a20 6772 6164  ml_tensor * grad
-0004a550: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0004a560: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-0004a570: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-0004a580: 5353 4552 5428 6767 6d6c 5f69 735f 636f  SSERT(ggml_is_co
-0004a590: 6e74 6967 756f 7573 2867 7261 6429 293b  ntiguous(grad));
-0004a5a0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0004a5b0: 2867 676d 6c5f 6973 5f63 6f6e 7469 6775  (ggml_is_contigu
-0004a5c0: 6f75 7328 7372 6330 2929 3b0a 2020 2020  ous(src0));.    
-0004a5d0: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-0004a5e0: 5f69 735f 636f 6e74 6967 756f 7573 2864  _is_contiguous(d
-0004a5f0: 7374 2929 3b0a 2020 2020 4747 4d4c 5f41  st));.    GGML_A
-0004a600: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
-0004a610: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-0004a620: 6473 7429 293b 0a20 2020 2047 474d 4c5f  dst));.    GGML_
-0004a630: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
-0004a640: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
-0004a650: 2067 7261 6429 293b 0a0a 2020 2020 6966   grad));..    if
-0004a660: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
-0004a670: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
-0004a680: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
-0004a690: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-0004a6a0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-0004a6b0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-0004a6c0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-0004a6d0: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
-0004a6e0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0004a6f0: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
-0004a700: 683b 0a0a 2020 2020 636f 6e73 7420 696e  h;..    const in
-0004a710: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
-0004a720: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0004a730: 7420 6e72 203d 2067 676d 6c5f 6e72 6f77  t nr = ggml_nrow
-0004a740: 7328 7372 6330 293b 0a0a 2020 2020 2f2f  s(src0);..    //
-0004a750: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
-0004a760: 0a20 2020 2063 6f6e 7374 2069 6e74 2064  .    const int d
-0004a770: 7220 3d20 286e 7220 2b20 6e74 6820 2d20  r = (nr + nth - 
-0004a780: 3129 2f6e 7468 3b0a 0a20 2020 202f 2f20  1)/nth;..    // 
-0004a790: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
-0004a7a0: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
-0004a7b0: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
-0004a7c0: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
-0004a7d0: 696e 7420 6972 3120 3d20 4d49 4e28 6972  int ir1 = MIN(ir
-0004a7e0: 3020 2b20 6472 2c20 6e72 293b 0a0a 2020  0 + dr, nr);..  
-0004a7f0: 2020 666f 7220 2869 6e74 2069 3120 3d20    for (int i1 = 
-0004a800: 6972 303b 2069 3120 3c20 6972 313b 2069  ir0; i1 < ir1; i
-0004a810: 312b 2b29 207b 0a20 2020 2020 2020 2067  1++) {.        g
-0004a820: 676d 6c5f 7665 635f 7369 6c75 5f62 6163  gml_vec_silu_bac
-0004a830: 6b77 6172 645f 6633 3228 6e63 2c0a 2020  kward_f32(nc,.  
-0004a840: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-0004a850: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-0004a860: 2920 6473 742d 3e64 6174 6120 202b 2069  ) dst->data  + i
-0004a870: 312a 2820 6473 742d 3e6e 625b 315d 2929  1*( dst->nb[1]))
-0004a880: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004a890: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-0004a8a0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-0004a8b0: 202b 2069 312a 2873 7263 302d 3e6e 625b   + i1*(src0->nb[
-0004a8c0: 315d 2929 2c0a 2020 2020 2020 2020 2020  1])),.          
-0004a8d0: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-0004a8e0: 2828 6368 6172 202a 2920 6772 6164 2d3e  ((char *) grad->
-0004a8f0: 6461 7461 202b 2069 312a 2867 7261 642d  data + i1*(grad-
-0004a900: 3e6e 625b 315d 2929 293b 0a0a 2369 666e  >nb[1])));..#ifn
-0004a910: 6465 6620 4e44 4542 5547 0a20 2020 2020  def NDEBUG.     
-0004a920: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
-0004a930: 303b 206b 203c 206e 633b 206b 2b2b 2920  0; k < nc; k++) 
-0004a940: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
-0004a950: 6e73 7420 666c 6f61 7420 7820 3d20 2828  nst float x = ((
-0004a960: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-0004a970: 2a29 2064 7374 2d3e 6461 7461 202b 2069  *) dst->data + i
-0004a980: 312a 2820 6473 742d 3e6e 625b 315d 2929  1*( dst->nb[1]))
-0004a990: 295b 6b5d 3b0a 2020 2020 2020 2020 2020  )[k];.          
-0004a9a0: 2020 554e 5553 4544 2878 293b 0a20 2020    UNUSED(x);.   
-0004a9b0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-0004a9c0: 2169 736e 616e 2878 2929 3b0a 2020 2020  !isnan(x));.    
-0004a9d0: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
-0004a9e0: 6973 696e 6628 7829 293b 0a20 2020 2020  isinf(x));.     
-0004a9f0: 2020 207d 0a23 656e 6469 660a 2020 2020     }.#endif.    
-0004aa00: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-0004aa10: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-0004aa20: 7277 6172 645f 7369 6c75 5f62 6163 6b28  rward_silu_back(
-0004aa30: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0004aa40: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0004aa50: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-0004aa60: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-0004aa70: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0004aa80: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-0004aa90: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0004aaa0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0004aab0: 6772 6164 2c0a 2020 2020 2020 2020 7374  grad,.        st
-0004aac0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004aad0: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
-0004aae0: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
-0004aaf0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-0004ab00: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-0004ab10: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0004ab20: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0004ab30: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0004ab40: 7264 5f73 696c 755f 6261 636b 5f66 3332  rd_silu_back_f32
-0004ab50: 2870 6172 616d 732c 2073 7263 302c 2067  (params, src0, g
-0004ab60: 7261 642c 2064 7374 293b 0a20 2020 2020  rad, dst);.     
-0004ab70: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0004ab80: 2020 2020 2020 2020 6465 6661 756c 743a          default:
-0004ab90: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0004aba0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-0004abb0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-0004abc0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0004abd0: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-0004abe0: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
-0004abf0: 5f66 6f72 7761 7264 5f6e 6f72 6d0a 0a73  _forward_norm..s
-0004ac00: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0004ac10: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0004ac20: 6e6f 726d 5f66 3332 280a 2020 2020 2020  norm_f32(.      
-0004ac30: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0004ac40: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0004ac50: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0004ac60: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0004ac70: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0004ac80: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
-0004ac90: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004aca0: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
-0004acb0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f61  ML_ASSERT(ggml_a
-0004acc0: 7265 5f73 616d 655f 7368 6170 6528 7372  re_same_shape(sr
-0004acd0: 6330 2c20 6473 7429 293b 0a0a 2020 2020  c0, dst));..    
-0004ace0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-0004acf0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-0004ad00: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
-0004ad10: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-0004ad20: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-0004ad30: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-0004ad40: 7d0a 0a20 2020 2047 474d 4c5f 4153 5345  }..    GGML_ASSE
-0004ad50: 5254 2873 7263 302d 3e6e 625b 305d 203d  RT(src0->nb[0] =
-0004ad60: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-0004ad70: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0004ad80: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
-0004ad90: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-0004ada0: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
-0004adb0: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
-0004adc0: 696e 7436 345f 7420 6e65 3030 203d 2073  int64_t ne00 = s
-0004add0: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
-0004ade0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0004adf0: 3031 203d 2073 7263 302d 3e6e 655b 315d  01 = src0->ne[1]
-0004ae00: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-0004ae10: 345f 7420 6e65 3032 203d 2073 7263 302d  4_t ne02 = src0-
-0004ae20: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-0004ae30: 7420 696e 7436 345f 7420 6e65 3033 203d  t int64_t ne03 =
-0004ae40: 2073 7263 302d 3e6e 655b 335d 3b0a 0a20   src0->ne[3];.. 
-0004ae50: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0004ae60: 6e62 3031 203d 2073 7263 302d 3e6e 625b  nb01 = src0->nb[
-0004ae70: 315d 3b0a 2020 2020 636f 6e73 7420 7369  1];.    const si
-0004ae80: 7a65 5f74 206e 6230 3220 3d20 7372 6330  ze_t nb02 = src0
-0004ae90: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-0004aea0: 7374 2073 697a 655f 7420 6e62 3033 203d  st size_t nb03 =
-0004aeb0: 2073 7263 302d 3e6e 625b 335d 3b0a 0a20   src0->nb[3];.. 
-0004aec0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0004aed0: 6e62 3120 3d20 6473 742d 3e6e 625b 315d  nb1 = dst->nb[1]
-0004aee0: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-0004aef0: 5f74 206e 6232 203d 2064 7374 2d3e 6e62  _t nb2 = dst->nb
-0004af00: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2073  [2];.    const s
-0004af10: 697a 655f 7420 6e62 3320 3d20 6473 742d  ize_t nb3 = dst-
-0004af20: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-0004af30: 7374 2066 6c6f 6174 2065 7073 203d 2031  st float eps = 1
-0004af40: 652d 3566 3b20 2f2f 2054 4f44 4f3a 206d  e-5f; // TODO: m
-0004af50: 616b 6520 7468 6973 2061 2070 6172 616d  ake this a param
-0004af60: 6574 6572 0a0a 2020 2020 2f2f 2054 4f44  eter..    // TOD
-0004af70: 4f3a 206f 7074 696d 697a 650a 2020 2020  O: optimize.    
-0004af80: 666f 7220 2869 6e74 3634 5f74 2069 3033  for (int64_t i03
-0004af90: 203d 2030 3b20 6930 3320 3c20 6e65 3033   = 0; i03 < ne03
-0004afa0: 3b20 6930 332b 2b29 207b 0a20 2020 2020  ; i03++) {.     
-0004afb0: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-0004afc0: 6930 3220 3d20 303b 2069 3032 203c 206e  i02 = 0; i02 < n
-0004afd0: 6530 323b 2069 3032 2b2b 2920 7b0a 2020  e02; i02++) {.  
-0004afe0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0004aff0: 6e74 3634 5f74 2069 3031 203d 2069 7468  nt64_t i01 = ith
-0004b000: 3b20 6930 3120 3c20 6e65 3031 3b20 6930  ; i01 < ne01; i0
-0004b010: 3120 2b3d 206e 7468 2920 7b0a 2020 2020  1 += nth) {.    
-0004b020: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0004b030: 7420 666c 6f61 7420 2a20 7820 3d20 2866  t float * x = (f
-0004b040: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-0004b050: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
-0004b060: 3031 2a6e 6230 3120 2b20 6930 322a 6e62  01*nb01 + i02*nb
-0004b070: 3032 202b 2069 3033 2a6e 6230 3329 3b0a  02 + i03*nb03);.
-0004b080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b090: 2067 676d 6c5f 666c 6f61 7420 7375 6d20   ggml_float sum 
-0004b0a0: 3d20 302e 303b 0a20 2020 2020 2020 2020  = 0.0;.         
-0004b0b0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-0004b0c0: 345f 7420 6930 3020 3d20 303b 2069 3030  4_t i00 = 0; i00
-0004b0d0: 203c 206e 6530 303b 2069 3030 2b2b 2920   < ne00; i00++) 
-0004b0e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0004b0f0: 2020 2020 2020 7375 6d20 2b3d 2028 6767        sum += (gg
-0004b100: 6d6c 5f66 6c6f 6174 2978 5b69 3030 5d3b  ml_float)x[i00];
-0004b110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b120: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-0004b130: 2020 2020 666c 6f61 7420 6d65 616e 203d      float mean =
-0004b140: 2073 756d 2f6e 6530 303b 0a0a 2020 2020   sum/ne00;..    
-0004b150: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-0004b160: 7420 2a20 7920 3d20 2866 6c6f 6174 202a  t * y = (float *
-0004b170: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
-0004b180: 3e64 6174 6120 2b20 6930 312a 6e62 3120  >data + i01*nb1 
-0004b190: 2b20 6930 322a 6e62 3220 2b20 6930 332a  + i02*nb2 + i03*
-0004b1a0: 6e62 3329 3b0a 0a20 2020 2020 2020 2020  nb3);..         
-0004b1b0: 2020 2020 2020 2067 676d 6c5f 666c 6f61         ggml_floa
-0004b1c0: 7420 7375 6d32 203d 2030 2e30 3b0a 2020  t sum2 = 0.0;.  
-0004b1d0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0004b1e0: 7220 2869 6e74 3634 5f74 2069 3030 203d  r (int64_t i00 =
-0004b1f0: 2030 3b20 6930 3020 3c20 6e65 3030 3b20   0; i00 < ne00; 
-0004b200: 6930 302b 2b29 207b 0a20 2020 2020 2020  i00++) {.       
-0004b210: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-0004b220: 6174 2076 203d 2078 5b69 3030 5d20 2d20  at v = x[i00] - 
-0004b230: 6d65 616e 3b0a 2020 2020 2020 2020 2020  mean;.          
-0004b240: 2020 2020 2020 2020 2020 795b 6930 305d            y[i00]
-0004b250: 203d 2076 3b0a 2020 2020 2020 2020 2020   = v;.          
-0004b260: 2020 2020 2020 2020 2020 7375 6d32 202b            sum2 +
-0004b270: 3d20 2867 676d 6c5f 666c 6f61 7429 2876  = (ggml_float)(v
-0004b280: 2a76 293b 0a20 2020 2020 2020 2020 2020  *v);.           
-0004b290: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0004b2a0: 2020 2020 2020 2020 666c 6f61 7420 7661          float va
-0004b2b0: 7269 616e 6365 203d 2073 756d 322f 6e65  riance = sum2/ne
-0004b2c0: 3030 3b0a 2020 2020 2020 2020 2020 2020  00;.            
-0004b2d0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0004b2e0: 7363 616c 6520 3d20 312e 3066 2f73 7172  scale = 1.0f/sqr
-0004b2f0: 7466 2876 6172 6961 6e63 6520 2b20 6570  tf(variance + ep
-0004b300: 7329 3b0a 0a20 2020 2020 2020 2020 2020  s);..           
-0004b310: 2020 2020 2067 676d 6c5f 7665 635f 7363       ggml_vec_sc
-0004b320: 616c 655f 6633 3228 6e65 3030 2c20 792c  ale_f32(ne00, y,
-0004b330: 2073 6361 6c65 293b 0a20 2020 2020 2020   scale);.       
-0004b340: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-0004b350: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-0004b360: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-0004b370: 7465 5f66 6f72 7761 7264 5f6e 6f72 6d28  te_forward_norm(
-0004b380: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0004b390: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0004b3a0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-0004b3b0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-0004b3c0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0004b3d0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-0004b3e0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0004b3f0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-0004b400: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-0004b410: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-0004b420: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0004b430: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-0004b440: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0004b450: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-0004b460: 655f 666f 7277 6172 645f 6e6f 726d 5f66  e_forward_norm_f
-0004b470: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-0004b480: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-0004b490: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0004b4a0: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-0004b4b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0004b4c0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0004b4d0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-0004b4e0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0004b4f0: 616b 3b0a 2020 2020 7d0a 7d0a 0a73 7461  ak;.    }.}..sta
-0004b500: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-0004b510: 6d70 7574 655f 666f 7277 6172 645f 726d  mpute_forward_rm
-0004b520: 735f 6e6f 726d 5f66 3332 280a 2020 2020  s_norm_f32(.    
-0004b530: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0004b540: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-0004b550: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-0004b560: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0004b570: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0004b580: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-0004b590: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0004b5a0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-0004b5b0: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-0004b5c0: 5f61 7265 5f73 616d 655f 7368 6170 6528  _are_same_shape(
-0004b5d0: 7372 6330 2c20 6473 7429 293b 0a0a 2020  src0, dst));..  
-0004b5e0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-0004b5f0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-0004b600: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
-0004b610: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-0004b620: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-0004b630: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-0004b640: 2020 7d0a 0a20 2020 2047 474d 4c5f 4153    }..    GGML_AS
-0004b650: 5345 5254 2873 7263 302d 3e6e 625b 305d  SERT(src0->nb[0]
-0004b660: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-0004b670: 2929 3b0a 0a20 2020 2063 6f6e 7374 2069  ));..    const i
-0004b680: 6e74 2069 7468 203d 2070 6172 616d 732d  nt ith = params-
-0004b690: 3e69 7468 3b0a 2020 2020 636f 6e73 7420  >ith;.    const 
-0004b6a0: 696e 7420 6e74 6820 3d20 7061 7261 6d73  int nth = params
-0004b6b0: 2d3e 6e74 683b 0a0a 2020 2020 636f 6e73  ->nth;..    cons
-0004b6c0: 7420 696e 7436 345f 7420 6e65 3030 203d  t int64_t ne00 =
-0004b6d0: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
-0004b6e0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0004b6f0: 6e65 3031 203d 2073 7263 302d 3e6e 655b  ne01 = src0->ne[
-0004b700: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-0004b710: 7436 345f 7420 6e65 3032 203d 2073 7263  t64_t ne02 = src
-0004b720: 302d 3e6e 655b 325d 3b0a 2020 2020 636f  0->ne[2];.    co
-0004b730: 6e73 7420 696e 7436 345f 7420 6e65 3033  nst int64_t ne03
-0004b740: 203d 2073 7263 302d 3e6e 655b 335d 3b0a   = src0->ne[3];.
-0004b750: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-0004b760: 7420 6e62 3031 203d 2073 7263 302d 3e6e  t nb01 = src0->n
-0004b770: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
-0004b780: 7369 7a65 5f74 206e 6230 3220 3d20 7372  size_t nb02 = sr
-0004b790: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 2063  c0->nb[2];.    c
-0004b7a0: 6f6e 7374 2073 697a 655f 7420 6e62 3033  onst size_t nb03
-0004b7b0: 203d 2073 7263 302d 3e6e 625b 335d 3b0a   = src0->nb[3];.
-0004b7c0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-0004b7d0: 7420 6e62 3120 3d20 6473 742d 3e6e 625b  t nb1 = dst->nb[
-0004b7e0: 315d 3b0a 2020 2020 636f 6e73 7420 7369  1];.    const si
-0004b7f0: 7a65 5f74 206e 6232 203d 2064 7374 2d3e  ze_t nb2 = dst->
-0004b800: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
-0004b810: 2073 697a 655f 7420 6e62 3320 3d20 6473   size_t nb3 = ds
-0004b820: 742d 3e6e 625b 335d 3b0a 0a20 2020 2063  t->nb[3];..    c
-0004b830: 6f6e 7374 2066 6c6f 6174 2065 7073 203d  onst float eps =
-0004b840: 2031 652d 3666 3b20 2f2f 2054 4f44 4f3a   1e-6f; // TODO:
-0004b850: 206d 616b 6520 7468 6973 2061 2070 6172   make this a par
-0004b860: 616d 6574 6572 0a0a 2020 2020 2f2f 2054  ameter..    // T
-0004b870: 4f44 4f3a 206f 7074 696d 697a 650a 2020  ODO: optimize.  
-0004b880: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-0004b890: 3033 203d 2030 3b20 6930 3320 3c20 6e65  03 = 0; i03 < ne
-0004b8a0: 3033 3b20 6930 332b 2b29 207b 0a20 2020  03; i03++) {.   
-0004b8b0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-0004b8c0: 7420 6930 3220 3d20 303b 2069 3032 203c  t i02 = 0; i02 <
-0004b8d0: 206e 6530 323b 2069 3032 2b2b 2920 7b0a   ne02; i02++) {.
-0004b8e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0004b8f0: 2869 6e74 3634 5f74 2069 3031 203d 2069  (int64_t i01 = i
-0004b900: 7468 3b20 6930 3120 3c20 6e65 3031 3b20  th; i01 < ne01; 
-0004b910: 6930 3120 2b3d 206e 7468 2920 7b0a 2020  i01 += nth) {.  
-0004b920: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0004b930: 6e73 7420 666c 6f61 7420 2a20 7820 3d20  nst float * x = 
-0004b940: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-0004b950: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-0004b960: 2069 3031 2a6e 6230 3120 2b20 6930 322a   i01*nb01 + i02*
-0004b970: 6e62 3032 202b 2069 3033 2a6e 6230 3329  nb02 + i03*nb03)
-0004b980: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0004b990: 2020 2067 676d 6c5f 666c 6f61 7420 7375     ggml_float su
-0004b9a0: 6d20 3d20 302e 303b 0a20 2020 2020 2020  m = 0.0;.       
-0004b9b0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0004b9c0: 7436 345f 7420 6930 3020 3d20 303b 2069  t64_t i00 = 0; i
-0004b9d0: 3030 203c 206e 6530 303b 2069 3030 2b2b  00 < ne00; i00++
-0004b9e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0004b9f0: 2020 2020 2020 2020 7375 6d20 2b3d 2028          sum += (
-0004ba00: 6767 6d6c 5f66 6c6f 6174 2928 785b 6930  ggml_float)(x[i0
-0004ba10: 305d 202a 2078 5b69 3030 5d29 3b0a 2020  0] * x[i00]);.  
-0004ba20: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0004ba30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ba40: 2063 6f6e 7374 2066 6c6f 6174 206d 6561   const float mea
-0004ba50: 6e20 3d20 7375 6d2f 6e65 3030 3b0a 0a20  n = sum/ne00;.. 
-0004ba60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0004ba70: 6c6f 6174 202a 2079 203d 2028 666c 6f61  loat * y = (floa
-0004ba80: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
-0004ba90: 7374 2d3e 6461 7461 202b 2069 3031 2a6e  st->data + i01*n
-0004baa0: 6231 202b 2069 3032 2a6e 6232 202b 2069  b1 + i02*nb2 + i
-0004bab0: 3033 2a6e 6233 293b 0a0a 2020 2020 2020  03*nb3);..      
-0004bac0: 2020 2020 2020 2020 2020 6d65 6d63 7079            memcpy
-0004bad0: 2879 2c20 782c 206e 6530 3020 2a20 7369  (y, x, ne00 * si
-0004bae0: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
-0004baf0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0004bb00: 2066 6f72 2028 696e 7420 6930 3020 3d20   for (int i00 = 
-0004bb10: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
-0004bb20: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
-0004bb30: 2020 2020 2020 2020 2f2f 2020 2020 2079          //     y
-0004bb40: 5b69 3030 5d20 3d20 785b 6930 305d 3b0a  [i00] = x[i00];.
-0004bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bb60: 2f2f 207d 0a0a 2020 2020 2020 2020 2020  // }..          
-0004bb70: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-0004bb80: 7420 7363 616c 6520 3d20 312e 3066 2f73  t scale = 1.0f/s
-0004bb90: 7172 7466 286d 6561 6e20 2b20 6570 7329  qrtf(mean + eps)
-0004bba0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0004bbb0: 2020 2067 676d 6c5f 7665 635f 7363 616c     ggml_vec_scal
-0004bbc0: 655f 6633 3228 6e65 3030 2c20 792c 2073  e_f32(ne00, y, s
-0004bbd0: 6361 6c65 293b 0a20 2020 2020 2020 2020  cale);.         
-0004bbe0: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-0004bbf0: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
-0004bc00: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-0004bc10: 5f66 6f72 7761 7264 5f72 6d73 5f6e 6f72  _forward_rms_nor
-0004bc20: 6d28 0a20 2020 2020 2020 2063 6f6e 7374  m(.        const
-0004bc30: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-0004bc40: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-0004bc50: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-0004bc60: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0004bc70: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-0004bc80: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0004bc90: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0004bca0: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
-0004bcb0: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
-0004bcc0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0004bcd0: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-0004bce0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0004bcf0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-0004bd00: 7574 655f 666f 7277 6172 645f 726d 735f  ute_forward_rms_
-0004bd10: 6e6f 726d 5f66 3332 2870 6172 616d 732c  norm_f32(params,
-0004bd20: 2073 7263 302c 2064 7374 293b 0a20 2020   src0, dst);.   
-0004bd30: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0004bd40: 3b0a 2020 2020 2020 2020 6465 6661 756c  ;.        defaul
-0004bd50: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
-0004bd60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004bd70: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-0004bd80: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-0004bd90: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-0004bda0: 7d0a 0a0a 7374 6174 6963 2076 6f69 6420  }...static void 
-0004bdb0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-0004bdc0: 7761 7264 5f72 6d73 5f6e 6f72 6d5f 6261  ward_rms_norm_ba
-0004bdd0: 636b 5f66 3332 280a 2020 2020 2020 2020  ck_f32(.        
-0004bde0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0004bdf0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-0004be00: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-0004be10: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0004be20: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-0004be30: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-0004be40: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0004be50: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-0004be60: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0004be70: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-0004be80: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0004be90: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
-0004bea0: 6861 7065 2873 7263 302c 2064 7374 2920  hape(src0, dst) 
-0004beb0: 2626 2067 676d 6c5f 6172 655f 7361 6d65  && ggml_are_same
-0004bec0: 5f73 6861 7065 2873 7263 302c 2073 7263  _shape(src0, src
-0004bed0: 3129 293b 0a0a 2020 2020 6966 2028 7061  1));..    if (pa
-0004bee0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-0004bef0: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-0004bf00: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-0004bf10: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-0004bf20: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-0004bf30: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-0004bf40: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
-0004bf50: 302d 3e6e 625b 305d 203d 3d20 7369 7a65  0->nb[0] == size
-0004bf60: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-0004bf70: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
-0004bf80: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
-0004bf90: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
-0004bfa0: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
-0004bfb0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0004bfc0: 7420 6e65 3030 203d 2073 7263 302d 3e6e  t ne00 = src0->n
-0004bfd0: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-0004bfe0: 696e 7436 345f 7420 6e65 3031 203d 2073  int64_t ne01 = s
-0004bff0: 7263 302d 3e6e 655b 315d 3b0a 2020 2020  rc0->ne[1];.    
-0004c000: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0004c010: 3032 203d 2073 7263 302d 3e6e 655b 325d  02 = src0->ne[2]
-0004c020: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-0004c030: 345f 7420 6e65 3033 203d 2073 7263 302d  4_t ne03 = src0-
-0004c040: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
-0004c050: 7374 2073 697a 655f 7420 6e62 3031 203d  st size_t nb01 =
-0004c060: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
-0004c070: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0004c080: 6230 3220 3d20 7372 6330 2d3e 6e62 5b32  b02 = src0->nb[2
-0004c090: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-0004c0a0: 655f 7420 6e62 3033 203d 2073 7263 302d  e_t nb03 = src0-
-0004c0b0: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-0004c0c0: 7374 2073 697a 655f 7420 6e62 3131 203d  st size_t nb11 =
-0004c0d0: 2073 7263 312d 3e6e 625b 315d 3b0a 2020   src1->nb[1];.  
-0004c0e0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0004c0f0: 6231 3220 3d20 7372 6331 2d3e 6e62 5b32  b12 = src1->nb[2
-0004c100: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-0004c110: 655f 7420 6e62 3133 203d 2073 7263 312d  e_t nb13 = src1-
-0004c120: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-0004c130: 7374 2073 697a 655f 7420 6e62 3120 3d20  st size_t nb1 = 
-0004c140: 6473 742d 3e6e 625b 315d 3b0a 2020 2020  dst->nb[1];.    
-0004c150: 636f 6e73 7420 7369 7a65 5f74 206e 6232  const size_t nb2
-0004c160: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
-0004c170: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0004c180: 6e62 3320 3d20 6473 742d 3e6e 625b 335d  nb3 = dst->nb[3]
-0004c190: 3b0a 0a20 2020 2063 6f6e 7374 2066 6c6f  ;..    const flo
-0004c1a0: 6174 2065 7073 203d 2031 652d 3666 3b20  at eps = 1e-6f; 
-0004c1b0: 2f2f 2054 4f44 4f3a 206d 616b 6520 7468  // TODO: make th
-0004c1c0: 6973 2061 2070 6172 616d 6574 6572 0a0a  is a parameter..
-0004c1d0: 2020 2020 2f2f 2054 4f44 4f3a 206f 7074      // TODO: opt
-0004c1e0: 696d 697a 650a 2020 2020 666f 7220 2869  imize.    for (i
-0004c1f0: 6e74 3634 5f74 2069 3033 203d 2030 3b20  nt64_t i03 = 0; 
-0004c200: 6930 3320 3c20 6e65 3033 3b20 6930 332b  i03 < ne03; i03+
-0004c210: 2b29 207b 0a20 2020 2020 2020 2066 6f72  +) {.        for
-0004c220: 2028 696e 7436 345f 7420 6930 3220 3d20   (int64_t i02 = 
-0004c230: 303b 2069 3032 203c 206e 6530 323b 2069  0; i02 < ne02; i
-0004c240: 3032 2b2b 2920 7b0a 2020 2020 2020 2020  02++) {.        
-0004c250: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0004c260: 2069 3031 203d 2069 7468 3b20 6930 3120   i01 = ith; i01 
-0004c270: 3c20 6e65 3031 3b20 6930 3120 2b3d 206e  < ne01; i01 += n
-0004c280: 7468 2920 7b0a 2020 2020 2020 2020 2020  th) {.          
-0004c290: 2020 2020 2020 2f2f 2073 7263 3120 6973        // src1 is
-0004c2a0: 2073 616d 6520 7368 6170 6520 6173 2073   same shape as s
-0004c2b0: 7263 3020 3d3e 2073 616d 6520 696e 6469  rc0 => same indi
-0004c2c0: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
-0004c2d0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0004c2e0: 7420 6931 3120 3d20 6930 313b 0a20 2020  t i11 = i01;.   
-0004c2f0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0004c300: 7374 2069 6e74 3634 5f74 2069 3132 203d  st int64_t i12 =
-0004c310: 2069 3032 3b0a 2020 2020 2020 2020 2020   i02;.          
-0004c320: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
-0004c330: 345f 7420 6931 3320 3d20 6930 333b 0a0a  4_t i13 = i03;..
-0004c340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c350: 636f 6e73 7420 666c 6f61 7420 2a20 7820  const float * x 
-0004c360: 3d20 2866 6c6f 6174 202a 2920 2828 6368  = (float *) ((ch
-0004c370: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-0004c380: 202b 2069 3031 2a6e 6230 3120 2b20 6930   + i01*nb01 + i0
-0004c390: 322a 6e62 3032 202b 2069 3033 2a6e 6230  2*nb02 + i03*nb0
-0004c3a0: 3329 3b0a 2020 2020 2020 2020 2020 2020  3);.            
-0004c3b0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0004c3c0: 2a20 647a 203d 2028 666c 6f61 7420 2a29  * dz = (float *)
-0004c3d0: 2028 2863 6861 7220 2a29 2073 7263 312d   ((char *) src1-
-0004c3e0: 3e64 6174 6120 2b20 6931 312a 6e62 3131  >data + i11*nb11
-0004c3f0: 202b 2069 3132 2a6e 6231 3220 2b20 6931   + i12*nb12 + i1
-0004c400: 332a 6e62 3133 293b 0a0a 2020 2020 2020  3*nb13);..      
-0004c410: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
-0004c420: 6c6f 6174 2073 756d 5f78 7820 203d 2030  loat sum_xx  = 0
-0004c430: 2e30 3b0a 2020 2020 2020 2020 2020 2020  .0;.            
-0004c440: 2020 2020 6767 6d6c 5f66 6c6f 6174 2073      ggml_float s
-0004c450: 756d 5f78 647a 203d 2030 2e30 3b0a 0a20  um_xdz = 0.0;.. 
-0004c460: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0004c470: 6f72 2028 696e 7436 345f 7420 6930 3020  or (int64_t i00 
-0004c480: 3d20 303b 2069 3030 203c 206e 6530 303b  = 0; i00 < ne00;
-0004c490: 2069 3030 2b2b 2920 7b0a 2020 2020 2020   i00++) {.      
-0004c4a0: 2020 2020 2020 2020 2020 2020 2020 7375                su
-0004c4b0: 6d5f 7878 2020 2b3d 2028 6767 6d6c 5f66  m_xx  += (ggml_f
-0004c4c0: 6c6f 6174 2928 785b 6930 305d 202a 2078  loat)(x[i00] * x
+00047da0: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+00047db0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00047dc0: 2920 2064 7374 2d3e 6461 7461 202b 2028  )  dst->data + (
+00047dd0: 2020 2020 2020 2020 206b 3329 2a6e 6233           k3)*nb3
+00047de0: 2020 2b20 2820 2020 2020 2020 2020 6b32    + (         k2
+00047df0: 292a 6e62 3220 202b 2028 2020 2020 2020  )*nb2  + (      
+00047e00: 2020 206b 3129 2a6e 6231 292c 0a20 2020     k1)*nb1),.   
+00047e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047e30: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00047e40: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
+00047e50: 6174 6120 2b20 2869 332a 6e65 3320 2b20  ata + (i3*ne3 + 
+00047e60: 6b33 292a 6e62 3033 202b 2028 6932 2a6e  k3)*nb03 + (i2*n
+00047e70: 6532 202b 206b 3229 2a6e 6230 3220 2b20  e2 + k2)*nb02 + 
+00047e80: 2869 312a 6e65 3120 2b20 6b31 292a 6e62  (i1*ne1 + k1)*nb
+00047e90: 3031 202b 2028 6930 2a6e 6530 292a 6e62  01 + (i0*ne0)*nb
+00047ea0: 3030 2929 3b0a 2020 2020 2020 2020 2020  00));.          
+00047eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ec0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00047ed0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00047ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ef0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00047f00: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00047f10: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
+00047f20: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+00047f30: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+00047f40: 666f 7277 6172 645f 7265 7065 6174 5f62  forward_repeat_b
+00047f50: 6163 6b28 0a20 2020 2020 2020 2063 6f6e  ack(.        con
+00047f60: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00047f70: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00047f80: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00047f90: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00047fa0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00047fb0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00047fc0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00047fd0: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+00047fe0: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+00047ff0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00048000: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
+00048010: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00048020: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00048030: 6d70 7574 655f 666f 7277 6172 645f 7265  mpute_forward_re
+00048040: 7065 6174 5f62 6163 6b5f 6633 3228 7061  peat_back_f32(pa
+00048050: 7261 6d73 2c20 7372 6330 2c20 6473 7429  rams, src0, dst)
+00048060: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00048070: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
+00048080: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
+00048090: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000480a0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+000480b0: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+000480c0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+000480d0: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
+000480e0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000480f0: 6162 730a 0a73 7461 7469 6320 766f 6964  abs..static void
+00048100: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00048110: 7277 6172 645f 6162 735f 6633 3228 0a20  rward_abs_f32(. 
+00048120: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00048130: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00048140: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00048150: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00048160: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00048170: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00048180: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00048190: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+000481a0: 2020 2061 7373 6572 7428 7061 7261 6d73     assert(params
+000481b0: 2d3e 6974 6820 3d3d 2030 293b 0a20 2020  ->ith == 0);.   
+000481c0: 2061 7373 6572 7428 6767 6d6c 5f61 7265   assert(ggml_are
+000481d0: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
+000481e0: 2c20 6473 7429 293b 0a0a 2020 2020 6966  , dst));..    if
+000481f0: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00048200: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00048210: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+00048220: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00048230: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00048240: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00048250: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00048260: 2020 3d20 6767 6d6c 5f6e 726f 7773 2873    = ggml_nrows(s
+00048270: 7263 3029 3b0a 2020 2020 636f 6e73 7420  rc0);.    const 
+00048280: 696e 7420 6e63 203d 2073 7263 302d 3e6e  int nc = src0->n
+00048290: 655b 305d 3b0a 0a20 2020 2061 7373 6572  e[0];..    asser
+000482a0: 7428 6473 742d 3e6e 625b 305d 2020 3d3d  t(dst->nb[0]  ==
+000482b0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+000482c0: 0a20 2020 2061 7373 6572 7428 7372 6330  .    assert(src0
+000482d0: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+000482e0: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+000482f0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+00048300: 6920 3c20 6e3b 2069 2b2b 2920 7b0a 2020  i < n; i++) {.  
+00048310: 2020 2020 2020 6767 6d6c 5f76 6563 5f61        ggml_vec_a
+00048320: 6273 5f66 3332 286e 632c 0a20 2020 2020  bs_f32(nc,.     
+00048330: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00048340: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
+00048350: 7374 2d3e 6461 7461 2020 2b20 692a 2820  st->data  + i*( 
+00048360: 6473 742d 3e6e 625b 315d 2929 2c0a 2020  dst->nb[1])),.  
+00048370: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+00048380: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00048390: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
+000483a0: 2a28 7372 6330 2d3e 6e62 5b31 5d29 2929  *(src0->nb[1])))
+000483b0: 3b0a 2020 2020 7d0a 7d0a 0a73 7461 7469  ;.    }.}..stati
+000483c0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+000483d0: 7574 655f 666f 7277 6172 645f 6162 7328  ute_forward_abs(
+000483e0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000483f0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00048400: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00048410: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00048420: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00048430: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00048440: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00048450: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+00048460: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
+00048470: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+00048480: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00048490: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
+000484a0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000484b0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+000484c0: 655f 666f 7277 6172 645f 6162 735f 6633  e_forward_abs_f3
+000484d0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+000484e0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+000484f0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00048500: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00048510: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00048520: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00048530: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00048540: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00048550: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+00048560: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00048570: 6172 645f 7367 6e0a 0a73 7461 7469 6320  ard_sgn..static 
+00048580: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+00048590: 655f 666f 7277 6172 645f 7367 6e5f 6633  e_forward_sgn_f3
+000485a0: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
+000485b0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+000485c0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+000485d0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+000485e0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000485f0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00048600: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00048610: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00048620: 207b 0a20 2020 2061 7373 6572 7428 7061   {.    assert(pa
+00048630: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
+00048640: 0a20 2020 2061 7373 6572 7428 6767 6d6c  .    assert(ggml
+00048650: 5f61 7265 5f73 616d 655f 7368 6170 6528  _are_same_shape(
+00048660: 7372 6330 2c20 6473 7429 293b 0a0a 2020  src0, dst));..  
+00048670: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+00048680: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00048690: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
+000486a0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+000486b0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+000486c0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+000486d0: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
+000486e0: 6e74 206e 2020 3d20 6767 6d6c 5f6e 726f  nt n  = ggml_nro
+000486f0: 7773 2873 7263 3029 3b0a 2020 2020 636f  ws(src0);.    co
+00048700: 6e73 7420 696e 7420 6e63 203d 2073 7263  nst int nc = src
+00048710: 302d 3e6e 655b 305d 3b0a 0a20 2020 2061  0->ne[0];..    a
+00048720: 7373 6572 7428 6473 742d 3e6e 625b 305d  ssert(dst->nb[0]
+00048730: 2020 3d3d 2073 697a 656f 6628 666c 6f61    == sizeof(floa
+00048740: 7429 293b 0a20 2020 2061 7373 6572 7428  t));.    assert(
+00048750: 7372 6330 2d3e 6e62 5b30 5d20 3d3d 2073  src0->nb[0] == s
+00048760: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
+00048770: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00048780: 2030 3b20 6920 3c20 6e3b 2069 2b2b 2920   0; i < n; i++) 
+00048790: 7b0a 2020 2020 2020 2020 6767 6d6c 5f76  {.        ggml_v
+000487a0: 6563 5f73 676e 5f66 3332 286e 632c 0a20  ec_sgn_f32(nc,. 
+000487b0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+000487c0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+000487d0: 2a29 2064 7374 2d3e 6461 7461 2020 2b20  *) dst->data  + 
+000487e0: 692a 2820 6473 742d 3e6e 625b 315d 2929  i*( dst->nb[1]))
+000487f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00048800: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+00048810: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+00048820: 202b 2069 2a28 7372 6330 2d3e 6e62 5b31   + i*(src0->nb[1
+00048830: 5d29 2929 3b0a 2020 2020 7d0a 7d0a 0a73  ])));.    }.}..s
+00048840: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00048850: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00048860: 7367 6e28 0a20 2020 2020 2020 2063 6f6e  sgn(.        con
+00048870: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00048880: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00048890: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+000488a0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000488b0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+000488c0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000488d0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+000488e0: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+000488f0: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+00048900: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00048910: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
+00048920: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00048930: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00048940: 6d70 7574 655f 666f 7277 6172 645f 7367  mpute_forward_sg
+00048950: 6e5f 6633 3228 7061 7261 6d73 2c20 7372  n_f32(params, sr
+00048960: 6330 2c20 6473 7429 3b0a 2020 2020 2020  c0, dst);.      
+00048970: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00048980: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
+00048990: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000489a0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+000489b0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+000489c0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+000489d0: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
+000489e0: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
+000489f0: 666f 7277 6172 645f 6e65 670a 0a73 7461  forward_neg..sta
+00048a00: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00048a10: 6d70 7574 655f 666f 7277 6172 645f 6e65  mpute_forward_ne
+00048a20: 675f 6633 3228 0a20 2020 2020 2020 2063  g_f32(.        c
+00048a30: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00048a40: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+00048a50: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+00048a60: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00048a70: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00048a80: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
+00048a90: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00048aa0: 6473 7429 207b 0a20 2020 2061 7373 6572  dst) {.    asser
+00048ab0: 7428 7061 7261 6d73 2d3e 6974 6820 3d3d  t(params->ith ==
+00048ac0: 2030 293b 0a20 2020 2061 7373 6572 7428   0);.    assert(
+00048ad0: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
+00048ae0: 6170 6528 7372 6330 2c20 6473 7429 293b  ape(src0, dst));
+00048af0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+00048b00: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00048b10: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
+00048b20: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+00048b30: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+00048b40: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+00048b50: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
+00048b60: 7374 2069 6e74 206e 2020 3d20 6767 6d6c  st int n  = ggml
+00048b70: 5f6e 726f 7773 2873 7263 3029 3b0a 2020  _nrows(src0);.  
+00048b80: 2020 636f 6e73 7420 696e 7420 6e63 203d    const int nc =
+00048b90: 2073 7263 302d 3e6e 655b 305d 3b0a 0a20   src0->ne[0];.. 
+00048ba0: 2020 2061 7373 6572 7428 6473 742d 3e6e     assert(dst->n
+00048bb0: 625b 305d 2020 3d3d 2073 697a 656f 6628  b[0]  == sizeof(
+00048bc0: 666c 6f61 7429 293b 0a20 2020 2061 7373  float));.    ass
+00048bd0: 6572 7428 7372 6330 2d3e 6e62 5b30 5d20  ert(src0->nb[0] 
+00048be0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00048bf0: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
+00048c00: 2069 203d 2030 3b20 6920 3c20 6e3b 2069   i = 0; i < n; i
+00048c10: 2b2b 2920 7b0a 2020 2020 2020 2020 6767  ++) {.        gg
+00048c20: 6d6c 5f76 6563 5f6e 6567 5f66 3332 286e  ml_vec_neg_f32(n
+00048c30: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+00048c40: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+00048c50: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
+00048c60: 2020 2b20 692a 2820 6473 742d 3e6e 625b    + i*( dst->nb[
+00048c70: 315d 2929 2c0a 2020 2020 2020 2020 2020  1])),.          
+00048c80: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+00048c90: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+00048ca0: 6461 7461 202b 2069 2a28 7372 6330 2d3e  data + i*(src0->
+00048cb0: 6e62 5b31 5d29 2929 3b0a 2020 2020 7d0a  nb[1])));.    }.
+00048cc0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+00048cd0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00048ce0: 6172 645f 6e65 6728 0a20 2020 2020 2020  ard_neg(.       
+00048cf0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00048d00: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00048d10: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00048d20: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00048d30: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00048d40: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
+00048d50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00048d60: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
+00048d70: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
+00048d80: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+00048d90: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
+00048da0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00048db0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00048dc0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00048dd0: 645f 6e65 675f 6633 3228 7061 7261 6d73  d_neg_f32(params
+00048de0: 2c20 7372 6330 2c20 6473 7429 3b0a 2020  , src0, dst);.  
+00048df0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00048e00: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
+00048e10: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+00048e20: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00048e30: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+00048e40: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+00048e50: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
+00048e60: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
+00048e70: 7574 655f 666f 7277 6172 645f 7374 6570  ute_forward_step
+00048e80: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00048e90: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00048ea0: 7264 5f73 7465 705f 6633 3228 0a20 2020  rd_step_f32(.   
+00048eb0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00048ec0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00048ed0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00048ee0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00048ef0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00048f00: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00048f10: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00048f20: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+00048f30: 2061 7373 6572 7428 7061 7261 6d73 2d3e   assert(params->
+00048f40: 6974 6820 3d3d 2030 293b 0a20 2020 2061  ith == 0);.    a
+00048f50: 7373 6572 7428 6767 6d6c 5f61 7265 5f73  ssert(ggml_are_s
+00048f60: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
+00048f70: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
+00048f80: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00048f90: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
+00048fa0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
+00048fb0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+00048fc0: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+00048fd0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+00048fe0: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
+00048ff0: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
+00049000: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+00049010: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
+00049020: 305d 3b0a 0a20 2020 2061 7373 6572 7428  0];..    assert(
+00049030: 6473 742d 3e6e 625b 305d 2020 3d3d 2073  dst->nb[0]  == s
+00049040: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+00049050: 2020 2061 7373 6572 7428 7372 6330 2d3e     assert(src0->
+00049060: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+00049070: 666c 6f61 7429 293b 0a0a 2020 2020 666f  float));..    fo
+00049080: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00049090: 3c20 6e3b 2069 2b2b 2920 7b0a 2020 2020  < n; i++) {.    
+000490a0: 2020 2020 6767 6d6c 5f76 6563 5f73 7465      ggml_vec_ste
+000490b0: 705f 6633 3228 6e63 2c0a 2020 2020 2020  p_f32(nc,.      
+000490c0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+000490d0: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
+000490e0: 742d 3e64 6174 6120 202b 2069 2a28 2064  t->data  + i*( d
+000490f0: 7374 2d3e 6e62 5b31 5d29 292c 0a20 2020  st->nb[1])),.   
+00049100: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+00049110: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+00049120: 2073 7263 302d 3e64 6174 6120 2b20 692a   src0->data + i*
+00049130: 2873 7263 302d 3e6e 625b 315d 2929 293b  (src0->nb[1])));
+00049140: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+00049150: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00049160: 7465 5f66 6f72 7761 7264 5f73 7465 7028  te_forward_step(
+00049170: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00049180: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00049190: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+000491a0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+000491b0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+000491c0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+000491d0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+000491e0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+000491f0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
+00049200: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+00049210: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00049220: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
+00049230: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00049240: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00049250: 655f 666f 7277 6172 645f 7374 6570 5f66  e_forward_step_f
+00049260: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
+00049270: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+00049280: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00049290: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
+000492a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000492b0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+000492c0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+000492d0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000492e0: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
+000492f0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00049300: 7761 7264 5f72 656c 750a 0a73 7461 7469  ward_relu..stati
+00049310: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+00049320: 7574 655f 666f 7277 6172 645f 7265 6c75  ute_forward_relu
+00049330: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
+00049340: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00049350: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+00049360: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+00049370: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00049380: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00049390: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+000493a0: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+000493b0: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
+000493c0: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
+000493d0: 3029 3b0a 2020 2020 6173 7365 7274 2867  0);.    assert(g
+000493e0: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
+000493f0: 7065 2873 7263 302c 2064 7374 2929 3b0a  pe(src0, dst));.
+00049400: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00049410: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00049420: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+00049430: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00049440: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+00049450: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+00049460: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
+00049470: 7420 696e 7420 6e20 203d 2067 676d 6c5f  t int n  = ggml_
+00049480: 6e72 6f77 7328 7372 6330 293b 0a20 2020  nrows(src0);.   
+00049490: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
+000494a0: 7372 6330 2d3e 6e65 5b30 5d3b 0a0a 2020  src0->ne[0];..  
+000494b0: 2020 6173 7365 7274 2864 7374 2d3e 6e62    assert(dst->nb
+000494c0: 5b30 5d20 203d 3d20 7369 7a65 6f66 2866  [0]  == sizeof(f
+000494d0: 6c6f 6174 2929 3b0a 2020 2020 6173 7365  loat));.    asse
+000494e0: 7274 2873 7263 302d 3e6e 625b 305d 203d  rt(src0->nb[0] =
+000494f0: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
+00049500: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+00049510: 6920 3d20 303b 2069 203c 206e 3b20 692b  i = 0; i < n; i+
+00049520: 2b29 207b 0a20 2020 2020 2020 2067 676d  +) {.        ggm
+00049530: 6c5f 7665 635f 7265 6c75 5f66 3332 286e  l_vec_relu_f32(n
+00049540: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+00049550: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+00049560: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
+00049570: 2020 2b20 692a 2820 6473 742d 3e6e 625b    + i*( dst->nb[
+00049580: 315d 2929 2c0a 2020 2020 2020 2020 2020  1])),.          
+00049590: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+000495a0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+000495b0: 6461 7461 202b 2069 2a28 7372 6330 2d3e  data + i*(src0->
+000495c0: 6e62 5b31 5d29 2929 3b0a 2020 2020 7d0a  nb[1])));.    }.
+000495d0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+000495e0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000495f0: 6172 645f 7265 6c75 280a 2020 2020 2020  ard_relu(.      
+00049600: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00049610: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00049620: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00049630: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00049640: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00049650: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
+00049660: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00049670: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
+00049680: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
+00049690: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+000496a0: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
+000496b0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000496c0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000496d0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000496e0: 7264 5f72 656c 755f 6633 3228 7061 7261  rd_relu_f32(para
+000496f0: 6d73 2c20 7372 6330 2c20 6473 7429 3b0a  ms, src0, dst);.
+00049700: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00049710: 6561 6b3b 0a20 2020 2020 2020 2064 6566  eak;.        def
+00049720: 6175 6c74 3a0a 2020 2020 2020 2020 2020  ault:.          
+00049730: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00049740: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00049750: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00049760: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00049770: 207d 0a7d 0a0a 2f2f 2067 676d 6c5f 636f   }.}..// ggml_co
+00049780: 6d70 7574 655f 666f 7277 6172 645f 6765  mpute_forward_ge
+00049790: 6c75 0a0a 7374 6174 6963 2076 6f69 6420  lu..static void 
+000497a0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000497b0: 7761 7264 5f67 656c 755f 6633 3228 0a20  ward_gelu_f32(. 
+000497c0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000497d0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+000497e0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+000497f0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00049800: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00049810: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00049820: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00049830: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00049840: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+00049850: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
+00049860: 7328 7372 6330 2929 3b0a 2020 2020 4747  s(src0));.    GG
+00049870: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+00049880: 735f 636f 6e74 6967 756f 7573 2864 7374  s_contiguous(dst
+00049890: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+000498a0: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
+000498b0: 655f 7368 6170 6528 7372 6330 2c20 6473  e_shape(src0, ds
+000498c0: 7429 293b 0a0a 2020 2020 6966 2028 7061  t));..    if (pa
+000498d0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+000498e0: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
+000498f0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00049900: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
+00049910: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
+00049920: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+00049930: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
+00049940: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
+00049950: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
+00049960: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
+00049970: 2020 2020 636f 6e73 7420 696e 7420 6e63      const int nc
+00049980: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
+00049990: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
+000499a0: 203d 2067 676d 6c5f 6e72 6f77 7328 7372   = ggml_nrows(sr
+000499b0: 6330 293b 0a0a 2020 2020 2f2f 2072 6f77  c0);..    // row
+000499c0: 7320 7065 7220 7468 7265 6164 0a20 2020  s per thread.   
+000499d0: 2063 6f6e 7374 2069 6e74 2064 7220 3d20   const int dr = 
+000499e0: 286e 7220 2b20 6e74 6820 2d20 3129 2f6e  (nr + nth - 1)/n
+000499f0: 7468 3b0a 0a20 2020 202f 2f20 726f 7720  th;..    // row 
+00049a00: 7261 6e67 6520 666f 7220 7468 6973 2074  range for this t
+00049a10: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
+00049a20: 696e 7420 6972 3020 3d20 6472 2a69 7468  int ir0 = dr*ith
+00049a30: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00049a40: 6972 3120 3d20 4d49 4e28 6972 3020 2b20  ir1 = MIN(ir0 + 
+00049a50: 6472 2c20 6e72 293b 0a0a 2020 2020 666f  dr, nr);..    fo
+00049a60: 7220 2869 6e74 2069 3120 3d20 6972 303b  r (int i1 = ir0;
+00049a70: 2069 3120 3c20 6972 313b 2069 312b 2b29   i1 < ir1; i1++)
+00049a80: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
+00049a90: 7665 635f 6765 6c75 5f66 3332 286e 632c  vec_gelu_f32(nc,
+00049aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00049ab0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+00049ac0: 7220 2a29 2064 7374 2d3e 6461 7461 2020  r *) dst->data  
+00049ad0: 2b20 6931 2a28 2064 7374 2d3e 6e62 5b31  + i1*( dst->nb[1
+00049ae0: 5d29 292c 0a20 2020 2020 2020 2020 2020  ])),.           
+00049af0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00049b00: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
+00049b10: 6174 6120 2b20 6931 2a28 7372 6330 2d3e  ata + i1*(src0->
+00049b20: 6e62 5b31 5d29 2929 3b0a 0a23 6966 6e64  nb[1])));..#ifnd
+00049b30: 6566 204e 4445 4255 470a 2020 2020 2020  ef NDEBUG.      
+00049b40: 2020 666f 7220 2869 6e74 206b 203d 2030    for (int k = 0
+00049b50: 3b20 6b20 3c20 6e63 3b20 6b2b 2b29 207b  ; k < nc; k++) {
+00049b60: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00049b70: 7374 2066 6c6f 6174 2078 203d 2028 2866  st float x = ((f
+00049b80: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00049b90: 2920 6473 742d 3e64 6174 6120 2b20 6931  ) dst->data + i1
+00049ba0: 2a28 2064 7374 2d3e 6e62 5b31 5d29 2929  *( dst->nb[1])))
+00049bb0: 5b6b 5d3b 0a20 2020 2020 2020 2020 2020  [k];.           
+00049bc0: 2055 4e55 5345 4428 7829 3b0a 2020 2020   UNUSED(x);.    
+00049bd0: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
+00049be0: 6973 6e61 6e28 7829 293b 0a20 2020 2020  isnan(x));.     
+00049bf0: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
+00049c00: 7369 6e66 2878 2929 3b0a 2020 2020 2020  sinf(x));.      
+00049c10: 2020 7d0a 2365 6e64 6966 0a20 2020 207d    }.#endif.    }
+00049c20: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+00049c30: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00049c40: 7761 7264 5f67 656c 7528 0a20 2020 2020  ward_gelu(.     
+00049c50: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00049c60: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00049c70: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00049c80: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00049c90: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00049ca0: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
+00049cb0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00049cc0: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+00049cd0: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+00049ce0: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+00049cf0: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+00049d00: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00049d10: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00049d20: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00049d30: 6172 645f 6765 6c75 5f66 3332 2870 6172  ard_gelu_f32(par
+00049d40: 616d 732c 2073 7263 302c 2064 7374 293b  ams, src0, dst);
+00049d50: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00049d60: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
+00049d70: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
+00049d80: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00049d90: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00049da0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+00049db0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00049dc0: 2020 7d0a 0a20 2020 202f 2f70 7269 6e74    }..    //print
+00049dd0: 6628 2258 5858 5858 5858 5820 6765 6c75  f("XXXXXXXX gelu
+00049de0: 5c6e 2229 3b0a 7d0a 0a2f 2f20 6767 6d6c  \n");.}..// ggml
+00049df0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00049e00: 5f73 696c 750a 0a73 7461 7469 6320 766f  _silu..static vo
+00049e10: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+00049e20: 666f 7277 6172 645f 7369 6c75 5f66 3332  forward_silu_f32
+00049e30: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00049e40: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00049e50: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00049e60: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00049e70: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00049e80: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00049e90: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00049ea0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00049eb0: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
+00049ec0: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
+00049ed0: 756f 7573 2873 7263 3029 293b 0a20 2020  uous(src0));.   
+00049ee0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00049ef0: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
+00049f00: 6473 7429 293b 0a20 2020 2047 474d 4c5f  dst));.    GGML_
+00049f10: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
+00049f20: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
+00049f30: 2064 7374 2929 3b0a 0a20 2020 2069 6620   dst));..    if 
+00049f40: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00049f50: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
+00049f60: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
+00049f70: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00049f80: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+00049f90: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00049fa0: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+00049fb0: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+00049fc0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00049fd0: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+00049fe0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00049ff0: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
+0004a000: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0004a010: 206e 7220 3d20 6767 6d6c 5f6e 726f 7773   nr = ggml_nrows
+0004a020: 2873 7263 3029 3b0a 0a20 2020 202f 2f20  (src0);..    // 
+0004a030: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
+0004a040: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
+0004a050: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
+0004a060: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
+0004a070: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
+0004a080: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
+0004a090: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
+0004a0a0: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0004a0b0: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
+0004a0c0: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
+0004a0d0: 2066 6f72 2028 696e 7420 6931 203d 2069   for (int i1 = i
+0004a0e0: 7230 3b20 6931 203c 2069 7231 3b20 6931  r0; i1 < ir1; i1
+0004a0f0: 2b2b 2920 7b0a 2020 2020 2020 2020 6767  ++) {.        gg
+0004a100: 6d6c 5f76 6563 5f73 696c 755f 6633 3228  ml_vec_silu_f32(
+0004a110: 6e63 2c0a 2020 2020 2020 2020 2020 2020  nc,.            
+0004a120: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+0004a130: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+0004a140: 6120 202b 2069 312a 2820 6473 742d 3e6e  a  + i1*( dst->n
+0004a150: 625b 315d 2929 2c0a 2020 2020 2020 2020  b[1])),.        
+0004a160: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+0004a170: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+0004a180: 2d3e 6461 7461 202b 2069 312a 2873 7263  ->data + i1*(src
+0004a190: 302d 3e6e 625b 315d 2929 293b 0a0a 2369  0->nb[1])));..#i
+0004a1a0: 666e 6465 6620 4e44 4542 5547 0a20 2020  fndef NDEBUG.   
+0004a1b0: 2020 2020 2066 6f72 2028 696e 7420 6b20       for (int k 
+0004a1c0: 3d20 303b 206b 203c 206e 633b 206b 2b2b  = 0; k < nc; k++
+0004a1d0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0004a1e0: 636f 6e73 7420 666c 6f61 7420 7820 3d20  const float x = 
+0004a1f0: 2828 666c 6f61 7420 2a29 2028 2863 6861  ((float *) ((cha
+0004a200: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
+0004a210: 2069 312a 2820 6473 742d 3e6e 625b 315d   i1*( dst->nb[1]
+0004a220: 2929 295b 6b5d 3b0a 2020 2020 2020 2020  )))[k];.        
+0004a230: 2020 2020 554e 5553 4544 2878 293b 0a20      UNUSED(x);. 
+0004a240: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0004a250: 7428 2169 736e 616e 2878 2929 3b0a 2020  t(!isnan(x));.  
+0004a260: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0004a270: 2821 6973 696e 6628 7829 293b 0a20 2020  (!isinf(x));.   
+0004a280: 2020 2020 207d 0a23 656e 6469 660a 2020       }.#endif.  
+0004a290: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+0004a2a0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+0004a2b0: 666f 7277 6172 645f 7369 6c75 280a 2020  forward_silu(.  
+0004a2c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0004a2d0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+0004a2e0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+0004a2f0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0004a300: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0004a310: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+0004a320: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0004a330: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+0004a340: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
+0004a350: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+0004a360: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+0004a370: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
+0004a380: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0004a390: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0004a3a0: 6f72 7761 7264 5f73 696c 755f 6633 3228  orward_silu_f32(
+0004a3b0: 7061 7261 6d73 2c20 7372 6330 2c20 6473  params, src0, ds
+0004a3c0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+0004a3d0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0004a3e0: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
+0004a3f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0004a400: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0004a410: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+0004a420: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0004a430: 0a20 2020 207d 0a7d 0a0a 0a2f 2f20 6767  .    }.}...// gg
+0004a440: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0004a450: 7264 5f73 696c 755f 6261 636b 0a0a 7374  rd_silu_back..st
+0004a460: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+0004a470: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+0004a480: 696c 755f 6261 636b 5f66 3332 280a 2020  ilu_back_f32(.  
+0004a490: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0004a4a0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+0004a4b0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+0004a4c0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0004a4d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0004a4e0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+0004a4f0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0004a500: 676d 6c5f 7465 6e73 6f72 202a 2067 7261  gml_tensor * gra
+0004a510: 642c 0a20 2020 2020 2020 2073 7472 7563  d,.        struc
+0004a520: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0004a530: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
+0004a540: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
+0004a550: 6f6e 7469 6775 6f75 7328 6772 6164 2929  ontiguous(grad))
+0004a560: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0004a570: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
+0004a580: 756f 7573 2873 7263 3029 293b 0a20 2020  uous(src0));.   
+0004a590: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+0004a5a0: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
+0004a5b0: 6473 7429 293b 0a20 2020 2047 474d 4c5f  dst));.    GGML_
+0004a5c0: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
+0004a5d0: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
+0004a5e0: 2064 7374 2929 3b0a 2020 2020 4747 4d4c   dst));.    GGML
+0004a5f0: 5f41 5353 4552 5428 6767 6d6c 5f61 7265  _ASSERT(ggml_are
+0004a600: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
+0004a610: 2c20 6772 6164 2929 3b0a 0a20 2020 2069  , grad));..    i
+0004a620: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+0004a630: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+0004a640: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
+0004a650: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+0004a660: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+0004a670: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+0004a680: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0004a690: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
+0004a6a0: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
+0004a6b0: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
+0004a6c0: 7468 3b0a 0a20 2020 2063 6f6e 7374 2069  th;..    const i
+0004a6d0: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
+0004a6e0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+0004a6f0: 6e74 206e 7220 3d20 6767 6d6c 5f6e 726f  nt nr = ggml_nro
+0004a700: 7773 2873 7263 3029 3b0a 0a20 2020 202f  ws(src0);..    /
+0004a710: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
+0004a720: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
+0004a730: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
+0004a740: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
+0004a750: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
+0004a760: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
+0004a770: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
+0004a780: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
+0004a790: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
+0004a7a0: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
+0004a7b0: 2020 2066 6f72 2028 696e 7420 6931 203d     for (int i1 =
+0004a7c0: 2069 7230 3b20 6931 203c 2069 7231 3b20   ir0; i1 < ir1; 
+0004a7d0: 6931 2b2b 2920 7b0a 2020 2020 2020 2020  i1++) {.        
+0004a7e0: 6767 6d6c 5f76 6563 5f73 696c 755f 6261  ggml_vec_silu_ba
+0004a7f0: 636b 7761 7264 5f66 3332 286e 632c 0a20  ckward_f32(nc,. 
+0004a800: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0004a810: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+0004a820: 2a29 2064 7374 2d3e 6461 7461 2020 2b20  *) dst->data  + 
+0004a830: 6931 2a28 2064 7374 2d3e 6e62 5b31 5d29  i1*( dst->nb[1])
+0004a840: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0004a850: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+0004a860: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+0004a870: 6120 2b20 6931 2a28 7372 6330 2d3e 6e62  a + i1*(src0->nb
+0004a880: 5b31 5d29 292c 0a20 2020 2020 2020 2020  [1])),.         
+0004a890: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+0004a8a0: 2028 2863 6861 7220 2a29 2067 7261 642d   ((char *) grad-
+0004a8b0: 3e64 6174 6120 2b20 6931 2a28 6772 6164  >data + i1*(grad
+0004a8c0: 2d3e 6e62 5b31 5d29 2929 3b0a 0a23 6966  ->nb[1])));..#if
+0004a8d0: 6e64 6566 204e 4445 4255 470a 2020 2020  ndef NDEBUG.    
+0004a8e0: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
+0004a8f0: 2030 3b20 6b20 3c20 6e63 3b20 6b2b 2b29   0; k < nc; k++)
+0004a900: 207b 0a20 2020 2020 2020 2020 2020 2063   {.            c
+0004a910: 6f6e 7374 2066 6c6f 6174 2078 203d 2028  onst float x = (
+0004a920: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+0004a930: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
+0004a940: 6931 2a28 2064 7374 2d3e 6e62 5b31 5d29  i1*( dst->nb[1])
+0004a950: 2929 5b6b 5d3b 0a20 2020 2020 2020 2020  ))[k];.         
+0004a960: 2020 2055 4e55 5345 4428 7829 3b0a 2020     UNUSED(x);.  
+0004a970: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0004a980: 2821 6973 6e61 6e28 7829 293b 0a20 2020  (!isnan(x));.   
+0004a990: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
+0004a9a0: 2169 7369 6e66 2878 2929 3b0a 2020 2020  !isinf(x));.    
+0004a9b0: 2020 2020 7d0a 2365 6e64 6966 0a20 2020      }.#endif.   
+0004a9c0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
+0004a9d0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+0004a9e0: 6f72 7761 7264 5f73 696c 755f 6261 636b  orward_silu_back
+0004a9f0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0004aa00: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0004aa10: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0004aa20: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0004aa30: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0004aa40: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0004aa50: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0004aa60: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0004aa70: 2067 7261 642c 0a20 2020 2020 2020 2073   grad,.        s
+0004aa80: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0004aa90: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+0004aaa0: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+0004aab0: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+0004aac0: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+0004aad0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0004aae0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0004aaf0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0004ab00: 6172 645f 7369 6c75 5f62 6163 6b5f 6633  ard_silu_back_f3
+0004ab10: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+0004ab20: 6772 6164 2c20 6473 7429 3b0a 2020 2020  grad, dst);.    
+0004ab30: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0004ab40: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+0004ab50: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0004ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ab70: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+0004ab80: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+0004ab90: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+0004aba0: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
+0004abb0: 655f 666f 7277 6172 645f 6e6f 726d 0a0a  e_forward_norm..
+0004abc0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+0004abd0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0004abe0: 5f6e 6f72 6d5f 6633 3228 0a20 2020 2020  _norm_f32(.     
+0004abf0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0004ac00: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+0004ac10: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+0004ac20: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0004ac30: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0004ac40: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
+0004ac50: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0004ac60: 7220 2a20 6473 7429 207b 0a20 2020 2047  r * dst) {.    G
+0004ac70: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+0004ac80: 6172 655f 7361 6d65 5f73 6861 7065 2873  are_same_shape(s
+0004ac90: 7263 302c 2064 7374 2929 3b0a 0a20 2020  rc0, dst));..   
+0004aca0: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+0004acb0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+0004acc0: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
+0004acd0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+0004ace0: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
+0004acf0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+0004ad00: 207d 0a0a 2020 2020 4747 4d4c 5f41 5353   }..    GGML_ASS
+0004ad10: 4552 5428 7372 6330 2d3e 6e62 5b30 5d20  ERT(src0->nb[0] 
+0004ad20: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+0004ad30: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
+0004ad40: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
+0004ad50: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0004ad60: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
+0004ad70: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
+0004ad80: 2069 6e74 3634 5f74 206e 6530 3020 3d20   int64_t ne00 = 
+0004ad90: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
+0004ada0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0004adb0: 6530 3120 3d20 7372 6330 2d3e 6e65 5b31  e01 = src0->ne[1
+0004adc0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0004add0: 3634 5f74 206e 6530 3220 3d20 7372 6330  64_t ne02 = src0
+0004ade0: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
+0004adf0: 7374 2069 6e74 3634 5f74 206e 6530 3320  st int64_t ne03 
+0004ae00: 3d20 7372 6330 2d3e 6e65 5b33 5d3b 0a0a  = src0->ne[3];..
+0004ae10: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0004ae20: 206e 6230 3120 3d20 7372 6330 2d3e 6e62   nb01 = src0->nb
+0004ae30: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2073  [1];.    const s
+0004ae40: 697a 655f 7420 6e62 3032 203d 2073 7263  ize_t nb02 = src
+0004ae50: 302d 3e6e 625b 325d 3b0a 2020 2020 636f  0->nb[2];.    co
+0004ae60: 6e73 7420 7369 7a65 5f74 206e 6230 3320  nst size_t nb03 
+0004ae70: 3d20 7372 6330 2d3e 6e62 5b33 5d3b 0a0a  = src0->nb[3];..
+0004ae80: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0004ae90: 206e 6231 203d 2064 7374 2d3e 6e62 5b31   nb1 = dst->nb[1
+0004aea0: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+0004aeb0: 655f 7420 6e62 3220 3d20 6473 742d 3e6e  e_t nb2 = dst->n
+0004aec0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+0004aed0: 7369 7a65 5f74 206e 6233 203d 2064 7374  size_t nb3 = dst
+0004aee0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
+0004aef0: 6e73 7420 666c 6f61 7420 6570 7320 3d20  nst float eps = 
+0004af00: 3165 2d35 663b 202f 2f20 544f 444f 3a20  1e-5f; // TODO: 
+0004af10: 6d61 6b65 2074 6869 7320 6120 7061 7261  make this a para
+0004af20: 6d65 7465 720a 0a20 2020 202f 2f20 544f  meter..    // TO
+0004af30: 444f 3a20 6f70 7469 6d69 7a65 0a20 2020  DO: optimize.   
+0004af40: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+0004af50: 3320 3d20 303b 2069 3033 203c 206e 6530  3 = 0; i03 < ne0
+0004af60: 333b 2069 3033 2b2b 2920 7b0a 2020 2020  3; i03++) {.    
+0004af70: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+0004af80: 2069 3032 203d 2030 3b20 6930 3220 3c20   i02 = 0; i02 < 
+0004af90: 6e65 3032 3b20 6930 322b 2b29 207b 0a20  ne02; i02++) {. 
+0004afa0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0004afb0: 696e 7436 345f 7420 6930 3120 3d20 6974  int64_t i01 = it
+0004afc0: 683b 2069 3031 203c 206e 6530 313b 2069  h; i01 < ne01; i
+0004afd0: 3031 202b 3d20 6e74 6829 207b 0a20 2020  01 += nth) {.   
+0004afe0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0004aff0: 7374 2066 6c6f 6174 202a 2078 203d 2028  st float * x = (
+0004b000: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+0004b010: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+0004b020: 6930 312a 6e62 3031 202b 2069 3032 2a6e  i01*nb01 + i02*n
+0004b030: 6230 3220 2b20 6930 332a 6e62 3033 293b  b02 + i03*nb03);
+0004b040: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004b050: 2020 6767 6d6c 5f66 6c6f 6174 2073 756d    ggml_float sum
+0004b060: 203d 2030 2e30 3b0a 2020 2020 2020 2020   = 0.0;.        
+0004b070: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0004b080: 3634 5f74 2069 3030 203d 2030 3b20 6930  64_t i00 = 0; i0
+0004b090: 3020 3c20 6e65 3030 3b20 6930 302b 2b29  0 < ne00; i00++)
+0004b0a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0004b0b0: 2020 2020 2020 2073 756d 202b 3d20 2867         sum += (g
+0004b0c0: 676d 6c5f 666c 6f61 7429 785b 6930 305d  gml_float)x[i00]
+0004b0d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0004b0e0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+0004b0f0: 2020 2020 2066 6c6f 6174 206d 6561 6e20       float mean 
+0004b100: 3d20 7375 6d2f 6e65 3030 3b0a 0a20 2020  = sum/ne00;..   
+0004b110: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+0004b120: 6174 202a 2079 203d 2028 666c 6f61 7420  at * y = (float 
+0004b130: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
+0004b140: 2d3e 6461 7461 202b 2069 3031 2a6e 6231  ->data + i01*nb1
+0004b150: 202b 2069 3032 2a6e 6232 202b 2069 3033   + i02*nb2 + i03
+0004b160: 2a6e 6233 293b 0a0a 2020 2020 2020 2020  *nb3);..        
+0004b170: 2020 2020 2020 2020 6767 6d6c 5f66 6c6f          ggml_flo
+0004b180: 6174 2073 756d 3220 3d20 302e 303b 0a20  at sum2 = 0.0;. 
+0004b190: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0004b1a0: 6f72 2028 696e 7436 345f 7420 6930 3020  or (int64_t i00 
+0004b1b0: 3d20 303b 2069 3030 203c 206e 6530 303b  = 0; i00 < ne00;
+0004b1c0: 2069 3030 2b2b 2920 7b0a 2020 2020 2020   i00++) {.      
+0004b1d0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0004b1e0: 6f61 7420 7620 3d20 785b 6930 305d 202d  oat v = x[i00] -
+0004b1f0: 206d 6561 6e3b 0a20 2020 2020 2020 2020   mean;.         
+0004b200: 2020 2020 2020 2020 2020 2079 5b69 3030             y[i00
+0004b210: 5d20 3d20 763b 0a20 2020 2020 2020 2020  ] = v;.         
+0004b220: 2020 2020 2020 2020 2020 2073 756d 3220             sum2 
+0004b230: 2b3d 2028 6767 6d6c 5f66 6c6f 6174 2928  += (ggml_float)(
+0004b240: 762a 7629 3b0a 2020 2020 2020 2020 2020  v*v);.          
+0004b250: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0004b260: 2020 2020 2020 2020 2066 6c6f 6174 2076           float v
+0004b270: 6172 6961 6e63 6520 3d20 7375 6d32 2f6e  ariance = sum2/n
+0004b280: 6530 303b 0a20 2020 2020 2020 2020 2020  e00;.           
+0004b290: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+0004b2a0: 2073 6361 6c65 203d 2031 2e30 662f 7371   scale = 1.0f/sq
+0004b2b0: 7274 6628 7661 7269 616e 6365 202b 2065  rtf(variance + e
+0004b2c0: 7073 293b 0a0a 2020 2020 2020 2020 2020  ps);..          
+0004b2d0: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+0004b2e0: 6361 6c65 5f66 3332 286e 6530 302c 2079  cale_f32(ne00, y
+0004b2f0: 2c20 7363 616c 6529 3b0a 2020 2020 2020  , scale);.      
+0004b300: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0004b310: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
+0004b320: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+0004b330: 7574 655f 666f 7277 6172 645f 6e6f 726d  ute_forward_norm
+0004b340: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0004b350: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0004b360: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0004b370: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0004b380: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0004b390: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0004b3a0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0004b3b0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+0004b3c0: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
+0004b3d0: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
+0004b3e0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0004b3f0: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+0004b400: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0004b410: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+0004b420: 7465 5f66 6f72 7761 7264 5f6e 6f72 6d5f  te_forward_norm_
+0004b430: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+0004b440: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
+0004b450: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0004b460: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
+0004b470: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0004b480: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+0004b490: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+0004b4a0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0004b4b0: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 7374  eak;.    }.}..st
+0004b4c0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+0004b4d0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+0004b4e0: 6d73 5f6e 6f72 6d5f 6633 3228 0a20 2020  ms_norm_f32(.   
+0004b4f0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0004b500: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+0004b510: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+0004b520: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0004b530: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0004b540: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+0004b550: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0004b560: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+0004b570: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+0004b580: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
+0004b590: 2873 7263 302c 2064 7374 2929 3b0a 0a20  (src0, dst));.. 
+0004b5a0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+0004b5b0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+0004b5c0: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
+0004b5d0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0004b5e0: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
+0004b5f0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+0004b600: 2020 207d 0a0a 2020 2020 4747 4d4c 5f41     }..    GGML_A
+0004b610: 5353 4552 5428 7372 6330 2d3e 6e62 5b30  SSERT(src0->nb[0
+0004b620: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+0004b630: 7429 293b 0a0a 2020 2020 636f 6e73 7420  t));..    const 
+0004b640: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
+0004b650: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
+0004b660: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
+0004b670: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
+0004b680: 7374 2069 6e74 3634 5f74 206e 6530 3020  st int64_t ne00 
+0004b690: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
+0004b6a0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+0004b6b0: 206e 6530 3120 3d20 7372 6330 2d3e 6e65   ne01 = src0->ne
+0004b6c0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+0004b6d0: 6e74 3634 5f74 206e 6530 3220 3d20 7372  nt64_t ne02 = sr
+0004b6e0: 6330 2d3e 6e65 5b32 5d3b 0a20 2020 2063  c0->ne[2];.    c
+0004b6f0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+0004b700: 3320 3d20 7372 6330 2d3e 6e65 5b33 5d3b  3 = src0->ne[3];
+0004b710: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
+0004b720: 5f74 206e 6230 3120 3d20 7372 6330 2d3e  _t nb01 = src0->
+0004b730: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
+0004b740: 2073 697a 655f 7420 6e62 3032 203d 2073   size_t nb02 = s
+0004b750: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
+0004b760: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+0004b770: 3320 3d20 7372 6330 2d3e 6e62 5b33 5d3b  3 = src0->nb[3];
+0004b780: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
+0004b790: 5f74 206e 6231 203d 2064 7374 2d3e 6e62  _t nb1 = dst->nb
+0004b7a0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2073  [1];.    const s
+0004b7b0: 697a 655f 7420 6e62 3220 3d20 6473 742d  ize_t nb2 = dst-
+0004b7c0: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
+0004b7d0: 7420 7369 7a65 5f74 206e 6233 203d 2064  t size_t nb3 = d
+0004b7e0: 7374 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  st->nb[3];..    
+0004b7f0: 636f 6e73 7420 666c 6f61 7420 6570 7320  const float eps 
+0004b800: 3d20 3165 2d36 663b 202f 2f20 544f 444f  = 1e-6f; // TODO
+0004b810: 3a20 6d61 6b65 2074 6869 7320 6120 7061  : make this a pa
+0004b820: 7261 6d65 7465 720a 0a20 2020 202f 2f20  rameter..    // 
+0004b830: 544f 444f 3a20 6f70 7469 6d69 7a65 0a20  TODO: optimize. 
+0004b840: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+0004b850: 6930 3320 3d20 303b 2069 3033 203c 206e  i03 = 0; i03 < n
+0004b860: 6530 333b 2069 3033 2b2b 2920 7b0a 2020  e03; i03++) {.  
+0004b870: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0004b880: 5f74 2069 3032 203d 2030 3b20 6930 3220  _t i02 = 0; i02 
+0004b890: 3c20 6e65 3032 3b20 6930 322b 2b29 207b  < ne02; i02++) {
+0004b8a0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0004b8b0: 2028 696e 7436 345f 7420 6930 3120 3d20   (int64_t i01 = 
+0004b8c0: 6974 683b 2069 3031 203c 206e 6530 313b  ith; i01 < ne01;
+0004b8d0: 2069 3031 202b 3d20 6e74 6829 207b 0a20   i01 += nth) {. 
+0004b8e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0004b8f0: 6f6e 7374 2066 6c6f 6174 202a 2078 203d  onst float * x =
+0004b900: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+0004b910: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+0004b920: 2b20 6930 312a 6e62 3031 202b 2069 3032  + i01*nb01 + i02
+0004b930: 2a6e 6230 3220 2b20 6930 332a 6e62 3033  *nb02 + i03*nb03
+0004b940: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0004b950: 2020 2020 6767 6d6c 5f66 6c6f 6174 2073      ggml_float s
+0004b960: 756d 203d 2030 2e30 3b0a 2020 2020 2020  um = 0.0;.      
+0004b970: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0004b980: 6e74 3634 5f74 2069 3030 203d 2030 3b20  nt64_t i00 = 0; 
+0004b990: 6930 3020 3c20 6e65 3030 3b20 6930 302b  i00 < ne00; i00+
+0004b9a0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0004b9b0: 2020 2020 2020 2020 2073 756d 202b 3d20           sum += 
+0004b9c0: 2867 676d 6c5f 666c 6f61 7429 2878 5b69  (ggml_float)(x[i
+0004b9d0: 3030 5d20 2a20 785b 6930 305d 293b 0a20  00] * x[i00]);. 
+0004b9e0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0004b9f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004ba00: 2020 636f 6e73 7420 666c 6f61 7420 6d65    const float me
+0004ba10: 616e 203d 2073 756d 2f6e 6530 303b 0a0a  an = sum/ne00;..
+0004ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ba30: 666c 6f61 7420 2a20 7920 3d20 2866 6c6f  float * y = (flo
+0004ba40: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+0004ba50: 6473 742d 3e64 6174 6120 2b20 6930 312a  dst->data + i01*
+0004ba60: 6e62 3120 2b20 6930 322a 6e62 3220 2b20  nb1 + i02*nb2 + 
+0004ba70: 6930 332a 6e62 3329 3b0a 0a20 2020 2020  i03*nb3);..     
+0004ba80: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
+0004ba90: 7928 792c 2078 2c20 6e65 3030 202a 2073  y(y, x, ne00 * s
+0004baa0: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+0004bab0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0004bac0: 2f20 666f 7220 2869 6e74 2069 3030 203d  / for (int i00 =
+0004bad0: 2030 3b20 6930 3020 3c20 6e65 3030 3b20   0; i00 < ne00; 
+0004bae0: 6930 302b 2b29 207b 0a20 2020 2020 2020  i00++) {.       
+0004baf0: 2020 2020 2020 2020 202f 2f20 2020 2020           //     
+0004bb00: 795b 6930 305d 203d 2078 5b69 3030 5d3b  y[i00] = x[i00];
+0004bb10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004bb20: 202f 2f20 7d0a 0a20 2020 2020 2020 2020   // }..         
+0004bb30: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0004bb40: 6174 2073 6361 6c65 203d 2031 2e30 662f  at scale = 1.0f/
+0004bb50: 7371 7274 6628 6d65 616e 202b 2065 7073  sqrtf(mean + eps
+0004bb60: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0004bb70: 2020 2020 6767 6d6c 5f76 6563 5f73 6361      ggml_vec_sca
+0004bb80: 6c65 5f66 3332 286e 6530 302c 2079 2c20  le_f32(ne00, y, 
+0004bb90: 7363 616c 6529 3b0a 2020 2020 2020 2020  scale);.        
+0004bba0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+0004bbb0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+0004bbc0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+0004bbd0: 655f 666f 7277 6172 645f 726d 735f 6e6f  e_forward_rms_no
+0004bbe0: 726d 280a 2020 2020 2020 2020 636f 6e73  rm(.        cons
+0004bbf0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+0004bc00: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+0004bc10: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+0004bc20: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0004bc30: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+0004bc40: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0004bc50: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+0004bc60: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+0004bc70: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+0004bc80: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0004bc90: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+0004bca0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0004bcb0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+0004bcc0: 7075 7465 5f66 6f72 7761 7264 5f72 6d73  pute_forward_rms
+0004bcd0: 5f6e 6f72 6d5f 6633 3228 7061 7261 6d73  _norm_f32(params
+0004bce0: 2c20 7372 6330 2c20 6473 7429 3b0a 2020  , src0, dst);.  
+0004bcf0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0004bd00: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
+0004bd10: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+0004bd20: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0004bd30: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0004bd40: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+0004bd50: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
+0004bd60: 0a7d 0a0a 0a73 7461 7469 6320 766f 6964  .}...static void
+0004bd70: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+0004bd80: 7277 6172 645f 726d 735f 6e6f 726d 5f62  rward_rms_norm_b
+0004bd90: 6163 6b5f 6633 3228 0a20 2020 2020 2020  ack_f32(.       
+0004bda0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0004bdb0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+0004bdc0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+0004bdd0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0004bde0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+0004bdf0: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+0004be00: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0004be10: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+0004be20: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0004be30: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+0004be40: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
+0004be50: 5428 6767 6d6c 5f61 7265 5f73 616d 655f  T(ggml_are_same_
+0004be60: 7368 6170 6528 7372 6330 2c20 6473 7429  shape(src0, dst)
+0004be70: 2026 2620 6767 6d6c 5f61 7265 5f73 616d   && ggml_are_sam
+0004be80: 655f 7368 6170 6528 7372 6330 2c20 7372  e_shape(src0, sr
+0004be90: 6331 2929 3b0a 0a20 2020 2069 6620 2870  c1));..    if (p
+0004bea0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0004beb0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+0004bec0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+0004bed0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+0004bee0: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+0004bef0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0004bf00: 2020 4747 4d4c 5f41 5353 4552 5428 7372    GGML_ASSERT(sr
+0004bf10: 6330 2d3e 6e62 5b30 5d20 3d3d 2073 697a  c0->nb[0] == siz
+0004bf20: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
+0004bf30: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
+0004bf40: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
+0004bf50: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
+0004bf60: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
+0004bf70: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0004bf80: 5f74 206e 6530 3020 3d20 7372 6330 2d3e  _t ne00 = src0->
+0004bf90: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+0004bfa0: 2069 6e74 3634 5f74 206e 6530 3120 3d20   int64_t ne01 = 
+0004bfb0: 7372 6330 2d3e 6e65 5b31 5d3b 0a20 2020  src0->ne[1];.   
+0004bfc0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0004bfd0: 6530 3220 3d20 7372 6330 2d3e 6e65 5b32  e02 = src0->ne[2
+0004bfe0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0004bff0: 3634 5f74 206e 6530 3320 3d20 7372 6330  64_t ne03 = src0
+0004c000: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
+0004c010: 6e73 7420 7369 7a65 5f74 206e 6230 3120  nst size_t nb01 
+0004c020: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a20  = src0->nb[1];. 
+0004c030: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0004c040: 6e62 3032 203d 2073 7263 302d 3e6e 625b  nb02 = src0->nb[
+0004c050: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
+0004c060: 7a65 5f74 206e 6230 3320 3d20 7372 6330  ze_t nb03 = src0
+0004c070: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
+0004c080: 6e73 7420 7369 7a65 5f74 206e 6231 3120  nst size_t nb11 
+0004c090: 3d20 7372 6331 2d3e 6e62 5b31 5d3b 0a20  = src1->nb[1];. 
+0004c0a0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0004c0b0: 6e62 3132 203d 2073 7263 312d 3e6e 625b  nb12 = src1->nb[
+0004c0c0: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
+0004c0d0: 7a65 5f74 206e 6231 3320 3d20 7372 6331  ze_t nb13 = src1
+0004c0e0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
+0004c0f0: 6e73 7420 7369 7a65 5f74 206e 6231 203d  nst size_t nb1 =
+0004c100: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
+0004c110: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+0004c120: 3220 3d20 6473 742d 3e6e 625b 325d 3b0a  2 = dst->nb[2];.
+0004c130: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0004c140: 206e 6233 203d 2064 7374 2d3e 6e62 5b33   nb3 = dst->nb[3
+0004c150: 5d3b 0a0a 2020 2020 636f 6e73 7420 666c  ];..    const fl
+0004c160: 6f61 7420 6570 7320 3d20 3165 2d36 663b  oat eps = 1e-6f;
+0004c170: 202f 2f20 544f 444f 3a20 6d61 6b65 2074   // TODO: make t
+0004c180: 6869 7320 6120 7061 7261 6d65 7465 720a  his a parameter.
+0004c190: 0a20 2020 202f 2f20 544f 444f 3a20 6f70  .    // TODO: op
+0004c1a0: 7469 6d69 7a65 0a20 2020 2066 6f72 2028  timize.    for (
+0004c1b0: 696e 7436 345f 7420 6930 3320 3d20 303b  int64_t i03 = 0;
+0004c1c0: 2069 3033 203c 206e 6530 333b 2069 3033   i03 < ne03; i03
+0004c1d0: 2b2b 2920 7b0a 2020 2020 2020 2020 666f  ++) {.        fo
+0004c1e0: 7220 2869 6e74 3634 5f74 2069 3032 203d  r (int64_t i02 =
+0004c1f0: 2030 3b20 6930 3220 3c20 6e65 3032 3b20   0; i02 < ne02; 
+0004c200: 6930 322b 2b29 207b 0a20 2020 2020 2020  i02++) {.       
+0004c210: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+0004c220: 7420 6930 3120 3d20 6974 683b 2069 3031  t i01 = ith; i01
+0004c230: 203c 206e 6530 313b 2069 3031 202b 3d20   < ne01; i01 += 
+0004c240: 6e74 6829 207b 0a20 2020 2020 2020 2020  nth) {.         
+0004c250: 2020 2020 2020 202f 2f20 7372 6331 2069         // src1 i
+0004c260: 7320 7361 6d65 2073 6861 7065 2061 7320  s same shape as 
+0004c270: 7372 6330 203d 3e20 7361 6d65 2069 6e64  src0 => same ind
+0004c280: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
+0004c290: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
+0004c2a0: 5f74 2069 3131 203d 2069 3031 3b0a 2020  _t i11 = i01;.  
+0004c2b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0004c2c0: 6e73 7420 696e 7436 345f 7420 6931 3220  nst int64_t i12 
+0004c2d0: 3d20 6930 323b 0a20 2020 2020 2020 2020  = i02;.         
+0004c2e0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0004c2f0: 3634 5f74 2069 3133 203d 2069 3033 3b0a  64_t i13 = i03;.
+0004c300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004c310: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
+0004c320: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
+0004c330: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+0004c340: 6120 2b20 6930 312a 6e62 3031 202b 2069  a + i01*nb01 + i
+0004c350: 3032 2a6e 6230 3220 2b20 6930 332a 6e62  02*nb02 + i03*nb
+0004c360: 3033 293b 0a20 2020 2020 2020 2020 2020  03);.           
+0004c370: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+0004c380: 202a 2064 7a20 3d20 2866 6c6f 6174 202a   * dz = (float *
+0004c390: 2920 2828 6368 6172 202a 2920 7372 6331  ) ((char *) src1
+0004c3a0: 2d3e 6461 7461 202b 2069 3131 2a6e 6231  ->data + i11*nb1
+0004c3b0: 3120 2b20 6931 322a 6e62 3132 202b 2069  1 + i12*nb12 + i
+0004c3c0: 3133 2a6e 6231 3329 3b0a 0a20 2020 2020  13*nb13);..     
+0004c3d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0004c3e0: 666c 6f61 7420 7375 6d5f 7878 2020 3d20  float sum_xx  = 
+0004c3f0: 302e 303b 0a20 2020 2020 2020 2020 2020  0.0;.           
+0004c400: 2020 2020 2067 676d 6c5f 666c 6f61 7420       ggml_float 
+0004c410: 7375 6d5f 7864 7a20 3d20 302e 303b 0a0a  sum_xdz = 0.0;..
+0004c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c430: 666f 7220 2869 6e74 3634 5f74 2069 3030  for (int64_t i00
+0004c440: 203d 2030 3b20 6930 3020 3c20 6e65 3030   = 0; i00 < ne00
+0004c450: 3b20 6930 302b 2b29 207b 0a20 2020 2020  ; i00++) {.     
+0004c460: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0004c470: 756d 5f78 7820 202b 3d20 2867 676d 6c5f  um_xx  += (ggml_
+0004c480: 666c 6f61 7429 2878 5b69 3030 5d20 2a20  float)(x[i00] * 
+0004c490: 785b 6930 305d 293b 0a20 2020 2020 2020  x[i00]);.       
+0004c4a0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+0004c4b0: 5f78 647a 202b 3d20 2867 676d 6c5f 666c  _xdz += (ggml_fl
+0004c4c0: 6f61 7429 2878 5b69 3030 5d20 2a20 647a  oat)(x[i00] * dz
 0004c4d0: 5b69 3030 5d29 3b0a 2020 2020 2020 2020  [i00]);.        
-0004c4e0: 2020 2020 2020 2020 2020 2020 7375 6d5f              sum_
-0004c4f0: 7864 7a20 2b3d 2028 6767 6d6c 5f66 6c6f  xdz += (ggml_flo
-0004c500: 6174 2928 785b 6930 305d 202a 2064 7a5b  at)(x[i00] * dz[
-0004c510: 6930 305d 293b 0a20 2020 2020 2020 2020  i00]);.         
-0004c520: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0004c530: 2020 2020 2020 2020 2020 2f2f 636f 6e73            //cons
-0004c540: 7420 666c 6f61 7420 6d65 616e 2020 2020  t float mean    
-0004c550: 203d 2028 666c 6f61 7429 2873 756d 5f78   = (float)(sum_x
-0004c560: 7829 2f6e 6530 303b 0a20 2020 2020 2020  x)/ne00;.       
-0004c570: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0004c580: 6c6f 6174 206d 6561 6e5f 6570 7320 3d20  loat mean_eps = 
-0004c590: 2866 6c6f 6174 2928 7375 6d5f 7878 292f  (float)(sum_xx)/
-0004c5a0: 6e65 3030 202b 2065 7073 3b0a 2020 2020  ne00 + eps;.    
-0004c5b0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0004c5c0: 7420 666c 6f61 7420 7375 6d5f 6570 7320  t float sum_eps 
-0004c5d0: 203d 2028 666c 6f61 7429 2873 756d 5f78   = (float)(sum_x
-0004c5e0: 7829 202b 2065 7073 2a6e 6530 303b 0a20  x) + eps*ne00;. 
-0004c5f0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0004c600: 2f63 6f6e 7374 2066 6c6f 6174 206d 6561  /const float mea
-0004c610: 6e5f 7864 7a20 3d20 2866 6c6f 6174 2928  n_xdz = (float)(
-0004c620: 7375 6d5f 7864 7a29 2f6e 6530 303b 0a20  sum_xdz)/ne00;. 
-0004c630: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0004c640: 2f20 7765 2063 6f75 6c64 2063 6163 6865  / we could cache
-0004c650: 2072 6d73 2066 726f 6d20 666f 7277 6172   rms from forwar
-0004c660: 6420 7061 7373 2074 6f20 696d 7072 6f76  d pass to improv
-0004c670: 6520 7065 7266 6f72 6d61 6e63 652e 0a20  e performance.. 
-0004c680: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0004c690: 2f20 746f 2064 6f20 7468 6973 2069 6d70  / to do this imp
-0004c6a0: 6c65 6d65 6e74 2067 676d 6c5f 726d 7320  lement ggml_rms 
-0004c6b0: 616e 6420 636f 6d70 6f73 6520 6767 6d6c  and compose ggml
-0004c6c0: 5f72 6d73 5f6e 6f72 6d20 7573 696e 6720  _rms_norm using 
-0004c6d0: 6767 6d6c 5f72 6d73 2e0a 2020 2020 2020  ggml_rms..      
-0004c6e0: 2020 2020 2020 2020 2020 2f2f 636f 6e73            //cons
-0004c6f0: 7420 666c 6f61 7420 726d 7320 2020 2020  t float rms     
-0004c700: 203d 2073 7172 7466 286d 6561 6e5f 6570   = sqrtf(mean_ep
+0004c4e0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0004c4f0: 2020 2020 2020 2020 2020 202f 2f63 6f6e             //con
+0004c500: 7374 2066 6c6f 6174 206d 6561 6e20 2020  st float mean   
+0004c510: 2020 3d20 2866 6c6f 6174 2928 7375 6d5f    = (float)(sum_
+0004c520: 7878 292f 6e65 3030 3b0a 2020 2020 2020  xx)/ne00;.      
+0004c530: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0004c540: 666c 6f61 7420 6d65 616e 5f65 7073 203d  float mean_eps =
+0004c550: 2028 666c 6f61 7429 2873 756d 5f78 7829   (float)(sum_xx)
+0004c560: 2f6e 6530 3020 2b20 6570 733b 0a20 2020  /ne00 + eps;.   
+0004c570: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0004c580: 7374 2066 6c6f 6174 2073 756d 5f65 7073  st float sum_eps
+0004c590: 2020 3d20 2866 6c6f 6174 2928 7375 6d5f    = (float)(sum_
+0004c5a0: 7878 2920 2b20 6570 732a 6e65 3030 3b0a  xx) + eps*ne00;.
+0004c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c5c0: 2f2f 636f 6e73 7420 666c 6f61 7420 6d65  //const float me
+0004c5d0: 616e 5f78 647a 203d 2028 666c 6f61 7429  an_xdz = (float)
+0004c5e0: 2873 756d 5f78 647a 292f 6e65 3030 3b0a  (sum_xdz)/ne00;.
+0004c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c600: 2f2f 2077 6520 636f 756c 6420 6361 6368  // we could cach
+0004c610: 6520 726d 7320 6672 6f6d 2066 6f72 7761  e rms from forwa
+0004c620: 7264 2070 6173 7320 746f 2069 6d70 726f  rd pass to impro
+0004c630: 7665 2070 6572 666f 726d 616e 6365 2e0a  ve performance..
+0004c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c650: 2f2f 2074 6f20 646f 2074 6869 7320 696d  // to do this im
+0004c660: 706c 656d 656e 7420 6767 6d6c 5f72 6d73  plement ggml_rms
+0004c670: 2061 6e64 2063 6f6d 706f 7365 2067 676d   and compose ggm
+0004c680: 6c5f 726d 735f 6e6f 726d 2075 7369 6e67  l_rms_norm using
+0004c690: 2067 676d 6c5f 726d 732e 0a20 2020 2020   ggml_rms..     
+0004c6a0: 2020 2020 2020 2020 2020 202f 2f63 6f6e             //con
+0004c6b0: 7374 2066 6c6f 6174 2072 6d73 2020 2020  st float rms    
+0004c6c0: 2020 3d20 7371 7274 6628 6d65 616e 5f65    = sqrtf(mean_e
+0004c6d0: 7073 293b 0a20 2020 2020 2020 2020 2020  ps);.           
+0004c6e0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+0004c6f0: 2072 726d 7320 2020 2020 3d20 312e 3066   rrms     = 1.0f
+0004c700: 202f 2073 7172 7466 286d 6561 6e5f 6570   / sqrtf(mean_ep
 0004c710: 7329 3b0a 2020 2020 2020 2020 2020 2020  s);.            
-0004c720: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0004c730: 7272 6d73 2020 2020 203d 2031 2e30 6620  rrms     = 1.0f 
-0004c740: 2f20 7371 7274 6628 6d65 616e 5f65 7073  / sqrtf(mean_eps
-0004c750: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0004c760: 2020 202f 2f63 6f6e 7374 2066 6c6f 6174     //const float
-0004c770: 2073 6361 6c65 2020 2020 3d20 2d72 726d   scale    = -rrm
-0004c780: 732f 286e 6530 3020 2a20 6d65 616e 5f65  s/(ne00 * mean_e
-0004c790: 7073 293b 202f 2f20 2d31 2f28 6e2a 726d  ps); // -1/(n*rm
-0004c7a0: 732a 2a33 290a 0a20 2020 2020 2020 2020  s**3)..         
-0004c7b0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0004c7c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0004c7d0: 7a20 3d20 726d 735f 6e6f 726d 2878 290a  z = rms_norm(x).
+0004c720: 2020 2020 2f2f 636f 6e73 7420 666c 6f61      //const floa
+0004c730: 7420 7363 616c 6520 2020 203d 202d 7272  t scale    = -rr
+0004c740: 6d73 2f28 6e65 3030 202a 206d 6561 6e5f  ms/(ne00 * mean_
+0004c750: 6570 7329 3b20 2f2f 202d 312f 286e 2a72  eps); // -1/(n*r
+0004c760: 6d73 2a2a 3329 0a0a 2020 2020 2020 2020  ms**3)..        
+0004c770: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0004c780: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0004c790: 207a 203d 2072 6d73 5f6e 6f72 6d28 7829   z = rms_norm(x)
+0004c7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004c7b0: 2020 2020 202f 2f0a 2020 2020 2020 2020       //.        
+0004c7c0: 2020 2020 2020 2020 2020 2020 2f2f 2072              // r
+0004c7d0: 6d73 5f6e 6f72 6d28 7372 6330 2920 3d0a  ms_norm(src0) =.
 0004c7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c7f0: 2020 2020 2f2f 0a20 2020 2020 2020 2020      //.         
-0004c800: 2020 2020 2020 2020 2020 202f 2f20 726d             // rm
-0004c810: 735f 6e6f 726d 2873 7263 3029 203d 0a20  s_norm(src0) =. 
-0004c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c830: 2020 202f 2f20 2020 2020 7363 616c 6528     //     scale(
-0004c840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004c850: 2020 2020 202f 2f20 2020 2020 2020 2020       //         
-0004c860: 7372 6330 2c0a 2020 2020 2020 2020 2020  src0,.          
-0004c870: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
-0004c880: 2020 2020 2064 6976 280a 2020 2020 2020       div(.      
-0004c890: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0004c8a0: 2020 2020 2020 2020 2020 2020 2031 2c0a               1,.
+0004c7f0: 2020 2020 2f2f 2020 2020 2073 6361 6c65      //     scale
+0004c800: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0004c810: 2020 2020 2020 2f2f 2020 2020 2020 2020        //        
+0004c820: 2073 7263 302c 0a20 2020 2020 2020 2020   src0,.         
+0004c830: 2020 2020 2020 2020 2020 202f 2f20 2020             //   
+0004c840: 2020 2020 2020 6469 7628 0a20 2020 2020        div(.     
+0004c850: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0004c860: 2f20 2020 2020 2020 2020 2020 2020 312c  /             1,
+0004c870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004c880: 2020 2020 202f 2f20 2020 2020 2020 2020       //         
+0004c890: 2020 2020 7371 7274 280a 2020 2020 2020      sqrt(.      
+0004c8a0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
 0004c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c8c0: 2020 2020 2f2f 2020 2020 2020 2020 2020      //          
-0004c8d0: 2020 2073 7172 7428 0a20 2020 2020 2020     sqrt(.       
-0004c8e0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0004c8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c900: 6164 6428 0a20 2020 2020 2020 2020 2020  add(.           
-0004c910: 2020 2020 2020 2020 202f 2f20 2020 2020           //     
-0004c920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c930: 7363 616c 6528 0a20 2020 2020 2020 2020  scale(.         
-0004c940: 2020 2020 2020 2020 2020 202f 2f20 2020             //   
-0004c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c960: 2020 2020 2020 7375 6d28 0a20 2020 2020        sum(.     
-0004c970: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0004c980: 2f20 2020 2020 2020 2020 2020 2020 2020  /               
-0004c990: 2020 2020 2020 2020 2020 2020 2020 7371                sq
-0004c9a0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0004c8c0: 2061 6464 280a 2020 2020 2020 2020 2020   add(.          
+0004c8d0: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
+0004c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c8f0: 2073 6361 6c65 280a 2020 2020 2020 2020   scale(.        
+0004c900: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
+0004c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c920: 2020 2020 2020 2073 756d 280a 2020 2020         sum(.    
+0004c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c940: 2f2f 2020 2020 2020 2020 2020 2020 2020  //              
+0004c950: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0004c960: 7172 280a 2020 2020 2020 2020 2020 2020  qr(.            
+0004c970: 2020 2020 2020 2020 2f2f 2020 2020 2020          //      
+0004c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c990: 2020 2020 2020 2020 2020 2073 7263 3029             src0)
+0004c9a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
 0004c9b0: 2020 2020 2020 202f 2f20 2020 2020 2020         //       
 0004c9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c9d0: 2020 2020 2020 2020 2020 7372 6330 2929            src0))
-0004c9e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004c9f0: 2020 2020 2020 2f2f 2020 2020 2020 2020        //        
-0004ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ca10: 2028 312e 302f 4e29 292c 0a20 2020 2020   (1.0/N)),.     
-0004ca20: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0004ca30: 2f20 2020 2020 2020 2020 2020 2020 2020  /               
-0004ca40: 2020 2020 2020 6570 7329 2929 293b 0a0a        eps))));..
-0004ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ca60: 2020 2020 2f2f 2070 6f73 746f 7264 6572      // postorder
-0004ca70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004ca80: 2020 2020 2020 2f2f 2023 2320 6f70 2020        // ## op  
-0004ca90: 2020 6172 6773 2020 2020 2020 2020 2067    args         g
-0004caa0: 7261 640a 2020 2020 2020 2020 2020 2020  rad.            
-0004cab0: 2020 2020 2020 2020 2f2f 2030 3020 7061          // 00 pa
-0004cac0: 7261 6d20 7372 6330 2020 2020 2020 2020  ram src0        
-0004cad0: 2067 7261 645b 2330 305d 0a20 2020 2020   grad[#00].     
-0004cae0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0004caf0: 2f20 3031 2063 6f6e 7374 2031 0a20 2020  / 01 const 1.   
-0004cb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cb10: 202f 2f20 3032 2073 7172 2020 2028 2330   // 02 sqr   (#0
-0004cb20: 3029 2020 2020 2020 2020 6772 6164 5b23  0)        grad[#
-0004cb30: 3032 5d0a 2020 2020 2020 2020 2020 2020  02].            
-0004cb40: 2020 2020 2020 2020 2f2f 2030 3320 7375          // 03 su
-0004cb50: 6d20 2020 2823 3032 2920 2020 2020 2020  m   (#02)       
-0004cb60: 2067 7261 645b 2330 335d 0a20 2020 2020   grad[#03].     
-0004cb70: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0004cb80: 2f20 3034 2063 6f6e 7374 2031 2f4e 0a20  / 04 const 1/N. 
-0004cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cba0: 2020 202f 2f20 3035 2073 6361 6c65 2028     // 05 scale (
-0004cbb0: 2330 332c 2023 3034 2920 2020 6772 6164  #03, #04)   grad
-0004cbc0: 5b23 3035 5d0a 2020 2020 2020 2020 2020  [#05].          
-0004cbd0: 2020 2020 2020 2020 2020 2f2f 2030 3620            // 06 
-0004cbe0: 636f 6e73 7420 6570 730a 2020 2020 2020  const eps.      
-0004cbf0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0004cc00: 2030 3720 6164 6420 2020 2823 3035 2c20   07 add   (#05, 
-0004cc10: 2330 3629 2020 2067 7261 645b 2330 375d  #06)   grad[#07]
-0004cc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004cc30: 2020 2020 202f 2f20 3038 2073 7172 7420       // 08 sqrt 
-0004cc40: 2028 2330 3729 2020 2020 2020 2020 6772   (#07)        gr
-0004cc50: 6164 5b23 3038 5d0a 2020 2020 2020 2020  ad[#08].        
-0004cc60: 2020 2020 2020 2020 2020 2020 2f2f 2030              // 0
-0004cc70: 3920 6469 7620 2020 2823 3031 2c23 3038  9 div   (#01,#08
-0004cc80: 2920 2020 2067 7261 645b 2330 395d 0a20  )    grad[#09]. 
-0004cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cca0: 2020 202f 2f20 3130 2073 6361 6c65 2028     // 10 scale (
-0004ccb0: 2330 302c 2330 3929 2020 2020 6772 6164  #00,#09)    grad
-0004ccc0: 5b23 3130 5d0a 2020 2020 2020 2020 2020  [#10].          
-0004ccd0: 2020 2020 2020 2020 2020 2f2f 0a20 2020            //.   
-0004cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ccf0: 202f 2f20 6261 636b 7761 7264 2070 6173   // backward pas
-0004cd00: 732c 2067 6976 656e 2067 7261 645b 2331  s, given grad[#1
-0004cd10: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-0004cd20: 2020 2020 2020 202f 2f20 2331 303a 2073         // #10: s
-0004cd30: 6361 6c65 0a20 2020 2020 2020 2020 2020  cale.           
-0004cd40: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
-0004cd50: 5b23 3030 5d20 2b3d 2073 6361 6c65 2867  [#00] += scale(g
-0004cd60: 7261 645b 2331 305d 2c23 3039 290a 2020  rad[#10],#09).  
-0004cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cd80: 2020 2f2f 2067 7261 645b 2330 395d 202b    // grad[#09] +
-0004cd90: 3d20 7375 6d28 6d75 6c28 6772 6164 5b23  = sum(mul(grad[#
-0004cda0: 3130 5d2c 2330 3029 290a 2020 2020 2020  10],#00)).      
-0004cdb0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0004cdc0: 2023 3039 3a20 6469 760a 2020 2020 2020   #09: div.      
-0004cdd0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0004cde0: 2067 7261 645b 2330 385d 202b 3d20 6e65   grad[#08] += ne
-0004cdf0: 6728 6d75 6c28 6772 6164 5b23 3039 5d2c  g(mul(grad[#09],
-0004ce00: 2064 6976 2823 3039 2c23 3038 2929 290a   div(#09,#08))).
-0004ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ce20: 2020 2020 2f2f 2023 3038 3a20 7371 7274      // #08: sqrt
-0004ce30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ce40: 2020 2020 202f 2f20 6772 6164 5b23 3037       // grad[#07
-0004ce50: 5d20 2b3d 206d 756c 2867 7261 645b 2330  ] += mul(grad[#0
-0004ce60: 385d 2c20 6469 7628 302e 352c 2023 3038  8], div(0.5, #08
-0004ce70: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0004ce80: 2020 2020 2020 202f 2f20 2330 373a 2061         // #07: a
-0004ce90: 6464 0a20 2020 2020 2020 2020 2020 2020  dd.             
-0004cea0: 2020 2020 2020 202f 2f20 6772 6164 5b23         // grad[#
-0004ceb0: 3035 5d20 2b3d 2067 7261 645b 2330 375d  05] += grad[#07]
-0004cec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ced0: 2020 2020 202f 2f20 2330 353a 2073 6361       // #05: sca
-0004cee0: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
-0004cef0: 2020 2020 2020 202f 2f20 6772 6164 5b23         // grad[#
-0004cf00: 3033 5d20 2b3d 2073 6361 6c65 2867 7261  03] += scale(gra
-0004cf10: 645b 2330 355d 2c23 3034 290a 2020 2020  d[#05],#04).    
-0004cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cf30: 2f2f 2023 3033 3a20 7375 6d0a 2020 2020  // #03: sum.    
-0004cf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cf50: 2f2f 2067 7261 645b 2330 325d 202b 3d20  // grad[#02] += 
-0004cf60: 7265 7065 6174 2867 7261 645b 2330 335d  repeat(grad[#03]
-0004cf70: 2c20 2330 3229 0a20 2020 2020 2020 2020  , #02).         
-0004cf80: 2020 2020 2020 2020 2020 202f 2f20 2330             // #0
-0004cf90: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
-0004cfa0: 2020 2020 2020 202f 2f20 6772 6164 5b23         // grad[#
-0004cfb0: 3030 5d20 2b3d 2073 6361 6c65 286d 756c  00] += scale(mul
-0004cfc0: 2823 3030 2c20 6772 6164 5b23 3032 5d29  (#00, grad[#02])
-0004cfd0: 2c20 322e 3029 0a20 2020 2020 2020 2020  , 2.0).         
-0004cfe0: 2020 2020 2020 2020 2020 202f 2f0a 2020             //.  
-0004cff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d000: 2020 2f2f 2073 7562 7374 6974 7574 6520    // substitute 
-0004d010: 616e 6420 7369 6d70 6c69 6679 3a0a 2020  and simplify:.  
-0004d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d030: 2020 2f2f 2067 7261 645b 2330 305d 203d    // grad[#00] =
-0004d040: 2073 6361 6c65 2867 7261 6428 2331 3029   scale(grad(#10)
-0004d050: 2c20 2330 3929 202b 2073 6361 6c65 286d  , #09) + scale(m
-0004d060: 756c 2823 3030 2c20 6772 6164 5b23 3032  ul(#00, grad[#02
-0004d070: 5d29 2c20 322e 3029 0a20 2020 2020 2020  ]), 2.0).       
-0004d080: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0004d090: 6772 6164 5b23 3032 5d20 3d20 7265 7065  grad[#02] = repe
-0004d0a0: 6174 2867 7261 645b 2330 335d 2c20 2330  at(grad[#03], #0
-0004d0b0: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-0004d0c0: 2020 2020 2020 202f 2f20 6772 6164 5b23         // grad[#
-0004d0d0: 3032 5d20 3d20 7265 7065 6174 2873 6361  02] = repeat(sca
-0004d0e0: 6c65 2867 7261 645b 2330 355d 2c23 3034  le(grad[#05],#04
-0004d0f0: 292c 2023 3032 290a 2020 2020 2020 2020  ), #02).        
-0004d100: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
-0004d110: 7261 645b 2330 325d 203d 2072 6570 6561  rad[#02] = repea
-0004d120: 7428 7363 616c 6528 6772 6164 5b23 3037  t(scale(grad[#07
-0004d130: 5d2c 2330 3429 2c20 2330 3229 0a20 2020  ],#04), #02).   
-0004d140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d150: 202f 2f20 6772 6164 5b23 3032 5d20 3d20   // grad[#02] = 
-0004d160: 7265 7065 6174 2873 6361 6c65 286d 756c  repeat(scale(mul
-0004d170: 2867 7261 645b 2330 385d 2c20 6469 7628  (grad[#08], div(
-0004d180: 302e 352c 2023 3038 2929 2c23 3034 292c  0.5, #08)),#04),
-0004d190: 2023 3032 290a 2020 2020 2020 2020 2020   #02).          
-0004d1a0: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
-0004d1b0: 645b 2330 325d 203d 2072 6570 6561 7428  d[#02] = repeat(
-0004d1c0: 7363 616c 6528 6d75 6c28 6e65 6728 6d75  scale(mul(neg(mu
-0004d1d0: 6c28 6772 6164 5b23 3039 5d2c 2064 6976  l(grad[#09], div
-0004d1e0: 2823 3039 2c23 3038 2929 292c 2064 6976  (#09,#08))), div
-0004d1f0: 2830 2e35 2c20 2330 3829 292c 2330 3429  (0.5, #08)),#04)
-0004d200: 2c20 2330 3229 0a20 2020 2020 2020 2020  , #02).         
-0004d210: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
-0004d220: 6164 5b23 3032 5d20 3d20 7265 7065 6174  ad[#02] = repeat
-0004d230: 2873 6361 6c65 286d 756c 286e 6567 286d  (scale(mul(neg(m
-0004d240: 756c 2873 756d 286d 756c 2867 7261 645b  ul(sum(mul(grad[
-0004d250: 2331 305d 2c23 3030 2929 2c20 6469 7628  #10],#00)), div(
-0004d260: 2330 392c 2330 3829 2929 2c20 6469 7628  #09,#08))), div(
-0004d270: 302e 352c 2023 3038 2929 2c23 3034 292c  0.5, #08)),#04),
-0004d280: 2023 3032 290a 2020 2020 2020 2020 2020   #02).          
-0004d290: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
-0004d2a0: 645b 2330 325d 203d 2072 6570 6561 7428  d[#02] = repeat(
-0004d2b0: 2d28 7375 6d28 6d75 6c28 6772 6164 5b23  -(sum(mul(grad[#
-0004d2c0: 3130 5d2c 2330 3029 2920 2a20 6469 7628  10],#00)) * div(
-0004d2d0: 2330 392c 2330 3829 202a 2064 6976 2830  #09,#08) * div(0
-0004d2e0: 2e35 2c20 2330 3829 202a 2028 312f 4e29  .5, #08) * (1/N)
-0004d2f0: 292c 2023 3032 290a 2020 2020 2020 2020  ), #02).        
-0004d300: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
-0004d310: 7261 645b 2330 325d 203d 2072 6570 6561  rad[#02] = repea
-0004d320: 7428 2d28 7375 6d28 6d75 6c28 6772 6164  t(-(sum(mul(grad
-0004d330: 5b23 3130 5d2c 2330 3029 2920 2a20 6469  [#10],#00)) * di
-0004d340: 7628 6469 7628 2330 312c 2330 3829 2c23  v(div(#01,#08),#
-0004d350: 3038 2920 2a20 6469 7628 302e 352c 2023  08) * div(0.5, #
-0004d360: 3038 2920 2a20 2831 2f4e 2929 2c20 2330  08) * (1/N)), #0
-0004d370: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-0004d380: 2020 2020 2020 202f 2f20 6772 6164 5b23         // grad[#
-0004d390: 3032 5d20 3d20 7265 7065 6174 282d 2873  02] = repeat(-(s
-0004d3a0: 756d 286d 756c 2867 7261 645b 2331 305d  um(mul(grad[#10]
-0004d3b0: 2c23 3030 2929 202a 2064 6976 2831 2c23  ,#00)) * div(1,#
-0004d3c0: 3038 2a23 3038 2920 2a20 6469 7628 302e  08*#08) * div(0.
-0004d3d0: 352c 2023 3038 2920 2a20 2831 2f4e 2929  5, #08) * (1/N))
-0004d3e0: 2c20 2330 3229 0a20 2020 2020 2020 2020  , #02).         
-0004d3f0: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
-0004d400: 6164 5b23 3032 5d20 3d20 7265 7065 6174  ad[#02] = repeat
-0004d410: 282d 2873 756d 286d 756c 2867 7261 645b  (-(sum(mul(grad[
-0004d420: 2331 305d 2c23 3030 2929 202a 2064 6976  #10],#00)) * div
-0004d430: 2831 2c23 3037 2920 2a20 6469 7628 302e  (1,#07) * div(0.
-0004d440: 352c 2023 3038 2920 2a20 2831 2f4e 2929  5, #08) * (1/N))
-0004d450: 2c20 2330 3229 0a20 2020 2020 2020 2020  , #02).         
-0004d460: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
-0004d470: 6164 5b23 3030 5d20 3d20 7363 616c 6528  ad[#00] = scale(
-0004d480: 6772 6164 2823 3130 292c 2023 3039 2920  grad(#10), #09) 
-0004d490: 2b20 7363 616c 6528 6d75 6c28 2330 302c  + scale(mul(#00,
-0004d4a0: 2067 7261 645b 2330 325d 292c 2032 2e30   grad[#02]), 2.0
-0004d4b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004d4c0: 2020 2020 2020 2f2f 2067 7261 645b 2330        // grad[#0
-0004d4d0: 305d 203d 2073 6361 6c65 2867 7261 6428  0] = scale(grad(
-0004d4e0: 2331 3029 2c20 2330 3929 202b 2073 6361  #10), #09) + sca
-0004d4f0: 6c65 286d 756c 2823 3030 2c20 7265 7065  le(mul(#00, repe
-0004d500: 6174 282d 2873 756d 286d 756c 2867 7261  at(-(sum(mul(gra
-0004d510: 645b 2331 305d 2c23 3030 2929 202a 2064  d[#10],#00)) * d
-0004d520: 6976 2831 2c23 3037 2920 2a20 6469 7628  iv(1,#07) * div(
-0004d530: 302e 352c 2023 3038 2920 2a20 2831 2f4e  0.5, #08) * (1/N
-0004d540: 2929 2c20 2330 3229 292c 2032 2e30 290a  )), #02)), 2.0).
-0004d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d560: 2020 2020 2f2f 2067 7261 645b 2330 305d      // grad[#00]
-0004d570: 203d 2073 6361 6c65 2867 7261 6428 2331   = scale(grad(#1
-0004d580: 3029 2c20 2330 3929 202b 2073 6361 6c65  0), #09) + scale
-0004d590: 2873 6361 6c65 2823 3030 2c20 2d28 7375  (scale(#00, -(su
-0004d5a0: 6d28 6d75 6c28 6772 6164 5b23 3130 5d2c  m(mul(grad[#10],
-0004d5b0: 2330 3029 2920 2a20 6469 7628 312c 2330  #00)) * div(1,#0
-0004d5c0: 3729 202a 2064 6976 2830 2e35 2c20 2330  7) * div(0.5, #0
-0004d5d0: 3829 202a 2028 312f 4e29 2929 2c20 322e  8) * (1/N))), 2.
-0004d5e0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-0004d5f0: 2020 2020 2020 202f 2f20 6772 6164 5b23         // grad[#
-0004d600: 3030 5d20 3d20 7363 616c 6528 6772 6164  00] = scale(grad
-0004d610: 2823 3130 292c 2023 3039 2920 2b20 7363  (#10), #09) + sc
-0004d620: 616c 6528 2330 302c 202d 2873 756d 286d  ale(#00, -(sum(m
-0004d630: 756c 2867 7261 645b 2331 305d 2c23 3030  ul(grad[#10],#00
-0004d640: 2929 202a 2064 6976 2831 2c23 3037 2920  )) * div(1,#07) 
-0004d650: 2a20 6469 7628 312c 2330 3829 202a 2028  * div(1,#08) * (
-0004d660: 312f 4e29 2929 0a20 2020 2020 2020 2020  1/N))).         
-0004d670: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
-0004d680: 6164 5b23 3030 5d20 3d20 7363 616c 6528  ad[#00] = scale(
-0004d690: 6772 6164 2823 3130 292c 2023 3039 2920  grad(#10), #09) 
-0004d6a0: 2b20 7363 616c 6528 2330 302c 2073 756d  + scale(#00, sum
-0004d6b0: 286d 756c 2867 7261 645b 2331 305d 2c23  (mul(grad[#10],#
-0004d6c0: 3030 2929 202a 2064 6976 2831 2c23 3037  00)) * div(1,#07
-0004d6d0: 2a23 3038 2920 2a20 282d 312f 4e29 290a  *#08) * (-1/N)).
-0004d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d6f0: 2020 2020 2f2f 2067 7261 645b 2330 305d      // grad[#00]
-0004d700: 203d 2073 6361 6c65 2867 7261 6428 2331   = scale(grad(#1
-0004d710: 3029 2c20 2330 3929 202b 2073 6361 6c65  0), #09) + scale
-0004d720: 2823 3030 2c20 7375 6d28 6d75 6c28 6772  (#00, sum(mul(gr
-0004d730: 6164 5b23 3130 5d2c 2330 3029 2920 2a20  ad[#10],#00)) * 
-0004d740: 6469 7628 312c 2330 372a 2330 3829 202a  div(1,#07*#08) *
-0004d750: 2028 2d31 2f4e 2929 0a20 2020 2020 2020   (-1/N)).       
-0004d760: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0004d770: 6772 6164 5b23 3030 5d20 3d20 7363 616c  grad[#00] = scal
-0004d780: 6528 6772 6164 2823 3130 292c 2023 3039  e(grad(#10), #09
-0004d790: 2920 2b20 7363 616c 6528 2330 302c 2073  ) + scale(#00, s
-0004d7a0: 756d 286d 756c 2867 7261 645b 2331 305d  um(mul(grad[#10]
-0004d7b0: 2c23 3030 2929 202a 2064 6976 2831 2c6d  ,#00)) * div(1,m
-0004d7c0: 6561 6e5f 6570 732a 726d 7329 202a 2028  ean_eps*rms) * (
-0004d7d0: 2d31 2f4e 2929 0a20 2020 2020 2020 2020  -1/N)).         
-0004d7e0: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
-0004d7f0: 6164 5b23 3030 5d20 3d20 7363 616c 6528  ad[#00] = scale(
-0004d800: 6772 6164 2823 3130 292c 2023 3039 2920  grad(#10), #09) 
-0004d810: 2b20 7363 616c 6528 2330 302c 2073 756d  + scale(#00, sum
-0004d820: 286d 756c 2867 7261 645b 2331 305d 2c23  (mul(grad[#10],#
-0004d830: 3030 2929 202a 2064 6976 282d 312c 726d  00)) * div(-1,rm
-0004d840: 732a 4e2a 6d65 616e 5f65 7073 2929 0a20  s*N*mean_eps)). 
-0004d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d860: 2020 202f 2f20 6772 6164 5b23 3030 5d20     // grad[#00] 
-0004d870: 3d20 7363 616c 6528 6772 6164 2823 3130  = scale(grad(#10
-0004d880: 292c 2023 3039 2920 2b20 7363 616c 6528  ), #09) + scale(
-0004d890: 2330 302c 2073 756d 286d 756c 2867 7261  #00, sum(mul(gra
-0004d8a0: 645b 2331 305d 2c23 3030 2929 202a 2064  d[#10],#00)) * d
-0004d8b0: 6976 282d 312c 726d 732a 4e2a 2873 756d  iv(-1,rms*N*(sum
-0004d8c0: 5f78 782f 4e2b 6570 7329 2929 0a20 2020  _xx/N+eps))).   
-0004d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d8e0: 202f 2f20 6772 6164 5b23 3030 5d20 3d20   // grad[#00] = 
-0004d8f0: 7363 616c 6528 6772 6164 2823 3130 292c  scale(grad(#10),
-0004d900: 2023 3039 2920 2b20 7363 616c 6528 2330   #09) + scale(#0
-0004d910: 302c 2073 756d 286d 756c 2867 7261 645b  0, sum(mul(grad[
-0004d920: 2331 305d 2c23 3030 2929 202a 2064 6976  #10],#00)) * div
-0004d930: 282d 312c 726d 732a 4e2a 7375 6d5f 7878  (-1,rms*N*sum_xx
-0004d940: 2b72 6d73 2a4e 2a65 7073 2929 0a20 2020  +rms*N*eps)).   
-0004d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d960: 202f 2f20 6772 6164 5b23 3030 5d20 3d20   // grad[#00] = 
-0004d970: 7363 616c 6528 647a 2c20 7272 6d73 2920  scale(dz, rrms) 
-0004d980: 2b20 7363 616c 6528 782c 2073 756d 286d  + scale(x, sum(m
-0004d990: 756c 2864 7a2c 7829 2920 2a20 6469 7628  ul(dz,x)) * div(
-0004d9a0: 2d31 2c72 6d73 2a4e 2a6d 6561 6e5f 6570  -1,rms*N*mean_ep
-0004d9b0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0004d9c0: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
-0004d9d0: 2330 305d 203d 2073 6361 6c65 2864 7a2c  #00] = scale(dz,
-0004d9e0: 2072 726d 7329 202b 2073 6361 6c65 2878   rrms) + scale(x
-0004d9f0: 2c20 7375 6d5f 7864 7a20 2a20 6469 7628  , sum_xdz * div(
-0004da00: 2d31 2c72 6d73 2a4e 2a6d 6561 6e5f 6570  -1,rms*N*mean_ep
-0004da10: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0004da20: 2020 2020 2020 2020 2f2f 2061 203d 2062          // a = b
-0004da30: 2a63 202b 2064 2a65 0a20 2020 2020 2020  *c + d*e.       
-0004da40: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0004da50: 6120 3d20 622a 632a 662f 6620 2b20 642a  a = b*c*f/f + d*
-0004da60: 652a 662f 660a 2020 2020 2020 2020 2020  e*f/f.          
-0004da70: 2020 2020 2020 2020 2020 2f2f 2061 203d            // a =
-0004da80: 2028 622a 632a 6620 2b20 642a 652a 6629   (b*c*f + d*e*f)
-0004da90: 2a28 312f 6629 0a20 2020 2020 2020 2020  *(1/f).         
-0004daa0: 2020 2020 2020 2020 2020 202f 2f20 6120             // a 
-0004dab0: 3d20 2862 2a63 2a28 312f 6329 202b 2064  = (b*c*(1/c) + d
-0004dac0: 2a65 2a28 312f 6329 292a 2831 2f28 312f  *e*(1/c))*(1/(1/
-0004dad0: 6329 290a 2020 2020 2020 2020 2020 2020  c)).            
-0004dae0: 2020 2020 2020 2020 2f2f 2061 203d 2028          // a = (
-0004daf0: 6220 2b20 642a 652f 6329 2a63 0a20 2020  b + d*e/c)*c.   
-0004db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004db10: 202f 2f20 6220 3d20 647a 2c20 6320 3d20   // b = dz, c = 
-0004db20: 7272 6d73 2c20 6420 3d20 782c 2065 203d  rrms, d = x, e =
-0004db30: 2073 756d 5f78 647a 202a 2064 6976 282d   sum_xdz * div(-
-0004db40: 312c 726d 732a 4e2a 6d65 616e 5f65 7073  1,rms*N*mean_eps
-0004db50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004db60: 2020 2020 2020 2f2f 2061 203d 2028 647a        // a = (dz
-0004db70: 202b 2078 2a73 756d 5f78 647a 202a 2064   + x*sum_xdz * d
-0004db80: 6976 282d 312c 726d 732a 4e2a 6d65 616e  iv(-1,rms*N*mean
-0004db90: 5f65 7073 292f 7272 6d73 292a 7272 6d73  _eps)/rrms)*rrms
-0004dba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004dbb0: 2020 2020 202f 2f20 6120 3d20 2864 7a20       // a = (dz 
-0004dbc0: 2b20 782a 7375 6d5f 7864 7a20 2a20 6469  + x*sum_xdz * di
-0004dbd0: 7628 2d31 2c72 6d73 2a4e 2a6d 6561 6e5f  v(-1,rms*N*mean_
-0004dbe0: 6570 7329 2a72 6d73 292a 7272 6d73 0a20  eps)*rms)*rrms. 
-0004dbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004dc00: 2020 202f 2f20 6120 3d20 2864 7a20 2b20     // a = (dz + 
-0004dc10: 782a 7375 6d5f 7864 7a20 2a20 6469 7628  x*sum_xdz * div(
-0004dc20: 2d72 6d73 2c72 6d73 2a4e 2a6d 6561 6e5f  -rms,rms*N*mean_
-0004dc30: 6570 7329 292a 7272 6d73 0a20 2020 2020  eps))*rrms.     
-0004dc40: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0004dc50: 2f20 6120 3d20 2864 7a20 2b20 782a 7375  / a = (dz + x*su
-0004dc60: 6d5f 7864 7a20 2a20 6469 7628 2d31 2c4e  m_xdz * div(-1,N
-0004dc70: 2a6d 6561 6e5f 6570 7329 292a 7272 6d73  *mean_eps))*rrms
-0004dc80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004dc90: 2020 2020 202f 2f20 6120 3d20 2864 7a20       // a = (dz 
-0004dca0: 2b20 782a 6469 7628 2d73 756d 5f78 647a  + x*div(-sum_xdz
-0004dcb0: 2c4e 2a6d 6561 6e5f 6570 7329 292a 7272  ,N*mean_eps))*rr
-0004dcc0: 6d73 0a20 2020 2020 2020 2020 2020 2020  ms.             
-0004dcd0: 2020 2020 2020 202f 2f20 6120 3d20 2864         // a = (d
-0004dce0: 7a20 2b20 782a 6469 7628 2d6d 6561 6e5f  z + x*div(-mean_
-0004dcf0: 7864 7a2c 6d65 616e 5f65 7073 2929 2a72  xdz,mean_eps))*r
-0004dd00: 726d 730a 2020 2020 2020 2020 2020 2020  rms.            
-0004dd10: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
-0004dd20: 2330 305d 203d 2073 6361 6c65 2864 7a20  #00] = scale(dz 
-0004dd30: 2b20 7363 616c 6528 782c 2064 6976 282d  + scale(x, div(-
-0004dd40: 6d65 616e 5f78 647a 2c6d 6561 6e5f 6570  mean_xdz,mean_ep
-0004dd50: 7329 292c 7272 6d73 290a 2020 2020 2020  s)),rrms).      
-0004dd60: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0004dd70: 2067 7261 645b 2330 305d 203d 2073 6361   grad[#00] = sca
-0004dd80: 6c65 2864 7a20 2b20 7363 616c 6528 782c  le(dz + scale(x,
-0004dd90: 202d 6d65 616e 5f78 647a 2f6d 6561 6e5f   -mean_xdz/mean_
-0004dda0: 6570 7329 2c72 726d 7329 0a20 2020 2020  eps),rrms).     
-0004ddb0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0004ddc0: 2f20 6478 203d 2073 6361 6c65 2864 7a20  / dx = scale(dz 
-0004ddd0: 2b20 7363 616c 6528 782c 202d 6d65 616e  + scale(x, -mean
-0004dde0: 5f78 647a 2f6d 6561 6e5f 6570 7329 2c72  _xdz/mean_eps),r
-0004ddf0: 726d 7329 0a20 2020 2020 2020 2020 2020  rms).           
-0004de00: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0004de10: 2020 2020 2020 202f 2f20 6478 203d 2073         // dx = s
-0004de20: 6361 6c65 2864 7a20 2b20 7363 616c 6528  cale(dz + scale(
-0004de30: 782c 202d 6d65 616e 5f78 647a 2f6d 6561  x, -mean_xdz/mea
-0004de40: 6e5f 6570 7329 2c72 726d 7329 0a20 2020  n_eps),rrms).   
-0004de50: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0004de60: 706f 7374 2d6f 7264 6572 3a0a 2020 2020  post-order:.    
-0004de70: 2020 2020 2020 2020 2020 2020 2f2f 2064              // d
-0004de80: 7820 3a3d 2078 0a20 2020 2020 2020 2020  x := x.         
-0004de90: 2020 2020 2020 202f 2f20 6478 203a 3d20         // dx := 
-0004dea0: 7363 616c 6528 6478 2c2d 6d65 616e 5f78  scale(dx,-mean_x
-0004deb0: 647a 2f6d 6561 6e5f 6570 7329 0a20 2020  dz/mean_eps).   
-0004dec0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0004ded0: 6478 203a 3d20 6164 6428 6478 2c20 647a  dx := add(dx, dz
-0004dee0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004def0: 2020 2f2f 2064 7820 3a3d 2073 6361 6c65    // dx := scale
-0004df00: 2864 782c 2072 726d 7329 0a20 2020 2020  (dx, rrms).     
-0004df10: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-0004df20: 202a 2064 7820 3d20 2866 6c6f 6174 202a   * dx = (float *
-0004df30: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
-0004df40: 3e64 6174 6120 2b20 6930 312a 6e62 3120  >data + i01*nb1 
-0004df50: 2b20 6930 322a 6e62 3220 2b20 6930 332a  + i02*nb2 + i03*
-0004df60: 6e62 3329 3b0a 0a20 2020 2020 2020 2020  nb3);..         
-0004df70: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0004df80: 6370 795f 6633 3220 2028 6e65 3030 2c20  cpy_f32  (ne00, 
-0004df90: 6478 2c20 7829 3b0a 2020 2020 2020 2020  dx, x);.        
-0004dfa0: 2020 2020 2020 2020 2f2f 2067 676d 6c5f          // ggml_
-0004dfb0: 7665 635f 7363 616c 655f 6633 3228 6e65  vec_scale_f32(ne
-0004dfc0: 3030 2c20 6478 2c20 2d6d 6561 6e5f 7864  00, dx, -mean_xd
-0004dfd0: 7a2f 6d65 616e 5f65 7073 293b 0a20 2020  z/mean_eps);.   
-0004dfe0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0004dff0: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
-0004e000: 6e65 3030 2c20 6478 2c20 2866 6c6f 6174  ne00, dx, (float
-0004e010: 2928 2d73 756d 5f78 647a 292f 7375 6d5f  )(-sum_xdz)/sum_
-0004e020: 6570 7329 3b0a 2020 2020 2020 2020 2020  eps);.          
-0004e030: 2020 2020 2020 6767 6d6c 5f76 6563 5f61        ggml_vec_a
-0004e040: 6363 5f66 3332 2020 286e 6530 302c 2064  cc_f32  (ne00, d
-0004e050: 782c 2064 7a29 3b0a 2020 2020 2020 2020  x, dz);.        
-0004e060: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0004e070: 5f73 6361 6c65 5f66 3332 286e 6530 302c  _scale_f32(ne00,
-0004e080: 2064 782c 2072 726d 7329 3b0a 2020 2020   dx, rrms);.    
-0004e090: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0004e0a0: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
-0004e0b0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-0004e0c0: 6d70 7574 655f 666f 7277 6172 645f 726d  mpute_forward_rm
-0004e0d0: 735f 6e6f 726d 5f62 6163 6b28 0a20 2020  s_norm_back(.   
-0004e0e0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0004e0f0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-0004e100: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-0004e110: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0004e120: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004e130: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-0004e140: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0004e150: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-0004e160: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0004e170: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-0004e180: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
-0004e190: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
-0004e1a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0004e1b0: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
-0004e1c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0004e1d0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-0004e1e0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
-0004e1f0: 6d73 5f6e 6f72 6d5f 6261 636b 5f66 3332  ms_norm_back_f32
-0004e200: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
-0004e210: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
-0004e220: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0004e230: 2020 2020 2020 2020 6465 6661 756c 743a          default:
-0004e240: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0004e250: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-0004e260: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-0004e270: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0004e280: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-0004e290: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-0004e2a0: 655f 666f 7277 6172 645f 6d75 6c5f 6d61  e_forward_mul_ma
-0004e2b0: 740a 0a23 6966 2064 6566 696e 6564 2847  t..#if defined(G
-0004e2c0: 474d 4c5f 5553 455f 4143 4345 4c45 5241  GML_USE_ACCELERA
-0004e2d0: 5445 2920 7c7c 2064 6566 696e 6564 2847  TE) || defined(G
-0004e2e0: 474d 4c5f 5553 455f 4f50 454e 424c 4153  GML_USE_OPENBLAS
-0004e2f0: 290a 2f2f 2068 656c 7065 7220 6675 6e63  ).// helper func
-0004e300: 7469 6f6e 2074 6f20 6465 7465 726d 696e  tion to determin
-0004e310: 6520 6966 2069 7420 6973 2062 6574 7465  e if it is bette
-0004e320: 7220 746f 2075 7365 2042 4c41 5320 6f72  r to use BLAS or
-0004e330: 206e 6f74 0a2f 2f20 666f 7220 6c61 7267   not.// for larg
-0004e340: 6520 6d61 7472 6963 6573 2c20 424c 4153  e matrices, BLAS
-0004e350: 2069 7320 6661 7374 6572 0a73 7461 7469   is faster.stati
-0004e360: 6320 626f 6f6c 2067 676d 6c5f 636f 6d70  c bool ggml_comp
-0004e370: 7574 655f 666f 7277 6172 645f 6d75 6c5f  ute_forward_mul_
-0004e380: 6d61 745f 7573 655f 626c 6173 280a 2020  mat_use_blas(.  
-0004e390: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0004e3a0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0004e3b0: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-0004e3c0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0004e3d0: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-0004e3e0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0004e3f0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0004e400: 202a 2064 7374 2920 7b0a 2020 2020 2f2f   * dst) {.    //
-0004e410: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0004e420: 3030 203d 2073 7263 302d 3e6e 655b 305d  00 = src0->ne[0]
-0004e430: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0004e440: 7436 345f 7420 6e65 3031 203d 2073 7263  t64_t ne01 = src
-0004e450: 302d 3e6e 655b 315d 3b0a 0a20 2020 2063  0->ne[1];..    c
-0004e460: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-0004e470: 3020 3d20 7372 6331 2d3e 6e65 5b30 5d3b  0 = src1->ne[0];
-0004e480: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-0004e490: 345f 7420 6e65 3020 3d20 6473 742d 3e6e  4_t ne0 = dst->n
-0004e4a0: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-0004e4b0: 696e 7436 345f 7420 6e65 3120 3d20 6473  int64_t ne1 = ds
-0004e4c0: 742d 3e6e 655b 315d 3b0a 0a20 2020 202f  t->ne[1];..    /
-0004e4d0: 2f20 544f 444f 3a20 6669 6e64 2074 6865  / TODO: find the
-0004e4e0: 206f 7074 696d 616c 2076 616c 7565 7320   optimal values 
-0004e4f0: 666f 7220 7468 6573 650a 2020 2020 6966  for these.    if
-0004e500: 2028 6767 6d6c 5f69 735f 636f 6e74 6967   (ggml_is_contig
-0004e510: 756f 7573 2873 7263 3029 2026 260a 2020  uous(src0) &&.  
-0004e520: 2020 2020 2020 6767 6d6c 5f69 735f 636f        ggml_is_co
-0004e530: 6e74 6967 756f 7573 2873 7263 3129 2026  ntiguous(src1) &
-0004e540: 260a 2020 2020 2020 2020 286e 6530 203e  &.        (ne0 >
-0004e550: 3d20 3332 2026 2620 6e65 3120 3e3d 2033  = 32 && ne1 >= 3
-0004e560: 3220 2626 206e 6531 3020 3e3d 2033 3229  2 && ne10 >= 32)
-0004e570: 2920 7b0a 0a20 2020 2020 2020 202f 2a70  ) {..        /*p
-0004e580: 7269 6e74 6628 2242 4c41 533a 2025 6420  rintf("BLAS: %d 
-0004e590: 2564 2025 6420 2564 2025 645c 6e22 2c20  %d %d %d %d\n", 
-0004e5a0: 6e65 302c 206e 6531 2c20 6e65 3130 2c20  ne0, ne1, ne10, 
-0004e5b0: 6e65 3030 2c20 6e65 3031 293b 2a2f 0a20  ne00, ne01);*/. 
-0004e5c0: 2020 2020 2020 2072 6574 7572 6e20 7472         return tr
-0004e5d0: 7565 3b0a 2020 2020 7d0a 0a20 2020 2072  ue;.    }..    r
-0004e5e0: 6574 7572 6e20 6661 6c73 653b 0a7d 0a23  eturn false;.}.#
-0004e5f0: 656e 6469 660a 0a73 7461 7469 6320 766f  endif..static vo
-0004e600: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-0004e610: 666f 7277 6172 645f 6d75 6c5f 6d61 745f  forward_mul_mat_
-0004e620: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
-0004e630: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-0004e640: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-0004e650: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-0004e660: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0004e670: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-0004e680: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0004e690: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0004e6a0: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-0004e6b0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0004e6c0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-0004e6d0: 2920 7b0a 2020 2020 696e 7436 345f 7420  ) {.    int64_t 
-0004e6e0: 7430 203d 2067 676d 6c5f 7065 7266 5f74  t0 = ggml_perf_t
-0004e6f0: 696d 655f 7573 2829 3b0a 2020 2020 554e  ime_us();.    UN
-0004e700: 5553 4544 2874 3029 3b0a 0a20 2020 2063  USED(t0);..    c
-0004e710: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
-0004e720: 3020 3d20 7372 6330 2d3e 6e65 5b30 5d3b  0 = src0->ne[0];
-0004e730: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-0004e740: 5f74 206e 6530 3120 3d20 7372 6330 2d3e  _t ne01 = src0->
-0004e750: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
-0004e760: 2069 6e74 3634 5f74 206e 6530 3220 3d20   int64_t ne02 = 
-0004e770: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
-0004e780: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-0004e790: 6530 3320 3d20 7372 6330 2d3e 6e65 5b33  e03 = src0->ne[3
-0004e7a0: 5d3b 0a0a 2369 6620 6465 6669 6e65 6428  ];..#if defined(
-0004e7b0: 4747 4d4c 5f55 5345 5f41 4343 454c 4552  GGML_USE_ACCELER
-0004e7c0: 4154 4529 207c 7c20 6465 6669 6e65 6428  ATE) || defined(
-0004e7d0: 4747 4d4c 5f55 5345 5f4f 5045 4e42 4c41  GGML_USE_OPENBLA
-0004e7e0: 5329 0a20 2020 2063 6f6e 7374 2069 6e74  S).    const int
-0004e7f0: 3634 5f74 206e 6531 3020 3d20 7372 6331  64_t ne10 = src1
-0004e800: 2d3e 6e65 5b30 5d3b 0a23 656e 6469 660a  ->ne[0];.#endif.
-0004e810: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0004e820: 7420 6e65 3131 203d 2073 7263 312d 3e6e  t ne11 = src1->n
-0004e830: 655b 315d 3b0a 2369 666e 6465 6620 4e44  e[1];.#ifndef ND
-0004e840: 4542 5547 0a20 2020 2063 6f6e 7374 2069  EBUG.    const i
-0004e850: 6e74 3634 5f74 206e 6531 3220 3d20 7372  nt64_t ne12 = sr
-0004e860: 6331 2d3e 6e65 5b32 5d3b 0a20 2020 2063  c1->ne[2];.    c
-0004e870: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-0004e880: 3320 3d20 7372 6331 2d3e 6e65 5b33 5d3b  3 = src1->ne[3];
-0004e890: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-0004e8a0: 345f 7420 6e65 3020 203d 2064 7374 2d3e  4_t ne0  = dst->
-0004e8b0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-0004e8c0: 2069 6e74 3634 5f74 206e 6531 2020 3d20   int64_t ne1  = 
-0004e8d0: 6473 742d 3e6e 655b 315d 3b0a 2020 2020  dst->ne[1];.    
-0004e8e0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0004e8f0: 3220 203d 2064 7374 2d3e 6e65 5b32 5d3b  2  = dst->ne[2];
-0004e900: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-0004e910: 5f74 206e 6533 2020 3d20 6473 742d 3e6e  _t ne3  = dst->n
-0004e920: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
-0004e930: 2069 6e74 206e 6230 3020 3d20 7372 6330   int nb00 = src0
-0004e940: 2d3e 6e62 5b30 5d3b 0a23 656e 6469 660a  ->nb[0];.#endif.
-0004e950: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-0004e960: 3031 203d 2073 7263 302d 3e6e 625b 315d  01 = src0->nb[1]
-0004e970: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0004e980: 6e62 3032 203d 2073 7263 302d 3e6e 625b  nb02 = src0->nb[
-0004e990: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
-0004e9a0: 7420 6e62 3033 203d 2073 7263 302d 3e6e  t nb03 = src0->n
-0004e9b0: 625b 335d 3b0a 0a23 6966 6e64 6566 204e  b[3];..#ifndef N
-0004e9c0: 4445 4255 470a 2020 2020 636f 6e73 7420  DEBUG.    const 
-0004e9d0: 696e 7420 6e62 3130 203d 2073 7263 312d  int nb10 = src1-
-0004e9e0: 3e6e 625b 305d 3b0a 2365 6e64 6966 0a20  >nb[0];.#endif. 
-0004e9f0: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
-0004ea00: 3120 3d20 7372 6331 2d3e 6e62 5b31 5d3b  1 = src1->nb[1];
-0004ea10: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0004ea20: 6231 3220 3d20 7372 6331 2d3e 6e62 5b32  b12 = src1->nb[2
-0004ea30: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0004ea40: 206e 6231 3320 3d20 7372 6331 2d3e 6e62   nb13 = src1->nb
-0004ea50: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-0004ea60: 696e 7420 6e62 3020 203d 2064 7374 2d3e  int nb0  = dst->
-0004ea70: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-0004ea80: 2069 6e74 206e 6231 2020 3d20 6473 742d   int nb1  = dst-
-0004ea90: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-0004eaa0: 7420 696e 7420 6e62 3220 203d 2064 7374  t int nb2  = dst
-0004eab0: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-0004eac0: 7374 2069 6e74 206e 6233 2020 3d20 6473  st int nb3  = ds
-0004ead0: 742d 3e6e 625b 335d 3b0a 0a20 2020 2063  t->nb[3];..    c
-0004eae0: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
-0004eaf0: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
-0004eb00: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
-0004eb10: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
-0004eb20: 2020 6173 7365 7274 286e 6530 3220 3d3d    assert(ne02 ==
-0004eb30: 206e 6531 3229 3b0a 2020 2020 6173 7365   ne12);.    asse
-0004eb40: 7274 286e 6530 3320 3d3d 206e 6531 3329  rt(ne03 == ne13)
-0004eb50: 3b0a 2020 2020 6173 7365 7274 286e 6532  ;.    assert(ne2
-0004eb60: 2020 3d3d 206e 6531 3229 3b0a 2020 2020    == ne12);.    
-0004eb70: 6173 7365 7274 286e 6533 2020 3d3d 206e  assert(ne3  == n
-0004eb80: 6531 3329 3b0a 0a20 2020 202f 2f20 7765  e13);..    // we
-0004eb90: 2064 6f6e 2774 2073 7570 706f 7274 2070   don't support p
-0004eba0: 6572 6d75 7465 6420 7372 6330 206f 7220  ermuted src0 or 
-0004ebb0: 7372 6331 0a20 2020 2061 7373 6572 7428  src1.    assert(
-0004ebc0: 6e62 3030 203d 3d20 7369 7a65 6f66 2866  nb00 == sizeof(f
-0004ebd0: 6c6f 6174 2929 3b0a 2020 2020 6173 7365  loat));.    asse
-0004ebe0: 7274 286e 6231 3020 3d3d 2073 697a 656f  rt(nb10 == sizeo
-0004ebf0: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
-0004ec00: 2f2f 2064 7374 2063 616e 6e6f 7420 6265  // dst cannot be
-0004ec10: 2074 7261 6e73 706f 7365 6420 6f72 2070   transposed or p
-0004ec20: 6572 6d75 7465 640a 2020 2020 6173 7365  ermuted.    asse
-0004ec30: 7274 286e 6230 203d 3d20 7369 7a65 6f66  rt(nb0 == sizeof
-0004ec40: 2866 6c6f 6174 2929 3b0a 2020 2020 6173  (float));.    as
-0004ec50: 7365 7274 286e 6230 203c 3d20 6e62 3129  sert(nb0 <= nb1)
-0004ec60: 3b0a 2020 2020 6173 7365 7274 286e 6231  ;.    assert(nb1
-0004ec70: 203c 3d20 6e62 3229 3b0a 2020 2020 6173   <= nb2);.    as
-0004ec80: 7365 7274 286e 6232 203c 3d20 6e62 3329  sert(nb2 <= nb3)
-0004ec90: 3b0a 0a20 2020 2061 7373 6572 7428 6e65  ;..    assert(ne
-0004eca0: 3020 3d3d 206e 6530 3129 3b0a 2020 2020  0 == ne01);.    
-0004ecb0: 6173 7365 7274 286e 6531 203d 3d20 6e65  assert(ne1 == ne
-0004ecc0: 3131 293b 0a20 2020 2061 7373 6572 7428  11);.    assert(
-0004ecd0: 6e65 3220 3d3d 206e 6530 3229 3b0a 2020  ne2 == ne02);.  
-0004ece0: 2020 6173 7365 7274 286e 6533 203d 3d20    assert(ne3 == 
-0004ecf0: 6e65 3033 293b 0a0a 2020 2020 2f2f 206e  ne03);..    // n
-0004ed00: 6230 3120 3e3d 206e 6230 3020 2d20 7372  b01 >= nb00 - sr
-0004ed10: 6330 2069 7320 6e6f 7420 7472 616e 7370  c0 is not transp
-0004ed20: 6f73 6564 0a20 2020 202f 2f20 2020 636f  osed.    //   co
-0004ed30: 6d70 7574 6520 6279 2073 7263 3020 726f  mpute by src0 ro
-0004ed40: 7773 0a0a 2369 6620 6465 6669 6e65 6428  ws..#if defined(
-0004ed50: 4747 4d4c 5f55 5345 5f43 4c42 4c41 5354  GGML_USE_CLBLAST
-0004ed60: 290a 2020 2020 6966 2028 6767 6d6c 5f63  ).    if (ggml_c
-0004ed70: 6c5f 6361 6e5f 6d75 6c5f 6d61 7428 7372  l_can_mul_mat(sr
-0004ed80: 6330 2c20 7372 6331 2c20 6473 7429 2920  c0, src1, dst)) 
-0004ed90: 7b0a 2020 2020 2020 2020 6966 2028 7061  {.        if (pa
-0004eda0: 7261 6d73 2d3e 6974 6820 3d3d 2030 2026  rams->ith == 0 &
-0004edb0: 2620 7061 7261 6d73 2d3e 7479 7065 203d  & params->type =
-0004edc0: 3d20 4747 4d4c 5f54 4153 4b5f 434f 4d50  = GGML_TASK_COMP
-0004edd0: 5554 4529 207b 0a20 2020 2020 2020 2020  UTE) {.         
-0004ede0: 2020 2067 676d 6c5f 636c 5f6d 756c 5f6d     ggml_cl_mul_m
-0004edf0: 6174 2873 7263 302c 2073 7263 312c 2064  at(src0, src1, d
-0004ee00: 7374 2c20 7061 7261 6d73 2d3e 7764 6174  st, params->wdat
-0004ee10: 612c 2070 6172 616d 732d 3e77 7369 7a65  a, params->wsize
-0004ee20: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
-0004ee30: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-0004ee40: 207d 0a23 656e 6469 660a 0a23 6966 2064   }.#endif..#if d
-0004ee50: 6566 696e 6564 2847 474d 4c5f 5553 455f  efined(GGML_USE_
-0004ee60: 4143 4345 4c45 5241 5445 2920 7c7c 2064  ACCELERATE) || d
-0004ee70: 6566 696e 6564 2847 474d 4c5f 5553 455f  efined(GGML_USE_
-0004ee80: 4f50 454e 424c 4153 290a 2020 2020 6966  OPENBLAS).    if
-0004ee90: 2028 6767 6d6c 5f63 6f6d 7075 7465 5f66   (ggml_compute_f
-0004eea0: 6f72 7761 7264 5f6d 756c 5f6d 6174 5f75  orward_mul_mat_u
-0004eeb0: 7365 5f62 6c61 7328 7372 6330 2c20 7372  se_blas(src0, sr
-0004eec0: 6331 2c20 6473 7429 2920 7b0a 2020 2020  c1, dst)) {.    
+0004c9d0: 2020 2831 2e30 2f4e 2929 2c0a 2020 2020    (1.0/N)),.    
+0004c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c9f0: 2f2f 2020 2020 2020 2020 2020 2020 2020  //              
+0004ca00: 2020 2020 2020 2065 7073 2929 2929 3b0a         eps))));.
+0004ca10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004ca20: 2020 2020 202f 2f20 706f 7374 6f72 6465       // postorde
+0004ca30: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0004ca40: 2020 2020 2020 202f 2f20 2323 206f 7020         // ## op 
+0004ca50: 2020 2061 7267 7320 2020 2020 2020 2020     args         
+0004ca60: 6772 6164 0a20 2020 2020 2020 2020 2020  grad.           
+0004ca70: 2020 2020 2020 2020 202f 2f20 3030 2070           // 00 p
+0004ca80: 6172 616d 2073 7263 3020 2020 2020 2020  aram src0       
+0004ca90: 2020 6772 6164 5b23 3030 5d0a 2020 2020    grad[#00].    
+0004caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cab0: 2f2f 2030 3120 636f 6e73 7420 310a 2020  // 01 const 1.  
+0004cac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cad0: 2020 2f2f 2030 3220 7371 7220 2020 2823    // 02 sqr   (#
+0004cae0: 3030 2920 2020 2020 2020 2067 7261 645b  00)        grad[
+0004caf0: 2330 325d 0a20 2020 2020 2020 2020 2020  #02].           
+0004cb00: 2020 2020 2020 2020 202f 2f20 3033 2073           // 03 s
+0004cb10: 756d 2020 2028 2330 3229 2020 2020 2020  um   (#02)      
+0004cb20: 2020 6772 6164 5b23 3033 5d0a 2020 2020    grad[#03].    
+0004cb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cb40: 2f2f 2030 3420 636f 6e73 7420 312f 4e0a  // 04 const 1/N.
+0004cb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cb60: 2020 2020 2f2f 2030 3520 7363 616c 6520      // 05 scale 
+0004cb70: 2823 3033 2c20 2330 3429 2020 2067 7261  (#03, #04)   gra
+0004cb80: 645b 2330 355d 0a20 2020 2020 2020 2020  d[#05].         
+0004cb90: 2020 2020 2020 2020 2020 202f 2f20 3036             // 06
+0004cba0: 2063 6f6e 7374 2065 7073 0a20 2020 2020   const eps.     
+0004cbb0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0004cbc0: 2f20 3037 2061 6464 2020 2028 2330 352c  / 07 add   (#05,
+0004cbd0: 2023 3036 2920 2020 6772 6164 5b23 3037   #06)   grad[#07
+0004cbe0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0004cbf0: 2020 2020 2020 2f2f 2030 3820 7371 7274        // 08 sqrt
+0004cc00: 2020 2823 3037 2920 2020 2020 2020 2067    (#07)        g
+0004cc10: 7261 645b 2330 385d 0a20 2020 2020 2020  rad[#08].       
+0004cc20: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0004cc30: 3039 2064 6976 2020 2028 2330 312c 2330  09 div   (#01,#0
+0004cc40: 3829 2020 2020 6772 6164 5b23 3039 5d0a  8)    grad[#09].
+0004cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cc60: 2020 2020 2f2f 2031 3020 7363 616c 6520      // 10 scale 
+0004cc70: 2823 3030 2c23 3039 2920 2020 2067 7261  (#00,#09)    gra
+0004cc80: 645b 2331 305d 0a20 2020 2020 2020 2020  d[#10].         
+0004cc90: 2020 2020 2020 2020 2020 202f 2f0a 2020             //.  
+0004cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ccb0: 2020 2f2f 2062 6163 6b77 6172 6420 7061    // backward pa
+0004ccc0: 7373 2c20 6769 7665 6e20 6772 6164 5b23  ss, given grad[#
+0004ccd0: 3130 5d0a 2020 2020 2020 2020 2020 2020  10].            
+0004cce0: 2020 2020 2020 2020 2f2f 2023 3130 3a20          // #10: 
+0004ccf0: 7363 616c 650a 2020 2020 2020 2020 2020  scale.          
+0004cd00: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
+0004cd10: 645b 2330 305d 202b 3d20 7363 616c 6528  d[#00] += scale(
+0004cd20: 6772 6164 5b23 3130 5d2c 2330 3929 0a20  grad[#10],#09). 
+0004cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cd40: 2020 202f 2f20 6772 6164 5b23 3039 5d20     // grad[#09] 
+0004cd50: 2b3d 2073 756d 286d 756c 2867 7261 645b  += sum(mul(grad[
+0004cd60: 2331 305d 2c23 3030 2929 0a20 2020 2020  #10],#00)).     
+0004cd70: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0004cd80: 2f20 2330 393a 2064 6976 0a20 2020 2020  / #09: div.     
+0004cd90: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0004cda0: 2f20 6772 6164 5b23 3038 5d20 2b3d 206e  / grad[#08] += n
+0004cdb0: 6567 286d 756c 2867 7261 645b 2330 395d  eg(mul(grad[#09]
+0004cdc0: 2c20 6469 7628 2330 392c 2330 3829 2929  , div(#09,#08)))
+0004cdd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004cde0: 2020 2020 202f 2f20 2330 383a 2073 7172       // #08: sqr
+0004cdf0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+0004ce00: 2020 2020 2020 2f2f 2067 7261 645b 2330        // grad[#0
+0004ce10: 375d 202b 3d20 6d75 6c28 6772 6164 5b23  7] += mul(grad[#
+0004ce20: 3038 5d2c 2064 6976 2830 2e35 2c20 2330  08], div(0.5, #0
+0004ce30: 3829 290a 2020 2020 2020 2020 2020 2020  8)).            
+0004ce40: 2020 2020 2020 2020 2f2f 2023 3037 3a20          // #07: 
+0004ce50: 6164 640a 2020 2020 2020 2020 2020 2020  add.            
+0004ce60: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+0004ce70: 2330 355d 202b 3d20 6772 6164 5b23 3037  #05] += grad[#07
+0004ce80: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0004ce90: 2020 2020 2020 2f2f 2023 3035 3a20 7363        // #05: sc
+0004cea0: 616c 650a 2020 2020 2020 2020 2020 2020  ale.            
+0004ceb0: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+0004cec0: 2330 335d 202b 3d20 7363 616c 6528 6772  #03] += scale(gr
+0004ced0: 6164 5b23 3035 5d2c 2330 3429 0a20 2020  ad[#05],#04).   
+0004cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cef0: 202f 2f20 2330 333a 2073 756d 0a20 2020   // #03: sum.   
+0004cf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cf10: 202f 2f20 6772 6164 5b23 3032 5d20 2b3d   // grad[#02] +=
+0004cf20: 2072 6570 6561 7428 6772 6164 5b23 3033   repeat(grad[#03
+0004cf30: 5d2c 2023 3032 290a 2020 2020 2020 2020  ], #02).        
+0004cf40: 2020 2020 2020 2020 2020 2020 2f2f 2023              // #
+0004cf50: 3032 3a0a 2020 2020 2020 2020 2020 2020  02:.            
+0004cf60: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+0004cf70: 2330 305d 202b 3d20 7363 616c 6528 6d75  #00] += scale(mu
+0004cf80: 6c28 2330 302c 2067 7261 645b 2330 325d  l(#00, grad[#02]
+0004cf90: 292c 2032 2e30 290a 2020 2020 2020 2020  ), 2.0).        
+0004cfa0: 2020 2020 2020 2020 2020 2020 2f2f 0a20              //. 
+0004cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cfc0: 2020 202f 2f20 7375 6273 7469 7475 7465     // substitute
+0004cfd0: 2061 6e64 2073 696d 706c 6966 793a 0a20   and simplify:. 
+0004cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cff0: 2020 202f 2f20 6772 6164 5b23 3030 5d20     // grad[#00] 
+0004d000: 3d20 7363 616c 6528 6772 6164 2823 3130  = scale(grad(#10
+0004d010: 292c 2023 3039 2920 2b20 7363 616c 6528  ), #09) + scale(
+0004d020: 6d75 6c28 2330 302c 2067 7261 645b 2330  mul(#00, grad[#0
+0004d030: 325d 292c 2032 2e30 290a 2020 2020 2020  2]), 2.0).      
+0004d040: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0004d050: 2067 7261 645b 2330 325d 203d 2072 6570   grad[#02] = rep
+0004d060: 6561 7428 6772 6164 5b23 3033 5d2c 2023  eat(grad[#03], #
+0004d070: 3032 290a 2020 2020 2020 2020 2020 2020  02).            
+0004d080: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+0004d090: 2330 325d 203d 2072 6570 6561 7428 7363  #02] = repeat(sc
+0004d0a0: 616c 6528 6772 6164 5b23 3035 5d2c 2330  ale(grad[#05],#0
+0004d0b0: 3429 2c20 2330 3229 0a20 2020 2020 2020  4), #02).       
+0004d0c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0004d0d0: 6772 6164 5b23 3032 5d20 3d20 7265 7065  grad[#02] = repe
+0004d0e0: 6174 2873 6361 6c65 2867 7261 645b 2330  at(scale(grad[#0
+0004d0f0: 375d 2c23 3034 292c 2023 3032 290a 2020  7],#04), #02).  
+0004d100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d110: 2020 2f2f 2067 7261 645b 2330 325d 203d    // grad[#02] =
+0004d120: 2072 6570 6561 7428 7363 616c 6528 6d75   repeat(scale(mu
+0004d130: 6c28 6772 6164 5b23 3038 5d2c 2064 6976  l(grad[#08], div
+0004d140: 2830 2e35 2c20 2330 3829 292c 2330 3429  (0.5, #08)),#04)
+0004d150: 2c20 2330 3229 0a20 2020 2020 2020 2020  , #02).         
+0004d160: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
+0004d170: 6164 5b23 3032 5d20 3d20 7265 7065 6174  ad[#02] = repeat
+0004d180: 2873 6361 6c65 286d 756c 286e 6567 286d  (scale(mul(neg(m
+0004d190: 756c 2867 7261 645b 2330 395d 2c20 6469  ul(grad[#09], di
+0004d1a0: 7628 2330 392c 2330 3829 2929 2c20 6469  v(#09,#08))), di
+0004d1b0: 7628 302e 352c 2023 3038 2929 2c23 3034  v(0.5, #08)),#04
+0004d1c0: 292c 2023 3032 290a 2020 2020 2020 2020  ), #02).        
+0004d1d0: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0004d1e0: 7261 645b 2330 325d 203d 2072 6570 6561  rad[#02] = repea
+0004d1f0: 7428 7363 616c 6528 6d75 6c28 6e65 6728  t(scale(mul(neg(
+0004d200: 6d75 6c28 7375 6d28 6d75 6c28 6772 6164  mul(sum(mul(grad
+0004d210: 5b23 3130 5d2c 2330 3029 292c 2064 6976  [#10],#00)), div
+0004d220: 2823 3039 2c23 3038 2929 292c 2064 6976  (#09,#08))), div
+0004d230: 2830 2e35 2c20 2330 3829 292c 2330 3429  (0.5, #08)),#04)
+0004d240: 2c20 2330 3229 0a20 2020 2020 2020 2020  , #02).         
+0004d250: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
+0004d260: 6164 5b23 3032 5d20 3d20 7265 7065 6174  ad[#02] = repeat
+0004d270: 282d 2873 756d 286d 756c 2867 7261 645b  (-(sum(mul(grad[
+0004d280: 2331 305d 2c23 3030 2929 202a 2064 6976  #10],#00)) * div
+0004d290: 2823 3039 2c23 3038 2920 2a20 6469 7628  (#09,#08) * div(
+0004d2a0: 302e 352c 2023 3038 2920 2a20 2831 2f4e  0.5, #08) * (1/N
+0004d2b0: 2929 2c20 2330 3229 0a20 2020 2020 2020  )), #02).       
+0004d2c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0004d2d0: 6772 6164 5b23 3032 5d20 3d20 7265 7065  grad[#02] = repe
+0004d2e0: 6174 282d 2873 756d 286d 756c 2867 7261  at(-(sum(mul(gra
+0004d2f0: 645b 2331 305d 2c23 3030 2929 202a 2064  d[#10],#00)) * d
+0004d300: 6976 2864 6976 2823 3031 2c23 3038 292c  iv(div(#01,#08),
+0004d310: 2330 3829 202a 2064 6976 2830 2e35 2c20  #08) * div(0.5, 
+0004d320: 2330 3829 202a 2028 312f 4e29 292c 2023  #08) * (1/N)), #
+0004d330: 3032 290a 2020 2020 2020 2020 2020 2020  02).            
+0004d340: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+0004d350: 2330 325d 203d 2072 6570 6561 7428 2d28  #02] = repeat(-(
+0004d360: 7375 6d28 6d75 6c28 6772 6164 5b23 3130  sum(mul(grad[#10
+0004d370: 5d2c 2330 3029 2920 2a20 6469 7628 312c  ],#00)) * div(1,
+0004d380: 2330 382a 2330 3829 202a 2064 6976 2830  #08*#08) * div(0
+0004d390: 2e35 2c20 2330 3829 202a 2028 312f 4e29  .5, #08) * (1/N)
+0004d3a0: 292c 2023 3032 290a 2020 2020 2020 2020  ), #02).        
+0004d3b0: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0004d3c0: 7261 645b 2330 325d 203d 2072 6570 6561  rad[#02] = repea
+0004d3d0: 7428 2d28 7375 6d28 6d75 6c28 6772 6164  t(-(sum(mul(grad
+0004d3e0: 5b23 3130 5d2c 2330 3029 2920 2a20 6469  [#10],#00)) * di
+0004d3f0: 7628 312c 2330 3729 202a 2064 6976 2830  v(1,#07) * div(0
+0004d400: 2e35 2c20 2330 3829 202a 2028 312f 4e29  .5, #08) * (1/N)
+0004d410: 292c 2023 3032 290a 2020 2020 2020 2020  ), #02).        
+0004d420: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0004d430: 7261 645b 2330 305d 203d 2073 6361 6c65  rad[#00] = scale
+0004d440: 2867 7261 6428 2331 3029 2c20 2330 3929  (grad(#10), #09)
+0004d450: 202b 2073 6361 6c65 286d 756c 2823 3030   + scale(mul(#00
+0004d460: 2c20 6772 6164 5b23 3032 5d29 2c20 322e  , grad[#02]), 2.
+0004d470: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+0004d480: 2020 2020 2020 202f 2f20 6772 6164 5b23         // grad[#
+0004d490: 3030 5d20 3d20 7363 616c 6528 6772 6164  00] = scale(grad
+0004d4a0: 2823 3130 292c 2023 3039 2920 2b20 7363  (#10), #09) + sc
+0004d4b0: 616c 6528 6d75 6c28 2330 302c 2072 6570  ale(mul(#00, rep
+0004d4c0: 6561 7428 2d28 7375 6d28 6d75 6c28 6772  eat(-(sum(mul(gr
+0004d4d0: 6164 5b23 3130 5d2c 2330 3029 2920 2a20  ad[#10],#00)) * 
+0004d4e0: 6469 7628 312c 2330 3729 202a 2064 6976  div(1,#07) * div
+0004d4f0: 2830 2e35 2c20 2330 3829 202a 2028 312f  (0.5, #08) * (1/
+0004d500: 4e29 292c 2023 3032 2929 2c20 322e 3029  N)), #02)), 2.0)
+0004d510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004d520: 2020 2020 202f 2f20 6772 6164 5b23 3030       // grad[#00
+0004d530: 5d20 3d20 7363 616c 6528 6772 6164 2823  ] = scale(grad(#
+0004d540: 3130 292c 2023 3039 2920 2b20 7363 616c  10), #09) + scal
+0004d550: 6528 7363 616c 6528 2330 302c 202d 2873  e(scale(#00, -(s
+0004d560: 756d 286d 756c 2867 7261 645b 2331 305d  um(mul(grad[#10]
+0004d570: 2c23 3030 2929 202a 2064 6976 2831 2c23  ,#00)) * div(1,#
+0004d580: 3037 2920 2a20 6469 7628 302e 352c 2023  07) * div(0.5, #
+0004d590: 3038 2920 2a20 2831 2f4e 2929 292c 2032  08) * (1/N))), 2
+0004d5a0: 2e30 290a 2020 2020 2020 2020 2020 2020  .0).            
+0004d5b0: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+0004d5c0: 2330 305d 203d 2073 6361 6c65 2867 7261  #00] = scale(gra
+0004d5d0: 6428 2331 3029 2c20 2330 3929 202b 2073  d(#10), #09) + s
+0004d5e0: 6361 6c65 2823 3030 2c20 2d28 7375 6d28  cale(#00, -(sum(
+0004d5f0: 6d75 6c28 6772 6164 5b23 3130 5d2c 2330  mul(grad[#10],#0
+0004d600: 3029 2920 2a20 6469 7628 312c 2330 3729  0)) * div(1,#07)
+0004d610: 202a 2064 6976 2831 2c23 3038 2920 2a20   * div(1,#08) * 
+0004d620: 2831 2f4e 2929 290a 2020 2020 2020 2020  (1/N))).        
+0004d630: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0004d640: 7261 645b 2330 305d 203d 2073 6361 6c65  rad[#00] = scale
+0004d650: 2867 7261 6428 2331 3029 2c20 2330 3929  (grad(#10), #09)
+0004d660: 202b 2073 6361 6c65 2823 3030 2c20 7375   + scale(#00, su
+0004d670: 6d28 6d75 6c28 6772 6164 5b23 3130 5d2c  m(mul(grad[#10],
+0004d680: 2330 3029 2920 2a20 6469 7628 312c 2330  #00)) * div(1,#0
+0004d690: 372a 2330 3829 202a 2028 2d31 2f4e 2929  7*#08) * (-1/N))
+0004d6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004d6b0: 2020 2020 202f 2f20 6772 6164 5b23 3030       // grad[#00
+0004d6c0: 5d20 3d20 7363 616c 6528 6772 6164 2823  ] = scale(grad(#
+0004d6d0: 3130 292c 2023 3039 2920 2b20 7363 616c  10), #09) + scal
+0004d6e0: 6528 2330 302c 2073 756d 286d 756c 2867  e(#00, sum(mul(g
+0004d6f0: 7261 645b 2331 305d 2c23 3030 2929 202a  rad[#10],#00)) *
+0004d700: 2064 6976 2831 2c23 3037 2a23 3038 2920   div(1,#07*#08) 
+0004d710: 2a20 282d 312f 4e29 290a 2020 2020 2020  * (-1/N)).      
+0004d720: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0004d730: 2067 7261 645b 2330 305d 203d 2073 6361   grad[#00] = sca
+0004d740: 6c65 2867 7261 6428 2331 3029 2c20 2330  le(grad(#10), #0
+0004d750: 3929 202b 2073 6361 6c65 2823 3030 2c20  9) + scale(#00, 
+0004d760: 7375 6d28 6d75 6c28 6772 6164 5b23 3130  sum(mul(grad[#10
+0004d770: 5d2c 2330 3029 2920 2a20 6469 7628 312c  ],#00)) * div(1,
+0004d780: 6d65 616e 5f65 7073 2a72 6d73 2920 2a20  mean_eps*rms) * 
+0004d790: 282d 312f 4e29 290a 2020 2020 2020 2020  (-1/N)).        
+0004d7a0: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0004d7b0: 7261 645b 2330 305d 203d 2073 6361 6c65  rad[#00] = scale
+0004d7c0: 2867 7261 6428 2331 3029 2c20 2330 3929  (grad(#10), #09)
+0004d7d0: 202b 2073 6361 6c65 2823 3030 2c20 7375   + scale(#00, su
+0004d7e0: 6d28 6d75 6c28 6772 6164 5b23 3130 5d2c  m(mul(grad[#10],
+0004d7f0: 2330 3029 2920 2a20 6469 7628 2d31 2c72  #00)) * div(-1,r
+0004d800: 6d73 2a4e 2a6d 6561 6e5f 6570 7329 290a  ms*N*mean_eps)).
+0004d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d820: 2020 2020 2f2f 2067 7261 645b 2330 305d      // grad[#00]
+0004d830: 203d 2073 6361 6c65 2867 7261 6428 2331   = scale(grad(#1
+0004d840: 3029 2c20 2330 3929 202b 2073 6361 6c65  0), #09) + scale
+0004d850: 2823 3030 2c20 7375 6d28 6d75 6c28 6772  (#00, sum(mul(gr
+0004d860: 6164 5b23 3130 5d2c 2330 3029 2920 2a20  ad[#10],#00)) * 
+0004d870: 6469 7628 2d31 2c72 6d73 2a4e 2a28 7375  div(-1,rms*N*(su
+0004d880: 6d5f 7878 2f4e 2b65 7073 2929 290a 2020  m_xx/N+eps))).  
+0004d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d8a0: 2020 2f2f 2067 7261 645b 2330 305d 203d    // grad[#00] =
+0004d8b0: 2073 6361 6c65 2867 7261 6428 2331 3029   scale(grad(#10)
+0004d8c0: 2c20 2330 3929 202b 2073 6361 6c65 2823  , #09) + scale(#
+0004d8d0: 3030 2c20 7375 6d28 6d75 6c28 6772 6164  00, sum(mul(grad
+0004d8e0: 5b23 3130 5d2c 2330 3029 2920 2a20 6469  [#10],#00)) * di
+0004d8f0: 7628 2d31 2c72 6d73 2a4e 2a73 756d 5f78  v(-1,rms*N*sum_x
+0004d900: 782b 726d 732a 4e2a 6570 7329 290a 2020  x+rms*N*eps)).  
+0004d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d920: 2020 2f2f 2067 7261 645b 2330 305d 203d    // grad[#00] =
+0004d930: 2073 6361 6c65 2864 7a2c 2072 726d 7329   scale(dz, rrms)
+0004d940: 202b 2073 6361 6c65 2878 2c20 7375 6d28   + scale(x, sum(
+0004d950: 6d75 6c28 647a 2c78 2929 202a 2064 6976  mul(dz,x)) * div
+0004d960: 282d 312c 726d 732a 4e2a 6d65 616e 5f65  (-1,rms*N*mean_e
+0004d970: 7073 2929 0a20 2020 2020 2020 2020 2020  ps)).           
+0004d980: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
+0004d990: 5b23 3030 5d20 3d20 7363 616c 6528 647a  [#00] = scale(dz
+0004d9a0: 2c20 7272 6d73 2920 2b20 7363 616c 6528  , rrms) + scale(
+0004d9b0: 782c 2073 756d 5f78 647a 202a 2064 6976  x, sum_xdz * div
+0004d9c0: 282d 312c 726d 732a 4e2a 6d65 616e 5f65  (-1,rms*N*mean_e
+0004d9d0: 7073 2929 0a20 2020 2020 2020 2020 2020  ps)).           
+0004d9e0: 2020 2020 2020 2020 202f 2f20 6120 3d20           // a = 
+0004d9f0: 622a 6320 2b20 642a 650a 2020 2020 2020  b*c + d*e.      
+0004da00: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0004da10: 2061 203d 2062 2a63 2a66 2f66 202b 2064   a = b*c*f/f + d
+0004da20: 2a65 2a66 2f66 0a20 2020 2020 2020 2020  *e*f/f.         
+0004da30: 2020 2020 2020 2020 2020 202f 2f20 6120             // a 
+0004da40: 3d20 2862 2a63 2a66 202b 2064 2a65 2a66  = (b*c*f + d*e*f
+0004da50: 292a 2831 2f66 290a 2020 2020 2020 2020  )*(1/f).        
+0004da60: 2020 2020 2020 2020 2020 2020 2f2f 2061              // a
+0004da70: 203d 2028 622a 632a 2831 2f63 2920 2b20   = (b*c*(1/c) + 
+0004da80: 642a 652a 2831 2f63 2929 2a28 312f 2831  d*e*(1/c))*(1/(1
+0004da90: 2f63 2929 0a20 2020 2020 2020 2020 2020  /c)).           
+0004daa0: 2020 2020 2020 2020 202f 2f20 6120 3d20           // a = 
+0004dab0: 2862 202b 2064 2a65 2f63 292a 630a 2020  (b + d*e/c)*c.  
+0004dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dad0: 2020 2f2f 2062 203d 2064 7a2c 2063 203d    // b = dz, c =
+0004dae0: 2072 726d 732c 2064 203d 2078 2c20 6520   rrms, d = x, e 
+0004daf0: 3d20 7375 6d5f 7864 7a20 2a20 6469 7628  = sum_xdz * div(
+0004db00: 2d31 2c72 6d73 2a4e 2a6d 6561 6e5f 6570  -1,rms*N*mean_ep
+0004db10: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0004db20: 2020 2020 2020 202f 2f20 6120 3d20 2864         // a = (d
+0004db30: 7a20 2b20 782a 7375 6d5f 7864 7a20 2a20  z + x*sum_xdz * 
+0004db40: 6469 7628 2d31 2c72 6d73 2a4e 2a6d 6561  div(-1,rms*N*mea
+0004db50: 6e5f 6570 7329 2f72 726d 7329 2a72 726d  n_eps)/rrms)*rrm
+0004db60: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0004db70: 2020 2020 2020 2f2f 2061 203d 2028 647a        // a = (dz
+0004db80: 202b 2078 2a73 756d 5f78 647a 202a 2064   + x*sum_xdz * d
+0004db90: 6976 282d 312c 726d 732a 4e2a 6d65 616e  iv(-1,rms*N*mean
+0004dba0: 5f65 7073 292a 726d 7329 2a72 726d 730a  _eps)*rms)*rrms.
+0004dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dbc0: 2020 2020 2f2f 2061 203d 2028 647a 202b      // a = (dz +
+0004dbd0: 2078 2a73 756d 5f78 647a 202a 2064 6976   x*sum_xdz * div
+0004dbe0: 282d 726d 732c 726d 732a 4e2a 6d65 616e  (-rms,rms*N*mean
+0004dbf0: 5f65 7073 2929 2a72 726d 730a 2020 2020  _eps))*rrms.    
+0004dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dc10: 2f2f 2061 203d 2028 647a 202b 2078 2a73  // a = (dz + x*s
+0004dc20: 756d 5f78 647a 202a 2064 6976 282d 312c  um_xdz * div(-1,
+0004dc30: 4e2a 6d65 616e 5f65 7073 2929 2a72 726d  N*mean_eps))*rrm
+0004dc40: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0004dc50: 2020 2020 2020 2f2f 2061 203d 2028 647a        // a = (dz
+0004dc60: 202b 2078 2a64 6976 282d 7375 6d5f 7864   + x*div(-sum_xd
+0004dc70: 7a2c 4e2a 6d65 616e 5f65 7073 2929 2a72  z,N*mean_eps))*r
+0004dc80: 726d 730a 2020 2020 2020 2020 2020 2020  rms.            
+0004dc90: 2020 2020 2020 2020 2f2f 2061 203d 2028          // a = (
+0004dca0: 647a 202b 2078 2a64 6976 282d 6d65 616e  dz + x*div(-mean
+0004dcb0: 5f78 647a 2c6d 6561 6e5f 6570 7329 292a  _xdz,mean_eps))*
+0004dcc0: 7272 6d73 0a20 2020 2020 2020 2020 2020  rrms.           
+0004dcd0: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
+0004dce0: 5b23 3030 5d20 3d20 7363 616c 6528 647a  [#00] = scale(dz
+0004dcf0: 202b 2073 6361 6c65 2878 2c20 6469 7628   + scale(x, div(
+0004dd00: 2d6d 6561 6e5f 7864 7a2c 6d65 616e 5f65  -mean_xdz,mean_e
+0004dd10: 7073 2929 2c72 726d 7329 0a20 2020 2020  ps)),rrms).     
+0004dd20: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0004dd30: 2f20 6772 6164 5b23 3030 5d20 3d20 7363  / grad[#00] = sc
+0004dd40: 616c 6528 647a 202b 2073 6361 6c65 2878  ale(dz + scale(x
+0004dd50: 2c20 2d6d 6561 6e5f 7864 7a2f 6d65 616e  , -mean_xdz/mean
+0004dd60: 5f65 7073 292c 7272 6d73 290a 2020 2020  _eps),rrms).    
+0004dd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dd80: 2f2f 2064 7820 3d20 7363 616c 6528 647a  // dx = scale(dz
+0004dd90: 202b 2073 6361 6c65 2878 2c20 2d6d 6561   + scale(x, -mea
+0004dda0: 6e5f 7864 7a2f 6d65 616e 5f65 7073 292c  n_xdz/mean_eps),
+0004ddb0: 7272 6d73 290a 2020 2020 2020 2020 2020  rrms).          
+0004ddc0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0004ddd0: 2020 2020 2020 2020 2f2f 2064 7820 3d20          // dx = 
+0004dde0: 7363 616c 6528 647a 202b 2073 6361 6c65  scale(dz + scale
+0004ddf0: 2878 2c20 2d6d 6561 6e5f 7864 7a2f 6d65  (x, -mean_xdz/me
+0004de00: 616e 5f65 7073 292c 7272 6d73 290a 2020  an_eps),rrms).  
+0004de10: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0004de20: 2070 6f73 742d 6f72 6465 723a 0a20 2020   post-order:.   
+0004de30: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0004de40: 6478 203a 3d20 780a 2020 2020 2020 2020  dx := x.        
+0004de50: 2020 2020 2020 2020 2f2f 2064 7820 3a3d          // dx :=
+0004de60: 2073 6361 6c65 2864 782c 2d6d 6561 6e5f   scale(dx,-mean_
+0004de70: 7864 7a2f 6d65 616e 5f65 7073 290a 2020  xdz/mean_eps).  
+0004de80: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0004de90: 2064 7820 3a3d 2061 6464 2864 782c 2064   dx := add(dx, d
+0004dea0: 7a29 0a20 2020 2020 2020 2020 2020 2020  z).             
+0004deb0: 2020 202f 2f20 6478 203a 3d20 7363 616c     // dx := scal
+0004dec0: 6528 6478 2c20 7272 6d73 290a 2020 2020  e(dx, rrms).    
+0004ded0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+0004dee0: 7420 2a20 6478 203d 2028 666c 6f61 7420  t * dx = (float 
+0004def0: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
+0004df00: 2d3e 6461 7461 202b 2069 3031 2a6e 6231  ->data + i01*nb1
+0004df10: 202b 2069 3032 2a6e 6232 202b 2069 3033   + i02*nb2 + i03
+0004df20: 2a6e 6233 293b 0a0a 2020 2020 2020 2020  *nb3);..        
+0004df30: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0004df40: 5f63 7079 5f66 3332 2020 286e 6530 302c  _cpy_f32  (ne00,
+0004df50: 2064 782c 2078 293b 0a20 2020 2020 2020   dx, x);.       
+0004df60: 2020 2020 2020 2020 202f 2f20 6767 6d6c           // ggml
+0004df70: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
+0004df80: 6530 302c 2064 782c 202d 6d65 616e 5f78  e00, dx, -mean_x
+0004df90: 647a 2f6d 6561 6e5f 6570 7329 3b0a 2020  dz/mean_eps);.  
+0004dfa0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0004dfb0: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
+0004dfc0: 286e 6530 302c 2064 782c 2028 666c 6f61  (ne00, dx, (floa
+0004dfd0: 7429 282d 7375 6d5f 7864 7a29 2f73 756d  t)(-sum_xdz)/sum
+0004dfe0: 5f65 7073 293b 0a20 2020 2020 2020 2020  _eps);.         
+0004dff0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0004e000: 6163 635f 6633 3220 2028 6e65 3030 2c20  acc_f32  (ne00, 
+0004e010: 6478 2c20 647a 293b 0a20 2020 2020 2020  dx, dz);.       
+0004e020: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+0004e030: 635f 7363 616c 655f 6633 3228 6e65 3030  c_scale_f32(ne00
+0004e040: 2c20 6478 2c20 7272 6d73 293b 0a20 2020  , dx, rrms);.   
+0004e050: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0004e060: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
+0004e070: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+0004e080: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+0004e090: 6d73 5f6e 6f72 6d5f 6261 636b 280a 2020  ms_norm_back(.  
+0004e0a0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0004e0b0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+0004e0c0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+0004e0d0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0004e0e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0004e0f0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+0004e100: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0004e110: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+0004e120: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
+0004e130: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0004e140: 6473 7429 207b 0a20 2020 2073 7769 7463  dst) {.    switc
+0004e150: 6820 2873 7263 302d 3e74 7970 6529 207b  h (src0->type) {
+0004e160: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0004e170: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
+0004e180: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0004e190: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0004e1a0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0004e1b0: 726d 735f 6e6f 726d 5f62 6163 6b5f 6633  rms_norm_back_f3
+0004e1c0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+0004e1d0: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+0004e1e0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0004e1f0: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+0004e200: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0004e210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e220: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+0004e230: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+0004e240: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+0004e250: 0a0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  ...// ggml_compu
+0004e260: 7465 5f66 6f72 7761 7264 5f6d 756c 5f6d  te_forward_mul_m
+0004e270: 6174 0a0a 2369 6620 6465 6669 6e65 6428  at..#if defined(
+0004e280: 4747 4d4c 5f55 5345 5f41 4343 454c 4552  GGML_USE_ACCELER
+0004e290: 4154 4529 207c 7c20 6465 6669 6e65 6428  ATE) || defined(
+0004e2a0: 4747 4d4c 5f55 5345 5f4f 5045 4e42 4c41  GGML_USE_OPENBLA
+0004e2b0: 5329 0a2f 2f20 6865 6c70 6572 2066 756e  S).// helper fun
+0004e2c0: 6374 696f 6e20 746f 2064 6574 6572 6d69  ction to determi
+0004e2d0: 6e65 2069 6620 6974 2069 7320 6265 7474  ne if it is bett
+0004e2e0: 6572 2074 6f20 7573 6520 424c 4153 206f  er to use BLAS o
+0004e2f0: 7220 6e6f 740a 2f2f 2066 6f72 206c 6172  r not.// for lar
+0004e300: 6765 206d 6174 7269 6365 732c 2042 4c41  ge matrices, BLA
+0004e310: 5320 6973 2066 6173 7465 720a 7374 6174  S is faster.stat
+0004e320: 6963 2062 6f6f 6c20 6767 6d6c 5f63 6f6d  ic bool ggml_com
+0004e330: 7075 7465 5f66 6f72 7761 7264 5f6d 756c  pute_forward_mul
+0004e340: 5f6d 6174 5f75 7365 5f62 6c61 7328 0a20  _mat_use_blas(. 
+0004e350: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0004e360: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0004e370: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+0004e380: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0004e390: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+0004e3a0: 0a20 2020 2020 2020 2020 2020 2020 2073  .              s
+0004e3b0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0004e3c0: 7220 2a20 6473 7429 207b 0a20 2020 202f  r * dst) {.    /
+0004e3d0: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+0004e3e0: 6530 3020 3d20 7372 6330 2d3e 6e65 5b30  e00 = src0->ne[0
+0004e3f0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+0004e400: 6e74 3634 5f74 206e 6530 3120 3d20 7372  nt64_t ne01 = sr
+0004e410: 6330 2d3e 6e65 5b31 5d3b 0a0a 2020 2020  c0->ne[1];..    
+0004e420: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0004e430: 3130 203d 2073 7263 312d 3e6e 655b 305d  10 = src1->ne[0]
+0004e440: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0004e450: 3634 5f74 206e 6530 203d 2064 7374 2d3e  64_t ne0 = dst->
+0004e460: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+0004e470: 2069 6e74 3634 5f74 206e 6531 203d 2064   int64_t ne1 = d
+0004e480: 7374 2d3e 6e65 5b31 5d3b 0a0a 2020 2020  st->ne[1];..    
+0004e490: 2f2f 2054 4f44 4f3a 2066 696e 6420 7468  // TODO: find th
+0004e4a0: 6520 6f70 7469 6d61 6c20 7661 6c75 6573  e optimal values
+0004e4b0: 2066 6f72 2074 6865 7365 0a20 2020 2069   for these.    i
+0004e4c0: 6620 2867 676d 6c5f 6973 5f63 6f6e 7469  f (ggml_is_conti
+0004e4d0: 6775 6f75 7328 7372 6330 2920 2626 0a20  guous(src0) &&. 
+0004e4e0: 2020 2020 2020 2067 676d 6c5f 6973 5f63         ggml_is_c
+0004e4f0: 6f6e 7469 6775 6f75 7328 7372 6331 2920  ontiguous(src1) 
+0004e500: 2626 0a20 2020 2020 2020 2028 6e65 3020  &&.        (ne0 
+0004e510: 3e3d 2033 3220 2626 206e 6531 203e 3d20  >= 32 && ne1 >= 
+0004e520: 3332 2026 2620 6e65 3130 203e 3d20 3332  32 && ne10 >= 32
+0004e530: 2929 207b 0a0a 2020 2020 2020 2020 2f2a  )) {..        /*
+0004e540: 7072 696e 7466 2822 424c 4153 3a20 2564  printf("BLAS: %d
+0004e550: 2025 6420 2564 2025 6420 2564 5c6e 222c   %d %d %d %d\n",
+0004e560: 206e 6530 2c20 6e65 312c 206e 6531 302c   ne0, ne1, ne10,
+0004e570: 206e 6530 302c 206e 6530 3129 3b2a 2f0a   ne00, ne01);*/.
+0004e580: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0004e590: 7275 653b 0a20 2020 207d 0a0a 2020 2020  rue;.    }..    
+0004e5a0: 7265 7475 726e 2066 616c 7365 3b0a 7d0a  return false;.}.
+0004e5b0: 2365 6e64 6966 0a0a 7374 6174 6963 2076  #endif..static v
+0004e5c0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+0004e5d0: 5f66 6f72 7761 7264 5f6d 756c 5f6d 6174  _forward_mul_mat
+0004e5e0: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
+0004e5f0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0004e600: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+0004e610: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+0004e620: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0004e630: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+0004e640: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0004e650: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0004e660: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+0004e670: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+0004e680: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+0004e690: 7429 207b 0a20 2020 2069 6e74 3634 5f74  t) {.    int64_t
+0004e6a0: 2074 3020 3d20 6767 6d6c 5f70 6572 665f   t0 = ggml_perf_
+0004e6b0: 7469 6d65 5f75 7328 293b 0a20 2020 2055  time_us();.    U
+0004e6c0: 4e55 5345 4428 7430 293b 0a0a 2020 2020  NUSED(t0);..    
+0004e6d0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0004e6e0: 3030 203d 2073 7263 302d 3e6e 655b 305d  00 = src0->ne[0]
+0004e6f0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+0004e700: 345f 7420 6e65 3031 203d 2073 7263 302d  4_t ne01 = src0-
+0004e710: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
+0004e720: 7420 696e 7436 345f 7420 6e65 3032 203d  t int64_t ne02 =
+0004e730: 2073 7263 302d 3e6e 655b 325d 3b0a 2020   src0->ne[2];.  
+0004e740: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+0004e750: 6e65 3033 203d 2073 7263 302d 3e6e 655b  ne03 = src0->ne[
+0004e760: 335d 3b0a 0a23 6966 2064 6566 696e 6564  3];..#if defined
+0004e770: 2847 474d 4c5f 5553 455f 4143 4345 4c45  (GGML_USE_ACCELE
+0004e780: 5241 5445 2920 7c7c 2064 6566 696e 6564  RATE) || defined
+0004e790: 2847 474d 4c5f 5553 455f 4f50 454e 424c  (GGML_USE_OPENBL
+0004e7a0: 4153 290a 2020 2020 636f 6e73 7420 696e  AS).    const in
+0004e7b0: 7436 345f 7420 6e65 3130 203d 2073 7263  t64_t ne10 = src
+0004e7c0: 312d 3e6e 655b 305d 3b0a 2365 6e64 6966  1->ne[0];.#endif
+0004e7d0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0004e7e0: 5f74 206e 6531 3120 3d20 7372 6331 2d3e  _t ne11 = src1->
+0004e7f0: 6e65 5b31 5d3b 0a23 6966 6e64 6566 204e  ne[1];.#ifndef N
+0004e800: 4445 4255 470a 2020 2020 636f 6e73 7420  DEBUG.    const 
+0004e810: 696e 7436 345f 7420 6e65 3132 203d 2073  int64_t ne12 = s
+0004e820: 7263 312d 3e6e 655b 325d 3b0a 2020 2020  rc1->ne[2];.    
+0004e830: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0004e840: 3133 203d 2073 7263 312d 3e6e 655b 335d  13 = src1->ne[3]
+0004e850: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0004e860: 3634 5f74 206e 6530 2020 3d20 6473 742d  64_t ne0  = dst-
+0004e870: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+0004e880: 7420 696e 7436 345f 7420 6e65 3120 203d  t int64_t ne1  =
+0004e890: 2064 7374 2d3e 6e65 5b31 5d3b 0a20 2020   dst->ne[1];.   
+0004e8a0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0004e8b0: 6532 2020 3d20 6473 742d 3e6e 655b 325d  e2  = dst->ne[2]
+0004e8c0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+0004e8d0: 345f 7420 6e65 3320 203d 2064 7374 2d3e  4_t ne3  = dst->
+0004e8e0: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
+0004e8f0: 7420 696e 7420 6e62 3030 203d 2073 7263  t int nb00 = src
+0004e900: 302d 3e6e 625b 305d 3b0a 2365 6e64 6966  0->nb[0];.#endif
+0004e910: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0004e920: 6230 3120 3d20 7372 6330 2d3e 6e62 5b31  b01 = src0->nb[1
+0004e930: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0004e940: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
+0004e950: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
+0004e960: 6e74 206e 6230 3320 3d20 7372 6330 2d3e  nt nb03 = src0->
+0004e970: 6e62 5b33 5d3b 0a0a 2369 666e 6465 6620  nb[3];..#ifndef 
+0004e980: 4e44 4542 5547 0a20 2020 2063 6f6e 7374  NDEBUG.    const
+0004e990: 2069 6e74 206e 6231 3020 3d20 7372 6331   int nb10 = src1
+0004e9a0: 2d3e 6e62 5b30 5d3b 0a23 656e 6469 660a  ->nb[0];.#endif.
+0004e9b0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+0004e9c0: 3131 203d 2073 7263 312d 3e6e 625b 315d  11 = src1->nb[1]
+0004e9d0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0004e9e0: 6e62 3132 203d 2073 7263 312d 3e6e 625b  nb12 = src1->nb[
+0004e9f0: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+0004ea00: 7420 6e62 3133 203d 2073 7263 312d 3e6e  t nb13 = src1->n
+0004ea10: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+0004ea20: 2069 6e74 206e 6230 2020 3d20 6473 742d   int nb0  = dst-
+0004ea30: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
+0004ea40: 7420 696e 7420 6e62 3120 203d 2064 7374  t int nb1  = dst
+0004ea50: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
+0004ea60: 7374 2069 6e74 206e 6232 2020 3d20 6473  st int nb2  = ds
+0004ea70: 742d 3e6e 625b 325d 3b0a 2020 2020 636f  t->nb[2];.    co
+0004ea80: 6e73 7420 696e 7420 6e62 3320 203d 2064  nst int nb3  = d
+0004ea90: 7374 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  st->nb[3];..    
+0004eaa0: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
+0004eab0: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
+0004eac0: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
+0004ead0: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
+0004eae0: 2020 2061 7373 6572 7428 6e65 3032 203d     assert(ne02 =
+0004eaf0: 3d20 6e65 3132 293b 0a20 2020 2061 7373  = ne12);.    ass
+0004eb00: 6572 7428 6e65 3033 203d 3d20 6e65 3133  ert(ne03 == ne13
+0004eb10: 293b 0a20 2020 2061 7373 6572 7428 6e65  );.    assert(ne
+0004eb20: 3220 203d 3d20 6e65 3132 293b 0a20 2020  2  == ne12);.   
+0004eb30: 2061 7373 6572 7428 6e65 3320 203d 3d20   assert(ne3  == 
+0004eb40: 6e65 3133 293b 0a0a 2020 2020 2f2f 2077  ne13);..    // w
+0004eb50: 6520 646f 6e27 7420 7375 7070 6f72 7420  e don't support 
+0004eb60: 7065 726d 7574 6564 2073 7263 3020 6f72  permuted src0 or
+0004eb70: 2073 7263 310a 2020 2020 6173 7365 7274   src1.    assert
+0004eb80: 286e 6230 3020 3d3d 2073 697a 656f 6628  (nb00 == sizeof(
+0004eb90: 666c 6f61 7429 293b 0a20 2020 2061 7373  float));.    ass
+0004eba0: 6572 7428 6e62 3130 203d 3d20 7369 7a65  ert(nb10 == size
+0004ebb0: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
+0004ebc0: 202f 2f20 6473 7420 6361 6e6e 6f74 2062   // dst cannot b
+0004ebd0: 6520 7472 616e 7370 6f73 6564 206f 7220  e transposed or 
+0004ebe0: 7065 726d 7574 6564 0a20 2020 2061 7373  permuted.    ass
+0004ebf0: 6572 7428 6e62 3020 3d3d 2073 697a 656f  ert(nb0 == sizeo
+0004ec00: 6628 666c 6f61 7429 293b 0a20 2020 2061  f(float));.    a
+0004ec10: 7373 6572 7428 6e62 3020 3c3d 206e 6231  ssert(nb0 <= nb1
+0004ec20: 293b 0a20 2020 2061 7373 6572 7428 6e62  );.    assert(nb
+0004ec30: 3120 3c3d 206e 6232 293b 0a20 2020 2061  1 <= nb2);.    a
+0004ec40: 7373 6572 7428 6e62 3220 3c3d 206e 6233  ssert(nb2 <= nb3
+0004ec50: 293b 0a0a 2020 2020 6173 7365 7274 286e  );..    assert(n
+0004ec60: 6530 203d 3d20 6e65 3031 293b 0a20 2020  e0 == ne01);.   
+0004ec70: 2061 7373 6572 7428 6e65 3120 3d3d 206e   assert(ne1 == n
+0004ec80: 6531 3129 3b0a 2020 2020 6173 7365 7274  e11);.    assert
+0004ec90: 286e 6532 203d 3d20 6e65 3032 293b 0a20  (ne2 == ne02);. 
+0004eca0: 2020 2061 7373 6572 7428 6e65 3320 3d3d     assert(ne3 ==
+0004ecb0: 206e 6530 3329 3b0a 0a20 2020 202f 2f20   ne03);..    // 
+0004ecc0: 6e62 3031 203e 3d20 6e62 3030 202d 2073  nb01 >= nb00 - s
+0004ecd0: 7263 3020 6973 206e 6f74 2074 7261 6e73  rc0 is not trans
+0004ece0: 706f 7365 640a 2020 2020 2f2f 2020 2063  posed.    //   c
+0004ecf0: 6f6d 7075 7465 2062 7920 7372 6330 2072  ompute by src0 r
+0004ed00: 6f77 730a 0a23 6966 2064 6566 696e 6564  ows..#if defined
+0004ed10: 2847 474d 4c5f 5553 455f 434c 424c 4153  (GGML_USE_CLBLAS
+0004ed20: 5429 0a20 2020 2069 6620 2867 676d 6c5f  T).    if (ggml_
+0004ed30: 636c 5f63 616e 5f6d 756c 5f6d 6174 2873  cl_can_mul_mat(s
+0004ed40: 7263 302c 2073 7263 312c 2064 7374 2929  rc0, src1, dst))
+0004ed50: 207b 0a20 2020 2020 2020 2069 6620 2870   {.        if (p
+0004ed60: 6172 616d 732d 3e69 7468 203d 3d20 3020  arams->ith == 0 
+0004ed70: 2626 2070 6172 616d 732d 3e74 7970 6520  && params->type 
+0004ed80: 3d3d 2047 474d 4c5f 5441 534b 5f43 4f4d  == GGML_TASK_COM
+0004ed90: 5055 5445 2920 7b0a 2020 2020 2020 2020  PUTE) {.        
+0004eda0: 2020 2020 6767 6d6c 5f63 6c5f 6d75 6c5f      ggml_cl_mul_
+0004edb0: 6d61 7428 7372 6330 2c20 7372 6331 2c20  mat(src0, src1, 
+0004edc0: 6473 742c 2070 6172 616d 732d 3e77 6461  dst, params->wda
+0004edd0: 7461 2c20 7061 7261 6d73 2d3e 7773 697a  ta, params->wsiz
+0004ede0: 6529 3b0a 2020 2020 2020 2020 7d0a 2020  e);.        }.  
+0004edf0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+0004ee00: 2020 7d0a 2365 6e64 6966 0a0a 2369 6620    }.#endif..#if 
+0004ee10: 6465 6669 6e65 6428 4747 4d4c 5f55 5345  defined(GGML_USE
+0004ee20: 5f41 4343 454c 4552 4154 4529 207c 7c20  _ACCELERATE) || 
+0004ee30: 6465 6669 6e65 6428 4747 4d4c 5f55 5345  defined(GGML_USE
+0004ee40: 5f4f 5045 4e42 4c41 5329 0a20 2020 2069  _OPENBLAS).    i
+0004ee50: 6620 2867 676d 6c5f 636f 6d70 7574 655f  f (ggml_compute_
+0004ee60: 666f 7277 6172 645f 6d75 6c5f 6d61 745f  forward_mul_mat_
+0004ee70: 7573 655f 626c 6173 2873 7263 302c 2073  use_blas(src0, s
+0004ee80: 7263 312c 2064 7374 2929 207b 0a20 2020  rc1, dst)) {.   
+0004ee90: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
+0004eea0: 3e69 7468 2021 3d20 3029 207b 0a20 2020  >ith != 0) {.   
+0004eeb0: 2020 2020 2020 2020 2072 6574 7572 6e3b           return;
+0004eec0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
 0004eed0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-0004eee0: 6974 6820 213d 2030 2920 7b0a 2020 2020  ith != 0) {.    
-0004eef0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-0004ef00: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0004ef10: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-0004ef20: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0004ef30: 5f49 4e49 5429 207b 0a20 2020 2020 2020  _INIT) {.       
-0004ef40: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-0004ef50: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0004ef60: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-0004ef70: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-0004ef80: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-0004ef90: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-0004efa0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0004efb0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
-0004efc0: 3320 3d20 303b 2069 3033 203c 206e 6530  3 = 0; i03 < ne0
-0004efd0: 333b 2069 3033 2b2b 2920 7b0a 2020 2020  3; i03++) {.    
-0004efe0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0004eff0: 3634 5f74 2069 3032 203d 2030 3b20 6930  64_t i02 = 0; i0
-0004f000: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
-0004f010: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0004f020: 2020 2063 6f6e 7374 2066 6c6f 6174 202a     const float *
-0004f030: 2078 203d 2028 666c 6f61 7420 2a29 2028   x = (float *) (
-0004f040: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-0004f050: 6174 6120 2b20 6930 322a 6e62 3032 202b  ata + i02*nb02 +
-0004f060: 2069 3033 2a6e 6230 3329 3b0a 2020 2020   i03*nb03);.    
-0004f070: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0004f080: 7420 666c 6f61 7420 2a20 7920 3d20 2866  t float * y = (f
-0004f090: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-0004f0a0: 2920 7372 6331 2d3e 6461 7461 202b 2069  ) src1->data + i
-0004f0b0: 3032 2a6e 6231 3220 2b20 6930 332a 6e62  02*nb12 + i03*nb
-0004f0c0: 3133 293b 0a20 2020 2020 2020 2020 2020  13);.           
-0004f0d0: 2020 2020 2066 6c6f 6174 202a 2064 203d       float * d =
-0004f0e0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-0004f0f0: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
-0004f100: 2069 3032 2a6e 6232 202b 2069 3033 2a6e   i02*nb2 + i03*n
-0004f110: 6233 293b 0a0a 2020 2020 2020 2020 2020  b3);..          
-0004f120: 2020 2020 2020 6362 6c61 735f 7367 656d        cblas_sgem
-0004f130: 6d28 4362 6c61 7352 6f77 4d61 6a6f 722c  m(CblasRowMajor,
-0004f140: 2043 626c 6173 4e6f 5472 616e 732c 2043   CblasNoTrans, C
-0004f150: 626c 6173 5472 616e 732c 0a20 2020 2020  blasTrans,.     
-0004f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f170: 2020 206e 6531 312c 206e 6530 312c 206e     ne11, ne01, n
-0004f180: 6531 302c 0a20 2020 2020 2020 2020 2020  e10,.           
-0004f190: 2020 2020 2020 2020 2020 2020 2031 2e30               1.0
-0004f1a0: 662c 2020 2020 792c 206e 6531 302c 0a20  f,    y, ne10,. 
-0004f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f1d0: 782c 206e 6530 302c 0a20 2020 2020 2020  x, ne00,.       
-0004f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f1f0: 2030 2e30 662c 2020 2020 642c 206e 6530   0.0f,    d, ne0
-0004f200: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-0004f210: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
-0004f220: 2020 2020 2f2f 7072 696e 7466 2822 4342      //printf("CB
-0004f230: 4c41 5320 4633 3220 3d20 2566 206d 732c  LAS F32 = %f ms,
-0004f240: 2025 6420 7820 2564 2078 2025 6420 7820   %d x %d x %d x 
-0004f250: 2564 5c6e 222c 2028 6767 6d6c 5f70 6572  %d\n", (ggml_per
-0004f260: 665f 7469 6d65 5f75 7328 2920 2d20 7430  f_time_us() - t0
-0004f270: 292f 3130 3030 2e30 2c20 6e65 302c 206e  )/1000.0, ne0, n
-0004f280: 6531 2c20 6e65 322c 206e 6533 293b 0a0a  e1, ne2, ne3);..
-0004f290: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-0004f2a0: 2020 2020 7d0a 2365 6e64 6966 0a0a 2020      }.#endif..  
-0004f2b0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-0004f2c0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-0004f2d0: 494e 4954 2920 7b0a 2020 2020 2020 2020  INIT) {.        
-0004f2e0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-0004f2f0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-0004f300: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0004f310: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-0004f320: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-0004f330: 207d 0a0a 2020 2020 2f2f 2070 6172 616c   }..    // paral
-0004f340: 6c65 6c69 7a65 2062 7920 7372 6330 2072  lelize by src0 r
-0004f350: 6f77 7320 7573 696e 6720 6767 6d6c 5f76  ows using ggml_v
-0004f360: 6563 5f64 6f74 5f66 3332 0a0a 2020 2020  ec_dot_f32..    
-0004f370: 2f2f 2074 6f74 616c 2072 6f77 7320 696e  // total rows in
-0004f380: 2073 7263 300a 2020 2020 636f 6e73 7420   src0.    const 
-0004f390: 696e 7420 6e72 203d 206e 6530 312a 6e65  int nr = ne01*ne
-0004f3a0: 3032 2a6e 6530 333b 0a0a 2020 2020 2f2f  02*ne03;..    //
-0004f3b0: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
-0004f3c0: 0a20 2020 2063 6f6e 7374 2069 6e74 2064  .    const int d
-0004f3d0: 7220 3d20 286e 7220 2b20 6e74 6820 2d20  r = (nr + nth - 
-0004f3e0: 3129 2f6e 7468 3b0a 0a20 2020 202f 2f20  1)/nth;..    // 
-0004f3f0: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
-0004f400: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
-0004f410: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
-0004f420: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
-0004f430: 696e 7420 6972 3120 3d20 4d49 4e28 6972  int ir1 = MIN(ir
-0004f440: 3020 2b20 6472 2c20 6e72 293b 0a0a 2020  0 + dr, nr);..  
-0004f450: 2020 666f 7220 2869 6e74 2069 7220 3d20    for (int ir = 
-0004f460: 6972 303b 2069 7220 3c20 6972 313b 202b  ir0; ir < ir1; +
-0004f470: 2b69 7229 207b 0a20 2020 2020 2020 202f  +ir) {.        /
-0004f480: 2f20 7372 6330 2069 6e64 6963 6573 0a20  / src0 indices. 
-0004f490: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0004f4a0: 2069 3033 203d 2069 722f 286e 6530 322a   i03 = ir/(ne02*
-0004f4b0: 6e65 3031 293b 0a20 2020 2020 2020 2063  ne01);.        c
-0004f4c0: 6f6e 7374 2069 6e74 2069 3032 203d 2028  onst int i02 = (
-0004f4d0: 6972 202d 2069 3033 2a6e 6530 322a 6e65  ir - i03*ne02*ne
-0004f4e0: 3031 292f 6e65 3031 3b0a 2020 2020 2020  01)/ne01;.      
-0004f4f0: 2020 636f 6e73 7420 696e 7420 6930 3120    const int i01 
-0004f500: 3d20 2869 7220 2d20 6930 332a 6e65 3032  = (ir - i03*ne02
-0004f510: 2a6e 6530 3120 2d20 6930 322a 6e65 3031  *ne01 - i02*ne01
-0004f520: 293b 0a0a 2020 2020 2020 2020 666f 7220  );..        for 
-0004f530: 2869 6e74 3634 5f74 2069 6320 3d20 303b  (int64_t ic = 0;
-0004f540: 2069 6320 3c20 6e65 3131 3b20 2b2b 6963   ic < ne11; ++ic
-0004f550: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0004f560: 2f2f 2073 7263 3120 696e 6469 6365 730a  // src1 indices.
-0004f570: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0004f580: 7420 696e 7420 6931 3320 3d20 6930 333b  t int i13 = i03;
-0004f590: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0004f5a0: 7374 2069 6e74 2069 3132 203d 2069 3032  st int i12 = i02
-0004f5b0: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-0004f5c0: 6e73 7420 696e 7420 6931 3120 3d20 6963  nst int i11 = ic
-0004f5d0: 3b0a 0a20 2020 2020 2020 2020 2020 202f  ;..            /
-0004f5e0: 2f20 6473 7420 696e 6469 6365 730a 2020  / dst indices.  
-0004f5f0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0004f600: 696e 7420 6930 203d 2069 3031 3b0a 2020  int i0 = i01;.  
-0004f610: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0004f620: 696e 7420 6931 203d 2069 3131 3b0a 2020  int i1 = i11;.  
-0004f630: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0004f640: 696e 7420 6932 203d 2069 3032 3b0a 2020  int i2 = i02;.  
-0004f650: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0004f660: 696e 7420 6933 203d 2069 3033 3b0a 0a20  int i3 = i03;.. 
-0004f670: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0004f680: 7665 635f 646f 745f 6633 3228 6e65 3030  vec_dot_f32(ne00
-0004f690: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004f6a0: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-0004f6b0: 2828 6368 6172 202a 2920 2064 7374 2d3e  ((char *)  dst->
-0004f6c0: 6461 7461 202b 2028 6930 2a6e 6230 202b  data + (i0*nb0 +
-0004f6d0: 2069 312a 6e62 3120 2b20 6932 2a6e 6232   i1*nb1 + i2*nb2
-0004f6e0: 202b 2069 332a 6e62 3329 292c 0a20 2020   + i3*nb3)),.   
-0004f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f700: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-0004f710: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-0004f720: 2b20 2869 3031 2a6e 6230 3120 2b20 6930  + (i01*nb01 + i0
-0004f730: 322a 6e62 3032 202b 2069 3033 2a6e 6230  2*nb02 + i03*nb0
-0004f740: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
-0004f750: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-0004f760: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
-0004f770: 312d 3e64 6174 6120 2b20 2869 3131 2a6e  1->data + (i11*n
-0004f780: 6231 3120 2b20 6931 322a 6e62 3132 202b  b11 + i12*nb12 +
-0004f790: 2069 3133 2a6e 6231 3329 2929 3b0a 2020   i13*nb13)));.  
-0004f7a0: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
-0004f7b0: 2020 202f 2f69 6e74 3634 5f74 2074 3120     //int64_t t1 
-0004f7c0: 3d20 6767 6d6c 5f70 6572 665f 7469 6d65  = ggml_perf_time
-0004f7d0: 5f75 7328 293b 0a20 2020 202f 2f73 7461  _us();.    //sta
-0004f7e0: 7469 6320 696e 7436 345f 7420 6163 6320  tic int64_t acc 
-0004f7f0: 3d20 303b 0a20 2020 202f 2f61 6363 202b  = 0;.    //acc +
-0004f800: 3d20 7431 202d 2074 303b 0a20 2020 202f  = t1 - t0;.    /
-0004f810: 2f69 6620 2874 3120 2d20 7430 203e 2031  /if (t1 - t0 > 1
-0004f820: 3029 207b 0a20 2020 202f 2f20 2020 2070  0) {.    //    p
-0004f830: 7269 6e74 6628 225c 6e22 293b 0a20 2020  rintf("\n");.   
-0004f840: 202f 2f20 2020 2070 7269 6e74 6628 226e   //    printf("n
-0004f850: 6530 3020 3d20 2535 642c 206e 6530 3120  e00 = %5d, ne01 
-0004f860: 3d20 2535 642c 206e 6530 3220 3d20 2535  = %5d, ne02 = %5
-0004f870: 642c 206e 6530 3320 3d20 2535 645c 6e22  d, ne03 = %5d\n"
-0004f880: 2c20 6e65 3030 2c20 6e65 3031 2c20 6e65  , ne00, ne01, ne
-0004f890: 3032 2c20 6e65 3033 293b 0a20 2020 202f  02, ne03);.    /
-0004f8a0: 2f20 2020 2070 7269 6e74 6628 226e 6230  /    printf("nb0
-0004f8b0: 3020 3d20 2535 642c 206e 6230 3120 3d20  0 = %5d, nb01 = 
-0004f8c0: 2535 642c 206e 6230 3220 3d20 2535 642c  %5d, nb02 = %5d,
-0004f8d0: 206e 6230 3320 3d20 2535 645c 6e22 2c20   nb03 = %5d\n", 
-0004f8e0: 6e62 3030 2c20 6e62 3031 2c20 6e62 3032  nb00, nb01, nb02
-0004f8f0: 2c20 6e62 3033 293b 0a20 2020 202f 2f20  , nb03);.    // 
-0004f900: 2020 2070 7269 6e74 6628 226e 6531 3020     printf("ne10 
-0004f910: 3d20 2535 642c 206e 6531 3120 3d20 2535  = %5d, ne11 = %5
-0004f920: 642c 206e 6531 3220 3d20 2535 642c 206e  d, ne12 = %5d, n
-0004f930: 6531 3320 3d20 2535 645c 6e22 2c20 6e65  e13 = %5d\n", ne
-0004f940: 3130 2c20 6e65 3131 2c20 6e65 3132 2c20  10, ne11, ne12, 
-0004f950: 6e65 3133 293b 0a20 2020 202f 2f20 2020  ne13);.    //   
-0004f960: 2070 7269 6e74 6628 226e 6231 3020 3d20   printf("nb10 = 
-0004f970: 2535 642c 206e 6231 3120 3d20 2535 642c  %5d, nb11 = %5d,
-0004f980: 206e 6231 3220 3d20 2535 642c 206e 6231   nb12 = %5d, nb1
-0004f990: 3320 3d20 2535 645c 6e22 2c20 6e62 3130  3 = %5d\n", nb10
-0004f9a0: 2c20 6e62 3131 2c20 6e62 3132 2c20 6e62  , nb11, nb12, nb
-0004f9b0: 3133 293b 0a0a 2020 2020 2f2f 2020 2020  13);..    //    
-0004f9c0: 7072 696e 7466 2822 5858 5858 5858 5858  printf("XXXXXXXX
-0004f9d0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-0004f9e0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-0004f9f0: 5858 5858 5858 5858 5858 5858 2074 6173  XXXXXXXXXXXX tas
-0004fa00: 6b20 2564 2f25 643a 2025 6420 7573 2c20  k %d/%d: %d us, 
-0004fa10: 6163 6320 3d20 2564 5c6e 222c 2069 7468  acc = %d\n", ith
-0004fa20: 2c20 6e74 682c 2028 696e 7429 2028 7431  , nth, (int) (t1
-0004fa30: 202d 2074 3029 2c20 2869 6e74 2920 6163   - t0), (int) ac
-0004fa40: 6329 3b0a 2020 2020 2f2f 7d0a 7d0a 0a73  c);.    //}.}..s
-0004fa50: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0004fa60: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0004fa70: 6d75 6c5f 6d61 745f 6631 365f 6633 3228  mul_mat_f16_f32(
-0004fa80: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0004fa90: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0004faa0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-0004fab0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-0004fac0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0004fad0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-0004fae0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0004faf0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0004fb00: 7372 6331 2c0a 2020 2020 2020 2020 2020  src1,.          
-0004fb10: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0004fb20: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-0004fb30: 2020 2020 696e 7436 345f 7420 7430 203d      int64_t t0 =
-0004fb40: 2067 676d 6c5f 7065 7266 5f74 696d 655f   ggml_perf_time_
-0004fb50: 7573 2829 3b0a 2020 2020 554e 5553 4544  us();.    UNUSED
-0004fb60: 2874 3029 3b0a 0a20 2020 2063 6f6e 7374  (t0);..    const
-0004fb70: 2069 6e74 3634 5f74 206e 6530 3020 3d20   int64_t ne00 = 
-0004fb80: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
-0004fb90: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-0004fba0: 6530 3120 3d20 7372 6330 2d3e 6e65 5b31  e01 = src0->ne[1
-0004fbb0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0004fbc0: 3634 5f74 206e 6530 3220 3d20 7372 6330  64_t ne02 = src0
-0004fbd0: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
-0004fbe0: 7374 2069 6e74 3634 5f74 206e 6530 3320  st int64_t ne03 
-0004fbf0: 3d20 7372 6330 2d3e 6e65 5b33 5d3b 0a0a  = src0->ne[3];..
-0004fc00: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0004fc10: 7420 6e65 3130 203d 2073 7263 312d 3e6e  t ne10 = src1->n
-0004fc20: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-0004fc30: 696e 7436 345f 7420 6e65 3131 203d 2073  int64_t ne11 = s
-0004fc40: 7263 312d 3e6e 655b 315d 3b0a 2020 2020  rc1->ne[1];.    
-0004fc50: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0004fc60: 3132 203d 2073 7263 312d 3e6e 655b 325d  12 = src1->ne[2]
-0004fc70: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-0004fc80: 345f 7420 6e65 3133 203d 2073 7263 312d  4_t ne13 = src1-
-0004fc90: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
-0004fca0: 7374 2069 6e74 3634 5f74 206e 6530 2020  st int64_t ne0  
-0004fcb0: 3d20 6473 742d 3e6e 655b 305d 3b0a 2020  = dst->ne[0];.  
-0004fcc0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0004fcd0: 6e65 3120 203d 2064 7374 2d3e 6e65 5b31  ne1  = dst->ne[1
-0004fce0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0004fcf0: 3634 5f74 206e 6532 2020 3d20 6473 742d  64_t ne2  = dst-
-0004fd00: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-0004fd10: 7420 696e 7436 345f 7420 6e65 3320 203d  t int64_t ne3  =
-0004fd20: 2064 7374 2d3e 6e65 5b33 5d3b 0a20 2020   dst->ne[3];.   
-0004fd30: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-0004fd40: 206e 6520 2020 3d20 6e65 302a 6e65 312a   ne   = ne0*ne1*
-0004fd50: 6e65 322a 6e65 333b 0a0a 2020 2020 636f  ne2*ne3;..    co
-0004fd60: 6e73 7420 696e 7420 6e62 3030 203d 2073  nst int nb00 = s
-0004fd70: 7263 302d 3e6e 625b 305d 3b0a 2020 2020  rc0->nb[0];.    
-0004fd80: 636f 6e73 7420 696e 7420 6e62 3031 203d  const int nb01 =
-0004fd90: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
-0004fda0: 2020 636f 6e73 7420 696e 7420 6e62 3032    const int nb02
-0004fdb0: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
-0004fdc0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-0004fdd0: 3033 203d 2073 7263 302d 3e6e 625b 335d  03 = src0->nb[3]
-0004fde0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0004fdf0: 206e 6231 3020 3d20 7372 6331 2d3e 6e62   nb10 = src1->nb
-0004fe00: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-0004fe10: 6e74 206e 6231 3120 3d20 7372 6331 2d3e  nt nb11 = src1->
-0004fe20: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-0004fe30: 2069 6e74 206e 6231 3220 3d20 7372 6331   int nb12 = src1
-0004fe40: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-0004fe50: 7374 2069 6e74 206e 6231 3320 3d20 7372  st int nb13 = sr
-0004fe60: 6331 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c1->nb[3];..    
-0004fe70: 636f 6e73 7420 696e 7420 6e62 3020 203d  const int nb0  =
-0004fe80: 2064 7374 2d3e 6e62 5b30 5d3b 0a20 2020   dst->nb[0];.   
-0004fe90: 2063 6f6e 7374 2069 6e74 206e 6231 2020   const int nb1  
-0004fea0: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
-0004feb0: 2020 636f 6e73 7420 696e 7420 6e62 3220    const int nb2 
-0004fec0: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
-0004fed0: 2020 2063 6f6e 7374 2069 6e74 206e 6233     const int nb3
-0004fee0: 2020 3d20 6473 742d 3e6e 625b 335d 3b0a    = dst->nb[3];.
-0004fef0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-0004ff00: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
-0004ff10: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0004ff20: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
-0004ff30: 683b 0a0a 2020 2020 4747 4d4c 5f41 5353  h;..    GGML_ASS
-0004ff40: 4552 5428 6e65 3032 203d 3d20 6e65 3132  ERT(ne02 == ne12
-0004ff50: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0004ff60: 5254 286e 6530 3320 3d3d 206e 6531 3329  RT(ne03 == ne13)
-0004ff70: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0004ff80: 5428 6e65 3220 203d 3d20 6e65 3132 293b  T(ne2  == ne12);
-0004ff90: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0004ffa0: 286e 6533 2020 3d3d 206e 6531 3329 3b0a  (ne3  == ne13);.
-0004ffb0: 0a20 2020 202f 2f20 544f 444f 3a20 7765  .    // TODO: we
-0004ffc0: 2064 6f6e 2774 2073 7570 706f 7274 2070   don't support p
-0004ffd0: 6572 6d75 7465 6420 7372 6330 0a20 2020  ermuted src0.   
-0004ffe0: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
-0004fff0: 3020 3d3d 2073 697a 656f 6628 6767 6d6c  0 == sizeof(ggml
-00050000: 5f66 7031 365f 7429 293b 0a0a 2020 2020  _fp16_t));..    
-00050010: 2f2f 2064 7374 2063 616e 6e6f 7420 6265  // dst cannot be
-00050020: 2074 7261 6e73 706f 7365 6420 6f72 2070   transposed or p
-00050030: 6572 6d75 7465 640a 2020 2020 4747 4d4c  ermuted.    GGML
-00050040: 5f41 5353 4552 5428 6e62 3020 3d3d 2073  _ASSERT(nb0 == s
-00050050: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
-00050060: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00050070: 6230 203c 3d20 6e62 3129 3b0a 2020 2020  b0 <= nb1);.    
-00050080: 4747 4d4c 5f41 5353 4552 5428 6e62 3120  GGML_ASSERT(nb1 
-00050090: 3c3d 206e 6232 293b 0a20 2020 2047 474d  <= nb2);.    GGM
-000500a0: 4c5f 4153 5345 5254 286e 6232 203c 3d20  L_ASSERT(nb2 <= 
-000500b0: 6e62 3329 3b0a 0a20 2020 2047 474d 4c5f  nb3);..    GGML_
-000500c0: 4153 5345 5254 286e 6530 203d 3d20 6e65  ASSERT(ne0 == ne
-000500d0: 3031 293b 0a20 2020 2047 474d 4c5f 4153  01);.    GGML_AS
-000500e0: 5345 5254 286e 6531 203d 3d20 6e65 3131  SERT(ne1 == ne11
-000500f0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00050100: 5254 286e 6532 203d 3d20 6e65 3032 293b  RT(ne2 == ne02);
-00050110: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00050120: 286e 6533 203d 3d20 6e65 3033 293b 0a0a  (ne3 == ne03);..
-00050130: 2020 2020 2f2f 206e 6230 3120 3e3d 206e      // nb01 >= n
-00050140: 6230 3020 2d20 7372 6330 2069 7320 6e6f  b00 - src0 is no
-00050150: 7420 7472 616e 7370 6f73 6564 0a20 2020  t transposed.   
-00050160: 202f 2f20 2020 636f 6d70 7574 6520 6279   //   compute by
-00050170: 2073 7263 3020 726f 7773 0a0a 2369 6620   src0 rows..#if 
-00050180: 6465 6669 6e65 6428 4747 4d4c 5f55 5345  defined(GGML_USE
-00050190: 5f43 4c42 4c41 5354 290a 2020 2020 6966  _CLBLAST).    if
-000501a0: 2028 6767 6d6c 5f63 6c5f 6361 6e5f 6d75   (ggml_cl_can_mu
-000501b0: 6c5f 6d61 7428 7372 6330 2c20 7372 6331  l_mat(src0, src1
-000501c0: 2c20 6473 7429 2920 7b0a 2020 2020 2020  , dst)) {.      
-000501d0: 2020 6966 2028 7061 7261 6d73 2d3e 6974    if (params->it
-000501e0: 6820 3d3d 2030 2026 2620 7061 7261 6d73  h == 0 && params
-000501f0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00050200: 4153 4b5f 434f 4d50 5554 4529 207b 0a20  ASK_COMPUTE) {. 
-00050210: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00050220: 636c 5f6d 756c 5f6d 6174 2873 7263 302c  cl_mul_mat(src0,
-00050230: 2073 7263 312c 2064 7374 2c20 7061 7261   src1, dst, para
-00050240: 6d73 2d3e 7764 6174 612c 2070 6172 616d  ms->wdata, param
-00050250: 732d 3e77 7369 7a65 293b 0a20 2020 2020  s->wsize);.     
-00050260: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
-00050270: 7572 6e3b 0a20 2020 207d 0a23 656e 6469  urn;.    }.#endi
-00050280: 660a 0a23 6966 2064 6566 696e 6564 2847  f..#if defined(G
-00050290: 474d 4c5f 5553 455f 4143 4345 4c45 5241  GML_USE_ACCELERA
-000502a0: 5445 2920 7c7c 2064 6566 696e 6564 2847  TE) || defined(G
-000502b0: 474d 4c5f 5553 455f 4f50 454e 424c 4153  GML_USE_OPENBLAS
-000502c0: 290a 2020 2020 6966 2028 6767 6d6c 5f63  ).    if (ggml_c
-000502d0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-000502e0: 756c 5f6d 6174 5f75 7365 5f62 6c61 7328  ul_mat_use_blas(
-000502f0: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
-00050300: 2920 7b0a 2020 2020 2020 2020 4747 4d4c  ) {.        GGML
-00050310: 5f41 5353 4552 5428 6e62 3130 203d 3d20  _ASSERT(nb10 == 
-00050320: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+0004eee0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+0004eef0: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
+0004ef00: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+0004ef10: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0004ef20: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+0004ef30: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+0004ef40: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+0004ef50: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+0004ef60: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0004ef70: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0004ef80: 3033 203d 2030 3b20 6930 3320 3c20 6e65  03 = 0; i03 < ne
+0004ef90: 3033 3b20 6930 332b 2b29 207b 0a20 2020  03; i03++) {.   
+0004efa0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0004efb0: 7436 345f 7420 6930 3220 3d20 303b 2069  t64_t i02 = 0; i
+0004efc0: 3032 203c 206e 6530 323b 2069 3032 2b2b  02 < ne02; i02++
+0004efd0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0004efe0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+0004eff0: 2a20 7820 3d20 2866 6c6f 6174 202a 2920  * x = (float *) 
+0004f000: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+0004f010: 6461 7461 202b 2069 3032 2a6e 6230 3220  data + i02*nb02 
+0004f020: 2b20 6930 332a 6e62 3033 293b 0a20 2020  + i03*nb03);.   
+0004f030: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0004f040: 7374 2066 6c6f 6174 202a 2079 203d 2028  st float * y = (
+0004f050: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+0004f060: 2a29 2073 7263 312d 3e64 6174 6120 2b20  *) src1->data + 
+0004f070: 6930 322a 6e62 3132 202b 2069 3033 2a6e  i02*nb12 + i03*n
+0004f080: 6231 3329 3b0a 2020 2020 2020 2020 2020  b13);.          
+0004f090: 2020 2020 2020 666c 6f61 7420 2a20 6420        float * d 
+0004f0a0: 3d20 2866 6c6f 6174 202a 2920 2828 6368  = (float *) ((ch
+0004f0b0: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+0004f0c0: 2b20 6930 322a 6e62 3220 2b20 6930 332a  + i02*nb2 + i03*
+0004f0d0: 6e62 3329 3b0a 0a20 2020 2020 2020 2020  nb3);..         
+0004f0e0: 2020 2020 2020 2063 626c 6173 5f73 6765         cblas_sge
+0004f0f0: 6d6d 2843 626c 6173 526f 774d 616a 6f72  mm(CblasRowMajor
+0004f100: 2c20 4362 6c61 734e 6f54 7261 6e73 2c20  , CblasNoTrans, 
+0004f110: 4362 6c61 7354 7261 6e73 2c0a 2020 2020  CblasTrans,.    
+0004f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f130: 2020 2020 6e65 3131 2c20 6e65 3031 2c20      ne11, ne01, 
+0004f140: 6e65 3130 2c0a 2020 2020 2020 2020 2020  ne10,.          
+0004f150: 2020 2020 2020 2020 2020 2020 2020 312e                1.
+0004f160: 3066 2c20 2020 2079 2c20 6e65 3130 2c0a  0f,    y, ne10,.
+0004f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f190: 2078 2c20 6e65 3030 2c0a 2020 2020 2020   x, ne00,.      
+0004f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f1b0: 2020 302e 3066 2c20 2020 2064 2c20 6e65    0.0f,    d, ne
+0004f1c0: 3031 293b 0a20 2020 2020 2020 2020 2020  01);.           
+0004f1d0: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
+0004f1e0: 2020 2020 202f 2f70 7269 6e74 6628 2243       //printf("C
+0004f1f0: 424c 4153 2046 3332 203d 2025 6620 6d73  BLAS F32 = %f ms
+0004f200: 2c20 2564 2078 2025 6420 7820 2564 2078  , %d x %d x %d x
+0004f210: 2025 645c 6e22 2c20 2867 676d 6c5f 7065   %d\n", (ggml_pe
+0004f220: 7266 5f74 696d 655f 7573 2829 202d 2074  rf_time_us() - t
+0004f230: 3029 2f31 3030 302e 302c 206e 6530 2c20  0)/1000.0, ne0, 
+0004f240: 6e65 312c 206e 6532 2c20 6e65 3329 3b0a  ne1, ne2, ne3);.
+0004f250: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+0004f260: 0a20 2020 207d 0a23 656e 6469 660a 0a20  .    }.#endif.. 
+0004f270: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+0004f280: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+0004f290: 5f49 4e49 5429 207b 0a20 2020 2020 2020  _INIT) {.       
+0004f2a0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+0004f2b0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+0004f2c0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+0004f2d0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+0004f2e0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+0004f2f0: 2020 7d0a 0a20 2020 202f 2f20 7061 7261    }..    // para
+0004f300: 6c6c 656c 697a 6520 6279 2073 7263 3020  llelize by src0 
+0004f310: 726f 7773 2075 7369 6e67 2067 676d 6c5f  rows using ggml_
+0004f320: 7665 635f 646f 745f 6633 320a 0a20 2020  vec_dot_f32..   
+0004f330: 202f 2f20 746f 7461 6c20 726f 7773 2069   // total rows i
+0004f340: 6e20 7372 6330 0a20 2020 2063 6f6e 7374  n src0.    const
+0004f350: 2069 6e74 206e 7220 3d20 6e65 3031 2a6e   int nr = ne01*n
+0004f360: 6530 322a 6e65 3033 3b0a 0a20 2020 202f  e02*ne03;..    /
+0004f370: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
+0004f380: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
+0004f390: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
+0004f3a0: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
+0004f3b0: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
+0004f3c0: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
+0004f3d0: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
+0004f3e0: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
+0004f3f0: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
+0004f400: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
+0004f410: 2020 2066 6f72 2028 696e 7420 6972 203d     for (int ir =
+0004f420: 2069 7230 3b20 6972 203c 2069 7231 3b20   ir0; ir < ir1; 
+0004f430: 2b2b 6972 2920 7b0a 2020 2020 2020 2020  ++ir) {.        
+0004f440: 2f2f 2073 7263 3020 696e 6469 6365 730a  // src0 indices.
+0004f450: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0004f460: 7420 6930 3320 3d20 6972 2f28 6e65 3032  t i03 = ir/(ne02
+0004f470: 2a6e 6530 3129 3b0a 2020 2020 2020 2020  *ne01);.        
+0004f480: 636f 6e73 7420 696e 7420 6930 3220 3d20  const int i02 = 
+0004f490: 2869 7220 2d20 6930 332a 6e65 3032 2a6e  (ir - i03*ne02*n
+0004f4a0: 6530 3129 2f6e 6530 313b 0a20 2020 2020  e01)/ne01;.     
+0004f4b0: 2020 2063 6f6e 7374 2069 6e74 2069 3031     const int i01
+0004f4c0: 203d 2028 6972 202d 2069 3033 2a6e 6530   = (ir - i03*ne0
+0004f4d0: 322a 6e65 3031 202d 2069 3032 2a6e 6530  2*ne01 - i02*ne0
+0004f4e0: 3129 3b0a 0a20 2020 2020 2020 2066 6f72  1);..        for
+0004f4f0: 2028 696e 7436 345f 7420 6963 203d 2030   (int64_t ic = 0
+0004f500: 3b20 6963 203c 206e 6531 313b 202b 2b69  ; ic < ne11; ++i
+0004f510: 6329 207b 0a20 2020 2020 2020 2020 2020  c) {.           
+0004f520: 202f 2f20 7372 6331 2069 6e64 6963 6573   // src1 indices
+0004f530: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0004f540: 7374 2069 6e74 2069 3133 203d 2069 3033  st int i13 = i03
+0004f550: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+0004f560: 6e73 7420 696e 7420 6931 3220 3d20 6930  nst int i12 = i0
+0004f570: 323b 0a20 2020 2020 2020 2020 2020 2063  2;.            c
+0004f580: 6f6e 7374 2069 6e74 2069 3131 203d 2069  onst int i11 = i
+0004f590: 633b 0a0a 2020 2020 2020 2020 2020 2020  c;..            
+0004f5a0: 2f2f 2064 7374 2069 6e64 6963 6573 0a20  // dst indices. 
+0004f5b0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0004f5c0: 2069 6e74 2069 3020 3d20 6930 313b 0a20   int i0 = i01;. 
+0004f5d0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0004f5e0: 2069 6e74 2069 3120 3d20 6931 313b 0a20   int i1 = i11;. 
+0004f5f0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0004f600: 2069 6e74 2069 3220 3d20 6930 323b 0a20   int i2 = i02;. 
+0004f610: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0004f620: 2069 6e74 2069 3320 3d20 6930 333b 0a0a   int i3 = i03;..
+0004f630: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0004f640: 5f76 6563 5f64 6f74 5f66 3332 286e 6530  _vec_dot_f32(ne0
+0004f650: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+0004f660: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+0004f670: 2028 2863 6861 7220 2a29 2020 6473 742d   ((char *)  dst-
+0004f680: 3e64 6174 6120 2b20 2869 302a 6e62 3020  >data + (i0*nb0 
+0004f690: 2b20 6931 2a6e 6231 202b 2069 322a 6e62  + i1*nb1 + i2*nb
+0004f6a0: 3220 2b20 6933 2a6e 6233 2929 2c0a 2020  2 + i3*nb3)),.  
+0004f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f6c0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+0004f6d0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+0004f6e0: 202b 2028 6930 312a 6e62 3031 202b 2069   + (i01*nb01 + i
+0004f6f0: 3032 2a6e 6230 3220 2b20 6930 332a 6e62  02*nb02 + i03*nb
+0004f700: 3033 2929 2c0a 2020 2020 2020 2020 2020  03)),.          
+0004f710: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+0004f720: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
+0004f730: 6331 2d3e 6461 7461 202b 2028 6931 312a  c1->data + (i11*
+0004f740: 6e62 3131 202b 2069 3132 2a6e 6231 3220  nb11 + i12*nb12 
+0004f750: 2b20 6931 332a 6e62 3133 2929 293b 0a20  + i13*nb13)));. 
+0004f760: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+0004f770: 2020 2020 2f2f 696e 7436 345f 7420 7431      //int64_t t1
+0004f780: 203d 2067 676d 6c5f 7065 7266 5f74 696d   = ggml_perf_tim
+0004f790: 655f 7573 2829 3b0a 2020 2020 2f2f 7374  e_us();.    //st
+0004f7a0: 6174 6963 2069 6e74 3634 5f74 2061 6363  atic int64_t acc
+0004f7b0: 203d 2030 3b0a 2020 2020 2f2f 6163 6320   = 0;.    //acc 
+0004f7c0: 2b3d 2074 3120 2d20 7430 3b0a 2020 2020  += t1 - t0;.    
+0004f7d0: 2f2f 6966 2028 7431 202d 2074 3020 3e20  //if (t1 - t0 > 
+0004f7e0: 3130 2920 7b0a 2020 2020 2f2f 2020 2020  10) {.    //    
+0004f7f0: 7072 696e 7466 2822 5c6e 2229 3b0a 2020  printf("\n");.  
+0004f800: 2020 2f2f 2020 2020 7072 696e 7466 2822    //    printf("
+0004f810: 6e65 3030 203d 2025 3564 2c20 6e65 3031  ne00 = %5d, ne01
+0004f820: 203d 2025 3564 2c20 6e65 3032 203d 2025   = %5d, ne02 = %
+0004f830: 3564 2c20 6e65 3033 203d 2025 3564 5c6e  5d, ne03 = %5d\n
+0004f840: 222c 206e 6530 302c 206e 6530 312c 206e  ", ne00, ne01, n
+0004f850: 6530 322c 206e 6530 3329 3b0a 2020 2020  e02, ne03);.    
+0004f860: 2f2f 2020 2020 7072 696e 7466 2822 6e62  //    printf("nb
+0004f870: 3030 203d 2025 3564 2c20 6e62 3031 203d  00 = %5d, nb01 =
+0004f880: 2025 3564 2c20 6e62 3032 203d 2025 3564   %5d, nb02 = %5d
+0004f890: 2c20 6e62 3033 203d 2025 3564 5c6e 222c  , nb03 = %5d\n",
+0004f8a0: 206e 6230 302c 206e 6230 312c 206e 6230   nb00, nb01, nb0
+0004f8b0: 322c 206e 6230 3329 3b0a 2020 2020 2f2f  2, nb03);.    //
+0004f8c0: 2020 2020 7072 696e 7466 2822 6e65 3130      printf("ne10
+0004f8d0: 203d 2025 3564 2c20 6e65 3131 203d 2025   = %5d, ne11 = %
+0004f8e0: 3564 2c20 6e65 3132 203d 2025 3564 2c20  5d, ne12 = %5d, 
+0004f8f0: 6e65 3133 203d 2025 3564 5c6e 222c 206e  ne13 = %5d\n", n
+0004f900: 6531 302c 206e 6531 312c 206e 6531 322c  e10, ne11, ne12,
+0004f910: 206e 6531 3329 3b0a 2020 2020 2f2f 2020   ne13);.    //  
+0004f920: 2020 7072 696e 7466 2822 6e62 3130 203d    printf("nb10 =
+0004f930: 2025 3564 2c20 6e62 3131 203d 2025 3564   %5d, nb11 = %5d
+0004f940: 2c20 6e62 3132 203d 2025 3564 2c20 6e62  , nb12 = %5d, nb
+0004f950: 3133 203d 2025 3564 5c6e 222c 206e 6231  13 = %5d\n", nb1
+0004f960: 302c 206e 6231 312c 206e 6231 322c 206e  0, nb11, nb12, n
+0004f970: 6231 3329 3b0a 0a20 2020 202f 2f20 2020  b13);..    //   
+0004f980: 2070 7269 6e74 6628 2258 5858 5858 5858   printf("XXXXXXX
+0004f990: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+0004f9a0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+0004f9b0: 5858 5858 5858 5858 5858 5858 5820 7461  XXXXXXXXXXXXX ta
+0004f9c0: 736b 2025 642f 2564 3a20 2564 2075 732c  sk %d/%d: %d us,
+0004f9d0: 2061 6363 203d 2025 645c 6e22 2c20 6974   acc = %d\n", it
+0004f9e0: 682c 206e 7468 2c20 2869 6e74 2920 2874  h, nth, (int) (t
+0004f9f0: 3120 2d20 7430 292c 2028 696e 7429 2061  1 - t0), (int) a
+0004fa00: 6363 293b 0a20 2020 202f 2f7d 0a7d 0a0a  cc);.    //}.}..
+0004fa10: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+0004fa20: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0004fa30: 5f6d 756c 5f6d 6174 5f66 3136 5f66 3332  _mul_mat_f16_f32
+0004fa40: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0004fa50: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0004fa60: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0004fa70: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0004fa80: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0004fa90: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0004faa0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0004fab0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0004fac0: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
+0004fad0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0004fae0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+0004faf0: 0a20 2020 2069 6e74 3634 5f74 2074 3020  .    int64_t t0 
+0004fb00: 3d20 6767 6d6c 5f70 6572 665f 7469 6d65  = ggml_perf_time
+0004fb10: 5f75 7328 293b 0a20 2020 2055 4e55 5345  _us();.    UNUSE
+0004fb20: 4428 7430 293b 0a0a 2020 2020 636f 6e73  D(t0);..    cons
+0004fb30: 7420 696e 7436 345f 7420 6e65 3030 203d  t int64_t ne00 =
+0004fb40: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
+0004fb50: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+0004fb60: 6e65 3031 203d 2073 7263 302d 3e6e 655b  ne01 = src0->ne[
+0004fb70: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
+0004fb80: 7436 345f 7420 6e65 3032 203d 2073 7263  t64_t ne02 = src
+0004fb90: 302d 3e6e 655b 325d 3b0a 2020 2020 636f  0->ne[2];.    co
+0004fba0: 6e73 7420 696e 7436 345f 7420 6e65 3033  nst int64_t ne03
+0004fbb0: 203d 2073 7263 302d 3e6e 655b 335d 3b0a   = src0->ne[3];.
+0004fbc0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0004fbd0: 5f74 206e 6531 3020 3d20 7372 6331 2d3e  _t ne10 = src1->
+0004fbe0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+0004fbf0: 2069 6e74 3634 5f74 206e 6531 3120 3d20   int64_t ne11 = 
+0004fc00: 7372 6331 2d3e 6e65 5b31 5d3b 0a20 2020  src1->ne[1];.   
+0004fc10: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0004fc20: 6531 3220 3d20 7372 6331 2d3e 6e65 5b32  e12 = src1->ne[2
+0004fc30: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0004fc40: 3634 5f74 206e 6531 3320 3d20 7372 6331  64_t ne13 = src1
+0004fc50: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
+0004fc60: 6e73 7420 696e 7436 345f 7420 6e65 3020  nst int64_t ne0 
+0004fc70: 203d 2064 7374 2d3e 6e65 5b30 5d3b 0a20   = dst->ne[0];. 
+0004fc80: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+0004fc90: 206e 6531 2020 3d20 6473 742d 3e6e 655b   ne1  = dst->ne[
+0004fca0: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
+0004fcb0: 7436 345f 7420 6e65 3220 203d 2064 7374  t64_t ne2  = dst
+0004fcc0: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
+0004fcd0: 7374 2069 6e74 3634 5f74 206e 6533 2020  st int64_t ne3  
+0004fce0: 3d20 6473 742d 3e6e 655b 335d 3b0a 2020  = dst->ne[3];.  
+0004fcf0: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+0004fd00: 7420 6e65 2020 203d 206e 6530 2a6e 6531  t ne   = ne0*ne1
+0004fd10: 2a6e 6532 2a6e 6533 3b0a 0a20 2020 2063  *ne2*ne3;..    c
+0004fd20: 6f6e 7374 2069 6e74 206e 6230 3020 3d20  onst int nb00 = 
+0004fd30: 7372 6330 2d3e 6e62 5b30 5d3b 0a20 2020  src0->nb[0];.   
+0004fd40: 2063 6f6e 7374 2069 6e74 206e 6230 3120   const int nb01 
+0004fd50: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a20  = src0->nb[1];. 
+0004fd60: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
+0004fd70: 3220 3d20 7372 6330 2d3e 6e62 5b32 5d3b  2 = src0->nb[2];
+0004fd80: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0004fd90: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
+0004fda0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+0004fdb0: 7420 6e62 3130 203d 2073 7263 312d 3e6e  t nb10 = src1->n
+0004fdc0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+0004fdd0: 696e 7420 6e62 3131 203d 2073 7263 312d  int nb11 = src1-
+0004fde0: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+0004fdf0: 7420 696e 7420 6e62 3132 203d 2073 7263  t int nb12 = src
+0004fe00: 312d 3e6e 625b 325d 3b0a 2020 2020 636f  1->nb[2];.    co
+0004fe10: 6e73 7420 696e 7420 6e62 3133 203d 2073  nst int nb13 = s
+0004fe20: 7263 312d 3e6e 625b 335d 3b0a 0a20 2020  rc1->nb[3];..   
+0004fe30: 2063 6f6e 7374 2069 6e74 206e 6230 2020   const int nb0  
+0004fe40: 3d20 6473 742d 3e6e 625b 305d 3b0a 2020  = dst->nb[0];.  
+0004fe50: 2020 636f 6e73 7420 696e 7420 6e62 3120    const int nb1 
+0004fe60: 203d 2064 7374 2d3e 6e62 5b31 5d3b 0a20   = dst->nb[1];. 
+0004fe70: 2020 2063 6f6e 7374 2069 6e74 206e 6232     const int nb2
+0004fe80: 2020 3d20 6473 742d 3e6e 625b 325d 3b0a    = dst->nb[2];.
+0004fe90: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+0004fea0: 3320 203d 2064 7374 2d3e 6e62 5b33 5d3b  3  = dst->nb[3];
+0004feb0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0004fec0: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
+0004fed0: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
+0004fee0: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
+0004fef0: 7468 3b0a 0a20 2020 2047 474d 4c5f 4153  th;..    GGML_AS
+0004ff00: 5345 5254 286e 6530 3220 3d3d 206e 6531  SERT(ne02 == ne1
+0004ff10: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
+0004ff20: 4552 5428 6e65 3033 203d 3d20 6e65 3133  ERT(ne03 == ne13
+0004ff30: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0004ff40: 5254 286e 6532 2020 3d3d 206e 6531 3229  RT(ne2  == ne12)
+0004ff50: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0004ff60: 5428 6e65 3320 203d 3d20 6e65 3133 293b  T(ne3  == ne13);
+0004ff70: 0a0a 2020 2020 2f2f 2054 4f44 4f3a 2077  ..    // TODO: w
+0004ff80: 6520 646f 6e27 7420 7375 7070 6f72 7420  e don't support 
+0004ff90: 7065 726d 7574 6564 2073 7263 300a 2020  permuted src0.  
+0004ffa0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+0004ffb0: 3030 203d 3d20 7369 7a65 6f66 2867 676d  00 == sizeof(ggm
+0004ffc0: 6c5f 6670 3136 5f74 2929 3b0a 0a20 2020  l_fp16_t));..   
+0004ffd0: 202f 2f20 6473 7420 6361 6e6e 6f74 2062   // dst cannot b
+0004ffe0: 6520 7472 616e 7370 6f73 6564 206f 7220  e transposed or 
+0004fff0: 7065 726d 7574 6564 0a20 2020 2047 474d  permuted.    GGM
+00050000: 4c5f 4153 5345 5254 286e 6230 203d 3d20  L_ASSERT(nb0 == 
+00050010: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+00050020: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00050030: 6e62 3020 3c3d 206e 6231 293b 0a20 2020  nb0 <= nb1);.   
+00050040: 2047 474d 4c5f 4153 5345 5254 286e 6231   GGML_ASSERT(nb1
+00050050: 203c 3d20 6e62 3229 3b0a 2020 2020 4747   <= nb2);.    GG
+00050060: 4d4c 5f41 5353 4552 5428 6e62 3220 3c3d  ML_ASSERT(nb2 <=
+00050070: 206e 6233 293b 0a0a 2020 2020 4747 4d4c   nb3);..    GGML
+00050080: 5f41 5353 4552 5428 6e65 3020 3d3d 206e  _ASSERT(ne0 == n
+00050090: 6530 3129 3b0a 2020 2020 4747 4d4c 5f41  e01);.    GGML_A
+000500a0: 5353 4552 5428 6e65 3120 3d3d 206e 6531  SSERT(ne1 == ne1
+000500b0: 3129 3b0a 2020 2020 4747 4d4c 5f41 5353  1);.    GGML_ASS
+000500c0: 4552 5428 6e65 3220 3d3d 206e 6530 3229  ERT(ne2 == ne02)
+000500d0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+000500e0: 5428 6e65 3320 3d3d 206e 6530 3329 3b0a  T(ne3 == ne03);.
+000500f0: 0a20 2020 202f 2f20 6e62 3031 203e 3d20  .    // nb01 >= 
+00050100: 6e62 3030 202d 2073 7263 3020 6973 206e  nb00 - src0 is n
+00050110: 6f74 2074 7261 6e73 706f 7365 640a 2020  ot transposed.  
+00050120: 2020 2f2f 2020 2063 6f6d 7075 7465 2062    //   compute b
+00050130: 7920 7372 6330 2072 6f77 730a 0a23 6966  y src0 rows..#if
+00050140: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
+00050150: 455f 434c 424c 4153 5429 0a20 2020 2069  E_CLBLAST).    i
+00050160: 6620 2867 676d 6c5f 636c 5f63 616e 5f6d  f (ggml_cl_can_m
+00050170: 756c 5f6d 6174 2873 7263 302c 2073 7263  ul_mat(src0, src
+00050180: 312c 2064 7374 2929 207b 0a20 2020 2020  1, dst)) {.     
+00050190: 2020 2069 6620 2870 6172 616d 732d 3e69     if (params->i
+000501a0: 7468 203d 3d20 3020 2626 2070 6172 616d  th == 0 && param
+000501b0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+000501c0: 5441 534b 5f43 4f4d 5055 5445 2920 7b0a  TASK_COMPUTE) {.
+000501d0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000501e0: 5f63 6c5f 6d75 6c5f 6d61 7428 7372 6330  _cl_mul_mat(src0
+000501f0: 2c20 7372 6331 2c20 6473 742c 2070 6172  , src1, dst, par
+00050200: 616d 732d 3e77 6461 7461 2c20 7061 7261  ams->wdata, para
+00050210: 6d73 2d3e 7773 697a 6529 3b0a 2020 2020  ms->wsize);.    
+00050220: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
+00050230: 7475 726e 3b0a 2020 2020 7d0a 2365 6e64  turn;.    }.#end
+00050240: 6966 0a0a 2369 6620 6465 6669 6e65 6428  if..#if defined(
+00050250: 4747 4d4c 5f55 5345 5f41 4343 454c 4552  GGML_USE_ACCELER
+00050260: 4154 4529 207c 7c20 6465 6669 6e65 6428  ATE) || defined(
+00050270: 4747 4d4c 5f55 5345 5f4f 5045 4e42 4c41  GGML_USE_OPENBLA
+00050280: 5329 0a20 2020 2069 6620 2867 676d 6c5f  S).    if (ggml_
+00050290: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000502a0: 6d75 6c5f 6d61 745f 7573 655f 626c 6173  mul_mat_use_blas
+000502b0: 2873 7263 302c 2073 7263 312c 2064 7374  (src0, src1, dst
+000502c0: 2929 207b 0a20 2020 2020 2020 2047 474d  )) {.        GGM
+000502d0: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
+000502e0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+000502f0: 0a0a 2020 2020 2020 2020 6966 2028 7061  ..        if (pa
+00050300: 7261 6d73 2d3e 6974 6820 213d 2030 2920  rams->ith != 0) 
+00050310: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
+00050320: 7475 726e 3b0a 2020 2020 2020 2020 7d0a  turn;.        }.
 00050330: 0a20 2020 2020 2020 2069 6620 2870 6172  .        if (par
-00050340: 616d 732d 3e69 7468 2021 3d20 3029 207b  ams->ith != 0) {
-00050350: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00050360: 7572 6e3b 0a20 2020 2020 2020 207d 0a0a  urn;.        }..
-00050370: 2020 2020 2020 2020 6966 2028 7061 7261          if (para
-00050380: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-00050390: 5f54 4153 4b5f 494e 4954 2920 7b0a 2020  _TASK_INIT) {.  
-000503a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000503b0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-000503c0: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
-000503d0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-000503e0: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
-000503f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00050400: 6e3b 0a20 2020 2020 2020 207d 0a0a 2020  n;.        }..  
-00050410: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00050420: 5f74 2069 3033 203d 2030 3b20 6930 3320  _t i03 = 0; i03 
-00050430: 3c20 6e65 3033 3b20 6930 332b 2b29 207b  < ne03; i03++) {
-00050440: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00050450: 2028 696e 7436 345f 7420 6930 3220 3d20   (int64_t i02 = 
-00050460: 303b 2069 3032 203c 206e 6530 323b 2069  0; i02 < ne02; i
-00050470: 3032 2b2b 2920 7b0a 2020 2020 2020 2020  02++) {.        
-00050480: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-00050490: 636f 6e73 7420 7764 6174 6120 3d20 7061  const wdata = pa
-000504a0: 7261 6d73 2d3e 7764 6174 613b 0a20 2020  rams->wdata;.   
-000504b0: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-000504c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000504d0: 2020 2073 697a 655f 7420 6964 203d 2030     size_t id = 0
-000504e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000504f0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00050500: 5f74 2069 3031 203d 2030 3b20 6930 3120  _t i01 = 0; i01 
-00050510: 3c20 6e65 3031 3b20 2b2b 6930 3129 207b  < ne01; ++i01) {
-00050520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050530: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00050540: 7436 345f 7420 6930 3020 3d20 303b 2069  t64_t i00 = 0; i
-00050550: 3030 203c 206e 6530 303b 202b 2b69 3030  00 < ne00; ++i00
-00050560: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00050570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050580: 7764 6174 615b 6964 2b2b 5d20 3d20 4747  wdata[id++] = GG
-00050590: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
-000505a0: 2a28 6767 6d6c 5f66 7031 365f 7420 2a29  *(ggml_fp16_t *)
-000505b0: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-000505c0: 3e64 6174 6120 2b20 6930 332a 6e62 3033  >data + i03*nb03
-000505d0: 202b 2069 3032 2a6e 6230 3220 2b20 6930   + i02*nb02 + i0
-000505e0: 312a 6e62 3031 202b 2069 3030 2a6e 6230  1*nb01 + i00*nb0
-000505f0: 3029 293b 0a20 2020 2020 2020 2020 2020  0));.           
-00050600: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00050610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050620: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00050630: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00050640: 2869 642a 7369 7a65 6f66 2866 6c6f 6174  (id*sizeof(float
-00050650: 2920 3c3d 2070 6172 616d 732d 3e77 7369  ) <= params->wsi
-00050660: 7a65 293b 0a20 2020 2020 2020 2020 2020  ze);.           
-00050670: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00050680: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-00050690: 6f61 7420 2a20 7820 3d20 7764 6174 613b  oat * x = wdata;
-000506a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000506b0: 2063 6f6e 7374 2066 6c6f 6174 202a 2079   const float * y
-000506c0: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
-000506d0: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
-000506e0: 6120 2b20 6930 322a 6e62 3132 202b 2069  a + i02*nb12 + i
-000506f0: 3033 2a6e 6231 3329 3b0a 0a20 2020 2020  03*nb13);..     
-00050700: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-00050710: 202a 2064 203d 2028 666c 6f61 7420 2a29   * d = (float *)
-00050720: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
-00050730: 6461 7461 202b 2069 3032 2a6e 6232 202b  data + i02*nb2 +
-00050740: 2069 3033 2a6e 6233 293b 0a0a 2020 2020   i03*nb3);..    
-00050750: 2020 2020 2020 2020 2020 2020 2f2f 207a              // z
-00050760: 5420 3d20 7920 2a20 7854 0a20 2020 2020  T = y * xT.     
-00050770: 2020 2020 2020 2020 2020 2063 626c 6173             cblas
-00050780: 5f73 6765 6d6d 2843 626c 6173 526f 774d  _sgemm(CblasRowM
-00050790: 616a 6f72 2c20 4362 6c61 734e 6f54 7261  ajor, CblasNoTra
-000507a0: 6e73 2c20 4362 6c61 7354 7261 6e73 2c0a  ns, CblasTrans,.
-000507b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000507c0: 2020 2020 2020 2020 6e65 3131 2c20 6e65          ne11, ne
-000507d0: 3031 2c20 6e65 3130 2c0a 2020 2020 2020  01, ne10,.      
-000507e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000507f0: 2020 312e 3066 2c20 2020 2079 2c20 6e65    1.0f,    y, ne
-00050800: 3130 2c0a 2020 2020 2020 2020 2020 2020  10,.            
-00050810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050820: 2020 2020 2078 2c20 6e65 3030 2c0a 2020       x, ne00,.  
-00050830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050840: 2020 2020 2020 302e 3066 2c20 2020 2064        0.0f,    d
-00050850: 2c20 6e65 3031 293b 0a20 2020 2020 2020  , ne01);.       
-00050860: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00050870: 0a0a 2020 2020 2020 2020 2f2a 7072 696e  ..        /*prin
-00050880: 7466 2822 4342 4c41 5320 4631 3620 3d20  tf("CBLAS F16 = 
-00050890: 2566 206d 732c 2025 6420 7820 2564 2078  %f ms, %d x %d x
-000508a0: 2025 6420 7820 2564 5c6e 222c 2028 6767   %d x %d\n", (gg
-000508b0: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
-000508c0: 2920 2d20 7430 292f 3130 3030 2e30 2c20  ) - t0)/1000.0, 
-000508d0: 6e65 302c 206e 6531 2c20 6e65 322c 206e  ne0, ne1, ne2, n
-000508e0: 6533 293b 2a2f 0a0a 2020 2020 2020 2020  e3);*/..        
-000508f0: 7265 7475 726e 3b0a 2020 2020 7d0a 2365  return;.    }.#e
-00050900: 6e64 6966 0a0a 2020 2020 6966 2028 7061  ndif..    if (pa
-00050910: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00050920: 4d4c 5f54 4153 4b5f 494e 4954 2920 7b0a  ML_TASK_INIT) {.
-00050930: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
-00050940: 365f 7420 2a20 636f 6e73 7420 7764 6174  6_t * const wdat
-00050950: 6120 3d20 7061 7261 6d73 2d3e 7764 6174  a = params->wdat
-00050960: 613b 0a0a 2020 2020 2020 2020 7369 7a65  a;..        size
-00050970: 5f74 2069 6420 3d20 303b 0a20 2020 2020  _t id = 0;.     
-00050980: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-00050990: 6931 3320 3d20 303b 2069 3133 203c 206e  i13 = 0; i13 < n
-000509a0: 6531 333b 202b 2b69 3133 2920 7b0a 2020  e13; ++i13) {.  
-000509b0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-000509c0: 6e74 3634 5f74 2069 3132 203d 2030 3b20  nt64_t i12 = 0; 
-000509d0: 6931 3220 3c20 6e65 3132 3b20 2b2b 6931  i12 < ne12; ++i1
-000509e0: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
+00050340: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+00050350: 4c5f 5441 534b 5f49 4e49 5429 207b 0a20  L_TASK_INIT) {. 
+00050360: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00050370: 6e3b 0a20 2020 2020 2020 207d 0a0a 2020  n;.        }..  
+00050380: 2020 2020 2020 6966 2028 7061 7261 6d73        if (params
+00050390: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+000503a0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+000503b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000503c0: 726e 3b0a 2020 2020 2020 2020 7d0a 0a20  rn;.        }.. 
+000503d0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+000503e0: 345f 7420 6930 3320 3d20 303b 2069 3033  4_t i03 = 0; i03
+000503f0: 203c 206e 6530 333b 2069 3033 2b2b 2920   < ne03; i03++) 
+00050400: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
+00050410: 7220 2869 6e74 3634 5f74 2069 3032 203d  r (int64_t i02 =
+00050420: 2030 3b20 6930 3220 3c20 6e65 3032 3b20   0; i02 < ne02; 
+00050430: 6930 322b 2b29 207b 0a20 2020 2020 2020  i02++) {.       
+00050440: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+00050450: 2063 6f6e 7374 2077 6461 7461 203d 2070   const wdata = p
+00050460: 6172 616d 732d 3e77 6461 7461 3b0a 2020  arams->wdata;.  
+00050470: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+00050480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050490: 2020 2020 7369 7a65 5f74 2069 6420 3d20      size_t id = 
+000504a0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+000504b0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+000504c0: 345f 7420 6930 3120 3d20 303b 2069 3031  4_t i01 = 0; i01
+000504d0: 203c 206e 6530 313b 202b 2b69 3031 2920   < ne01; ++i01) 
+000504e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000504f0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00050500: 6e74 3634 5f74 2069 3030 203d 2030 3b20  nt64_t i00 = 0; 
+00050510: 6930 3020 3c20 6e65 3030 3b20 2b2b 6930  i00 < ne00; ++i0
+00050520: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+00050530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050540: 2077 6461 7461 5b69 642b 2b5d 203d 2047   wdata[id++] = G
+00050550: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
+00050560: 282a 2867 676d 6c5f 6670 3136 5f74 202a  (*(ggml_fp16_t *
+00050570: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+00050580: 2d3e 6461 7461 202b 2069 3033 2a6e 6230  ->data + i03*nb0
+00050590: 3320 2b20 6930 322a 6e62 3032 202b 2069  3 + i02*nb02 + i
+000505a0: 3031 2a6e 6230 3120 2b20 6930 302a 6e62  01*nb01 + i00*nb
+000505b0: 3030 2929 3b0a 2020 2020 2020 2020 2020  00));.          
+000505c0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000505d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000505e0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+000505f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00050600: 7428 6964 2a73 697a 656f 6628 666c 6f61  t(id*sizeof(floa
+00050610: 7429 203c 3d20 7061 7261 6d73 2d3e 7773  t) <= params->ws
+00050620: 697a 6529 3b0a 2020 2020 2020 2020 2020  ize);.          
+00050630: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00050640: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00050650: 6c6f 6174 202a 2078 203d 2077 6461 7461  loat * x = wdata
+00050660: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00050670: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
+00050680: 7920 3d20 2866 6c6f 6174 202a 2920 2828  y = (float *) ((
+00050690: 6368 6172 202a 2920 7372 6331 2d3e 6461  char *) src1->da
+000506a0: 7461 202b 2069 3032 2a6e 6231 3220 2b20  ta + i02*nb12 + 
+000506b0: 6930 332a 6e62 3133 293b 0a0a 2020 2020  i03*nb13);..    
+000506c0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+000506d0: 7420 2a20 6420 3d20 2866 6c6f 6174 202a  t * d = (float *
+000506e0: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
+000506f0: 3e64 6174 6120 2b20 6930 322a 6e62 3220  >data + i02*nb2 
+00050700: 2b20 6930 332a 6e62 3329 3b0a 0a20 2020  + i03*nb3);..   
+00050710: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00050720: 7a54 203d 2079 202a 2078 540a 2020 2020  zT = y * xT.    
+00050730: 2020 2020 2020 2020 2020 2020 6362 6c61              cbla
+00050740: 735f 7367 656d 6d28 4362 6c61 7352 6f77  s_sgemm(CblasRow
+00050750: 4d61 6a6f 722c 2043 626c 6173 4e6f 5472  Major, CblasNoTr
+00050760: 616e 732c 2043 626c 6173 5472 616e 732c  ans, CblasTrans,
+00050770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00050780: 2020 2020 2020 2020 206e 6531 312c 206e           ne11, n
+00050790: 6530 312c 206e 6531 302c 0a20 2020 2020  e01, ne10,.     
+000507a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000507b0: 2020 2031 2e30 662c 2020 2020 792c 206e     1.0f,    y, n
+000507c0: 6531 302c 0a20 2020 2020 2020 2020 2020  e10,.           
+000507d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000507e0: 2020 2020 2020 782c 206e 6530 302c 0a20        x, ne00,. 
+000507f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050800: 2020 2020 2020 2030 2e30 662c 2020 2020         0.0f,    
+00050810: 642c 206e 6530 3129 3b0a 2020 2020 2020  d, ne01);.      
+00050820: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00050830: 7d0a 0a20 2020 2020 2020 202f 2a70 7269  }..        /*pri
+00050840: 6e74 6628 2243 424c 4153 2046 3136 203d  ntf("CBLAS F16 =
+00050850: 2025 6620 6d73 2c20 2564 2078 2025 6420   %f ms, %d x %d 
+00050860: 7820 2564 2078 2025 645c 6e22 2c20 2867  x %d x %d\n", (g
+00050870: 676d 6c5f 7065 7266 5f74 696d 655f 7573  gml_perf_time_us
+00050880: 2829 202d 2074 3029 2f31 3030 302e 302c  () - t0)/1000.0,
+00050890: 206e 6530 2c20 6e65 312c 206e 6532 2c20   ne0, ne1, ne2, 
+000508a0: 6e65 3329 3b2a 2f0a 0a20 2020 2020 2020  ne3);*/..       
+000508b0: 2072 6574 7572 6e3b 0a20 2020 207d 0a23   return;.    }.#
+000508c0: 656e 6469 660a 0a20 2020 2069 6620 2870  endif..    if (p
+000508d0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+000508e0: 474d 4c5f 5441 534b 5f49 4e49 5429 207b  GML_TASK_INIT) {
+000508f0: 0a20 2020 2020 2020 2067 676d 6c5f 6670  .        ggml_fp
+00050900: 3136 5f74 202a 2063 6f6e 7374 2077 6461  16_t * const wda
+00050910: 7461 203d 2070 6172 616d 732d 3e77 6461  ta = params->wda
+00050920: 7461 3b0a 0a20 2020 2020 2020 2073 697a  ta;..        siz
+00050930: 655f 7420 6964 203d 2030 3b0a 2020 2020  e_t id = 0;.    
+00050940: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00050950: 2069 3133 203d 2030 3b20 6931 3320 3c20   i13 = 0; i13 < 
+00050960: 6e65 3133 3b20 2b2b 6931 3329 207b 0a20  ne13; ++i13) {. 
+00050970: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00050980: 696e 7436 345f 7420 6931 3220 3d20 303b  int64_t i12 = 0;
+00050990: 2069 3132 203c 206e 6531 323b 202b 2b69   i12 < ne12; ++i
+000509a0: 3132 2920 7b0a 2020 2020 2020 2020 2020  12) {.          
+000509b0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+000509c0: 5f74 2069 3131 203d 2030 3b20 6931 3120  _t i11 = 0; i11 
+000509d0: 3c20 6e65 3131 3b20 2b2b 6931 3129 207b  < ne11; ++i11) {
+000509e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000509f0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00050a00: 7420 6931 3120 3d20 303b 2069 3131 203c  t i11 = 0; i11 <
-00050a10: 206e 6531 313b 202b 2b69 3131 2920 7b0a   ne11; ++i11) {.
+00050a00: 7420 6931 3020 3d20 303b 2069 3130 203c  t i10 = 0; i10 <
+00050a10: 206e 6531 303b 202b 2b69 3130 2920 7b0a   ne10; ++i10) {.
 00050a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050a30: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-00050a40: 2069 3130 203d 2030 3b20 6931 3020 3c20   i10 = 0; i10 < 
-00050a50: 6e65 3130 3b20 2b2b 6931 3029 207b 0a20  ne10; ++i10) {. 
-00050a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050a70: 2020 2020 2020 2077 6461 7461 5b69 642b         wdata[id+
-00050a80: 2b5d 203d 2047 474d 4c5f 4650 3332 5f54  +] = GGML_FP32_T
-00050a90: 4f5f 4650 3136 282a 2866 6c6f 6174 202a  O_FP16(*(float *
-00050aa0: 2928 2863 6861 7220 2a29 2073 7263 312d  )((char *) src1-
-00050ab0: 3e64 6174 6120 2b20 6931 332a 6e62 3133  >data + i13*nb13
-00050ac0: 202b 2069 3132 2a6e 6231 3220 2b20 6931   + i12*nb12 + i1
-00050ad0: 312a 6e62 3131 202b 2069 3130 2a6e 6231  1*nb11 + i10*nb1
-00050ae0: 3029 293b 0a20 2020 2020 2020 2020 2020  0));.           
-00050af0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00050b00: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00050b10: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00050b20: 2020 207d 0a0a 2020 2020 2020 2020 4747     }..        GG
-00050b30: 4d4c 5f41 5353 4552 5428 6964 2a73 697a  ML_ASSERT(id*siz
-00050b40: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
-00050b50: 203c 3d20 7061 7261 6d73 2d3e 7773 697a   <= params->wsiz
-00050b60: 6529 3b0a 0a20 2020 2020 2020 2072 6574  e);..        ret
-00050b70: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00050b80: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-00050b90: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-00050ba0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-00050bb0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-00050bc0: 0a20 2020 202f 2f20 6670 3136 202d 3e20  .    // fp16 -> 
-00050bd0: 6861 6c66 2074 6865 2073 697a 652c 2073  half the size, s
-00050be0: 6f20 6469 7669 6465 2062 7920 320a 2020  o divide by 2.  
-00050bf0: 2020 2f2f 2054 4f44 4f3a 2064 6f20 6e6f    // TODO: do no
-00050c00: 7420 7375 7070 6f72 7420 7472 616e 7370  t support transp
-00050c10: 6f73 6564 2073 7263 310a 2020 2020 6173  osed src1.    as
-00050c20: 7365 7274 286e 6231 302f 3220 3d3d 2073  sert(nb10/2 == s
-00050c30: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
-00050c40: 7429 293b 0a0a 2020 2020 2f2f 2070 6172  t));..    // par
-00050c50: 616c 6c65 6c69 7a65 2062 7920 7372 6330  allelize by src0
-00050c60: 2072 6f77 7320 7573 696e 6720 6767 6d6c   rows using ggml
-00050c70: 5f76 6563 5f64 6f74 5f66 3136 0a0a 2020  _vec_dot_f16..  
-00050c80: 2020 2f2f 2074 6f74 616c 2072 6f77 7320    // total rows 
-00050c90: 696e 2073 7263 300a 2020 2020 636f 6e73  in src0.    cons
-00050ca0: 7420 696e 7420 6e72 203d 206e 6530 312a  t int nr = ne01*
-00050cb0: 6e65 3032 2a6e 6530 333b 0a0a 2020 2020  ne02*ne03;..    
-00050cc0: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
-00050cd0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-00050ce0: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
-00050cf0: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
-00050d00: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
-00050d10: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
-00050d20: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
-00050d30: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
-00050d40: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
-00050d50: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
-00050d60: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-00050d70: 2a20 7764 6174 6120 3d20 7061 7261 6d73  * wdata = params
-00050d80: 2d3e 7764 6174 613b 0a0a 2020 2020 666f  ->wdata;..    fo
-00050d90: 7220 2869 6e74 2069 7220 3d20 6972 303b  r (int ir = ir0;
-00050da0: 2069 7220 3c20 6972 313b 202b 2b69 7229   ir < ir1; ++ir)
-00050db0: 207b 0a20 2020 2020 2020 202f 2f20 7372   {.        // sr
-00050dc0: 6330 2069 6e64 6963 6573 0a20 2020 2020  c0 indices.     
-00050dd0: 2020 2063 6f6e 7374 2069 6e74 2069 3033     const int i03
-00050de0: 203d 2069 722f 286e 6530 322a 6e65 3031   = ir/(ne02*ne01
-00050df0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
-00050e00: 2069 6e74 2069 3032 203d 2028 6972 202d   int i02 = (ir -
-00050e10: 2069 3033 2a6e 6530 322a 6e65 3031 292f   i03*ne02*ne01)/
-00050e20: 6e65 3031 3b0a 2020 2020 2020 2020 636f  ne01;.        co
-00050e30: 6e73 7420 696e 7420 6930 3120 3d20 2869  nst int i01 = (i
-00050e40: 7220 2d20 6930 332a 6e65 3032 2a6e 6530  r - i03*ne02*ne0
-00050e50: 3120 2d20 6930 322a 6e65 3031 293b 0a0a  1 - i02*ne01);..
-00050e60: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-00050e70: 7420 6931 3320 3d20 6930 333b 0a20 2020  t i13 = i03;.   
-00050e80: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00050e90: 3132 203d 2069 3032 3b0a 0a20 2020 2020  12 = i02;..     
-00050ea0: 2020 2063 6f6e 7374 2069 6e74 2069 3020     const int i0 
-00050eb0: 3d20 6930 313b 0a20 2020 2020 2020 2063  = i01;.        c
-00050ec0: 6f6e 7374 2069 6e74 2069 3220 3d20 6930  onst int i2 = i0
-00050ed0: 323b 0a20 2020 2020 2020 2063 6f6e 7374  2;.        const
-00050ee0: 2069 6e74 2069 3320 3d20 6930 333b 0a0a   int i3 = i03;..
-00050ef0: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
-00050f00: 365f 7420 2a20 7372 6330 5f72 6f77 203d  6_t * src0_row =
-00050f10: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-00050f20: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-00050f30: 3e64 6174 6120 2b20 2869 3031 2a6e 6230  >data + (i01*nb0
-00050f40: 3120 2b20 6930 322a 6e62 3032 202b 2069  1 + i02*nb02 + i
-00050f50: 3033 2a6e 6230 3329 293b 0a20 2020 2020  03*nb03));.     
-00050f60: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
-00050f70: 2073 7263 315f 636f 6c20 3d20 2020 2020   src1_col =     
-00050f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050f90: 2020 2020 2020 2020 2020 2077 6461 7461             wdata
-00050fa0: 202b 2028 2020 2020 2020 2030 202b 2069   + (       0 + i
-00050fb0: 3132 2a6e 6531 3120 2b20 6931 332a 6e65  12*ne11 + i13*ne
-00050fc0: 3132 2a6e 6531 3129 2a6e 6530 303b 0a0a  12*ne11)*ne00;..
-00050fd0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-00050fe0: 6473 745f 636f 6c20 3d20 2866 6c6f 6174  dst_col = (float
-00050ff0: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-00051000: 742d 3e64 6174 6120 2b20 2869 302a 6e62  t->data + (i0*nb
-00051010: 3020 2b20 302a 6e62 3120 2b20 6932 2a6e  0 + 0*nb1 + i2*n
-00051020: 6232 202b 2069 332a 6e62 3329 293b 0a0a  b2 + i3*nb3));..
-00051030: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00051040: 3634 5f74 2069 6320 3d20 303b 2069 6320  64_t ic = 0; ic 
-00051050: 3c20 6e65 3131 3b20 2b2b 6963 2920 7b0a  < ne11; ++ic) {.
-00051060: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00051070: 5f76 6563 5f64 6f74 5f66 3136 286e 6530  _vec_dot_f16(ne0
-00051080: 302c 2026 6473 745f 636f 6c5b 6963 2a6e  0, &dst_col[ic*n
-00051090: 6530 5d2c 2073 7263 305f 726f 772c 2073  e0], src0_row, s
-000510a0: 7263 315f 636f 6c20 2b20 6963 2a6e 6530  rc1_col + ic*ne0
-000510b0: 3029 3b0a 2020 2020 2020 2020 7d0a 2020  0);.        }.  
-000510c0: 2020 7d0a 0a20 2020 202f 2f69 6e74 3634    }..    //int64
-000510d0: 5f74 2074 3120 3d20 6767 6d6c 5f74 696d  _t t1 = ggml_tim
-000510e0: 655f 7573 2829 3b0a 2020 2020 2f2f 7374  e_us();.    //st
-000510f0: 6174 6963 2069 6e74 3634 5f74 2061 6363  atic int64_t acc
-00051100: 203d 2030 3b0a 2020 2020 2f2f 6163 6320   = 0;.    //acc 
-00051110: 2b3d 2074 3120 2d20 7430 3b0a 2020 2020  += t1 - t0;.    
-00051120: 2f2f 6966 2028 7431 202d 2074 3020 3e20  //if (t1 - t0 > 
-00051130: 3130 2920 7b0a 2020 2020 2f2f 2020 2020  10) {.    //    
-00051140: 7072 696e 7466 2822 5c6e 2229 3b0a 2020  printf("\n");.  
-00051150: 2020 2f2f 2020 2020 7072 696e 7466 2822    //    printf("
-00051160: 6e65 3030 203d 2025 3564 2c20 6e65 3031  ne00 = %5d, ne01
-00051170: 203d 2025 3564 2c20 6e65 3032 203d 2025   = %5d, ne02 = %
-00051180: 3564 2c20 6e65 3033 203d 2025 3564 5c6e  5d, ne03 = %5d\n
-00051190: 222c 206e 6530 302c 206e 6530 312c 206e  ", ne00, ne01, n
-000511a0: 6530 322c 206e 6530 3329 3b0a 2020 2020  e02, ne03);.    
-000511b0: 2f2f 2020 2020 7072 696e 7466 2822 6e62  //    printf("nb
-000511c0: 3030 203d 2025 3564 2c20 6e62 3031 203d  00 = %5d, nb01 =
-000511d0: 2025 3564 2c20 6e62 3032 203d 2025 3564   %5d, nb02 = %5d
-000511e0: 2c20 6e62 3033 203d 2025 3564 5c6e 222c  , nb03 = %5d\n",
-000511f0: 206e 6230 302c 206e 6230 312c 206e 6230   nb00, nb01, nb0
-00051200: 322c 206e 6230 3329 3b0a 2020 2020 2f2f  2, nb03);.    //
-00051210: 2020 2020 7072 696e 7466 2822 6e65 3130      printf("ne10
-00051220: 203d 2025 3564 2c20 6e65 3131 203d 2025   = %5d, ne11 = %
-00051230: 3564 2c20 6e65 3132 203d 2025 3564 2c20  5d, ne12 = %5d, 
-00051240: 6e65 3133 203d 2025 3564 5c6e 222c 206e  ne13 = %5d\n", n
-00051250: 6531 302c 206e 6531 312c 206e 6531 322c  e10, ne11, ne12,
-00051260: 206e 6531 3329 3b0a 0a20 2020 202f 2f20   ne13);..    // 
-00051270: 2020 2070 7269 6e74 6628 2258 5858 5858     printf("XXXXX
-00051280: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00051290: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-000512a0: 5858 5858 5858 5858 5858 5858 5858 5820  XXXXXXXXXXXXXXX 
-000512b0: 7461 736b 2025 642f 2564 3a20 2564 2075  task %d/%d: %d u
-000512c0: 732c 2061 6363 203d 2025 645c 6e22 2c20  s, acc = %d\n", 
-000512d0: 6974 682c 206e 7468 2c20 2869 6e74 2920  ith, nth, (int) 
-000512e0: 2874 3120 2d20 7430 292c 2028 696e 7429  (t1 - t0), (int)
-000512f0: 2061 6363 293b 0a20 2020 202f 2f7d 0a7d   acc);.    //}.}
-00051300: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00051310: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00051320: 7264 5f6d 756c 5f6d 6174 5f71 5f66 3332  rd_mul_mat_q_f32
-00051330: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-00051340: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00051350: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00051360: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-00051370: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00051380: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-00051390: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000513a0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000513b0: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
-000513c0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000513d0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-000513e0: 0a20 2020 2069 6e74 3634 5f74 2074 3020  .    int64_t t0 
-000513f0: 3d20 6767 6d6c 5f70 6572 665f 7469 6d65  = ggml_perf_time
-00051400: 5f75 7328 293b 0a20 2020 2055 4e55 5345  _us();.    UNUSE
-00051410: 4428 7430 293b 0a0a 2020 2020 636f 6e73  D(t0);..    cons
-00051420: 7420 696e 7436 345f 7420 6e65 3030 203d  t int64_t ne00 =
-00051430: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
-00051440: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00051450: 6e65 3031 203d 2073 7263 302d 3e6e 655b  ne01 = src0->ne[
-00051460: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-00051470: 7436 345f 7420 6e65 3032 203d 2073 7263  t64_t ne02 = src
-00051480: 302d 3e6e 655b 325d 3b0a 2020 2020 636f  0->ne[2];.    co
-00051490: 6e73 7420 696e 7436 345f 7420 6e65 3033  nst int64_t ne03
-000514a0: 203d 2073 7263 302d 3e6e 655b 335d 3b0a   = src0->ne[3];.
-000514b0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-000514c0: 5f74 206e 6531 3020 3d20 7372 6331 2d3e  _t ne10 = src1->
-000514d0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-000514e0: 2069 6e74 3634 5f74 206e 6531 3120 3d20   int64_t ne11 = 
-000514f0: 7372 6331 2d3e 6e65 5b31 5d3b 0a20 2020  src1->ne[1];.   
-00051500: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00051510: 6531 3220 3d20 7372 6331 2d3e 6e65 5b32  e12 = src1->ne[2
-00051520: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00051530: 3634 5f74 206e 6531 3320 3d20 7372 6331  64_t ne13 = src1
-00051540: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
-00051550: 6e73 7420 696e 7436 345f 7420 6e65 3020  nst int64_t ne0 
-00051560: 203d 2064 7374 2d3e 6e65 5b30 5d3b 0a20   = dst->ne[0];. 
-00051570: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00051580: 206e 6531 2020 3d20 6473 742d 3e6e 655b   ne1  = dst->ne[
-00051590: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-000515a0: 7436 345f 7420 6e65 3220 203d 2064 7374  t64_t ne2  = dst
-000515b0: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
-000515c0: 7374 2069 6e74 3634 5f74 206e 6533 2020  st int64_t ne3  
-000515d0: 3d20 6473 742d 3e6e 655b 335d 3b0a 0a20  = dst->ne[3];.. 
-000515e0: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-000515f0: 3020 3d20 7372 6330 2d3e 6e62 5b30 5d3b  0 = src0->nb[0];
-00051600: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00051610: 6230 3120 3d20 7372 6330 2d3e 6e62 5b31  b01 = src0->nb[1
-00051620: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00051630: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
-00051640: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
-00051650: 6e74 206e 6230 3320 3d20 7372 6330 2d3e  nt nb03 = src0->
-00051660: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-00051670: 7420 696e 7420 6e62 3130 203d 2073 7263  t int nb10 = src
-00051680: 312d 3e6e 625b 305d 3b0a 2020 2020 636f  1->nb[0];.    co
-00051690: 6e73 7420 696e 7420 6e62 3131 203d 2073  nst int nb11 = s
-000516a0: 7263 312d 3e6e 625b 315d 3b0a 2020 2020  rc1->nb[1];.    
-000516b0: 636f 6e73 7420 696e 7420 6e62 3132 203d  const int nb12 =
-000516c0: 2073 7263 312d 3e6e 625b 325d 3b0a 2020   src1->nb[2];.  
-000516d0: 2020 636f 6e73 7420 696e 7420 6e62 3133    const int nb13
-000516e0: 203d 2073 7263 312d 3e6e 625b 335d 3b0a   = src1->nb[3];.
-000516f0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00051700: 6230 2020 3d20 6473 742d 3e6e 625b 305d  b0  = dst->nb[0]
-00051710: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00051720: 6e62 3120 203d 2064 7374 2d3e 6e62 5b31  nb1  = dst->nb[1
-00051730: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00051740: 206e 6232 2020 3d20 6473 742d 3e6e 625b   nb2  = dst->nb[
-00051750: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
-00051760: 7420 6e62 3320 203d 2064 7374 2d3e 6e62  t nb3  = dst->nb
-00051770: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-00051780: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
-00051790: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-000517a0: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
-000517b0: 732d 3e6e 7468 3b0a 0a20 2020 2047 474d  s->nth;..    GGM
-000517c0: 4c5f 4153 5345 5254 286e 6530 3220 3d3d  L_ASSERT(ne02 ==
-000517d0: 206e 6531 3229 3b0a 2020 2020 4747 4d4c   ne12);.    GGML
-000517e0: 5f41 5353 4552 5428 6e65 3033 203d 3d20  _ASSERT(ne03 == 
-000517f0: 6e65 3133 293b 0a20 2020 2047 474d 4c5f  ne13);.    GGML_
-00051800: 4153 5345 5254 286e 6532 2020 3d3d 206e  ASSERT(ne2  == n
-00051810: 6531 3229 3b0a 2020 2020 4747 4d4c 5f41  e12);.    GGML_A
-00051820: 5353 4552 5428 6e65 3320 203d 3d20 6e65  SSERT(ne3  == ne
-00051830: 3133 293b 0a0a 2020 2020 636f 6e73 7420  13);..    const 
-00051840: 656e 756d 2067 676d 6c5f 7479 7065 2074  enum ggml_type t
-00051850: 7970 6520 3d20 7372 6330 2d3e 7479 7065  ype = src0->type
-00051860: 3b0a 2020 2020 7175 616e 7469 7a65 5f72  ;.    quantize_r
-00051870: 6f77 5f71 5f74 2063 6f6e 7374 2071 7561  ow_q_t const qua
-00051880: 6e74 697a 655f 726f 775f 715f 646f 7420  ntize_row_q_dot 
-00051890: 3d20 7175 616e 7469 7a65 5f66 6e73 5b74  = quantize_fns[t
-000518a0: 7970 655d 2e71 7561 6e74 697a 655f 726f  ype].quantize_ro
-000518b0: 775f 715f 646f 743b 0a20 2020 2076 6563  w_q_dot;.    vec
-000518c0: 5f64 6f74 5f71 5f74 2020 2020 2020 636f  _dot_q_t      co
-000518d0: 6e73 7420 7665 635f 646f 745f 7120 2020  nst vec_dot_q   
-000518e0: 2020 2020 2020 203d 2071 7561 6e74 697a         = quantiz
-000518f0: 655f 666e 735b 7479 7065 5d2e 7665 635f  e_fns[type].vec_
-00051900: 646f 745f 713b 0a20 2020 2065 6e75 6d20  dot_q;.    enum 
-00051910: 6767 6d6c 5f74 7970 6520 2020 636f 6e73  ggml_type   cons
-00051920: 7420 7665 635f 646f 745f 7479 7065 2020  t vec_dot_type  
-00051930: 2020 2020 203d 2071 7561 6e74 697a 655f       = quantize_
-00051940: 666e 735b 7479 7065 5d2e 7665 635f 646f  fns[type].vec_do
-00051950: 745f 7479 7065 3b0a 0a20 2020 202f 2f20  t_type;..    // 
-00051960: 7765 2064 6f6e 2774 2073 7570 706f 7274  we don't support
-00051970: 2070 6572 6d75 7465 6420 7372 6330 206f   permuted src0 o
-00051980: 7220 7372 6331 0a20 2020 2047 474d 4c5f  r src1.    GGML_
-00051990: 4153 5345 5254 286e 6230 3020 3d3d 2028  ASSERT(nb00 == (
-000519a0: 696e 7429 2047 474d 4c5f 5459 5045 5f53  int) GGML_TYPE_S
-000519b0: 495a 455b 7479 7065 5d29 3b0a 2020 2020  IZE[type]);.    
-000519c0: 4747 4d4c 5f41 5353 4552 5428 6e62 3130  GGML_ASSERT(nb10
-000519d0: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-000519e0: 2929 3b0a 0a20 2020 202f 2f20 6473 7420  ));..    // dst 
-000519f0: 6361 6e6e 6f74 2062 6520 7472 616e 7370  cannot be transp
-00051a00: 6f73 6564 206f 7220 7065 726d 7574 6564  osed or permuted
-00051a10: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00051a20: 286e 6230 203d 3d20 7369 7a65 6f66 2866  (nb0 == sizeof(f
-00051a30: 6c6f 6174 2929 3b0a 2020 2020 4747 4d4c  loat));.    GGML
-00051a40: 5f41 5353 4552 5428 6e62 3020 3c3d 206e  _ASSERT(nb0 <= n
-00051a50: 6231 293b 0a20 2020 2047 474d 4c5f 4153  b1);.    GGML_AS
-00051a60: 5345 5254 286e 6231 203c 3d20 6e62 3229  SERT(nb1 <= nb2)
-00051a70: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00051a80: 5428 6e62 3220 3c3d 206e 6233 293b 0a0a  T(nb2 <= nb3);..
-00051a90: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00051aa0: 6e65 3020 3d3d 206e 6530 3129 3b0a 2020  ne0 == ne01);.  
-00051ab0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-00051ac0: 3120 3d3d 206e 6531 3129 3b0a 2020 2020  1 == ne11);.    
-00051ad0: 4747 4d4c 5f41 5353 4552 5428 6e65 3220  GGML_ASSERT(ne2 
-00051ae0: 3d3d 206e 6530 3229 3b0a 2020 2020 4747  == ne02);.    GG
-00051af0: 4d4c 5f41 5353 4552 5428 6e65 3320 3d3d  ML_ASSERT(ne3 ==
-00051b00: 206e 6530 3329 3b0a 0a20 2020 202f 2f20   ne03);..    // 
-00051b10: 6e62 3031 203e 3d20 6e62 3030 202d 2073  nb01 >= nb00 - s
-00051b20: 7263 3020 6973 206e 6f74 2074 7261 6e73  rc0 is not trans
-00051b30: 706f 7365 640a 2020 2020 2f2f 2020 2063  posed.    //   c
-00051b40: 6f6d 7075 7465 2062 7920 7372 6330 2072  ompute by src0 r
-00051b50: 6f77 730a 0a23 6966 2064 6566 696e 6564  ows..#if defined
-00051b60: 2847 474d 4c5f 5553 455f 434c 424c 4153  (GGML_USE_CLBLAS
-00051b70: 5429 0a20 2020 2069 6620 2867 676d 6c5f  T).    if (ggml_
-00051b80: 636c 5f63 616e 5f6d 756c 5f6d 6174 2873  cl_can_mul_mat(s
-00051b90: 7263 302c 2073 7263 312c 2064 7374 2929  rc0, src1, dst))
-00051ba0: 207b 0a20 2020 2020 2020 2069 6620 2870   {.        if (p
-00051bb0: 6172 616d 732d 3e69 7468 203d 3d20 3020  arams->ith == 0 
-00051bc0: 2626 2070 6172 616d 732d 3e74 7970 6520  && params->type 
-00051bd0: 3d3d 2047 474d 4c5f 5441 534b 5f43 4f4d  == GGML_TASK_COM
-00051be0: 5055 5445 2920 7b0a 2020 2020 2020 2020  PUTE) {.        
-00051bf0: 2020 2020 6767 6d6c 5f63 6c5f 6d75 6c5f      ggml_cl_mul_
-00051c00: 6d61 7428 7372 6330 2c20 7372 6331 2c20  mat(src0, src1, 
-00051c10: 6473 742c 2070 6172 616d 732d 3e77 6461  dst, params->wda
-00051c20: 7461 2c20 7061 7261 6d73 2d3e 7773 697a  ta, params->wsiz
-00051c30: 6529 3b0a 2020 2020 2020 2020 7d0a 2020  e);.        }.  
-00051c40: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00051c50: 2020 7d0a 2365 6e64 6966 0a0a 2369 6620    }.#endif..#if 
-00051c60: 6465 6669 6e65 6428 4747 4d4c 5f55 5345  defined(GGML_USE
-00051c70: 5f41 4343 454c 4552 4154 4529 207c 7c20  _ACCELERATE) || 
-00051c80: 6465 6669 6e65 6428 4747 4d4c 5f55 5345  defined(GGML_USE
-00051c90: 5f4f 5045 4e42 4c41 5329 0a20 2020 2069  _OPENBLAS).    i
-00051ca0: 6620 2867 676d 6c5f 636f 6d70 7574 655f  f (ggml_compute_
-00051cb0: 666f 7277 6172 645f 6d75 6c5f 6d61 745f  forward_mul_mat_
-00051cc0: 7573 655f 626c 6173 2873 7263 302c 2073  use_blas(src0, s
-00051cd0: 7263 312c 2064 7374 2929 207b 0a20 2020  rc1, dst)) {.   
+00050a30: 2020 2020 2020 2020 7764 6174 615b 6964          wdata[id
+00050a40: 2b2b 5d20 3d20 4747 4d4c 5f46 5033 325f  ++] = GGML_FP32_
+00050a50: 544f 5f46 5031 3628 2a28 666c 6f61 7420  TO_FP16(*(float 
+00050a60: 2a29 2828 6368 6172 202a 2920 7372 6331  *)((char *) src1
+00050a70: 2d3e 6461 7461 202b 2069 3133 2a6e 6231  ->data + i13*nb1
+00050a80: 3320 2b20 6931 322a 6e62 3132 202b 2069  3 + i12*nb12 + i
+00050a90: 3131 2a6e 6231 3120 2b20 6931 302a 6e62  11*nb11 + i10*nb
+00050aa0: 3130 2929 3b0a 2020 2020 2020 2020 2020  10));.          
+00050ab0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00050ac0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00050ad0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00050ae0: 2020 2020 7d0a 0a20 2020 2020 2020 2047      }..        G
+00050af0: 474d 4c5f 4153 5345 5254 2869 642a 7369  GML_ASSERT(id*si
+00050b00: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
+00050b10: 2920 3c3d 2070 6172 616d 732d 3e77 7369  ) <= params->wsi
+00050b20: 7a65 293b 0a0a 2020 2020 2020 2020 7265  ze);..        re
+00050b30: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+00050b40: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+00050b50: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+00050b60: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+00050b70: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+00050b80: 0a0a 2020 2020 2f2f 2066 7031 3620 2d3e  ..    // fp16 ->
+00050b90: 2068 616c 6620 7468 6520 7369 7a65 2c20   half the size, 
+00050ba0: 736f 2064 6976 6964 6520 6279 2032 0a20  so divide by 2. 
+00050bb0: 2020 202f 2f20 544f 444f 3a20 646f 206e     // TODO: do n
+00050bc0: 6f74 2073 7570 706f 7274 2074 7261 6e73  ot support trans
+00050bd0: 706f 7365 6420 7372 6331 0a20 2020 2061  posed src1.    a
+00050be0: 7373 6572 7428 6e62 3130 2f32 203d 3d20  ssert(nb10/2 == 
+00050bf0: 7369 7a65 6f66 2867 676d 6c5f 6670 3136  sizeof(ggml_fp16
+00050c00: 5f74 2929 3b0a 0a20 2020 202f 2f20 7061  _t));..    // pa
+00050c10: 7261 6c6c 656c 697a 6520 6279 2073 7263  rallelize by src
+00050c20: 3020 726f 7773 2075 7369 6e67 2067 676d  0 rows using ggm
+00050c30: 6c5f 7665 635f 646f 745f 6631 360a 0a20  l_vec_dot_f16.. 
+00050c40: 2020 202f 2f20 746f 7461 6c20 726f 7773     // total rows
+00050c50: 2069 6e20 7372 6330 0a20 2020 2063 6f6e   in src0.    con
+00050c60: 7374 2069 6e74 206e 7220 3d20 6e65 3031  st int nr = ne01
+00050c70: 2a6e 6530 322a 6e65 3033 3b0a 0a20 2020  *ne02*ne03;..   
+00050c80: 202f 2f20 726f 7773 2070 6572 2074 6872   // rows per thr
+00050c90: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
+00050ca0: 7420 6472 203d 2028 6e72 202b 206e 7468  t dr = (nr + nth
+00050cb0: 202d 2031 292f 6e74 683b 0a0a 2020 2020   - 1)/nth;..    
+00050cc0: 2f2f 2072 6f77 2072 616e 6765 2066 6f72  // row range for
+00050cd0: 2074 6869 7320 7468 7265 6164 0a20 2020   this thread.   
+00050ce0: 2063 6f6e 7374 2069 6e74 2069 7230 203d   const int ir0 =
+00050cf0: 2064 722a 6974 683b 0a20 2020 2063 6f6e   dr*ith;.    con
+00050d00: 7374 2069 6e74 2069 7231 203d 204d 494e  st int ir1 = MIN
+00050d10: 2869 7230 202b 2064 722c 206e 7229 3b0a  (ir0 + dr, nr);.
+00050d20: 0a20 2020 2067 676d 6c5f 6670 3136 5f74  .    ggml_fp16_t
+00050d30: 202a 2077 6461 7461 203d 2070 6172 616d   * wdata = param
+00050d40: 732d 3e77 6461 7461 3b0a 0a20 2020 2066  s->wdata;..    f
+00050d50: 6f72 2028 696e 7420 6972 203d 2069 7230  or (int ir = ir0
+00050d60: 3b20 6972 203c 2069 7231 3b20 2b2b 6972  ; ir < ir1; ++ir
+00050d70: 2920 7b0a 2020 2020 2020 2020 2f2f 2073  ) {.        // s
+00050d80: 7263 3020 696e 6469 6365 730a 2020 2020  rc0 indices.    
+00050d90: 2020 2020 636f 6e73 7420 696e 7420 6930      const int i0
+00050da0: 3320 3d20 6972 2f28 6e65 3032 2a6e 6530  3 = ir/(ne02*ne0
+00050db0: 3129 3b0a 2020 2020 2020 2020 636f 6e73  1);.        cons
+00050dc0: 7420 696e 7420 6930 3220 3d20 2869 7220  t int i02 = (ir 
+00050dd0: 2d20 6930 332a 6e65 3032 2a6e 6530 3129  - i03*ne02*ne01)
+00050de0: 2f6e 6530 313b 0a20 2020 2020 2020 2063  /ne01;.        c
+00050df0: 6f6e 7374 2069 6e74 2069 3031 203d 2028  onst int i01 = (
+00050e00: 6972 202d 2069 3033 2a6e 6530 322a 6e65  ir - i03*ne02*ne
+00050e10: 3031 202d 2069 3032 2a6e 6530 3129 3b0a  01 - i02*ne01);.
+00050e20: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+00050e30: 6e74 2069 3133 203d 2069 3033 3b0a 2020  nt i13 = i03;.  
+00050e40: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00050e50: 6931 3220 3d20 6930 323b 0a0a 2020 2020  i12 = i02;..    
+00050e60: 2020 2020 636f 6e73 7420 696e 7420 6930      const int i0
+00050e70: 203d 2069 3031 3b0a 2020 2020 2020 2020   = i01;.        
+00050e80: 636f 6e73 7420 696e 7420 6932 203d 2069  const int i2 = i
+00050e90: 3032 3b0a 2020 2020 2020 2020 636f 6e73  02;.        cons
+00050ea0: 7420 696e 7420 6933 203d 2069 3033 3b0a  t int i3 = i03;.
+00050eb0: 0a20 2020 2020 2020 2067 676d 6c5f 6670  .        ggml_fp
+00050ec0: 3136 5f74 202a 2073 7263 305f 726f 7720  16_t * src0_row 
+00050ed0: 3d20 2867 676d 6c5f 6670 3136 5f74 202a  = (ggml_fp16_t *
+00050ee0: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+00050ef0: 2d3e 6461 7461 202b 2028 6930 312a 6e62  ->data + (i01*nb
+00050f00: 3031 202b 2069 3032 2a6e 6230 3220 2b20  01 + i02*nb02 + 
+00050f10: 6930 332a 6e62 3033 2929 3b0a 2020 2020  i03*nb03));.    
+00050f20: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
+00050f30: 2a20 7372 6331 5f63 6f6c 203d 2020 2020  * src1_col =    
+00050f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050f50: 2020 2020 2020 2020 2020 2020 7764 6174              wdat
+00050f60: 6120 2b20 2820 2020 2020 2020 3020 2b20  a + (       0 + 
+00050f70: 6931 322a 6e65 3131 202b 2069 3133 2a6e  i12*ne11 + i13*n
+00050f80: 6531 322a 6e65 3131 292a 6e65 3030 3b0a  e12*ne11)*ne00;.
+00050f90: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
+00050fa0: 2064 7374 5f63 6f6c 203d 2028 666c 6f61   dst_col = (floa
+00050fb0: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
+00050fc0: 7374 2d3e 6461 7461 202b 2028 6930 2a6e  st->data + (i0*n
+00050fd0: 6230 202b 2030 2a6e 6231 202b 2069 322a  b0 + 0*nb1 + i2*
+00050fe0: 6e62 3220 2b20 6933 2a6e 6233 2929 3b0a  nb2 + i3*nb3));.
+00050ff0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00051000: 7436 345f 7420 6963 203d 2030 3b20 6963  t64_t ic = 0; ic
+00051010: 203c 206e 6531 313b 202b 2b69 6329 207b   < ne11; ++ic) {
+00051020: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+00051030: 6c5f 7665 635f 646f 745f 6631 3628 6e65  l_vec_dot_f16(ne
+00051040: 3030 2c20 2664 7374 5f63 6f6c 5b69 632a  00, &dst_col[ic*
+00051050: 6e65 305d 2c20 7372 6330 5f72 6f77 2c20  ne0], src0_row, 
+00051060: 7372 6331 5f63 6f6c 202b 2069 632a 6e65  src1_col + ic*ne
+00051070: 3030 293b 0a20 2020 2020 2020 207d 0a20  00);.        }. 
+00051080: 2020 207d 0a0a 2020 2020 2f2f 696e 7436     }..    //int6
+00051090: 345f 7420 7431 203d 2067 676d 6c5f 7469  4_t t1 = ggml_ti
+000510a0: 6d65 5f75 7328 293b 0a20 2020 202f 2f73  me_us();.    //s
+000510b0: 7461 7469 6320 696e 7436 345f 7420 6163  tatic int64_t ac
+000510c0: 6320 3d20 303b 0a20 2020 202f 2f61 6363  c = 0;.    //acc
+000510d0: 202b 3d20 7431 202d 2074 303b 0a20 2020   += t1 - t0;.   
+000510e0: 202f 2f69 6620 2874 3120 2d20 7430 203e   //if (t1 - t0 >
+000510f0: 2031 3029 207b 0a20 2020 202f 2f20 2020   10) {.    //   
+00051100: 2070 7269 6e74 6628 225c 6e22 293b 0a20   printf("\n");. 
+00051110: 2020 202f 2f20 2020 2070 7269 6e74 6628     //    printf(
+00051120: 226e 6530 3020 3d20 2535 642c 206e 6530  "ne00 = %5d, ne0
+00051130: 3120 3d20 2535 642c 206e 6530 3220 3d20  1 = %5d, ne02 = 
+00051140: 2535 642c 206e 6530 3320 3d20 2535 645c  %5d, ne03 = %5d\
+00051150: 6e22 2c20 6e65 3030 2c20 6e65 3031 2c20  n", ne00, ne01, 
+00051160: 6e65 3032 2c20 6e65 3033 293b 0a20 2020  ne02, ne03);.   
+00051170: 202f 2f20 2020 2070 7269 6e74 6628 226e   //    printf("n
+00051180: 6230 3020 3d20 2535 642c 206e 6230 3120  b00 = %5d, nb01 
+00051190: 3d20 2535 642c 206e 6230 3220 3d20 2535  = %5d, nb02 = %5
+000511a0: 642c 206e 6230 3320 3d20 2535 645c 6e22  d, nb03 = %5d\n"
+000511b0: 2c20 6e62 3030 2c20 6e62 3031 2c20 6e62  , nb00, nb01, nb
+000511c0: 3032 2c20 6e62 3033 293b 0a20 2020 202f  02, nb03);.    /
+000511d0: 2f20 2020 2070 7269 6e74 6628 226e 6531  /    printf("ne1
+000511e0: 3020 3d20 2535 642c 206e 6531 3120 3d20  0 = %5d, ne11 = 
+000511f0: 2535 642c 206e 6531 3220 3d20 2535 642c  %5d, ne12 = %5d,
+00051200: 206e 6531 3320 3d20 2535 645c 6e22 2c20   ne13 = %5d\n", 
+00051210: 6e65 3130 2c20 6e65 3131 2c20 6e65 3132  ne10, ne11, ne12
+00051220: 2c20 6e65 3133 293b 0a0a 2020 2020 2f2f  , ne13);..    //
+00051230: 2020 2020 7072 696e 7466 2822 5858 5858      printf("XXXX
+00051240: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00051250: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00051260: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00051270: 2074 6173 6b20 2564 2f25 643a 2025 6420   task %d/%d: %d 
+00051280: 7573 2c20 6163 6320 3d20 2564 5c6e 222c  us, acc = %d\n",
+00051290: 2069 7468 2c20 6e74 682c 2028 696e 7429   ith, nth, (int)
+000512a0: 2028 7431 202d 2074 3029 2c20 2869 6e74   (t1 - t0), (int
+000512b0: 2920 6163 6329 3b0a 2020 2020 2f2f 7d0a  ) acc);.    //}.
+000512c0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+000512d0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000512e0: 6172 645f 6d75 6c5f 6d61 745f 715f 6633  ard_mul_mat_q_f3
+000512f0: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
+00051300: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00051310: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00051320: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00051330: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00051340: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00051350: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00051360: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00051370: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
+00051380: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00051390: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+000513a0: 7b0a 2020 2020 696e 7436 345f 7420 7430  {.    int64_t t0
+000513b0: 203d 2067 676d 6c5f 7065 7266 5f74 696d   = ggml_perf_tim
+000513c0: 655f 7573 2829 3b0a 2020 2020 554e 5553  e_us();.    UNUS
+000513d0: 4544 2874 3029 3b0a 0a20 2020 2063 6f6e  ED(t0);..    con
+000513e0: 7374 2069 6e74 3634 5f74 206e 6530 3020  st int64_t ne00 
+000513f0: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
+00051400: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00051410: 206e 6530 3120 3d20 7372 6330 2d3e 6e65   ne01 = src0->ne
+00051420: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+00051430: 6e74 3634 5f74 206e 6530 3220 3d20 7372  nt64_t ne02 = sr
+00051440: 6330 2d3e 6e65 5b32 5d3b 0a20 2020 2063  c0->ne[2];.    c
+00051450: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+00051460: 3320 3d20 7372 6330 2d3e 6e65 5b33 5d3b  3 = src0->ne[3];
+00051470: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
+00051480: 345f 7420 6e65 3130 203d 2073 7263 312d  4_t ne10 = src1-
+00051490: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+000514a0: 7420 696e 7436 345f 7420 6e65 3131 203d  t int64_t ne11 =
+000514b0: 2073 7263 312d 3e6e 655b 315d 3b0a 2020   src1->ne[1];.  
+000514c0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+000514d0: 6e65 3132 203d 2073 7263 312d 3e6e 655b  ne12 = src1->ne[
+000514e0: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+000514f0: 7436 345f 7420 6e65 3133 203d 2073 7263  t64_t ne13 = src
+00051500: 312d 3e6e 655b 335d 3b0a 0a20 2020 2063  1->ne[3];..    c
+00051510: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+00051520: 2020 3d20 6473 742d 3e6e 655b 305d 3b0a    = dst->ne[0];.
+00051530: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00051540: 7420 6e65 3120 203d 2064 7374 2d3e 6e65  t ne1  = dst->ne
+00051550: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+00051560: 6e74 3634 5f74 206e 6532 2020 3d20 6473  nt64_t ne2  = ds
+00051570: 742d 3e6e 655b 325d 3b0a 2020 2020 636f  t->ne[2];.    co
+00051580: 6e73 7420 696e 7436 345f 7420 6e65 3320  nst int64_t ne3 
+00051590: 203d 2064 7374 2d3e 6e65 5b33 5d3b 0a0a   = dst->ne[3];..
+000515a0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+000515b0: 3030 203d 2073 7263 302d 3e6e 625b 305d  00 = src0->nb[0]
+000515c0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000515d0: 6e62 3031 203d 2073 7263 302d 3e6e 625b  nb01 = src0->nb[
+000515e0: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
+000515f0: 7420 6e62 3032 203d 2073 7263 302d 3e6e  t nb02 = src0->n
+00051600: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+00051610: 696e 7420 6e62 3033 203d 2073 7263 302d  int nb03 = src0-
+00051620: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
+00051630: 7374 2069 6e74 206e 6231 3020 3d20 7372  st int nb10 = sr
+00051640: 6331 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c1->nb[0];.    c
+00051650: 6f6e 7374 2069 6e74 206e 6231 3120 3d20  onst int nb11 = 
+00051660: 7372 6331 2d3e 6e62 5b31 5d3b 0a20 2020  src1->nb[1];.   
+00051670: 2063 6f6e 7374 2069 6e74 206e 6231 3220   const int nb12 
+00051680: 3d20 7372 6331 2d3e 6e62 5b32 5d3b 0a20  = src1->nb[2];. 
+00051690: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
+000516a0: 3320 3d20 7372 6331 2d3e 6e62 5b33 5d3b  3 = src1->nb[3];
+000516b0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+000516c0: 6e62 3020 203d 2064 7374 2d3e 6e62 5b30  nb0  = dst->nb[0
+000516d0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+000516e0: 206e 6231 2020 3d20 6473 742d 3e6e 625b   nb1  = dst->nb[
+000516f0: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
+00051700: 7420 6e62 3220 203d 2064 7374 2d3e 6e62  t nb2  = dst->nb
+00051710: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
+00051720: 6e74 206e 6233 2020 3d20 6473 742d 3e6e  nt nb3  = dst->n
+00051730: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+00051740: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
+00051750: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
+00051760: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
+00051770: 6d73 2d3e 6e74 683b 0a0a 2020 2020 4747  ms->nth;..    GG
+00051780: 4d4c 5f41 5353 4552 5428 6e65 3032 203d  ML_ASSERT(ne02 =
+00051790: 3d20 6e65 3132 293b 0a20 2020 2047 474d  = ne12);.    GGM
+000517a0: 4c5f 4153 5345 5254 286e 6530 3320 3d3d  L_ASSERT(ne03 ==
+000517b0: 206e 6531 3329 3b0a 2020 2020 4747 4d4c   ne13);.    GGML
+000517c0: 5f41 5353 4552 5428 6e65 3220 203d 3d20  _ASSERT(ne2  == 
+000517d0: 6e65 3132 293b 0a20 2020 2047 474d 4c5f  ne12);.    GGML_
+000517e0: 4153 5345 5254 286e 6533 2020 3d3d 206e  ASSERT(ne3  == n
+000517f0: 6531 3329 3b0a 0a20 2020 2063 6f6e 7374  e13);..    const
+00051800: 2065 6e75 6d20 6767 6d6c 5f74 7970 6520   enum ggml_type 
+00051810: 7479 7065 203d 2073 7263 302d 3e74 7970  type = src0->typ
+00051820: 653b 0a20 2020 2071 7561 6e74 697a 655f  e;.    quantize_
+00051830: 726f 775f 715f 7420 636f 6e73 7420 7175  row_q_t const qu
+00051840: 616e 7469 7a65 5f72 6f77 5f71 5f64 6f74  antize_row_q_dot
+00051850: 203d 2071 7561 6e74 697a 655f 666e 735b   = quantize_fns[
+00051860: 7479 7065 5d2e 7175 616e 7469 7a65 5f72  type].quantize_r
+00051870: 6f77 5f71 5f64 6f74 3b0a 2020 2020 7665  ow_q_dot;.    ve
+00051880: 635f 646f 745f 715f 7420 2020 2020 2063  c_dot_q_t      c
+00051890: 6f6e 7374 2076 6563 5f64 6f74 5f71 2020  onst vec_dot_q  
+000518a0: 2020 2020 2020 2020 3d20 7175 616e 7469          = quanti
+000518b0: 7a65 5f66 6e73 5b74 7970 655d 2e76 6563  ze_fns[type].vec
+000518c0: 5f64 6f74 5f71 3b0a 2020 2020 656e 756d  _dot_q;.    enum
+000518d0: 2067 676d 6c5f 7479 7065 2020 2063 6f6e   ggml_type   con
+000518e0: 7374 2076 6563 5f64 6f74 5f74 7970 6520  st vec_dot_type 
+000518f0: 2020 2020 2020 3d20 7175 616e 7469 7a65        = quantize
+00051900: 5f66 6e73 5b74 7970 655d 2e76 6563 5f64  _fns[type].vec_d
+00051910: 6f74 5f74 7970 653b 0a0a 2020 2020 2f2f  ot_type;..    //
+00051920: 2077 6520 646f 6e27 7420 7375 7070 6f72   we don't suppor
+00051930: 7420 7065 726d 7574 6564 2073 7263 3020  t permuted src0 
+00051940: 6f72 2073 7263 310a 2020 2020 4747 4d4c  or src1.    GGML
+00051950: 5f41 5353 4552 5428 6e62 3030 203d 3d20  _ASSERT(nb00 == 
+00051960: 2869 6e74 2920 4747 4d4c 5f54 5950 455f  (int) GGML_TYPE_
+00051970: 5349 5a45 5b74 7970 655d 293b 0a20 2020  SIZE[type]);.   
+00051980: 2047 474d 4c5f 4153 5345 5254 286e 6231   GGML_ASSERT(nb1
+00051990: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
+000519a0: 7429 293b 0a0a 2020 2020 2f2f 2064 7374  t));..    // dst
+000519b0: 2063 616e 6e6f 7420 6265 2074 7261 6e73   cannot be trans
+000519c0: 706f 7365 6420 6f72 2070 6572 6d75 7465  posed or permute
+000519d0: 640a 2020 2020 4747 4d4c 5f41 5353 4552  d.    GGML_ASSER
+000519e0: 5428 6e62 3020 3d3d 2073 697a 656f 6628  T(nb0 == sizeof(
+000519f0: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
+00051a00: 4c5f 4153 5345 5254 286e 6230 203c 3d20  L_ASSERT(nb0 <= 
+00051a10: 6e62 3129 3b0a 2020 2020 4747 4d4c 5f41  nb1);.    GGML_A
+00051a20: 5353 4552 5428 6e62 3120 3c3d 206e 6232  SSERT(nb1 <= nb2
+00051a30: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00051a40: 5254 286e 6232 203c 3d20 6e62 3329 3b0a  RT(nb2 <= nb3);.
+00051a50: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00051a60: 286e 6530 203d 3d20 6e65 3031 293b 0a20  (ne0 == ne01);. 
+00051a70: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+00051a80: 6531 203d 3d20 6e65 3131 293b 0a20 2020  e1 == ne11);.   
+00051a90: 2047 474d 4c5f 4153 5345 5254 286e 6532   GGML_ASSERT(ne2
+00051aa0: 203d 3d20 6e65 3032 293b 0a20 2020 2047   == ne02);.    G
+00051ab0: 474d 4c5f 4153 5345 5254 286e 6533 203d  GML_ASSERT(ne3 =
+00051ac0: 3d20 6e65 3033 293b 0a0a 2020 2020 2f2f  = ne03);..    //
+00051ad0: 206e 6230 3120 3e3d 206e 6230 3020 2d20   nb01 >= nb00 - 
+00051ae0: 7372 6330 2069 7320 6e6f 7420 7472 616e  src0 is not tran
+00051af0: 7370 6f73 6564 0a20 2020 202f 2f20 2020  sposed.    //   
+00051b00: 636f 6d70 7574 6520 6279 2073 7263 3020  compute by src0 
+00051b10: 726f 7773 0a0a 2369 6620 6465 6669 6e65  rows..#if define
+00051b20: 6428 4747 4d4c 5f55 5345 5f43 4c42 4c41  d(GGML_USE_CLBLA
+00051b30: 5354 290a 2020 2020 6966 2028 6767 6d6c  ST).    if (ggml
+00051b40: 5f63 6c5f 6361 6e5f 6d75 6c5f 6d61 7428  _cl_can_mul_mat(
+00051b50: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
+00051b60: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
+00051b70: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
+00051b80: 2026 2620 7061 7261 6d73 2d3e 7479 7065   && params->type
+00051b90: 203d 3d20 4747 4d4c 5f54 4153 4b5f 434f   == GGML_TASK_CO
+00051ba0: 4d50 5554 4529 207b 0a20 2020 2020 2020  MPUTE) {.       
+00051bb0: 2020 2020 2067 676d 6c5f 636c 5f6d 756c       ggml_cl_mul
+00051bc0: 5f6d 6174 2873 7263 302c 2073 7263 312c  _mat(src0, src1,
+00051bd0: 2064 7374 2c20 7061 7261 6d73 2d3e 7764   dst, params->wd
+00051be0: 6174 612c 2070 6172 616d 732d 3e77 7369  ata, params->wsi
+00051bf0: 7a65 293b 0a20 2020 2020 2020 207d 0a20  ze);.        }. 
+00051c00: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+00051c10: 2020 207d 0a23 656e 6469 660a 0a23 6966     }.#endif..#if
+00051c20: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
+00051c30: 455f 4143 4345 4c45 5241 5445 2920 7c7c  E_ACCELERATE) ||
+00051c40: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
+00051c50: 455f 4f50 454e 424c 4153 290a 2020 2020  E_OPENBLAS).    
+00051c60: 6966 2028 6767 6d6c 5f63 6f6d 7075 7465  if (ggml_compute
+00051c70: 5f66 6f72 7761 7264 5f6d 756c 5f6d 6174  _forward_mul_mat
+00051c80: 5f75 7365 5f62 6c61 7328 7372 6330 2c20  _use_blas(src0, 
+00051c90: 7372 6331 2c20 6473 7429 2920 7b0a 2020  src1, dst)) {.  
+00051ca0: 2020 2020 2020 6966 2028 7061 7261 6d73        if (params
+00051cb0: 2d3e 6974 6820 213d 2030 2920 7b0a 2020  ->ith != 0) {.  
+00051cc0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00051cd0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
 00051ce0: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
-00051cf0: 3e69 7468 2021 3d20 3029 207b 0a20 2020  >ith != 0) {.   
-00051d00: 2020 2020 2020 2020 2072 6574 7572 6e3b           return;
-00051d10: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00051d20: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00051d30: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00051d40: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
-00051d50: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00051d60: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00051d70: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00051d80: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00051d90: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00051da0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-00051db0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00051dc0: 2020 666c 6f61 7420 2a20 636f 6e73 7420    float * const 
-00051dd0: 7764 6174 6120 3d20 7061 7261 6d73 2d3e  wdata = params->
-00051de0: 7764 6174 613b 0a20 2020 2020 2020 2064  wdata;.        d
-00051df0: 6571 7561 6e74 697a 655f 726f 775f 715f  equantize_row_q_
-00051e00: 7420 636f 6e73 7420 6465 7175 616e 7469  t const dequanti
-00051e10: 7a65 5f72 6f77 5f71 203d 2071 7561 6e74  ze_row_q = quant
-00051e20: 697a 655f 666e 735b 7479 7065 5d2e 6465  ize_fns[type].de
-00051e30: 7175 616e 7469 7a65 5f72 6f77 5f71 3b0a  quantize_row_q;.
-00051e40: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-00051e50: 7436 345f 7420 6930 3320 3d20 303b 2069  t64_t i03 = 0; i
-00051e60: 3033 203c 206e 6530 333b 2069 3033 2b2b  03 < ne03; i03++
-00051e70: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00051e80: 666f 7220 2869 6e74 3634 5f74 2069 3032  for (int64_t i02
-00051e90: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
-00051ea0: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
-00051eb0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00051ec0: 2066 6c6f 6174 202a 2079 203d 2028 666c   float * y = (fl
-00051ed0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00051ee0: 2073 7263 312d 3e64 6174 6120 2b20 6930   src1->data + i0
-00051ef0: 322a 6e62 3132 202b 2069 3033 2a6e 6231  2*nb12 + i03*nb1
-00051f00: 3329 3b0a 0a20 2020 2020 2020 2020 2020  3);..           
-00051f10: 2020 2020 2066 6c6f 6174 202a 2064 203d       float * d =
-00051f20: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-00051f30: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
-00051f40: 2069 3032 2a6e 6232 202b 2069 3033 2a6e   i02*nb2 + i03*n
-00051f50: 6233 293b 0a0a 2020 2020 2020 2020 2020  b3);..          
-00051f60: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00051f70: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-00051f80: 5f74 2069 6420 3d20 303b 0a20 2020 2020  _t id = 0;.     
-00051f90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00051fa0: 6f72 2028 696e 7436 345f 7420 6930 3120  or (int64_t i01 
-00051fb0: 3d20 303b 2069 3031 203c 206e 6530 313b  = 0; i01 < ne01;
-00051fc0: 202b 2b69 3031 2920 7b0a 2020 2020 2020   ++i01) {.      
-00051fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051fe0: 2020 6465 7175 616e 7469 7a65 5f72 6f77    dequantize_row
-00051ff0: 5f71 2828 6368 6172 202a 2920 7372 6330  _q((char *) src0
-00052000: 2d3e 6461 7461 202b 2069 3033 2a6e 6230  ->data + i03*nb0
-00052010: 3320 2b20 6930 322a 6e62 3032 202b 2069  3 + i02*nb02 + i
-00052020: 3031 2a6e 6230 312c 2077 6461 7461 202b  01*nb01, wdata +
-00052030: 2069 642c 206e 6530 3029 3b0a 2020 2020   id, ne00);.    
-00052040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052050: 2020 2020 6964 202b 3d20 6e65 3030 3b0a      id += ne00;.
-00052060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052070: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-00052080: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00052090: 7428 6964 2a73 697a 656f 6628 666c 6f61  t(id*sizeof(floa
-000520a0: 7429 203c 3d20 7061 7261 6d73 2d3e 7773  t) <= params->ws
-000520b0: 697a 6529 3b0a 2020 2020 2020 2020 2020  ize);.          
-000520c0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000520d0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-000520e0: 6c6f 6174 202a 2078 203d 2077 6461 7461  loat * x = wdata
-000520f0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00052100: 2020 2063 626c 6173 5f73 6765 6d6d 2843     cblas_sgemm(C
-00052110: 626c 6173 526f 774d 616a 6f72 2c20 4362  blasRowMajor, Cb
-00052120: 6c61 734e 6f54 7261 6e73 2c20 4362 6c61  lasNoTrans, Cbla
-00052130: 7354 7261 6e73 2c0a 2020 2020 2020 2020  sTrans,.        
-00052140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052150: 6e65 3131 2c20 6e65 3031 2c20 6e65 3130  ne11, ne01, ne10
-00052160: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00052170: 2020 2020 2020 2020 2020 312e 3066 2c20            1.0f, 
-00052180: 2020 2079 2c20 6e65 3130 2c0a 2020 2020     y, ne10,.    
-00052190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000521a0: 2020 2020 2020 2020 2020 2020 2078 2c20               x, 
-000521b0: 6e65 3030 2c0a 2020 2020 2020 2020 2020  ne00,.          
-000521c0: 2020 2020 2020 2020 2020 2020 2020 302e                0.
-000521d0: 3066 2c20 2020 2064 2c20 6e65 3031 293b  0f,    d, ne01);
-000521e0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-000521f0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00052200: 2020 2f2f 7072 696e 7466 2822 4342 4c41    //printf("CBLA
-00052210: 5320 3d20 2566 206d 732c 2025 6420 7820  S = %f ms, %d x 
-00052220: 2564 2078 2025 6420 7820 2564 5c6e 222c  %d x %d x %d\n",
-00052230: 2028 6767 6d6c 5f70 6572 665f 7469 6d65   (ggml_perf_time
-00052240: 5f75 7328 2920 2d20 7430 292f 3130 3030  _us() - t0)/1000
-00052250: 2e30 2c20 6e65 302c 206e 6531 2c20 6e65  .0, ne0, ne1, ne
-00052260: 322c 206e 6533 293b 0a0a 2020 2020 2020  2, ne3);..      
-00052270: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-00052280: 2365 6e64 6966 0a0a 2020 2020 6966 2028  #endif..    if (
-00052290: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-000522a0: 4747 4d4c 5f54 4153 4b5f 494e 4954 2920  GGML_TASK_INIT) 
-000522b0: 7b0a 2020 2020 2020 2020 6368 6172 202a  {.        char *
-000522c0: 2077 6461 7461 203d 2070 6172 616d 732d   wdata = params-
-000522d0: 3e77 6461 7461 3b0a 2020 2020 2020 2020  >wdata;.        
-000522e0: 636f 6e73 7420 7369 7a65 5f74 2072 6f77  const size_t row
-000522f0: 5f73 697a 6520 3d20 6e65 3130 2a47 474d  _size = ne10*GGM
-00052300: 4c5f 5459 5045 5f53 495a 455b 7665 635f  L_TYPE_SIZE[vec_
-00052310: 646f 745f 7479 7065 5d2f 4747 4d4c 5f42  dot_type]/GGML_B
-00052320: 4c43 4b5f 5349 5a45 5b76 6563 5f64 6f74  LCK_SIZE[vec_dot
-00052330: 5f74 7970 655d 3b0a 0a20 2020 2020 2020  _type];..       
-00052340: 2066 6f72 2028 696e 7436 345f 7420 6931   for (int64_t i1
-00052350: 3320 3d20 303b 2069 3133 203c 206e 6531  3 = 0; i13 < ne1
-00052360: 333b 202b 2b69 3133 2920 7b0a 2020 2020  3; ++i13) {.    
-00052370: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00052380: 3634 5f74 2069 3132 203d 2030 3b20 6931  64_t i12 = 0; i1
-00052390: 3220 3c20 6e65 3132 3b20 2b2b 6931 3229  2 < ne12; ++i12)
-000523a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000523b0: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-000523c0: 6931 3120 3d20 303b 2069 3131 203c 206e  i11 = 0; i11 < n
-000523d0: 6531 313b 202b 2b69 3131 2920 7b0a 2020  e11; ++i11) {.  
-000523e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000523f0: 2020 7175 616e 7469 7a65 5f72 6f77 5f71    quantize_row_q
-00052400: 5f64 6f74 2828 666c 6f61 7420 2a29 2828  _dot((float *)((
-00052410: 6368 6172 202a 2920 7372 6331 2d3e 6461  char *) src1->da
-00052420: 7461 202b 2069 3133 2a6e 6231 3320 2b20  ta + i13*nb13 + 
-00052430: 6931 322a 6e62 3132 202b 2069 3131 2a6e  i12*nb12 + i11*n
-00052440: 6231 3129 2c20 2876 6f69 6420 2a29 2077  b11), (void *) w
-00052450: 6461 7461 2c20 6e65 3130 293b 0a20 2020  data, ne10);.   
-00052460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052470: 2077 6461 7461 202b 3d20 726f 775f 7369   wdata += row_si
-00052480: 7a65 3b0a 2020 2020 2020 2020 2020 2020  ze;.            
-00052490: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000524a0: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
-000524b0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-000524c0: 2020 207d 0a0a 2020 2020 6966 2028 7061     }..    if (pa
-000524d0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-000524e0: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
-000524f0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-00052500: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
-00052510: 2f20 7061 7261 6c6c 656c 697a 6520 6279  / parallelize by
-00052520: 2073 7263 3020 726f 7773 2075 7369 6e67   src0 rows using
-00052530: 2067 676d 6c5f 7665 635f 646f 745f 710a   ggml_vec_dot_q.
-00052540: 0a20 2020 202f 2f20 746f 7461 6c20 726f  .    // total ro
-00052550: 7773 2069 6e20 7372 6330 0a20 2020 2063  ws in src0.    c
-00052560: 6f6e 7374 2069 6e74 206e 7220 3d20 6e65  onst int nr = ne
-00052570: 3031 2a6e 6530 322a 6e65 3033 3b0a 0a20  01*ne02*ne03;.. 
-00052580: 2020 202f 2f20 726f 7773 2070 6572 2074     // rows per t
-00052590: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
-000525a0: 696e 7420 6472 203d 2028 6e72 202b 206e  int dr = (nr + n
-000525b0: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-000525c0: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
-000525d0: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
-000525e0: 2020 2063 6f6e 7374 2069 6e74 2069 7230     const int ir0
-000525f0: 203d 2064 722a 6974 683b 0a20 2020 2063   = dr*ith;.    c
-00052600: 6f6e 7374 2069 6e74 2069 7231 203d 204d  onst int ir1 = M
-00052610: 494e 2869 7230 202b 2064 722c 206e 7229  IN(ir0 + dr, nr)
-00052620: 3b0a 0a20 2020 2076 6f69 6420 2a20 7764  ;..    void * wd
-00052630: 6174 6120 3d20 7061 7261 6d73 2d3e 7764  ata = params->wd
-00052640: 6174 613b 0a20 2020 2063 6f6e 7374 2073  ata;.    const s
-00052650: 697a 655f 7420 726f 775f 7369 7a65 203d  ize_t row_size =
-00052660: 206e 6530 302a 4747 4d4c 5f54 5950 455f   ne00*GGML_TYPE_
-00052670: 5349 5a45 5b76 6563 5f64 6f74 5f74 7970  SIZE[vec_dot_typ
-00052680: 655d 2f47 474d 4c5f 424c 434b 5f53 495a  e]/GGML_BLCK_SIZ
-00052690: 455b 7665 635f 646f 745f 7479 7065 5d3b  E[vec_dot_type];
-000526a0: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
-000526b0: 7220 3d20 6972 303b 2069 7220 3c20 6972  r = ir0; ir < ir
-000526c0: 313b 202b 2b69 7229 207b 0a20 2020 2020  1; ++ir) {.     
-000526d0: 2020 202f 2f20 7372 6330 2069 6e64 6963     // src0 indic
-000526e0: 6573 0a20 2020 2020 2020 2063 6f6e 7374  es.        const
-000526f0: 2069 6e74 2069 3033 203d 2069 722f 286e   int i03 = ir/(n
-00052700: 6530 322a 6e65 3031 293b 0a20 2020 2020  e02*ne01);.     
-00052710: 2020 2063 6f6e 7374 2069 6e74 2069 3032     const int i02
-00052720: 203d 2028 6972 202d 2069 3033 2a6e 6530   = (ir - i03*ne0
-00052730: 322a 6e65 3031 292f 6e65 3031 3b0a 2020  2*ne01)/ne01;.  
-00052740: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00052750: 6930 3120 3d20 2869 7220 2d20 6930 332a  i01 = (ir - i03*
-00052760: 6e65 3032 2a6e 6530 3120 2d20 6930 322a  ne02*ne01 - i02*
-00052770: 6e65 3031 293b 0a0a 2020 2020 2020 2020  ne01);..        
-00052780: 636f 6e73 7420 696e 7420 6931 3320 3d20  const int i13 = 
-00052790: 6930 333b 0a20 2020 2020 2020 2063 6f6e  i03;.        con
-000527a0: 7374 2069 6e74 2069 3132 203d 2069 3032  st int i12 = i02
-000527b0: 3b0a 0a20 2020 2020 2020 2063 6f6e 7374  ;..        const
-000527c0: 2069 6e74 2069 3020 3d20 6930 313b 0a20   int i0 = i01;. 
-000527d0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-000527e0: 2069 3220 3d20 6930 323b 0a20 2020 2020   i2 = i02;.     
-000527f0: 2020 2063 6f6e 7374 2069 6e74 2069 3320     const int i3 
-00052800: 3d20 6930 333b 0a0a 2020 2020 2020 2020  = i03;..        
-00052810: 766f 6964 202a 2073 7263 305f 726f 7720  void * src0_row 
-00052820: 3d20 2876 6f69 6420 2a29 2028 2863 6861  = (void *) ((cha
-00052830: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00052840: 2b20 2869 3031 2a6e 6230 3120 2b20 6930  + (i01*nb01 + i0
-00052850: 322a 6e62 3032 202b 2069 3033 2a6e 6230  2*nb02 + i03*nb0
-00052860: 3329 293b 0a20 2020 2020 2020 2063 6861  3));.        cha
-00052870: 7220 2a20 7372 6331 5f63 6f6c 203d 2020  r * src1_col =  
-00052880: 2020 2020 2020 2020 2828 6368 6172 202a          ((char *
-00052890: 2920 2020 2020 2077 6461 7461 202b 2028  )      wdata + (
-000528a0: 2020 2020 2020 2830 202b 2069 3132 2a6e        (0 + i12*n
-000528b0: 6531 3120 2b20 6931 332a 6e65 3132 2a6e  e11 + i13*ne12*n
-000528c0: 6531 3129 2a72 6f77 5f73 697a 6529 293b  e11)*row_size));
-000528d0: 0a0a 2020 2020 2020 2020 666c 6f61 7420  ..        float 
-000528e0: 2a20 6473 745f 636f 6c20 3d20 2866 6c6f  * dst_col = (flo
-000528f0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-00052900: 6473 742d 3e64 6174 6120 2b20 2869 302a  dst->data + (i0*
-00052910: 6e62 3020 2b20 302a 6e62 3120 2b20 6932  nb0 + 0*nb1 + i2
-00052920: 2a6e 6232 202b 2069 332a 6e62 3329 293b  *nb2 + i3*nb3));
-00052930: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
-00052940: 286e 6530 3020 2520 3332 203d 3d20 3029  (ne00 % 32 == 0)
-00052950: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
-00052960: 696e 7436 345f 7420 6963 203d 2030 3b20  int64_t ic = 0; 
-00052970: 6963 203c 206e 6531 313b 202b 2b69 6329  ic < ne11; ++ic)
-00052980: 207b 0a20 2020 2020 2020 2020 2020 2076   {.            v
-00052990: 6563 5f64 6f74 5f71 286e 6530 302c 2026  ec_dot_q(ne00, &
-000529a0: 6473 745f 636f 6c5b 6963 2a6e 6530 5d2c  dst_col[ic*ne0],
-000529b0: 2073 7263 305f 726f 772c 2028 766f 6964   src0_row, (void
-000529c0: 202a 2920 2873 7263 315f 636f 6c20 2b20   *) (src1_col + 
-000529d0: 6963 2a72 6f77 5f73 697a 6529 293b 0a20  ic*row_size));. 
-000529e0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-000529f0: 2020 2020 2f2f 696e 7436 345f 7420 7431      //int64_t t1
-00052a00: 203d 2067 676d 6c5f 7469 6d65 5f75 7328   = ggml_time_us(
-00052a10: 293b 0a20 2020 202f 2f73 7461 7469 6320  );.    //static 
-00052a20: 696e 7436 345f 7420 6163 6320 3d20 303b  int64_t acc = 0;
-00052a30: 0a20 2020 202f 2f61 6363 202b 3d20 7431  .    //acc += t1
-00052a40: 202d 2074 303b 0a20 2020 202f 2f69 6620   - t0;.    //if 
-00052a50: 2874 3120 2d20 7430 203e 2031 3029 207b  (t1 - t0 > 10) {
-00052a60: 0a20 2020 202f 2f20 2020 2070 7269 6e74  .    //    print
-00052a70: 6628 225c 6e22 293b 0a20 2020 202f 2f20  f("\n");.    // 
-00052a80: 2020 2070 7269 6e74 6628 226e 6530 3020     printf("ne00 
-00052a90: 3d20 2535 642c 206e 6530 3120 3d20 2535  = %5d, ne01 = %5
-00052aa0: 642c 206e 6530 3220 3d20 2535 642c 206e  d, ne02 = %5d, n
-00052ab0: 6530 3320 3d20 2535 645c 6e22 2c20 6e65  e03 = %5d\n", ne
-00052ac0: 3030 2c20 6e65 3031 2c20 6e65 3032 2c20  00, ne01, ne02, 
-00052ad0: 6e65 3033 293b 0a20 2020 202f 2f20 2020  ne03);.    //   
-00052ae0: 2070 7269 6e74 6628 226e 6230 3020 3d20   printf("nb00 = 
-00052af0: 2535 642c 206e 6230 3120 3d20 2535 642c  %5d, nb01 = %5d,
-00052b00: 206e 6230 3220 3d20 2535 642c 206e 6230   nb02 = %5d, nb0
-00052b10: 3320 3d20 2535 645c 6e22 2c20 6e62 3030  3 = %5d\n", nb00
-00052b20: 2c20 6e62 3031 2c20 6e62 3032 2c20 6e62  , nb01, nb02, nb
-00052b30: 3033 293b 0a20 2020 202f 2f20 2020 2070  03);.    //    p
-00052b40: 7269 6e74 6628 226e 6531 3020 3d20 2535  rintf("ne10 = %5
-00052b50: 642c 206e 6531 3120 3d20 2535 642c 206e  d, ne11 = %5d, n
-00052b60: 6531 3220 3d20 2535 642c 206e 6531 3320  e12 = %5d, ne13 
-00052b70: 3d20 2535 645c 6e22 2c20 6e65 3130 2c20  = %5d\n", ne10, 
-00052b80: 6e65 3131 2c20 6e65 3132 2c20 6e65 3133  ne11, ne12, ne13
-00052b90: 293b 0a0a 2020 2020 2f2f 2020 2020 7072  );..    //    pr
-00052ba0: 696e 7466 2822 5858 5858 5858 5858 5858  intf("XXXXXXXXXX
-00052bb0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00052bc0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00052bd0: 5858 5858 5858 5858 5858 2074 6173 6b20  XXXXXXXXXX task 
-00052be0: 2564 2f25 643a 2025 6420 7573 2c20 6163  %d/%d: %d us, ac
-00052bf0: 6320 3d20 2564 5c6e 222c 2069 7468 2c20  c = %d\n", ith, 
-00052c00: 6e74 682c 2028 696e 7429 2028 7431 202d  nth, (int) (t1 -
-00052c10: 2074 3029 2c20 2869 6e74 2920 6163 6329   t0), (int) acc)
-00052c20: 3b0a 2020 2020 2f2f 7d0a 7d0a 0a73 7461  ;.    //}.}..sta
-00052c30: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00052c40: 6d70 7574 655f 666f 7277 6172 645f 6d75  mpute_forward_mu
-00052c50: 6c5f 6d61 7428 0a20 2020 2020 2020 2063  l_mat(.        c
-00052c60: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00052c70: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00052c80: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00052c90: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00052ca0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00052cb0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00052cc0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00052cd0: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-00052ce0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00052cf0: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00052d00: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
-00052d10: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-00052d20: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00052d30: 5f51 345f 303a 0a20 2020 2020 2020 2063  _Q4_0:.        c
-00052d40: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
-00052d50: 5f31 3a0a 2020 2020 2020 2020 6361 7365  _1:.        case
-00052d60: 2047 474d 4c5f 5459 5045 5f51 355f 303a   GGML_TYPE_Q5_0:
-00052d70: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00052d80: 4d4c 5f54 5950 455f 5135 5f31 3a0a 2020  ML_TYPE_Q5_1:.  
-00052d90: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00052da0: 5459 5045 5f51 385f 303a 0a20 2020 2020  TYPE_Q8_0:.     
-00052db0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00052dc0: 455f 5138 5f31 3a0a 2020 2020 2020 2020  E_Q8_1:.        
-00052dd0: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00052de0: 325f 4b3a 0a20 2020 2020 2020 2063 6173  2_K:.        cas
-00052df0: 6520 4747 4d4c 5f54 5950 455f 5133 5f4b  e GGML_TYPE_Q3_K
-00052e00: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00052e10: 474d 4c5f 5459 5045 5f51 345f 4b3a 0a20  GML_TYPE_Q4_K:. 
-00052e20: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00052e30: 5f54 5950 455f 5135 5f4b 3a0a 2020 2020  _TYPE_Q5_K:.    
-00052e40: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00052e50: 5045 5f51 365f 4b3a 0a20 2020 2020 2020  PE_Q6_K:.       
-00052e60: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00052e70: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00052e80: 7574 655f 666f 7277 6172 645f 6d75 6c5f  ute_forward_mul_
-00052e90: 6d61 745f 715f 6633 3228 7061 7261 6d73  mat_q_f32(params
-00052ea0: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
-00052eb0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-00052ec0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00052ed0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00052ee0: 4631 363a 0a20 2020 2020 2020 2020 2020  F16:.           
-00052ef0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00052f00: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00052f10: 666f 7277 6172 645f 6d75 6c5f 6d61 745f  forward_mul_mat_
-00052f20: 6631 365f 6633 3228 7061 7261 6d73 2c20  f16_f32(params, 
-00052f30: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
-00052f40: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00052f50: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00052f60: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-00052f70: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-00052f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00052f90: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00052fa0: 7277 6172 645f 6d75 6c5f 6d61 745f 6633  rward_mul_mat_f3
-00052fb0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
-00052fc0: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
-00052fd0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00052fe0: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
-00052ff0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00053000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053010: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-00053020: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00053030: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
-00053040: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-00053050: 655f 666f 7277 6172 645f 6f75 745f 7072  e_forward_out_pr
-00053060: 6f64 0a0a 0a73 7461 7469 6320 766f 6964  od...static void
-00053070: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00053080: 7277 6172 645f 6f75 745f 7072 6f64 5f66  rward_out_prod_f
-00053090: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
-000530a0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-000530b0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-000530c0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-000530d0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000530e0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-000530f0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00053100: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00053110: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-00053120: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00053130: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-00053140: 207b 0a20 2020 2069 6e74 3634 5f74 2074   {.    int64_t t
-00053150: 3020 3d20 6767 6d6c 5f70 6572 665f 7469  0 = ggml_perf_ti
-00053160: 6d65 5f75 7328 293b 0a20 2020 2055 4e55  me_us();.    UNU
-00053170: 5345 4428 7430 293b 0a0a 2020 2020 636f  SED(t0);..    co
-00053180: 6e73 7420 696e 7436 345f 7420 6e65 3030  nst int64_t ne00
-00053190: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
-000531a0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-000531b0: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
-000531c0: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-000531d0: 696e 7436 345f 7420 6e65 3032 203d 2073  int64_t ne02 = s
-000531e0: 7263 302d 3e6e 655b 325d 3b0a 2020 2020  rc0->ne[2];.    
-000531f0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00053200: 3033 203d 2073 7263 302d 3e6e 655b 335d  03 = src0->ne[3]
-00053210: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00053220: 3634 5f74 206e 6531 3020 3d20 7372 6331  64_t ne10 = src1
-00053230: 2d3e 6e65 5b30 5d3b 0a20 2020 202f 2f63  ->ne[0];.    //c
-00053240: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-00053250: 3120 3d20 7372 6331 2d3e 6e65 5b31 5d3b  1 = src1->ne[1];
-00053260: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00053270: 5f74 206e 6531 3220 3d20 7372 6331 2d3e  _t ne12 = src1->
-00053280: 6e65 5b32 5d3b 0a20 2020 2063 6f6e 7374  ne[2];.    const
-00053290: 2069 6e74 3634 5f74 206e 6531 3320 3d20   int64_t ne13 = 
-000532a0: 7372 6331 2d3e 6e65 5b33 5d3b 0a0a 2020  src1->ne[3];..  
-000532b0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000532c0: 6e65 3020 203d 2064 7374 2d3e 6e65 5b30  ne0  = dst->ne[0
-000532d0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-000532e0: 3634 5f74 206e 6531 2020 3d20 6473 742d  64_t ne1  = dst-
-000532f0: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
-00053300: 7420 696e 7436 345f 7420 6e65 3220 203d  t int64_t ne2  =
-00053310: 2064 7374 2d3e 6e65 5b32 5d3b 0a20 2020   dst->ne[2];.   
-00053320: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00053330: 6533 2020 3d20 6473 742d 3e6e 655b 335d  e3  = dst->ne[3]
-00053340: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00053350: 206e 6230 3020 3d20 7372 6330 2d3e 6e62   nb00 = src0->nb
-00053360: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-00053370: 6e74 206e 6230 3120 3d20 7372 6330 2d3e  nt nb01 = src0->
-00053380: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-00053390: 2069 6e74 206e 6230 3220 3d20 7372 6330   int nb02 = src0
-000533a0: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-000533b0: 7374 2069 6e74 206e 6230 3320 3d20 7372  st int nb03 = sr
-000533c0: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
-000533d0: 636f 6e73 7420 696e 7420 6e62 3130 203d  const int nb10 =
-000533e0: 2073 7263 312d 3e6e 625b 305d 3b0a 2020   src1->nb[0];.  
-000533f0: 2020 636f 6e73 7420 696e 7420 6e62 3131    const int nb11
-00053400: 203d 2073 7263 312d 3e6e 625b 315d 3b0a   = src1->nb[1];.
-00053410: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00053420: 3132 203d 2073 7263 312d 3e6e 625b 325d  12 = src1->nb[2]
-00053430: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00053440: 6e62 3133 203d 2073 7263 312d 3e6e 625b  nb13 = src1->nb[
-00053450: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-00053460: 6e74 206e 6230 2020 3d20 6473 742d 3e6e  nt nb0  = dst->n
-00053470: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-00053480: 696e 7420 6e62 3120 203d 2064 7374 2d3e  int nb1  = dst->
-00053490: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-000534a0: 2069 6e74 206e 6232 2020 3d20 6473 742d   int nb2  = dst-
-000534b0: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
-000534c0: 7420 696e 7420 6e62 3320 203d 2064 7374  t int nb3  = dst
-000534d0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
-000534e0: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
-000534f0: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
-00053500: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
-00053510: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
-00053520: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
-00053530: 3220 3d3d 206e 6531 3229 3b0a 2020 2020  2 == ne12);.    
-00053540: 4747 4d4c 5f41 5353 4552 5428 6e65 3033  GGML_ASSERT(ne03
-00053550: 203d 3d20 6e65 3133 293b 0a20 2020 2047   == ne13);.    G
-00053560: 474d 4c5f 4153 5345 5254 286e 6532 2020  GML_ASSERT(ne2  
-00053570: 3d3d 206e 6531 3229 3b0a 2020 2020 4747  == ne12);.    GG
-00053580: 4d4c 5f41 5353 4552 5428 6e65 3320 203d  ML_ASSERT(ne3  =
-00053590: 3d20 6e65 3133 293b 0a0a 2020 2020 2f2f  = ne13);..    //
-000535a0: 2077 6520 646f 6e27 7420 7375 7070 6f72   we don't suppor
-000535b0: 7420 7065 726d 7574 6564 2073 7263 3020  t permuted src0 
-000535c0: 6f72 2073 7263 310a 2020 2020 4747 4d4c  or src1.    GGML
-000535d0: 5f41 5353 4552 5428 6e62 3030 203d 3d20  _ASSERT(nb00 == 
-000535e0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-000535f0: 0a20 2020 202f 2f20 6473 7420 6361 6e6e  .    // dst cann
-00053600: 6f74 2062 6520 7472 616e 7370 6f73 6564  ot be transposed
-00053610: 206f 7220 7065 726d 7574 6564 0a20 2020   or permuted.   
-00053620: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
-00053630: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-00053640: 2929 3b0a 2020 2020 2f2f 2047 474d 4c5f  ));.    // GGML_
-00053650: 4153 5345 5254 286e 6230 203c 3d20 6e62  ASSERT(nb0 <= nb
-00053660: 3129 3b0a 2020 2020 2f2f 2047 474d 4c5f  1);.    // GGML_
-00053670: 4153 5345 5254 286e 6231 203c 3d20 6e62  ASSERT(nb1 <= nb
-00053680: 3229 3b0a 2020 2020 2f2f 2047 474d 4c5f  2);.    // GGML_
-00053690: 4153 5345 5254 286e 6232 203c 3d20 6e62  ASSERT(nb2 <= nb
-000536a0: 3329 3b0a 0a20 2020 2047 474d 4c5f 4153  3);..    GGML_AS
-000536b0: 5345 5254 286e 6530 203d 3d20 6e65 3030  SERT(ne0 == ne00
-000536c0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000536d0: 5254 286e 6531 203d 3d20 6e65 3130 293b  RT(ne1 == ne10);
-000536e0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000536f0: 286e 6532 203d 3d20 6e65 3032 293b 0a20  (ne2 == ne02);. 
-00053700: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00053710: 6533 203d 3d20 6e65 3033 293b 0a0a 2020  e3 == ne03);..  
-00053720: 2020 2f2f 206e 6230 3120 3e3d 206e 6230    // nb01 >= nb0
-00053730: 3020 2d20 7372 6330 2069 7320 6e6f 7420  0 - src0 is not 
-00053740: 7472 616e 7370 6f73 6564 0a20 2020 202f  transposed.    /
-00053750: 2f20 2020 636f 6d70 7574 6520 6279 2073  /   compute by s
-00053760: 7263 3020 726f 7773 0a0a 2020 2020 2f2f  rc0 rows..    //
-00053770: 2054 4f44 4f3a 2023 6966 2064 6566 696e   TODO: #if defin
-00053780: 6564 2847 474d 4c5f 5553 455f 4355 424c  ed(GGML_USE_CUBL
-00053790: 4153 2920 6767 6d6c 5f63 7564 615f 6f75  AS) ggml_cuda_ou
-000537a0: 745f 7072 6f64 0a20 2020 202f 2f20 544f  t_prod.    // TO
-000537b0: 444f 3a20 2369 6620 6465 6669 6e65 6428  DO: #if defined(
-000537c0: 4747 4d4c 5f55 5345 5f41 4343 454c 4552  GGML_USE_ACCELER
-000537d0: 4154 4529 207c 7c20 6465 6669 6e65 6428  ATE) || defined(
-000537e0: 4747 4d4c 5f55 5345 5f4f 5045 4e42 4c41  GGML_USE_OPENBLA
-000537f0: 5329 207c 7c20 6465 6669 6e65 6428 4747  S) || defined(GG
-00053800: 4d4c 5f55 5345 5f43 4c42 4c41 5354 290a  ML_USE_CLBLAST).
-00053810: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00053820: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00053830: 534b 5f49 4e49 5429 207b 0a20 2020 2020  SK_INIT) {.     
-00053840: 2020 2067 676d 6c5f 7665 635f 7365 745f     ggml_vec_set_
-00053850: 6633 3228 6e65 302a 6e65 312a 6e65 322a  f32(ne0*ne1*ne2*
-00053860: 6e65 332c 2064 7374 2d3e 6461 7461 2c20  ne3, dst->data, 
-00053870: 3029 3b0a 2020 2020 2020 2020 7265 7475  0);.        retu
-00053880: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
-00053890: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-000538a0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-000538b0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-000538c0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-000538d0: 2020 2020 2f2f 2070 6172 616c 6c65 6c69      // paralleli
-000538e0: 7a65 2062 7920 6c61 7374 2074 6872 6565  ze by last three
-000538f0: 2064 696d 656e 7369 6f6e 730a 0a20 2020   dimensions..   
-00053900: 202f 2f20 746f 7461 6c20 726f 7773 2069   // total rows i
-00053910: 6e20 6473 740a 2020 2020 636f 6e73 7420  n dst.    const 
-00053920: 696e 7436 345f 7420 6e72 203d 206e 6531  int64_t nr = ne1
-00053930: 2a6e 6532 2a6e 6533 3b0a 0a20 2020 202f  *ne2*ne3;..    /
-00053940: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-00053950: 640a 2020 2020 636f 6e73 7420 696e 7436  d.    const int6
-00053960: 345f 7420 6472 203d 2028 6e72 202b 206e  4_t dr = (nr + n
-00053970: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-00053980: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
-00053990: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
-000539a0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-000539b0: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
-000539c0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-000539d0: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
-000539e0: 2064 722c 206e 7229 3b0a 0a20 2020 202f   dr, nr);..    /
-000539f0: 2f20 6473 745b 3a2c 3a2c 3a2c 3a5d 203d  / dst[:,:,:,:] =
-00053a00: 2030 0a20 2020 202f 2f20 666f 7220 6932   0.    // for i2
-00053a10: 2c69 333a 0a20 2020 202f 2f20 2020 666f  ,i3:.    //   fo
-00053a20: 7220 6931 3a0a 2020 2020 2f2f 2020 2020  r i1:.    //    
-00053a30: 2066 6f72 2069 3031 3a0a 2020 2020 2f2f   for i01:.    //
-00053a40: 2020 2020 2020 2066 6f72 2069 303a 0a20         for i0:. 
-00053a50: 2020 202f 2f20 2020 2020 2020 2020 6473     //         ds
-00053a60: 745b 6930 2c69 312c 6932 2c69 335d 202b  t[i0,i1,i2,i3] +
-00053a70: 3d20 7372 6330 5b69 302c 6930 312c 6932  = src0[i0,i01,i2
-00053a80: 2c69 335d 202a 2073 7263 315b 6931 2c69  ,i3] * src1[i1,i
-00053a90: 3031 2c69 322c 6933 5d0a 0a20 2020 2066  01,i2,i3]..    f
-00053aa0: 6f72 2028 696e 7436 345f 7420 6972 203d  or (int64_t ir =
-00053ab0: 2069 7230 3b20 6972 203c 2069 7231 3b20   ir0; ir < ir1; 
-00053ac0: 2b2b 6972 2920 7b0a 2020 2020 2020 2020  ++ir) {.        
-00053ad0: 2f2f 2064 7374 2069 6e64 6963 6573 0a20  // dst indices. 
-00053ae0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00053af0: 3634 5f74 2069 3320 3d20 6972 2f28 6e65  64_t i3 = ir/(ne
-00053b00: 322a 6e65 3129 3b0a 2020 2020 2020 2020  2*ne1);.        
-00053b10: 636f 6e73 7420 696e 7436 345f 7420 6932  const int64_t i2
-00053b20: 203d 2028 6972 202d 2069 332a 6e65 322a   = (ir - i3*ne2*
-00053b30: 6e65 3129 2f6e 6531 3b0a 2020 2020 2020  ne1)/ne1;.      
-00053b40: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00053b50: 6931 203d 2028 6972 202d 2069 332a 6e65  i1 = (ir - i3*ne
-00053b60: 322a 6e65 3120 2d20 6932 2a6e 6531 293b  2*ne1 - i2*ne1);
-00053b70: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
-00053b80: 696e 7436 345f 7420 6930 3220 3d20 6932  int64_t i02 = i2
-00053b90: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-00053ba0: 696e 7436 345f 7420 6930 3320 3d20 6933  int64_t i03 = i3
-00053bb0: 3b0a 0a20 2020 2020 2020 202f 2f63 6f6e  ;..        //con
-00053bc0: 7374 2069 6e74 3634 5f74 2069 3130 203d  st int64_t i10 =
-00053bd0: 2069 313b 0a20 2020 2020 2020 2063 6f6e   i1;.        con
-00053be0: 7374 2069 6e74 3634 5f74 2069 3132 203d  st int64_t i12 =
-00053bf0: 2069 323b 0a20 2020 2020 2020 2063 6f6e   i2;.        con
-00053c00: 7374 2069 6e74 3634 5f74 2069 3133 203d  st int64_t i13 =
-00053c10: 2069 333b 0a0a 2020 2020 2020 2020 666f   i3;..        fo
-00053c20: 7220 2869 6e74 3634 5f74 2069 3031 203d  r (int64_t i01 =
-00053c30: 2030 3b20 6930 3120 3c20 6e65 3031 3b20   0; i01 < ne01; 
-00053c40: 2b2b 6930 3129 207b 0a20 2020 2020 2020  ++i01) {.       
-00053c50: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-00053c60: 5f74 2069 3131 203d 2069 3031 3b0a 0a20  _t i11 = i01;.. 
-00053c70: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-00053c80: 202a 2073 3020 3d20 2866 6c6f 6174 202a   * s0 = (float *
-00053c90: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
-00053ca0: 2d3e 6461 7461 202b 2028 2020 2020 2020  ->data + (      
-00053cb0: 2020 2020 6930 312a 6e62 3031 202b 2069      i01*nb01 + i
-00053cc0: 3032 2a6e 6230 3220 2b20 6930 332a 6e62  02*nb02 + i03*nb
-00053cd0: 3033 2929 3b0a 2020 2020 2020 2020 2020  03));.          
-00053ce0: 2020 666c 6f61 7420 2a20 7331 203d 2028    float * s1 = (
-00053cf0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00053d00: 2a29 2073 7263 312d 3e64 6174 6120 2b20  *) src1->data + 
-00053d10: 2869 312a 6e62 3130 202b 2069 3131 2a6e  (i1*nb10 + i11*n
-00053d20: 6231 3120 2b20 6931 322a 6e62 3132 202b  b11 + i12*nb12 +
-00053d30: 2069 3133 2a6e 6231 3329 293b 0a20 2020   i13*nb13));.   
-00053d40: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-00053d50: 2064 2020 3d20 2866 6c6f 6174 202a 2920   d  = (float *) 
-00053d60: 2828 6368 6172 202a 2920 2064 7374 2d3e  ((char *)  dst->
-00053d70: 6461 7461 202b 2028 2020 2020 2020 2020  data + (        
-00053d80: 2020 6931 2a6e 6231 202b 2069 322a 6e62    i1*nb1 + i2*nb
-00053d90: 3220 2b20 6933 2a6e 6233 2929 3b0a 0a20  2 + i3*nb3));.. 
-00053da0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00053db0: 7665 635f 6d61 645f 6633 3228 6e65 302c  vec_mad_f32(ne0,
-00053dc0: 2064 2c20 7330 2c20 2a73 3129 3b0a 2020   d, s0, *s1);.  
-00053dd0: 2020 2020 2020 2020 2020 2f2f 2066 6f72            // for
-00053de0: 2028 696e 7436 345f 7420 6930 203d 2030   (int64_t i0 = 0
-00053df0: 3b20 6930 203c 206e 6530 3b20 2b2b 6930  ; i0 < ne0; ++i0
-00053e00: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00053e10: 2f2f 2020 2020 2064 5b69 305d 202b 3d20  //     d[i0] += 
-00053e20: 7330 5b69 305d 202a 2073 315b 6931 5d3b  s0[i0] * s1[i1];
-00053e30: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-00053e40: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
-00053e50: 7d0a 0a20 2020 202f 2f69 6e74 3634 5f74  }..    //int64_t
-00053e60: 2074 3120 3d20 6767 6d6c 5f70 6572 665f   t1 = ggml_perf_
-00053e70: 7469 6d65 5f75 7328 293b 0a20 2020 202f  time_us();.    /
-00053e80: 2f73 7461 7469 6320 696e 7436 345f 7420  /static int64_t 
-00053e90: 6163 6320 3d20 303b 0a20 2020 202f 2f61  acc = 0;.    //a
-00053ea0: 6363 202b 3d20 7431 202d 2074 303b 0a20  cc += t1 - t0;. 
-00053eb0: 2020 202f 2f69 6620 2874 3120 2d20 7430     //if (t1 - t0
-00053ec0: 203e 2031 3029 207b 0a20 2020 202f 2f20   > 10) {.    // 
-00053ed0: 2020 2070 7269 6e74 6628 225c 6e22 293b     printf("\n");
-00053ee0: 0a20 2020 202f 2f20 2020 2070 7269 6e74  .    //    print
-00053ef0: 6628 226e 6530 3020 3d20 2535 642c 206e  f("ne00 = %5d, n
-00053f00: 6530 3120 3d20 2535 642c 206e 6530 3220  e01 = %5d, ne02 
-00053f10: 3d20 2535 642c 206e 6530 3320 3d20 2535  = %5d, ne03 = %5
-00053f20: 645c 6e22 2c20 6e65 3030 2c20 6e65 3031  d\n", ne00, ne01
-00053f30: 2c20 6e65 3032 2c20 6e65 3033 293b 0a20  , ne02, ne03);. 
-00053f40: 2020 202f 2f20 2020 2070 7269 6e74 6628     //    printf(
-00053f50: 226e 6230 3020 3d20 2535 642c 206e 6230  "nb00 = %5d, nb0
-00053f60: 3120 3d20 2535 642c 206e 6230 3220 3d20  1 = %5d, nb02 = 
-00053f70: 2535 642c 206e 6230 3320 3d20 2535 645c  %5d, nb03 = %5d\
-00053f80: 6e22 2c20 6e62 3030 2c20 6e62 3031 2c20  n", nb00, nb01, 
-00053f90: 6e62 3032 2c20 6e62 3033 293b 0a20 2020  nb02, nb03);.   
-00053fa0: 202f 2f20 2020 2070 7269 6e74 6628 226e   //    printf("n
-00053fb0: 6531 3020 3d20 2535 642c 206e 6531 3120  e10 = %5d, ne11 
-00053fc0: 3d20 2535 642c 206e 6531 3220 3d20 2535  = %5d, ne12 = %5
-00053fd0: 642c 206e 6531 3320 3d20 2535 645c 6e22  d, ne13 = %5d\n"
-00053fe0: 2c20 6e65 3130 2c20 6e65 3131 2c20 6e65  , ne10, ne11, ne
-00053ff0: 3132 2c20 6e65 3133 293b 0a20 2020 202f  12, ne13);.    /
-00054000: 2f20 2020 2070 7269 6e74 6628 226e 6231  /    printf("nb1
-00054010: 3020 3d20 2535 642c 206e 6231 3120 3d20  0 = %5d, nb11 = 
-00054020: 2535 642c 206e 6231 3220 3d20 2535 642c  %5d, nb12 = %5d,
-00054030: 206e 6231 3320 3d20 2535 645c 6e22 2c20   nb13 = %5d\n", 
-00054040: 6e62 3130 2c20 6e62 3131 2c20 6e62 3132  nb10, nb11, nb12
-00054050: 2c20 6e62 3133 293b 0a0a 2020 2020 2f2f  , nb13);..    //
-00054060: 2020 2020 7072 696e 7466 2822 5858 5858      printf("XXXX
-00054070: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00054080: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00054090: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-000540a0: 2074 6173 6b20 2564 2f25 643a 2025 6420   task %d/%d: %d 
-000540b0: 7573 2c20 6163 6320 3d20 2564 5c6e 222c  us, acc = %d\n",
-000540c0: 2069 7468 2c20 6e74 682c 2028 696e 7429   ith, nth, (int)
-000540d0: 2028 7431 202d 2074 3029 2c20 2869 6e74   (t1 - t0), (int
-000540e0: 2920 6163 6329 3b0a 2020 2020 2f2f 7d0a  ) acc);.    //}.
-000540f0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00054100: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00054110: 6172 645f 6f75 745f 7072 6f64 280a 2020  ard_out_prod(.  
-00054120: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00054130: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00054140: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00054150: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00054160: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00054170: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00054180: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00054190: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-000541a0: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
-000541b0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000541c0: 6473 7429 207b 0a20 2020 2073 7769 7463  dst) {.    switc
-000541d0: 6820 2873 7263 302d 3e74 7970 6529 207b  h (src0->type) {
-000541e0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000541f0: 4d4c 5f54 5950 455f 5134 5f30 3a0a 2020  ML_TYPE_Q4_0:.  
-00054200: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00054210: 5459 5045 5f51 345f 313a 0a20 2020 2020  TYPE_Q4_1:.     
-00054220: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00054230: 455f 5135 5f30 3a0a 2020 2020 2020 2020  E_Q5_0:.        
-00054240: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00054250: 355f 313a 0a20 2020 2020 2020 2063 6173  5_1:.        cas
-00054260: 6520 4747 4d4c 5f54 5950 455f 5138 5f30  e GGML_TYPE_Q8_0
-00054270: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00054280: 474d 4c5f 5459 5045 5f51 385f 313a 0a20  GML_TYPE_Q8_1:. 
-00054290: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000542a0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-000542b0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-000542c0: 202f 2f20 746f 646f 0a20 2020 2020 2020   // todo.       
-000542d0: 2020 2020 2020 2020 202f 2f20 6767 6d6c           // ggml
-000542e0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000542f0: 5f6f 7574 5f70 726f 645f 715f 6633 3228  _out_prod_q_f32(
-00054300: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-00054310: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-00054320: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00054330: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00054340: 5f54 5950 455f 4631 363a 0a20 2020 2020  _TYPE_F16:.     
-00054350: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00054360: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00054370: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
-00054380: 746f 646f 0a20 2020 2020 2020 2020 2020  todo.           
-00054390: 2020 2020 202f 2f20 6767 6d6c 5f63 6f6d       // ggml_com
-000543a0: 7075 7465 5f66 6f72 7761 7264 5f6f 7574  pute_forward_out
-000543b0: 5f70 726f 645f 6631 365f 6633 3228 7061  _prod_f16_f32(pa
-000543c0: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
-000543d0: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-000543e0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-000543f0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00054400: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-00054410: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00054420: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00054430: 7574 655f 666f 7277 6172 645f 6f75 745f  ute_forward_out_
-00054440: 7072 6f64 5f66 3332 2870 6172 616d 732c  prod_f32(params,
-00054450: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
-00054460: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00054470: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00054480: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-00054490: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-000544a0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-000544b0: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-000544c0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-000544d0: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
-000544e0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000544f0: 5f73 6361 6c65 0a0a 7374 6174 6963 2076  _scale..static v
-00054500: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-00054510: 5f66 6f72 7761 7264 5f73 6361 6c65 5f66  _forward_scale_f
-00054520: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
-00054530: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00054540: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00054550: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00054560: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00054570: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00054580: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00054590: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000545a0: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-000545b0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000545c0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-000545d0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-000545e0: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
-000545f0: 7372 6330 2929 3b0a 2020 2020 4747 4d4c  src0));.    GGML
-00054600: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
-00054610: 636f 6e74 6967 756f 7573 2864 7374 2929  contiguous(dst))
-00054620: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00054630: 5428 6767 6d6c 5f61 7265 5f73 616d 655f  T(ggml_are_same_
-00054640: 7368 6170 6528 7372 6330 2c20 6473 7429  shape(src0, dst)
-00054650: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00054660: 5254 2867 676d 6c5f 6973 5f73 6361 6c61  RT(ggml_is_scala
-00054670: 7228 7372 6331 2929 3b0a 0a20 2020 2069  r(src1));..    i
-00054680: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-00054690: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-000546a0: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
-000546b0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-000546c0: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-000546d0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-000546e0: 0a0a 2020 2020 2f2f 2073 6361 6c65 2066  ..    // scale f
-000546f0: 6163 746f 720a 2020 2020 636f 6e73 7420  actor.    const 
-00054700: 666c 6f61 7420 7620 3d20 2a28 666c 6f61  float v = *(floa
-00054710: 7420 2a29 2073 7263 312d 3e64 6174 613b  t *) src1->data;
-00054720: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00054730: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
-00054740: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-00054750: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
-00054760: 7468 3b0a 0a20 2020 2063 6f6e 7374 2069  th;..    const i
-00054770: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
-00054780: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-00054790: 6e74 206e 7220 3d20 6767 6d6c 5f6e 726f  nt nr = ggml_nro
-000547a0: 7773 2873 7263 3029 3b0a 0a20 2020 202f  ws(src0);..    /
-000547b0: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-000547c0: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-000547d0: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-000547e0: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
-000547f0: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
-00054800: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
-00054810: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
-00054820: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
-00054830: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-00054840: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-00054850: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00054860: 6e62 3031 203d 2073 7263 302d 3e6e 625b  nb01 = src0->nb[
-00054870: 315d 3b0a 0a20 2020 2063 6f6e 7374 2073  1];..    const s
-00054880: 697a 655f 7420 6e62 3120 3d20 6473 742d  ize_t nb1 = dst-
-00054890: 3e6e 625b 315d 3b0a 0a0a 2020 2020 666f  >nb[1];...    fo
-000548a0: 7220 2869 6e74 2069 3120 3d20 6972 303b  r (int i1 = ir0;
-000548b0: 2069 3120 3c20 6972 313b 2069 312b 2b29   i1 < ir1; i1++)
-000548c0: 207b 0a20 2020 2020 2020 2069 6620 2864   {.        if (d
-000548d0: 7374 2d3e 6461 7461 2021 3d20 7372 6330  st->data != src0
-000548e0: 2d3e 6461 7461 2920 7b0a 2020 2020 2020  ->data) {.      
-000548f0: 2020 2020 2020 2f2f 2073 7263 3020 6973        // src0 is
-00054900: 2073 616d 6520 7368 6170 6520 6173 2064   same shape as d
-00054910: 7374 203d 3e20 7361 6d65 2069 6e64 6963  st => same indic
-00054920: 6573 0a20 2020 2020 2020 2020 2020 206d  es.            m
-00054930: 656d 6370 7928 2863 6861 7220 2a29 6473  emcpy((char *)ds
-00054940: 742d 3e64 6174 6120 2b20 6931 2a6e 6231  t->data + i1*nb1
-00054950: 2c20 2863 6861 7220 2a29 7372 6330 2d3e  , (char *)src0->
-00054960: 6461 7461 202b 2069 312a 6e62 3031 2c20  data + i1*nb01, 
-00054970: 6e63 202a 2073 697a 656f 6628 666c 6f61  nc * sizeof(floa
-00054980: 7429 293b 0a20 2020 2020 2020 207d 0a20  t));.        }. 
-00054990: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-000549a0: 7363 616c 655f 6633 3228 6e63 2c20 2866  scale_f32(nc, (f
-000549b0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-000549c0: 2920 6473 742d 3e64 6174 6120 2b20 6931  ) dst->data + i1
-000549d0: 2a6e 6231 292c 2076 293b 0a20 2020 207d  *nb1), v);.    }
-000549e0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-000549f0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00054a00: 7761 7264 5f73 6361 6c65 280a 2020 2020  ward_scale(.    
-00054a10: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00054a20: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00054a30: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00054a40: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00054a50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00054a60: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00054a70: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00054a80: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-00054a90: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00054aa0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00054ab0: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
-00054ac0: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
-00054ad0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00054ae0: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-00054af0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00054b00: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00054b10: 6d70 7574 655f 666f 7277 6172 645f 7363  mpute_forward_sc
-00054b20: 616c 655f 6633 3228 7061 7261 6d73 2c20  ale_f32(params, 
-00054b30: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
-00054b40: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00054b50: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
-00054b60: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-00054b70: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00054b80: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00054b90: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-00054ba0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00054bb0: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
-00054bc0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00054bd0: 7365 740a 0a73 7461 7469 6320 766f 6964  set..static void
-00054be0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00054bf0: 7277 6172 645f 7365 745f 6633 3228 0a20  rward_set_f32(. 
-00054c00: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00054c10: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00054c20: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-00054c30: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00054c40: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00054c50: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-00054c60: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00054c70: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00054c80: 6331 2c0a 2020 2020 2020 2020 636f 6e73  c1,.        cons
-00054c90: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00054ca0: 6e73 6f72 202a 206f 7074 302c 0a20 2020  nsor * opt0,.   
-00054cb0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00054cc0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00054cd0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00054ce0: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
-00054cf0: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
-00054d00: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00054d10: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-00054d20: 756f 7573 2864 7374 2920 2626 2067 676d  uous(dst) && ggm
-00054d30: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
-00054d40: 7372 6330 2929 3b0a 0a20 2020 2047 474d  src0));..    GGM
-00054d50: 4c5f 4153 5345 5254 286f 7074 302d 3e74  L_ASSERT(opt0->t
-00054d60: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00054d70: 5f49 3332 293b 0a20 2020 2047 474d 4c5f  _I32);.    GGML_
-00054d80: 4153 5345 5254 2867 676d 6c5f 6e65 6c65  ASSERT(ggml_nele
-00054d90: 6d65 6e74 7328 6f70 7430 2920 3d3d 2035  ments(opt0) == 5
-00054da0: 293b 0a0a 2020 2020 2f2f 2076 6965 7720  );..    // view 
-00054db0: 7372 6330 2061 6e64 2064 7374 2077 6974  src0 and dst wit
-00054dc0: 6820 7468 6573 6520 7374 7269 6465 7320  h these strides 
-00054dd0: 616e 6420 6461 7461 206f 6666 7365 7420  and data offset 
-00054de0: 696e 6279 7465 7320 6475 7269 6e67 2073  inbytes during s
-00054df0: 6574 0a20 2020 202f 2f20 6e62 3020 6973  et.    // nb0 is
-00054e00: 2069 6d70 6c69 6369 7465 6c79 2065 6c65   implicitely ele
-00054e10: 6d65 6e74 5f73 697a 6520 6265 6361 7573  ment_size becaus
-00054e20: 6520 7372 6330 2061 6e64 2064 7374 2061  e src0 and dst a
-00054e30: 7265 2063 6f6e 7469 6775 6f75 730a 2020  re contiguous.  
-00054e40: 2020 7369 7a65 5f74 206e 6231 2020 2020    size_t nb1    
-00054e50: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
-00054e60: 6f70 7430 2d3e 6461 7461 295b 305d 3b0a  opt0->data)[0];.
-00054e70: 2020 2020 7369 7a65 5f74 206e 6232 2020      size_t nb2  
-00054e80: 2020 203d 2028 2869 6e74 3332 5f74 202a     = ((int32_t *
-00054e90: 2920 6f70 7430 2d3e 6461 7461 295b 315d  ) opt0->data)[1]
-00054ea0: 3b0a 2020 2020 7369 7a65 5f74 206e 6233  ;.    size_t nb3
-00054eb0: 2020 2020 203d 2028 2869 6e74 3332 5f74       = ((int32_t
-00054ec0: 202a 2920 6f70 7430 2d3e 6461 7461 295b   *) opt0->data)[
-00054ed0: 325d 3b0a 2020 2020 7369 7a65 5f74 206f  2];.    size_t o
-00054ee0: 6666 7365 7420 203d 2028 2869 6e74 3332  ffset  = ((int32
-00054ef0: 5f74 202a 2920 6f70 7430 2d3e 6461 7461  _t *) opt0->data
-00054f00: 295b 335d 3b0a 2020 2020 626f 6f6c 2020  )[3];.    bool  
-00054f10: 2069 6e70 6c61 6365 203d 2028 626f 6f6c   inplace = (bool
-00054f20: 2920 2828 696e 7433 325f 7420 2a29 206f  ) ((int32_t *) o
-00054f30: 7074 302d 3e64 6174 6129 5b34 5d3b 0a0a  pt0->data)[4];..
-00054f40: 2020 2020 6966 2028 2169 6e70 6c61 6365      if (!inplace
-00054f50: 2026 2620 2870 6172 616d 732d 3e74 7970   && (params->typ
-00054f60: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-00054f70: 4e49 5429 2920 7b0a 2020 2020 2020 2020  NIT)) {.        
-00054f80: 2f2f 206d 656d 6370 7920 6e65 6564 7320  // memcpy needs 
-00054f90: 746f 2062 6520 7379 6e63 6872 6f6e 697a  to be synchroniz
-00054fa0: 6564 2061 6372 6f73 7320 7468 7265 6164  ed across thread
-00054fb0: 7320 746f 2061 766f 6964 2072 6163 6520  s to avoid race 
-00054fc0: 636f 6e64 6974 696f 6e73 2e0a 2020 2020  conditions..    
-00054fd0: 2020 2020 2f2f 203d 3e20 646f 2069 7420      // => do it 
-00054fe0: 696e 2049 4e49 5420 7068 6173 650a 2020  in INIT phase.  
-00054ff0: 2020 2020 2020 6d65 6d63 7079 280a 2020        memcpy(.  
-00055000: 2020 2020 2020 2020 2020 2828 6368 6172            ((char
-00055010: 202a 2920 2064 7374 2d3e 6461 7461 292c   *)  dst->data),
-00055020: 0a20 2020 2020 2020 2020 2020 2028 2863  .            ((c
-00055030: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-00055040: 6129 2c0a 2020 2020 2020 2020 2020 2020  a),.            
-00055050: 6767 6d6c 5f6e 6279 7465 7328 6473 7429  ggml_nbytes(dst)
-00055060: 293b 0a20 2020 207d 0a0a 2020 2020 6966  );.    }..    if
-00055070: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
-00055080: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
-00055090: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
-000550a0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-000550b0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-000550c0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-000550d0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-000550e0: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
-000550f0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00055100: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
-00055110: 683b 0a0a 2020 2020 636f 6e73 7420 696e  h;..    const in
-00055120: 7420 6e72 203d 2067 676d 6c5f 6e72 6f77  t nr = ggml_nrow
-00055130: 7328 7372 6331 293b 0a20 2020 2063 6f6e  s(src1);.    con
-00055140: 7374 2069 6e74 206e 6320 3d20 7372 6331  st int nc = src1
-00055150: 2d3e 6e65 5b30 5d3b 0a0a 2020 2020 636f  ->ne[0];..    co
-00055160: 6e73 7420 696e 7436 345f 7420 6e65 3130  nst int64_t ne10
-00055170: 203d 2073 7263 312d 3e6e 655b 305d 3b0a   = src1->ne[0];.
-00055180: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00055190: 7420 6e65 3131 203d 2073 7263 312d 3e6e  t ne11 = src1->n
-000551a0: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-000551b0: 696e 7436 345f 7420 6e65 3132 203d 2073  int64_t ne12 = s
-000551c0: 7263 312d 3e6e 655b 325d 3b0a 2020 2020  rc1->ne[2];.    
-000551d0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-000551e0: 3133 203d 2073 7263 312d 3e6e 655b 335d  13 = src1->ne[3]
-000551f0: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
-00055200: 655f 7420 6e62 3130 203d 2073 7263 312d  e_t nb10 = src1-
-00055210: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-00055220: 7420 7369 7a65 5f74 206e 6231 3120 3d20  t size_t nb11 = 
-00055230: 7372 6331 2d3e 6e62 5b31 5d3b 0a20 2020  src1->nb[1];.   
-00055240: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-00055250: 3132 203d 2073 7263 312d 3e6e 625b 325d  12 = src1->nb[2]
-00055260: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00055270: 5f74 206e 6231 3320 3d20 7372 6331 2d3e  _t nb13 = src1->
-00055280: 6e62 5b33 5d3b 0a0a 2020 2020 2f2f 2073  nb[3];..    // s
-00055290: 7263 3020 616e 6420 6473 7420 6173 2076  rc0 and dst as v
-000552a0: 6965 7765 6420 6475 7269 6e67 2073 6574  iewed during set
-000552b0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-000552c0: 7420 6e62 3020 3d20 6767 6d6c 5f65 6c65  t nb0 = ggml_ele
-000552d0: 6d65 6e74 5f73 697a 6528 7372 6330 293b  ment_size(src0);
-000552e0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-000552f0: 696d 3020 3d20 286e 6531 3020 3d3d 2030  im0 = (ne10 == 0
-00055300: 203f 2030 203a 206e 6531 302d 3129 3b0a   ? 0 : ne10-1);.
-00055310: 2020 2020 636f 6e73 7420 696e 7420 696d      const int im
-00055320: 3120 3d20 286e 6531 3120 3d3d 2030 203f  1 = (ne11 == 0 ?
-00055330: 2030 203a 206e 6531 312d 3129 3b0a 2020   0 : ne11-1);.  
-00055340: 2020 636f 6e73 7420 696e 7420 696d 3220    const int im2 
-00055350: 3d20 286e 6531 3220 3d3d 2030 203f 2030  = (ne12 == 0 ? 0
-00055360: 203a 206e 6531 322d 3129 3b0a 2020 2020   : ne12-1);.    
-00055370: 636f 6e73 7420 696e 7420 696d 3320 3d20  const int im3 = 
-00055380: 286e 6531 3320 3d3d 2030 203f 2030 203a  (ne13 == 0 ? 0 :
-00055390: 206e 6531 332d 3129 3b0a 0a20 2020 2047   ne13-1);..    G
-000553a0: 474d 4c5f 4153 5345 5254 286f 6666 7365  GML_ASSERT(offse
-000553b0: 7420 2b20 696d 302a 6e62 3020 202b 2069  t + im0*nb0  + i
-000553c0: 6d31 2a6e 6231 2020 2b20 696d 322a 6e62  m1*nb1  + im2*nb
-000553d0: 3220 202b 2069 6d33 2a6e 6233 2020 3c20  2  + im3*nb3  < 
-000553e0: 6767 6d6c 5f6e 6279 7465 7328 6473 7429  ggml_nbytes(dst)
-000553f0: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
-00055400: 4552 5428 6e62 3130 203d 3d20 7369 7a65  ERT(nb10 == size
-00055410: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-00055420: 202f 2f20 726f 7773 2070 6572 2074 6872   // rows per thr
-00055430: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
-00055440: 7420 6472 203d 2028 6e72 202b 206e 7468  t dr = (nr + nth
-00055450: 202d 2031 292f 6e74 683b 0a0a 2020 2020   - 1)/nth;..    
-00055460: 2f2f 2072 6f77 2072 616e 6765 2066 6f72  // row range for
-00055470: 2074 6869 7320 7468 7265 6164 0a20 2020   this thread.   
-00055480: 2063 6f6e 7374 2069 6e74 2069 7230 203d   const int ir0 =
-00055490: 2064 722a 6974 683b 0a20 2020 2063 6f6e   dr*ith;.    con
-000554a0: 7374 2069 6e74 2069 7231 203d 204d 494e  st int ir1 = MIN
-000554b0: 2869 7230 202b 2064 722c 206e 7229 3b0a  (ir0 + dr, nr);.
-000554c0: 0a20 2020 2066 6f72 2028 696e 7420 6972  .    for (int ir
-000554d0: 203d 2069 7230 3b20 6972 203c 2069 7231   = ir0; ir < ir1
-000554e0: 3b20 2b2b 6972 2920 7b0a 2020 2020 2020  ; ++ir) {.      
-000554f0: 2020 2f2f 2073 7263 3020 616e 6420 6473    // src0 and ds
-00055500: 7420 6172 6520 7669 6577 6564 2077 6974  t are viewed wit
-00055510: 6820 7368 6170 6520 6f66 2073 7263 3120  h shape of src1 
-00055520: 616e 6420 6f66 6673 6574 0a20 2020 2020  and offset.     
-00055530: 2020 202f 2f20 3d3e 2073 616d 6520 696e     // => same in
-00055540: 6469 6365 730a 2020 2020 2020 2020 636f  dices.        co
-00055550: 6e73 7420 696e 7420 6933 203d 2069 722f  nst int i3 = ir/
-00055560: 286e 6531 322a 6e65 3131 293b 0a20 2020  (ne12*ne11);.   
-00055570: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00055580: 3220 3d20 2869 7220 2d20 6933 2a6e 6531  2 = (ir - i3*ne1
-00055590: 322a 6e65 3131 292f 6e65 3131 3b0a 2020  2*ne11)/ne11;.  
-000555a0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-000555b0: 6931 203d 2028 6972 202d 2069 332a 6e65  i1 = (ir - i3*ne
-000555c0: 3132 2a6e 6531 3120 2d20 6932 2a6e 6531  12*ne11 - i2*ne1
-000555d0: 3129 3b0a 0a20 2020 2020 2020 2067 676d  1);..        ggm
-000555e0: 6c5f 7665 635f 6370 795f 6633 3228 6e63  l_vec_cpy_f32(nc
-000555f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00055600: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-00055610: 6172 202a 2920 2064 7374 2d3e 6461 7461  ar *)  dst->data
-00055620: 202b 2069 332a 6e62 3320 202b 2069 322a   + i3*nb3  + i2*
-00055630: 6e62 3220 202b 2069 312a 6e62 3120 202b  nb2  + i1*nb1  +
-00055640: 206f 6666 7365 7429 2c0a 2020 2020 2020   offset),.      
-00055650: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00055660: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
-00055670: 6331 2d3e 6461 7461 202b 2069 332a 6e62  c1->data + i3*nb
-00055680: 3133 202b 2069 322a 6e62 3132 202b 2069  13 + i2*nb12 + i
-00055690: 312a 6e62 3131 2929 3b0a 2020 2020 7d0a  1*nb11));.    }.
-000556a0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-000556b0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000556c0: 6172 645f 7365 7428 0a20 2020 2020 2020  ard_set(.       
-000556d0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-000556e0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-000556f0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00055700: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00055710: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00055720: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
-00055730: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00055740: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
-00055750: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00055760: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00055770: 206f 7074 302c 0a20 2020 2020 2020 2073   opt0,.        s
-00055780: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00055790: 7220 2a20 6473 7429 207b 0a0a 2020 2020  r * dst) {..    
-000557a0: 7377 6974 6368 2028 7372 6330 2d3e 7479  switch (src0->ty
-000557b0: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
-000557c0: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
-000557d0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000557e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000557f0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00055800: 7761 7264 5f73 6574 5f66 3332 2870 6172  ward_set_f32(par
-00055810: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
-00055820: 206f 7074 302c 2064 7374 293b 0a20 2020   opt0, dst);.   
-00055830: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00055840: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00055850: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-00055860: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00055870: 5459 5045 5f51 345f 303a 0a20 2020 2020  TYPE_Q4_0:.     
-00055880: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00055890: 455f 5134 5f31 3a0a 2020 2020 2020 2020  E_Q4_1:.        
-000558a0: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-000558b0: 355f 303a 0a20 2020 2020 2020 2063 6173  5_0:.        cas
-000558c0: 6520 4747 4d4c 5f54 5950 455f 5135 5f31  e GGML_TYPE_Q5_1
-000558d0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-000558e0: 474d 4c5f 5459 5045 5f51 385f 303a 0a20  GML_TYPE_Q8_0:. 
-000558f0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00055900: 5f54 5950 455f 5138 5f31 3a0a 2020 2020  _TYPE_Q8_1:.    
-00055910: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00055920: 5045 5f51 325f 4b3a 0a20 2020 2020 2020  PE_Q2_K:.       
-00055930: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00055940: 5133 5f4b 3a0a 2020 2020 2020 2020 6361  Q3_K:.        ca
-00055950: 7365 2047 474d 4c5f 5459 5045 5f51 345f  se GGML_TYPE_Q4_
-00055960: 4b3a 0a20 2020 2020 2020 2063 6173 6520  K:.        case 
-00055970: 4747 4d4c 5f54 5950 455f 5135 5f4b 3a0a  GGML_TYPE_Q5_K:.
-00055980: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00055990: 4c5f 5459 5045 5f51 365f 4b3a 0a20 2020  L_TYPE_Q6_K:.   
-000559a0: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
-000559b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000559c0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-000559d0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-000559e0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000559f0: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
-00055a00: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00055a10: 7277 6172 645f 6370 790a 0a73 7461 7469  rward_cpy..stati
-00055a20: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00055a30: 7574 655f 666f 7277 6172 645f 6370 7928  ute_forward_cpy(
-00055a40: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00055a50: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00055a60: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00055a70: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00055a80: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00055a90: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-00055aa0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00055ab0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00055ac0: 0a20 2020 2067 676d 6c5f 636f 6d70 7574  .    ggml_comput
-00055ad0: 655f 666f 7277 6172 645f 6475 7028 7061  e_forward_dup(pa
-00055ae0: 7261 6d73 2c20 7372 6330 2c20 6473 7429  rams, src0, dst)
-00055af0: 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  ;.}..// ggml_com
-00055b00: 7075 7465 5f66 6f72 7761 7264 5f63 6f6e  pute_forward_con
-00055b10: 740a 0a73 7461 7469 6320 766f 6964 2067  t..static void g
-00055b20: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00055b30: 6172 645f 636f 6e74 280a 2020 2020 2020  ard_cont(.      
-00055b40: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00055b50: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00055b60: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00055b70: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00055b80: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00055b90: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
-00055ba0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00055bb0: 202a 2064 7374 2920 7b0a 2020 2020 6767   * dst) {.    gg
-00055bc0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00055bd0: 7264 5f64 7570 2870 6172 616d 732c 2073  rd_dup(params, s
-00055be0: 7263 302c 2064 7374 293b 0a7d 0a0a 2f2f  rc0, dst);.}..//
-00055bf0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00055c00: 7277 6172 645f 7265 7368 6170 650a 0a73  rward_reshape..s
-00055c10: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00055c20: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00055c30: 7265 7368 6170 6528 0a20 2020 2020 2020  reshape(.       
-00055c40: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00055c50: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00055c60: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00055c70: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00055c80: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00055c90: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
-00055ca0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00055cb0: 2a20 6473 7429 207b 0a20 2020 202f 2f20  * dst) {.    // 
-00055cc0: 4e4f 500a 2020 2020 554e 5553 4544 2870  NOP.    UNUSED(p
-00055cd0: 6172 616d 7329 3b0a 2020 2020 554e 5553  arams);.    UNUS
-00055ce0: 4544 2873 7263 3029 3b0a 2020 2020 554e  ED(src0);.    UN
-00055cf0: 5553 4544 2864 7374 293b 0a7d 0a0a 2f2f  USED(dst);.}..//
-00055d00: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00055d10: 7277 6172 645f 7669 6577 0a0a 7374 6174  rward_view..stat
-00055d20: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00055d30: 7075 7465 5f66 6f72 7761 7264 5f76 6965  pute_forward_vie
-00055d40: 7728 0a20 2020 2020 2020 2063 6f6e 7374  w(.        const
-00055d50: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00055d60: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-00055d70: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-00055d80: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00055d90: 7465 6e73 6f72 202a 2073 7263 3029 207b  tensor * src0) {
-00055da0: 0a20 2020 202f 2f20 4e4f 500a 2020 2020  .    // NOP.    
-00055db0: 554e 5553 4544 2870 6172 616d 7329 3b0a  UNUSED(params);.
-00055dc0: 2020 2020 554e 5553 4544 2873 7263 3029      UNUSED(src0)
-00055dd0: 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  ;.}..// ggml_com
-00055de0: 7075 7465 5f66 6f72 7761 7264 5f70 6572  pute_forward_per
-00055df0: 6d75 7465 0a0a 7374 6174 6963 2076 6f69  mute..static voi
-00055e00: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00055e10: 6f72 7761 7264 5f70 6572 6d75 7465 280a  orward_permute(.
-00055e20: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00055e30: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00055e40: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00055e50: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00055e60: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00055e70: 736f 7220 2a20 7372 6330 2920 7b0a 2020  sor * src0) {.  
-00055e80: 2020 2f2f 204e 4f50 0a20 2020 2055 4e55    // NOP.    UNU
-00055e90: 5345 4428 7061 7261 6d73 293b 0a20 2020  SED(params);.   
-00055ea0: 2055 4e55 5345 4428 7372 6330 293b 0a7d   UNUSED(src0);.}
-00055eb0: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-00055ec0: 655f 666f 7277 6172 645f 7472 616e 7370  e_forward_transp
-00055ed0: 6f73 650a 0a73 7461 7469 6320 766f 6964  ose..static void
-00055ee0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00055ef0: 7277 6172 645f 7472 616e 7370 6f73 6528  rward_transpose(
-00055f00: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00055f10: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00055f20: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00055f30: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00055f40: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00055f50: 6e73 6f72 202a 2073 7263 3029 207b 0a20  nsor * src0) {. 
-00055f60: 2020 202f 2f20 4e4f 500a 2020 2020 554e     // NOP.    UN
-00055f70: 5553 4544 2870 6172 616d 7329 3b0a 2020  USED(params);.  
-00055f80: 2020 554e 5553 4544 2873 7263 3029 3b0a    UNUSED(src0);.
-00055f90: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-00055fa0: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
-00055fb0: 6f77 730a 0a73 7461 7469 6320 766f 6964  ows..static void
-00055fc0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00055fd0: 7277 6172 645f 6765 745f 726f 7773 5f71  rward_get_rows_q
-00055fe0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-00055ff0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00056000: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00056010: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-00056020: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00056030: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-00056040: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00056050: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00056060: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
-00056070: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00056080: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00056090: 0a20 2020 2061 7373 6572 7428 7061 7261  .    assert(para
-000560a0: 6d73 2d3e 6974 6820 3d3d 2030 293b 0a0a  ms->ith == 0);..
-000560b0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-000560c0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-000560d0: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-000560e0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-000560f0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-00056100: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00056110: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
-00056120: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
-00056130: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-00056140: 2069 6e74 206e 7220 3d20 6767 6d6c 5f6e   int nr = ggml_n
-00056150: 656c 656d 656e 7473 2873 7263 3129 3b0a  elements(src1);.
-00056160: 2020 2020 636f 6e73 7420 656e 756d 2067      const enum g
-00056170: 676d 6c5f 7479 7065 2074 7970 6520 3d20  gml_type type = 
-00056180: 7372 6330 2d3e 7479 7065 3b0a 2020 2020  src0->type;.    
+00051cf0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00051d00: 534b 5f49 4e49 5429 207b 0a20 2020 2020  SK_INIT) {.     
+00051d10: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+00051d20: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00051d30: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+00051d40: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00051d50: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+00051d60: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00051d70: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00051d80: 2020 2066 6c6f 6174 202a 2063 6f6e 7374     float * const
+00051d90: 2077 6461 7461 203d 2070 6172 616d 732d   wdata = params-
+00051da0: 3e77 6461 7461 3b0a 2020 2020 2020 2020  >wdata;.        
+00051db0: 6465 7175 616e 7469 7a65 5f72 6f77 5f71  dequantize_row_q
+00051dc0: 5f74 2063 6f6e 7374 2064 6571 7561 6e74  _t const dequant
+00051dd0: 697a 655f 726f 775f 7120 3d20 7175 616e  ize_row_q = quan
+00051de0: 7469 7a65 5f66 6e73 5b74 7970 655d 2e64  tize_fns[type].d
+00051df0: 6571 7561 6e74 697a 655f 726f 775f 713b  equantize_row_q;
+00051e00: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
+00051e10: 6e74 3634 5f74 2069 3033 203d 2030 3b20  nt64_t i03 = 0; 
+00051e20: 6930 3320 3c20 6e65 3033 3b20 6930 332b  i03 < ne03; i03+
+00051e30: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00051e40: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+00051e50: 3220 3d20 303b 2069 3032 203c 206e 6530  2 = 0; i02 < ne0
+00051e60: 323b 2069 3032 2b2b 2920 7b0a 2020 2020  2; i02++) {.    
+00051e70: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00051e80: 7420 666c 6f61 7420 2a20 7920 3d20 2866  t float * y = (f
+00051e90: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00051ea0: 2920 7372 6331 2d3e 6461 7461 202b 2069  ) src1->data + i
+00051eb0: 3032 2a6e 6231 3220 2b20 6930 332a 6e62  02*nb12 + i03*nb
+00051ec0: 3133 293b 0a0a 2020 2020 2020 2020 2020  13);..          
+00051ed0: 2020 2020 2020 666c 6f61 7420 2a20 6420        float * d 
+00051ee0: 3d20 2866 6c6f 6174 202a 2920 2828 6368  = (float *) ((ch
+00051ef0: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+00051f00: 2b20 6930 322a 6e62 3220 2b20 6930 332a  + i02*nb2 + i03*
+00051f10: 6e62 3329 3b0a 0a20 2020 2020 2020 2020  nb3);..         
+00051f20: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00051f30: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+00051f40: 655f 7420 6964 203d 2030 3b0a 2020 2020  e_t id = 0;.    
+00051f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051f60: 666f 7220 2869 6e74 3634 5f74 2069 3031  for (int64_t i01
+00051f70: 203d 2030 3b20 6930 3120 3c20 6e65 3031   = 0; i01 < ne01
+00051f80: 3b20 2b2b 6930 3129 207b 0a20 2020 2020  ; ++i01) {.     
+00051f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051fa0: 2020 2064 6571 7561 6e74 697a 655f 726f     dequantize_ro
+00051fb0: 775f 7128 2863 6861 7220 2a29 2073 7263  w_q((char *) src
+00051fc0: 302d 3e64 6174 6120 2b20 6930 332a 6e62  0->data + i03*nb
+00051fd0: 3033 202b 2069 3032 2a6e 6230 3220 2b20  03 + i02*nb02 + 
+00051fe0: 6930 312a 6e62 3031 2c20 7764 6174 6120  i01*nb01, wdata 
+00051ff0: 2b20 6964 2c20 6e65 3030 293b 0a20 2020  + id, ne00);.   
+00052000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052010: 2020 2020 2069 6420 2b3d 206e 6530 303b       id += ne00;
+00052020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00052030: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00052040: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00052050: 7274 2869 642a 7369 7a65 6f66 2866 6c6f  rt(id*sizeof(flo
+00052060: 6174 2920 3c3d 2070 6172 616d 732d 3e77  at) <= params->w
+00052070: 7369 7a65 293b 0a20 2020 2020 2020 2020  size);.         
+00052080: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00052090: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+000520a0: 666c 6f61 7420 2a20 7820 3d20 7764 6174  float * x = wdat
+000520b0: 613b 0a0a 2020 2020 2020 2020 2020 2020  a;..            
+000520c0: 2020 2020 6362 6c61 735f 7367 656d 6d28      cblas_sgemm(
+000520d0: 4362 6c61 7352 6f77 4d61 6a6f 722c 2043  CblasRowMajor, C
+000520e0: 626c 6173 4e6f 5472 616e 732c 2043 626c  blasNoTrans, Cbl
+000520f0: 6173 5472 616e 732c 0a20 2020 2020 2020  asTrans,.       
+00052100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052110: 206e 6531 312c 206e 6530 312c 206e 6531   ne11, ne01, ne1
+00052120: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00052130: 2020 2020 2020 2020 2020 2031 2e30 662c             1.0f,
+00052140: 2020 2020 792c 206e 6531 302c 0a20 2020      y, ne10,.   
+00052150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052160: 2020 2020 2020 2020 2020 2020 2020 782c                x,
+00052170: 206e 6530 302c 0a20 2020 2020 2020 2020   ne00,.         
+00052180: 2020 2020 2020 2020 2020 2020 2020 2030                 0
+00052190: 2e30 662c 2020 2020 642c 206e 6530 3129  .0f,    d, ne01)
+000521a0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+000521b0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000521c0: 2020 202f 2f70 7269 6e74 6628 2243 424c     //printf("CBL
+000521d0: 4153 203d 2025 6620 6d73 2c20 2564 2078  AS = %f ms, %d x
+000521e0: 2025 6420 7820 2564 2078 2025 645c 6e22   %d x %d x %d\n"
+000521f0: 2c20 2867 676d 6c5f 7065 7266 5f74 696d  , (ggml_perf_tim
+00052200: 655f 7573 2829 202d 2074 3029 2f31 3030  e_us() - t0)/100
+00052210: 302e 302c 206e 6530 2c20 6e65 312c 206e  0.0, ne0, ne1, n
+00052220: 6532 2c20 6e65 3329 3b0a 0a20 2020 2020  e2, ne3);..     
+00052230: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+00052240: 0a23 656e 6469 660a 0a20 2020 2069 6620  .#endif..    if 
+00052250: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00052260: 2047 474d 4c5f 5441 534b 5f49 4e49 5429   GGML_TASK_INIT)
+00052270: 207b 0a20 2020 2020 2020 2063 6861 7220   {.        char 
+00052280: 2a20 7764 6174 6120 3d20 7061 7261 6d73  * wdata = params
+00052290: 2d3e 7764 6174 613b 0a20 2020 2020 2020  ->wdata;.       
+000522a0: 2063 6f6e 7374 2073 697a 655f 7420 726f   const size_t ro
+000522b0: 775f 7369 7a65 203d 206e 6531 302a 4747  w_size = ne10*GG
+000522c0: 4d4c 5f54 5950 455f 5349 5a45 5b76 6563  ML_TYPE_SIZE[vec
+000522d0: 5f64 6f74 5f74 7970 655d 2f47 474d 4c5f  _dot_type]/GGML_
+000522e0: 424c 434b 5f53 495a 455b 7665 635f 646f  BLCK_SIZE[vec_do
+000522f0: 745f 7479 7065 5d3b 0a0a 2020 2020 2020  t_type];..      
+00052300: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+00052310: 3133 203d 2030 3b20 6931 3320 3c20 6e65  13 = 0; i13 < ne
+00052320: 3133 3b20 2b2b 6931 3329 207b 0a20 2020  13; ++i13) {.   
+00052330: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00052340: 7436 345f 7420 6931 3220 3d20 303b 2069  t64_t i12 = 0; i
+00052350: 3132 203c 206e 6531 323b 202b 2b69 3132  12 < ne12; ++i12
+00052360: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00052370: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00052380: 2069 3131 203d 2030 3b20 6931 3120 3c20   i11 = 0; i11 < 
+00052390: 6e65 3131 3b20 2b2b 6931 3129 207b 0a20  ne11; ++i11) {. 
+000523a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000523b0: 2020 2071 7561 6e74 697a 655f 726f 775f     quantize_row_
+000523c0: 715f 646f 7428 2866 6c6f 6174 202a 2928  q_dot((float *)(
+000523d0: 2863 6861 7220 2a29 2073 7263 312d 3e64  (char *) src1->d
+000523e0: 6174 6120 2b20 6931 332a 6e62 3133 202b  ata + i13*nb13 +
+000523f0: 2069 3132 2a6e 6231 3220 2b20 6931 312a   i12*nb12 + i11*
+00052400: 6e62 3131 292c 2028 766f 6964 202a 2920  nb11), (void *) 
+00052410: 7764 6174 612c 206e 6531 3029 3b0a 2020  wdata, ne10);.  
+00052420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052430: 2020 7764 6174 6120 2b3d 2072 6f77 5f73    wdata += row_s
+00052440: 697a 653b 0a20 2020 2020 2020 2020 2020  ize;.           
+00052450: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00052460: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
+00052470: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00052480: 2020 2020 7d0a 0a20 2020 2069 6620 2870      }..    if (p
+00052490: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+000524a0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
+000524b0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
+000524c0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
+000524d0: 2f2f 2070 6172 616c 6c65 6c69 7a65 2062  // parallelize b
+000524e0: 7920 7372 6330 2072 6f77 7320 7573 696e  y src0 rows usin
+000524f0: 6720 6767 6d6c 5f76 6563 5f64 6f74 5f71  g ggml_vec_dot_q
+00052500: 0a0a 2020 2020 2f2f 2074 6f74 616c 2072  ..    // total r
+00052510: 6f77 7320 696e 2073 7263 300a 2020 2020  ows in src0.    
+00052520: 636f 6e73 7420 696e 7420 6e72 203d 206e  const int nr = n
+00052530: 6530 312a 6e65 3032 2a6e 6530 333b 0a0a  e01*ne02*ne03;..
+00052540: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
+00052550: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
+00052560: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
+00052570: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
+00052580: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
+00052590: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
+000525a0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+000525b0: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
+000525c0: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
+000525d0: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
+000525e0: 293b 0a0a 2020 2020 766f 6964 202a 2077  );..    void * w
+000525f0: 6461 7461 203d 2070 6172 616d 732d 3e77  data = params->w
+00052600: 6461 7461 3b0a 2020 2020 636f 6e73 7420  data;.    const 
+00052610: 7369 7a65 5f74 2072 6f77 5f73 697a 6520  size_t row_size 
+00052620: 3d20 6e65 3030 2a47 474d 4c5f 5459 5045  = ne00*GGML_TYPE
+00052630: 5f53 495a 455b 7665 635f 646f 745f 7479  _SIZE[vec_dot_ty
+00052640: 7065 5d2f 4747 4d4c 5f42 4c43 4b5f 5349  pe]/GGML_BLCK_SI
+00052650: 5a45 5b76 6563 5f64 6f74 5f74 7970 655d  ZE[vec_dot_type]
+00052660: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+00052670: 6972 203d 2069 7230 3b20 6972 203c 2069  ir = ir0; ir < i
+00052680: 7231 3b20 2b2b 6972 2920 7b0a 2020 2020  r1; ++ir) {.    
+00052690: 2020 2020 2f2f 2073 7263 3020 696e 6469      // src0 indi
+000526a0: 6365 730a 2020 2020 2020 2020 636f 6e73  ces.        cons
+000526b0: 7420 696e 7420 6930 3320 3d20 6972 2f28  t int i03 = ir/(
+000526c0: 6e65 3032 2a6e 6530 3129 3b0a 2020 2020  ne02*ne01);.    
+000526d0: 2020 2020 636f 6e73 7420 696e 7420 6930      const int i0
+000526e0: 3220 3d20 2869 7220 2d20 6930 332a 6e65  2 = (ir - i03*ne
+000526f0: 3032 2a6e 6530 3129 2f6e 6530 313b 0a20  02*ne01)/ne01;. 
+00052700: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00052710: 2069 3031 203d 2028 6972 202d 2069 3033   i01 = (ir - i03
+00052720: 2a6e 6530 322a 6e65 3031 202d 2069 3032  *ne02*ne01 - i02
+00052730: 2a6e 6530 3129 3b0a 0a20 2020 2020 2020  *ne01);..       
+00052740: 2063 6f6e 7374 2069 6e74 2069 3133 203d   const int i13 =
+00052750: 2069 3033 3b0a 2020 2020 2020 2020 636f   i03;.        co
+00052760: 6e73 7420 696e 7420 6931 3220 3d20 6930  nst int i12 = i0
+00052770: 323b 0a0a 2020 2020 2020 2020 636f 6e73  2;..        cons
+00052780: 7420 696e 7420 6930 203d 2069 3031 3b0a  t int i0 = i01;.
+00052790: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+000527a0: 7420 6932 203d 2069 3032 3b0a 2020 2020  t i2 = i02;.    
+000527b0: 2020 2020 636f 6e73 7420 696e 7420 6933      const int i3
+000527c0: 203d 2069 3033 3b0a 0a20 2020 2020 2020   = i03;..       
+000527d0: 2076 6f69 6420 2a20 7372 6330 5f72 6f77   void * src0_row
+000527e0: 203d 2028 766f 6964 202a 2920 2828 6368   = (void *) ((ch
+000527f0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+00052800: 202b 2028 6930 312a 6e62 3031 202b 2069   + (i01*nb01 + i
+00052810: 3032 2a6e 6230 3220 2b20 6930 332a 6e62  02*nb02 + i03*nb
+00052820: 3033 2929 3b0a 2020 2020 2020 2020 6368  03));.        ch
+00052830: 6172 202a 2073 7263 315f 636f 6c20 3d20  ar * src1_col = 
+00052840: 2020 2020 2020 2020 2028 2863 6861 7220           ((char 
+00052850: 2a29 2020 2020 2020 7764 6174 6120 2b20  *)      wdata + 
+00052860: 2820 2020 2020 2028 3020 2b20 6931 322a  (      (0 + i12*
+00052870: 6e65 3131 202b 2069 3133 2a6e 6531 322a  ne11 + i13*ne12*
+00052880: 6e65 3131 292a 726f 775f 7369 7a65 2929  ne11)*row_size))
+00052890: 3b0a 0a20 2020 2020 2020 2066 6c6f 6174  ;..        float
+000528a0: 202a 2064 7374 5f63 6f6c 203d 2028 666c   * dst_col = (fl
+000528b0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+000528c0: 2064 7374 2d3e 6461 7461 202b 2028 6930   dst->data + (i0
+000528d0: 2a6e 6230 202b 2030 2a6e 6231 202b 2069  *nb0 + 0*nb1 + i
+000528e0: 322a 6e62 3220 2b20 6933 2a6e 6233 2929  2*nb2 + i3*nb3))
+000528f0: 3b0a 0a20 2020 2020 2020 2061 7373 6572  ;..        asser
+00052900: 7428 6e65 3030 2025 2033 3220 3d3d 2030  t(ne00 % 32 == 0
+00052910: 293b 0a0a 2020 2020 2020 2020 666f 7220  );..        for 
+00052920: 2869 6e74 3634 5f74 2069 6320 3d20 303b  (int64_t ic = 0;
+00052930: 2069 6320 3c20 6e65 3131 3b20 2b2b 6963   ic < ne11; ++ic
+00052940: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00052950: 7665 635f 646f 745f 7128 6e65 3030 2c20  vec_dot_q(ne00, 
+00052960: 2664 7374 5f63 6f6c 5b69 632a 6e65 305d  &dst_col[ic*ne0]
+00052970: 2c20 7372 6330 5f72 6f77 2c20 2876 6f69  , src0_row, (voi
+00052980: 6420 2a29 2028 7372 6331 5f63 6f6c 202b  d *) (src1_col +
+00052990: 2069 632a 726f 775f 7369 7a65 2929 3b0a   ic*row_size));.
+000529a0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+000529b0: 0a20 2020 202f 2f69 6e74 3634 5f74 2074  .    //int64_t t
+000529c0: 3120 3d20 6767 6d6c 5f74 696d 655f 7573  1 = ggml_time_us
+000529d0: 2829 3b0a 2020 2020 2f2f 7374 6174 6963  ();.    //static
+000529e0: 2069 6e74 3634 5f74 2061 6363 203d 2030   int64_t acc = 0
+000529f0: 3b0a 2020 2020 2f2f 6163 6320 2b3d 2074  ;.    //acc += t
+00052a00: 3120 2d20 7430 3b0a 2020 2020 2f2f 6966  1 - t0;.    //if
+00052a10: 2028 7431 202d 2074 3020 3e20 3130 2920   (t1 - t0 > 10) 
+00052a20: 7b0a 2020 2020 2f2f 2020 2020 7072 696e  {.    //    prin
+00052a30: 7466 2822 5c6e 2229 3b0a 2020 2020 2f2f  tf("\n");.    //
+00052a40: 2020 2020 7072 696e 7466 2822 6e65 3030      printf("ne00
+00052a50: 203d 2025 3564 2c20 6e65 3031 203d 2025   = %5d, ne01 = %
+00052a60: 3564 2c20 6e65 3032 203d 2025 3564 2c20  5d, ne02 = %5d, 
+00052a70: 6e65 3033 203d 2025 3564 5c6e 222c 206e  ne03 = %5d\n", n
+00052a80: 6530 302c 206e 6530 312c 206e 6530 322c  e00, ne01, ne02,
+00052a90: 206e 6530 3329 3b0a 2020 2020 2f2f 2020   ne03);.    //  
+00052aa0: 2020 7072 696e 7466 2822 6e62 3030 203d    printf("nb00 =
+00052ab0: 2025 3564 2c20 6e62 3031 203d 2025 3564   %5d, nb01 = %5d
+00052ac0: 2c20 6e62 3032 203d 2025 3564 2c20 6e62  , nb02 = %5d, nb
+00052ad0: 3033 203d 2025 3564 5c6e 222c 206e 6230  03 = %5d\n", nb0
+00052ae0: 302c 206e 6230 312c 206e 6230 322c 206e  0, nb01, nb02, n
+00052af0: 6230 3329 3b0a 2020 2020 2f2f 2020 2020  b03);.    //    
+00052b00: 7072 696e 7466 2822 6e65 3130 203d 2025  printf("ne10 = %
+00052b10: 3564 2c20 6e65 3131 203d 2025 3564 2c20  5d, ne11 = %5d, 
+00052b20: 6e65 3132 203d 2025 3564 2c20 6e65 3133  ne12 = %5d, ne13
+00052b30: 203d 2025 3564 5c6e 222c 206e 6531 302c   = %5d\n", ne10,
+00052b40: 206e 6531 312c 206e 6531 322c 206e 6531   ne11, ne12, ne1
+00052b50: 3329 3b0a 0a20 2020 202f 2f20 2020 2070  3);..    //    p
+00052b60: 7269 6e74 6628 2258 5858 5858 5858 5858  rintf("XXXXXXXXX
+00052b70: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00052b80: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00052b90: 5858 5858 5858 5858 5858 5820 7461 736b  XXXXXXXXXXX task
+00052ba0: 2025 642f 2564 3a20 2564 2075 732c 2061   %d/%d: %d us, a
+00052bb0: 6363 203d 2025 645c 6e22 2c20 6974 682c  cc = %d\n", ith,
+00052bc0: 206e 7468 2c20 2869 6e74 2920 2874 3120   nth, (int) (t1 
+00052bd0: 2d20 7430 292c 2028 696e 7429 2061 6363  - t0), (int) acc
+00052be0: 293b 0a20 2020 202f 2f7d 0a7d 0a0a 7374  );.    //}.}..st
+00052bf0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00052c00: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
+00052c10: 756c 5f6d 6174 280a 2020 2020 2020 2020  ul_mat(.        
+00052c20: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00052c30: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+00052c40: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+00052c50: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00052c60: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00052c70: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
+00052c80: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00052c90: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
+00052ca0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00052cb0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+00052cc0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
+00052cd0: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+00052ce0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00052cf0: 455f 5134 5f30 3a0a 2020 2020 2020 2020  E_Q4_0:.        
+00052d00: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+00052d10: 345f 313a 0a20 2020 2020 2020 2063 6173  4_1:.        cas
+00052d20: 6520 4747 4d4c 5f54 5950 455f 5135 5f30  e GGML_TYPE_Q5_0
+00052d30: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+00052d40: 474d 4c5f 5459 5045 5f51 355f 313a 0a20  GML_TYPE_Q5_1:. 
+00052d50: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00052d60: 5f54 5950 455f 5138 5f30 3a0a 2020 2020  _TYPE_Q8_0:.    
+00052d70: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00052d80: 5045 5f51 385f 313a 0a20 2020 2020 2020  PE_Q8_1:.       
+00052d90: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00052da0: 5132 5f4b 3a0a 2020 2020 2020 2020 6361  Q2_K:.        ca
+00052db0: 7365 2047 474d 4c5f 5459 5045 5f51 335f  se GGML_TYPE_Q3_
+00052dc0: 4b3a 0a20 2020 2020 2020 2063 6173 6520  K:.        case 
+00052dd0: 4747 4d4c 5f54 5950 455f 5134 5f4b 3a0a  GGML_TYPE_Q4_K:.
+00052de0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00052df0: 4c5f 5459 5045 5f51 355f 4b3a 0a20 2020  L_TYPE_Q5_K:.   
+00052e00: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00052e10: 5950 455f 5136 5f4b 3a0a 2020 2020 2020  YPE_Q6_K:.      
+00052e20: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00052e30: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00052e40: 7075 7465 5f66 6f72 7761 7264 5f6d 756c  pute_forward_mul
+00052e50: 5f6d 6174 5f71 5f66 3332 2870 6172 616d  _mat_q_f32(param
+00052e60: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
+00052e70: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
+00052e80: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00052e90: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00052ea0: 5f46 3136 3a0a 2020 2020 2020 2020 2020  _F16:.          
+00052eb0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00052ec0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00052ed0: 5f66 6f72 7761 7264 5f6d 756c 5f6d 6174  _forward_mul_mat
+00052ee0: 5f66 3136 5f66 3332 2870 6172 616d 732c  _f16_f32(params,
+00052ef0: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
+00052f00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00052f10: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00052f20: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+00052f30: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
+00052f40: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00052f50: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00052f60: 6f72 7761 7264 5f6d 756c 5f6d 6174 5f66  orward_mul_mat_f
+00052f70: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
+00052f80: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
+00052f90: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00052fa0: 3b0a 2020 2020 2020 2020 6465 6661 756c  ;.        defaul
+00052fb0: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
+00052fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00052fd0: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+00052fe0: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
+00052ff0: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
+00053000: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00053010: 7465 5f66 6f72 7761 7264 5f6f 7574 5f70  te_forward_out_p
+00053020: 726f 640a 0a0a 7374 6174 6963 2076 6f69  rod...static voi
+00053030: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00053040: 6f72 7761 7264 5f6f 7574 5f70 726f 645f  orward_out_prod_
+00053050: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
+00053060: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00053070: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00053080: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00053090: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000530a0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+000530b0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000530c0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000530d0: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+000530e0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+000530f0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00053100: 2920 7b0a 2020 2020 696e 7436 345f 7420  ) {.    int64_t 
+00053110: 7430 203d 2067 676d 6c5f 7065 7266 5f74  t0 = ggml_perf_t
+00053120: 696d 655f 7573 2829 3b0a 2020 2020 554e  ime_us();.    UN
+00053130: 5553 4544 2874 3029 3b0a 0a20 2020 2063  USED(t0);..    c
+00053140: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+00053150: 3020 3d20 7372 6330 2d3e 6e65 5b30 5d3b  0 = src0->ne[0];
+00053160: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00053170: 5f74 206e 6530 3120 3d20 7372 6330 2d3e  _t ne01 = src0->
+00053180: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
+00053190: 2069 6e74 3634 5f74 206e 6530 3220 3d20   int64_t ne02 = 
+000531a0: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
+000531b0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+000531c0: 6530 3320 3d20 7372 6330 2d3e 6e65 5b33  e03 = src0->ne[3
+000531d0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+000531e0: 7436 345f 7420 6e65 3130 203d 2073 7263  t64_t ne10 = src
+000531f0: 312d 3e6e 655b 305d 3b0a 2020 2020 2f2f  1->ne[0];.    //
+00053200: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00053210: 3131 203d 2073 7263 312d 3e6e 655b 315d  11 = src1->ne[1]
+00053220: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+00053230: 345f 7420 6e65 3132 203d 2073 7263 312d  4_t ne12 = src1-
+00053240: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
+00053250: 7420 696e 7436 345f 7420 6e65 3133 203d  t int64_t ne13 =
+00053260: 2073 7263 312d 3e6e 655b 335d 3b0a 0a20   src1->ne[3];.. 
+00053270: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00053280: 206e 6530 2020 3d20 6473 742d 3e6e 655b   ne0  = dst->ne[
+00053290: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+000532a0: 7436 345f 7420 6e65 3120 203d 2064 7374  t64_t ne1  = dst
+000532b0: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
+000532c0: 7374 2069 6e74 3634 5f74 206e 6532 2020  st int64_t ne2  
+000532d0: 3d20 6473 742d 3e6e 655b 325d 3b0a 2020  = dst->ne[2];.  
+000532e0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+000532f0: 6e65 3320 203d 2064 7374 2d3e 6e65 5b33  ne3  = dst->ne[3
+00053300: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00053310: 7420 6e62 3030 203d 2073 7263 302d 3e6e  t nb00 = src0->n
+00053320: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+00053330: 696e 7420 6e62 3031 203d 2073 7263 302d  int nb01 = src0-
+00053340: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00053350: 7420 696e 7420 6e62 3032 203d 2073 7263  t int nb02 = src
+00053360: 302d 3e6e 625b 325d 3b0a 2020 2020 636f  0->nb[2];.    co
+00053370: 6e73 7420 696e 7420 6e62 3033 203d 2073  nst int nb03 = s
+00053380: 7263 302d 3e6e 625b 335d 3b0a 0a20 2020  rc0->nb[3];..   
+00053390: 2063 6f6e 7374 2069 6e74 206e 6231 3020   const int nb10 
+000533a0: 3d20 7372 6331 2d3e 6e62 5b30 5d3b 0a20  = src1->nb[0];. 
+000533b0: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
+000533c0: 3120 3d20 7372 6331 2d3e 6e62 5b31 5d3b  1 = src1->nb[1];
+000533d0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000533e0: 6231 3220 3d20 7372 6331 2d3e 6e62 5b32  b12 = src1->nb[2
+000533f0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00053400: 206e 6231 3320 3d20 7372 6331 2d3e 6e62   nb13 = src1->nb
+00053410: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+00053420: 696e 7420 6e62 3020 203d 2064 7374 2d3e  int nb0  = dst->
+00053430: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+00053440: 2069 6e74 206e 6231 2020 3d20 6473 742d   int nb1  = dst-
+00053450: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00053460: 7420 696e 7420 6e62 3220 203d 2064 7374  t int nb2  = dst
+00053470: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
+00053480: 7374 2069 6e74 206e 6233 2020 3d20 6473  st int nb3  = ds
+00053490: 742d 3e6e 625b 335d 3b0a 0a20 2020 2063  t->nb[3];..    c
+000534a0: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
+000534b0: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
+000534c0: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
+000534d0: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
+000534e0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+000534f0: 3032 203d 3d20 6e65 3132 293b 0a20 2020  02 == ne12);.   
+00053500: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
+00053510: 3320 3d3d 206e 6531 3329 3b0a 2020 2020  3 == ne13);.    
+00053520: 4747 4d4c 5f41 5353 4552 5428 6e65 3220  GGML_ASSERT(ne2 
+00053530: 203d 3d20 6e65 3132 293b 0a20 2020 2047   == ne12);.    G
+00053540: 474d 4c5f 4153 5345 5254 286e 6533 2020  GML_ASSERT(ne3  
+00053550: 3d3d 206e 6531 3329 3b0a 0a20 2020 202f  == ne13);..    /
+00053560: 2f20 7765 2064 6f6e 2774 2073 7570 706f  / we don't suppo
+00053570: 7274 2070 6572 6d75 7465 6420 7372 6330  rt permuted src0
+00053580: 206f 7220 7372 6331 0a20 2020 2047 474d   or src1.    GGM
+00053590: 4c5f 4153 5345 5254 286e 6230 3020 3d3d  L_ASSERT(nb00 ==
+000535a0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+000535b0: 0a0a 2020 2020 2f2f 2064 7374 2063 616e  ..    // dst can
+000535c0: 6e6f 7420 6265 2074 7261 6e73 706f 7365  not be transpose
+000535d0: 6420 6f72 2070 6572 6d75 7465 640a 2020  d or permuted.  
+000535e0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+000535f0: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
+00053600: 7429 293b 0a20 2020 202f 2f20 4747 4d4c  t));.    // GGML
+00053610: 5f41 5353 4552 5428 6e62 3020 3c3d 206e  _ASSERT(nb0 <= n
+00053620: 6231 293b 0a20 2020 202f 2f20 4747 4d4c  b1);.    // GGML
+00053630: 5f41 5353 4552 5428 6e62 3120 3c3d 206e  _ASSERT(nb1 <= n
+00053640: 6232 293b 0a20 2020 202f 2f20 4747 4d4c  b2);.    // GGML
+00053650: 5f41 5353 4552 5428 6e62 3220 3c3d 206e  _ASSERT(nb2 <= n
+00053660: 6233 293b 0a0a 2020 2020 4747 4d4c 5f41  b3);..    GGML_A
+00053670: 5353 4552 5428 6e65 3020 3d3d 206e 6530  SSERT(ne0 == ne0
+00053680: 3029 3b0a 2020 2020 4747 4d4c 5f41 5353  0);.    GGML_ASS
+00053690: 4552 5428 6e65 3120 3d3d 206e 6531 3029  ERT(ne1 == ne10)
+000536a0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+000536b0: 5428 6e65 3220 3d3d 206e 6530 3229 3b0a  T(ne2 == ne02);.
+000536c0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000536d0: 6e65 3320 3d3d 206e 6530 3329 3b0a 0a20  ne3 == ne03);.. 
+000536e0: 2020 202f 2f20 6e62 3031 203e 3d20 6e62     // nb01 >= nb
+000536f0: 3030 202d 2073 7263 3020 6973 206e 6f74  00 - src0 is not
+00053700: 2074 7261 6e73 706f 7365 640a 2020 2020   transposed.    
+00053710: 2f2f 2020 2063 6f6d 7075 7465 2062 7920  //   compute by 
+00053720: 7372 6330 2072 6f77 730a 0a20 2020 202f  src0 rows..    /
+00053730: 2f20 544f 444f 3a20 2369 6620 6465 6669  / TODO: #if defi
+00053740: 6e65 6428 4747 4d4c 5f55 5345 5f43 5542  ned(GGML_USE_CUB
+00053750: 4c41 5329 2067 676d 6c5f 6375 6461 5f6f  LAS) ggml_cuda_o
+00053760: 7574 5f70 726f 640a 2020 2020 2f2f 2054  ut_prod.    // T
+00053770: 4f44 4f3a 2023 6966 2064 6566 696e 6564  ODO: #if defined
+00053780: 2847 474d 4c5f 5553 455f 4143 4345 4c45  (GGML_USE_ACCELE
+00053790: 5241 5445 2920 7c7c 2064 6566 696e 6564  RATE) || defined
+000537a0: 2847 474d 4c5f 5553 455f 4f50 454e 424c  (GGML_USE_OPENBL
+000537b0: 4153 2920 7c7c 2064 6566 696e 6564 2847  AS) || defined(G
+000537c0: 474d 4c5f 5553 455f 434c 424c 4153 5429  GML_USE_CLBLAST)
+000537d0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+000537e0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+000537f0: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
+00053800: 2020 2020 6767 6d6c 5f76 6563 5f73 6574      ggml_vec_set
+00053810: 5f66 3332 286e 6530 2a6e 6531 2a6e 6532  _f32(ne0*ne1*ne2
+00053820: 2a6e 6533 2c20 6473 742d 3e64 6174 612c  *ne3, dst->data,
+00053830: 2030 293b 0a20 2020 2020 2020 2072 6574   0);.        ret
+00053840: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
+00053850: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+00053860: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00053870: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00053880: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00053890: 0a20 2020 202f 2f20 7061 7261 6c6c 656c  .    // parallel
+000538a0: 697a 6520 6279 206c 6173 7420 7468 7265  ize by last thre
+000538b0: 6520 6469 6d65 6e73 696f 6e73 0a0a 2020  e dimensions..  
+000538c0: 2020 2f2f 2074 6f74 616c 2072 6f77 7320    // total rows 
+000538d0: 696e 2064 7374 0a20 2020 2063 6f6e 7374  in dst.    const
+000538e0: 2069 6e74 3634 5f74 206e 7220 3d20 6e65   int64_t nr = ne
+000538f0: 312a 6e65 322a 6e65 333b 0a0a 2020 2020  1*ne2*ne3;..    
+00053900: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
+00053910: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+00053920: 3634 5f74 2064 7220 3d20 286e 7220 2b20  64_t dr = (nr + 
+00053930: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
+00053940: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
+00053950: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
+00053960: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00053970: 7420 6972 3020 3d20 6472 2a69 7468 3b0a  t ir0 = dr*ith;.
+00053980: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00053990: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
+000539a0: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
+000539b0: 2f2f 2064 7374 5b3a 2c3a 2c3a 2c3a 5d20  // dst[:,:,:,:] 
+000539c0: 3d20 300a 2020 2020 2f2f 2066 6f72 2069  = 0.    // for i
+000539d0: 322c 6933 3a0a 2020 2020 2f2f 2020 2066  2,i3:.    //   f
+000539e0: 6f72 2069 313a 0a20 2020 202f 2f20 2020  or i1:.    //   
+000539f0: 2020 666f 7220 6930 313a 0a20 2020 202f    for i01:.    /
+00053a00: 2f20 2020 2020 2020 666f 7220 6930 3a0a  /       for i0:.
+00053a10: 2020 2020 2f2f 2020 2020 2020 2020 2064      //         d
+00053a20: 7374 5b69 302c 6931 2c69 322c 6933 5d20  st[i0,i1,i2,i3] 
+00053a30: 2b3d 2073 7263 305b 6930 2c69 3031 2c69  += src0[i0,i01,i
+00053a40: 322c 6933 5d20 2a20 7372 6331 5b69 312c  2,i3] * src1[i1,
+00053a50: 6930 312c 6932 2c69 335d 0a0a 2020 2020  i01,i2,i3]..    
+00053a60: 666f 7220 2869 6e74 3634 5f74 2069 7220  for (int64_t ir 
+00053a70: 3d20 6972 303b 2069 7220 3c20 6972 313b  = ir0; ir < ir1;
+00053a80: 202b 2b69 7229 207b 0a20 2020 2020 2020   ++ir) {.       
+00053a90: 202f 2f20 6473 7420 696e 6469 6365 730a   // dst indices.
+00053aa0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00053ab0: 7436 345f 7420 6933 203d 2069 722f 286e  t64_t i3 = ir/(n
+00053ac0: 6532 2a6e 6531 293b 0a20 2020 2020 2020  e2*ne1);.       
+00053ad0: 2063 6f6e 7374 2069 6e74 3634 5f74 2069   const int64_t i
+00053ae0: 3220 3d20 2869 7220 2d20 6933 2a6e 6532  2 = (ir - i3*ne2
+00053af0: 2a6e 6531 292f 6e65 313b 0a20 2020 2020  *ne1)/ne1;.     
+00053b00: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00053b10: 2069 3120 3d20 2869 7220 2d20 6933 2a6e   i1 = (ir - i3*n
+00053b20: 6532 2a6e 6531 202d 2069 322a 6e65 3129  e2*ne1 - i2*ne1)
+00053b30: 3b0a 0a20 2020 2020 2020 2063 6f6e 7374  ;..        const
+00053b40: 2069 6e74 3634 5f74 2069 3032 203d 2069   int64_t i02 = i
+00053b50: 323b 0a20 2020 2020 2020 2063 6f6e 7374  2;.        const
+00053b60: 2069 6e74 3634 5f74 2069 3033 203d 2069   int64_t i03 = i
+00053b70: 333b 0a0a 2020 2020 2020 2020 2f2f 636f  3;..        //co
+00053b80: 6e73 7420 696e 7436 345f 7420 6931 3020  nst int64_t i10 
+00053b90: 3d20 6931 3b0a 2020 2020 2020 2020 636f  = i1;.        co
+00053ba0: 6e73 7420 696e 7436 345f 7420 6931 3220  nst int64_t i12 
+00053bb0: 3d20 6932 3b0a 2020 2020 2020 2020 636f  = i2;.        co
+00053bc0: 6e73 7420 696e 7436 345f 7420 6931 3320  nst int64_t i13 
+00053bd0: 3d20 6933 3b0a 0a20 2020 2020 2020 2066  = i3;..        f
+00053be0: 6f72 2028 696e 7436 345f 7420 6930 3120  or (int64_t i01 
+00053bf0: 3d20 303b 2069 3031 203c 206e 6530 313b  = 0; i01 < ne01;
+00053c00: 202b 2b69 3031 2920 7b0a 2020 2020 2020   ++i01) {.      
+00053c10: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00053c20: 345f 7420 6931 3120 3d20 6930 313b 0a0a  4_t i11 = i01;..
+00053c30: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+00053c40: 7420 2a20 7330 203d 2028 666c 6f61 7420  t * s0 = (float 
+00053c50: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+00053c60: 302d 3e64 6174 6120 2b20 2820 2020 2020  0->data + (     
+00053c70: 2020 2020 2069 3031 2a6e 6230 3120 2b20       i01*nb01 + 
+00053c80: 6930 322a 6e62 3032 202b 2069 3033 2a6e  i02*nb02 + i03*n
+00053c90: 6230 3329 293b 0a20 2020 2020 2020 2020  b03));.         
+00053ca0: 2020 2066 6c6f 6174 202a 2073 3120 3d20     float * s1 = 
+00053cb0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+00053cc0: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
+00053cd0: 2028 6931 2a6e 6231 3020 2b20 6931 312a   (i1*nb10 + i11*
+00053ce0: 6e62 3131 202b 2069 3132 2a6e 6231 3220  nb11 + i12*nb12 
+00053cf0: 2b20 6931 332a 6e62 3133 2929 3b0a 2020  + i13*nb13));.  
+00053d00: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00053d10: 2a20 6420 203d 2028 666c 6f61 7420 2a29  * d  = (float *)
+00053d20: 2028 2863 6861 7220 2a29 2020 6473 742d   ((char *)  dst-
+00053d30: 3e64 6174 6120 2b20 2820 2020 2020 2020  >data + (       
+00053d40: 2020 2069 312a 6e62 3120 2b20 6932 2a6e     i1*nb1 + i2*n
+00053d50: 6232 202b 2069 332a 6e62 3329 293b 0a0a  b2 + i3*nb3));..
+00053d60: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00053d70: 5f76 6563 5f6d 6164 5f66 3332 286e 6530  _vec_mad_f32(ne0
+00053d80: 2c20 642c 2073 302c 202a 7331 293b 0a20  , d, s0, *s1);. 
+00053d90: 2020 2020 2020 2020 2020 202f 2f20 666f             // fo
+00053da0: 7220 2869 6e74 3634 5f74 2069 3020 3d20  r (int64_t i0 = 
+00053db0: 303b 2069 3020 3c20 6e65 303b 202b 2b69  0; i0 < ne0; ++i
+00053dc0: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+00053dd0: 202f 2f20 2020 2020 645b 6930 5d20 2b3d   //     d[i0] +=
+00053de0: 2073 305b 6930 5d20 2a20 7331 5b69 315d   s0[i0] * s1[i1]
+00053df0: 3b0a 2020 2020 2020 2020 2020 2020 2f2f  ;.            //
+00053e00: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
+00053e10: 207d 0a0a 2020 2020 2f2f 696e 7436 345f   }..    //int64_
+00053e20: 7420 7431 203d 2067 676d 6c5f 7065 7266  t t1 = ggml_perf
+00053e30: 5f74 696d 655f 7573 2829 3b0a 2020 2020  _time_us();.    
+00053e40: 2f2f 7374 6174 6963 2069 6e74 3634 5f74  //static int64_t
+00053e50: 2061 6363 203d 2030 3b0a 2020 2020 2f2f   acc = 0;.    //
+00053e60: 6163 6320 2b3d 2074 3120 2d20 7430 3b0a  acc += t1 - t0;.
+00053e70: 2020 2020 2f2f 6966 2028 7431 202d 2074      //if (t1 - t
+00053e80: 3020 3e20 3130 2920 7b0a 2020 2020 2f2f  0 > 10) {.    //
+00053e90: 2020 2020 7072 696e 7466 2822 5c6e 2229      printf("\n")
+00053ea0: 3b0a 2020 2020 2f2f 2020 2020 7072 696e  ;.    //    prin
+00053eb0: 7466 2822 6e65 3030 203d 2025 3564 2c20  tf("ne00 = %5d, 
+00053ec0: 6e65 3031 203d 2025 3564 2c20 6e65 3032  ne01 = %5d, ne02
+00053ed0: 203d 2025 3564 2c20 6e65 3033 203d 2025   = %5d, ne03 = %
+00053ee0: 3564 5c6e 222c 206e 6530 302c 206e 6530  5d\n", ne00, ne0
+00053ef0: 312c 206e 6530 322c 206e 6530 3329 3b0a  1, ne02, ne03);.
+00053f00: 2020 2020 2f2f 2020 2020 7072 696e 7466      //    printf
+00053f10: 2822 6e62 3030 203d 2025 3564 2c20 6e62  ("nb00 = %5d, nb
+00053f20: 3031 203d 2025 3564 2c20 6e62 3032 203d  01 = %5d, nb02 =
+00053f30: 2025 3564 2c20 6e62 3033 203d 2025 3564   %5d, nb03 = %5d
+00053f40: 5c6e 222c 206e 6230 302c 206e 6230 312c  \n", nb00, nb01,
+00053f50: 206e 6230 322c 206e 6230 3329 3b0a 2020   nb02, nb03);.  
+00053f60: 2020 2f2f 2020 2020 7072 696e 7466 2822    //    printf("
+00053f70: 6e65 3130 203d 2025 3564 2c20 6e65 3131  ne10 = %5d, ne11
+00053f80: 203d 2025 3564 2c20 6e65 3132 203d 2025   = %5d, ne12 = %
+00053f90: 3564 2c20 6e65 3133 203d 2025 3564 5c6e  5d, ne13 = %5d\n
+00053fa0: 222c 206e 6531 302c 206e 6531 312c 206e  ", ne10, ne11, n
+00053fb0: 6531 322c 206e 6531 3329 3b0a 2020 2020  e12, ne13);.    
+00053fc0: 2f2f 2020 2020 7072 696e 7466 2822 6e62  //    printf("nb
+00053fd0: 3130 203d 2025 3564 2c20 6e62 3131 203d  10 = %5d, nb11 =
+00053fe0: 2025 3564 2c20 6e62 3132 203d 2025 3564   %5d, nb12 = %5d
+00053ff0: 2c20 6e62 3133 203d 2025 3564 5c6e 222c  , nb13 = %5d\n",
+00054000: 206e 6231 302c 206e 6231 312c 206e 6231   nb10, nb11, nb1
+00054010: 322c 206e 6231 3329 3b0a 0a20 2020 202f  2, nb13);..    /
+00054020: 2f20 2020 2070 7269 6e74 6628 2258 5858  /    printf("XXX
+00054030: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00054040: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00054050: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00054060: 5820 7461 736b 2025 642f 2564 3a20 2564  X task %d/%d: %d
+00054070: 2075 732c 2061 6363 203d 2025 645c 6e22   us, acc = %d\n"
+00054080: 2c20 6974 682c 206e 7468 2c20 2869 6e74  , ith, nth, (int
+00054090: 2920 2874 3120 2d20 7430 292c 2028 696e  ) (t1 - t0), (in
+000540a0: 7429 2061 6363 293b 0a20 2020 202f 2f7d  t) acc);.    //}
+000540b0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+000540c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000540d0: 7761 7264 5f6f 7574 5f70 726f 6428 0a20  ward_out_prod(. 
+000540e0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000540f0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00054100: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00054110: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00054120: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00054130: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00054140: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00054150: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00054160: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+00054170: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00054180: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
+00054190: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
+000541a0: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
+000541b0: 474d 4c5f 5459 5045 5f51 345f 303a 0a20  GML_TYPE_Q4_0:. 
+000541c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000541d0: 5f54 5950 455f 5134 5f31 3a0a 2020 2020  _TYPE_Q4_1:.    
+000541e0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+000541f0: 5045 5f51 355f 303a 0a20 2020 2020 2020  PE_Q5_0:.       
+00054200: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00054210: 5135 5f31 3a0a 2020 2020 2020 2020 6361  Q5_1:.        ca
+00054220: 7365 2047 474d 4c5f 5459 5045 5f51 385f  se GGML_TYPE_Q8_
+00054230: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
+00054240: 4747 4d4c 5f54 5950 455f 5138 5f31 3a0a  GGML_TYPE_Q8_1:.
+00054250: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00054260: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00054270: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+00054280: 3b20 2f2f 2074 6f64 6f0a 2020 2020 2020  ; // todo.      
+00054290: 2020 2020 2020 2020 2020 2f2f 2067 676d            // ggm
+000542a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000542b0: 645f 6f75 745f 7072 6f64 5f71 5f66 3332  d_out_prod_q_f32
+000542c0: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+000542d0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+000542e0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000542f0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00054300: 4c5f 5459 5045 5f46 3136 3a0a 2020 2020  L_TYPE_F16:.    
+00054310: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00054320: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00054330: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+00054340: 2074 6f64 6f0a 2020 2020 2020 2020 2020   todo.          
+00054350: 2020 2020 2020 2f2f 2067 676d 6c5f 636f        // ggml_co
+00054360: 6d70 7574 655f 666f 7277 6172 645f 6f75  mpute_forward_ou
+00054370: 745f 7072 6f64 5f66 3136 5f66 3332 2870  t_prod_f16_f32(p
+00054380: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
+00054390: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
+000543a0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000543b0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000543c0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+000543d0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000543e0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+000543f0: 7075 7465 5f66 6f72 7761 7264 5f6f 7574  pute_forward_out
+00054400: 5f70 726f 645f 6633 3228 7061 7261 6d73  _prod_f32(params
+00054410: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
+00054420: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+00054430: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00054440: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
+00054450: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00054460: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00054470: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+00054480: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00054490: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
+000544a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000544b0: 645f 7363 616c 650a 0a73 7461 7469 6320  d_scale..static 
+000544c0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+000544d0: 655f 666f 7277 6172 645f 7363 616c 655f  e_forward_scale_
+000544e0: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
+000544f0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00054500: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00054510: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00054520: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00054530: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00054540: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00054550: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00054560: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+00054570: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00054580: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00054590: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+000545a0: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
+000545b0: 2873 7263 3029 293b 0a20 2020 2047 474d  (src0));.    GGM
+000545c0: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
+000545d0: 5f63 6f6e 7469 6775 6f75 7328 6473 7429  _contiguous(dst)
+000545e0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+000545f0: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
+00054600: 5f73 6861 7065 2873 7263 302c 2064 7374  _shape(src0, dst
+00054610: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+00054620: 4552 5428 6767 6d6c 5f69 735f 7363 616c  ERT(ggml_is_scal
+00054630: 6172 2873 7263 3129 293b 0a0a 2020 2020  ar(src1));..    
+00054640: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+00054650: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+00054660: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
+00054670: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00054680: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+00054690: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+000546a0: 7d0a 0a20 2020 202f 2f20 7363 616c 6520  }..    // scale 
+000546b0: 6661 6374 6f72 0a20 2020 2063 6f6e 7374  factor.    const
+000546c0: 2066 6c6f 6174 2076 203d 202a 2866 6c6f   float v = *(flo
+000546d0: 6174 202a 2920 7372 6331 2d3e 6461 7461  at *) src1->data
+000546e0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+000546f0: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
+00054700: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+00054710: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
+00054720: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
+00054730: 696e 7420 6e63 203d 2073 7263 302d 3e6e  int nc = src0->n
+00054740: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+00054750: 696e 7420 6e72 203d 2067 676d 6c5f 6e72  int nr = ggml_nr
+00054760: 6f77 7328 7372 6330 293b 0a0a 2020 2020  ows(src0);..    
+00054770: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
+00054780: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+00054790: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
+000547a0: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
+000547b0: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
+000547c0: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
+000547d0: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
+000547e0: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
+000547f0: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
+00054800: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
+00054810: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00054820: 206e 6230 3120 3d20 7372 6330 2d3e 6e62   nb01 = src0->nb
+00054830: 5b31 5d3b 0a0a 2020 2020 636f 6e73 7420  [1];..    const 
+00054840: 7369 7a65 5f74 206e 6231 203d 2064 7374  size_t nb1 = dst
+00054850: 2d3e 6e62 5b31 5d3b 0a0a 0a20 2020 2066  ->nb[1];...    f
+00054860: 6f72 2028 696e 7420 6931 203d 2069 7230  or (int i1 = ir0
+00054870: 3b20 6931 203c 2069 7231 3b20 6931 2b2b  ; i1 < ir1; i1++
+00054880: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
+00054890: 6473 742d 3e64 6174 6120 213d 2073 7263  dst->data != src
+000548a0: 302d 3e64 6174 6129 207b 0a20 2020 2020  0->data) {.     
+000548b0: 2020 2020 2020 202f 2f20 7372 6330 2069         // src0 i
+000548c0: 7320 7361 6d65 2073 6861 7065 2061 7320  s same shape as 
+000548d0: 6473 7420 3d3e 2073 616d 6520 696e 6469  dst => same indi
+000548e0: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
+000548f0: 6d65 6d63 7079 2828 6368 6172 202a 2964  memcpy((char *)d
+00054900: 7374 2d3e 6461 7461 202b 2069 312a 6e62  st->data + i1*nb
+00054910: 312c 2028 6368 6172 202a 2973 7263 302d  1, (char *)src0-
+00054920: 3e64 6174 6120 2b20 6931 2a6e 6230 312c  >data + i1*nb01,
+00054930: 206e 6320 2a20 7369 7a65 6f66 2866 6c6f   nc * sizeof(flo
+00054940: 6174 2929 3b0a 2020 2020 2020 2020 7d0a  at));.        }.
+00054950: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00054960: 5f73 6361 6c65 5f66 3332 286e 632c 2028  _scale_f32(nc, (
+00054970: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+00054980: 2a29 2064 7374 2d3e 6461 7461 202b 2069  *) dst->data + i
+00054990: 312a 6e62 3129 2c20 7629 3b0a 2020 2020  1*nb1), v);.    
+000549a0: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+000549b0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000549c0: 7277 6172 645f 7363 616c 6528 0a20 2020  rward_scale(.   
+000549d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000549e0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+000549f0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00054a00: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00054a10: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00054a20: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00054a30: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00054a40: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
+00054a50: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00054a60: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00054a70: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
+00054a80: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
+00054a90: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00054aa0: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+00054ab0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00054ac0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00054ad0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00054ae0: 6361 6c65 5f66 3332 2870 6172 616d 732c  cale_f32(params,
+00054af0: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
+00054b00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00054b10: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00054b20: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+00054b30: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00054b40: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00054b50: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+00054b60: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00054b70: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
+00054b80: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00054b90: 5f73 6574 0a0a 7374 6174 6963 2076 6f69  _set..static voi
+00054ba0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00054bb0: 6f72 7761 7264 5f73 6574 5f66 3332 280a  orward_set_f32(.
+00054bc0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00054bd0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00054be0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00054bf0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00054c00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00054c10: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+00054c20: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00054c30: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00054c40: 7263 312c 0a20 2020 2020 2020 2063 6f6e  rc1,.        con
+00054c50: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00054c60: 656e 736f 7220 2a20 6f70 7430 2c0a 2020  ensor * opt0,.  
+00054c70: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00054c80: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00054c90: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
+00054ca0: 5428 6767 6d6c 5f61 7265 5f73 616d 655f  T(ggml_are_same_
+00054cb0: 7368 6170 6528 7372 6330 2c20 6473 7429  shape(src0, dst)
+00054cc0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00054cd0: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
+00054ce0: 6775 6f75 7328 6473 7429 2026 2620 6767  guous(dst) && gg
+00054cf0: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
+00054d00: 2873 7263 3029 293b 0a0a 2020 2020 4747  (src0));..    GG
+00054d10: 4d4c 5f41 5353 4552 5428 6f70 7430 2d3e  ML_ASSERT(opt0->
+00054d20: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+00054d30: 455f 4933 3229 3b0a 2020 2020 4747 4d4c  E_I32);.    GGML
+00054d40: 5f41 5353 4552 5428 6767 6d6c 5f6e 656c  _ASSERT(ggml_nel
+00054d50: 656d 656e 7473 286f 7074 3029 203d 3d20  ements(opt0) == 
+00054d60: 3529 3b0a 0a20 2020 202f 2f20 7669 6577  5);..    // view
+00054d70: 2073 7263 3020 616e 6420 6473 7420 7769   src0 and dst wi
+00054d80: 7468 2074 6865 7365 2073 7472 6964 6573  th these strides
+00054d90: 2061 6e64 2064 6174 6120 6f66 6673 6574   and data offset
+00054da0: 2069 6e62 7974 6573 2064 7572 696e 6720   inbytes during 
+00054db0: 7365 740a 2020 2020 2f2f 206e 6230 2069  set.    // nb0 i
+00054dc0: 7320 696d 706c 6963 6974 656c 7920 656c  s implicitely el
+00054dd0: 656d 656e 745f 7369 7a65 2062 6563 6175  ement_size becau
+00054de0: 7365 2073 7263 3020 616e 6420 6473 7420  se src0 and dst 
+00054df0: 6172 6520 636f 6e74 6967 756f 7573 0a20  are contiguous. 
+00054e00: 2020 2073 697a 655f 7420 6e62 3120 2020     size_t nb1   
+00054e10: 2020 3d20 2828 696e 7433 325f 7420 2a29    = ((int32_t *)
+00054e20: 206f 7074 302d 3e64 6174 6129 5b30 5d3b   opt0->data)[0];
+00054e30: 0a20 2020 2073 697a 655f 7420 6e62 3220  .    size_t nb2 
+00054e40: 2020 2020 3d20 2828 696e 7433 325f 7420      = ((int32_t 
+00054e50: 2a29 206f 7074 302d 3e64 6174 6129 5b31  *) opt0->data)[1
+00054e60: 5d3b 0a20 2020 2073 697a 655f 7420 6e62  ];.    size_t nb
+00054e70: 3320 2020 2020 3d20 2828 696e 7433 325f  3     = ((int32_
+00054e80: 7420 2a29 206f 7074 302d 3e64 6174 6129  t *) opt0->data)
+00054e90: 5b32 5d3b 0a20 2020 2073 697a 655f 7420  [2];.    size_t 
+00054ea0: 6f66 6673 6574 2020 3d20 2828 696e 7433  offset  = ((int3
+00054eb0: 325f 7420 2a29 206f 7074 302d 3e64 6174  2_t *) opt0->dat
+00054ec0: 6129 5b33 5d3b 0a20 2020 2062 6f6f 6c20  a)[3];.    bool 
+00054ed0: 2020 696e 706c 6163 6520 3d20 2862 6f6f    inplace = (boo
+00054ee0: 6c29 2028 2869 6e74 3332 5f74 202a 2920  l) ((int32_t *) 
+00054ef0: 6f70 7430 2d3e 6461 7461 295b 345d 3b0a  opt0->data)[4];.
+00054f00: 0a20 2020 2069 6620 2821 696e 706c 6163  .    if (!inplac
+00054f10: 6520 2626 2028 7061 7261 6d73 2d3e 7479  e && (params->ty
+00054f20: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00054f30: 494e 4954 2929 207b 0a20 2020 2020 2020  INIT)) {.       
+00054f40: 202f 2f20 6d65 6d63 7079 206e 6565 6473   // memcpy needs
+00054f50: 2074 6f20 6265 2073 796e 6368 726f 6e69   to be synchroni
+00054f60: 7a65 6420 6163 726f 7373 2074 6872 6561  zed across threa
+00054f70: 6473 2074 6f20 6176 6f69 6420 7261 6365  ds to avoid race
+00054f80: 2063 6f6e 6469 7469 6f6e 732e 0a20 2020   conditions..   
+00054f90: 2020 2020 202f 2f20 3d3e 2064 6f20 6974       // => do it
+00054fa0: 2069 6e20 494e 4954 2070 6861 7365 0a20   in INIT phase. 
+00054fb0: 2020 2020 2020 206d 656d 6370 7928 0a20         memcpy(. 
+00054fc0: 2020 2020 2020 2020 2020 2028 2863 6861             ((cha
+00054fd0: 7220 2a29 2020 6473 742d 3e64 6174 6129  r *)  dst->data)
+00054fe0: 2c0a 2020 2020 2020 2020 2020 2020 2828  ,.            ((
+00054ff0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
+00055000: 7461 292c 0a20 2020 2020 2020 2020 2020  ta),.           
+00055010: 2067 676d 6c5f 6e62 7974 6573 2864 7374   ggml_nbytes(dst
+00055020: 2929 3b0a 2020 2020 7d0a 0a20 2020 2069  ));.    }..    i
+00055030: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+00055040: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+00055050: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
+00055060: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+00055070: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+00055080: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+00055090: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+000550a0: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
+000550b0: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
+000550c0: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
+000550d0: 7468 3b0a 0a20 2020 2063 6f6e 7374 2069  th;..    const i
+000550e0: 6e74 206e 7220 3d20 6767 6d6c 5f6e 726f  nt nr = ggml_nro
+000550f0: 7773 2873 7263 3129 3b0a 2020 2020 636f  ws(src1);.    co
+00055100: 6e73 7420 696e 7420 6e63 203d 2073 7263  nst int nc = src
+00055110: 312d 3e6e 655b 305d 3b0a 0a20 2020 2063  1->ne[0];..    c
+00055120: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
+00055130: 3020 3d20 7372 6331 2d3e 6e65 5b30 5d3b  0 = src1->ne[0];
+00055140: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00055150: 5f74 206e 6531 3120 3d20 7372 6331 2d3e  _t ne11 = src1->
+00055160: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
+00055170: 2069 6e74 3634 5f74 206e 6531 3220 3d20   int64_t ne12 = 
+00055180: 7372 6331 2d3e 6e65 5b32 5d3b 0a20 2020  src1->ne[2];.   
+00055190: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+000551a0: 6531 3320 3d20 7372 6331 2d3e 6e65 5b33  e13 = src1->ne[3
+000551b0: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
+000551c0: 7a65 5f74 206e 6231 3020 3d20 7372 6331  ze_t nb10 = src1
+000551d0: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+000551e0: 7374 2073 697a 655f 7420 6e62 3131 203d  st size_t nb11 =
+000551f0: 2073 7263 312d 3e6e 625b 315d 3b0a 2020   src1->nb[1];.  
+00055200: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+00055210: 6231 3220 3d20 7372 6331 2d3e 6e62 5b32  b12 = src1->nb[2
+00055220: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+00055230: 655f 7420 6e62 3133 203d 2073 7263 312d  e_t nb13 = src1-
+00055240: 3e6e 625b 335d 3b0a 0a20 2020 202f 2f20  >nb[3];..    // 
+00055250: 7372 6330 2061 6e64 2064 7374 2061 7320  src0 and dst as 
+00055260: 7669 6577 6564 2064 7572 696e 6720 7365  viewed during se
+00055270: 740a 2020 2020 636f 6e73 7420 7369 7a65  t.    const size
+00055280: 5f74 206e 6230 203d 2067 676d 6c5f 656c  _t nb0 = ggml_el
+00055290: 656d 656e 745f 7369 7a65 2873 7263 3029  ement_size(src0)
+000552a0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+000552b0: 2069 6d30 203d 2028 6e65 3130 203d 3d20   im0 = (ne10 == 
+000552c0: 3020 3f20 3020 3a20 6e65 3130 2d31 293b  0 ? 0 : ne10-1);
+000552d0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+000552e0: 6d31 203d 2028 6e65 3131 203d 3d20 3020  m1 = (ne11 == 0 
+000552f0: 3f20 3020 3a20 6e65 3131 2d31 293b 0a20  ? 0 : ne11-1);. 
+00055300: 2020 2063 6f6e 7374 2069 6e74 2069 6d32     const int im2
+00055310: 203d 2028 6e65 3132 203d 3d20 3020 3f20   = (ne12 == 0 ? 
+00055320: 3020 3a20 6e65 3132 2d31 293b 0a20 2020  0 : ne12-1);.   
+00055330: 2063 6f6e 7374 2069 6e74 2069 6d33 203d   const int im3 =
+00055340: 2028 6e65 3133 203d 3d20 3020 3f20 3020   (ne13 == 0 ? 0 
+00055350: 3a20 6e65 3133 2d31 293b 0a0a 2020 2020  : ne13-1);..    
+00055360: 4747 4d4c 5f41 5353 4552 5428 6f66 6673  GGML_ASSERT(offs
+00055370: 6574 202b 2069 6d30 2a6e 6230 2020 2b20  et + im0*nb0  + 
+00055380: 696d 312a 6e62 3120 202b 2069 6d32 2a6e  im1*nb1  + im2*n
+00055390: 6232 2020 2b20 696d 332a 6e62 3320 203c  b2  + im3*nb3  <
+000553a0: 2067 676d 6c5f 6e62 7974 6573 2864 7374   ggml_nbytes(dst
+000553b0: 2929 3b0a 0a20 2020 2047 474d 4c5f 4153  ));..    GGML_AS
+000553c0: 5345 5254 286e 6231 3020 3d3d 2073 697a  SERT(nb10 == siz
+000553d0: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
+000553e0: 2020 2f2f 2072 6f77 7320 7065 7220 7468    // rows per th
+000553f0: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+00055400: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
+00055410: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
+00055420: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
+00055430: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
+00055440: 2020 636f 6e73 7420 696e 7420 6972 3020    const int ir0 
+00055450: 3d20 6472 2a69 7468 3b0a 2020 2020 636f  = dr*ith;.    co
+00055460: 6e73 7420 696e 7420 6972 3120 3d20 4d49  nst int ir1 = MI
+00055470: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
+00055480: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00055490: 7220 3d20 6972 303b 2069 7220 3c20 6972  r = ir0; ir < ir
+000554a0: 313b 202b 2b69 7229 207b 0a20 2020 2020  1; ++ir) {.     
+000554b0: 2020 202f 2f20 7372 6330 2061 6e64 2064     // src0 and d
+000554c0: 7374 2061 7265 2076 6965 7765 6420 7769  st are viewed wi
+000554d0: 7468 2073 6861 7065 206f 6620 7372 6331  th shape of src1
+000554e0: 2061 6e64 206f 6666 7365 740a 2020 2020   and offset.    
+000554f0: 2020 2020 2f2f 203d 3e20 7361 6d65 2069      // => same i
+00055500: 6e64 6963 6573 0a20 2020 2020 2020 2063  ndices.        c
+00055510: 6f6e 7374 2069 6e74 2069 3320 3d20 6972  onst int i3 = ir
+00055520: 2f28 6e65 3132 2a6e 6531 3129 3b0a 2020  /(ne12*ne11);.  
+00055530: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00055540: 6932 203d 2028 6972 202d 2069 332a 6e65  i2 = (ir - i3*ne
+00055550: 3132 2a6e 6531 3129 2f6e 6531 313b 0a20  12*ne11)/ne11;. 
+00055560: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00055570: 2069 3120 3d20 2869 7220 2d20 6933 2a6e   i1 = (ir - i3*n
+00055580: 6531 322a 6e65 3131 202d 2069 322a 6e65  e12*ne11 - i2*ne
+00055590: 3131 293b 0a0a 2020 2020 2020 2020 6767  11);..        gg
+000555a0: 6d6c 5f76 6563 5f63 7079 5f66 3332 286e  ml_vec_cpy_f32(n
+000555b0: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+000555c0: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+000555d0: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
+000555e0: 6120 2b20 6933 2a6e 6233 2020 2b20 6932  a + i3*nb3  + i2
+000555f0: 2a6e 6232 2020 2b20 6931 2a6e 6231 2020  *nb2  + i1*nb1  
+00055600: 2b20 6f66 6673 6574 292c 0a20 2020 2020  + offset),.     
+00055610: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00055620: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+00055630: 7263 312d 3e64 6174 6120 2b20 6933 2a6e  rc1->data + i3*n
+00055640: 6231 3320 2b20 6932 2a6e 6231 3220 2b20  b13 + i2*nb12 + 
+00055650: 6931 2a6e 6231 3129 293b 0a20 2020 207d  i1*nb11));.    }
+00055660: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+00055670: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00055680: 7761 7264 5f73 6574 280a 2020 2020 2020  ward_set(.      
+00055690: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000556a0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000556b0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+000556c0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000556d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000556e0: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+000556f0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00055700: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+00055710: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00055720: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00055730: 2a20 6f70 7430 2c0a 2020 2020 2020 2020  * opt0,.        
+00055740: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00055750: 6f72 202a 2064 7374 2920 7b0a 0a20 2020  or * dst) {..   
+00055760: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
+00055770: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
+00055780: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
+00055790: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
+000557a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000557b0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000557c0: 7277 6172 645f 7365 745f 6633 3228 7061  rward_set_f32(pa
+000557d0: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
+000557e0: 2c20 6f70 7430 2c20 6473 7429 3b0a 2020  , opt0, dst);.  
+000557f0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00055800: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00055810: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+00055820: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00055830: 5f54 5950 455f 5134 5f30 3a0a 2020 2020  _TYPE_Q4_0:.    
+00055840: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00055850: 5045 5f51 345f 313a 0a20 2020 2020 2020  PE_Q4_1:.       
+00055860: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00055870: 5135 5f30 3a0a 2020 2020 2020 2020 6361  Q5_0:.        ca
+00055880: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
+00055890: 313a 0a20 2020 2020 2020 2063 6173 6520  1:.        case 
+000558a0: 4747 4d4c 5f54 5950 455f 5138 5f30 3a0a  GGML_TYPE_Q8_0:.
+000558b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000558c0: 4c5f 5459 5045 5f51 385f 313a 0a20 2020  L_TYPE_Q8_1:.   
+000558d0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+000558e0: 5950 455f 5132 5f4b 3a0a 2020 2020 2020  YPE_Q2_K:.      
+000558f0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00055900: 5f51 335f 4b3a 0a20 2020 2020 2020 2063  _Q3_K:.        c
+00055910: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
+00055920: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
+00055930: 2047 474d 4c5f 5459 5045 5f51 355f 4b3a   GGML_TYPE_Q5_K:
+00055940: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00055950: 4d4c 5f54 5950 455f 5136 5f4b 3a0a 2020  ML_TYPE_Q6_K:.  
+00055960: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+00055970: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00055980: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00055990: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+000559a0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000559b0: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
+000559c0: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+000559d0: 6f72 7761 7264 5f63 7079 0a0a 7374 6174  orward_cpy..stat
+000559e0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+000559f0: 7075 7465 5f66 6f72 7761 7264 5f63 7079  pute_forward_cpy
+00055a00: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00055a10: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00055a20: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00055a30: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00055a40: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00055a50: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00055a60: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00055a70: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00055a80: 7b0a 2020 2020 6767 6d6c 5f63 6f6d 7075  {.    ggml_compu
+00055a90: 7465 5f66 6f72 7761 7264 5f64 7570 2870  te_forward_dup(p
+00055aa0: 6172 616d 732c 2073 7263 302c 2064 7374  arams, src0, dst
+00055ab0: 293b 0a7d 0a0a 2f2f 2067 676d 6c5f 636f  );.}..// ggml_co
+00055ac0: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
+00055ad0: 6e74 0a0a 7374 6174 6963 2076 6f69 6420  nt..static void 
+00055ae0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00055af0: 7761 7264 5f63 6f6e 7428 0a20 2020 2020  ward_cont(.     
+00055b00: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00055b10: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00055b20: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00055b30: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00055b40: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00055b50: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
+00055b60: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00055b70: 7220 2a20 6473 7429 207b 0a20 2020 2067  r * dst) {.    g
+00055b80: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00055b90: 6172 645f 6475 7028 7061 7261 6d73 2c20  ard_dup(params, 
+00055ba0: 7372 6330 2c20 6473 7429 3b0a 7d0a 0a2f  src0, dst);.}../
+00055bb0: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+00055bc0: 6f72 7761 7264 5f72 6573 6861 7065 0a0a  orward_reshape..
+00055bd0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00055be0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00055bf0: 5f72 6573 6861 7065 280a 2020 2020 2020  _reshape(.      
+00055c00: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00055c10: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00055c20: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00055c30: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00055c40: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00055c50: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
+00055c60: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00055c70: 202a 2064 7374 2920 7b0a 2020 2020 2f2f   * dst) {.    //
+00055c80: 204e 4f50 0a20 2020 2055 4e55 5345 4428   NOP.    UNUSED(
+00055c90: 7061 7261 6d73 293b 0a20 2020 2055 4e55  params);.    UNU
+00055ca0: 5345 4428 7372 6330 293b 0a20 2020 2055  SED(src0);.    U
+00055cb0: 4e55 5345 4428 6473 7429 3b0a 7d0a 0a2f  NUSED(dst);.}../
+00055cc0: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+00055cd0: 6f72 7761 7264 5f76 6965 770a 0a73 7461  orward_view..sta
+00055ce0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00055cf0: 6d70 7574 655f 666f 7277 6172 645f 7669  mpute_forward_vi
+00055d00: 6577 280a 2020 2020 2020 2020 636f 6e73  ew(.        cons
+00055d10: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+00055d20: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+00055d30: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+00055d40: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00055d50: 5f74 656e 736f 7220 2a20 7372 6330 2920  _tensor * src0) 
+00055d60: 7b0a 2020 2020 2f2f 204e 4f50 0a20 2020  {.    // NOP.   
+00055d70: 2055 4e55 5345 4428 7061 7261 6d73 293b   UNUSED(params);
+00055d80: 0a20 2020 2055 4e55 5345 4428 7372 6330  .    UNUSED(src0
+00055d90: 293b 0a7d 0a0a 2f2f 2067 676d 6c5f 636f  );.}..// ggml_co
+00055da0: 6d70 7574 655f 666f 7277 6172 645f 7065  mpute_forward_pe
+00055db0: 726d 7574 650a 0a73 7461 7469 6320 766f  rmute..static vo
+00055dc0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+00055dd0: 666f 7277 6172 645f 7065 726d 7574 6528  forward_permute(
+00055de0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00055df0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00055e00: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00055e10: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00055e20: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00055e30: 6e73 6f72 202a 2073 7263 3029 207b 0a20  nsor * src0) {. 
+00055e40: 2020 202f 2f20 4e4f 500a 2020 2020 554e     // NOP.    UN
+00055e50: 5553 4544 2870 6172 616d 7329 3b0a 2020  USED(params);.  
+00055e60: 2020 554e 5553 4544 2873 7263 3029 3b0a    UNUSED(src0);.
+00055e70: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00055e80: 7465 5f66 6f72 7761 7264 5f74 7261 6e73  te_forward_trans
+00055e90: 706f 7365 0a0a 7374 6174 6963 2076 6f69  pose..static voi
+00055ea0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00055eb0: 6f72 7761 7264 5f74 7261 6e73 706f 7365  orward_transpose
+00055ec0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00055ed0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00055ee0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00055ef0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00055f00: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00055f10: 656e 736f 7220 2a20 7372 6330 2920 7b0a  ensor * src0) {.
+00055f20: 2020 2020 2f2f 204e 4f50 0a20 2020 2055      // NOP.    U
+00055f30: 4e55 5345 4428 7061 7261 6d73 293b 0a20  NUSED(params);. 
+00055f40: 2020 2055 4e55 5345 4428 7372 6330 293b     UNUSED(src0);
+00055f50: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
+00055f60: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
+00055f70: 726f 7773 0a0a 7374 6174 6963 2076 6f69  rows..static voi
+00055f80: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00055f90: 6f72 7761 7264 5f67 6574 5f72 6f77 735f  orward_get_rows_
+00055fa0: 7128 0a20 2020 2020 2020 2063 6f6e 7374  q(.        const
+00055fb0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00055fc0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00055fd0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00055fe0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00055ff0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00056000: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00056010: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00056020: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
+00056030: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00056040: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00056050: 7b0a 2020 2020 6173 7365 7274 2870 6172  {.    assert(par
+00056060: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
+00056070: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00056080: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00056090: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+000560a0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+000560b0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+000560c0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+000560d0: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
+000560e0: 7420 696e 7420 6e63 203d 2073 7263 302d  t int nc = src0-
+000560f0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+00056100: 7420 696e 7420 6e72 203d 2067 676d 6c5f  t int nr = ggml_
+00056110: 6e65 6c65 6d65 6e74 7328 7372 6331 293b  nelements(src1);
+00056120: 0a20 2020 2063 6f6e 7374 2065 6e75 6d20  .    const enum 
+00056130: 6767 6d6c 5f74 7970 6520 7479 7065 203d  ggml_type type =
+00056140: 2073 7263 302d 3e74 7970 653b 0a20 2020   src0->type;.   
+00056150: 2064 6571 7561 6e74 697a 655f 726f 775f   dequantize_row_
+00056160: 715f 7420 636f 6e73 7420 6465 7175 616e  q_t const dequan
+00056170: 7469 7a65 5f72 6f77 5f71 203d 2071 7561  tize_row_q = qua
+00056180: 6e74 697a 655f 666e 735b 7479 7065 5d2e  ntize_fns[type].
 00056190: 6465 7175 616e 7469 7a65 5f72 6f77 5f71  dequantize_row_q
-000561a0: 5f74 2063 6f6e 7374 2064 6571 7561 6e74  _t const dequant
-000561b0: 697a 655f 726f 775f 7120 3d20 7175 616e  ize_row_q = quan
-000561c0: 7469 7a65 5f66 6e73 5b74 7970 655d 2e64  tize_fns[type].d
-000561d0: 6571 7561 6e74 697a 655f 726f 775f 713b  equantize_row_q;
-000561e0: 0a0a 2020 2020 6173 7365 7274 2820 6473  ..    assert( ds
-000561f0: 742d 3e6e 655b 305d 203d 3d20 6e63 293b  t->ne[0] == nc);
-00056200: 0a20 2020 2061 7373 6572 7428 2064 7374  .    assert( dst
-00056210: 2d3e 6e65 5b31 5d20 3d3d 206e 7229 3b0a  ->ne[1] == nr);.
-00056220: 2020 2020 6173 7365 7274 2873 7263 302d      assert(src0-
-00056230: 3e6e 625b 305d 203d 3d20 4747 4d4c 5f54  >nb[0] == GGML_T
-00056240: 5950 455f 5349 5a45 5b74 7970 655d 293b  YPE_SIZE[type]);
-00056250: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
-00056260: 203d 2030 3b20 6920 3c20 6e72 3b20 2b2b   = 0; i < nr; ++
-00056270: 6929 207b 0a20 2020 2020 2020 2063 6f6e  i) {.        con
-00056280: 7374 2069 6e74 2072 203d 2028 2869 6e74  st int r = ((int
-00056290: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
-000562a0: 7461 295b 695d 3b0a 0a20 2020 2020 2020  ta)[i];..       
-000562b0: 2064 6571 7561 6e74 697a 655f 726f 775f   dequantize_row_
-000562c0: 7128 0a20 2020 2020 2020 2020 2020 2020  q(.             
-000562d0: 2020 2028 636f 6e73 7420 766f 6964 202a     (const void *
-000562e0: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
-000562f0: 2d3e 6461 7461 202b 2072 2a73 7263 302d  ->data + r*src0-
-00056300: 3e6e 625b 315d 292c 0a20 2020 2020 2020  >nb[1]),.       
-00056310: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-00056320: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-00056330: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
-00056340: 2a64 7374 2d3e 6e62 5b31 5d29 2c20 6e63  *dst->nb[1]), nc
-00056350: 293b 0a20 2020 207d 0a7d 0a0a 7374 6174  );.    }.}..stat
-00056360: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00056370: 7075 7465 5f66 6f72 7761 7264 5f67 6574  pute_forward_get
-00056380: 5f72 6f77 735f 6631 3628 0a20 2020 2020  _rows_f16(.     
-00056390: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000563a0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-000563b0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-000563c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000563d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000563e0: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-000563f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00056400: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-00056410: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00056420: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00056430: 202a 2064 7374 2920 7b0a 2020 2020 6173   * dst) {.    as
-00056440: 7365 7274 2870 6172 616d 732d 3e69 7468  sert(params->ith
-00056450: 203d 3d20 3029 3b0a 0a20 2020 2069 6620   == 0);..    if 
-00056460: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00056470: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-00056480: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00056490: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-000564a0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-000564b0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-000564c0: 2020 2020 636f 6e73 7420 696e 7420 6e63      const int nc
-000564d0: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
-000564e0: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-000564f0: 203d 2067 676d 6c5f 6e65 6c65 6d65 6e74   = ggml_nelement
-00056500: 7328 7372 6331 293b 0a0a 2020 2020 6173  s(src1);..    as
-00056510: 7365 7274 2820 6473 742d 3e6e 655b 305d  sert( dst->ne[0]
-00056520: 203d 3d20 6e63 293b 0a20 2020 2061 7373   == nc);.    ass
-00056530: 6572 7428 2064 7374 2d3e 6e65 5b31 5d20  ert( dst->ne[1] 
-00056540: 3d3d 206e 7229 3b0a 2020 2020 6173 7365  == nr);.    asse
-00056550: 7274 2873 7263 302d 3e6e 625b 305d 203d  rt(src0->nb[0] =
-00056560: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
-00056570: 3136 5f74 2929 3b0a 0a20 2020 2066 6f72  16_t));..    for
-00056580: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-00056590: 206e 723b 202b 2b69 2920 7b0a 2020 2020   nr; ++i) {.    
-000565a0: 2020 2020 636f 6e73 7420 696e 7420 7220      const int r 
-000565b0: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
-000565c0: 7263 312d 3e64 6174 6129 5b69 5d3b 0a0a  rc1->data)[i];..
-000565d0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-000565e0: 206a 203d 2030 3b20 6a20 3c20 6e63 3b20   j = 0; j < nc; 
-000565f0: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
-00056600: 2020 2067 676d 6c5f 6670 3136 5f74 2076     ggml_fp16_t v
-00056610: 203d 2028 2867 676d 6c5f 6670 3136 5f74   = ((ggml_fp16_t
-00056620: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
-00056630: 6330 2d3e 6461 7461 202b 2072 2a73 7263  c0->data + r*src
-00056640: 302d 3e6e 625b 315d 2929 5b6a 5d3b 0a20  0->nb[1]))[j];. 
-00056650: 2020 2020 2020 2020 2020 2028 2866 6c6f             ((flo
-00056660: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-00056670: 2064 7374 2d3e 6461 7461 202b 2069 2a64   dst->data + i*d
-00056680: 7374 2d3e 6e62 5b31 5d29 295b 6a5d 203d  st->nb[1]))[j] =
-00056690: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
-000566a0: 3332 2876 293b 0a20 2020 2020 2020 207d  32(v);.        }
-000566b0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-000566c0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-000566d0: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
-000566e0: 6f77 735f 6633 3228 0a20 2020 2020 2020  ows_f32(.       
-000566f0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00056700: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00056710: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00056720: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00056730: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00056740: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
-00056750: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00056760: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
-00056770: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-00056780: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00056790: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
-000567a0: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
-000567b0: 3d20 3029 3b0a 0a20 2020 2069 6620 2870  = 0);..    if (p
-000567c0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000567d0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
-000567e0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
-000567f0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-00056800: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
-00056810: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-00056820: 2020 636f 6e73 7420 696e 7420 6e63 203d    const int nc =
-00056830: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
-00056840: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
-00056850: 2067 676d 6c5f 6e65 6c65 6d65 6e74 7328   ggml_nelements(
-00056860: 7372 6331 293b 0a0a 2020 2020 6173 7365  src1);..    asse
-00056870: 7274 2820 6473 742d 3e6e 655b 305d 203d  rt( dst->ne[0] =
-00056880: 3d20 6e63 293b 0a20 2020 2061 7373 6572  = nc);.    asser
-00056890: 7428 2064 7374 2d3e 6e65 5b31 5d20 3d3d  t( dst->ne[1] ==
-000568a0: 206e 7229 3b0a 2020 2020 6173 7365 7274   nr);.    assert
-000568b0: 2873 7263 302d 3e6e 625b 305d 203d 3d20  (src0->nb[0] == 
-000568c0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-000568d0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-000568e0: 3d20 303b 2069 203c 206e 723b 202b 2b69  = 0; i < nr; ++i
-000568f0: 2920 7b0a 2020 2020 2020 2020 636f 6e73  ) {.        cons
-00056900: 7420 696e 7420 7220 3d20 2828 696e 7433  t int r = ((int3
-00056910: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
-00056920: 6129 5b69 5d3b 0a0a 2020 2020 2020 2020  a)[i];..        
-00056930: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
-00056940: 286e 632c 0a20 2020 2020 2020 2020 2020  (nc,.           
-00056950: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-00056960: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
-00056970: 6174 6120 2b20 692a 6473 742d 3e6e 625b  ata + i*dst->nb[
-00056980: 315d 292c 0a20 2020 2020 2020 2020 2020  1]),.           
-00056990: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-000569a0: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-000569b0: 6174 6120 2b20 722a 7372 6330 2d3e 6e62  ata + r*src0->nb
-000569c0: 5b31 5d29 293b 0a20 2020 207d 0a7d 0a0a  [1]));.    }.}..
-000569d0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-000569e0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000569f0: 5f67 6574 5f72 6f77 7328 0a20 2020 2020  _get_rows(.     
-00056a00: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00056a10: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00056a20: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00056a30: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00056a40: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00056a50: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-00056a60: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00056a70: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-00056a80: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00056a90: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00056aa0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00056ab0: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00056ac0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00056ad0: 5459 5045 5f51 345f 303a 0a20 2020 2020  TYPE_Q4_0:.     
-00056ae0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00056af0: 455f 5134 5f31 3a0a 2020 2020 2020 2020  E_Q4_1:.        
-00056b00: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00056b10: 355f 303a 0a20 2020 2020 2020 2063 6173  5_0:.        cas
-00056b20: 6520 4747 4d4c 5f54 5950 455f 5135 5f31  e GGML_TYPE_Q5_1
-00056b30: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00056b40: 474d 4c5f 5459 5045 5f51 385f 303a 0a20  GML_TYPE_Q8_0:. 
-00056b50: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00056b60: 5f54 5950 455f 5138 5f31 3a0a 2020 2020  _TYPE_Q8_1:.    
-00056b70: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00056b80: 5045 5f51 325f 4b3a 0a20 2020 2020 2020  PE_Q2_K:.       
-00056b90: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00056ba0: 5133 5f4b 3a0a 2020 2020 2020 2020 6361  Q3_K:.        ca
-00056bb0: 7365 2047 474d 4c5f 5459 5045 5f51 345f  se GGML_TYPE_Q4_
-00056bc0: 4b3a 0a20 2020 2020 2020 2063 6173 6520  K:.        case 
-00056bd0: 4747 4d4c 5f54 5950 455f 5135 5f4b 3a0a  GGML_TYPE_Q5_K:.
-00056be0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00056bf0: 4c5f 5459 5045 5f51 365f 4b3a 0a20 2020  L_TYPE_Q6_K:.   
-00056c00: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00056c10: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00056c20: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00056c30: 6765 745f 726f 7773 5f71 2870 6172 616d  get_rows_q(param
-00056c40: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00056c50: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00056c60: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00056c70: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00056c80: 5f46 3136 3a0a 2020 2020 2020 2020 2020  _F16:.          
-00056c90: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00056ca0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00056cb0: 5f66 6f72 7761 7264 5f67 6574 5f72 6f77  _forward_get_row
-00056cc0: 735f 6631 3628 7061 7261 6d73 2c20 7372  s_f16(params, sr
-00056cd0: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
-00056ce0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00056cf0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00056d00: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
-00056d10: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00056d20: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00056d30: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00056d40: 6172 645f 6765 745f 726f 7773 5f66 3332  ard_get_rows_f32
-00056d50: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
-00056d60: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
-00056d70: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00056d80: 2020 2020 2020 2020 6465 6661 756c 743a          default:
-00056d90: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00056da0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00056db0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-00056dc0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00056dd0: 2062 7265 616b 3b0a 2020 2020 7d0a 0a20   break;.    }.. 
-00056de0: 2020 202f 2f73 7461 7469 6320 626f 6f6c     //static bool
-00056df0: 2066 6972 7374 203d 2074 7275 653b 0a20   first = true;. 
-00056e00: 2020 202f 2f70 7269 6e74 6628 226e 6530     //printf("ne0
-00056e10: 203d 2025 642c 206e 6531 203d 2025 642c   = %d, ne1 = %d,
-00056e20: 206e 6532 203d 2025 645c 6e22 2c20 6473   ne2 = %d\n", ds
-00056e30: 742d 3e6e 655b 305d 2c20 6473 742d 3e6e  t->ne[0], dst->n
-00056e40: 655b 315d 2c20 6473 742d 3e6e 655b 325d  e[1], dst->ne[2]
-00056e50: 293b 0a20 2020 202f 2f69 6620 2866 6972  );.    //if (fir
-00056e60: 7374 2920 7b0a 2020 2020 2f2f 2020 2020  st) {.    //    
-00056e70: 6669 7273 7420 3d20 6661 6c73 653b 0a20  first = false;. 
-00056e80: 2020 202f 2f7d 2065 6c73 6520 7b0a 2020     //} else {.  
-00056e90: 2020 2f2f 2020 2020 666f 7220 2869 6e74    //    for (int
-00056ea0: 206b 203d 2030 3b20 6b20 3c20 6473 742d   k = 0; k < dst-
-00056eb0: 3e6e 655b 315d 3b20 2b2b 6b29 207b 0a20  >ne[1]; ++k) {. 
-00056ec0: 2020 202f 2f20 2020 2020 2020 2066 6f72     //        for
-00056ed0: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
-00056ee0: 2064 7374 2d3e 6e65 5b30 5d2f 3136 3b20   dst->ne[0]/16; 
-00056ef0: 2b2b 6a29 207b 0a20 2020 202f 2f20 2020  ++j) {.    //   
-00056f00: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00056f10: 7420 6920 3d20 303b 2069 203c 2031 363b  t i = 0; i < 16;
-00056f20: 202b 2b69 2920 7b0a 2020 2020 2f2f 2020   ++i) {.    //  
-00056f30: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00056f40: 696e 7466 2822 2538 2e34 6620 222c 2028  intf("%8.4f ", (
-00056f50: 2866 6c6f 6174 202a 2920 6473 742d 3e64  (float *) dst->d
-00056f60: 6174 6129 5b6b 2a64 7374 2d3e 6e65 5b30  ata)[k*dst->ne[0
-00056f70: 5d20 2b20 6a2a 3136 202b 2069 5d29 3b0a  ] + j*16 + i]);.
-00056f80: 2020 2020 2f2f 2020 2020 2020 2020 2020      //          
-00056f90: 2020 7d0a 2020 2020 2f2f 2020 2020 2020    }.    //      
-00056fa0: 2020 2020 2020 7072 696e 7466 2822 5c6e        printf("\n
-00056fb0: 2229 3b0a 2020 2020 2f2f 2020 2020 2020  ");.    //      
-00056fc0: 2020 7d0a 2020 2020 2f2f 2020 2020 2020    }.    //      
-00056fd0: 2020 7072 696e 7466 2822 5c6e 2229 3b0a    printf("\n");.
-00056fe0: 2020 2020 2f2f 2020 2020 7d0a 2020 2020      //    }.    
-00056ff0: 2f2f 2020 2020 7072 696e 7466 2822 5c6e  //    printf("\n
-00057000: 2229 3b0a 2020 2020 2f2f 2020 2020 6578  ");.    //    ex
-00057010: 6974 2830 293b 0a20 2020 202f 2f7d 0a7d  it(0);.    //}.}
-00057020: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-00057030: 655f 666f 7277 6172 645f 6765 745f 726f  e_forward_get_ro
-00057040: 7773 5f62 6163 6b0a 0a73 7461 7469 6320  ws_back..static 
-00057050: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-00057060: 655f 666f 7277 6172 645f 6765 745f 726f  e_forward_get_ro
-00057070: 7773 5f62 6163 6b5f 6633 325f 6631 3628  ws_back_f32_f16(
-00057080: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00057090: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-000570a0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-000570b0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-000570c0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000570d0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-000570e0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000570f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00057100: 7372 6331 2c0a 2020 2020 2020 2020 636f  src1,.        co
-00057110: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00057120: 7465 6e73 6f72 202a 206f 7074 302c 0a20  tensor * opt0,. 
-00057130: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00057140: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00057150: 2a20 6473 7429 207b 0a20 2020 2047 474d  * dst) {.    GGM
-00057160: 4c5f 4153 5345 5254 2870 6172 616d 732d  L_ASSERT(params-
-00057170: 3e69 7468 203d 3d20 3029 3b0a 2020 2020  >ith == 0);.    
-00057180: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-00057190: 5f61 7265 5f73 616d 655f 7368 6170 6528  _are_same_shape(
-000571a0: 6f70 7430 2c20 6473 7429 293b 0a20 2020  opt0, dst));.   
-000571b0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-000571c0: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
-000571d0: 6f70 7430 2929 3b0a 2020 2020 4747 4d4c  opt0));.    GGML
-000571e0: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
-000571f0: 636f 6e74 6967 756f 7573 2864 7374 2929  contiguous(dst))
-00057200: 3b0a 0a20 2020 2067 676d 6c5f 636f 6d70  ;..    ggml_comp
-00057210: 7574 655f 666f 7277 6172 645f 6475 705f  ute_forward_dup_
-00057220: 7361 6d65 5f63 6f6e 7428 7061 7261 6d73  same_cont(params
-00057230: 2c20 6f70 7430 2c20 6473 7429 3b0a 0a20  , opt0, dst);.. 
-00057240: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-00057250: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-00057260: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
-00057270: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00057280: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
-00057290: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-000572a0: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
-000572b0: 696e 7420 6e63 203d 2073 7263 302d 3e6e  int nc = src0->n
-000572c0: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-000572d0: 696e 7420 6e72 203d 2067 676d 6c5f 6e65  int nr = ggml_ne
-000572e0: 6c65 6d65 6e74 7328 7372 6331 293b 0a0a  lements(src1);..
-000572f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00057300: 2064 7374 2d3e 6e65 5b30 5d20 3d3d 206e   dst->ne[0] == n
-00057310: 6329 3b0a 2020 2020 4747 4d4c 5f41 5353  c);.    GGML_ASS
-00057320: 4552 5428 7372 6330 2d3e 6e62 5b30 5d20  ERT(src0->nb[0] 
-00057330: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
-00057340: 7031 365f 7429 293b 0a0a 2020 2020 666f  p16_t));..    fo
-00057350: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00057360: 3c20 6e72 3b20 2b2b 6929 207b 0a20 2020  < nr; ++i) {.   
-00057370: 2020 2020 2063 6f6e 7374 2069 6e74 2072       const int r
-00057380: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
-00057390: 7372 6331 2d3e 6461 7461 295b 695d 3b0a  src1->data)[i];.
-000573a0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-000573b0: 7420 6a20 3d20 303b 206a 203c 206e 633b  t j = 0; j < nc;
-000573c0: 202b 2b6a 2920 7b0a 2020 2020 2020 2020   ++j) {.        
-000573d0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-000573e0: 7620 3d20 2828 6767 6d6c 5f66 7031 365f  v = ((ggml_fp16_
-000573f0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-00057400: 7263 302d 3e64 6174 6120 2b20 692a 7372  rc0->data + i*sr
-00057410: 6330 2d3e 6e62 5b31 5d29 295b 6a5d 3b0a  c0->nb[1]))[j];.
-00057420: 2020 2020 2020 2020 2020 2020 2828 666c              ((fl
-00057430: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00057440: 2064 7374 2d3e 6461 7461 202b 2072 2a64   dst->data + r*d
-00057450: 7374 2d3e 6e62 5b31 5d29 295b 6a5d 202b  st->nb[1]))[j] +
-00057460: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
-00057470: 5033 3228 7629 3b0a 2020 2020 2020 2020  P32(v);.        
-00057480: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
-00057490: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-000574a0: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
-000574b0: 726f 7773 5f62 6163 6b5f 6633 3228 0a20  rows_back_f32(. 
-000574c0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-000574d0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-000574e0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-000574f0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00057500: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00057510: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-00057520: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00057530: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00057540: 6331 2c0a 2020 2020 2020 2020 636f 6e73  c1,.        cons
-00057550: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00057560: 6e73 6f72 202a 206f 7074 302c 0a20 2020  nsor * opt0,.   
-00057570: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00057580: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00057590: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
-000575a0: 4153 5345 5254 2870 6172 616d 732d 3e69  ASSERT(params->i
-000575b0: 7468 203d 3d20 3029 3b0a 2020 2020 4747  th == 0);.    GG
-000575c0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f61  ML_ASSERT(ggml_a
-000575d0: 7265 5f73 616d 655f 7368 6170 6528 6f70  re_same_shape(op
-000575e0: 7430 2c20 6473 7429 293b 0a20 2020 2047  t0, dst));.    G
-000575f0: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
-00057600: 6973 5f63 6f6e 7469 6775 6f75 7328 6f70  is_contiguous(op
-00057610: 7430 2929 3b0a 2020 2020 4747 4d4c 5f41  t0));.    GGML_A
-00057620: 5353 4552 5428 6767 6d6c 5f69 735f 636f  SSERT(ggml_is_co
-00057630: 6e74 6967 756f 7573 2864 7374 2929 3b0a  ntiguous(dst));.
-00057640: 0a20 2020 202f 2f20 6767 6d6c 5f63 6f6d  .    // ggml_com
-00057650: 7075 7465 5f66 6f72 7761 7264 5f64 7570  pute_forward_dup
-00057660: 5f73 616d 655f 636f 6e74 2870 6172 616d  _same_cont(param
-00057670: 732c 206f 7074 302c 2064 7374 293b 0a0a  s, opt0, dst);..
-00057680: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00057690: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-000576a0: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
-000576b0: 2020 6d65 6d73 6574 2864 7374 2d3e 6461    memset(dst->da
-000576c0: 7461 2c20 302c 2067 676d 6c5f 6e62 7974  ta, 0, ggml_nbyt
-000576d0: 6573 2864 7374 2929 3b0a 2020 2020 7d0a  es(dst));.    }.
-000576e0: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-000576f0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00057700: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
-00057710: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00057720: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-00057730: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-00057740: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
-00057750: 7420 696e 7420 6e63 203d 2073 7263 302d  t int nc = src0-
-00057760: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-00057770: 7420 696e 7420 6e72 203d 2067 676d 6c5f  t int nr = ggml_
-00057780: 6e65 6c65 6d65 6e74 7328 7372 6331 293b  nelements(src1);
-00057790: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-000577a0: 5428 2064 7374 2d3e 6e65 5b30 5d20 3d3d  T( dst->ne[0] ==
-000577b0: 206e 6329 3b0a 2020 2020 4747 4d4c 5f41   nc);.    GGML_A
-000577c0: 5353 4552 5428 7372 6330 2d3e 6e62 5b30  SSERT(src0->nb[0
-000577d0: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
-000577e0: 7429 293b 0a0a 2020 2020 666f 7220 2869  t));..    for (i
-000577f0: 6e74 2069 203d 2030 3b20 6920 3c20 6e72  nt i = 0; i < nr
-00057800: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00057810: 2063 6f6e 7374 2069 6e74 2072 203d 2028   const int r = (
-00057820: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-00057830: 2d3e 6461 7461 295b 695d 3b0a 0a20 2020  ->data)[i];..   
-00057840: 2020 2020 2067 676d 6c5f 7665 635f 6164       ggml_vec_ad
-00057850: 645f 6633 3228 6e63 2c0a 2020 2020 2020  d_f32(nc,.      
-00057860: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00057870: 202a 2920 2828 6368 6172 202a 2920 2064   *) ((char *)  d
-00057880: 7374 2d3e 6461 7461 202b 2072 2a64 7374  st->data + r*dst
-00057890: 2d3e 6e62 5b31 5d29 2c0a 2020 2020 2020  ->nb[1]),.      
-000578a0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-000578b0: 202a 2920 2828 6368 6172 202a 2920 2064   *) ((char *)  d
-000578c0: 7374 2d3e 6461 7461 202b 2072 2a64 7374  st->data + r*dst
-000578d0: 2d3e 6e62 5b31 5d29 2c0a 2020 2020 2020  ->nb[1]),.      
-000578e0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-000578f0: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
-00057900: 6330 2d3e 6461 7461 202b 2069 2a73 7263  c0->data + i*src
-00057910: 302d 3e6e 625b 315d 2929 3b0a 2020 2020  0->nb[1]));.    
-00057920: 7d0a 7d0a 0a0a 7374 6174 6963 2076 6f69  }.}...static voi
-00057930: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00057940: 6f72 7761 7264 5f67 6574 5f72 6f77 735f  orward_get_rows_
-00057950: 6261 636b 280a 2020 2020 2020 2020 636f  back(.        co
-00057960: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00057970: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00057980: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00057990: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-000579a0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-000579b0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-000579c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000579d0: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
-000579e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000579f0: 6767 6d6c 5f74 656e 736f 7220 2a20 6f70  ggml_tensor * op
-00057a00: 7430 2c0a 2020 2020 2020 2020 7374 7275  t0,.        stru
-00057a10: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00057a20: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
-00057a30: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-00057a40: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-00057a50: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-00057a60: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00057a70: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00057a80: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00057a90: 5f67 6574 5f72 6f77 735f 6261 636b 5f66  _get_rows_back_f
-00057aa0: 3332 5f66 3136 2870 6172 616d 732c 2073  32_f16(params, s
-00057ab0: 7263 302c 2073 7263 312c 206f 7074 302c  rc0, src1, opt0,
-00057ac0: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00057ad0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00057ae0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00057af0: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
-00057b00: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00057b10: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00057b20: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
-00057b30: 6f77 735f 6261 636b 5f66 3332 2870 6172  ows_back_f32(par
-00057b40: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
-00057b50: 206f 7074 302c 2064 7374 293b 0a20 2020   opt0, dst);.   
-00057b60: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00057b70: 3b0a 2020 2020 2020 2020 6465 6661 756c  ;.        defaul
-00057b80: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
-00057b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00057ba0: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00057bb0: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00057bc0: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00057bd0: 0a20 2020 202f 2f73 7461 7469 6320 626f  .    //static bo
-00057be0: 6f6c 2066 6972 7374 203d 2074 7275 653b  ol first = true;
-00057bf0: 0a20 2020 202f 2f70 7269 6e74 6628 226e  .    //printf("n
-00057c00: 6530 203d 2025 642c 206e 6531 203d 2025  e0 = %d, ne1 = %
-00057c10: 642c 206e 6532 203d 2025 645c 6e22 2c20  d, ne2 = %d\n", 
-00057c20: 6473 742d 3e6e 655b 305d 2c20 6473 742d  dst->ne[0], dst-
-00057c30: 3e6e 655b 315d 2c20 6473 742d 3e6e 655b  >ne[1], dst->ne[
-00057c40: 325d 293b 0a20 2020 202f 2f69 6620 2866  2]);.    //if (f
-00057c50: 6972 7374 2920 7b0a 2020 2020 2f2f 2020  irst) {.    //  
-00057c60: 2020 6669 7273 7420 3d20 6661 6c73 653b    first = false;
-00057c70: 0a20 2020 202f 2f7d 2065 6c73 6520 7b0a  .    //} else {.
-00057c80: 2020 2020 2f2f 2020 2020 666f 7220 2869      //    for (i
-00057c90: 6e74 206b 203d 2030 3b20 6b20 3c20 6473  nt k = 0; k < ds
-00057ca0: 742d 3e6e 655b 315d 3b20 2b2b 6b29 207b  t->ne[1]; ++k) {
-00057cb0: 0a20 2020 202f 2f20 2020 2020 2020 2066  .    //        f
-00057cc0: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-00057cd0: 203c 2064 7374 2d3e 6e65 5b30 5d2f 3136   < dst->ne[0]/16
-00057ce0: 3b20 2b2b 6a29 207b 0a20 2020 202f 2f20  ; ++j) {.    // 
-00057cf0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00057d00: 696e 7420 6920 3d20 303b 2069 203c 2031  int i = 0; i < 1
-00057d10: 363b 202b 2b69 2920 7b0a 2020 2020 2f2f  6; ++i) {.    //
-00057d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057d30: 7072 696e 7466 2822 2538 2e34 6620 222c  printf("%8.4f ",
-00057d40: 2028 2866 6c6f 6174 202a 2920 6473 742d   ((float *) dst-
-00057d50: 3e64 6174 6129 5b6b 2a64 7374 2d3e 6e65  >data)[k*dst->ne
-00057d60: 5b30 5d20 2b20 6a2a 3136 202b 2069 5d29  [0] + j*16 + i])
-00057d70: 3b0a 2020 2020 2f2f 2020 2020 2020 2020  ;.    //        
-00057d80: 2020 2020 7d0a 2020 2020 2f2f 2020 2020      }.    //    
-00057d90: 2020 2020 2020 2020 7072 696e 7466 2822          printf("
-00057da0: 5c6e 2229 3b0a 2020 2020 2f2f 2020 2020  \n");.    //    
-00057db0: 2020 2020 7d0a 2020 2020 2f2f 2020 2020      }.    //    
-00057dc0: 2020 2020 7072 696e 7466 2822 5c6e 2229      printf("\n")
-00057dd0: 3b0a 2020 2020 2f2f 2020 2020 7d0a 2020  ;.    //    }.  
-00057de0: 2020 2f2f 2020 2020 7072 696e 7466 2822    //    printf("
-00057df0: 5c6e 2229 3b0a 2020 2020 2f2f 2020 2020  \n");.    //    
-00057e00: 6578 6974 2830 293b 0a20 2020 202f 2f7d  exit(0);.    //}
-00057e10: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
-00057e20: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
-00057e30: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00057e40: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00057e50: 7264 5f64 6961 675f 6633 3228 0a20 2020  rd_diag_f32(.   
-00057e60: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00057e70: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-00057e80: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00057e90: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00057ea0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00057eb0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00057ec0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00057ed0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00057ee0: 2047 474d 4c5f 4153 5345 5254 2870 6172   GGML_ASSERT(par
-00057ef0: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
-00057f00: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00057f10: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00057f20: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
-00057f30: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00057f40: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-00057f50: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-00057f60: 0a20 2020 207d 0a0a 2020 2020 2f2f 2054  .    }..    // T
-00057f70: 4f44 4f3a 2068 616e 646c 6520 7472 616e  ODO: handle tran
-00057f80: 7370 6f73 6564 2f70 6572 6d75 7465 6420  sposed/permuted 
-00057f90: 6d61 7472 6963 6573 0a0a 2020 2020 636f  matrices..    co
-00057fa0: 6e73 7420 696e 7420 6e65 3030 203d 2073  nst int ne00 = s
-00057fb0: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
-00057fc0: 636f 6e73 7420 696e 7420 6e65 3031 203d  const int ne01 =
-00057fd0: 2073 7263 302d 3e6e 655b 315d 3b0a 2020   src0->ne[1];.  
-00057fe0: 2020 636f 6e73 7420 696e 7420 6e65 3032    const int ne02
-00057ff0: 203d 2073 7263 302d 3e6e 655b 325d 3b0a   = src0->ne[2];.
-00058000: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-00058010: 3033 203d 2073 7263 302d 3e6e 655b 335d  03 = src0->ne[3]
-00058020: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00058030: 6e65 3020 3d20 6473 742d 3e6e 655b 305d  ne0 = dst->ne[0]
-00058040: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00058050: 6e65 3120 3d20 6473 742d 3e6e 655b 315d  ne1 = dst->ne[1]
-00058060: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00058070: 6e65 3220 3d20 6473 742d 3e6e 655b 325d  ne2 = dst->ne[2]
-00058080: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00058090: 6e65 3320 3d20 6473 742d 3e6e 655b 335d  ne3 = dst->ne[3]
-000580a0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-000580b0: 5428 6e65 3030 203d 3d20 6e65 3029 3b0a  T(ne00 == ne0);.
-000580c0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-000580d0: 6e65 3030 203d 3d20 6e65 3129 3b0a 2020  ne00 == ne1);.  
-000580e0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-000580f0: 3031 203d 3d20 3129 3b0a 2020 2020 4747  01 == 1);.    GG
-00058100: 4d4c 5f41 5353 4552 5428 6e65 3032 203d  ML_ASSERT(ne02 =
-00058110: 3d20 6e65 3229 3b0a 2020 2020 4747 4d4c  = ne2);.    GGML
-00058120: 5f41 5353 4552 5428 6e65 3033 203d 3d20  _ASSERT(ne03 == 
-00058130: 6e65 3329 3b0a 0a20 2020 2063 6f6e 7374  ne3);..    const
-00058140: 2069 6e74 206e 6230 3020 3d20 7372 6330   int nb00 = src0
-00058150: 2d3e 6e62 5b30 5d3b 0a20 2020 202f 2f63  ->nb[0];.    //c
-00058160: 6f6e 7374 2069 6e74 206e 6230 3120 3d20  onst int nb01 = 
-00058170: 7372 6330 2d3e 6e62 5b31 5d3b 0a20 2020  src0->nb[1];.   
-00058180: 2063 6f6e 7374 2069 6e74 206e 6230 3220   const int nb02 
-00058190: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
-000581a0: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-000581b0: 3320 3d20 7372 6330 2d3e 6e62 5b33 5d3b  3 = src0->nb[3];
-000581c0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-000581d0: 6230 203d 2064 7374 2d3e 6e62 5b30 5d3b  b0 = dst->nb[0];
-000581e0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-000581f0: 6231 203d 2064 7374 2d3e 6e62 5b31 5d3b  b1 = dst->nb[1];
-00058200: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00058210: 6232 203d 2064 7374 2d3e 6e62 5b32 5d3b  b2 = dst->nb[2];
-00058220: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00058230: 6233 203d 2064 7374 2d3e 6e62 5b33 5d3b  b3 = dst->nb[3];
-00058240: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00058250: 5428 6e62 3030 203d 3d20 7369 7a65 6f66  T(nb00 == sizeof
-00058260: 2866 6c6f 6174 2929 3b0a 2020 2020 4747  (float));.    GG
-00058270: 4d4c 5f41 5353 4552 5428 6e62 3020 203d  ML_ASSERT(nb0  =
-00058280: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-00058290: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-000582a0: 6933 203d 2030 3b20 6933 203c 206e 6533  i3 = 0; i3 < ne3
-000582b0: 3b20 6933 2b2b 2920 7b0a 2020 2020 2020  ; i3++) {.      
-000582c0: 2020 666f 7220 2869 6e74 2069 3220 3d20    for (int i2 = 
-000582d0: 303b 2069 3220 3c20 6e65 323b 2069 322b  0; i2 < ne2; i2+
-000582e0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-000582f0: 2066 6f72 2028 696e 7420 6931 203d 2030   for (int i1 = 0
-00058300: 3b20 6931 203c 206e 6531 3b20 6931 2b2b  ; i1 < ne1; i1++
-00058310: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00058320: 2020 2020 666c 6f61 7420 2a20 6420 3d20      float * d = 
-00058330: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
-00058340: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
-00058350: 6933 2a6e 6233 2020 2b20 6932 2a6e 6232  i3*nb3  + i2*nb2
-00058360: 202b 2069 312a 6e62 3129 3b0a 2020 2020   + i1*nb1);.    
-00058370: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-00058380: 7420 2a20 7320 3d20 2866 6c6f 6174 202a  t * s = (float *
-00058390: 2928 2863 6861 7220 2a29 2073 7263 302d  )((char *) src0-
-000583a0: 3e64 6174 6120 2b20 6933 2a6e 6230 3320  >data + i3*nb03 
-000583b0: 2b20 6932 2a6e 6230 3229 3b0a 2020 2020  + i2*nb02);.    
-000583c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000583d0: 2869 6e74 2069 3020 3d20 303b 2069 3020  (int i0 = 0; i0 
-000583e0: 3c20 6931 3b20 6930 2b2b 2920 7b0a 2020  < i1; i0++) {.  
-000583f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058400: 2020 645b 6930 5d20 3d20 303b 0a20 2020    d[i0] = 0;.   
-00058410: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00058420: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00058430: 5b69 315d 203d 2073 5b69 315d 3b0a 2020  [i1] = s[i1];.  
-00058440: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00058450: 7220 2869 6e74 2069 3020 3d20 6931 2b31  r (int i0 = i1+1
-00058460: 3b20 6930 203c 206e 6530 3b20 6930 2b2b  ; i0 < ne0; i0++
-00058470: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00058480: 2020 2020 2020 2020 645b 6930 5d20 3d20          d[i0] = 
-00058490: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-000584a0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000584b0: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
-000584c0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
-000584d0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-000584e0: 6f72 7761 7264 5f64 6961 6728 0a20 2020  orward_diag(.   
-000584f0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00058500: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-00058510: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00058520: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00058530: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00058540: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00058550: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00058560: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00058570: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-00058580: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-00058590: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-000585a0: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-000585b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000585c0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-000585d0: 7277 6172 645f 6469 6167 5f66 3332 2870  rward_diag_f32(p
-000585e0: 6172 616d 732c 2073 7263 302c 2064 7374  arams, src0, dst
-000585f0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00058600: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00058610: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-00058620: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00058630: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00058640: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-00058650: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00058660: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
-00058670: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00058680: 5f64 6961 675f 6d61 736b 5f69 6e66 0a0a  _diag_mask_inf..
-00058690: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-000586a0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000586b0: 5f64 6961 675f 6d61 736b 5f66 3332 280a  _diag_mask_f32(.
-000586c0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-000586d0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-000586e0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-000586f0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00058700: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00058710: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00058720: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00058730: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00058740: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
-00058750: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00058760: 2a20 6473 742c 0a20 2020 2020 2020 2063  * dst,.        c
-00058770: 6f6e 7374 2066 6c6f 6174 2076 616c 7565  onst float value
-00058780: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
-00058790: 4552 5428 7372 6331 2d3e 7479 7065 203d  ERT(src1->type =
-000587a0: 3d20 4747 4d4c 5f54 5950 455f 4933 3229  = GGML_TYPE_I32)
-000587b0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-000587c0: 5428 6767 6d6c 5f6e 656c 656d 656e 7473  T(ggml_nelements
-000587d0: 2873 7263 3129 203d 3d20 3229 3b0a 0a20  (src1) == 2);.. 
-000587e0: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-000587f0: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-00058800: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-00058810: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-00058820: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00058830: 206e 5f70 6173 7420 203d 2020 2020 2020   n_past  =      
-00058840: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-00058850: 6331 2d3e 6461 7461 295b 305d 3b0a 2020  c1->data)[0];.  
-00058860: 2020 636f 6e73 7420 626f 6f6c 2069 6e70    const bool inp
-00058870: 6c61 6365 203d 2028 626f 6f6c 2928 2869  lace = (bool)((i
-00058880: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-00058890: 6461 7461 295b 315d 3b0a 0a20 2020 2047  data)[1];..    G
-000588a0: 474d 4c5f 4153 5345 5254 286e 5f70 6173  GML_ASSERT(n_pas
-000588b0: 7420 3e3d 2030 293b 0a0a 2020 2020 6966  t >= 0);..    if
-000588c0: 2028 2169 6e70 6c61 6365 2026 2620 2870   (!inplace && (p
-000588d0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000588e0: 474d 4c5f 5441 534b 5f49 4e49 5429 2920  GML_TASK_INIT)) 
-000588f0: 7b0a 2020 2020 2020 2020 2f2f 206d 656d  {.        // mem
-00058900: 6370 7920 6e65 6564 7320 746f 2062 6520  cpy needs to be 
-00058910: 7379 6e63 6872 6f6e 697a 6564 2061 6372  synchronized acr
-00058920: 6f73 7320 7468 7265 6164 7320 746f 2061  oss threads to a
-00058930: 766f 6964 2072 6163 6520 636f 6e64 6974  void race condit
-00058940: 696f 6e73 2e0a 2020 2020 2020 2020 2f2f  ions..        //
-00058950: 203d 3e20 646f 2069 7420 696e 2049 4e49   => do it in INI
-00058960: 5420 7068 6173 650a 2020 2020 2020 2020  T phase.        
-00058970: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-00058980: 5f6e 656c 656d 656e 7473 2864 7374 2920  _nelements(dst) 
-00058990: 3d3d 2067 676d 6c5f 6e65 6c65 6d65 6e74  == ggml_nelement
-000589a0: 7328 7372 6330 2929 3b0a 2020 2020 2020  s(src0));.      
-000589b0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-000589c0: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-000589d0: 2864 7374 2920 2626 2067 676d 6c5f 6973  (dst) && ggml_is
-000589e0: 5f63 6f6e 7469 6775 6f75 7328 7372 6330  _contiguous(src0
-000589f0: 2929 3b0a 2020 2020 2020 2020 6d65 6d63  ));.        memc
-00058a00: 7079 280a 2020 2020 2020 2020 2020 2020  py(.            
-00058a10: 2828 6368 6172 202a 2920 2064 7374 2d3e  ((char *)  dst->
-00058a20: 6461 7461 292c 0a20 2020 2020 2020 2020  data),.         
-00058a30: 2020 2028 2863 6861 7220 2a29 2073 7263     ((char *) src
-00058a40: 302d 3e64 6174 6129 2c0a 2020 2020 2020  0->data),.      
-00058a50: 2020 2020 2020 6767 6d6c 5f6e 6279 7465        ggml_nbyte
-00058a60: 7328 6473 7429 293b 0a20 2020 207d 0a0a  s(dst));.    }..
-00058a70: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00058a80: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00058a90: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-00058aa0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00058ab0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-00058ac0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00058ad0: 2020 2020 7d0a 0a20 2020 202f 2f20 544f      }..    // TO
-00058ae0: 444f 3a20 6861 6e64 6c65 2074 7261 6e73  DO: handle trans
-00058af0: 706f 7365 642f 7065 726d 7574 6564 206d  posed/permuted m
-00058b00: 6174 7269 6365 730a 0a20 2020 2063 6f6e  atrices..    con
-00058b10: 7374 2069 6e74 206e 2020 3d20 6767 6d6c  st int n  = ggml
-00058b20: 5f6e 726f 7773 2873 7263 3029 3b0a 2020  _nrows(src0);.  
-00058b30: 2020 636f 6e73 7420 696e 7420 6e63 203d    const int nc =
-00058b40: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
-00058b50: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
-00058b60: 2073 7263 302d 3e6e 655b 315d 3b0a 2020   src0->ne[1];.  
-00058b70: 2020 636f 6e73 7420 696e 7420 6e7a 203d    const int nz =
-00058b80: 206e 2f6e 723b 0a0a 2020 2020 4747 4d4c   n/nr;..    GGML
-00058b90: 5f41 5353 4552 5428 2064 7374 2d3e 6e62  _ASSERT( dst->nb
-00058ba0: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
-00058bb0: 6f61 7429 293b 0a20 2020 2047 474d 4c5f  oat));.    GGML_
-00058bc0: 4153 5345 5254 2873 7263 302d 3e6e 625b  ASSERT(src0->nb[
-00058bd0: 305d 203d 3d20 7369 7a65 6f66 2866 6c6f  0] == sizeof(flo
-00058be0: 6174 2929 3b0a 0a20 2020 2066 6f72 2028  at));..    for (
-00058bf0: 696e 7420 6b20 3d20 303b 206b 203c 206e  int k = 0; k < n
-00058c00: 7a3b 206b 2b2b 2920 7b0a 2020 2020 2020  z; k++) {.      
-00058c10: 2020 666f 7220 2869 6e74 206a 203d 2069    for (int j = i
-00058c20: 7468 3b20 6a20 3c20 6e72 3b20 6a20 2b3d  th; j < nr; j +=
-00058c30: 206e 7468 2920 7b0a 2020 2020 2020 2020   nth) {.        
-00058c40: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00058c50: 206e 5f70 6173 743b 2069 203c 206e 633b   n_past; i < nc;
-00058c60: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-00058c70: 2020 2020 2020 2020 6966 2028 6920 3e20          if (i > 
-00058c80: 6e5f 7061 7374 202b 206a 2920 7b0a 2020  n_past + j) {.  
-00058c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058ca0: 2020 2a28 666c 6f61 7420 2a29 2828 6368    *(float *)((ch
-00058cb0: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
-00058cc0: 2b20 6b2a 6473 742d 3e6e 625b 325d 202b  + k*dst->nb[2] +
-00058cd0: 206a 2a64 7374 2d3e 6e62 5b31 5d20 2b20   j*dst->nb[1] + 
-00058ce0: 692a 6473 742d 3e6e 625b 305d 2920 3d20  i*dst->nb[0]) = 
-00058cf0: 7661 6c75 653b 0a20 2020 2020 2020 2020  value;.         
-00058d00: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00058d10: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00058d20: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-00058d30: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00058d40: 7465 5f66 6f72 7761 7264 5f64 6961 675f  te_forward_diag_
-00058d50: 6d61 736b 5f69 6e66 280a 2020 2020 2020  mask_inf(.      
-00058d60: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00058d70: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00058d80: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00058d90: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00058da0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00058db0: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00058dc0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00058dd0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00058de0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00058df0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-00058e00: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
-00058e10: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
-00058e20: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00058e30: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-00058e40: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00058e50: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00058e60: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
-00058e70: 5f6d 6173 6b5f 6633 3228 7061 7261 6d73  _mask_f32(params
-00058e80: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
-00058e90: 742c 202d 494e 4649 4e49 5459 293b 0a20  t, -INFINITY);. 
-00058ea0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00058eb0: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
-00058ec0: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-00058ed0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00058ee0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00058ef0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-00058f00: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00058f10: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-00058f20: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00058f30: 7277 6172 645f 6469 6167 5f6d 6173 6b5f  rward_diag_mask_
-00058f40: 7a65 726f 280a 2020 2020 2020 2020 636f  zero(.        co
-00058f50: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00058f60: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00058f70: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00058f80: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00058f90: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00058fa0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00058fb0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00058fc0: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
-00058fd0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00058fe0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-00058ff0: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
-00059000: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
-00059010: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00059020: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
-00059030: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00059040: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00059050: 666f 7277 6172 645f 6469 6167 5f6d 6173  forward_diag_mas
-00059060: 6b5f 6633 3228 7061 7261 6d73 2c20 7372  k_f32(params, sr
-00059070: 6330 2c20 7372 6331 2c20 6473 742c 2030  c0, src1, dst, 0
-00059080: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00059090: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000590a0: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-000590b0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-000590c0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-000590d0: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-000590e0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-000590f0: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
-00059100: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00059110: 5f73 6f66 745f 6d61 780a 0a73 7461 7469  _soft_max..stati
-00059120: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00059130: 7574 655f 666f 7277 6172 645f 736f 6674  ute_forward_soft
-00059140: 5f6d 6178 5f66 3332 280a 2020 2020 2020  _max_f32(.      
-00059150: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00059160: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00059170: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00059180: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00059190: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000591a0: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
-000591b0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000591c0: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
-000591d0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
-000591e0: 735f 636f 6e74 6967 756f 7573 2873 7263  s_contiguous(src
-000591f0: 3029 293b 0a20 2020 2047 474d 4c5f 4153  0));.    GGML_AS
-00059200: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
-00059210: 7469 6775 6f75 7328 6473 7429 293b 0a20  tiguous(dst));. 
-00059220: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-00059230: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
-00059240: 7065 2873 7263 302c 2064 7374 2929 3b0a  pe(src0, dst));.
-00059250: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00059260: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00059270: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
-00059280: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00059290: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-000592a0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-000592b0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2054  .    }..    // T
-000592c0: 4f44 4f3a 2068 616e 646c 6520 7472 616e  ODO: handle tran
-000592d0: 7370 6f73 6564 2f70 6572 6d75 7465 6420  sposed/permuted 
-000592e0: 6d61 7472 6963 6573 0a0a 2020 2020 636f  matrices..    co
-000592f0: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
-00059300: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
-00059310: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
-00059320: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
-00059330: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
-00059340: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
-00059350: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
-00059360: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
-00059370: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
-00059380: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
-00059390: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
-000593a0: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
-000593b0: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
-000593c0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
-000593d0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-000593e0: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
-000593f0: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
-00059400: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
-00059410: 206e 7229 3b0a 0a20 2020 2066 6f72 2028   nr);..    for (
-00059420: 696e 7420 6931 203d 2069 7230 3b20 6931  int i1 = ir0; i1
-00059430: 203c 2069 7231 3b20 6931 2b2b 2920 7b0a   < ir1; i1++) {.
-00059440: 2020 2020 2020 2020 666c 6f61 7420 2a73          float *s
-00059450: 7020 3d20 2866 6c6f 6174 202a 2928 2863  p = (float *)((c
-00059460: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-00059470: 6120 2b20 6931 2a73 7263 302d 3e6e 625b  a + i1*src0->nb[
-00059480: 315d 293b 0a20 2020 2020 2020 2066 6c6f  1]);.        flo
-00059490: 6174 202a 6470 203d 2028 666c 6f61 7420  at *dp = (float 
-000594a0: 2a29 2828 6368 6172 202a 2920 2064 7374  *)((char *)  dst
-000594b0: 2d3e 6461 7461 202b 2020 6931 2a64 7374  ->data +  i1*dst
-000594c0: 2d3e 6e62 5b31 5d29 3b0a 0a23 6966 6e64  ->nb[1]);..#ifnd
-000594d0: 6566 204e 4445 4255 470a 2020 2020 2020  ef NDEBUG.      
-000594e0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-000594f0: 3b20 6920 3c20 6e63 3b20 2b2b 6929 207b  ; i < nc; ++i) {
-00059500: 0a20 2020 2020 2020 2020 2020 202f 2f70  .            //p
-00059510: 7269 6e74 6628 2270 5b25 645d 203d 2025  rintf("p[%d] = %
-00059520: 665c 6e22 2c20 692c 2070 5b69 5d29 3b0a  f\n", i, p[i]);.
-00059530: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00059540: 7274 2821 6973 6e61 6e28 7370 5b69 5d29  rt(!isnan(sp[i])
-00059550: 293b 0a20 2020 2020 2020 207d 0a23 656e  );.        }.#en
-00059560: 6469 660a 0a20 2020 2020 2020 2066 6c6f  dif..        flo
-00059570: 6174 206d 6178 203d 202d 494e 4649 4e49  at max = -INFINI
-00059580: 5459 3b0a 2020 2020 2020 2020 6767 6d6c  TY;.        ggml
-00059590: 5f76 6563 5f6d 6178 5f66 3332 286e 632c  _vec_max_f32(nc,
-000595a0: 2026 6d61 782c 2073 7029 3b0a 0a20 2020   &max, sp);..   
-000595b0: 2020 2020 2067 676d 6c5f 666c 6f61 7420       ggml_float 
-000595c0: 7375 6d20 3d20 302e 303b 0a0a 2020 2020  sum = 0.0;..    
-000595d0: 2020 2020 7569 6e74 3136 5f74 2073 6376      uint16_t scv
-000595e0: 743b 0a20 2020 2020 2020 2066 6f72 2028  t;.        for (
-000595f0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-00059600: 633b 2069 2b2b 2920 7b0a 2020 2020 2020  c; i++) {.      
-00059610: 2020 2020 2020 6966 2028 7370 5b69 5d20        if (sp[i] 
-00059620: 3d3d 202d 494e 4649 4e49 5459 2920 7b0a  == -INFINITY) {.
-00059630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059640: 6470 5b69 5d20 3d20 302e 3066 3b0a 2020  dp[i] = 0.0f;.  
-00059650: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
-00059660: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00059670: 2020 202f 2f20 636f 6e73 7420 666c 6f61     // const floa
-00059680: 7420 7661 6c20 3d20 2873 705b 695d 203d  t val = (sp[i] =
-00059690: 3d20 2d49 4e46 494e 4954 5929 203f 2030  = -INFINITY) ? 0
-000596a0: 2e30 203a 2065 7870 2873 705b 695d 202d  .0 : exp(sp[i] -
-000596b0: 206d 6178 293b 0a20 2020 2020 2020 2020   max);.         
-000596c0: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
-000596d0: 5f74 2073 203d 2047 474d 4c5f 4650 3332  _t s = GGML_FP32
-000596e0: 5f54 4f5f 4650 3136 2873 705b 695d 202d  _TO_FP16(sp[i] -
-000596f0: 206d 6178 293b 0a20 2020 2020 2020 2020   max);.         
-00059700: 2020 2020 2020 206d 656d 6370 7928 2673         memcpy(&s
-00059710: 6376 742c 2026 732c 2073 697a 656f 6628  cvt, &s, sizeof(
-00059720: 7363 7674 2929 3b0a 2020 2020 2020 2020  scvt));.        
-00059730: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-00059740: 6f61 7420 7661 6c20 3d20 4747 4d4c 5f46  oat val = GGML_F
-00059750: 5031 365f 544f 5f46 5033 3228 7461 626c  P16_TO_FP32(tabl
-00059760: 655f 6578 705f 6631 365b 7363 7674 5d29  e_exp_f16[scvt])
-00059770: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00059780: 2020 7375 6d20 2b3d 2028 6767 6d6c 5f66    sum += (ggml_f
-00059790: 6c6f 6174 2976 616c 3b0a 2020 2020 2020  loat)val;.      
-000597a0: 2020 2020 2020 2020 2020 6470 5b69 5d20            dp[i] 
-000597b0: 3d20 7661 6c3b 0a20 2020 2020 2020 2020  = val;.         
-000597c0: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
-000597d0: 2020 2020 2020 2020 6173 7365 7274 2873          assert(s
-000597e0: 756d 203e 2030 2e30 293b 0a0a 2020 2020  um > 0.0);..    
-000597f0: 2020 2020 7375 6d20 3d20 312e 302f 7375      sum = 1.0/su
-00059800: 6d3b 0a20 2020 2020 2020 2067 676d 6c5f  m;.        ggml_
-00059810: 7665 635f 7363 616c 655f 6633 3228 6e63  vec_scale_f32(nc
-00059820: 2c20 6470 2c20 7375 6d29 3b0a 0a23 6966  , dp, sum);..#if
-00059830: 6e64 6566 204e 4445 4255 470a 2020 2020  ndef NDEBUG.    
-00059840: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00059850: 2030 3b20 6920 3c20 6e63 3b20 2b2b 6929   0; i < nc; ++i)
-00059860: 207b 0a20 2020 2020 2020 2020 2020 2061   {.            a
-00059870: 7373 6572 7428 2169 736e 616e 2864 705b  ssert(!isnan(dp[
-00059880: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
-00059890: 2020 6173 7365 7274 2821 6973 696e 6628    assert(!isinf(
-000598a0: 6470 5b69 5d29 293b 0a20 2020 2020 2020  dp[i]));.       
-000598b0: 207d 0a23 656e 6469 660a 2020 2020 7d0a   }.#endif.    }.
-000598c0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-000598d0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000598e0: 6172 645f 736f 6674 5f6d 6178 280a 2020  ard_soft_max(.  
-000598f0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00059900: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00059910: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00059920: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00059930: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00059940: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00059950: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00059960: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00059970: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
-00059980: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-00059990: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-000599a0: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
-000599b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000599c0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-000599d0: 6f72 7761 7264 5f73 6f66 745f 6d61 785f  orward_soft_max_
-000599e0: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
-000599f0: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-00059a00: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00059a10: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
-00059a20: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00059a30: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00059a40: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-00059a50: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00059a60: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
-00059a70: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00059a80: 7277 6172 645f 736f 6674 5f6d 6178 5f62  rward_soft_max_b
-00059a90: 6163 6b0a 0a73 7461 7469 6320 766f 6964  ack..static void
-00059aa0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00059ab0: 7277 6172 645f 736f 6674 5f6d 6178 5f62  rward_soft_max_b
-00059ac0: 6163 6b5f 6633 3228 0a20 2020 2020 2020  ack_f32(.       
-00059ad0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00059ae0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00059af0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00059b00: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00059b10: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00059b20: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
-00059b30: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00059b40: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
-00059b50: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00059b60: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-00059b70: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-00059b80: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-00059b90: 756f 7573 2873 7263 3029 293b 0a20 2020  uous(src0));.   
-00059ba0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-00059bb0: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
-00059bc0: 7372 6331 2929 3b0a 2020 2020 4747 4d4c  src1));.    GGML
-00059bd0: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
-00059be0: 636f 6e74 6967 756f 7573 2864 7374 2929  contiguous(dst))
-00059bf0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00059c00: 5428 6767 6d6c 5f61 7265 5f73 616d 655f  T(ggml_are_same_
-00059c10: 7368 6170 6528 7372 6330 2c20 6473 7429  shape(src0, dst)
-00059c20: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00059c30: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-00059c40: 5f73 6861 7065 2873 7263 312c 2064 7374  _shape(src1, dst
-00059c50: 2929 3b0a 0a20 2020 2069 6620 2870 6172  ));..    if (par
-00059c60: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00059c70: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-00059c80: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00059c90: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-00059ca0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00059cb0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00059cc0: 2f2f 2054 4f44 4f3a 2068 616e 646c 6520  // TODO: handle 
-00059cd0: 7472 616e 7370 6f73 6564 2f70 6572 6d75  transposed/permu
-00059ce0: 7465 6420 6d61 7472 6963 6573 0a0a 2020  ted matrices..  
-00059cf0: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
-00059d00: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
-00059d10: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
-00059d20: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
-00059d30: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00059d40: 6320 3d20 7372 6330 2d3e 6e65 5b30 5d3b  c = src0->ne[0];
-00059d50: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00059d60: 7220 3d20 6767 6d6c 5f6e 726f 7773 2873  r = ggml_nrows(s
-00059d70: 7263 3029 3b0a 0a20 2020 202f 2f20 726f  rc0);..    // ro
-00059d80: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
-00059d90: 2020 636f 6e73 7420 696e 7420 6472 203d    const int dr =
-00059da0: 2028 6e72 202b 206e 7468 202d 2031 292f   (nr + nth - 1)/
-00059db0: 6e74 683b 0a0a 2020 2020 2f2f 2072 6f77  nth;..    // row
-00059dc0: 2072 616e 6765 2066 6f72 2074 6869 7320   range for this 
-00059dd0: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-00059de0: 2069 6e74 2069 7230 203d 2064 722a 6974   int ir0 = dr*it
-00059df0: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-00059e00: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
-00059e10: 2064 722c 206e 7229 3b0a 0a20 2020 2066   dr, nr);..    f
-00059e20: 6f72 2028 696e 7420 6931 203d 2069 7230  or (int i1 = ir0
-00059e30: 3b20 6931 203c 2069 7231 3b20 6931 2b2b  ; i1 < ir1; i1++
-00059e40: 2920 7b0a 2020 2020 2020 2020 666c 6f61  ) {.        floa
-00059e50: 7420 2a64 7920 3d20 2866 6c6f 6174 202a  t *dy = (float *
-00059e60: 2928 2863 6861 7220 2a29 2073 7263 302d  )((char *) src0-
-00059e70: 3e64 6174 6120 2b20 6931 2a73 7263 302d  >data + i1*src0-
-00059e80: 3e6e 625b 315d 293b 0a20 2020 2020 2020  >nb[1]);.       
-00059e90: 2066 6c6f 6174 202a 7920 203d 2028 666c   float *y  = (fl
-00059ea0: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
-00059eb0: 7372 6331 2d3e 6461 7461 202b 2069 312a  src1->data + i1*
-00059ec0: 7372 6331 2d3e 6e62 5b31 5d29 3b0a 2020  src1->nb[1]);.  
-00059ed0: 2020 2020 2020 666c 6f61 7420 2a64 7820        float *dx 
-00059ee0: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
-00059ef0: 7220 2a29 2064 7374 2d3e 6461 7461 2020  r *) dst->data  
-00059f00: 2b20 6931 2a64 7374 2d3e 6e62 5b31 5d29  + i1*dst->nb[1])
-00059f10: 3b0a 0a23 6966 6e64 6566 204e 4445 4255  ;..#ifndef NDEBU
-00059f20: 470a 2020 2020 2020 2020 666f 7220 2869  G.        for (i
-00059f30: 6e74 2069 203d 2030 3b20 6920 3c20 6e63  nt i = 0; i < nc
-00059f40: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00059f50: 2020 2020 202f 2f70 7269 6e74 6628 2270       //printf("p
-00059f60: 5b25 645d 203d 2025 665c 6e22 2c20 692c  [%d] = %f\n", i,
-00059f70: 2070 5b69 5d29 3b0a 2020 2020 2020 2020   p[i]);.        
-00059f80: 2020 2020 6173 7365 7274 2821 6973 6e61      assert(!isna
-00059f90: 6e28 6479 5b69 5d29 293b 0a20 2020 2020  n(dy[i]));.     
-00059fa0: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
-00059fb0: 736e 616e 2879 5b69 5d29 293b 0a20 2020  snan(y[i]));.   
-00059fc0: 2020 2020 207d 0a23 656e 6469 660a 2020       }.#endif.  
-00059fd0: 2020 2020 2020 2f2f 204a 6969 203d 2079        // Jii = y
-00059fe0: 6920 2d20 7969 2a79 690a 2020 2020 2020  i - yi*yi.      
-00059ff0: 2020 2f2f 204a 696a 203d 202d 7969 2a79    // Jij = -yi*y
-0005a000: 6a0a 2020 2020 2020 2020 2f2f 204a 203d  j.        // J =
-0005a010: 2064 6961 6728 7929 2d79 2e54 2a79 0a20   diag(y)-y.T*y. 
-0005a020: 2020 2020 2020 202f 2f20 6478 203d 204a         // dx = J
-0005a030: 202a 2064 790a 2020 2020 2020 2020 2f2f   * dy.        //
-0005a040: 2064 786b 203d 2073 756d 5f69 284a 6b69   dxk = sum_i(Jki
-0005a050: 202a 2064 7969 290a 2020 2020 2020 2020   * dyi).        
-0005a060: 2f2f 2064 786b 203d 2073 756d 5f69 282d  // dxk = sum_i(-
-0005a070: 796b 2a79 6920 2a20 6479 6929 202d 2028  yk*yi * dyi) - (
-0005a080: 2d79 6b2a 796b 292a 6479 6b20 2b20 2879  -yk*yk)*dyk + (y
-0005a090: 6b20 2d20 796b 2a79 6b29 2a64 796b 0a20  k - yk*yk)*dyk. 
-0005a0a0: 2020 2020 2020 202f 2f20 6478 6b20 3d20         // dxk = 
-0005a0b0: 7375 6d5f 6928 2d79 6b2a 7969 202a 2064  sum_i(-yk*yi * d
-0005a0c0: 7969 2920 2b20 796b 2a64 796b 0a20 2020  yi) + yk*dyk.   
-0005a0d0: 2020 2020 202f 2f20 6478 6b20 3d20 2d79       // dxk = -y
-0005a0e0: 6b20 2a20 7375 6d5f 6928 7969 202a 2064  k * sum_i(yi * d
-0005a0f0: 7969 2920 2b20 796b 2a64 796b 0a20 2020  yi) + yk*dyk.   
-0005a100: 2020 2020 202f 2f20 6478 6b20 3d20 2d79       // dxk = -y
-0005a110: 6b20 2a20 646f 7428 792c 2064 7929 202b  k * dot(y, dy) +
-0005a120: 2079 6b2a 6479 6b0a 2020 2020 2020 2020   yk*dyk.        
-0005a130: 2f2f 2064 786b 203d 2079 6b20 2a20 282d  // dxk = yk * (-
-0005a140: 2064 6f74 2879 2c20 6479 2920 2b20 6479   dot(y, dy) + dy
-0005a150: 6b29 0a20 2020 2020 2020 202f 2f20 6478  k).        // dx
-0005a160: 6b20 3d20 796b 202a 2028 6479 6b20 2d20  k = yk * (dyk - 
-0005a170: 646f 7428 792c 2064 7929 290a 2020 2020  dot(y, dy)).    
-0005a180: 2020 2020 2f2f 0a20 2020 2020 2020 202f      //.        /
-0005a190: 2f20 706f 7374 2d6f 7264 6572 3a0a 2020  / post-order:.  
-0005a1a0: 2020 2020 2020 2f2f 2064 6f74 5f79 5f64        // dot_y_d
-0005a1b0: 7920 3a3d 2064 6f74 2879 2c20 6479 290a  y := dot(y, dy).
-0005a1c0: 2020 2020 2020 2020 2f2f 2064 7820 3a3d          // dx :=
-0005a1d0: 2064 790a 2020 2020 2020 2020 2f2f 2064   dy.        // d
-0005a1e0: 7820 3a3d 2064 7820 2d20 646f 745f 795f  x := dx - dot_y_
-0005a1f0: 6479 0a20 2020 2020 2020 202f 2f20 6478  dy.        // dx
-0005a200: 203a 3d20 6478 202a 2079 0a0a 2020 2020   := dx * y..    
-0005a210: 2020 2020 2f2f 206c 696e 6561 7220 7275      // linear ru
-0005a220: 6e74 696d 652c 206e 6f20 6164 6469 7469  ntime, no additi
-0005a230: 6f6e 616c 206d 656d 6f72 790a 2020 2020  onal memory.    
-0005a240: 2020 2020 666c 6f61 7420 646f 745f 795f      float dot_y_
-0005a250: 6479 203d 2030 3b0a 2020 2020 2020 2020  dy = 0;.        
-0005a260: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3332  ggml_vec_dot_f32
-0005a270: 2028 6e63 2c20 2664 6f74 5f79 5f64 792c   (nc, &dot_y_dy,
-0005a280: 2079 2c20 6479 293b 0a20 2020 2020 2020   y, dy);.       
-0005a290: 2067 676d 6c5f 7665 635f 6370 795f 6633   ggml_vec_cpy_f3
-0005a2a0: 3220 286e 632c 2064 782c 2064 7929 3b0a  2 (nc, dx, dy);.
-0005a2b0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0005a2c0: 5f61 6363 315f 6633 3228 6e63 2c20 6478  _acc1_f32(nc, dx
-0005a2d0: 2c20 2d64 6f74 5f79 5f64 7929 3b0a 2020  , -dot_y_dy);.  
-0005a2e0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
-0005a2f0: 756c 5f66 3332 2028 6e63 2c20 6478 2c20  ul_f32 (nc, dx, 
-0005a300: 6478 2c20 7929 3b0a 0a23 6966 6e64 6566  dx, y);..#ifndef
-0005a310: 204e 4445 4255 470a 2020 2020 2020 2020   NDEBUG.        
-0005a320: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0005a330: 6920 3c20 6e63 3b20 2b2b 6929 207b 0a20  i < nc; ++i) {. 
-0005a340: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0005a350: 7428 2169 736e 616e 2864 785b 695d 2929  t(!isnan(dx[i]))
-0005a360: 3b0a 2020 2020 2020 2020 2020 2020 6173  ;.            as
-0005a370: 7365 7274 2821 6973 696e 6628 6478 5b69  sert(!isinf(dx[i
-0005a380: 5d29 293b 0a20 2020 2020 2020 207d 0a23  ]));.        }.#
-0005a390: 656e 6469 660a 2020 2020 7d0a 7d0a 0a73  endif.    }.}..s
-0005a3a0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0005a3b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0005a3c0: 736f 6674 5f6d 6178 5f62 6163 6b28 0a20  soft_max_back(. 
-0005a3d0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0005a3e0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-0005a3f0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-0005a400: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-0005a410: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0005a420: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-0005a430: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0005a440: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-0005a450: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
-0005a460: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0005a470: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
-0005a480: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-0005a490: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-0005a4a0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
-0005a4b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0005a4c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0005a4d0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0005a4e0: 5f73 6f66 745f 6d61 785f 6261 636b 5f66  _soft_max_back_f
-0005a4f0: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-0005a500: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-0005a510: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0005a520: 3b0a 2020 2020 2020 2020 6465 6661 756c  ;.        defaul
-0005a530: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
-0005a540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005a550: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-0005a560: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-0005a570: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-0005a580: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-0005a590: 7465 5f66 6f72 7761 7264 5f61 6c69 6269  te_forward_alibi
-0005a5a0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-0005a5b0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0005a5c0: 7264 5f61 6c69 6269 5f66 3332 280a 2020  rd_alibi_f32(.  
-0005a5d0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0005a5e0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-0005a5f0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-0005a600: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0005a610: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0005a620: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-0005a630: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005a640: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-0005a650: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
-0005a660: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005a670: 6473 7429 207b 0a20 2020 2061 7373 6572  dst) {.    asser
-0005a680: 7428 7061 7261 6d73 2d3e 6974 6820 3d3d  t(params->ith ==
-0005a690: 2030 293b 0a20 2020 2061 7373 6572 7428   0);.    assert(
-0005a6a0: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-0005a6b0: 4d4c 5f54 5950 455f 4933 3229 3b0a 2020  ML_TYPE_I32);.  
-0005a6c0: 2020 6173 7365 7274 2867 676d 6c5f 6e65    assert(ggml_ne
-0005a6d0: 6c65 6d65 6e74 7328 7372 6331 2920 3d3d  lements(src1) ==
-0005a6e0: 2033 293b 0a0a 2020 2020 6966 2028 7061   3);..    if (pa
-0005a6f0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-0005a700: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-0005a710: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-0005a720: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-0005a730: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-0005a740: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-0005a750: 2063 6f6e 7374 2069 6e74 2020 206e 5f70   const int   n_p
-0005a760: 6173 7420 2020 3d20 2828 696e 7433 325f  ast   = ((int32_
-0005a770: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
-0005a780: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-0005a790: 6e74 2020 206e 5f68 6561 6420 2020 3d20  nt   n_head   = 
-0005a7a0: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
-0005a7b0: 312d 3e64 6174 6129 5b31 5d3b 0a20 2020  1->data)[1];.   
-0005a7c0: 2063 6f6e 7374 2066 6c6f 6174 206d 6178   const float max
-0005a7d0: 5f62 6961 7320 3d20 2828 666c 6f61 7420  _bias = ((float 
-0005a7e0: 2a29 2020 2073 7263 312d 3e64 6174 6129  *)   src1->data)
-0005a7f0: 5b32 5d3b 0a0a 2020 2020 6173 7365 7274  [2];..    assert
-0005a800: 286e 5f70 6173 7420 3e3d 2030 293b 0a0a  (n_past >= 0);..
+000561a0: 3b0a 0a20 2020 2061 7373 6572 7428 2064  ;..    assert( d
+000561b0: 7374 2d3e 6e65 5b30 5d20 3d3d 206e 6329  st->ne[0] == nc)
+000561c0: 3b0a 2020 2020 6173 7365 7274 2820 6473  ;.    assert( ds
+000561d0: 742d 3e6e 655b 315d 203d 3d20 6e72 293b  t->ne[1] == nr);
+000561e0: 0a20 2020 2061 7373 6572 7428 7372 6330  .    assert(src0
+000561f0: 2d3e 6e62 5b30 5d20 3d3d 2047 474d 4c5f  ->nb[0] == GGML_
+00056200: 5459 5045 5f53 495a 455b 7479 7065 5d29  TYPE_SIZE[type])
+00056210: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+00056220: 6920 3d20 303b 2069 203c 206e 723b 202b  i = 0; i < nr; +
+00056230: 2b69 2920 7b0a 2020 2020 2020 2020 636f  +i) {.        co
+00056240: 6e73 7420 696e 7420 7220 3d20 2828 696e  nst int r = ((in
+00056250: 7433 325f 7420 2a29 2073 7263 312d 3e64  t32_t *) src1->d
+00056260: 6174 6129 5b69 5d3b 0a0a 2020 2020 2020  ata)[i];..      
+00056270: 2020 6465 7175 616e 7469 7a65 5f72 6f77    dequantize_row
+00056280: 5f71 280a 2020 2020 2020 2020 2020 2020  _q(.            
+00056290: 2020 2020 2863 6f6e 7374 2076 6f69 6420      (const void 
+000562a0: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+000562b0: 302d 3e64 6174 6120 2b20 722a 7372 6330  0->data + r*src0
+000562c0: 2d3e 6e62 5b31 5d29 2c0a 2020 2020 2020  ->nb[1]),.      
+000562d0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+000562e0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+000562f0: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
+00056300: 692a 6473 742d 3e6e 625b 315d 292c 206e  i*dst->nb[1]), n
+00056310: 6329 3b0a 2020 2020 7d0a 7d0a 0a73 7461  c);.    }.}..sta
+00056320: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00056330: 6d70 7574 655f 666f 7277 6172 645f 6765  mpute_forward_ge
+00056340: 745f 726f 7773 5f66 3136 280a 2020 2020  t_rows_f16(.    
+00056350: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00056360: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00056370: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00056380: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00056390: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000563a0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+000563b0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000563c0: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+000563d0: 0a20 2020 2020 2020 2020 2020 2020 2073  .              s
+000563e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000563f0: 7220 2a20 6473 7429 207b 0a20 2020 2061  r * dst) {.    a
+00056400: 7373 6572 7428 7061 7261 6d73 2d3e 6974  ssert(params->it
+00056410: 6820 3d3d 2030 293b 0a0a 2020 2020 6966  h == 0);..    if
+00056420: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00056430: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00056440: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+00056450: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00056460: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00056470: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00056480: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00056490: 6320 3d20 7372 6330 2d3e 6e65 5b30 5d3b  c = src0->ne[0];
+000564a0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000564b0: 7220 3d20 6767 6d6c 5f6e 656c 656d 656e  r = ggml_nelemen
+000564c0: 7473 2873 7263 3129 3b0a 0a20 2020 2061  ts(src1);..    a
+000564d0: 7373 6572 7428 2064 7374 2d3e 6e65 5b30  ssert( dst->ne[0
+000564e0: 5d20 3d3d 206e 6329 3b0a 2020 2020 6173  ] == nc);.    as
+000564f0: 7365 7274 2820 6473 742d 3e6e 655b 315d  sert( dst->ne[1]
+00056500: 203d 3d20 6e72 293b 0a20 2020 2061 7373   == nr);.    ass
+00056510: 6572 7428 7372 6330 2d3e 6e62 5b30 5d20  ert(src0->nb[0] 
+00056520: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
+00056530: 7031 365f 7429 293b 0a0a 2020 2020 666f  p16_t));..    fo
+00056540: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00056550: 3c20 6e72 3b20 2b2b 6929 207b 0a20 2020  < nr; ++i) {.   
+00056560: 2020 2020 2063 6f6e 7374 2069 6e74 2072       const int r
+00056570: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
+00056580: 7372 6331 2d3e 6461 7461 295b 695d 3b0a  src1->data)[i];.
+00056590: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+000565a0: 7420 6a20 3d20 303b 206a 203c 206e 633b  t j = 0; j < nc;
+000565b0: 202b 2b6a 2920 7b0a 2020 2020 2020 2020   ++j) {.        
+000565c0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
+000565d0: 7620 3d20 2828 6767 6d6c 5f66 7031 365f  v = ((ggml_fp16_
+000565e0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+000565f0: 7263 302d 3e64 6174 6120 2b20 722a 7372  rc0->data + r*sr
+00056600: 6330 2d3e 6e62 5b31 5d29 295b 6a5d 3b0a  c0->nb[1]))[j];.
+00056610: 2020 2020 2020 2020 2020 2020 2828 666c              ((fl
+00056620: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+00056630: 2020 6473 742d 3e64 6174 6120 2b20 692a    dst->data + i*
+00056640: 6473 742d 3e6e 625b 315d 2929 5b6a 5d20  dst->nb[1]))[j] 
+00056650: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
+00056660: 5033 3228 7629 3b0a 2020 2020 2020 2020  P32(v);.        
+00056670: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
+00056680: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+00056690: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
+000566a0: 726f 7773 5f66 3332 280a 2020 2020 2020  rows_f32(.      
+000566b0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000566c0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000566d0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+000566e0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000566f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00056700: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+00056710: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00056720: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+00056730: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00056740: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00056750: 2a20 6473 7429 207b 0a20 2020 2061 7373  * dst) {.    ass
+00056760: 6572 7428 7061 7261 6d73 2d3e 6974 6820  ert(params->ith 
+00056770: 3d3d 2030 293b 0a0a 2020 2020 6966 2028  == 0);..    if (
+00056780: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00056790: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
+000567a0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
+000567b0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+000567c0: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+000567d0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+000567e0: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
+000567f0: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
+00056800: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
+00056810: 3d20 6767 6d6c 5f6e 656c 656d 656e 7473  = ggml_nelements
+00056820: 2873 7263 3129 3b0a 0a20 2020 2061 7373  (src1);..    ass
+00056830: 6572 7428 2064 7374 2d3e 6e65 5b30 5d20  ert( dst->ne[0] 
+00056840: 3d3d 206e 6329 3b0a 2020 2020 6173 7365  == nc);.    asse
+00056850: 7274 2820 6473 742d 3e6e 655b 315d 203d  rt( dst->ne[1] =
+00056860: 3d20 6e72 293b 0a20 2020 2061 7373 6572  = nr);.    asser
+00056870: 7428 7372 6330 2d3e 6e62 5b30 5d20 3d3d  t(src0->nb[0] ==
+00056880: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00056890: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+000568a0: 203d 2030 3b20 6920 3c20 6e72 3b20 2b2b   = 0; i < nr; ++
+000568b0: 6929 207b 0a20 2020 2020 2020 2063 6f6e  i) {.        con
+000568c0: 7374 2069 6e74 2072 203d 2028 2869 6e74  st int r = ((int
+000568d0: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
+000568e0: 7461 295b 695d 3b0a 0a20 2020 2020 2020  ta)[i];..       
+000568f0: 2067 676d 6c5f 7665 635f 6370 795f 6633   ggml_vec_cpy_f3
+00056900: 3228 6e63 2c0a 2020 2020 2020 2020 2020  2(nc,.          
+00056910: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+00056920: 2828 6368 6172 202a 2920 2064 7374 2d3e  ((char *)  dst->
+00056930: 6461 7461 202b 2069 2a64 7374 2d3e 6e62  data + i*dst->nb
+00056940: 5b31 5d29 2c0a 2020 2020 2020 2020 2020  [1]),.          
+00056950: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+00056960: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+00056970: 6461 7461 202b 2072 2a73 7263 302d 3e6e  data + r*src0->n
+00056980: 625b 315d 2929 3b0a 2020 2020 7d0a 7d0a  b[1]));.    }.}.
+00056990: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+000569a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000569b0: 645f 6765 745f 726f 7773 280a 2020 2020  d_get_rows(.    
+000569c0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000569d0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+000569e0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+000569f0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00056a00: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00056a10: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+00056a20: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00056a30: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+00056a40: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00056a50: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00056a60: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+00056a70: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+00056a80: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00056a90: 5f54 5950 455f 5134 5f30 3a0a 2020 2020  _TYPE_Q4_0:.    
+00056aa0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00056ab0: 5045 5f51 345f 313a 0a20 2020 2020 2020  PE_Q4_1:.       
+00056ac0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00056ad0: 5135 5f30 3a0a 2020 2020 2020 2020 6361  Q5_0:.        ca
+00056ae0: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
+00056af0: 313a 0a20 2020 2020 2020 2063 6173 6520  1:.        case 
+00056b00: 4747 4d4c 5f54 5950 455f 5138 5f30 3a0a  GGML_TYPE_Q8_0:.
+00056b10: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00056b20: 4c5f 5459 5045 5f51 385f 313a 0a20 2020  L_TYPE_Q8_1:.   
+00056b30: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00056b40: 5950 455f 5132 5f4b 3a0a 2020 2020 2020  YPE_Q2_K:.      
+00056b50: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00056b60: 5f51 335f 4b3a 0a20 2020 2020 2020 2063  _Q3_K:.        c
+00056b70: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
+00056b80: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
+00056b90: 2047 474d 4c5f 5459 5045 5f51 355f 4b3a   GGML_TYPE_Q5_K:
+00056ba0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00056bb0: 4d4c 5f54 5950 455f 5136 5f4b 3a0a 2020  ML_TYPE_Q6_K:.  
+00056bc0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00056bd0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00056be0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00056bf0: 5f67 6574 5f72 6f77 735f 7128 7061 7261  _get_rows_q(para
+00056c00: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+00056c10: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+00056c20: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00056c30: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00056c40: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
+00056c50: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00056c60: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00056c70: 655f 666f 7277 6172 645f 6765 745f 726f  e_forward_get_ro
+00056c80: 7773 5f66 3136 2870 6172 616d 732c 2073  ws_f16(params, s
+00056c90: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
+00056ca0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00056cb0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00056cc0: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
+00056cd0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00056ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00056cf0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00056d00: 7761 7264 5f67 6574 5f72 6f77 735f 6633  ward_get_rows_f3
+00056d10: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+00056d20: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+00056d30: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00056d40: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+00056d50: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00056d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00056d70: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00056d80: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00056d90: 7d20 6272 6561 6b3b 0a20 2020 207d 0a0a  } break;.    }..
+00056da0: 2020 2020 2f2f 7374 6174 6963 2062 6f6f      //static boo
+00056db0: 6c20 6669 7273 7420 3d20 7472 7565 3b0a  l first = true;.
+00056dc0: 2020 2020 2f2f 7072 696e 7466 2822 6e65      //printf("ne
+00056dd0: 3020 3d20 2564 2c20 6e65 3120 3d20 2564  0 = %d, ne1 = %d
+00056de0: 2c20 6e65 3220 3d20 2564 5c6e 222c 2064  , ne2 = %d\n", d
+00056df0: 7374 2d3e 6e65 5b30 5d2c 2064 7374 2d3e  st->ne[0], dst->
+00056e00: 6e65 5b31 5d2c 2064 7374 2d3e 6e65 5b32  ne[1], dst->ne[2
+00056e10: 5d29 3b0a 2020 2020 2f2f 6966 2028 6669  ]);.    //if (fi
+00056e20: 7273 7429 207b 0a20 2020 202f 2f20 2020  rst) {.    //   
+00056e30: 2066 6972 7374 203d 2066 616c 7365 3b0a   first = false;.
+00056e40: 2020 2020 2f2f 7d20 656c 7365 207b 0a20      //} else {. 
+00056e50: 2020 202f 2f20 2020 2066 6f72 2028 696e     //    for (in
+00056e60: 7420 6b20 3d20 303b 206b 203c 2064 7374  t k = 0; k < dst
+00056e70: 2d3e 6e65 5b31 5d3b 202b 2b6b 2920 7b0a  ->ne[1]; ++k) {.
+00056e80: 2020 2020 2f2f 2020 2020 2020 2020 666f      //        fo
+00056e90: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+00056ea0: 3c20 6473 742d 3e6e 655b 305d 2f31 363b  < dst->ne[0]/16;
+00056eb0: 202b 2b6a 2920 7b0a 2020 2020 2f2f 2020   ++j) {.    //  
+00056ec0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00056ed0: 6e74 2069 203d 2030 3b20 6920 3c20 3136  nt i = 0; i < 16
+00056ee0: 3b20 2b2b 6929 207b 0a20 2020 202f 2f20  ; ++i) {.    // 
+00056ef0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00056f00: 7269 6e74 6628 2225 382e 3466 2022 2c20  rintf("%8.4f ", 
+00056f10: 2828 666c 6f61 7420 2a29 2064 7374 2d3e  ((float *) dst->
+00056f20: 6461 7461 295b 6b2a 6473 742d 3e6e 655b  data)[k*dst->ne[
+00056f30: 305d 202b 206a 2a31 3620 2b20 695d 293b  0] + j*16 + i]);
+00056f40: 0a20 2020 202f 2f20 2020 2020 2020 2020  .    //         
+00056f50: 2020 207d 0a20 2020 202f 2f20 2020 2020     }.    //     
+00056f60: 2020 2020 2020 2070 7269 6e74 6628 225c         printf("\
+00056f70: 6e22 293b 0a20 2020 202f 2f20 2020 2020  n");.    //     
+00056f80: 2020 207d 0a20 2020 202f 2f20 2020 2020     }.    //     
+00056f90: 2020 2070 7269 6e74 6628 225c 6e22 293b     printf("\n");
+00056fa0: 0a20 2020 202f 2f20 2020 207d 0a20 2020  .    //    }.   
+00056fb0: 202f 2f20 2020 2070 7269 6e74 6628 225c   //    printf("\
+00056fc0: 6e22 293b 0a20 2020 202f 2f20 2020 2065  n");.    //    e
+00056fd0: 7869 7428 3029 3b0a 2020 2020 2f2f 7d0a  xit(0);.    //}.
+00056fe0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00056ff0: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
+00057000: 6f77 735f 6261 636b 0a0a 7374 6174 6963  ows_back..static
+00057010: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00057020: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
+00057030: 6f77 735f 6261 636b 5f66 3332 5f66 3136  ows_back_f32_f16
+00057040: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00057050: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00057060: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00057070: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00057080: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00057090: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+000570a0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000570b0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000570c0: 2073 7263 312c 0a20 2020 2020 2020 2063   src1,.        c
+000570d0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+000570e0: 5f74 656e 736f 7220 2a20 6f70 7430 2c0a  _tensor * opt0,.
+000570f0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00057100: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00057110: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
+00057120: 4d4c 5f41 5353 4552 5428 7061 7261 6d73  ML_ASSERT(params
+00057130: 2d3e 6974 6820 3d3d 2030 293b 0a20 2020  ->ith == 0);.   
+00057140: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00057150: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
+00057160: 286f 7074 302c 2064 7374 2929 3b0a 2020  (opt0, dst));.  
+00057170: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+00057180: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
+00057190: 286f 7074 3029 293b 0a20 2020 2047 474d  (opt0));.    GGM
+000571a0: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
+000571b0: 5f63 6f6e 7469 6775 6f75 7328 6473 7429  _contiguous(dst)
+000571c0: 293b 0a0a 2020 2020 6767 6d6c 5f63 6f6d  );..    ggml_com
+000571d0: 7075 7465 5f66 6f72 7761 7264 5f64 7570  pute_forward_dup
+000571e0: 5f73 616d 655f 636f 6e74 2870 6172 616d  _same_cont(param
+000571f0: 732c 206f 7074 302c 2064 7374 293b 0a0a  s, opt0, dst);..
+00057200: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+00057210: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00057220: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
+00057230: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00057240: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+00057250: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00057260: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
+00057270: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
+00057280: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+00057290: 2069 6e74 206e 7220 3d20 6767 6d6c 5f6e   int nr = ggml_n
+000572a0: 656c 656d 656e 7473 2873 7263 3129 3b0a  elements(src1);.
+000572b0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000572c0: 2820 6473 742d 3e6e 655b 305d 203d 3d20  ( dst->ne[0] == 
+000572d0: 6e63 293b 0a20 2020 2047 474d 4c5f 4153  nc);.    GGML_AS
+000572e0: 5345 5254 2873 7263 302d 3e6e 625b 305d  SERT(src0->nb[0]
+000572f0: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
+00057300: 6670 3136 5f74 2929 3b0a 0a20 2020 2066  fp16_t));..    f
+00057310: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00057320: 203c 206e 723b 202b 2b69 2920 7b0a 2020   < nr; ++i) {.  
+00057330: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00057340: 7220 3d20 2828 696e 7433 325f 7420 2a29  r = ((int32_t *)
+00057350: 2073 7263 312d 3e64 6174 6129 5b69 5d3b   src1->data)[i];
+00057360: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
+00057370: 6e74 206a 203d 2030 3b20 6a20 3c20 6e63  nt j = 0; j < nc
+00057380: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
+00057390: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+000573a0: 2076 203d 2028 2867 676d 6c5f 6670 3136   v = ((ggml_fp16
+000573b0: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
+000573c0: 7372 6330 2d3e 6461 7461 202b 2069 2a73  src0->data + i*s
+000573d0: 7263 302d 3e6e 625b 315d 2929 5b6a 5d3b  rc0->nb[1]))[j];
+000573e0: 0a20 2020 2020 2020 2020 2020 2028 2866  .            ((f
+000573f0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00057400: 2920 6473 742d 3e64 6174 6120 2b20 722a  ) dst->data + r*
+00057410: 6473 742d 3e6e 625b 315d 2929 5b6a 5d20  dst->nb[1]))[j] 
+00057420: 2b3d 2047 474d 4c5f 4650 3136 5f54 4f5f  += GGML_FP16_TO_
+00057430: 4650 3332 2876 293b 0a20 2020 2020 2020  FP32(v);.       
+00057440: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
+00057450: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00057460: 7075 7465 5f66 6f72 7761 7264 5f67 6574  pute_forward_get
+00057470: 5f72 6f77 735f 6261 636b 5f66 3332 280a  _rows_back_f32(.
+00057480: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00057490: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+000574a0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+000574b0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+000574c0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000574d0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+000574e0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000574f0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00057500: 7263 312c 0a20 2020 2020 2020 2063 6f6e  rc1,.        con
+00057510: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00057520: 656e 736f 7220 2a20 6f70 7430 2c0a 2020  ensor * opt0,.  
+00057530: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+00057540: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00057550: 2064 7374 2920 7b0a 2020 2020 4747 4d4c   dst) {.    GGML
+00057560: 5f41 5353 4552 5428 7061 7261 6d73 2d3e  _ASSERT(params->
+00057570: 6974 6820 3d3d 2030 293b 0a20 2020 2047  ith == 0);.    G
+00057580: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+00057590: 6172 655f 7361 6d65 5f73 6861 7065 286f  are_same_shape(o
+000575a0: 7074 302c 2064 7374 2929 3b0a 2020 2020  pt0, dst));.    
+000575b0: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
+000575c0: 5f69 735f 636f 6e74 6967 756f 7573 286f  _is_contiguous(o
+000575d0: 7074 3029 293b 0a20 2020 2047 474d 4c5f  pt0));.    GGML_
+000575e0: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
+000575f0: 6f6e 7469 6775 6f75 7328 6473 7429 293b  ontiguous(dst));
+00057600: 0a0a 2020 2020 2f2f 2067 676d 6c5f 636f  ..    // ggml_co
+00057610: 6d70 7574 655f 666f 7277 6172 645f 6475  mpute_forward_du
+00057620: 705f 7361 6d65 5f63 6f6e 7428 7061 7261  p_same_cont(para
+00057630: 6d73 2c20 6f70 7430 2c20 6473 7429 3b0a  ms, opt0, dst);.
+00057640: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00057650: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00057660: 534b 5f49 4e49 5429 207b 0a20 2020 2020  SK_INIT) {.     
+00057670: 2020 206d 656d 7365 7428 6473 742d 3e64     memset(dst->d
+00057680: 6174 612c 2030 2c20 6767 6d6c 5f6e 6279  ata, 0, ggml_nby
+00057690: 7465 7328 6473 7429 293b 0a20 2020 207d  tes(dst));.    }
+000576a0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+000576b0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+000576c0: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
+000576d0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+000576e0: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+000576f0: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+00057700: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
+00057710: 7374 2069 6e74 206e 6320 3d20 7372 6330  st int nc = src0
+00057720: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00057730: 7374 2069 6e74 206e 7220 3d20 6767 6d6c  st int nr = ggml
+00057740: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
+00057750: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00057760: 5254 2820 6473 742d 3e6e 655b 305d 203d  RT( dst->ne[0] =
+00057770: 3d20 6e63 293b 0a20 2020 2047 474d 4c5f  = nc);.    GGML_
+00057780: 4153 5345 5254 2873 7263 302d 3e6e 625b  ASSERT(src0->nb[
+00057790: 305d 203d 3d20 7369 7a65 6f66 2866 6c6f  0] == sizeof(flo
+000577a0: 6174 2929 3b0a 0a20 2020 2066 6f72 2028  at));..    for (
+000577b0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
+000577c0: 723b 202b 2b69 2920 7b0a 2020 2020 2020  r; ++i) {.      
+000577d0: 2020 636f 6e73 7420 696e 7420 7220 3d20    const int r = 
+000577e0: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+000577f0: 312d 3e64 6174 6129 5b69 5d3b 0a0a 2020  1->data)[i];..  
+00057800: 2020 2020 2020 6767 6d6c 5f76 6563 5f61        ggml_vec_a
+00057810: 6464 5f66 3332 286e 632c 0a20 2020 2020  dd_f32(nc,.     
+00057820: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00057830: 7420 2a29 2028 2863 6861 7220 2a29 2020  t *) ((char *)  
+00057840: 6473 742d 3e64 6174 6120 2b20 722a 6473  dst->data + r*ds
+00057850: 742d 3e6e 625b 315d 292c 0a20 2020 2020  t->nb[1]),.     
+00057860: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00057870: 7420 2a29 2028 2863 6861 7220 2a29 2020  t *) ((char *)  
+00057880: 6473 742d 3e64 6174 6120 2b20 722a 6473  dst->data + r*ds
+00057890: 742d 3e6e 625b 315d 292c 0a20 2020 2020  t->nb[1]),.     
+000578a0: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+000578b0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+000578c0: 7263 302d 3e64 6174 6120 2b20 692a 7372  rc0->data + i*sr
+000578d0: 6330 2d3e 6e62 5b31 5d29 293b 0a20 2020  c0->nb[1]));.   
+000578e0: 207d 0a7d 0a0a 0a73 7461 7469 6320 766f   }.}...static vo
+000578f0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+00057900: 666f 7277 6172 645f 6765 745f 726f 7773  forward_get_rows
+00057910: 5f62 6163 6b28 0a20 2020 2020 2020 2063  _back(.        c
+00057920: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00057930: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+00057940: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+00057950: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00057960: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00057970: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
+00057980: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00057990: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
+000579a0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000579b0: 2067 676d 6c5f 7465 6e73 6f72 202a 206f   ggml_tensor * o
+000579c0: 7074 302c 0a20 2020 2020 2020 2073 7472  pt0,.        str
+000579d0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000579e0: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
+000579f0: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
+00057a00: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+00057a10: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+00057a20: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00057a30: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00057a40: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00057a50: 645f 6765 745f 726f 7773 5f62 6163 6b5f  d_get_rows_back_
+00057a60: 6633 325f 6631 3628 7061 7261 6d73 2c20  f32_f16(params, 
+00057a70: 7372 6330 2c20 7372 6331 2c20 6f70 7430  src0, src1, opt0
+00057a80: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
+00057a90: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00057aa0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00057ab0: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+00057ac0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00057ad0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00057ae0: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
+00057af0: 726f 7773 5f62 6163 6b5f 6633 3228 7061  rows_back_f32(pa
+00057b00: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
+00057b10: 2c20 6f70 7430 2c20 6473 7429 3b0a 2020  , opt0, dst);.  
+00057b20: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00057b30: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
+00057b40: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+00057b50: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00057b60: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+00057b70: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+00057b80: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
+00057b90: 0a0a 2020 2020 2f2f 7374 6174 6963 2062  ..    //static b
+00057ba0: 6f6f 6c20 6669 7273 7420 3d20 7472 7565  ool first = true
+00057bb0: 3b0a 2020 2020 2f2f 7072 696e 7466 2822  ;.    //printf("
+00057bc0: 6e65 3020 3d20 2564 2c20 6e65 3120 3d20  ne0 = %d, ne1 = 
+00057bd0: 2564 2c20 6e65 3220 3d20 2564 5c6e 222c  %d, ne2 = %d\n",
+00057be0: 2064 7374 2d3e 6e65 5b30 5d2c 2064 7374   dst->ne[0], dst
+00057bf0: 2d3e 6e65 5b31 5d2c 2064 7374 2d3e 6e65  ->ne[1], dst->ne
+00057c00: 5b32 5d29 3b0a 2020 2020 2f2f 6966 2028  [2]);.    //if (
+00057c10: 6669 7273 7429 207b 0a20 2020 202f 2f20  first) {.    // 
+00057c20: 2020 2066 6972 7374 203d 2066 616c 7365     first = false
+00057c30: 3b0a 2020 2020 2f2f 7d20 656c 7365 207b  ;.    //} else {
+00057c40: 0a20 2020 202f 2f20 2020 2066 6f72 2028  .    //    for (
+00057c50: 696e 7420 6b20 3d20 303b 206b 203c 2064  int k = 0; k < d
+00057c60: 7374 2d3e 6e65 5b31 5d3b 202b 2b6b 2920  st->ne[1]; ++k) 
+00057c70: 7b0a 2020 2020 2f2f 2020 2020 2020 2020  {.    //        
+00057c80: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
+00057c90: 6a20 3c20 6473 742d 3e6e 655b 305d 2f31  j < dst->ne[0]/1
+00057ca0: 363b 202b 2b6a 2920 7b0a 2020 2020 2f2f  6; ++j) {.    //
+00057cb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00057cc0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+00057cd0: 3136 3b20 2b2b 6929 207b 0a20 2020 202f  16; ++i) {.    /
+00057ce0: 2f20 2020 2020 2020 2020 2020 2020 2020  /               
+00057cf0: 2070 7269 6e74 6628 2225 382e 3466 2022   printf("%8.4f "
+00057d00: 2c20 2828 666c 6f61 7420 2a29 2064 7374  , ((float *) dst
+00057d10: 2d3e 6461 7461 295b 6b2a 6473 742d 3e6e  ->data)[k*dst->n
+00057d20: 655b 305d 202b 206a 2a31 3620 2b20 695d  e[0] + j*16 + i]
+00057d30: 293b 0a20 2020 202f 2f20 2020 2020 2020  );.    //       
+00057d40: 2020 2020 207d 0a20 2020 202f 2f20 2020       }.    //   
+00057d50: 2020 2020 2020 2020 2070 7269 6e74 6628           printf(
+00057d60: 225c 6e22 293b 0a20 2020 202f 2f20 2020  "\n");.    //   
+00057d70: 2020 2020 207d 0a20 2020 202f 2f20 2020       }.    //   
+00057d80: 2020 2020 2070 7269 6e74 6628 225c 6e22       printf("\n"
+00057d90: 293b 0a20 2020 202f 2f20 2020 207d 0a20  );.    //    }. 
+00057da0: 2020 202f 2f20 2020 2070 7269 6e74 6628     //    printf(
+00057db0: 225c 6e22 293b 0a20 2020 202f 2f20 2020  "\n");.    //   
+00057dc0: 2065 7869 7428 3029 3b0a 2020 2020 2f2f   exit(0);.    //
+00057dd0: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
+00057de0: 7075 7465 5f66 6f72 7761 7264 5f64 6961  pute_forward_dia
+00057df0: 670a 0a73 7461 7469 6320 766f 6964 2067  g..static void g
+00057e00: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00057e10: 6172 645f 6469 6167 5f66 3332 280a 2020  ard_diag_f32(.  
+00057e20: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00057e30: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00057e40: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00057e50: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00057e60: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00057e70: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00057e80: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00057e90: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00057ea0: 2020 4747 4d4c 5f41 5353 4552 5428 7061    GGML_ASSERT(pa
+00057eb0: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
+00057ec0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+00057ed0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00057ee0: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
+00057ef0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+00057f00: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+00057f10: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+00057f20: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+00057f30: 544f 444f 3a20 6861 6e64 6c65 2074 7261  TODO: handle tra
+00057f40: 6e73 706f 7365 642f 7065 726d 7574 6564  nsposed/permuted
+00057f50: 206d 6174 7269 6365 730a 0a20 2020 2063   matrices..    c
+00057f60: 6f6e 7374 2069 6e74 206e 6530 3020 3d20  onst int ne00 = 
+00057f70: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
+00057f80: 2063 6f6e 7374 2069 6e74 206e 6530 3120   const int ne01 
+00057f90: 3d20 7372 6330 2d3e 6e65 5b31 5d3b 0a20  = src0->ne[1];. 
+00057fa0: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
+00057fb0: 3220 3d20 7372 6330 2d3e 6e65 5b32 5d3b  2 = src0->ne[2];
+00057fc0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00057fd0: 6530 3320 3d20 7372 6330 2d3e 6e65 5b33  e03 = src0->ne[3
+00057fe0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00057ff0: 206e 6530 203d 2064 7374 2d3e 6e65 5b30   ne0 = dst->ne[0
+00058000: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00058010: 206e 6531 203d 2064 7374 2d3e 6e65 5b31   ne1 = dst->ne[1
+00058020: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00058030: 206e 6532 203d 2064 7374 2d3e 6e65 5b32   ne2 = dst->ne[2
+00058040: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00058050: 206e 6533 203d 2064 7374 2d3e 6e65 5b33   ne3 = dst->ne[3
+00058060: 5d3b 0a20 2020 2047 474d 4c5f 4153 5345  ];.    GGML_ASSE
+00058070: 5254 286e 6530 3020 3d3d 206e 6530 293b  RT(ne00 == ne0);
+00058080: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00058090: 286e 6530 3020 3d3d 206e 6531 293b 0a20  (ne00 == ne1);. 
+000580a0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+000580b0: 6530 3120 3d3d 2031 293b 0a20 2020 2047  e01 == 1);.    G
+000580c0: 474d 4c5f 4153 5345 5254 286e 6530 3220  GML_ASSERT(ne02 
+000580d0: 3d3d 206e 6532 293b 0a20 2020 2047 474d  == ne2);.    GGM
+000580e0: 4c5f 4153 5345 5254 286e 6530 3320 3d3d  L_ASSERT(ne03 ==
+000580f0: 206e 6533 293b 0a0a 2020 2020 636f 6e73   ne3);..    cons
+00058100: 7420 696e 7420 6e62 3030 203d 2073 7263  t int nb00 = src
+00058110: 302d 3e6e 625b 305d 3b0a 2020 2020 2f2f  0->nb[0];.    //
+00058120: 636f 6e73 7420 696e 7420 6e62 3031 203d  const int nb01 =
+00058130: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
+00058140: 2020 636f 6e73 7420 696e 7420 6e62 3032    const int nb02
+00058150: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
+00058160: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00058170: 3033 203d 2073 7263 302d 3e6e 625b 335d  03 = src0->nb[3]
+00058180: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00058190: 6e62 3020 3d20 6473 742d 3e6e 625b 305d  nb0 = dst->nb[0]
+000581a0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000581b0: 6e62 3120 3d20 6473 742d 3e6e 625b 315d  nb1 = dst->nb[1]
+000581c0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000581d0: 6e62 3220 3d20 6473 742d 3e6e 625b 325d  nb2 = dst->nb[2]
+000581e0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000581f0: 6e62 3320 3d20 6473 742d 3e6e 625b 335d  nb3 = dst->nb[3]
+00058200: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00058210: 5254 286e 6230 3020 3d3d 2073 697a 656f  RT(nb00 == sizeo
+00058220: 6628 666c 6f61 7429 293b 0a20 2020 2047  f(float));.    G
+00058230: 474d 4c5f 4153 5345 5254 286e 6230 2020  GML_ASSERT(nb0  
+00058240: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00058250: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
+00058260: 2069 3320 3d20 303b 2069 3320 3c20 6e65   i3 = 0; i3 < ne
+00058270: 333b 2069 332b 2b29 207b 0a20 2020 2020  3; i3++) {.     
+00058280: 2020 2066 6f72 2028 696e 7420 6932 203d     for (int i2 =
+00058290: 2030 3b20 6932 203c 206e 6532 3b20 6932   0; i2 < ne2; i2
+000582a0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+000582b0: 2020 666f 7220 2869 6e74 2069 3120 3d20    for (int i1 = 
+000582c0: 303b 2069 3120 3c20 6e65 313b 2069 312b  0; i1 < ne1; i1+
+000582d0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000582e0: 2020 2020 2066 6c6f 6174 202a 2064 203d       float * d =
+000582f0: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+00058300: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
+00058310: 2069 332a 6e62 3320 202b 2069 322a 6e62   i3*nb3  + i2*nb
+00058320: 3220 2b20 6931 2a6e 6231 293b 0a20 2020  2 + i1*nb1);.   
+00058330: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+00058340: 6174 202a 2073 203d 2028 666c 6f61 7420  at * s = (float 
+00058350: 2a29 2828 6368 6172 202a 2920 7372 6330  *)((char *) src0
+00058360: 2d3e 6461 7461 202b 2069 332a 6e62 3033  ->data + i3*nb03
+00058370: 202b 2069 322a 6e62 3032 293b 0a20 2020   + i2*nb02);.   
+00058380: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00058390: 2028 696e 7420 6930 203d 2030 3b20 6930   (int i0 = 0; i0
+000583a0: 203c 2069 313b 2069 302b 2b29 207b 0a20   < i1; i0++) {. 
+000583b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000583c0: 2020 2064 5b69 305d 203d 2030 3b0a 2020     d[i0] = 0;.  
+000583d0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000583e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000583f0: 645b 6931 5d20 3d20 735b 6931 5d3b 0a20  d[i1] = s[i1];. 
+00058400: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00058410: 6f72 2028 696e 7420 6930 203d 2069 312b  or (int i0 = i1+
+00058420: 313b 2069 3020 3c20 6e65 303b 2069 302b  1; i0 < ne0; i0+
+00058430: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00058440: 2020 2020 2020 2020 2064 5b69 305d 203d           d[i0] =
+00058450: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00058460: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00058470: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
+00058480: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+00058490: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+000584a0: 666f 7277 6172 645f 6469 6167 280a 2020  forward_diag(.  
+000584b0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000584c0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+000584d0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+000584e0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000584f0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00058500: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00058510: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00058520: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00058530: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
+00058540: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+00058550: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+00058560: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
+00058570: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00058580: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00058590: 6f72 7761 7264 5f64 6961 675f 6633 3228  orward_diag_f32(
+000585a0: 7061 7261 6d73 2c20 7372 6330 2c20 6473  params, src0, ds
+000585b0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+000585c0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+000585d0: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
+000585e0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000585f0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00058600: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+00058610: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00058620: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
+00058630: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00058640: 645f 6469 6167 5f6d 6173 6b5f 696e 660a  d_diag_mask_inf.
+00058650: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00058660: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00058670: 645f 6469 6167 5f6d 6173 6b5f 6633 3228  d_diag_mask_f32(
+00058680: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00058690: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+000586a0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+000586b0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+000586c0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+000586d0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+000586e0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000586f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00058700: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
+00058710: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00058720: 202a 2064 7374 2c0a 2020 2020 2020 2020   * dst,.        
+00058730: 636f 6e73 7420 666c 6f61 7420 7661 6c75  const float valu
+00058740: 6529 207b 0a20 2020 2047 474d 4c5f 4153  e) {.    GGML_AS
+00058750: 5345 5254 2873 7263 312d 3e74 7970 6520  SERT(src1->type 
+00058760: 3d3d 2047 474d 4c5f 5459 5045 5f49 3332  == GGML_TYPE_I32
+00058770: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00058780: 5254 2867 676d 6c5f 6e65 6c65 6d65 6e74  RT(ggml_nelement
+00058790: 7328 7372 6331 2920 3d3d 2032 293b 0a0a  s(src1) == 2);..
+000587a0: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+000587b0: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+000587c0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000587d0: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+000587e0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+000587f0: 2020 6e5f 7061 7374 2020 3d20 2020 2020    n_past  =     
+00058800: 2020 2828 696e 7433 325f 7420 2a29 2073    ((int32_t *) s
+00058810: 7263 312d 3e64 6174 6129 5b30 5d3b 0a20  rc1->data)[0];. 
+00058820: 2020 2063 6f6e 7374 2062 6f6f 6c20 696e     const bool in
+00058830: 706c 6163 6520 3d20 2862 6f6f 6c29 2828  place = (bool)((
+00058840: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
+00058850: 3e64 6174 6129 5b31 5d3b 0a0a 2020 2020  >data)[1];..    
+00058860: 4747 4d4c 5f41 5353 4552 5428 6e5f 7061  GGML_ASSERT(n_pa
+00058870: 7374 203e 3d20 3029 3b0a 0a20 2020 2069  st >= 0);..    i
+00058880: 6620 2821 696e 706c 6163 6520 2626 2028  f (!inplace && (
+00058890: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+000588a0: 4747 4d4c 5f54 4153 4b5f 494e 4954 2929  GGML_TASK_INIT))
+000588b0: 207b 0a20 2020 2020 2020 202f 2f20 6d65   {.        // me
+000588c0: 6d63 7079 206e 6565 6473 2074 6f20 6265  mcpy needs to be
+000588d0: 2073 796e 6368 726f 6e69 7a65 6420 6163   synchronized ac
+000588e0: 726f 7373 2074 6872 6561 6473 2074 6f20  ross threads to 
+000588f0: 6176 6f69 6420 7261 6365 2063 6f6e 6469  avoid race condi
+00058900: 7469 6f6e 732e 0a20 2020 2020 2020 202f  tions..        /
+00058910: 2f20 3d3e 2064 6f20 6974 2069 6e20 494e  / => do it in IN
+00058920: 4954 2070 6861 7365 0a20 2020 2020 2020  IT phase.       
+00058930: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00058940: 6c5f 6e65 6c65 6d65 6e74 7328 6473 7429  l_nelements(dst)
+00058950: 203d 3d20 6767 6d6c 5f6e 656c 656d 656e   == ggml_nelemen
+00058960: 7473 2873 7263 3029 293b 0a20 2020 2020  ts(src0));.     
+00058970: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+00058980: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
+00058990: 7328 6473 7429 2026 2620 6767 6d6c 5f69  s(dst) && ggml_i
+000589a0: 735f 636f 6e74 6967 756f 7573 2873 7263  s_contiguous(src
+000589b0: 3029 293b 0a20 2020 2020 2020 206d 656d  0));.        mem
+000589c0: 6370 7928 0a20 2020 2020 2020 2020 2020  cpy(.           
+000589d0: 2028 2863 6861 7220 2a29 2020 6473 742d   ((char *)  dst-
+000589e0: 3e64 6174 6129 2c0a 2020 2020 2020 2020  >data),.        
+000589f0: 2020 2020 2828 6368 6172 202a 2920 7372      ((char *) sr
+00058a00: 6330 2d3e 6461 7461 292c 0a20 2020 2020  c0->data),.     
+00058a10: 2020 2020 2020 2067 676d 6c5f 6e62 7974         ggml_nbyt
+00058a20: 6573 2864 7374 2929 3b0a 2020 2020 7d0a  es(dst));.    }.
+00058a30: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00058a40: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00058a50: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+00058a60: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00058a70: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+00058a80: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+00058a90: 0a20 2020 207d 0a0a 2020 2020 2f2f 2054  .    }..    // T
+00058aa0: 4f44 4f3a 2068 616e 646c 6520 7472 616e  ODO: handle tran
+00058ab0: 7370 6f73 6564 2f70 6572 6d75 7465 6420  sposed/permuted 
+00058ac0: 6d61 7472 6963 6573 0a0a 2020 2020 636f  matrices..    co
+00058ad0: 6e73 7420 696e 7420 6e20 203d 2067 676d  nst int n  = ggm
+00058ae0: 6c5f 6e72 6f77 7328 7372 6330 293b 0a20  l_nrows(src0);. 
+00058af0: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
+00058b00: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
+00058b10: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
+00058b20: 3d20 7372 6330 2d3e 6e65 5b31 5d3b 0a20  = src0->ne[1];. 
+00058b30: 2020 2063 6f6e 7374 2069 6e74 206e 7a20     const int nz 
+00058b40: 3d20 6e2f 6e72 3b0a 0a20 2020 2047 474d  = n/nr;..    GGM
+00058b50: 4c5f 4153 5345 5254 2820 6473 742d 3e6e  L_ASSERT( dst->n
+00058b60: 625b 305d 203d 3d20 7369 7a65 6f66 2866  b[0] == sizeof(f
+00058b70: 6c6f 6174 2929 3b0a 2020 2020 4747 4d4c  loat));.    GGML
+00058b80: 5f41 5353 4552 5428 7372 6330 2d3e 6e62  _ASSERT(src0->nb
+00058b90: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
+00058ba0: 6f61 7429 293b 0a0a 2020 2020 666f 7220  oat));..    for 
+00058bb0: 2869 6e74 206b 203d 2030 3b20 6b20 3c20  (int k = 0; k < 
+00058bc0: 6e7a 3b20 6b2b 2b29 207b 0a20 2020 2020  nz; k++) {.     
+00058bd0: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
+00058be0: 6974 683b 206a 203c 206e 723b 206a 202b  ith; j < nr; j +
+00058bf0: 3d20 6e74 6829 207b 0a20 2020 2020 2020  = nth) {.       
+00058c00: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00058c10: 3d20 6e5f 7061 7374 3b20 6920 3c20 6e63  = n_past; i < nc
+00058c20: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+00058c30: 2020 2020 2020 2020 2069 6620 2869 203e           if (i >
+00058c40: 206e 5f70 6173 7420 2b20 6a29 207b 0a20   n_past + j) {. 
+00058c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00058c60: 2020 202a 2866 6c6f 6174 202a 2928 2863     *(float *)((c
+00058c70: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
+00058c80: 202b 206b 2a64 7374 2d3e 6e62 5b32 5d20   + k*dst->nb[2] 
+00058c90: 2b20 6a2a 6473 742d 3e6e 625b 315d 202b  + j*dst->nb[1] +
+00058ca0: 2069 2a64 7374 2d3e 6e62 5b30 5d29 203d   i*dst->nb[0]) =
+00058cb0: 2076 616c 7565 3b0a 2020 2020 2020 2020   value;.        
+00058cc0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00058cd0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00058ce0: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
+00058cf0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+00058d00: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
+00058d10: 5f6d 6173 6b5f 696e 6628 0a20 2020 2020  _mask_inf(.     
+00058d20: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00058d30: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00058d40: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00058d50: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00058d60: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00058d70: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+00058d80: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00058d90: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+00058da0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00058db0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00058dc0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+00058dd0: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+00058de0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00058df0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00058e00: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00058e10: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00058e20: 7075 7465 5f66 6f72 7761 7264 5f64 6961  pute_forward_dia
+00058e30: 675f 6d61 736b 5f66 3332 2870 6172 616d  g_mask_f32(param
+00058e40: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
+00058e50: 7374 2c20 2d49 4e46 494e 4954 5929 3b0a  st, -INFINITY);.
+00058e60: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00058e70: 6561 6b3b 0a20 2020 2020 2020 2064 6566  eak;.        def
+00058e80: 6175 6c74 3a0a 2020 2020 2020 2020 2020  ault:.          
+00058e90: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00058ea0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00058eb0: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00058ec0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00058ed0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
+00058ee0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00058ef0: 6f72 7761 7264 5f64 6961 675f 6d61 736b  orward_diag_mask
+00058f00: 5f7a 6572 6f28 0a20 2020 2020 2020 2063  _zero(.        c
+00058f10: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00058f20: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+00058f30: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+00058f40: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00058f50: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00058f60: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
+00058f70: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00058f80: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
+00058f90: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00058fa0: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+00058fb0: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
+00058fc0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+00058fd0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00058fe0: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
+00058ff0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00059000: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00059010: 5f66 6f72 7761 7264 5f64 6961 675f 6d61  _forward_diag_ma
+00059020: 736b 5f66 3332 2870 6172 616d 732c 2073  sk_f32(params, s
+00059030: 7263 302c 2073 7263 312c 2064 7374 2c20  rc0, src1, dst, 
+00059040: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
+00059050: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00059060: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
+00059070: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00059080: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00059090: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+000590a0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+000590b0: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
+000590c0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000590d0: 645f 736f 6674 5f6d 6178 0a0a 7374 6174  d_soft_max..stat
+000590e0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+000590f0: 7075 7465 5f66 6f72 7761 7264 5f73 6f66  pute_forward_sof
+00059100: 745f 6d61 785f 6633 3228 0a20 2020 2020  t_max_f32(.     
+00059110: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00059120: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00059130: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00059140: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00059150: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00059160: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
+00059170: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00059180: 7220 2a20 6473 7429 207b 0a20 2020 2047  r * dst) {.    G
+00059190: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+000591a0: 6973 5f63 6f6e 7469 6775 6f75 7328 7372  is_contiguous(sr
+000591b0: 6330 2929 3b0a 2020 2020 4747 4d4c 5f41  c0));.    GGML_A
+000591c0: 5353 4552 5428 6767 6d6c 5f69 735f 636f  SSERT(ggml_is_co
+000591d0: 6e74 6967 756f 7573 2864 7374 2929 3b0a  ntiguous(dst));.
+000591e0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000591f0: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
+00059200: 6170 6528 7372 6330 2c20 6473 7429 293b  ape(src0, dst));
+00059210: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+00059220: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00059230: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
+00059240: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+00059250: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+00059260: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+00059270: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+00059280: 544f 444f 3a20 6861 6e64 6c65 2074 7261  TODO: handle tra
+00059290: 6e73 706f 7365 642f 7065 726d 7574 6564  nsposed/permuted
+000592a0: 206d 6174 7269 6365 730a 0a20 2020 2063   matrices..    c
+000592b0: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
+000592c0: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
+000592d0: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
+000592e0: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
+000592f0: 2020 636f 6e73 7420 696e 7420 6e63 203d    const int nc =
+00059300: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
+00059310: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
+00059320: 2067 676d 6c5f 6e72 6f77 7328 7372 6330   ggml_nrows(src0
+00059330: 293b 0a0a 2020 2020 2f2f 2072 6f77 7320  );..    // rows 
+00059340: 7065 7220 7468 7265 6164 0a20 2020 2063  per thread.    c
+00059350: 6f6e 7374 2069 6e74 2064 7220 3d20 286e  onst int dr = (n
+00059360: 7220 2b20 6e74 6820 2d20 3129 2f6e 7468  r + nth - 1)/nth
+00059370: 3b0a 0a20 2020 202f 2f20 726f 7720 7261  ;..    // row ra
+00059380: 6e67 6520 666f 7220 7468 6973 2074 6872  nge for this thr
+00059390: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
+000593a0: 7420 6972 3020 3d20 6472 2a69 7468 3b0a  t ir0 = dr*ith;.
+000593b0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+000593c0: 3120 3d20 4d49 4e28 6972 3020 2b20 6472  1 = MIN(ir0 + dr
+000593d0: 2c20 6e72 293b 0a0a 2020 2020 666f 7220  , nr);..    for 
+000593e0: 2869 6e74 2069 3120 3d20 6972 303b 2069  (int i1 = ir0; i
+000593f0: 3120 3c20 6972 313b 2069 312b 2b29 207b  1 < ir1; i1++) {
+00059400: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
+00059410: 7370 203d 2028 666c 6f61 7420 2a29 2828  sp = (float *)((
+00059420: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
+00059430: 7461 202b 2069 312a 7372 6330 2d3e 6e62  ta + i1*src0->nb
+00059440: 5b31 5d29 3b0a 2020 2020 2020 2020 666c  [1]);.        fl
+00059450: 6f61 7420 2a64 7020 3d20 2866 6c6f 6174  oat *dp = (float
+00059460: 202a 2928 2863 6861 7220 2a29 2020 6473   *)((char *)  ds
+00059470: 742d 3e64 6174 6120 2b20 2069 312a 6473  t->data +  i1*ds
+00059480: 742d 3e6e 625b 315d 293b 0a0a 2369 666e  t->nb[1]);..#ifn
+00059490: 6465 6620 4e44 4542 5547 0a20 2020 2020  def NDEBUG.     
+000594a0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+000594b0: 303b 2069 203c 206e 633b 202b 2b69 2920  0; i < nc; ++i) 
+000594c0: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
+000594d0: 7072 696e 7466 2822 705b 2564 5d20 3d20  printf("p[%d] = 
+000594e0: 2566 5c6e 222c 2069 2c20 705b 695d 293b  %f\n", i, p[i]);
+000594f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00059500: 6572 7428 2169 736e 616e 2873 705b 695d  ert(!isnan(sp[i]
+00059510: 2929 3b0a 2020 2020 2020 2020 7d0a 2365  ));.        }.#e
+00059520: 6e64 6966 0a0a 2020 2020 2020 2020 666c  ndif..        fl
+00059530: 6f61 7420 6d61 7820 3d20 2d49 4e46 494e  oat max = -INFIN
+00059540: 4954 593b 0a20 2020 2020 2020 2067 676d  ITY;.        ggm
+00059550: 6c5f 7665 635f 6d61 785f 6633 3228 6e63  l_vec_max_f32(nc
+00059560: 2c20 266d 6178 2c20 7370 293b 0a0a 2020  , &max, sp);..  
+00059570: 2020 2020 2020 6767 6d6c 5f66 6c6f 6174        ggml_float
+00059580: 2073 756d 203d 2030 2e30 3b0a 0a20 2020   sum = 0.0;..   
+00059590: 2020 2020 2075 696e 7431 365f 7420 7363       uint16_t sc
+000595a0: 7674 3b0a 2020 2020 2020 2020 666f 7220  vt;.        for 
+000595b0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+000595c0: 6e63 3b20 692b 2b29 207b 0a20 2020 2020  nc; i++) {.     
+000595d0: 2020 2020 2020 2069 6620 2873 705b 695d         if (sp[i]
+000595e0: 203d 3d20 2d49 4e46 494e 4954 5929 207b   == -INFINITY) {
+000595f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059600: 2064 705b 695d 203d 2030 2e30 663b 0a20   dp[i] = 0.0f;. 
+00059610: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
+00059620: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
+00059630: 2020 2020 2f2f 2063 6f6e 7374 2066 6c6f      // const flo
+00059640: 6174 2076 616c 203d 2028 7370 5b69 5d20  at val = (sp[i] 
+00059650: 3d3d 202d 494e 4649 4e49 5459 2920 3f20  == -INFINITY) ? 
+00059660: 302e 3020 3a20 6578 7028 7370 5b69 5d20  0.0 : exp(sp[i] 
+00059670: 2d20 6d61 7829 3b0a 2020 2020 2020 2020  - max);.        
+00059680: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
+00059690: 365f 7420 7320 3d20 4747 4d4c 5f46 5033  6_t s = GGML_FP3
+000596a0: 325f 544f 5f46 5031 3628 7370 5b69 5d20  2_TO_FP16(sp[i] 
+000596b0: 2d20 6d61 7829 3b0a 2020 2020 2020 2020  - max);.        
+000596c0: 2020 2020 2020 2020 6d65 6d63 7079 2826          memcpy(&
+000596d0: 7363 7674 2c20 2673 2c20 7369 7a65 6f66  scvt, &s, sizeof
+000596e0: 2873 6376 7429 293b 0a20 2020 2020 2020  (scvt));.       
+000596f0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00059700: 6c6f 6174 2076 616c 203d 2047 474d 4c5f  loat val = GGML_
+00059710: 4650 3136 5f54 4f5f 4650 3332 2874 6162  FP16_TO_FP32(tab
+00059720: 6c65 5f65 7870 5f66 3136 5b73 6376 745d  le_exp_f16[scvt]
+00059730: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00059740: 2020 2073 756d 202b 3d20 2867 676d 6c5f     sum += (ggml_
+00059750: 666c 6f61 7429 7661 6c3b 0a20 2020 2020  float)val;.     
+00059760: 2020 2020 2020 2020 2020 2064 705b 695d             dp[i]
+00059770: 203d 2076 616c 3b0a 2020 2020 2020 2020   = val;.        
+00059780: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+00059790: 0a20 2020 2020 2020 2061 7373 6572 7428  .        assert(
+000597a0: 7375 6d20 3e20 302e 3029 3b0a 0a20 2020  sum > 0.0);..   
+000597b0: 2020 2020 2073 756d 203d 2031 2e30 2f73       sum = 1.0/s
+000597c0: 756d 3b0a 2020 2020 2020 2020 6767 6d6c  um;.        ggml
+000597d0: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
+000597e0: 632c 2064 702c 2073 756d 293b 0a0a 2369  c, dp, sum);..#i
+000597f0: 666e 6465 6620 4e44 4542 5547 0a20 2020  fndef NDEBUG.   
+00059800: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00059810: 3d20 303b 2069 203c 206e 633b 202b 2b69  = 0; i < nc; ++i
+00059820: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00059830: 6173 7365 7274 2821 6973 6e61 6e28 6470  assert(!isnan(dp
+00059840: 5b69 5d29 293b 0a20 2020 2020 2020 2020  [i]));.         
+00059850: 2020 2061 7373 6572 7428 2169 7369 6e66     assert(!isinf
+00059860: 2864 705b 695d 2929 3b0a 2020 2020 2020  (dp[i]));.      
+00059870: 2020 7d0a 2365 6e64 6966 0a20 2020 207d    }.#endif.    }
+00059880: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+00059890: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000598a0: 7761 7264 5f73 6f66 745f 6d61 7828 0a20  ward_soft_max(. 
+000598b0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000598c0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+000598d0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+000598e0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+000598f0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00059900: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00059910: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00059920: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00059930: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
+00059940: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+00059950: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00059960: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
+00059970: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00059980: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00059990: 666f 7277 6172 645f 736f 6674 5f6d 6178  forward_soft_max
+000599a0: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
+000599b0: 302c 2064 7374 293b 0a20 2020 2020 2020  0, dst);.       
+000599c0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000599d0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+000599e0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000599f0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00059a00: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+00059a10: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00059a20: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
+00059a30: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+00059a40: 6f72 7761 7264 5f73 6f66 745f 6d61 785f  orward_soft_max_
+00059a50: 6261 636b 0a0a 7374 6174 6963 2076 6f69  back..static voi
+00059a60: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00059a70: 6f72 7761 7264 5f73 6f66 745f 6d61 785f  orward_soft_max_
+00059a80: 6261 636b 5f66 3332 280a 2020 2020 2020  back_f32(.      
+00059a90: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00059aa0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00059ab0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00059ac0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00059ad0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00059ae0: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+00059af0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00059b00: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+00059b10: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00059b20: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00059b30: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
+00059b40: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
+00059b50: 6775 6f75 7328 7372 6330 2929 3b0a 2020  guous(src0));.  
+00059b60: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+00059b70: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
+00059b80: 2873 7263 3129 293b 0a20 2020 2047 474d  (src1));.    GGM
+00059b90: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
+00059ba0: 5f63 6f6e 7469 6775 6f75 7328 6473 7429  _contiguous(dst)
+00059bb0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00059bc0: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
+00059bd0: 5f73 6861 7065 2873 7263 302c 2064 7374  _shape(src0, dst
+00059be0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+00059bf0: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
+00059c00: 655f 7368 6170 6528 7372 6331 2c20 6473  e_shape(src1, ds
+00059c10: 7429 293b 0a0a 2020 2020 6966 2028 7061  t));..    if (pa
+00059c20: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00059c30: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
+00059c40: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00059c50: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
+00059c60: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
+00059c70: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+00059c80: 202f 2f20 544f 444f 3a20 6861 6e64 6c65   // TODO: handle
+00059c90: 2074 7261 6e73 706f 7365 642f 7065 726d   transposed/perm
+00059ca0: 7574 6564 206d 6174 7269 6365 730a 0a20  uted matrices.. 
+00059cb0: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
+00059cc0: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
+00059cd0: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
+00059ce0: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
+00059cf0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+00059d00: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
+00059d10: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00059d20: 6e72 203d 2067 676d 6c5f 6e72 6f77 7328  nr = ggml_nrows(
+00059d30: 7372 6330 293b 0a0a 2020 2020 2f2f 2072  src0);..    // r
+00059d40: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
+00059d50: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
+00059d60: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
+00059d70: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
+00059d80: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
+00059d90: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+00059da0: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
+00059db0: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+00059dc0: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
+00059dd0: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
+00059de0: 666f 7220 2869 6e74 2069 3120 3d20 6972  for (int i1 = ir
+00059df0: 303b 2069 3120 3c20 6972 313b 2069 312b  0; i1 < ir1; i1+
+00059e00: 2b29 207b 0a20 2020 2020 2020 2066 6c6f  +) {.        flo
+00059e10: 6174 202a 6479 203d 2028 666c 6f61 7420  at *dy = (float 
+00059e20: 2a29 2828 6368 6172 202a 2920 7372 6330  *)((char *) src0
+00059e30: 2d3e 6461 7461 202b 2069 312a 7372 6330  ->data + i1*src0
+00059e40: 2d3e 6e62 5b31 5d29 3b0a 2020 2020 2020  ->nb[1]);.      
+00059e50: 2020 666c 6f61 7420 2a79 2020 3d20 2866    float *y  = (f
+00059e60: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+00059e70: 2073 7263 312d 3e64 6174 6120 2b20 6931   src1->data + i1
+00059e80: 2a73 7263 312d 3e6e 625b 315d 293b 0a20  *src1->nb[1]);. 
+00059e90: 2020 2020 2020 2066 6c6f 6174 202a 6478         float *dx
+00059ea0: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
+00059eb0: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+00059ec0: 202b 2069 312a 6473 742d 3e6e 625b 315d   + i1*dst->nb[1]
+00059ed0: 293b 0a0a 2369 666e 6465 6620 4e44 4542  );..#ifndef NDEB
+00059ee0: 5547 0a20 2020 2020 2020 2066 6f72 2028  UG.        for (
+00059ef0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
+00059f00: 633b 202b 2b69 2920 7b0a 2020 2020 2020  c; ++i) {.      
+00059f10: 2020 2020 2020 2f2f 7072 696e 7466 2822        //printf("
+00059f20: 705b 2564 5d20 3d20 2566 5c6e 222c 2069  p[%d] = %f\n", i
+00059f30: 2c20 705b 695d 293b 0a20 2020 2020 2020  , p[i]);.       
+00059f40: 2020 2020 2061 7373 6572 7428 2169 736e       assert(!isn
+00059f50: 616e 2864 795b 695d 2929 3b0a 2020 2020  an(dy[i]));.    
+00059f60: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
+00059f70: 6973 6e61 6e28 795b 695d 2929 3b0a 2020  isnan(y[i]));.  
+00059f80: 2020 2020 2020 7d0a 2365 6e64 6966 0a20        }.#endif. 
+00059f90: 2020 2020 2020 202f 2f20 4a69 6920 3d20         // Jii = 
+00059fa0: 7969 202d 2079 692a 7969 0a20 2020 2020  yi - yi*yi.     
+00059fb0: 2020 202f 2f20 4a69 6a20 3d20 2d79 692a     // Jij = -yi*
+00059fc0: 796a 0a20 2020 2020 2020 202f 2f20 4a20  yj.        // J 
+00059fd0: 3d20 6469 6167 2879 292d 792e 542a 790a  = diag(y)-y.T*y.
+00059fe0: 2020 2020 2020 2020 2f2f 2064 7820 3d20          // dx = 
+00059ff0: 4a20 2a20 6479 0a20 2020 2020 2020 202f  J * dy.        /
+0005a000: 2f20 6478 6b20 3d20 7375 6d5f 6928 4a6b  / dxk = sum_i(Jk
+0005a010: 6920 2a20 6479 6929 0a20 2020 2020 2020  i * dyi).       
+0005a020: 202f 2f20 6478 6b20 3d20 7375 6d5f 6928   // dxk = sum_i(
+0005a030: 2d79 6b2a 7969 202a 2064 7969 2920 2d20  -yk*yi * dyi) - 
+0005a040: 282d 796b 2a79 6b29 2a64 796b 202b 2028  (-yk*yk)*dyk + (
+0005a050: 796b 202d 2079 6b2a 796b 292a 6479 6b0a  yk - yk*yk)*dyk.
+0005a060: 2020 2020 2020 2020 2f2f 2064 786b 203d          // dxk =
+0005a070: 2073 756d 5f69 282d 796b 2a79 6920 2a20   sum_i(-yk*yi * 
+0005a080: 6479 6929 202b 2079 6b2a 6479 6b0a 2020  dyi) + yk*dyk.  
+0005a090: 2020 2020 2020 2f2f 2064 786b 203d 202d        // dxk = -
+0005a0a0: 796b 202a 2073 756d 5f69 2879 6920 2a20  yk * sum_i(yi * 
+0005a0b0: 6479 6929 202b 2079 6b2a 6479 6b0a 2020  dyi) + yk*dyk.  
+0005a0c0: 2020 2020 2020 2f2f 2064 786b 203d 202d        // dxk = -
+0005a0d0: 796b 202a 2064 6f74 2879 2c20 6479 2920  yk * dot(y, dy) 
+0005a0e0: 2b20 796b 2a64 796b 0a20 2020 2020 2020  + yk*dyk.       
+0005a0f0: 202f 2f20 6478 6b20 3d20 796b 202a 2028   // dxk = yk * (
+0005a100: 2d20 646f 7428 792c 2064 7929 202b 2064  - dot(y, dy) + d
+0005a110: 796b 290a 2020 2020 2020 2020 2f2f 2064  yk).        // d
+0005a120: 786b 203d 2079 6b20 2a20 2864 796b 202d  xk = yk * (dyk -
+0005a130: 2064 6f74 2879 2c20 6479 2929 0a20 2020   dot(y, dy)).   
+0005a140: 2020 2020 202f 2f0a 2020 2020 2020 2020       //.        
+0005a150: 2f2f 2070 6f73 742d 6f72 6465 723a 0a20  // post-order:. 
+0005a160: 2020 2020 2020 202f 2f20 646f 745f 795f         // dot_y_
+0005a170: 6479 203a 3d20 646f 7428 792c 2064 7929  dy := dot(y, dy)
+0005a180: 0a20 2020 2020 2020 202f 2f20 6478 203a  .        // dx :
+0005a190: 3d20 6479 0a20 2020 2020 2020 202f 2f20  = dy.        // 
+0005a1a0: 6478 203a 3d20 6478 202d 2064 6f74 5f79  dx := dx - dot_y
+0005a1b0: 5f64 790a 2020 2020 2020 2020 2f2f 2064  _dy.        // d
+0005a1c0: 7820 3a3d 2064 7820 2a20 790a 0a20 2020  x := dx * y..   
+0005a1d0: 2020 2020 202f 2f20 6c69 6e65 6172 2072       // linear r
+0005a1e0: 756e 7469 6d65 2c20 6e6f 2061 6464 6974  untime, no addit
+0005a1f0: 696f 6e61 6c20 6d65 6d6f 7279 0a20 2020  ional memory.   
+0005a200: 2020 2020 2066 6c6f 6174 2064 6f74 5f79       float dot_y
+0005a210: 5f64 7920 3d20 303b 0a20 2020 2020 2020  _dy = 0;.       
+0005a220: 2067 676d 6c5f 7665 635f 646f 745f 6633   ggml_vec_dot_f3
+0005a230: 3220 286e 632c 2026 646f 745f 795f 6479  2 (nc, &dot_y_dy
+0005a240: 2c20 792c 2064 7929 3b0a 2020 2020 2020  , y, dy);.      
+0005a250: 2020 6767 6d6c 5f76 6563 5f63 7079 5f66    ggml_vec_cpy_f
+0005a260: 3332 2028 6e63 2c20 6478 2c20 6479 293b  32 (nc, dx, dy);
+0005a270: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
+0005a280: 635f 6163 6331 5f66 3332 286e 632c 2064  c_acc1_f32(nc, d
+0005a290: 782c 202d 646f 745f 795f 6479 293b 0a20  x, -dot_y_dy);. 
+0005a2a0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0005a2b0: 6d75 6c5f 6633 3220 286e 632c 2064 782c  mul_f32 (nc, dx,
+0005a2c0: 2064 782c 2079 293b 0a0a 2369 666e 6465   dx, y);..#ifnde
+0005a2d0: 6620 4e44 4542 5547 0a20 2020 2020 2020  f NDEBUG.       
+0005a2e0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0005a2f0: 2069 203c 206e 633b 202b 2b69 2920 7b0a   i < nc; ++i) {.
+0005a300: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0005a310: 7274 2821 6973 6e61 6e28 6478 5b69 5d29  rt(!isnan(dx[i])
+0005a320: 293b 0a20 2020 2020 2020 2020 2020 2061  );.            a
+0005a330: 7373 6572 7428 2169 7369 6e66 2864 785b  ssert(!isinf(dx[
+0005a340: 695d 2929 3b0a 2020 2020 2020 2020 7d0a  i]));.        }.
+0005a350: 2365 6e64 6966 0a20 2020 207d 0a7d 0a0a  #endif.    }.}..
+0005a360: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+0005a370: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0005a380: 5f73 6f66 745f 6d61 785f 6261 636b 280a  _soft_max_back(.
+0005a390: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0005a3a0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+0005a3b0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+0005a3c0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+0005a3d0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0005a3e0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+0005a3f0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0005a400: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+0005a410: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
+0005a420: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0005a430: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
+0005a440: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
+0005a450: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+0005a460: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
+0005a470: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0005a480: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0005a490: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0005a4a0: 645f 736f 6674 5f6d 6178 5f62 6163 6b5f  d_soft_max_back_
+0005a4b0: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+0005a4c0: 2c20 7372 6331 2c20 6473 7429 3b0a 2020  , src1, dst);.  
+0005a4d0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0005a4e0: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
+0005a4f0: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+0005a500: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0005a510: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0005a520: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+0005a530: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
+0005a540: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
+0005a550: 7574 655f 666f 7277 6172 645f 616c 6962  ute_forward_alib
+0005a560: 690a 0a73 7461 7469 6320 766f 6964 2067  i..static void g
+0005a570: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0005a580: 6172 645f 616c 6962 695f 6633 3228 0a20  ard_alibi_f32(. 
+0005a590: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0005a5a0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+0005a5b0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+0005a5c0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0005a5d0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0005a5e0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+0005a5f0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0005a600: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+0005a610: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+0005a620: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0005a630: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
+0005a640: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
+0005a650: 3d20 3029 3b0a 2020 2020 6173 7365 7274  = 0);.    assert
+0005a660: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
+0005a670: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
+0005a680: 2020 2061 7373 6572 7428 6767 6d6c 5f6e     assert(ggml_n
+0005a690: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
+0005a6a0: 3d20 3329 3b0a 0a20 2020 2069 6620 2870  = 3);..    if (p
+0005a6b0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0005a6c0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+0005a6d0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+0005a6e0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+0005a6f0: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+0005a700: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0005a710: 2020 636f 6e73 7420 696e 7420 2020 6e5f    const int   n_
+0005a720: 7061 7374 2020 203d 2028 2869 6e74 3332  past   = ((int32
+0005a730: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
+0005a740: 295b 305d 3b0a 2020 2020 636f 6e73 7420  )[0];.    const 
+0005a750: 696e 7420 2020 6e5f 6865 6164 2020 203d  int   n_head   =
+0005a760: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
+0005a770: 6331 2d3e 6461 7461 295b 315d 3b0a 2020  c1->data)[1];.  
+0005a780: 2020 636f 6e73 7420 666c 6f61 7420 6d61    const float ma
+0005a790: 785f 6269 6173 203d 2028 2866 6c6f 6174  x_bias = ((float
+0005a7a0: 202a 2920 2020 7372 6331 2d3e 6461 7461   *)   src1->data
+0005a7b0: 295b 325d 3b0a 0a20 2020 2061 7373 6572  )[2];..    asser
+0005a7c0: 7428 6e5f 7061 7374 203e 3d20 3029 3b0a  t(n_past >= 0);.
+0005a7d0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005a7e0: 6530 203d 2073 7263 302d 3e6e 655b 305d  e0 = src0->ne[0]
+0005a7f0: 3b20 2f2f 2061 6c6c 5f73 6571 5f6c 656e  ; // all_seq_len
+0005a800: 203d 206e 5f70 6173 7420 2b20 6e65 310a   = n_past + ne1.
 0005a810: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
-0005a820: 3020 3d20 7372 6330 2d3e 6e65 5b30 5d3b  0 = src0->ne[0];
-0005a830: 202f 2f20 616c 6c5f 7365 715f 6c65 6e20   // all_seq_len 
-0005a840: 3d20 6e5f 7061 7374 202b 206e 6531 0a20  = n_past + ne1. 
-0005a850: 2020 2063 6f6e 7374 2069 6e74 206e 6531     const int ne1
-0005a860: 203d 2073 7263 302d 3e6e 655b 315d 3b20   = src0->ne[1]; 
-0005a870: 2f2f 2073 6571 5f6c 656e 5f77 6974 686f  // seq_len_witho
-0005a880: 7574 5f70 6173 740a 2020 2020 2f2f 636f  ut_past.    //co
-0005a890: 6e73 7420 696e 7420 6e65 3220 3d20 7372  nst int ne2 = sr
-0005a8a0: 6330 2d3e 6e65 5b32 5d3b 202f 2f20 6e5f  c0->ne[2]; // n_
-0005a8b0: 6865 6164 202d 3e20 7468 6973 2069 7320  head -> this is 
-0005a8c0: 6b0a 2020 2020 2f2f 636f 6e73 7420 696e  k.    //const in
-0005a8d0: 7420 6e65 3320 3d20 7372 6330 2d3e 6e65  t ne3 = src0->ne
-0005a8e0: 5b33 5d3b 202f 2f20 3120 2d3e 2062 737a  [3]; // 1 -> bsz
-0005a8f0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005a900: 6e20 203d 2067 676d 6c5f 6e72 6f77 7328  n  = ggml_nrows(
-0005a910: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
-0005a920: 2069 6e74 206e 6532 5f6e 6533 203d 206e   int ne2_ne3 = n
-0005a930: 2f6e 6531 3b20 2f2f 206e 6532 2a6e 6533  /ne1; // ne2*ne3
-0005a940: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005a950: 6e62 3020 3d20 7372 6330 2d3e 6e62 5b30  nb0 = src0->nb[0
-0005a960: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0005a970: 206e 6231 203d 2073 7263 302d 3e6e 625b   nb1 = src0->nb[
-0005a980: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-0005a990: 7420 6e62 3220 3d20 7372 6330 2d3e 6e62  t nb2 = src0->nb
-0005a9a0: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
-0005a9b0: 2069 6e74 206e 6233 203d 2073 7263 302d   int nb3 = src0-
-0005a9c0: 3e6e 625b 335d 3b0a 0a20 2020 2061 7373  >nb[3];..    ass
-0005a9d0: 6572 7428 6e62 3020 3d3d 2073 697a 656f  ert(nb0 == sizeo
-0005a9e0: 6628 666c 6f61 7429 293b 0a20 2020 2061  f(float));.    a
-0005a9f0: 7373 6572 7428 6e65 3120 2b20 6e5f 7061  ssert(ne1 + n_pa
-0005aa00: 7374 203d 3d20 6e65 3029 3b20 2876 6f69  st == ne0); (voi
-0005aa10: 6429 206e 5f70 6173 743b 0a0a 2020 2020  d) n_past;..    
-0005aa20: 2f2f 2061 6464 2061 6c69 6269 2074 6f20  // add alibi to 
-0005aa30: 7372 6330 2028 4b51 5f73 6361 6c65 6429  src0 (KQ_scaled)
-0005aa40: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005aa50: 5f68 6561 6473 5f6c 6f67 325f 666c 6f6f  _heads_log2_floo
-0005aa60: 7220 3d20 3120 3c3c 2028 696e 7429 2066  r = 1 << (int) f
-0005aa70: 6c6f 6f72 286c 6f67 3228 6e5f 6865 6164  loor(log2(n_head
-0005aa80: 2929 3b0a 0a20 2020 2063 6f6e 7374 2066  ));..    const f
-0005aa90: 6c6f 6174 206d 3020 3d20 706f 7766 2832  loat m0 = powf(2
-0005aaa0: 2e30 662c 202d 286d 6178 5f62 6961 7329  .0f, -(max_bias)
-0005aab0: 202f 206e 5f68 6561 6473 5f6c 6f67 325f   / n_heads_log2_
-0005aac0: 666c 6f6f 7229 3b0a 2020 2020 636f 6e73  floor);.    cons
-0005aad0: 7420 666c 6f61 7420 6d31 203d 2070 6f77  t float m1 = pow
-0005aae0: 6628 322e 3066 2c20 2d28 6d61 785f 6269  f(2.0f, -(max_bi
-0005aaf0: 6173 202f 2032 2e30 6629 202f 206e 5f68  as / 2.0f) / n_h
-0005ab00: 6561 6473 5f6c 6f67 325f 666c 6f6f 7229  eads_log2_floor)
-0005ab10: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-0005ab20: 6920 3d20 303b 2069 203c 206e 6530 3b20  i = 0; i < ne0; 
-0005ab30: 692b 2b29 207b 0a20 2020 2020 2020 2066  i++) {.        f
-0005ab40: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-0005ab50: 203c 206e 6531 3b20 6a2b 2b29 207b 0a20   < ne1; j++) {. 
-0005ab60: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-0005ab70: 696e 7420 6b20 3d20 303b 206b 203c 206e  int k = 0; k < n
-0005ab80: 6532 5f6e 6533 3b20 6b2b 2b29 207b 0a20  e2_ne3; k++) {. 
-0005ab90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005aba0: 6c6f 6174 202a 2063 6f6e 7374 2073 7263  loat * const src
-0005abb0: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
-0005abc0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-0005abd0: 202b 2069 2a6e 6230 202b 206a 2a6e 6231   + i*nb0 + j*nb1
-0005abe0: 202b 206b 2a6e 6232 293b 0a20 2020 2020   + k*nb2);.     
-0005abf0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-0005ac00: 202a 2020 2020 2020 7064 7374 203d 2028   *      pdst = (
-0005ac10: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-0005ac20: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
-0005ac30: 2a6e 6230 202b 206a 2a6e 6231 202b 206b  *nb0 + j*nb1 + k
-0005ac40: 2a6e 6232 293b 0a0a 2020 2020 2020 2020  *nb2);..        
-0005ac50: 2020 2020 2020 2020 2f2f 2054 4f44 4f3a          // TODO:
-0005ac60: 206b 2a6e 6232 206f 7220 6b2a 6e62 330a   k*nb2 or k*nb3.
-0005ac70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005ac80: 2066 6c6f 6174 206d 5f6b 3b0a 0a20 2020   float m_k;..   
-0005ac90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0005aca0: 286b 203c 206e 5f68 6561 6473 5f6c 6f67  (k < n_heads_log
-0005acb0: 325f 666c 6f6f 7229 207b 0a20 2020 2020  2_floor) {.     
-0005acc0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0005acd0: 5f6b 203d 2070 6f77 6628 6d30 2c20 6b20  _k = powf(m0, k 
-0005ace0: 2b20 3129 3b0a 2020 2020 2020 2020 2020  + 1);.          
-0005acf0: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-0005ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ad10: 2020 206d 5f6b 203d 2070 6f77 6628 6d31     m_k = powf(m1
-0005ad20: 2c20 3220 2a20 286b 202d 206e 5f68 6561  , 2 * (k - n_hea
-0005ad30: 6473 5f6c 6f67 325f 666c 6f6f 7229 202b  ds_log2_floor) +
-0005ad40: 2031 293b 0a20 2020 2020 2020 2020 2020   1);.           
-0005ad50: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0005ad60: 2020 2020 2020 2020 7064 7374 5b30 5d20          pdst[0] 
-0005ad70: 3d20 2869 2d6e 6530 2b31 2920 2a20 6d5f  = (i-ne0+1) * m_
-0005ad80: 6b20 2b20 7372 635b 305d 3b0a 0a20 2020  k + src[0];..   
-0005ad90: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0005ada0: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
-0005adb0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-0005adc0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
-0005add0: 6c69 6269 5f66 3136 280a 2020 2020 2020  libi_f16(.      
-0005ade0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005adf0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0005ae00: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0005ae10: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005ae20: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005ae30: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-0005ae40: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0005ae50: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-0005ae60: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0005ae70: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0005ae80: 207b 0a20 2020 2061 7373 6572 7428 7061   {.    assert(pa
-0005ae90: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
-0005aea0: 0a20 2020 2061 7373 6572 7428 7372 6331  .    assert(src1
-0005aeb0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005aec0: 5950 455f 4933 3229 3b0a 2020 2020 6173  YPE_I32);.    as
-0005aed0: 7365 7274 2867 676d 6c5f 6e65 6c65 6d65  sert(ggml_neleme
-0005aee0: 6e74 7328 7372 6331 2920 3d3d 2033 293b  nts(src1) == 3);
-0005aef0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-0005af00: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005af10: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
-0005af20: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-0005af30: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
-0005af40: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
-0005af50: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
-0005af60: 7374 2069 6e74 2020 206e 5f70 6173 7420  st int   n_past 
-0005af70: 2020 3d20 2828 696e 7433 325f 7420 2a29    = ((int32_t *)
-0005af80: 2073 7263 312d 3e64 6174 6129 5b30 5d3b   src1->data)[0];
-0005af90: 0a20 2020 2063 6f6e 7374 2069 6e74 2020  .    const int  
-0005afa0: 206e 5f68 6561 6420 2020 3d20 2828 696e   n_head   = ((in
-0005afb0: 7433 325f 7420 2a29 2073 7263 312d 3e64  t32_t *) src1->d
-0005afc0: 6174 6129 5b31 5d3b 0a20 2020 2063 6f6e  ata)[1];.    con
-0005afd0: 7374 2066 6c6f 6174 206d 6178 5f62 6961  st float max_bia
-0005afe0: 7320 3d20 2828 666c 6f61 7420 2a29 2020  s = ((float *)  
-0005aff0: 2073 7263 312d 3e64 6174 6129 5b32 5d3b   src1->data)[2];
-0005b000: 0a0a 2020 2020 6173 7365 7274 286e 5f70  ..    assert(n_p
-0005b010: 6173 7420 3e3d 2030 293b 0a0a 2020 2020  ast >= 0);..    
-0005b020: 636f 6e73 7420 696e 7420 6e65 3020 3d20  const int ne0 = 
-0005b030: 7372 6330 2d3e 6e65 5b30 5d3b 202f 2f20  src0->ne[0]; // 
-0005b040: 616c 6c5f 7365 715f 6c65 6e20 3d20 6e5f  all_seq_len = n_
-0005b050: 7061 7374 202b 206e 6531 0a20 2020 2063  past + ne1.    c
-0005b060: 6f6e 7374 2069 6e74 206e 6531 203d 2073  onst int ne1 = s
-0005b070: 7263 302d 3e6e 655b 315d 3b20 2f2f 2073  rc0->ne[1]; // s
-0005b080: 6571 5f6c 656e 5f77 6974 686f 7574 5f70  eq_len_without_p
-0005b090: 6173 740a 2020 2020 2f2f 636f 6e73 7420  ast.    //const 
-0005b0a0: 696e 7420 6e65 3220 3d20 7372 6330 2d3e  int ne2 = src0->
-0005b0b0: 6e65 5b32 5d3b 202f 2f20 6e5f 6865 6164  ne[2]; // n_head
-0005b0c0: 202d 3e20 7468 6973 2069 7320 6b0a 2020   -> this is k.  
-0005b0d0: 2020 2f2f 636f 6e73 7420 696e 7420 6e65    //const int ne
-0005b0e0: 3320 3d20 7372 6330 2d3e 6e65 5b33 5d3b  3 = src0->ne[3];
-0005b0f0: 202f 2f20 3120 2d3e 2062 737a 0a0a 2020   // 1 -> bsz..  
-0005b100: 2020 636f 6e73 7420 696e 7420 6e20 203d    const int n  =
-0005b110: 2067 676d 6c5f 6e72 6f77 7328 7372 6330   ggml_nrows(src0
-0005b120: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
-0005b130: 206e 6532 5f6e 6533 203d 206e 2f6e 6531   ne2_ne3 = n/ne1
-0005b140: 3b20 2f2f 206e 6532 2a6e 6533 0a0a 2020  ; // ne2*ne3..  
-0005b150: 2020 636f 6e73 7420 696e 7420 6e62 3020    const int nb0 
-0005b160: 3d20 7372 6330 2d3e 6e62 5b30 5d3b 0a20  = src0->nb[0];. 
-0005b170: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
-0005b180: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
-0005b190: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-0005b1a0: 3220 3d20 7372 6330 2d3e 6e62 5b32 5d3b  2 = src0->nb[2];
-0005b1b0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-0005b1c0: 206e 6233 203d 2073 7263 302d 3e6e 625b   nb3 = src0->nb[
-0005b1d0: 335d 3b0a 0a20 2020 2061 7373 6572 7428  3];..    assert(
-0005b1e0: 6e62 3020 3d3d 2073 697a 656f 6628 6767  nb0 == sizeof(gg
-0005b1f0: 6d6c 5f66 7031 365f 7429 293b 0a20 2020  ml_fp16_t));.   
-0005b200: 2061 7373 6572 7428 6e65 3120 2b20 6e5f   assert(ne1 + n_
-0005b210: 7061 7374 203d 3d20 6e65 3029 3b20 2876  past == ne0); (v
-0005b220: 6f69 6429 206e 5f70 6173 743b 0a0a 2020  oid) n_past;..  
-0005b230: 2020 2f2f 2061 6464 2061 6c69 6269 2074    // add alibi t
-0005b240: 6f20 7372 6330 2028 4b51 5f73 6361 6c65  o src0 (KQ_scale
-0005b250: 6429 0a20 2020 2063 6f6e 7374 2069 6e74  d).    const int
-0005b260: 206e 5f68 6561 6473 5f6c 6f67 325f 666c   n_heads_log2_fl
-0005b270: 6f6f 7220 3d20 3120 3c3c 2028 696e 7429  oor = 1 << (int)
-0005b280: 2066 6c6f 6f72 286c 6f67 3228 6e5f 6865   floor(log2(n_he
-0005b290: 6164 2929 3b0a 0a20 2020 2063 6f6e 7374  ad));..    const
-0005b2a0: 2066 6c6f 6174 206d 3020 3d20 706f 7766   float m0 = powf
-0005b2b0: 2832 2e30 662c 202d 286d 6178 5f62 6961  (2.0f, -(max_bia
-0005b2c0: 7329 202f 206e 5f68 6561 6473 5f6c 6f67  s) / n_heads_log
-0005b2d0: 325f 666c 6f6f 7229 3b0a 2020 2020 636f  2_floor);.    co
-0005b2e0: 6e73 7420 666c 6f61 7420 6d31 203d 2070  nst float m1 = p
-0005b2f0: 6f77 6628 322e 3066 2c20 2d28 6d61 785f  owf(2.0f, -(max_
-0005b300: 6269 6173 202f 2032 2e30 6629 202f 206e  bias / 2.0f) / n
-0005b310: 5f68 6561 6473 5f6c 6f67 325f 666c 6f6f  _heads_log2_floo
-0005b320: 7229 3b0a 0a20 2020 2066 6f72 2028 696e  r);..    for (in
-0005b330: 7420 6920 3d20 303b 2069 203c 206e 6530  t i = 0; i < ne0
-0005b340: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-0005b350: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-0005b360: 206a 203c 206e 6531 3b20 6a2b 2b29 207b   j < ne1; j++) {
-0005b370: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0005b380: 2028 696e 7420 6b20 3d20 303b 206b 203c   (int k = 0; k <
-0005b390: 206e 6532 5f6e 6533 3b20 6b2b 2b29 207b   ne2_ne3; k++) {
-0005b3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005b3b0: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
-0005b3c0: 6f6e 7374 2073 7263 2020 3d20 2867 676d  onst src  = (ggm
-0005b3d0: 6c5f 6670 3136 5f74 202a 2928 2863 6861  l_fp16_t *)((cha
-0005b3e0: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-0005b3f0: 2b20 692a 6e62 3020 2b20 6a2a 6e62 3120  + i*nb0 + j*nb1 
-0005b400: 2b20 6b2a 6e62 3229 3b0a 2020 2020 2020  + k*nb2);.      
-0005b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005b420: 666c 6f61 7420 2a20 2020 2020 2070 6473  float *      pds
-0005b430: 7420 203d 2020 2020 2020 2028 666c 6f61  t  =       (floa
-0005b440: 7420 2a29 2828 6368 6172 202a 2920 2064  t *)((char *)  d
-0005b450: 7374 2d3e 6461 7461 202b 2069 2a6e 6230  st->data + i*nb0
-0005b460: 202b 206a 2a6e 6231 202b 206b 2a6e 6232   + j*nb1 + k*nb2
-0005b470: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0005b480: 2020 2020 2f2f 2054 4f44 4f3a 206b 2a6e      // TODO: k*n
-0005b490: 6232 206f 7220 6b2a 6e62 330a 0a20 2020  b2 or k*nb3..   
-0005b4a0: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-0005b4b0: 6174 206d 5f6b 3b0a 0a20 2020 2020 2020  at m_k;..       
-0005b4c0: 2020 2020 2020 2020 2069 6620 286b 203c           if (k <
-0005b4d0: 206e 5f68 6561 6473 5f6c 6f67 325f 666c   n_heads_log2_fl
-0005b4e0: 6f6f 7229 207b 0a20 2020 2020 2020 2020  oor) {.         
-0005b4f0: 2020 2020 2020 2020 2020 206d 5f6b 203d             m_k =
-0005b500: 2070 6f77 6628 6d30 2c20 6b20 2b20 3129   powf(m0, k + 1)
-0005b510: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0005b520: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-0005b530: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0005b540: 5f6b 203d 2070 6f77 6628 6d31 2c20 3220  _k = powf(m1, 2 
-0005b550: 2a20 286b 202d 206e 5f68 6561 6473 5f6c  * (k - n_heads_l
-0005b560: 6f67 325f 666c 6f6f 7229 202b 2031 293b  og2_floor) + 1);
-0005b570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005b580: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-0005b590: 2020 2020 2f2f 2077 6520 7265 7475 726e      // we return
-0005b5a0: 2046 3332 0a20 2020 2020 2020 2020 2020   F32.           
-0005b5b0: 2020 2020 2070 6473 745b 305d 203d 2028       pdst[0] = (
-0005b5c0: 692d 6e65 302b 3129 202a 206d 5f6b 202b  i-ne0+1) * m_k +
-0005b5d0: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
-0005b5e0: 3332 2873 7263 5b30 5d29 3b0a 2020 2020  32(src[0]);.    
-0005b5f0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0005b600: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
-0005b610: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-0005b620: 6d70 7574 655f 666f 7277 6172 645f 616c  mpute_forward_al
-0005b630: 6962 6928 0a20 2020 2020 2020 2063 6f6e  ibi(.        con
-0005b640: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-0005b650: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-0005b660: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-0005b670: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0005b680: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-0005b690: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0005b6a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0005b6b0: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-0005b6c0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0005b6d0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-0005b6e0: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
-0005b6f0: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-0005b700: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-0005b710: 3136 3a0a 2020 2020 2020 2020 2020 2020  16:.            
-0005b720: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0005b730: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-0005b740: 6f72 7761 7264 5f61 6c69 6269 5f66 3136  orward_alibi_f16
-0005b750: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
-0005b760: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
-0005b770: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0005b780: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0005b790: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
-0005b7a0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0005b7b0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-0005b7c0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
-0005b7d0: 6c69 6269 5f66 3332 2870 6172 616d 732c  libi_f32(params,
-0005b7e0: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
-0005b7f0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0005b800: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0005b810: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-0005b820: 345f 303a 0a20 2020 2020 2020 2063 6173  4_0:.        cas
-0005b830: 6520 4747 4d4c 5f54 5950 455f 5134 5f31  e GGML_TYPE_Q4_1
-0005b840: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-0005b850: 474d 4c5f 5459 5045 5f51 355f 303a 0a20  GML_TYPE_Q5_0:. 
-0005b860: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0005b870: 5f54 5950 455f 5135 5f31 3a0a 2020 2020  _TYPE_Q5_1:.    
-0005b880: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-0005b890: 5045 5f51 385f 303a 0a20 2020 2020 2020  PE_Q8_0:.       
-0005b8a0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-0005b8b0: 5138 5f31 3a0a 2020 2020 2020 2020 6361  Q8_1:.        ca
-0005b8c0: 7365 2047 474d 4c5f 5459 5045 5f51 325f  se GGML_TYPE_Q2_
-0005b8d0: 4b3a 0a20 2020 2020 2020 2063 6173 6520  K:.        case 
-0005b8e0: 4747 4d4c 5f54 5950 455f 5133 5f4b 3a0a  GGML_TYPE_Q3_K:.
-0005b8f0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0005b900: 4c5f 5459 5045 5f51 345f 4b3a 0a20 2020  L_TYPE_Q4_K:.   
-0005b910: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0005b920: 5950 455f 5135 5f4b 3a0a 2020 2020 2020  YPE_Q5_K:.      
-0005b930: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-0005b940: 5f51 365f 4b3a 0a20 2020 2020 2020 2063  _Q6_K:.        c
-0005b950: 6173 6520 4747 4d4c 5f54 5950 455f 5138  ase GGML_TYPE_Q8
-0005b960: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
-0005b970: 2047 474d 4c5f 5459 5045 5f49 383a 0a20   GGML_TYPE_I8:. 
-0005b980: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0005b990: 5f54 5950 455f 4931 363a 0a20 2020 2020  _TYPE_I16:.     
-0005b9a0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0005b9b0: 455f 4933 323a 0a20 2020 2020 2020 2063  E_I32:.        c
-0005b9c0: 6173 6520 4747 4d4c 5f54 5950 455f 434f  ase GGML_TYPE_CO
-0005b9d0: 554e 543a 0a20 2020 2020 2020 2020 2020  UNT:.           
-0005b9e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0005b9f0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-0005ba00: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-0005ba10: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0005ba20: 7d0a 7d0a 0a0a 2f2f 2067 676d 6c5f 636f  }.}...// ggml_co
-0005ba30: 6d70 7574 655f 666f 7277 6172 645f 636c  mpute_forward_cl
-0005ba40: 616d 700a 0a73 7461 7469 6320 766f 6964  amp..static void
-0005ba50: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-0005ba60: 7277 6172 645f 636c 616d 705f 6633 3228  rward_clamp_f32(
-0005ba70: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0005ba80: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0005ba90: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-0005baa0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-0005bab0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0005bac0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-0005bad0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005bae0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005baf0: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
-0005bb00: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0005bb10: 202a 2064 7374 2920 7b0a 2020 2020 6173   * dst) {.    as
-0005bb20: 7365 7274 2870 6172 616d 732d 3e69 7468  sert(params->ith
-0005bb30: 203d 3d20 3029 3b0a 2020 2020 6173 7365   == 0);.    asse
-0005bb40: 7274 2873 7263 312d 3e74 7970 6520 3d3d  rt(src1->type ==
-0005bb50: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
-0005bb60: 0a20 2020 2061 7373 6572 7428 6767 6d6c  .    assert(ggml
-0005bb70: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
-0005bb80: 203d 3d20 3229 3b0a 0a20 2020 2069 6620   == 2);..    if 
-0005bb90: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-0005bba0: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-0005bbb0: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-0005bbc0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-0005bbd0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-0005bbe0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-0005bbf0: 2020 2020 636f 6e73 7420 696e 7420 6d69      const int mi
-0005bc00: 6e20 3d20 2828 666c 6f61 7420 2a29 2073  n = ((float *) s
-0005bc10: 7263 312d 3e64 6174 6129 5b30 5d3b 0a20  rc1->data)[0];. 
-0005bc20: 2020 2063 6f6e 7374 2069 6e74 206d 6178     const int max
-0005bc30: 203d 2028 2866 6c6f 6174 202a 2920 7372   = ((float *) sr
-0005bc40: 6331 2d3e 6461 7461 295b 315d 3b0a 0a20  c1->data)[1];.. 
-0005bc50: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-0005bc60: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-0005bc70: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-0005bc80: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-0005bc90: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005bca0: 6e20 203d 2067 676d 6c5f 6e72 6f77 7328  n  = ggml_nrows(
-0005bcb0: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
-0005bcc0: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
-0005bcd0: 6e65 5b30 5d3b 0a0a 2020 2020 636f 6e73  ne[0];..    cons
-0005bce0: 7420 7369 7a65 5f74 206e 6230 3020 3d20  t size_t nb00 = 
-0005bcf0: 7372 6330 2d3e 6e62 5b30 5d3b 0a20 2020  src0->nb[0];.   
-0005bd00: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0005bd10: 3031 203d 2073 7263 302d 3e6e 625b 315d  01 = src0->nb[1]
-0005bd20: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
-0005bd30: 655f 7420 6e62 3020 3d20 6473 742d 3e6e  e_t nb0 = dst->n
-0005bd40: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-0005bd50: 7369 7a65 5f74 206e 6231 203d 2064 7374  size_t nb1 = dst
-0005bd60: 2d3e 6e62 5b31 5d3b 0a0a 2020 2020 4747  ->nb[1];..    GG
-0005bd70: 4d4c 5f41 5353 4552 5428 206e 6230 203d  ML_ASSERT( nb0 =
-0005bd80: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-0005bd90: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0005bda0: 5428 6e62 3030 203d 3d20 7369 7a65 6f66  T(nb00 == sizeof
-0005bdb0: 2866 6c6f 6174 2929 3b0a 0a20 2020 2066  (float));..    f
-0005bdc0: 6f72 2028 696e 7420 6a20 3d20 6974 683b  or (int j = ith;
-0005bdd0: 206a 203c 206e 3b20 6a20 2b3d 206e 7468   j < n; j += nth
-0005bde0: 2920 7b0a 2020 2020 2020 2020 666c 6f61  ) {.        floa
-0005bdf0: 7420 2a20 6473 745f 7074 7220 203d 2028  t * dst_ptr  = (
-0005be00: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-0005be10: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
-0005be20: 6a2a 6e62 3129 3b0a 2020 2020 2020 2020  j*nb1);.        
-0005be30: 666c 6f61 7420 2a20 7372 6330 5f70 7472  float * src0_ptr
-0005be40: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
-0005be50: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-0005be60: 6120 2b20 6a2a 6e62 3031 293b 0a0a 2020  a + j*nb01);..  
-0005be70: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0005be80: 203d 2030 3b20 6920 3c20 6e63 3b20 692b   = 0; i < nc; i+
-0005be90: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-0005bea0: 2064 7374 5f70 7472 5b69 5d20 3d20 4d41   dst_ptr[i] = MA
-0005beb0: 5828 4d49 4e28 7372 6330 5f70 7472 5b69  X(MIN(src0_ptr[i
-0005bec0: 5d2c 206d 6178 292c 206d 696e 293b 0a20  ], max), min);. 
-0005bed0: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
-0005bee0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-0005bef0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0005bf00: 7264 5f63 6c61 6d70 280a 2020 2020 2020  rd_clamp(.      
-0005bf10: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005bf20: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0005bf30: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0005bf40: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005bf50: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005bf60: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-0005bf70: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0005bf80: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-0005bf90: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0005bfa0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0005bfb0: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
-0005bfc0: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
-0005bfd0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0005bfe0: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-0005bff0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0005c000: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-0005c010: 7574 655f 666f 7277 6172 645f 636c 616d  ute_forward_clam
-0005c020: 705f 6633 3228 7061 7261 6d73 2c20 7372  p_f32(params, sr
-0005c030: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
-0005c040: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0005c050: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0005c060: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
-0005c070: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0005c080: 4d4c 5f54 5950 455f 5134 5f30 3a0a 2020  ML_TYPE_Q4_0:.  
-0005c090: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0005c0a0: 5459 5045 5f51 345f 313a 0a20 2020 2020  TYPE_Q4_1:.     
-0005c0b0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0005c0c0: 455f 5135 5f30 3a0a 2020 2020 2020 2020  E_Q5_0:.        
-0005c0d0: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-0005c0e0: 355f 313a 0a20 2020 2020 2020 2063 6173  5_1:.        cas
-0005c0f0: 6520 4747 4d4c 5f54 5950 455f 5138 5f30  e GGML_TYPE_Q8_0
-0005c100: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-0005c110: 474d 4c5f 5459 5045 5f51 385f 313a 0a20  GML_TYPE_Q8_1:. 
-0005c120: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0005c130: 5f54 5950 455f 5132 5f4b 3a0a 2020 2020  _TYPE_Q2_K:.    
-0005c140: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-0005c150: 5045 5f51 335f 4b3a 0a20 2020 2020 2020  PE_Q3_K:.       
-0005c160: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-0005c170: 5134 5f4b 3a0a 2020 2020 2020 2020 6361  Q4_K:.        ca
-0005c180: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
-0005c190: 4b3a 0a20 2020 2020 2020 2063 6173 6520  K:.        case 
-0005c1a0: 4747 4d4c 5f54 5950 455f 5136 5f4b 3a0a  GGML_TYPE_Q6_K:.
-0005c1b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0005c1c0: 4c5f 5459 5045 5f51 385f 4b3a 0a20 2020  L_TYPE_Q8_K:.   
-0005c1d0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0005c1e0: 5950 455f 4938 3a0a 2020 2020 2020 2020  YPE_I8:.        
-0005c1f0: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
-0005c200: 3136 3a0a 2020 2020 2020 2020 6361 7365  16:.        case
-0005c210: 2047 474d 4c5f 5459 5045 5f49 3332 3a0a   GGML_TYPE_I32:.
-0005c220: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0005c230: 4c5f 5459 5045 5f43 4f55 4e54 3a0a 2020  L_TYPE_COUNT:.  
-0005c240: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0005c250: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0005c260: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-0005c270: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0005c280: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
-0005c290: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-0005c2a0: 7277 6172 645f 726f 7065 0a0a 7374 6174  rward_rope..stat
-0005c2b0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-0005c2c0: 7075 7465 5f66 6f72 7761 7264 5f72 6f70  pute_forward_rop
-0005c2d0: 655f 6633 3228 0a20 2020 2020 2020 2063  e_f32(.        c
-0005c2e0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0005c2f0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-0005c300: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-0005c310: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005c320: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-0005c330: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-0005c340: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0005c350: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-0005c360: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0005c370: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-0005c380: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0005c390: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-0005c3a0: 4d4c 5f54 5950 455f 4933 3229 3b0a 2020  ML_TYPE_I32);.  
-0005c3b0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-0005c3c0: 6d6c 5f6e 656c 656d 656e 7473 2873 7263  ml_nelements(src
-0005c3d0: 3129 203d 3d20 3329 3b0a 0a20 2020 2069  1) == 3);..    i
-0005c3e0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-0005c3f0: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-0005c400: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
-0005c410: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-0005c420: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-0005c430: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-0005c440: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005c450: 6e5f 7061 7374 203d 2028 2869 6e74 3332  n_past = ((int32
-0005c460: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
-0005c470: 295b 305d 3b0a 2020 2020 636f 6e73 7420  )[0];.    const 
-0005c480: 696e 7420 6e5f 6469 6d73 203d 2028 2869  int n_dims = ((i
-0005c490: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-0005c4a0: 6461 7461 295b 315d 3b0a 2020 2020 636f  data)[1];.    co
-0005c4b0: 6e73 7420 696e 7420 6d6f 6465 2020 203d  nst int mode   =
-0005c4c0: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-0005c4d0: 6331 2d3e 6461 7461 295b 325d 3b0a 0a20  c1->data)[2];.. 
-0005c4e0: 2020 2061 7373 6572 7428 6e5f 7061 7374     assert(n_past
-0005c4f0: 203e 3d20 3029 3b0a 0a20 2020 2063 6f6e   >= 0);..    con
-0005c500: 7374 2073 697a 655f 7420 6e62 3030 203d  st size_t nb00 =
-0005c510: 2073 7263 302d 3e6e 625b 305d 3b0a 2020   src0->nb[0];.  
-0005c520: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0005c530: 6230 3120 3d20 7372 6330 2d3e 6e62 5b31  b01 = src0->nb[1
-0005c540: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-0005c550: 655f 7420 6e62 3032 203d 2073 7263 302d  e_t nb02 = src0-
-0005c560: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
-0005c570: 7420 7369 7a65 5f74 206e 6230 3320 3d20  t size_t nb03 = 
-0005c580: 7372 6330 2d3e 6e62 5b33 5d3b 0a0a 2020  src0->nb[3];..  
-0005c590: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0005c5a0: 6e65 3020 3d20 6473 742d 3e6e 655b 305d  ne0 = dst->ne[0]
-0005c5b0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-0005c5c0: 345f 7420 6e65 3120 3d20 6473 742d 3e6e  4_t ne1 = dst->n
-0005c5d0: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-0005c5e0: 696e 7436 345f 7420 6e65 3220 3d20 6473  int64_t ne2 = ds
-0005c5f0: 742d 3e6e 655b 325d 3b0a 2020 2020 636f  t->ne[2];.    co
-0005c600: 6e73 7420 696e 7436 345f 7420 6e65 3320  nst int64_t ne3 
-0005c610: 3d20 6473 742d 3e6e 655b 335d 3b0a 0a20  = dst->ne[3];.. 
-0005c620: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0005c630: 6e62 3020 3d20 6473 742d 3e6e 625b 305d  nb0 = dst->nb[0]
-0005c640: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-0005c650: 5f74 206e 6231 203d 2064 7374 2d3e 6e62  _t nb1 = dst->nb
-0005c660: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2073  [1];.    const s
-0005c670: 697a 655f 7420 6e62 3220 3d20 6473 742d  ize_t nb2 = dst-
-0005c680: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
-0005c690: 7420 7369 7a65 5f74 206e 6233 203d 2064  t size_t nb3 = d
-0005c6a0: 7374 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  st->nb[3];..    
-0005c6b0: 2f2f 7072 696e 7466 2822 6e65 303a 2025  //printf("ne0: %
-0005c6c0: 642c 206e 6531 3a20 2564 2c20 6e65 323a  d, ne1: %d, ne2:
-0005c6d0: 2025 642c 206e 6533 3a20 2564 5c6e 222c   %d, ne3: %d\n",
-0005c6e0: 206e 6530 2c20 6e65 312c 206e 6532 2c20   ne0, ne1, ne2, 
-0005c6f0: 6e65 3329 3b0a 2020 2020 2f2f 7072 696e  ne3);.    //prin
-0005c700: 7466 2822 6e5f 7061 7374 203d 2025 642c  tf("n_past = %d,
-0005c710: 206e 6532 203d 2025 645c 6e22 2c20 6e5f   ne2 = %d\n", n_
-0005c720: 7061 7374 2c20 6e65 3229 3b0a 0a20 2020  past, ne2);..   
-0005c730: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
-0005c740: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-0005c750: 7429 293b 0a0a 2020 2020 636f 6e73 7420  t));..    const 
-0005c760: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
-0005c770: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-0005c780: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
-0005c790: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
-0005c7a0: 7374 2069 6e74 206e 7220 3d20 6767 6d6c  st int nr = ggml
-0005c7b0: 5f6e 726f 7773 2864 7374 293b 0a0a 2020  _nrows(dst);..  
-0005c7c0: 2020 4747 4d4c 5f41 5353 4552 5428 6e5f    GGML_ASSERT(n_
-0005c7d0: 6469 6d73 203c 3d20 6e65 3029 3b0a 2020  dims <= ne0);.  
-0005c7e0: 2020 4747 4d4c 5f41 5353 4552 5428 6e5f    GGML_ASSERT(n_
-0005c7f0: 6469 6d73 2025 2032 203d 3d20 3029 3b0a  dims % 2 == 0);.
-0005c800: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
-0005c810: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-0005c820: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
-0005c830: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
-0005c840: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
-0005c850: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
-0005c860: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-0005c870: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
-0005c880: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
-0005c890: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
-0005c8a0: 7229 3b0a 0a20 2020 202f 2f20 726f 7720  r);..    // row 
-0005c8b0: 696e 6465 7820 7573 6564 2074 6f20 6465  index used to de
-0005c8c0: 7465 726d 696e 6520 7768 6963 6820 7468  termine which th
-0005c8d0: 7265 6164 2074 6f20 7573 650a 2020 2020  read to use.    
-0005c8e0: 696e 7420 6972 203d 2030 3b0a 0a20 2020  int ir = 0;..   
-0005c8f0: 2063 6f6e 7374 2066 6c6f 6174 2074 6865   const float the
-0005c900: 7461 5f73 6361 6c65 203d 2070 6f77 6628  ta_scale = powf(
-0005c910: 3130 3030 302e 302c 202d 322e 3066 2f6e  10000.0, -2.0f/n
-0005c920: 5f64 696d 7329 3b0a 0a20 2020 2063 6f6e  _dims);..    con
-0005c930: 7374 2062 6f6f 6c20 6973 5f6e 656f 7820  st bool is_neox 
-0005c940: 3d20 6d6f 6465 2026 2032 3b0a 0a20 2020  = mode & 2;..   
-0005c950: 2066 6f72 2028 696e 7436 345f 7420 6933   for (int64_t i3
-0005c960: 203d 2030 3b20 6933 203c 206e 6533 3b20   = 0; i3 < ne3; 
-0005c970: 6933 2b2b 2920 7b0a 2020 2020 2020 2020  i3++) {.        
-0005c980: 666f 7220 2869 6e74 3634 5f74 2069 3220  for (int64_t i2 
-0005c990: 3d20 2828 6d6f 6465 2026 2031 2920 3d3d  = ((mode & 1) ==
-0005c9a0: 2030 203f 2030 203a 206e 5f70 6173 7429   0 ? 0 : n_past)
-0005c9b0: 3b20 6932 203c 206e 6532 3b20 6932 2b2b  ; i2 < ne2; i2++
-0005c9c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005c9d0: 636f 6e73 7420 696e 7436 345f 7420 7020  const int64_t p 
-0005c9e0: 3d20 2828 6d6f 6465 2026 2031 2920 3d3d  = ((mode & 1) ==
-0005c9f0: 2030 203f 206e 5f70 6173 7420 2b20 6932   0 ? n_past + i2
-0005ca00: 203a 2069 3229 3b0a 2020 2020 2020 2020   : i2);.        
-0005ca10: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0005ca20: 2069 3120 3d20 303b 2069 3120 3c20 6e65   i1 = 0; i1 < ne
-0005ca30: 313b 2069 312b 2b29 207b 0a20 2020 2020  1; i1++) {.     
-0005ca40: 2020 2020 2020 2020 2020 2069 6620 2869             if (i
-0005ca50: 722b 2b20 3c20 6972 3029 2063 6f6e 7469  r++ < ir0) conti
-0005ca60: 6e75 653b 0a20 2020 2020 2020 2020 2020  nue;.           
-0005ca70: 2020 2020 2069 6620 2869 7220 2020 3e20       if (ir   > 
-0005ca80: 6972 3129 2062 7265 616b 3b0a 0a20 2020  ir1) break;..   
-0005ca90: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-0005caa0: 6174 2074 6865 7461 203d 2028 666c 6f61  at theta = (floa
-0005cab0: 7429 703b 0a0a 2020 2020 2020 2020 2020  t)p;..          
-0005cac0: 2020 2020 2020 6966 2028 2169 735f 6e65        if (!is_ne
-0005cad0: 6f78 2920 7b0a 2020 2020 2020 2020 2020  ox) {.          
-0005cae0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0005caf0: 6e74 3634 5f74 2069 3020 3d20 303b 2069  nt64_t i0 = 0; i
-0005cb00: 3020 3c20 6e65 303b 2069 3020 2b3d 2032  0 < ne0; i0 += 2
-0005cb10: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005cb20: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0005cb30: 7420 666c 6f61 7420 636f 735f 7468 6574  t float cos_thet
-0005cb40: 6120 3d20 636f 7366 2874 6865 7461 293b  a = cosf(theta);
-0005cb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005cb60: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0005cb70: 6c6f 6174 2073 696e 5f74 6865 7461 203d  loat sin_theta =
-0005cb80: 2073 696e 6628 7468 6574 6129 3b0a 0a20   sinf(theta);.. 
-0005cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005cba0: 2020 2020 2020 2074 6865 7461 202a 3d20         theta *= 
-0005cbb0: 7468 6574 615f 7363 616c 653b 0a0a 2020  theta_scale;..  
-0005cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005cbd0: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-0005cbe0: 7420 2a20 636f 6e73 7420 7372 6320 3d20  t * const src = 
-0005cbf0: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
-0005cc00: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-0005cc10: 6933 2a6e 6230 3320 2b20 6932 2a6e 6230  i3*nb03 + i2*nb0
-0005cc20: 3220 2b20 6931 2a6e 6230 3120 2b20 6930  2 + i1*nb01 + i0
-0005cc30: 2a6e 6230 3029 3b0a 2020 2020 2020 2020  *nb00);.        
-0005cc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005cc50: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
-0005cc60: 745f 6461 7461 2020 3d20 2866 6c6f 6174  t_data  = (float
-0005cc70: 202a 2928 2863 6861 7220 2a29 2020 6473   *)((char *)  ds
-0005cc80: 742d 3e64 6174 6120 2b20 6933 2a6e 6233  t->data + i3*nb3
-0005cc90: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
-0005cca0: 2a6e 6231 2020 2b20 6930 2a6e 6230 293b  *nb1  + i0*nb0);
-0005ccb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0005ccc0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0005ccd0: 666c 6f61 7420 7830 203d 2073 7263 5b30  float x0 = src[0
-0005cce0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0005ccf0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005cd00: 2066 6c6f 6174 2078 3120 3d20 7372 635b   float x1 = src[
-0005cd10: 315d 3b0a 0a20 2020 2020 2020 2020 2020  1];..           
-0005cd20: 2020 2020 2020 2020 2020 2020 2064 7374               dst
-0005cd30: 5f64 6174 615b 305d 203d 2078 302a 636f  _data[0] = x0*co
-0005cd40: 735f 7468 6574 6120 2d20 7831 2a73 696e  s_theta - x1*sin
-0005cd50: 5f74 6865 7461 3b0a 2020 2020 2020 2020  _theta;.        
+0005a820: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
+0005a830: 202f 2f20 7365 715f 6c65 6e5f 7769 7468   // seq_len_with
+0005a840: 6f75 745f 7061 7374 0a20 2020 202f 2f63  out_past.    //c
+0005a850: 6f6e 7374 2069 6e74 206e 6532 203d 2073  onst int ne2 = s
+0005a860: 7263 302d 3e6e 655b 325d 3b20 2f2f 206e  rc0->ne[2]; // n
+0005a870: 5f68 6561 6420 2d3e 2074 6869 7320 6973  _head -> this is
+0005a880: 206b 0a20 2020 202f 2f63 6f6e 7374 2069   k.    //const i
+0005a890: 6e74 206e 6533 203d 2073 7263 302d 3e6e  nt ne3 = src0->n
+0005a8a0: 655b 335d 3b20 2f2f 2031 202d 3e20 6273  e[3]; // 1 -> bs
+0005a8b0: 7a0a 0a20 2020 2063 6f6e 7374 2069 6e74  z..    const int
+0005a8c0: 206e 2020 3d20 6767 6d6c 5f6e 726f 7773   n  = ggml_nrows
+0005a8d0: 2873 7263 3029 3b0a 2020 2020 636f 6e73  (src0);.    cons
+0005a8e0: 7420 696e 7420 6e65 325f 6e65 3320 3d20  t int ne2_ne3 = 
+0005a8f0: 6e2f 6e65 313b 202f 2f20 6e65 322a 6e65  n/ne1; // ne2*ne
+0005a900: 330a 0a20 2020 2063 6f6e 7374 2069 6e74  3..    const int
+0005a910: 206e 6230 203d 2073 7263 302d 3e6e 625b   nb0 = src0->nb[
+0005a920: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0005a930: 7420 6e62 3120 3d20 7372 6330 2d3e 6e62  t nb1 = src0->nb
+0005a940: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+0005a950: 6e74 206e 6232 203d 2073 7263 302d 3e6e  nt nb2 = src0->n
+0005a960: 625b 325d 3b0a 2020 2020 2f2f 636f 6e73  b[2];.    //cons
+0005a970: 7420 696e 7420 6e62 3320 3d20 7372 6330  t int nb3 = src0
+0005a980: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 6173  ->nb[3];..    as
+0005a990: 7365 7274 286e 6230 203d 3d20 7369 7a65  sert(nb0 == size
+0005a9a0: 6f66 2866 6c6f 6174 2929 3b0a 2020 2020  of(float));.    
+0005a9b0: 6173 7365 7274 286e 6531 202b 206e 5f70  assert(ne1 + n_p
+0005a9c0: 6173 7420 3d3d 206e 6530 293b 2028 766f  ast == ne0); (vo
+0005a9d0: 6964 2920 6e5f 7061 7374 3b0a 0a20 2020  id) n_past;..   
+0005a9e0: 202f 2f20 6164 6420 616c 6962 6920 746f   // add alibi to
+0005a9f0: 2073 7263 3020 284b 515f 7363 616c 6564   src0 (KQ_scaled
+0005aa00: 290a 2020 2020 636f 6e73 7420 696e 7420  ).    const int 
+0005aa10: 6e5f 6865 6164 735f 6c6f 6732 5f66 6c6f  n_heads_log2_flo
+0005aa20: 6f72 203d 2031 203c 3c20 2869 6e74 2920  or = 1 << (int) 
+0005aa30: 666c 6f6f 7228 6c6f 6732 286e 5f68 6561  floor(log2(n_hea
+0005aa40: 6429 293b 0a0a 2020 2020 636f 6e73 7420  d));..    const 
+0005aa50: 666c 6f61 7420 6d30 203d 2070 6f77 6628  float m0 = powf(
+0005aa60: 322e 3066 2c20 2d28 6d61 785f 6269 6173  2.0f, -(max_bias
+0005aa70: 2920 2f20 6e5f 6865 6164 735f 6c6f 6732  ) / n_heads_log2
+0005aa80: 5f66 6c6f 6f72 293b 0a20 2020 2063 6f6e  _floor);.    con
+0005aa90: 7374 2066 6c6f 6174 206d 3120 3d20 706f  st float m1 = po
+0005aaa0: 7766 2832 2e30 662c 202d 286d 6178 5f62  wf(2.0f, -(max_b
+0005aab0: 6961 7320 2f20 322e 3066 2920 2f20 6e5f  ias / 2.0f) / n_
+0005aac0: 6865 6164 735f 6c6f 6732 5f66 6c6f 6f72  heads_log2_floor
+0005aad0: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
+0005aae0: 2069 203d 2030 3b20 6920 3c20 6e65 303b   i = 0; i < ne0;
+0005aaf0: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+0005ab00: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
+0005ab10: 6a20 3c20 6e65 313b 206a 2b2b 2920 7b0a  j < ne1; j++) {.
+0005ab20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0005ab30: 2869 6e74 206b 203d 2030 3b20 6b20 3c20  (int k = 0; k < 
+0005ab40: 6e65 325f 6e65 333b 206b 2b2b 2920 7b0a  ne2_ne3; k++) {.
+0005ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ab60: 666c 6f61 7420 2a20 636f 6e73 7420 7372  float * const sr
+0005ab70: 6320 3d20 2866 6c6f 6174 202a 2928 2863  c = (float *)((c
+0005ab80: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+0005ab90: 6120 2b20 692a 6e62 3020 2b20 6a2a 6e62  a + i*nb0 + j*nb
+0005aba0: 3120 2b20 6b2a 6e62 3229 3b0a 2020 2020  1 + k*nb2);.    
+0005abb0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+0005abc0: 7420 2a20 2020 2020 2070 6473 7420 3d20  t *      pdst = 
+0005abd0: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
+0005abe0: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
+0005abf0: 692a 6e62 3020 2b20 6a2a 6e62 3120 2b20  i*nb0 + j*nb1 + 
+0005ac00: 6b2a 6e62 3229 3b0a 0a20 2020 2020 2020  k*nb2);..       
+0005ac10: 2020 2020 2020 2020 202f 2f20 544f 444f           // TODO
+0005ac20: 3a20 6b2a 6e62 3220 6f72 206b 2a6e 6233  : k*nb2 or k*nb3
+0005ac30: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0005ac40: 2020 666c 6f61 7420 6d5f 6b3b 0a0a 2020    float m_k;..  
+0005ac50: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0005ac60: 2028 6b20 3c20 6e5f 6865 6164 735f 6c6f   (k < n_heads_lo
+0005ac70: 6732 5f66 6c6f 6f72 2920 7b0a 2020 2020  g2_floor) {.    
+0005ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ac90: 6d5f 6b20 3d20 706f 7766 286d 302c 206b  m_k = powf(m0, k
+0005aca0: 202b 2031 293b 0a20 2020 2020 2020 2020   + 1);.         
+0005acb0: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+0005acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005acd0: 2020 2020 6d5f 6b20 3d20 706f 7766 286d      m_k = powf(m
+0005ace0: 312c 2032 202a 2028 6b20 2d20 6e5f 6865  1, 2 * (k - n_he
+0005acf0: 6164 735f 6c6f 6732 5f66 6c6f 6f72 2920  ads_log2_floor) 
+0005ad00: 2b20 3129 3b0a 2020 2020 2020 2020 2020  + 1);.          
+0005ad10: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0005ad20: 2020 2020 2020 2020 2070 6473 745b 305d           pdst[0]
+0005ad30: 203d 2028 692d 6e65 302b 3129 202a 206d   = (i-ne0+1) * m
+0005ad40: 5f6b 202b 2073 7263 5b30 5d3b 0a0a 2020  _k + src[0];..  
+0005ad50: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0005ad60: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
+0005ad70: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+0005ad80: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0005ad90: 616c 6962 695f 6631 3628 0a20 2020 2020  alibi_f16(.     
+0005ada0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0005adb0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+0005adc0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+0005add0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0005ade0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0005adf0: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+0005ae00: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0005ae10: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+0005ae20: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0005ae30: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+0005ae40: 2920 7b0a 2020 2020 6173 7365 7274 2870  ) {.    assert(p
+0005ae50: 6172 616d 732d 3e69 7468 203d 3d20 3029  arams->ith == 0)
+0005ae60: 3b0a 2020 2020 6173 7365 7274 2873 7263  ;.    assert(src
+0005ae70: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
+0005ae80: 5459 5045 5f49 3332 293b 0a20 2020 2061  TYPE_I32);.    a
+0005ae90: 7373 6572 7428 6767 6d6c 5f6e 656c 656d  ssert(ggml_nelem
+0005aea0: 656e 7473 2873 7263 3129 203d 3d20 3329  ents(src1) == 3)
+0005aeb0: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+0005aec0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+0005aed0: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
+0005aee0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+0005aef0: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+0005af00: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+0005af10: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
+0005af20: 6e73 7420 696e 7420 2020 6e5f 7061 7374  nst int   n_past
+0005af30: 2020 203d 2028 2869 6e74 3332 5f74 202a     = ((int32_t *
+0005af40: 2920 7372 6331 2d3e 6461 7461 295b 305d  ) src1->data)[0]
+0005af50: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0005af60: 2020 6e5f 6865 6164 2020 203d 2028 2869    n_head   = ((i
+0005af70: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
+0005af80: 6461 7461 295b 315d 3b0a 2020 2020 636f  data)[1];.    co
+0005af90: 6e73 7420 666c 6f61 7420 6d61 785f 6269  nst float max_bi
+0005afa0: 6173 203d 2028 2866 6c6f 6174 202a 2920  as = ((float *) 
+0005afb0: 2020 7372 6331 2d3e 6461 7461 295b 325d    src1->data)[2]
+0005afc0: 3b0a 0a20 2020 2061 7373 6572 7428 6e5f  ;..    assert(n_
+0005afd0: 7061 7374 203e 3d20 3029 3b0a 0a20 2020  past >= 0);..   
+0005afe0: 2063 6f6e 7374 2069 6e74 206e 6530 203d   const int ne0 =
+0005aff0: 2073 7263 302d 3e6e 655b 305d 3b20 2f2f   src0->ne[0]; //
+0005b000: 2061 6c6c 5f73 6571 5f6c 656e 203d 206e   all_seq_len = n
+0005b010: 5f70 6173 7420 2b20 6e65 310a 2020 2020  _past + ne1.    
+0005b020: 636f 6e73 7420 696e 7420 6e65 3120 3d20  const int ne1 = 
+0005b030: 7372 6330 2d3e 6e65 5b31 5d3b 202f 2f20  src0->ne[1]; // 
+0005b040: 7365 715f 6c65 6e5f 7769 7468 6f75 745f  seq_len_without_
+0005b050: 7061 7374 0a20 2020 202f 2f63 6f6e 7374  past.    //const
+0005b060: 2069 6e74 206e 6532 203d 2073 7263 302d   int ne2 = src0-
+0005b070: 3e6e 655b 325d 3b20 2f2f 206e 5f68 6561  >ne[2]; // n_hea
+0005b080: 6420 2d3e 2074 6869 7320 6973 206b 0a20  d -> this is k. 
+0005b090: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+0005b0a0: 6533 203d 2073 7263 302d 3e6e 655b 335d  e3 = src0->ne[3]
+0005b0b0: 3b20 2f2f 2031 202d 3e20 6273 7a0a 0a20  ; // 1 -> bsz.. 
+0005b0c0: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
+0005b0d0: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
+0005b0e0: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+0005b0f0: 7420 6e65 325f 6e65 3320 3d20 6e2f 6e65  t ne2_ne3 = n/ne
+0005b100: 313b 202f 2f20 6e65 322a 6e65 330a 0a20  1; // ne2*ne3.. 
+0005b110: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
+0005b120: 203d 2073 7263 302d 3e6e 625b 305d 3b0a   = src0->nb[0];.
+0005b130: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+0005b140: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
+0005b150: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005b160: 6232 203d 2073 7263 302d 3e6e 625b 325d  b2 = src0->nb[2]
+0005b170: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+0005b180: 7420 6e62 3320 3d20 7372 6330 2d3e 6e62  t nb3 = src0->nb
+0005b190: 5b33 5d3b 0a0a 2020 2020 6173 7365 7274  [3];..    assert
+0005b1a0: 286e 6230 203d 3d20 7369 7a65 6f66 2867  (nb0 == sizeof(g
+0005b1b0: 676d 6c5f 6670 3136 5f74 2929 3b0a 2020  gml_fp16_t));.  
+0005b1c0: 2020 6173 7365 7274 286e 6531 202b 206e    assert(ne1 + n
+0005b1d0: 5f70 6173 7420 3d3d 206e 6530 293b 2028  _past == ne0); (
+0005b1e0: 766f 6964 2920 6e5f 7061 7374 3b0a 0a20  void) n_past;.. 
+0005b1f0: 2020 202f 2f20 6164 6420 616c 6962 6920     // add alibi 
+0005b200: 746f 2073 7263 3020 284b 515f 7363 616c  to src0 (KQ_scal
+0005b210: 6564 290a 2020 2020 636f 6e73 7420 696e  ed).    const in
+0005b220: 7420 6e5f 6865 6164 735f 6c6f 6732 5f66  t n_heads_log2_f
+0005b230: 6c6f 6f72 203d 2031 203c 3c20 2869 6e74  loor = 1 << (int
+0005b240: 2920 666c 6f6f 7228 6c6f 6732 286e 5f68  ) floor(log2(n_h
+0005b250: 6561 6429 293b 0a0a 2020 2020 636f 6e73  ead));..    cons
+0005b260: 7420 666c 6f61 7420 6d30 203d 2070 6f77  t float m0 = pow
+0005b270: 6628 322e 3066 2c20 2d28 6d61 785f 6269  f(2.0f, -(max_bi
+0005b280: 6173 2920 2f20 6e5f 6865 6164 735f 6c6f  as) / n_heads_lo
+0005b290: 6732 5f66 6c6f 6f72 293b 0a20 2020 2063  g2_floor);.    c
+0005b2a0: 6f6e 7374 2066 6c6f 6174 206d 3120 3d20  onst float m1 = 
+0005b2b0: 706f 7766 2832 2e30 662c 202d 286d 6178  powf(2.0f, -(max
+0005b2c0: 5f62 6961 7320 2f20 322e 3066 2920 2f20  _bias / 2.0f) / 
+0005b2d0: 6e5f 6865 6164 735f 6c6f 6732 5f66 6c6f  n_heads_log2_flo
+0005b2e0: 6f72 293b 0a0a 2020 2020 666f 7220 2869  or);..    for (i
+0005b2f0: 6e74 2069 203d 2030 3b20 6920 3c20 6e65  nt i = 0; i < ne
+0005b300: 303b 2069 2b2b 2920 7b0a 2020 2020 2020  0; i++) {.      
+0005b310: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
+0005b320: 3b20 6a20 3c20 6e65 313b 206a 2b2b 2920  ; j < ne1; j++) 
+0005b330: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
+0005b340: 7220 2869 6e74 206b 203d 2030 3b20 6b20  r (int k = 0; k 
+0005b350: 3c20 6e65 325f 6e65 333b 206b 2b2b 2920  < ne2_ne3; k++) 
+0005b360: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0005b370: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
+0005b380: 636f 6e73 7420 7372 6320 203d 2028 6767  const src  = (gg
+0005b390: 6d6c 5f66 7031 365f 7420 2a29 2828 6368  ml_fp16_t *)((ch
+0005b3a0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+0005b3b0: 202b 2069 2a6e 6230 202b 206a 2a6e 6231   + i*nb0 + j*nb1
+0005b3c0: 202b 206b 2a6e 6232 293b 0a20 2020 2020   + k*nb2);.     
+0005b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005b3e0: 2066 6c6f 6174 202a 2020 2020 2020 7064   float *      pd
+0005b3f0: 7374 2020 3d20 2020 2020 2020 2866 6c6f  st  =       (flo
+0005b400: 6174 202a 2928 2863 6861 7220 2a29 2020  at *)((char *)  
+0005b410: 6473 742d 3e64 6174 6120 2b20 692a 6e62  dst->data + i*nb
+0005b420: 3020 2b20 6a2a 6e62 3120 2b20 6b2a 6e62  0 + j*nb1 + k*nb
+0005b430: 3229 3b0a 0a20 2020 2020 2020 2020 2020  2);..           
+0005b440: 2020 2020 202f 2f20 544f 444f 3a20 6b2a       // TODO: k*
+0005b450: 6e62 3220 6f72 206b 2a6e 6233 0a0a 2020  nb2 or k*nb3..  
+0005b460: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0005b470: 6f61 7420 6d5f 6b3b 0a0a 2020 2020 2020  oat m_k;..      
+0005b480: 2020 2020 2020 2020 2020 6966 2028 6b20            if (k 
+0005b490: 3c20 6e5f 6865 6164 735f 6c6f 6732 5f66  < n_heads_log2_f
+0005b4a0: 6c6f 6f72 2920 7b0a 2020 2020 2020 2020  loor) {.        
+0005b4b0: 2020 2020 2020 2020 2020 2020 6d5f 6b20              m_k 
+0005b4c0: 3d20 706f 7766 286d 302c 206b 202b 2031  = powf(m0, k + 1
+0005b4d0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0005b4e0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0005b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005b500: 6d5f 6b20 3d20 706f 7766 286d 312c 2032  m_k = powf(m1, 2
+0005b510: 202a 2028 6b20 2d20 6e5f 6865 6164 735f   * (k - n_heads_
+0005b520: 6c6f 6732 5f66 6c6f 6f72 2920 2b20 3129  log2_floor) + 1)
+0005b530: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005b540: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+0005b550: 2020 2020 202f 2f20 7765 2072 6574 7572       // we retur
+0005b560: 6e20 4633 320a 2020 2020 2020 2020 2020  n F32.          
+0005b570: 2020 2020 2020 7064 7374 5b30 5d20 3d20        pdst[0] = 
+0005b580: 2869 2d6e 6530 2b31 2920 2a20 6d5f 6b20  (i-ne0+1) * m_k 
+0005b590: 2b20 4747 4d4c 5f46 5031 365f 544f 5f46  + GGML_FP16_TO_F
+0005b5a0: 5033 3228 7372 635b 305d 293b 0a20 2020  P32(src[0]);.   
+0005b5b0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0005b5c0: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
+0005b5d0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+0005b5e0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
+0005b5f0: 6c69 6269 280a 2020 2020 2020 2020 636f  libi(.        co
+0005b600: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0005b610: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+0005b620: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+0005b630: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0005b640: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+0005b650: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0005b660: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0005b670: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+0005b680: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0005b690: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+0005b6a0: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
+0005b6b0: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+0005b6c0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0005b6d0: 4631 363a 0a20 2020 2020 2020 2020 2020  F16:.           
+0005b6e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0005b6f0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+0005b700: 666f 7277 6172 645f 616c 6962 695f 6631  forward_alibi_f1
+0005b710: 3628 7061 7261 6d73 2c20 7372 6330 2c20  6(params, src0, 
+0005b720: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+0005b730: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0005b740: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0005b750: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
+0005b760: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0005b770: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0005b780: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0005b790: 616c 6962 695f 6633 3228 7061 7261 6d73  alibi_f32(params
+0005b7a0: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
+0005b7b0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+0005b7c0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0005b7d0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0005b7e0: 5134 5f30 3a0a 2020 2020 2020 2020 6361  Q4_0:.        ca
+0005b7f0: 7365 2047 474d 4c5f 5459 5045 5f51 345f  se GGML_TYPE_Q4_
+0005b800: 313a 0a20 2020 2020 2020 2063 6173 6520  1:.        case 
+0005b810: 4747 4d4c 5f54 5950 455f 5135 5f30 3a0a  GGML_TYPE_Q5_0:.
+0005b820: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0005b830: 4c5f 5459 5045 5f51 355f 313a 0a20 2020  L_TYPE_Q5_1:.   
+0005b840: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0005b850: 5950 455f 5138 5f30 3a0a 2020 2020 2020  YPE_Q8_0:.      
+0005b860: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0005b870: 5f51 385f 313a 0a20 2020 2020 2020 2063  _Q8_1:.        c
+0005b880: 6173 6520 4747 4d4c 5f54 5950 455f 5132  ase GGML_TYPE_Q2
+0005b890: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
+0005b8a0: 2047 474d 4c5f 5459 5045 5f51 335f 4b3a   GGML_TYPE_Q3_K:
+0005b8b0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0005b8c0: 4d4c 5f54 5950 455f 5134 5f4b 3a0a 2020  ML_TYPE_Q4_K:.  
+0005b8d0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0005b8e0: 5459 5045 5f51 355f 4b3a 0a20 2020 2020  TYPE_Q5_K:.     
+0005b8f0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+0005b900: 455f 5136 5f4b 3a0a 2020 2020 2020 2020  E_Q6_K:.        
+0005b910: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+0005b920: 385f 4b3a 0a20 2020 2020 2020 2063 6173  8_K:.        cas
+0005b930: 6520 4747 4d4c 5f54 5950 455f 4938 3a0a  e GGML_TYPE_I8:.
+0005b940: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0005b950: 4c5f 5459 5045 5f49 3136 3a0a 2020 2020  L_TYPE_I16:.    
+0005b960: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0005b970: 5045 5f49 3332 3a0a 2020 2020 2020 2020  PE_I32:.        
+0005b980: 6361 7365 2047 474d 4c5f 5459 5045 5f43  case GGML_TYPE_C
+0005b990: 4f55 4e54 3a0a 2020 2020 2020 2020 2020  OUNT:.          
+0005b9a0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0005b9b0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0005b9c0: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+0005b9d0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0005b9e0: 207d 0a7d 0a0a 0a2f 2f20 6767 6d6c 5f63   }.}...// ggml_c
+0005b9f0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+0005ba00: 6c61 6d70 0a0a 7374 6174 6963 2076 6f69  lamp..static voi
+0005ba10: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+0005ba20: 6f72 7761 7264 5f63 6c61 6d70 5f66 3332  orward_clamp_f32
+0005ba30: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0005ba40: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0005ba50: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0005ba60: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0005ba70: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0005ba80: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0005ba90: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0005baa0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0005bab0: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
+0005bac0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0005bad0: 7220 2a20 6473 7429 207b 0a20 2020 2061  r * dst) {.    a
+0005bae0: 7373 6572 7428 7061 7261 6d73 2d3e 6974  ssert(params->it
+0005baf0: 6820 3d3d 2030 293b 0a20 2020 2061 7373  h == 0);.    ass
+0005bb00: 6572 7428 7372 6331 2d3e 7479 7065 203d  ert(src1->type =
+0005bb10: 3d20 4747 4d4c 5f54 5950 455f 4933 3229  = GGML_TYPE_I32)
+0005bb20: 3b0a 2020 2020 6173 7365 7274 2867 676d  ;.    assert(ggm
+0005bb30: 6c5f 6e65 6c65 6d65 6e74 7328 7372 6331  l_nelements(src1
+0005bb40: 2920 3d3d 2032 293b 0a0a 2020 2020 6966  ) == 2);..    if
+0005bb50: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+0005bb60: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+0005bb70: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+0005bb80: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+0005bb90: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+0005bba0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+0005bbb0: 0a20 2020 2063 6f6e 7374 2069 6e74 206d  .    const int m
+0005bbc0: 696e 203d 2028 2866 6c6f 6174 202a 2920  in = ((float *) 
+0005bbd0: 7372 6331 2d3e 6461 7461 295b 305d 3b0a  src1->data)[0];.
+0005bbe0: 2020 2020 636f 6e73 7420 696e 7420 6d61      const int ma
+0005bbf0: 7820 3d20 2828 666c 6f61 7420 2a29 2073  x = ((float *) s
+0005bc00: 7263 312d 3e64 6174 6129 5b31 5d3b 0a0a  rc1->data)[1];..
+0005bc10: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+0005bc20: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+0005bc30: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005bc40: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+0005bc50: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0005bc60: 206e 2020 3d20 6767 6d6c 5f6e 726f 7773   n  = ggml_nrows
+0005bc70: 2873 7263 3029 3b0a 2020 2020 636f 6e73  (src0);.    cons
+0005bc80: 7420 696e 7420 6e63 203d 2073 7263 302d  t int nc = src0-
+0005bc90: 3e6e 655b 305d 3b0a 0a20 2020 2063 6f6e  >ne[0];..    con
+0005bca0: 7374 2073 697a 655f 7420 6e62 3030 203d  st size_t nb00 =
+0005bcb0: 2073 7263 302d 3e6e 625b 305d 3b0a 2020   src0->nb[0];.  
+0005bcc0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0005bcd0: 6230 3120 3d20 7372 6330 2d3e 6e62 5b31  b01 = src0->nb[1
+0005bce0: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
+0005bcf0: 7a65 5f74 206e 6230 203d 2064 7374 2d3e  ze_t nb0 = dst->
+0005bd00: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+0005bd10: 2073 697a 655f 7420 6e62 3120 3d20 6473   size_t nb1 = ds
+0005bd20: 742d 3e6e 625b 315d 3b0a 0a20 2020 2047  t->nb[1];..    G
+0005bd30: 474d 4c5f 4153 5345 5254 2820 6e62 3020  GML_ASSERT( nb0 
+0005bd40: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+0005bd50: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0005bd60: 5254 286e 6230 3020 3d3d 2073 697a 656f  RT(nb00 == sizeo
+0005bd70: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+0005bd80: 666f 7220 2869 6e74 206a 203d 2069 7468  for (int j = ith
+0005bd90: 3b20 6a20 3c20 6e3b 206a 202b 3d20 6e74  ; j < n; j += nt
+0005bda0: 6829 207b 0a20 2020 2020 2020 2066 6c6f  h) {.        flo
+0005bdb0: 6174 202a 2064 7374 5f70 7472 2020 3d20  at * dst_ptr  = 
+0005bdc0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+0005bdd0: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
+0005bde0: 206a 2a6e 6231 293b 0a20 2020 2020 2020   j*nb1);.       
+0005bdf0: 2066 6c6f 6174 202a 2073 7263 305f 7074   float * src0_pt
+0005be00: 7220 3d20 2866 6c6f 6174 202a 2920 2828  r = (float *) ((
+0005be10: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
+0005be20: 7461 202b 206a 2a6e 6230 3129 3b0a 0a20  ta + j*nb01);.. 
+0005be30: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+0005be40: 6920 3d20 303b 2069 203c 206e 633b 2069  i = 0; i < nc; i
+0005be50: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0005be60: 2020 6473 745f 7074 725b 695d 203d 204d    dst_ptr[i] = M
+0005be70: 4158 284d 494e 2873 7263 305f 7074 725b  AX(MIN(src0_ptr[
+0005be80: 695d 2c20 6d61 7829 2c20 6d69 6e29 3b0a  i], max), min);.
+0005be90: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+0005bea0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+0005beb0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0005bec0: 6172 645f 636c 616d 7028 0a20 2020 2020  ard_clamp(.     
+0005bed0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0005bee0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+0005bef0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+0005bf00: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0005bf10: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0005bf20: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+0005bf30: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0005bf40: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+0005bf50: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0005bf60: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+0005bf70: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+0005bf80: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+0005bf90: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0005bfa0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+0005bfb0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0005bfc0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+0005bfd0: 7075 7465 5f66 6f72 7761 7264 5f63 6c61  pute_forward_cla
+0005bfe0: 6d70 5f66 3332 2870 6172 616d 732c 2073  mp_f32(params, s
+0005bff0: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
+0005c000: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0005c010: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0005c020: 7365 2047 474d 4c5f 5459 5045 5f46 3136  se GGML_TYPE_F16
+0005c030: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+0005c040: 474d 4c5f 5459 5045 5f51 345f 303a 0a20  GML_TYPE_Q4_0:. 
+0005c050: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0005c060: 5f54 5950 455f 5134 5f31 3a0a 2020 2020  _TYPE_Q4_1:.    
+0005c070: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0005c080: 5045 5f51 355f 303a 0a20 2020 2020 2020  PE_Q5_0:.       
+0005c090: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0005c0a0: 5135 5f31 3a0a 2020 2020 2020 2020 6361  Q5_1:.        ca
+0005c0b0: 7365 2047 474d 4c5f 5459 5045 5f51 385f  se GGML_TYPE_Q8_
+0005c0c0: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
+0005c0d0: 4747 4d4c 5f54 5950 455f 5138 5f31 3a0a  GGML_TYPE_Q8_1:.
+0005c0e0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0005c0f0: 4c5f 5459 5045 5f51 325f 4b3a 0a20 2020  L_TYPE_Q2_K:.   
+0005c100: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0005c110: 5950 455f 5133 5f4b 3a0a 2020 2020 2020  YPE_Q3_K:.      
+0005c120: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0005c130: 5f51 345f 4b3a 0a20 2020 2020 2020 2063  _Q4_K:.        c
+0005c140: 6173 6520 4747 4d4c 5f54 5950 455f 5135  ase GGML_TYPE_Q5
+0005c150: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
+0005c160: 2047 474d 4c5f 5459 5045 5f51 365f 4b3a   GGML_TYPE_Q6_K:
+0005c170: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0005c180: 4d4c 5f54 5950 455f 5138 5f4b 3a0a 2020  ML_TYPE_Q8_K:.  
+0005c190: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0005c1a0: 5459 5045 5f49 383a 0a20 2020 2020 2020  TYPE_I8:.       
+0005c1b0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0005c1c0: 4931 363a 0a20 2020 2020 2020 2063 6173  I16:.        cas
+0005c1d0: 6520 4747 4d4c 5f54 5950 455f 4933 323a  e GGML_TYPE_I32:
+0005c1e0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0005c1f0: 4d4c 5f54 5950 455f 434f 554e 543a 0a20  ML_TYPE_COUNT:. 
+0005c200: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0005c210: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+0005c220: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+0005c230: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0005c240: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
+0005c250: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+0005c260: 6f72 7761 7264 5f72 6f70 650a 0a73 7461  orward_rope..sta
+0005c270: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+0005c280: 6d70 7574 655f 666f 7277 6172 645f 726f  mpute_forward_ro
+0005c290: 7065 5f66 3332 280a 2020 2020 2020 2020  pe_f32(.        
+0005c2a0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0005c2b0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+0005c2c0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+0005c2d0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0005c2e0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+0005c2f0: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
+0005c300: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+0005c310: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
+0005c320: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0005c330: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+0005c340: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0005c350: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
+0005c360: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
+0005c370: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+0005c380: 676d 6c5f 6e65 6c65 6d65 6e74 7328 7372  gml_nelements(sr
+0005c390: 6331 2920 3d3d 2033 293b 0a0a 2020 2020  c1) == 3);..    
+0005c3a0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+0005c3b0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+0005c3c0: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
+0005c3d0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+0005c3e0: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+0005c3f0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+0005c400: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
+0005c410: 206e 5f70 6173 7420 3d20 2828 696e 7433   n_past = ((int3
+0005c420: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
+0005c430: 6129 5b30 5d3b 0a20 2020 2063 6f6e 7374  a)[0];.    const
+0005c440: 2069 6e74 206e 5f64 696d 7320 3d20 2828   int n_dims = ((
+0005c450: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
+0005c460: 3e64 6174 6129 5b31 5d3b 0a20 2020 2063  >data)[1];.    c
+0005c470: 6f6e 7374 2069 6e74 206d 6f64 6520 2020  onst int mode   
+0005c480: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
+0005c490: 7263 312d 3e64 6174 6129 5b32 5d3b 0a0a  rc1->data)[2];..
+0005c4a0: 2020 2020 6173 7365 7274 286e 5f70 6173      assert(n_pas
+0005c4b0: 7420 3e3d 2030 293b 0a0a 2020 2020 636f  t >= 0);..    co
+0005c4c0: 6e73 7420 7369 7a65 5f74 206e 6230 3020  nst size_t nb00 
+0005c4d0: 3d20 7372 6330 2d3e 6e62 5b30 5d3b 0a20  = src0->nb[0];. 
+0005c4e0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0005c4f0: 6e62 3031 203d 2073 7263 302d 3e6e 625b  nb01 = src0->nb[
+0005c500: 315d 3b0a 2020 2020 636f 6e73 7420 7369  1];.    const si
+0005c510: 7a65 5f74 206e 6230 3220 3d20 7372 6330  ze_t nb02 = src0
+0005c520: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
+0005c530: 7374 2073 697a 655f 7420 6e62 3033 203d  st size_t nb03 =
+0005c540: 2073 7263 302d 3e6e 625b 335d 3b0a 0a20   src0->nb[3];.. 
+0005c550: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+0005c560: 206e 6530 203d 2064 7374 2d3e 6e65 5b30   ne0 = dst->ne[0
+0005c570: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0005c580: 3634 5f74 206e 6531 203d 2064 7374 2d3e  64_t ne1 = dst->
+0005c590: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
+0005c5a0: 2069 6e74 3634 5f74 206e 6532 203d 2064   int64_t ne2 = d
+0005c5b0: 7374 2d3e 6e65 5b32 5d3b 0a20 2020 2063  st->ne[2];.    c
+0005c5c0: 6f6e 7374 2069 6e74 3634 5f74 206e 6533  onst int64_t ne3
+0005c5d0: 203d 2064 7374 2d3e 6e65 5b33 5d3b 0a0a   = dst->ne[3];..
+0005c5e0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0005c5f0: 206e 6230 203d 2064 7374 2d3e 6e62 5b30   nb0 = dst->nb[0
+0005c600: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+0005c610: 655f 7420 6e62 3120 3d20 6473 742d 3e6e  e_t nb1 = dst->n
+0005c620: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+0005c630: 7369 7a65 5f74 206e 6232 203d 2064 7374  size_t nb2 = dst
+0005c640: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
+0005c650: 7374 2073 697a 655f 7420 6e62 3320 3d20  st size_t nb3 = 
+0005c660: 6473 742d 3e6e 625b 335d 3b0a 0a20 2020  dst->nb[3];..   
+0005c670: 202f 2f70 7269 6e74 6628 226e 6530 3a20   //printf("ne0: 
+0005c680: 2564 2c20 6e65 313a 2025 642c 206e 6532  %d, ne1: %d, ne2
+0005c690: 3a20 2564 2c20 6e65 333a 2025 645c 6e22  : %d, ne3: %d\n"
+0005c6a0: 2c20 6e65 302c 206e 6531 2c20 6e65 322c  , ne0, ne1, ne2,
+0005c6b0: 206e 6533 293b 0a20 2020 202f 2f70 7269   ne3);.    //pri
+0005c6c0: 6e74 6628 226e 5f70 6173 7420 3d20 2564  ntf("n_past = %d
+0005c6d0: 2c20 6e65 3220 3d20 2564 5c6e 222c 206e  , ne2 = %d\n", n
+0005c6e0: 5f70 6173 742c 206e 6532 293b 0a0a 2020  _past, ne2);..  
+0005c6f0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+0005c700: 3030 203d 3d20 7369 7a65 6f66 2866 6c6f  00 == sizeof(flo
+0005c710: 6174 2929 3b0a 0a20 2020 2063 6f6e 7374  at));..    const
+0005c720: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
+0005c730: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
+0005c740: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
+0005c750: 6d73 2d3e 6e74 683b 0a0a 2020 2020 636f  ms->nth;..    co
+0005c760: 6e73 7420 696e 7420 6e72 203d 2067 676d  nst int nr = ggm
+0005c770: 6c5f 6e72 6f77 7328 6473 7429 3b0a 0a20  l_nrows(dst);.. 
+0005c780: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0005c790: 5f64 696d 7320 3c3d 206e 6530 293b 0a20  _dims <= ne0);. 
+0005c7a0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0005c7b0: 5f64 696d 7320 2520 3220 3d3d 2030 293b  _dims % 2 == 0);
+0005c7c0: 0a0a 2020 2020 2f2f 2072 6f77 7320 7065  ..    // rows pe
+0005c7d0: 7220 7468 7265 6164 0a20 2020 2063 6f6e  r thread.    con
+0005c7e0: 7374 2069 6e74 2064 7220 3d20 286e 7220  st int dr = (nr 
+0005c7f0: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
+0005c800: 0a20 2020 202f 2f20 726f 7720 7261 6e67  .    // row rang
+0005c810: 6520 666f 7220 7468 6973 2074 6872 6561  e for this threa
+0005c820: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
+0005c830: 6972 3020 3d20 6472 2a69 7468 3b0a 2020  ir0 = dr*ith;.  
+0005c840: 2020 636f 6e73 7420 696e 7420 6972 3120    const int ir1 
+0005c850: 3d20 4d49 4e28 6972 3020 2b20 6472 2c20  = MIN(ir0 + dr, 
+0005c860: 6e72 293b 0a0a 2020 2020 2f2f 2072 6f77  nr);..    // row
+0005c870: 2069 6e64 6578 2075 7365 6420 746f 2064   index used to d
+0005c880: 6574 6572 6d69 6e65 2077 6869 6368 2074  etermine which t
+0005c890: 6872 6561 6420 746f 2075 7365 0a20 2020  hread to use.   
+0005c8a0: 2069 6e74 2069 7220 3d20 303b 0a0a 2020   int ir = 0;..  
+0005c8b0: 2020 636f 6e73 7420 666c 6f61 7420 7468    const float th
+0005c8c0: 6574 615f 7363 616c 6520 3d20 706f 7766  eta_scale = powf
+0005c8d0: 2831 3030 3030 2e30 2c20 2d32 2e30 662f  (10000.0, -2.0f/
+0005c8e0: 6e5f 6469 6d73 293b 0a0a 2020 2020 636f  n_dims);..    co
+0005c8f0: 6e73 7420 626f 6f6c 2069 735f 6e65 6f78  nst bool is_neox
+0005c900: 203d 206d 6f64 6520 2620 323b 0a0a 2020   = mode & 2;..  
+0005c910: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0005c920: 3320 3d20 303b 2069 3320 3c20 6e65 333b  3 = 0; i3 < ne3;
+0005c930: 2069 332b 2b29 207b 0a20 2020 2020 2020   i3++) {.       
+0005c940: 2066 6f72 2028 696e 7436 345f 7420 6932   for (int64_t i2
+0005c950: 203d 2028 286d 6f64 6520 2620 3129 203d   = ((mode & 1) =
+0005c960: 3d20 3020 3f20 3020 3a20 6e5f 7061 7374  = 0 ? 0 : n_past
+0005c970: 293b 2069 3220 3c20 6e65 323b 2069 322b  ); i2 < ne2; i2+
+0005c980: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0005c990: 2063 6f6e 7374 2069 6e74 3634 5f74 2070   const int64_t p
+0005c9a0: 203d 2028 286d 6f64 6520 2620 3129 203d   = ((mode & 1) =
+0005c9b0: 3d20 3020 3f20 6e5f 7061 7374 202b 2069  = 0 ? n_past + i
+0005c9c0: 3220 3a20 6932 293b 0a20 2020 2020 2020  2 : i2);.       
+0005c9d0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+0005c9e0: 7420 6931 203d 2030 3b20 6931 203c 206e  t i1 = 0; i1 < n
+0005c9f0: 6531 3b20 6931 2b2b 2920 7b0a 2020 2020  e1; i1++) {.    
+0005ca00: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0005ca10: 6972 2b2b 203c 2069 7230 2920 636f 6e74  ir++ < ir0) cont
+0005ca20: 696e 7565 3b0a 2020 2020 2020 2020 2020  inue;.          
+0005ca30: 2020 2020 2020 6966 2028 6972 2020 203e        if (ir   >
+0005ca40: 2069 7231 2920 6272 6561 6b3b 0a0a 2020   ir1) break;..  
+0005ca50: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0005ca60: 6f61 7420 7468 6574 6120 3d20 2866 6c6f  oat theta = (flo
+0005ca70: 6174 2970 3b0a 0a20 2020 2020 2020 2020  at)p;..         
+0005ca80: 2020 2020 2020 2069 6620 2821 6973 5f6e         if (!is_n
+0005ca90: 656f 7829 207b 0a20 2020 2020 2020 2020  eox) {.         
+0005caa0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0005cab0: 696e 7436 345f 7420 6930 203d 2030 3b20  int64_t i0 = 0; 
+0005cac0: 6930 203c 206e 6530 3b20 6930 202b 3d20  i0 < ne0; i0 += 
+0005cad0: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
+0005cae0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005caf0: 7374 2066 6c6f 6174 2063 6f73 5f74 6865  st float cos_the
+0005cb00: 7461 203d 2063 6f73 6628 7468 6574 6129  ta = cosf(theta)
+0005cb10: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005cb20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0005cb30: 666c 6f61 7420 7369 6e5f 7468 6574 6120  float sin_theta 
+0005cb40: 3d20 7369 6e66 2874 6865 7461 293b 0a0a  = sinf(theta);..
+0005cb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cb60: 2020 2020 2020 2020 7468 6574 6120 2a3d          theta *=
+0005cb70: 2074 6865 7461 5f73 6361 6c65 3b0a 0a20   theta_scale;.. 
+0005cb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cb90: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0005cba0: 6174 202a 2063 6f6e 7374 2073 7263 203d  at * const src =
+0005cbb0: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+0005cbc0: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+0005cbd0: 2069 332a 6e62 3033 202b 2069 322a 6e62   i3*nb03 + i2*nb
+0005cbe0: 3032 202b 2069 312a 6e62 3031 202b 2069  02 + i1*nb01 + i
+0005cbf0: 302a 6e62 3030 293b 0a20 2020 2020 2020  0*nb00);.       
+0005cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cc10: 2020 2020 2020 2066 6c6f 6174 202a 2064         float * d
+0005cc20: 7374 5f64 6174 6120 203d 2028 666c 6f61  st_data  = (floa
+0005cc30: 7420 2a29 2828 6368 6172 202a 2920 2064  t *)((char *)  d
+0005cc40: 7374 2d3e 6461 7461 202b 2069 332a 6e62  st->data + i3*nb
+0005cc50: 3320 202b 2069 322a 6e62 3220 202b 2069  3  + i2*nb2  + i
+0005cc60: 312a 6e62 3120 202b 2069 302a 6e62 3029  1*nb1  + i0*nb0)
+0005cc70: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0005cc80: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0005cc90: 2066 6c6f 6174 2078 3020 3d20 7372 635b   float x0 = src[
+0005cca0: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
+0005ccb0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0005ccc0: 7420 666c 6f61 7420 7831 203d 2073 7263  t float x1 = src
+0005ccd0: 5b31 5d3b 0a0a 2020 2020 2020 2020 2020  [1];..          
+0005cce0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+0005ccf0: 745f 6461 7461 5b30 5d20 3d20 7830 2a63  t_data[0] = x0*c
+0005cd00: 6f73 5f74 6865 7461 202d 2078 312a 7369  os_theta - x1*si
+0005cd10: 6e5f 7468 6574 613b 0a20 2020 2020 2020  n_theta;.       
+0005cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cd30: 2064 7374 5f64 6174 615b 315d 203d 2078   dst_data[1] = x
+0005cd40: 302a 7369 6e5f 7468 6574 6120 2b20 7831  0*sin_theta + x1
+0005cd50: 2a63 6f73 5f74 6865 7461 3b0a 2020 2020  *cos_theta;.    
 0005cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005cd70: 6473 745f 6461 7461 5b31 5d20 3d20 7830  dst_data[1] = x0
-0005cd80: 2a73 696e 5f74 6865 7461 202b 2078 312a  *sin_theta + x1*
-0005cd90: 636f 735f 7468 6574 613b 0a20 2020 2020  cos_theta;.     
-0005cda0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0005cdb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005cdc0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-0005cdd0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0005cde0: 2054 4f44 4f3a 2074 6869 7320 6973 2070   TODO: this is p
-0005cdf0: 726f 6261 626c 7920 7772 6f6e 672c 2062  robably wrong, b
-0005ce00: 7574 2049 2063 616e 2774 2066 6967 7572  ut I can't figur
-0005ce10: 6520 6974 206f 7574 202e 2e0a 2020 2020  e it out ...    
-0005ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ce30: 2f2f 2072 6566 3a20 2068 7474 7073 3a2f  // ref:  https:/
-0005ce40: 2f67 6974 6875 622e 636f 6d2f 6875 6767  /github.com/hugg
-0005ce50: 696e 6766 6163 652f 7472 616e 7366 6f72  ingface/transfor
-0005ce60: 6d65 7273 2f62 6c6f 622f 6d61 696e 2f73  mers/blob/main/s
-0005ce70: 7263 2f74 7261 6e73 666f 726d 6572 732f  rc/transformers/
-0005ce80: 6d6f 6465 6c73 2f67 7074 5f6e 656f 782f  models/gpt_neox/
-0005ce90: 6d6f 6465 6c69 6e67 5f67 7074 5f6e 656f  modeling_gpt_neo
-0005cea0: 782e 7079 234c 4c32 3531 4331 2d4c 3239  x.py#LL251C1-L29
-0005ceb0: 3443 3238 0a20 2020 2020 2020 2020 2020  4C28.           
-0005cec0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0005ced0: 7436 345f 7420 6962 203d 2030 3b20 6962  t64_t ib = 0; ib
-0005cee0: 203c 206e 6530 2f6e 5f64 696d 733b 202b   < ne0/n_dims; +
-0005cef0: 2b69 6229 207b 0a20 2020 2020 2020 2020  +ib) {.         
-0005cf00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005cf10: 6f72 2028 696e 7436 345f 7420 6963 203d  or (int64_t ic =
-0005cf20: 2030 3b20 6963 203c 206e 5f64 696d 733b   0; ic < n_dims;
-0005cf30: 2069 6320 2b3d 2032 2920 7b0a 2020 2020   ic += 2) {.    
+0005cd70: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0005cd80: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+0005cd90: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0005cda0: 2f20 544f 444f 3a20 7468 6973 2069 7320  / TODO: this is 
+0005cdb0: 7072 6f62 6162 6c79 2077 726f 6e67 2c20  probably wrong, 
+0005cdc0: 6275 7420 4920 6361 6e27 7420 6669 6775  but I can't figu
+0005cdd0: 7265 2069 7420 6f75 7420 2e2e 0a20 2020  re it out ...   
+0005cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cdf0: 202f 2f20 7265 663a 2020 6874 7470 733a   // ref:  https:
+0005ce00: 2f2f 6769 7468 7562 2e63 6f6d 2f68 7567  //github.com/hug
+0005ce10: 6769 6e67 6661 6365 2f74 7261 6e73 666f  gingface/transfo
+0005ce20: 726d 6572 732f 626c 6f62 2f6d 6169 6e2f  rmers/blob/main/
+0005ce30: 7372 632f 7472 616e 7366 6f72 6d65 7273  src/transformers
+0005ce40: 2f6d 6f64 656c 732f 6770 745f 6e65 6f78  /models/gpt_neox
+0005ce50: 2f6d 6f64 656c 696e 675f 6770 745f 6e65  /modeling_gpt_ne
+0005ce60: 6f78 2e70 7923 4c4c 3235 3143 312d 4c32  ox.py#LL251C1-L2
+0005ce70: 3934 4332 380a 2020 2020 2020 2020 2020  94C28.          
+0005ce80: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0005ce90: 6e74 3634 5f74 2069 6220 3d20 303b 2069  nt64_t ib = 0; i
+0005cea0: 6220 3c20 6e65 302f 6e5f 6469 6d73 3b20  b < ne0/n_dims; 
+0005ceb0: 2b2b 6962 2920 7b0a 2020 2020 2020 2020  ++ib) {.        
+0005cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ced0: 666f 7220 2869 6e74 3634 5f74 2069 6320  for (int64_t ic 
+0005cee0: 3d20 303b 2069 6320 3c20 6e5f 6469 6d73  = 0; ic < n_dims
+0005cef0: 3b20 6963 202b 3d20 3229 207b 0a20 2020  ; ic += 2) {.   
+0005cf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cf10: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+0005cf20: 6c6f 6174 2063 6f73 5f74 6865 7461 203d  loat cos_theta =
+0005cf30: 2063 6f73 6628 7468 6574 6129 3b0a 2020   cosf(theta);.  
 0005cf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005cf50: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0005cf60: 6f61 7420 636f 735f 7468 6574 6120 3d20  oat cos_theta = 
-0005cf70: 636f 7366 2874 6865 7461 293b 0a20 2020  cosf(theta);.   
+0005cf50: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0005cf60: 666c 6f61 7420 7369 6e5f 7468 6574 6120  float sin_theta 
+0005cf70: 3d20 7369 6e66 2874 6865 7461 293b 0a0a  = sinf(theta);..
 0005cf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005cf90: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0005cfa0: 6c6f 6174 2073 696e 5f74 6865 7461 203d  loat sin_theta =
-0005cfb0: 2073 696e 6628 7468 6574 6129 3b0a 0a20   sinf(theta);.. 
-0005cfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005cfd0: 2020 2020 2020 2020 2020 2074 6865 7461             theta
-0005cfe0: 202a 3d20 7468 6574 615f 7363 616c 653b   *= theta_scale;
-0005cff0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0005d000: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005d010: 6e73 7420 696e 7436 345f 7420 6930 203d  nst int64_t i0 =
-0005d020: 2069 622a 6e5f 6469 6d73 202b 2069 632f   ib*n_dims + ic/
-0005d030: 323b 0a0a 2020 2020 2020 2020 2020 2020  2;..            
-0005d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d050: 636f 6e73 7420 666c 6f61 7420 2a20 636f  const float * co
-0005d060: 6e73 7420 7372 6320 3d20 2866 6c6f 6174  nst src = (float
-0005d070: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
-0005d080: 302d 3e64 6174 6120 2b20 6933 2a6e 6230  0->data + i3*nb0
-0005d090: 3320 2b20 6932 2a6e 6230 3220 2b20 6931  3 + i2*nb02 + i1
-0005d0a0: 2a6e 6230 3120 2b20 6930 2a6e 6230 3029  *nb01 + i0*nb00)
-0005d0b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0005d0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d0d0: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
-0005d0e0: 6461 7461 2020 3d20 2866 6c6f 6174 202a  data  = (float *
-0005d0f0: 2928 2863 6861 7220 2a29 2020 6473 742d  )((char *)  dst-
-0005d100: 3e64 6174 6120 2b20 6933 2a6e 6233 2020  >data + i3*nb3  
-0005d110: 2b20 6932 2a6e 6232 2020 2b20 6931 2a6e  + i2*nb2  + i1*n
-0005d120: 6231 2020 2b20 6930 2a6e 6230 293b 0a0a  b1  + i0*nb0);..
+0005cf90: 2020 2020 2020 2020 2020 2020 7468 6574              thet
+0005cfa0: 6120 2a3d 2074 6865 7461 5f73 6361 6c65  a *= theta_scale
+0005cfb0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0005cfc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0005cfd0: 6f6e 7374 2069 6e74 3634 5f74 2069 3020  onst int64_t i0 
+0005cfe0: 3d20 6962 2a6e 5f64 696d 7320 2b20 6963  = ib*n_dims + ic
+0005cff0: 2f32 3b0a 0a20 2020 2020 2020 2020 2020  /2;..           
+0005d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d010: 2063 6f6e 7374 2066 6c6f 6174 202a 2063   const float * c
+0005d020: 6f6e 7374 2073 7263 203d 2028 666c 6f61  onst src = (floa
+0005d030: 7420 2a29 2828 6368 6172 202a 2920 7372  t *)((char *) sr
+0005d040: 6330 2d3e 6461 7461 202b 2069 332a 6e62  c0->data + i3*nb
+0005d050: 3033 202b 2069 322a 6e62 3032 202b 2069  03 + i2*nb02 + i
+0005d060: 312a 6e62 3031 202b 2069 302a 6e62 3030  1*nb01 + i0*nb00
+0005d070: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0005d080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d090: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
+0005d0a0: 5f64 6174 6120 203d 2028 666c 6f61 7420  _data  = (float 
+0005d0b0: 2a29 2828 6368 6172 202a 2920 2064 7374  *)((char *)  dst
+0005d0c0: 2d3e 6461 7461 202b 2069 332a 6e62 3320  ->data + i3*nb3 
+0005d0d0: 202b 2069 322a 6e62 3220 202b 2069 312a   + i2*nb2  + i1*
+0005d0e0: 6e62 3120 202b 2069 302a 6e62 3029 3b0a  nb1  + i0*nb0);.
+0005d0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005d100: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005d110: 7374 2066 6c6f 6174 2078 3020 3d20 7372  st float x0 = sr
+0005d120: 635b 305d 3b0a 2020 2020 2020 2020 2020  c[0];.          
 0005d130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d140: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0005d150: 7420 666c 6f61 7420 7830 203d 2073 7263  t float x0 = src
-0005d160: 5b30 5d3b 0a20 2020 2020 2020 2020 2020  [0];.           
-0005d170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d180: 2063 6f6e 7374 2066 6c6f 6174 2078 3120   const float x1 
-0005d190: 3d20 7372 635b 6e5f 6469 6d73 2f32 5d3b  = src[n_dims/2];
-0005d1a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0005d1b0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-0005d1c0: 745f 6461 7461 5b30 5d20 2020 2020 2020  t_data[0]       
-0005d1d0: 203d 2078 302a 636f 735f 7468 6574 6120   = x0*cos_theta 
-0005d1e0: 2d20 7831 2a73 696e 5f74 6865 7461 3b0a  - x1*sin_theta;.
-0005d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d200: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-0005d210: 6461 7461 5b6e 5f64 696d 732f 325d 203d  data[n_dims/2] =
-0005d220: 2078 302a 7369 6e5f 7468 6574 6120 2b20   x0*sin_theta + 
-0005d230: 7831 2a63 6f73 5f74 6865 7461 3b0a 2020  x1*cos_theta;.  
-0005d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d250: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0005d260: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0005d270: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0005d280: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0005d290: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
-0005d2a0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-0005d2b0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0005d2c0: 645f 726f 7065 5f66 3136 280a 2020 2020  d_rope_f16(.    
-0005d2d0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0005d2e0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-0005d2f0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-0005d300: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0005d310: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0005d320: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-0005d330: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0005d340: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-0005d350: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0005d360: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-0005d370: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
-0005d380: 5345 5254 2873 7263 312d 3e74 7970 6520  SERT(src1->type 
-0005d390: 3d3d 2047 474d 4c5f 5459 5045 5f49 3332  == GGML_TYPE_I32
-0005d3a0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0005d3b0: 5254 2867 676d 6c5f 6e65 6c65 6d65 6e74  RT(ggml_nelement
-0005d3c0: 7328 7372 6331 2920 3d3d 2033 293b 0a0a  s(src1) == 3);..
-0005d3d0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-0005d3e0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-0005d3f0: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-0005d400: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005d410: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-0005d420: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-0005d430: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
-0005d440: 2069 6e74 206e 5f70 6173 7420 3d20 2828   int n_past = ((
-0005d450: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
-0005d460: 3e64 6174 6129 5b30 5d3b 0a20 2020 2063  >data)[0];.    c
-0005d470: 6f6e 7374 2069 6e74 206e 5f64 696d 7320  onst int n_dims 
-0005d480: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
-0005d490: 7263 312d 3e64 6174 6129 5b31 5d3b 0a20  rc1->data)[1];. 
-0005d4a0: 2020 2063 6f6e 7374 2069 6e74 206d 6f64     const int mod
-0005d4b0: 6520 2020 3d20 2828 696e 7433 325f 7420  e   = ((int32_t 
-0005d4c0: 2a29 2073 7263 312d 3e64 6174 6129 5b32  *) src1->data)[2
-0005d4d0: 5d3b 0a0a 2020 2020 6173 7365 7274 286e  ];..    assert(n
-0005d4e0: 5f70 6173 7420 3e3d 2030 293b 0a0a 2020  _past >= 0);..  
-0005d4f0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0005d500: 6230 3020 3d20 7372 6330 2d3e 6e62 5b30  b00 = src0->nb[0
-0005d510: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-0005d520: 655f 7420 6e62 3031 203d 2073 7263 302d  e_t nb01 = src0-
-0005d530: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-0005d540: 7420 7369 7a65 5f74 206e 6230 3220 3d20  t size_t nb02 = 
-0005d550: 7372 6330 2d3e 6e62 5b32 5d3b 0a20 2020  src0->nb[2];.   
-0005d560: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0005d570: 3033 203d 2073 7263 302d 3e6e 625b 335d  03 = src0->nb[3]
-0005d580: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0005d590: 3634 5f74 206e 6530 203d 2064 7374 2d3e  64_t ne0 = dst->
-0005d5a0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-0005d5b0: 2069 6e74 3634 5f74 206e 6531 203d 2064   int64_t ne1 = d
-0005d5c0: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 2063  st->ne[1];.    c
-0005d5d0: 6f6e 7374 2069 6e74 3634 5f74 206e 6532  onst int64_t ne2
-0005d5e0: 203d 2064 7374 2d3e 6e65 5b32 5d3b 0a20   = dst->ne[2];. 
-0005d5f0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-0005d600: 206e 6533 203d 2064 7374 2d3e 6e65 5b33   ne3 = dst->ne[3
-0005d610: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
-0005d620: 7a65 5f74 206e 6230 203d 2064 7374 2d3e  ze_t nb0 = dst->
-0005d630: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-0005d640: 2073 697a 655f 7420 6e62 3120 3d20 6473   size_t nb1 = ds
-0005d650: 742d 3e6e 625b 315d 3b0a 2020 2020 636f  t->nb[1];.    co
-0005d660: 6e73 7420 7369 7a65 5f74 206e 6232 203d  nst size_t nb2 =
-0005d670: 2064 7374 2d3e 6e62 5b32 5d3b 0a20 2020   dst->nb[2];.   
-0005d680: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0005d690: 3320 3d20 6473 742d 3e6e 625b 335d 3b0a  3 = dst->nb[3];.
-0005d6a0: 0a20 2020 202f 2f70 7269 6e74 6628 226e  .    //printf("n
-0005d6b0: 6530 3a20 2564 2c20 6e65 313a 2025 642c  e0: %d, ne1: %d,
-0005d6c0: 206e 6532 3a20 2564 2c20 6e65 333a 2025   ne2: %d, ne3: %
-0005d6d0: 645c 6e22 2c20 6e65 302c 206e 6531 2c20  d\n", ne0, ne1, 
-0005d6e0: 6e65 322c 206e 6533 293b 0a20 2020 202f  ne2, ne3);.    /
-0005d6f0: 2f70 7269 6e74 6628 226e 5f70 6173 7420  /printf("n_past 
-0005d700: 3d20 2564 2c20 6e65 3220 3d20 2564 5c6e  = %d, ne2 = %d\n
-0005d710: 222c 206e 5f70 6173 742c 206e 6532 293b  ", n_past, ne2);
-0005d720: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-0005d730: 5428 6e62 3020 3d3d 2073 697a 656f 6628  T(nb0 == sizeof(
-0005d740: 6767 6d6c 5f66 7031 365f 7429 293b 0a0a  ggml_fp16_t));..
-0005d750: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
-0005d760: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
-0005d770: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005d780: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
-0005d790: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0005d7a0: 206e 7220 3d20 6767 6d6c 5f6e 726f 7773   nr = ggml_nrows
-0005d7b0: 2864 7374 293b 0a0a 2020 2020 4747 4d4c  (dst);..    GGML
-0005d7c0: 5f41 5353 4552 5428 6e5f 6469 6d73 203c  _ASSERT(n_dims <
-0005d7d0: 3d20 6e65 3029 3b0a 2020 2020 4747 4d4c  = ne0);.    GGML
-0005d7e0: 5f41 5353 4552 5428 6e5f 6469 6d73 2025  _ASSERT(n_dims %
-0005d7f0: 2032 203d 3d20 3029 3b0a 0a20 2020 202f   2 == 0);..    /
-0005d800: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-0005d810: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-0005d820: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-0005d830: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
-0005d840: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
-0005d850: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
-0005d860: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
-0005d870: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
-0005d880: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-0005d890: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-0005d8a0: 2020 202f 2f20 726f 7720 696e 6465 7820     // row index 
-0005d8b0: 7573 6564 2074 6f20 6465 7465 726d 696e  used to determin
-0005d8c0: 6520 7768 6963 6820 7468 7265 6164 2074  e which thread t
-0005d8d0: 6f20 7573 650a 2020 2020 696e 7420 6972  o use.    int ir
-0005d8e0: 203d 2030 3b0a 0a20 2020 2063 6f6e 7374   = 0;..    const
-0005d8f0: 2066 6c6f 6174 2074 6865 7461 5f73 6361   float theta_sca
-0005d900: 6c65 203d 2070 6f77 6628 3130 3030 302e  le = powf(10000.
-0005d910: 302c 202d 322e 3066 2f6e 5f64 696d 7329  0, -2.0f/n_dims)
-0005d920: 3b0a 0a20 2020 2063 6f6e 7374 2062 6f6f  ;..    const boo
-0005d930: 6c20 6973 5f6e 656f 7820 3d20 6d6f 6465  l is_neox = mode
-0005d940: 2026 2032 3b0a 0a20 2020 2066 6f72 2028   & 2;..    for (
-0005d950: 696e 7436 345f 7420 6933 203d 2030 3b20  int64_t i3 = 0; 
-0005d960: 6933 203c 206e 6533 3b20 6933 2b2b 2920  i3 < ne3; i3++) 
-0005d970: 7b0a 2020 2020 2020 2020 666f 7220 2869  {.        for (i
-0005d980: 6e74 3634 5f74 2069 3220 3d20 2828 6d6f  nt64_t i2 = ((mo
-0005d990: 6465 2026 2031 2920 3d3d 2030 203f 2030  de & 1) == 0 ? 0
-0005d9a0: 203a 206e 5f70 6173 7429 3b20 6932 203c   : n_past); i2 <
-0005d9b0: 206e 6532 3b20 6932 2b2b 2920 7b0a 2020   ne2; i2++) {.  
-0005d9c0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0005d9d0: 696e 7436 345f 7420 7020 3d20 2828 6d6f  int64_t p = ((mo
-0005d9e0: 6465 2026 2031 2920 3d3d 2030 203f 206e  de & 1) == 0 ? n
-0005d9f0: 5f70 6173 7420 2b20 6932 203a 2069 3229  _past + i2 : i2)
-0005da00: 3b0a 2020 2020 2020 2020 2020 2020 666f  ;.            fo
-0005da10: 7220 2869 6e74 3634 5f74 2069 3120 3d20  r (int64_t i1 = 
-0005da20: 303b 2069 3120 3c20 6e65 313b 2069 312b  0; i1 < ne1; i1+
-0005da30: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-0005da40: 2020 2020 2069 6620 2869 722b 2b20 3c20       if (ir++ < 
-0005da50: 6972 3029 2063 6f6e 7469 6e75 653b 0a20  ir0) continue;. 
-0005da60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0005da70: 6620 2869 7220 2020 3e20 6972 3129 2062  f (ir   > ir1) b
-0005da80: 7265 616b 3b0a 0a20 2020 2020 2020 2020  reak;..         
-0005da90: 2020 2020 2020 2066 6c6f 6174 2074 6865         float the
-0005daa0: 7461 203d 2028 666c 6f61 7429 703b 0a0a  ta = (float)p;..
-0005dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dac0: 6966 2028 2169 735f 6e65 6f78 2920 7b0a  if (!is_neox) {.
+0005d140: 2020 636f 6e73 7420 666c 6f61 7420 7831    const float x1
+0005d150: 203d 2073 7263 5b6e 5f64 696d 732f 325d   = src[n_dims/2]
+0005d160: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0005d170: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0005d180: 7374 5f64 6174 615b 305d 2020 2020 2020  st_data[0]      
+0005d190: 2020 3d20 7830 2a63 6f73 5f74 6865 7461    = x0*cos_theta
+0005d1a0: 202d 2078 312a 7369 6e5f 7468 6574 613b   - x1*sin_theta;
+0005d1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005d1c0: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+0005d1d0: 5f64 6174 615b 6e5f 6469 6d73 2f32 5d20  _data[n_dims/2] 
+0005d1e0: 3d20 7830 2a73 696e 5f74 6865 7461 202b  = x0*sin_theta +
+0005d1f0: 2078 312a 636f 735f 7468 6574 613b 0a20   x1*cos_theta;. 
+0005d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d210: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0005d220: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0005d230: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0005d240: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0005d250: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+0005d260: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+0005d270: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0005d280: 7264 5f72 6f70 655f 6631 3628 0a20 2020  rd_rope_f16(.   
+0005d290: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0005d2a0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+0005d2b0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+0005d2c0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0005d2d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0005d2e0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+0005d2f0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0005d300: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
+0005d310: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0005d320: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+0005d330: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
+0005d340: 5353 4552 5428 7372 6331 2d3e 7479 7065  SSERT(src1->type
+0005d350: 203d 3d20 4747 4d4c 5f54 5950 455f 4933   == GGML_TYPE_I3
+0005d360: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
+0005d370: 4552 5428 6767 6d6c 5f6e 656c 656d 656e  ERT(ggml_nelemen
+0005d380: 7473 2873 7263 3129 203d 3d20 3329 3b0a  ts(src1) == 3);.
+0005d390: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+0005d3a0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0005d3b0: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+0005d3c0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+0005d3d0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+0005d3e0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+0005d3f0: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
+0005d400: 7420 696e 7420 6e5f 7061 7374 203d 2028  t int n_past = (
+0005d410: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
+0005d420: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
+0005d430: 636f 6e73 7420 696e 7420 6e5f 6469 6d73  const int n_dims
+0005d440: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
+0005d450: 7372 6331 2d3e 6461 7461 295b 315d 3b0a  src1->data)[1];.
+0005d460: 2020 2020 636f 6e73 7420 696e 7420 6d6f      const int mo
+0005d470: 6465 2020 203d 2028 2869 6e74 3332 5f74  de   = ((int32_t
+0005d480: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
+0005d490: 325d 3b0a 0a20 2020 2061 7373 6572 7428  2];..    assert(
+0005d4a0: 6e5f 7061 7374 203e 3d20 3029 3b0a 0a20  n_past >= 0);.. 
+0005d4b0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0005d4c0: 6e62 3030 203d 2073 7263 302d 3e6e 625b  nb00 = src0->nb[
+0005d4d0: 305d 3b0a 2020 2020 636f 6e73 7420 7369  0];.    const si
+0005d4e0: 7a65 5f74 206e 6230 3120 3d20 7372 6330  ze_t nb01 = src0
+0005d4f0: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
+0005d500: 7374 2073 697a 655f 7420 6e62 3032 203d  st size_t nb02 =
+0005d510: 2073 7263 302d 3e6e 625b 325d 3b0a 2020   src0->nb[2];.  
+0005d520: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0005d530: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
+0005d540: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+0005d550: 7436 345f 7420 6e65 3020 3d20 6473 742d  t64_t ne0 = dst-
+0005d560: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+0005d570: 7420 696e 7436 345f 7420 6e65 3120 3d20  t int64_t ne1 = 
+0005d580: 6473 742d 3e6e 655b 315d 3b0a 2020 2020  dst->ne[1];.    
+0005d590: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0005d5a0: 3220 3d20 6473 742d 3e6e 655b 325d 3b0a  2 = dst->ne[2];.
+0005d5b0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+0005d5c0: 7420 6e65 3320 3d20 6473 742d 3e6e 655b  t ne3 = dst->ne[
+0005d5d0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2073  3];..    const s
+0005d5e0: 697a 655f 7420 6e62 3020 3d20 6473 742d  ize_t nb0 = dst-
+0005d5f0: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
+0005d600: 7420 7369 7a65 5f74 206e 6231 203d 2064  t size_t nb1 = d
+0005d610: 7374 2d3e 6e62 5b31 5d3b 0a20 2020 2063  st->nb[1];.    c
+0005d620: 6f6e 7374 2073 697a 655f 7420 6e62 3220  onst size_t nb2 
+0005d630: 3d20 6473 742d 3e6e 625b 325d 3b0a 2020  = dst->nb[2];.  
+0005d640: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0005d650: 6233 203d 2064 7374 2d3e 6e62 5b33 5d3b  b3 = dst->nb[3];
+0005d660: 0a0a 2020 2020 2f2f 7072 696e 7466 2822  ..    //printf("
+0005d670: 6e65 303a 2025 642c 206e 6531 3a20 2564  ne0: %d, ne1: %d
+0005d680: 2c20 6e65 323a 2025 642c 206e 6533 3a20  , ne2: %d, ne3: 
+0005d690: 2564 5c6e 222c 206e 6530 2c20 6e65 312c  %d\n", ne0, ne1,
+0005d6a0: 206e 6532 2c20 6e65 3329 3b0a 2020 2020   ne2, ne3);.    
+0005d6b0: 2f2f 7072 696e 7466 2822 6e5f 7061 7374  //printf("n_past
+0005d6c0: 203d 2025 642c 206e 6532 203d 2025 645c   = %d, ne2 = %d\
+0005d6d0: 6e22 2c20 6e5f 7061 7374 2c20 6e65 3229  n", n_past, ne2)
+0005d6e0: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+0005d6f0: 5254 286e 6230 203d 3d20 7369 7a65 6f66  RT(nb0 == sizeof
+0005d700: 2867 676d 6c5f 6670 3136 5f74 2929 3b0a  (ggml_fp16_t));.
+0005d710: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+0005d720: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
+0005d730: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0005d740: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
+0005d750: 683b 0a0a 2020 2020 636f 6e73 7420 696e  h;..    const in
+0005d760: 7420 6e72 203d 2067 676d 6c5f 6e72 6f77  t nr = ggml_nrow
+0005d770: 7328 6473 7429 3b0a 0a20 2020 2047 474d  s(dst);..    GGM
+0005d780: 4c5f 4153 5345 5254 286e 5f64 696d 7320  L_ASSERT(n_dims 
+0005d790: 3c3d 206e 6530 293b 0a20 2020 2047 474d  <= ne0);.    GGM
+0005d7a0: 4c5f 4153 5345 5254 286e 5f64 696d 7320  L_ASSERT(n_dims 
+0005d7b0: 2520 3220 3d3d 2030 293b 0a0a 2020 2020  % 2 == 0);..    
+0005d7c0: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
+0005d7d0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+0005d7e0: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
+0005d7f0: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
+0005d800: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
+0005d810: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
+0005d820: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
+0005d830: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
+0005d840: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
+0005d850: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
+0005d860: 2020 2020 2f2f 2072 6f77 2069 6e64 6578      // row index
+0005d870: 2075 7365 6420 746f 2064 6574 6572 6d69   used to determi
+0005d880: 6e65 2077 6869 6368 2074 6872 6561 6420  ne which thread 
+0005d890: 746f 2075 7365 0a20 2020 2069 6e74 2069  to use.    int i
+0005d8a0: 7220 3d20 303b 0a0a 2020 2020 636f 6e73  r = 0;..    cons
+0005d8b0: 7420 666c 6f61 7420 7468 6574 615f 7363  t float theta_sc
+0005d8c0: 616c 6520 3d20 706f 7766 2831 3030 3030  ale = powf(10000
+0005d8d0: 2e30 2c20 2d32 2e30 662f 6e5f 6469 6d73  .0, -2.0f/n_dims
+0005d8e0: 293b 0a0a 2020 2020 636f 6e73 7420 626f  );..    const bo
+0005d8f0: 6f6c 2069 735f 6e65 6f78 203d 206d 6f64  ol is_neox = mod
+0005d900: 6520 2620 323b 0a0a 2020 2020 666f 7220  e & 2;..    for 
+0005d910: 2869 6e74 3634 5f74 2069 3320 3d20 303b  (int64_t i3 = 0;
+0005d920: 2069 3320 3c20 6e65 333b 2069 332b 2b29   i3 < ne3; i3++)
+0005d930: 207b 0a20 2020 2020 2020 2066 6f72 2028   {.        for (
+0005d940: 696e 7436 345f 7420 6932 203d 2028 286d  int64_t i2 = ((m
+0005d950: 6f64 6520 2620 3129 203d 3d20 3020 3f20  ode & 1) == 0 ? 
+0005d960: 3020 3a20 6e5f 7061 7374 293b 2069 3220  0 : n_past); i2 
+0005d970: 3c20 6e65 323b 2069 322b 2b29 207b 0a20  < ne2; i2++) {. 
+0005d980: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0005d990: 2069 6e74 3634 5f74 2070 203d 2028 286d   int64_t p = ((m
+0005d9a0: 6f64 6520 2620 3129 203d 3d20 3020 3f20  ode & 1) == 0 ? 
+0005d9b0: 6e5f 7061 7374 202b 2069 3220 3a20 6932  n_past + i2 : i2
+0005d9c0: 293b 0a20 2020 2020 2020 2020 2020 2066  );.            f
+0005d9d0: 6f72 2028 696e 7436 345f 7420 6931 203d  or (int64_t i1 =
+0005d9e0: 2030 3b20 6931 203c 206e 6531 3b20 6931   0; i1 < ne1; i1
+0005d9f0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0005da00: 2020 2020 2020 6966 2028 6972 2b2b 203c        if (ir++ <
+0005da10: 2069 7230 2920 636f 6e74 696e 7565 3b0a   ir0) continue;.
+0005da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005da30: 6966 2028 6972 2020 203e 2069 7231 2920  if (ir   > ir1) 
+0005da40: 6272 6561 6b3b 0a0a 2020 2020 2020 2020  break;..        
+0005da50: 2020 2020 2020 2020 666c 6f61 7420 7468          float th
+0005da60: 6574 6120 3d20 2866 6c6f 6174 2970 3b0a  eta = (float)p;.
+0005da70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005da80: 2069 6620 2821 6973 5f6e 656f 7829 207b   if (!is_neox) {
+0005da90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005daa0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+0005dab0: 7420 6930 203d 2030 3b20 6930 203c 206e  t i0 = 0; i0 < n
+0005dac0: 6530 3b20 6930 202b 3d20 3229 207b 0a20  e0; i0 += 2) {. 
 0005dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dae0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0005daf0: 2069 3020 3d20 303b 2069 3020 3c20 6e65   i0 = 0; i0 < ne
-0005db00: 303b 2069 3020 2b3d 2032 2920 7b0a 2020  0; i0 += 2) {.  
+0005dae0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0005daf0: 6174 2063 6f73 5f74 6865 7461 203d 2063  at cos_theta = c
+0005db00: 6f73 6628 7468 6574 6129 3b0a 2020 2020  osf(theta);.    
 0005db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005db20: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-0005db30: 7420 636f 735f 7468 6574 6120 3d20 636f  t cos_theta = co
-0005db40: 7366 2874 6865 7461 293b 0a20 2020 2020  sf(theta);.     
+0005db20: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+0005db30: 7369 6e5f 7468 6574 6120 3d20 7369 6e66  sin_theta = sinf
+0005db40: 2874 6865 7461 293b 0a0a 2020 2020 2020  (theta);..      
 0005db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005db60: 2020 2063 6f6e 7374 2066 6c6f 6174 2073     const float s
-0005db70: 696e 5f74 6865 7461 203d 2073 696e 6628  in_theta = sinf(
-0005db80: 7468 6574 6129 3b0a 0a20 2020 2020 2020  theta);..       
-0005db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dba0: 2074 6865 7461 202a 3d20 7468 6574 615f   theta *= theta_
-0005dbb0: 7363 616c 653b 0a0a 2020 2020 2020 2020  scale;..        
-0005dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dbd0: 636f 6e73 7420 6767 6d6c 5f66 7031 365f  const ggml_fp16_
-0005dbe0: 7420 2a20 636f 6e73 7420 7372 6320 3d20  t * const src = 
-0005dbf0: 2867 676d 6c5f 6670 3136 5f74 202a 2928  (ggml_fp16_t *)(
-0005dc00: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-0005dc10: 6174 6120 2b20 6933 2a6e 6230 3320 2b20  ata + i3*nb03 + 
-0005dc20: 6932 2a6e 6230 3220 2b20 6931 2a6e 6230  i2*nb02 + i1*nb0
-0005dc30: 3120 2b20 6930 2a6e 6230 3029 3b0a 2020  1 + i0*nb00);.  
-0005dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dc50: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0005dc60: 5f66 7031 365f 7420 2a20 6473 745f 6461  _fp16_t * dst_da
-0005dc70: 7461 2020 3d20 2867 676d 6c5f 6670 3136  ta  = (ggml_fp16
-0005dc80: 5f74 202a 2928 2863 6861 7220 2a29 2020  _t *)((char *)  
-0005dc90: 6473 742d 3e64 6174 6120 2b20 6933 2a6e  dst->data + i3*n
-0005dca0: 6233 2020 2b20 6932 2a6e 6232 2020 2b20  b3  + i2*nb2  + 
-0005dcb0: 6931 2a6e 6231 2020 2b20 6930 2a6e 6230  i1*nb1  + i0*nb0
-0005dcc0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0005dcd0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0005dce0: 7420 666c 6f61 7420 7830 203d 2047 474d  t float x0 = GGM
-0005dcf0: 4c5f 4650 3136 5f54 4f5f 4650 3332 2873  L_FP16_TO_FP32(s
-0005dd00: 7263 5b30 5d29 3b0a 2020 2020 2020 2020  rc[0]);.        
+0005db60: 2020 7468 6574 6120 2a3d 2074 6865 7461    theta *= theta
+0005db70: 5f73 6361 6c65 3b0a 0a20 2020 2020 2020  _scale;..       
+0005db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005db90: 2063 6f6e 7374 2067 676d 6c5f 6670 3136   const ggml_fp16
+0005dba0: 5f74 202a 2063 6f6e 7374 2073 7263 203d  _t * const src =
+0005dbb0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+0005dbc0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+0005dbd0: 6461 7461 202b 2069 332a 6e62 3033 202b  data + i3*nb03 +
+0005dbe0: 2069 322a 6e62 3032 202b 2069 312a 6e62   i2*nb02 + i1*nb
+0005dbf0: 3031 202b 2069 302a 6e62 3030 293b 0a20  01 + i0*nb00);. 
+0005dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005dc10: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0005dc20: 6c5f 6670 3136 5f74 202a 2064 7374 5f64  l_fp16_t * dst_d
+0005dc30: 6174 6120 203d 2028 6767 6d6c 5f66 7031  ata  = (ggml_fp1
+0005dc40: 365f 7420 2a29 2828 6368 6172 202a 2920  6_t *)((char *) 
+0005dc50: 2064 7374 2d3e 6461 7461 202b 2069 332a   dst->data + i3*
+0005dc60: 6e62 3320 202b 2069 322a 6e62 3220 202b  nb3  + i2*nb2  +
+0005dc70: 2069 312a 6e62 3120 202b 2069 302a 6e62   i1*nb1  + i0*nb
+0005dc80: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
+0005dc90: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005dca0: 7374 2066 6c6f 6174 2078 3020 3d20 4747  st float x0 = GG
+0005dcb0: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
+0005dcc0: 7372 635b 305d 293b 0a20 2020 2020 2020  src[0]);.       
+0005dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005dce0: 2063 6f6e 7374 2066 6c6f 6174 2078 3120   const float x1 
+0005dcf0: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
+0005dd00: 5033 3228 7372 635b 315d 293b 0a0a 2020  P32(src[1]);..  
 0005dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dd20: 636f 6e73 7420 666c 6f61 7420 7831 203d  const float x1 =
-0005dd30: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
-0005dd40: 3332 2873 7263 5b31 5d29 3b0a 0a20 2020  32(src[1]);..   
-0005dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dd60: 2020 2020 2064 7374 5f64 6174 615b 305d       dst_data[0]
-0005dd70: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
-0005dd80: 4650 3136 2878 302a 636f 735f 7468 6574  FP16(x0*cos_thet
-0005dd90: 6120 2d20 7831 2a73 696e 5f74 6865 7461  a - x1*sin_theta
-0005dda0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0005ddb0: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
-0005ddc0: 6174 615b 315d 203d 2047 474d 4c5f 4650  ata[1] = GGML_FP
-0005ddd0: 3332 5f54 4f5f 4650 3136 2878 302a 7369  32_TO_FP16(x0*si
-0005dde0: 6e5f 7468 6574 6120 2b20 7831 2a63 6f73  n_theta + x1*cos
-0005ddf0: 5f74 6865 7461 293b 0a20 2020 2020 2020  _theta);.       
-0005de00: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0005de10: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0005de20: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-0005de30: 2020 2020 2020 2020 2020 2020 2f2f 2054              // T
-0005de40: 4f44 4f3a 2074 6869 7320 6973 2070 726f  ODO: this is pro
-0005de50: 6261 626c 7920 7772 6f6e 672c 2062 7574  bably wrong, but
-0005de60: 2049 2063 616e 2774 2066 6967 7572 6520   I can't figure 
-0005de70: 6974 206f 7574 202e 2e0a 2020 2020 2020  it out ...      
-0005de80: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0005de90: 2072 6566 3a20 2068 7474 7073 3a2f 2f67   ref:  https://g
-0005dea0: 6974 6875 622e 636f 6d2f 6875 6767 696e  ithub.com/huggin
-0005deb0: 6766 6163 652f 7472 616e 7366 6f72 6d65  gface/transforme
-0005dec0: 7273 2f62 6c6f 622f 6d61 696e 2f73 7263  rs/blob/main/src
-0005ded0: 2f74 7261 6e73 666f 726d 6572 732f 6d6f  /transformers/mo
-0005dee0: 6465 6c73 2f67 7074 5f6e 656f 782f 6d6f  dels/gpt_neox/mo
-0005def0: 6465 6c69 6e67 5f67 7074 5f6e 656f 782e  deling_gpt_neox.
-0005df00: 7079 234c 4c32 3531 4331 2d4c 3239 3443  py#LL251C1-L294C
-0005df10: 3238 0a20 2020 2020 2020 2020 2020 2020  28.             
-0005df20: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-0005df30: 345f 7420 6962 203d 2030 3b20 6962 203c  4_t ib = 0; ib <
-0005df40: 206e 6530 2f6e 5f64 696d 733b 202b 2b69   ne0/n_dims; ++i
-0005df50: 6229 207b 0a20 2020 2020 2020 2020 2020  b) {.           
-0005df60: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0005df70: 2028 696e 7436 345f 7420 6963 203d 2030   (int64_t ic = 0
-0005df80: 3b20 6963 203c 206e 5f64 696d 733b 2069  ; ic < n_dims; i
-0005df90: 6320 2b3d 2032 2920 7b0a 2020 2020 2020  c += 2) {.      
+0005dd20: 2020 2020 2020 6473 745f 6461 7461 5b30        dst_data[0
+0005dd30: 5d20 3d20 4747 4d4c 5f46 5033 325f 544f  ] = GGML_FP32_TO
+0005dd40: 5f46 5031 3628 7830 2a63 6f73 5f74 6865  _FP16(x0*cos_the
+0005dd50: 7461 202d 2078 312a 7369 6e5f 7468 6574  ta - x1*sin_thet
+0005dd60: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
+0005dd70: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
+0005dd80: 6461 7461 5b31 5d20 3d20 4747 4d4c 5f46  data[1] = GGML_F
+0005dd90: 5033 325f 544f 5f46 5031 3628 7830 2a73  P32_TO_FP16(x0*s
+0005dda0: 696e 5f74 6865 7461 202b 2078 312a 636f  in_theta + x1*co
+0005ddb0: 735f 7468 6574 6129 3b0a 2020 2020 2020  s_theta);.      
+0005ddc0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0005ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005dde0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+0005ddf0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0005de00: 544f 444f 3a20 7468 6973 2069 7320 7072  TODO: this is pr
+0005de10: 6f62 6162 6c79 2077 726f 6e67 2c20 6275  obably wrong, bu
+0005de20: 7420 4920 6361 6e27 7420 6669 6775 7265  t I can't figure
+0005de30: 2069 7420 6f75 7420 2e2e 0a20 2020 2020   it out ...     
+0005de40: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0005de50: 2f20 7265 663a 2020 6874 7470 733a 2f2f  / ref:  https://
+0005de60: 6769 7468 7562 2e63 6f6d 2f68 7567 6769  github.com/huggi
+0005de70: 6e67 6661 6365 2f74 7261 6e73 666f 726d  ngface/transform
+0005de80: 6572 732f 626c 6f62 2f6d 6169 6e2f 7372  ers/blob/main/sr
+0005de90: 632f 7472 616e 7366 6f72 6d65 7273 2f6d  c/transformers/m
+0005dea0: 6f64 656c 732f 6770 745f 6e65 6f78 2f6d  odels/gpt_neox/m
+0005deb0: 6f64 656c 696e 675f 6770 745f 6e65 6f78  odeling_gpt_neox
+0005dec0: 2e70 7923 4c4c 3235 3143 312d 4c32 3934  .py#LL251C1-L294
+0005ded0: 4332 380a 2020 2020 2020 2020 2020 2020  C28.            
+0005dee0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0005def0: 3634 5f74 2069 6220 3d20 303b 2069 6220  64_t ib = 0; ib 
+0005df00: 3c20 6e65 302f 6e5f 6469 6d73 3b20 2b2b  < ne0/n_dims; ++
+0005df10: 6962 2920 7b0a 2020 2020 2020 2020 2020  ib) {.          
+0005df20: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0005df30: 7220 2869 6e74 3634 5f74 2069 6320 3d20  r (int64_t ic = 
+0005df40: 303b 2069 6320 3c20 6e5f 6469 6d73 3b20  0; ic < n_dims; 
+0005df50: 6963 202b 3d20 3229 207b 0a20 2020 2020  ic += 2) {.     
+0005df60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005df70: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0005df80: 6174 2063 6f73 5f74 6865 7461 203d 2063  at cos_theta = c
+0005df90: 6f73 6628 7468 6574 6129 3b0a 2020 2020  osf(theta);.    
 0005dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dfb0: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-0005dfc0: 7420 636f 735f 7468 6574 6120 3d20 636f  t cos_theta = co
-0005dfd0: 7366 2874 6865 7461 293b 0a20 2020 2020  sf(theta);.     
+0005dfb0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+0005dfc0: 6f61 7420 7369 6e5f 7468 6574 6120 3d20  oat sin_theta = 
+0005dfd0: 7369 6e66 2874 6865 7461 293b 0a0a 2020  sinf(theta);..  
 0005dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dff0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0005e000: 6174 2073 696e 5f74 6865 7461 203d 2073  at sin_theta = s
-0005e010: 696e 6628 7468 6574 6129 3b0a 0a20 2020  inf(theta);..   
-0005e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e030: 2020 2020 2020 2020 2074 6865 7461 202a           theta *
-0005e040: 3d20 7468 6574 615f 7363 616c 653b 0a0a  = theta_scale;..
-0005e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e060: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0005e070: 7420 696e 7436 345f 7420 6930 203d 2069  t int64_t i0 = i
-0005e080: 622a 6e5f 6469 6d73 202b 2069 632f 323b  b*n_dims + ic/2;
-0005e090: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0005e0a0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005e0b0: 6e73 7420 6767 6d6c 5f66 7031 365f 7420  nst ggml_fp16_t 
-0005e0c0: 2a20 636f 6e73 7420 7372 6320 3d20 2867  * const src = (g
-0005e0d0: 676d 6c5f 6670 3136 5f74 202a 2928 2863  gml_fp16_t *)((c
-0005e0e0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-0005e0f0: 6120 2b20 6933 2a6e 6230 3320 2b20 6932  a + i3*nb03 + i2
-0005e100: 2a6e 6230 3220 2b20 6931 2a6e 6230 3120  *nb02 + i1*nb01 
-0005e110: 2b20 6930 2a6e 6230 3029 3b0a 2020 2020  + i0*nb00);.    
-0005e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e130: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0005e140: 6d6c 5f66 7031 365f 7420 2a20 6473 745f  ml_fp16_t * dst_
-0005e150: 6461 7461 2020 3d20 2867 676d 6c5f 6670  data  = (ggml_fp
-0005e160: 3136 5f74 202a 2928 2863 6861 7220 2a29  16_t *)((char *)
-0005e170: 2020 6473 742d 3e64 6174 6120 2b20 6933    dst->data + i3
-0005e180: 2a6e 6233 2020 2b20 6932 2a6e 6232 2020  *nb3  + i2*nb2  
-0005e190: 2b20 6931 2a6e 6231 2020 2b20 6930 2a6e  + i1*nb1  + i0*n
-0005e1a0: 6230 293b 0a0a 2020 2020 2020 2020 2020  b0);..          
+0005dff0: 2020 2020 2020 2020 2020 7468 6574 6120            theta 
+0005e000: 2a3d 2074 6865 7461 5f73 6361 6c65 3b0a  *= theta_scale;.
+0005e010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005e020: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005e030: 7374 2069 6e74 3634 5f74 2069 3020 3d20  st int64_t i0 = 
+0005e040: 6962 2a6e 5f64 696d 7320 2b20 6963 2f32  ib*n_dims + ic/2
+0005e050: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0005e060: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0005e070: 6f6e 7374 2067 676d 6c5f 6670 3136 5f74  onst ggml_fp16_t
+0005e080: 202a 2063 6f6e 7374 2073 7263 203d 2028   * const src = (
+0005e090: 6767 6d6c 5f66 7031 365f 7420 2a29 2828  ggml_fp16_t *)((
+0005e0a0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
+0005e0b0: 7461 202b 2069 332a 6e62 3033 202b 2069  ta + i3*nb03 + i
+0005e0c0: 322a 6e62 3032 202b 2069 312a 6e62 3031  2*nb02 + i1*nb01
+0005e0d0: 202b 2069 302a 6e62 3030 293b 0a20 2020   + i0*nb00);.   
+0005e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e0f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0005e100: 676d 6c5f 6670 3136 5f74 202a 2064 7374  gml_fp16_t * dst
+0005e110: 5f64 6174 6120 203d 2028 6767 6d6c 5f66  _data  = (ggml_f
+0005e120: 7031 365f 7420 2a29 2828 6368 6172 202a  p16_t *)((char *
+0005e130: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
+0005e140: 332a 6e62 3320 202b 2069 322a 6e62 3220  3*nb3  + i2*nb2 
+0005e150: 202b 2069 312a 6e62 3120 202b 2069 302a   + i1*nb1  + i0*
+0005e160: 6e62 3029 3b0a 0a20 2020 2020 2020 2020  nb0);..         
+0005e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e180: 2020 2063 6f6e 7374 2066 6c6f 6174 2078     const float x
+0005e190: 3020 3d20 4747 4d4c 5f46 5031 365f 544f  0 = GGML_FP16_TO
+0005e1a0: 5f46 5033 3228 7372 635b 305d 293b 0a20  _FP32(src[0]);. 
 0005e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e1c0: 2020 636f 6e73 7420 666c 6f61 7420 7830    const float x0
-0005e1d0: 203d 2047 474d 4c5f 4650 3136 5f54 4f5f   = GGML_FP16_TO_
-0005e1e0: 4650 3332 2873 7263 5b30 5d29 3b0a 2020  FP32(src[0]);.  
-0005e1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e200: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0005e210: 666c 6f61 7420 7831 203d 2047 474d 4c5f  float x1 = GGML_
-0005e220: 4650 3136 5f54 4f5f 4650 3332 2873 7263  FP16_TO_FP32(src
-0005e230: 5b6e 5f64 696d 732f 325d 293b 0a0a 2020  [n_dims/2]);..  
-0005e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e250: 2020 2020 2020 2020 2020 6473 745f 6461            dst_da
-0005e260: 7461 5b30 5d20 2020 2020 3d20 4747 4d4c  ta[0]     = GGML
-0005e270: 5f46 5033 325f 544f 5f46 5031 3628 7830  _FP32_TO_FP16(x0
-0005e280: 2a63 6f73 5f74 6865 7461 202d 2078 312a  *cos_theta - x1*
-0005e290: 7369 6e5f 7468 6574 6129 3b0a 2020 2020  sin_theta);.    
-0005e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e2b0: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
-0005e2c0: 5b6e 5f64 696d 732f 325d 203d 2047 474d  [n_dims/2] = GGM
-0005e2d0: 4c5f 4650 3332 5f54 4f5f 4650 3136 2878  L_FP32_TO_FP16(x
-0005e2e0: 302a 7369 6e5f 7468 6574 6120 2b20 7831  0*sin_theta + x1
-0005e2f0: 2a63 6f73 5f74 6865 7461 293b 0a20 2020  *cos_theta);.   
-0005e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e310: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0005e320: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0005e330: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0005e340: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0005e350: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
-0005e360: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-0005e370: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0005e380: 5f72 6f70 6528 0a20 2020 2020 2020 2063  _rope(.        c
-0005e390: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0005e3a0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-0005e3b0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-0005e3c0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005e3d0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-0005e3e0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-0005e3f0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0005e400: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-0005e410: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0005e420: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-0005e430: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
-0005e440: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-0005e450: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-0005e460: 5f46 3136 3a0a 2020 2020 2020 2020 2020  _F16:.          
-0005e470: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0005e480: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-0005e490: 5f66 6f72 7761 7264 5f72 6f70 655f 6631  _forward_rope_f1
-0005e4a0: 3628 7061 7261 6d73 2c20 7372 6330 2c20  6(params, src0, 
-0005e4b0: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
-0005e4c0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0005e4d0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0005e4e0: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
-0005e4f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0005e500: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0005e510: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0005e520: 726f 7065 5f66 3332 2870 6172 616d 732c  rope_f32(params,
-0005e530: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
-0005e540: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0005e550: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0005e560: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-0005e570: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0005e580: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0005e590: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-0005e5a0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0005e5b0: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
-0005e5c0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0005e5d0: 5f72 6f70 655f 6261 636b 0a0a 7374 6174  _rope_back..stat
-0005e5e0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-0005e5f0: 7075 7465 5f66 6f72 7761 7264 5f72 6f70  pute_forward_rop
-0005e600: 655f 6261 636b 5f66 3332 280a 2020 2020  e_back_f32(.    
-0005e610: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0005e620: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-0005e630: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-0005e640: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0005e650: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0005e660: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-0005e670: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0005e680: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-0005e690: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0005e6a0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-0005e6b0: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
-0005e6c0: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-0005e6d0: 4d4c 5f54 5950 455f 4933 3229 3b0a 2020  ML_TYPE_I32);.  
-0005e6e0: 2020 6173 7365 7274 2867 676d 6c5f 6e65    assert(ggml_ne
-0005e6f0: 6c65 6d65 6e74 7328 7372 6331 2920 3d3d  lements(src1) ==
-0005e700: 2033 293b 0a0a 2020 2020 6966 2028 7061   3);..    if (pa
-0005e710: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-0005e720: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-0005e730: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-0005e740: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-0005e750: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-0005e760: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-0005e770: 202f 2f20 7920 3d20 726f 7065 2878 2c20   // y = rope(x, 
-0005e780: 7372 6331 290a 2020 2020 2f2f 2064 7820  src1).    // dx 
-0005e790: 3d20 726f 7065 5f62 6163 6b28 6479 2c20  = rope_back(dy, 
-0005e7a0: 7372 6331 290a 2020 2020 2f2f 2073 7263  src1).    // src
-0005e7b0: 3020 6973 2064 792c 2073 7263 3120 636f  0 is dy, src1 co
-0005e7c0: 6e74 6169 6e73 206f 7074 696f 6e73 0a0a  ntains options..
-0005e7d0: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
-0005e7e0: 7061 7374 203d 2028 2869 6e74 3332 5f74  past = ((int32_t
-0005e7f0: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-0005e800: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0005e810: 7420 6e5f 6469 6d73 203d 2028 2869 6e74  t n_dims = ((int
-0005e820: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
-0005e830: 7461 295b 315d 3b0a 2020 2020 636f 6e73  ta)[1];.    cons
-0005e840: 7420 696e 7420 6d6f 6465 2020 203d 2028  t int mode   = (
-0005e850: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-0005e860: 2d3e 6461 7461 295b 325d 3b0a 0a20 2020  ->data)[2];..   
-0005e870: 2061 7373 6572 7428 6e5f 7061 7374 203e   assert(n_past >
-0005e880: 3d20 3029 3b0a 0a20 2020 2063 6f6e 7374  = 0);..    const
-0005e890: 2073 697a 655f 7420 6e62 3030 203d 2073   size_t nb00 = s
-0005e8a0: 7263 302d 3e6e 625b 305d 3b0a 2020 2020  rc0->nb[0];.    
-0005e8b0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
-0005e8c0: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
-0005e8d0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-0005e8e0: 7420 6e62 3032 203d 2073 7263 302d 3e6e  t nb02 = src0->n
-0005e8f0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-0005e900: 7369 7a65 5f74 206e 6230 3320 3d20 7372  size_t nb03 = sr
-0005e910: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
-0005e920: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0005e930: 3020 3d20 6473 742d 3e6e 655b 305d 3b0a  0 = dst->ne[0];.
-0005e940: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0005e950: 7420 6e65 3120 3d20 6473 742d 3e6e 655b  t ne1 = dst->ne[
-0005e960: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-0005e970: 7436 345f 7420 6e65 3220 3d20 6473 742d  t64_t ne2 = dst-
-0005e980: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-0005e990: 7420 696e 7436 345f 7420 6e65 3320 3d20  t int64_t ne3 = 
-0005e9a0: 6473 742d 3e6e 655b 335d 3b0a 0a20 2020  dst->ne[3];..   
-0005e9b0: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0005e9c0: 3020 3d20 6473 742d 3e6e 625b 305d 3b0a  0 = dst->nb[0];.
-0005e9d0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0005e9e0: 206e 6231 203d 2064 7374 2d3e 6e62 5b31   nb1 = dst->nb[1
-0005e9f0: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-0005ea00: 655f 7420 6e62 3220 3d20 6473 742d 3e6e  e_t nb2 = dst->n
-0005ea10: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-0005ea20: 7369 7a65 5f74 206e 6233 203d 2064 7374  size_t nb3 = dst
-0005ea30: 2d3e 6e62 5b33 5d3b 0a0a 0a20 2020 202f  ->nb[3];...    /
-0005ea40: 2f70 7269 6e74 6628 226e 6530 3a20 2564  /printf("ne0: %d
-0005ea50: 2c20 6e65 313a 2025 642c 206e 6532 3a20  , ne1: %d, ne2: 
-0005ea60: 2564 2c20 6e65 333a 2025 645c 6e22 2c20  %d, ne3: %d\n", 
-0005ea70: 6e65 302c 206e 6531 2c20 6e65 322c 206e  ne0, ne1, ne2, n
-0005ea80: 6533 293b 0a20 2020 202f 2f70 7269 6e74  e3);.    //print
-0005ea90: 6628 226e 5f70 6173 7420 3d20 2564 2c20  f("n_past = %d, 
-0005eaa0: 6e65 3220 3d20 2564 5c6e 222c 206e 5f70  ne2 = %d\n", n_p
-0005eab0: 6173 742c 206e 6532 293b 0a0a 2020 2020  ast, ne2);..    
-0005eac0: 6173 7365 7274 286e 6230 203d 3d20 7369  assert(nb0 == si
-0005ead0: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
-0005eae0: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-0005eaf0: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-0005eb00: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-0005eb10: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-0005eb20: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005eb30: 6e72 203d 2067 676d 6c5f 6e72 6f77 7328  nr = ggml_nrows(
-0005eb40: 6473 7429 3b0a 0a20 2020 202f 2f20 726f  dst);..    // ro
-0005eb50: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
-0005eb60: 2020 636f 6e73 7420 696e 7420 6472 203d    const int dr =
-0005eb70: 2028 6e72 202b 206e 7468 202d 2031 292f   (nr + nth - 1)/
-0005eb80: 6e74 683b 0a0a 2020 2020 2f2f 2072 6f77  nth;..    // row
-0005eb90: 2072 616e 6765 2066 6f72 2074 6869 7320   range for this 
-0005eba0: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-0005ebb0: 2069 6e74 2069 7230 203d 2064 722a 6974   int ir0 = dr*it
-0005ebc0: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-0005ebd0: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
-0005ebe0: 2064 722c 206e 7229 3b0a 0a20 2020 202f   dr, nr);..    /
-0005ebf0: 2f20 726f 7720 696e 6465 7820 7573 6564  / row index used
-0005ec00: 2074 6f20 6465 7465 726d 696e 6520 7768   to determine wh
-0005ec10: 6963 6820 7468 7265 6164 2074 6f20 7573  ich thread to us
-0005ec20: 650a 2020 2020 696e 7420 6972 203d 2030  e.    int ir = 0
-0005ec30: 3b0a 0a20 2020 2063 6f6e 7374 2066 6c6f  ;..    const flo
-0005ec40: 6174 2074 6865 7461 5f73 6361 6c65 203d  at theta_scale =
-0005ec50: 2070 6f77 6628 3130 3030 302e 302c 202d   powf(10000.0, -
-0005ec60: 322e 3066 2f6e 5f64 696d 7329 3b0a 0a20  2.0f/n_dims);.. 
-0005ec70: 2020 2063 6f6e 7374 2062 6f6f 6c20 6973     const bool is
-0005ec80: 5f6e 656f 7820 3d20 6d6f 6465 2026 2032  _neox = mode & 2
-0005ec90: 3b0a 0a20 2020 2066 6f72 2028 696e 7436  ;..    for (int6
-0005eca0: 345f 7420 6933 203d 2030 3b20 6933 203c  4_t i3 = 0; i3 <
-0005ecb0: 206e 6533 3b20 6933 2b2b 2920 7b0a 2020   ne3; i3++) {.  
-0005ecc0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-0005ecd0: 5f74 2069 3220 3d20 2828 6d6f 6465 2026  _t i2 = ((mode &
-0005ece0: 2031 2920 3d3d 2030 203f 2030 203a 206e   1) == 0 ? 0 : n
-0005ecf0: 5f70 6173 7429 3b20 6932 203c 206e 6532  _past); i2 < ne2
-0005ed00: 3b20 6932 2b2b 2920 7b0a 2020 2020 2020  ; i2++) {.      
-0005ed10: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
-0005ed20: 345f 7420 7020 3d20 2828 6d6f 6465 2026  4_t p = ((mode &
-0005ed30: 2031 2920 3d3d 2030 203f 206e 5f70 6173   1) == 0 ? n_pas
-0005ed40: 7420 2b20 6932 203a 2069 3229 3b0a 2020  t + i2 : i2);.  
-0005ed50: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0005ed60: 6e74 3634 5f74 2069 3120 3d20 303b 2069  nt64_t i1 = 0; i
-0005ed70: 3120 3c20 6e65 313b 2069 312b 2b29 207b  1 < ne1; i1++) {
-0005ed80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005ed90: 2069 6620 2869 722b 2b20 3c20 6972 3029   if (ir++ < ir0)
-0005eda0: 2063 6f6e 7469 6e75 653b 0a20 2020 2020   continue;.     
-0005edb0: 2020 2020 2020 2020 2020 2069 6620 2869             if (i
-0005edc0: 7220 2020 3e20 6972 3129 2062 7265 616b  r   > ir1) break
-0005edd0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0005ede0: 2020 2066 6c6f 6174 2074 6865 7461 203d     float theta =
-0005edf0: 2028 666c 6f61 7429 703b 0a0a 2020 2020   (float)p;..    
-0005ee00: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0005ee10: 2169 735f 6e65 6f78 2920 7b0a 2020 2020  !is_neox) {.    
+0005e1c0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0005e1d0: 2066 6c6f 6174 2078 3120 3d20 4747 4d4c   float x1 = GGML
+0005e1e0: 5f46 5031 365f 544f 5f46 5033 3228 7372  _FP16_TO_FP32(sr
+0005e1f0: 635b 6e5f 6469 6d73 2f32 5d29 3b0a 0a20  c[n_dims/2]);.. 
+0005e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e210: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
+0005e220: 6174 615b 305d 2020 2020 203d 2047 474d  ata[0]     = GGM
+0005e230: 4c5f 4650 3332 5f54 4f5f 4650 3136 2878  L_FP32_TO_FP16(x
+0005e240: 302a 636f 735f 7468 6574 6120 2d20 7831  0*cos_theta - x1
+0005e250: 2a73 696e 5f74 6865 7461 293b 0a20 2020  *sin_theta);.   
+0005e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e270: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
+0005e280: 615b 6e5f 6469 6d73 2f32 5d20 3d20 4747  a[n_dims/2] = GG
+0005e290: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
+0005e2a0: 7830 2a73 696e 5f74 6865 7461 202b 2078  x0*sin_theta + x
+0005e2b0: 312a 636f 735f 7468 6574 6129 3b0a 2020  1*cos_theta);.  
+0005e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e2d0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0005e2e0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0005e2f0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0005e300: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0005e310: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
+0005e320: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+0005e330: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0005e340: 645f 726f 7065 280a 2020 2020 2020 2020  d_rope(.        
+0005e350: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0005e360: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+0005e370: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+0005e380: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0005e390: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+0005e3a0: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
+0005e3b0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+0005e3c0: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
+0005e3d0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0005e3e0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+0005e3f0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
+0005e400: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+0005e410: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+0005e420: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
+0005e430: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0005e440: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+0005e450: 655f 666f 7277 6172 645f 726f 7065 5f66  e_forward_rope_f
+0005e460: 3136 2870 6172 616d 732c 2073 7263 302c  16(params, src0,
+0005e470: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
+0005e480: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0005e490: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0005e4a0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
+0005e4b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0005e4c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0005e4d0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0005e4e0: 5f72 6f70 655f 6633 3228 7061 7261 6d73  _rope_f32(params
+0005e4f0: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
+0005e500: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+0005e510: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0005e520: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
+0005e530: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0005e540: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0005e550: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+0005e560: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0005e570: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
+0005e580: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0005e590: 645f 726f 7065 5f62 6163 6b0a 0a73 7461  d_rope_back..sta
+0005e5a0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+0005e5b0: 6d70 7574 655f 666f 7277 6172 645f 726f  mpute_forward_ro
+0005e5c0: 7065 5f62 6163 6b5f 6633 3228 0a20 2020  pe_back_f32(.   
+0005e5d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0005e5e0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+0005e5f0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+0005e600: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0005e610: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0005e620: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+0005e630: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0005e640: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
+0005e650: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+0005e660: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+0005e670: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
+0005e680: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
+0005e690: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
+0005e6a0: 2020 2061 7373 6572 7428 6767 6d6c 5f6e     assert(ggml_n
+0005e6b0: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
+0005e6c0: 3d20 3329 3b0a 0a20 2020 2069 6620 2870  = 3);..    if (p
+0005e6d0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0005e6e0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+0005e6f0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+0005e700: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+0005e710: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+0005e720: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0005e730: 2020 2f2f 2079 203d 2072 6f70 6528 782c    // y = rope(x,
+0005e740: 2073 7263 3129 0a20 2020 202f 2f20 6478   src1).    // dx
+0005e750: 203d 2072 6f70 655f 6261 636b 2864 792c   = rope_back(dy,
+0005e760: 2073 7263 3129 0a20 2020 202f 2f20 7372   src1).    // sr
+0005e770: 6330 2069 7320 6479 2c20 7372 6331 2063  c0 is dy, src1 c
+0005e780: 6f6e 7461 696e 7320 6f70 7469 6f6e 730a  ontains options.
+0005e790: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005e7a0: 5f70 6173 7420 3d20 2828 696e 7433 325f  _past = ((int32_
+0005e7b0: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
+0005e7c0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+0005e7d0: 6e74 206e 5f64 696d 7320 3d20 2828 696e  nt n_dims = ((in
+0005e7e0: 7433 325f 7420 2a29 2073 7263 312d 3e64  t32_t *) src1->d
+0005e7f0: 6174 6129 5b31 5d3b 0a20 2020 2063 6f6e  ata)[1];.    con
+0005e800: 7374 2069 6e74 206d 6f64 6520 2020 3d20  st int mode   = 
+0005e810: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+0005e820: 312d 3e64 6174 6129 5b32 5d3b 0a0a 2020  1->data)[2];..  
+0005e830: 2020 6173 7365 7274 286e 5f70 6173 7420    assert(n_past 
+0005e840: 3e3d 2030 293b 0a0a 2020 2020 636f 6e73  >= 0);..    cons
+0005e850: 7420 7369 7a65 5f74 206e 6230 3020 3d20  t size_t nb00 = 
+0005e860: 7372 6330 2d3e 6e62 5b30 5d3b 0a20 2020  src0->nb[0];.   
+0005e870: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+0005e880: 3031 203d 2073 7263 302d 3e6e 625b 315d  01 = src0->nb[1]
+0005e890: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
+0005e8a0: 5f74 206e 6230 3220 3d20 7372 6330 2d3e  _t nb02 = src0->
+0005e8b0: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+0005e8c0: 2073 697a 655f 7420 6e62 3033 203d 2073   size_t nb03 = s
+0005e8d0: 7263 302d 3e6e 625b 335d 3b0a 0a20 2020  rc0->nb[3];..   
+0005e8e0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0005e8f0: 6530 203d 2064 7374 2d3e 6e65 5b30 5d3b  e0 = dst->ne[0];
+0005e900: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0005e910: 5f74 206e 6531 203d 2064 7374 2d3e 6e65  _t ne1 = dst->ne
+0005e920: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+0005e930: 6e74 3634 5f74 206e 6532 203d 2064 7374  nt64_t ne2 = dst
+0005e940: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
+0005e950: 7374 2069 6e74 3634 5f74 206e 6533 203d  st int64_t ne3 =
+0005e960: 2064 7374 2d3e 6e65 5b33 5d3b 0a0a 2020   dst->ne[3];..  
+0005e970: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0005e980: 6230 203d 2064 7374 2d3e 6e62 5b30 5d3b  b0 = dst->nb[0];
+0005e990: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0005e9a0: 7420 6e62 3120 3d20 6473 742d 3e6e 625b  t nb1 = dst->nb[
+0005e9b0: 315d 3b0a 2020 2020 636f 6e73 7420 7369  1];.    const si
+0005e9c0: 7a65 5f74 206e 6232 203d 2064 7374 2d3e  ze_t nb2 = dst->
+0005e9d0: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+0005e9e0: 2073 697a 655f 7420 6e62 3320 3d20 6473   size_t nb3 = ds
+0005e9f0: 742d 3e6e 625b 335d 3b0a 0a0a 2020 2020  t->nb[3];...    
+0005ea00: 2f2f 7072 696e 7466 2822 6e65 303a 2025  //printf("ne0: %
+0005ea10: 642c 206e 6531 3a20 2564 2c20 6e65 323a  d, ne1: %d, ne2:
+0005ea20: 2025 642c 206e 6533 3a20 2564 5c6e 222c   %d, ne3: %d\n",
+0005ea30: 206e 6530 2c20 6e65 312c 206e 6532 2c20   ne0, ne1, ne2, 
+0005ea40: 6e65 3329 3b0a 2020 2020 2f2f 7072 696e  ne3);.    //prin
+0005ea50: 7466 2822 6e5f 7061 7374 203d 2025 642c  tf("n_past = %d,
+0005ea60: 206e 6532 203d 2025 645c 6e22 2c20 6e5f   ne2 = %d\n", n_
+0005ea70: 7061 7374 2c20 6e65 3229 3b0a 0a20 2020  past, ne2);..   
+0005ea80: 2061 7373 6572 7428 6e62 3020 3d3d 2073   assert(nb0 == s
+0005ea90: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
+0005eaa0: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+0005eab0: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+0005eac0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005ead0: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+0005eae0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0005eaf0: 206e 7220 3d20 6767 6d6c 5f6e 726f 7773   nr = ggml_nrows
+0005eb00: 2864 7374 293b 0a0a 2020 2020 2f2f 2072  (dst);..    // r
+0005eb10: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
+0005eb20: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
+0005eb30: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
+0005eb40: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
+0005eb50: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
+0005eb60: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+0005eb70: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
+0005eb80: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+0005eb90: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
+0005eba0: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
+0005ebb0: 2f2f 2072 6f77 2069 6e64 6578 2075 7365  // row index use
+0005ebc0: 6420 746f 2064 6574 6572 6d69 6e65 2077  d to determine w
+0005ebd0: 6869 6368 2074 6872 6561 6420 746f 2075  hich thread to u
+0005ebe0: 7365 0a20 2020 2069 6e74 2069 7220 3d20  se.    int ir = 
+0005ebf0: 303b 0a0a 2020 2020 636f 6e73 7420 666c  0;..    const fl
+0005ec00: 6f61 7420 7468 6574 615f 7363 616c 6520  oat theta_scale 
+0005ec10: 3d20 706f 7766 2831 3030 3030 2e30 2c20  = powf(10000.0, 
+0005ec20: 2d32 2e30 662f 6e5f 6469 6d73 293b 0a0a  -2.0f/n_dims);..
+0005ec30: 2020 2020 636f 6e73 7420 626f 6f6c 2069      const bool i
+0005ec40: 735f 6e65 6f78 203d 206d 6f64 6520 2620  s_neox = mode & 
+0005ec50: 323b 0a0a 2020 2020 666f 7220 2869 6e74  2;..    for (int
+0005ec60: 3634 5f74 2069 3320 3d20 303b 2069 3320  64_t i3 = 0; i3 
+0005ec70: 3c20 6e65 333b 2069 332b 2b29 207b 0a20  < ne3; i3++) {. 
+0005ec80: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+0005ec90: 345f 7420 6932 203d 2028 286d 6f64 6520  4_t i2 = ((mode 
+0005eca0: 2620 3129 203d 3d20 3020 3f20 3020 3a20  & 1) == 0 ? 0 : 
+0005ecb0: 6e5f 7061 7374 293b 2069 3220 3c20 6e65  n_past); i2 < ne
+0005ecc0: 323b 2069 322b 2b29 207b 0a20 2020 2020  2; i2++) {.     
+0005ecd0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0005ece0: 3634 5f74 2070 203d 2028 286d 6f64 6520  64_t p = ((mode 
+0005ecf0: 2620 3129 203d 3d20 3020 3f20 6e5f 7061  & 1) == 0 ? n_pa
+0005ed00: 7374 202b 2069 3220 3a20 6932 293b 0a20  st + i2 : i2);. 
+0005ed10: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0005ed20: 696e 7436 345f 7420 6931 203d 2030 3b20  int64_t i1 = 0; 
+0005ed30: 6931 203c 206e 6531 3b20 6931 2b2b 2920  i1 < ne1; i1++) 
+0005ed40: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0005ed50: 2020 6966 2028 6972 2b2b 203c 2069 7230    if (ir++ < ir0
+0005ed60: 2920 636f 6e74 696e 7565 3b0a 2020 2020  ) continue;.    
+0005ed70: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0005ed80: 6972 2020 203e 2069 7231 2920 6272 6561  ir   > ir1) brea
+0005ed90: 6b3b 0a0a 2020 2020 2020 2020 2020 2020  k;..            
+0005eda0: 2020 2020 666c 6f61 7420 7468 6574 6120      float theta 
+0005edb0: 3d20 2866 6c6f 6174 2970 3b0a 0a20 2020  = (float)p;..   
+0005edc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0005edd0: 2821 6973 5f6e 656f 7829 207b 0a20 2020  (!is_neox) {.   
+0005ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005edf0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+0005ee00: 203d 2030 3b20 6930 203c 206e 6530 3b20   = 0; i0 < ne0; 
+0005ee10: 6930 202b 3d20 3229 207b 0a20 2020 2020  i0 += 2) {.     
 0005ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ee30: 666f 7220 2869 6e74 3634 5f74 2069 3020  for (int64_t i0 
-0005ee40: 3d20 303b 2069 3020 3c20 6e65 303b 2069  = 0; i0 < ne0; i
-0005ee50: 3020 2b3d 2032 2920 7b0a 2020 2020 2020  0 += 2) {.      
+0005ee30: 2020 2063 6f6e 7374 2066 6c6f 6174 2063     const float c
+0005ee40: 6f73 5f74 6865 7461 203d 2063 6f73 6628  os_theta = cosf(
+0005ee50: 7468 6574 6129 3b0a 2020 2020 2020 2020  theta);.        
 0005ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ee70: 2020 636f 6e73 7420 666c 6f61 7420 636f    const float co
-0005ee80: 735f 7468 6574 6120 3d20 636f 7366 2874  s_theta = cosf(t
-0005ee90: 6865 7461 293b 0a20 2020 2020 2020 2020  heta);.         
-0005eea0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0005eeb0: 6f6e 7374 2066 6c6f 6174 2073 696e 5f74  onst float sin_t
-0005eec0: 6865 7461 203d 2073 696e 6628 7468 6574  heta = sinf(thet
-0005eed0: 6129 3b0a 0a20 2020 2020 2020 2020 2020  a);..           
-0005eee0: 2020 2020 2020 2020 2020 2020 2074 6865               the
-0005eef0: 7461 202a 3d20 7468 6574 615f 7363 616c  ta *= theta_scal
-0005ef00: 653b 0a0a 2020 2020 2020 2020 2020 2020  e;..            
-0005ef10: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0005ef20: 7420 666c 6f61 7420 2a20 636f 6e73 7420  t float * const 
-0005ef30: 6479 2020 3d20 2866 6c6f 6174 202a 2928  dy  = (float *)(
-0005ef40: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-0005ef50: 6174 6120 2b20 6933 2a6e 6230 3320 2b20  ata + i3*nb03 + 
-0005ef60: 6932 2a6e 6230 3220 2b20 6931 2a6e 6230  i2*nb02 + i1*nb0
-0005ef70: 3120 2b20 6930 2a6e 6230 3029 3b0a 2020  1 + i0*nb00);.  
-0005ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ef90: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-0005efa0: 7420 2a20 2020 2020 2020 6478 2020 3d20  t *       dx  = 
-0005efb0: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
-0005efc0: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
-0005efd0: 6933 2a6e 6233 2020 2b20 6932 2a6e 6232  i3*nb3  + i2*nb2
-0005efe0: 2020 2b20 6931 2a6e 6231 2020 2b20 6930    + i1*nb1  + i0
-0005eff0: 2a6e 6230 293b 0a0a 2020 2020 2020 2020  *nb0);..        
-0005f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f010: 636f 6e73 7420 666c 6f61 7420 6479 3020  const float dy0 
-0005f020: 3d20 6479 5b30 5d3b 0a20 2020 2020 2020  = dy[0];.       
-0005f030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f040: 2063 6f6e 7374 2066 6c6f 6174 2064 7931   const float dy1
-0005f050: 203d 2064 795b 315d 3b0a 0a20 2020 2020   = dy[1];..     
+0005ee70: 636f 6e73 7420 666c 6f61 7420 7369 6e5f  const float sin_
+0005ee80: 7468 6574 6120 3d20 7369 6e66 2874 6865  theta = sinf(the
+0005ee90: 7461 293b 0a0a 2020 2020 2020 2020 2020  ta);..          
+0005eea0: 2020 2020 2020 2020 2020 2020 2020 7468                th
+0005eeb0: 6574 6120 2a3d 2074 6865 7461 5f73 6361  eta *= theta_sca
+0005eec0: 6c65 3b0a 0a20 2020 2020 2020 2020 2020  le;..           
+0005eed0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005eee0: 7374 2066 6c6f 6174 202a 2063 6f6e 7374  st float * const
+0005eef0: 2064 7920 203d 2028 666c 6f61 7420 2a29   dy  = (float *)
+0005ef00: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+0005ef10: 6461 7461 202b 2069 332a 6e62 3033 202b  data + i3*nb03 +
+0005ef20: 2069 322a 6e62 3032 202b 2069 312a 6e62   i2*nb02 + i1*nb
+0005ef30: 3031 202b 2069 302a 6e62 3030 293b 0a20  01 + i0*nb00);. 
+0005ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ef50: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+0005ef60: 6174 202a 2020 2020 2020 2064 7820 203d  at *       dx  =
+0005ef70: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+0005ef80: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
+0005ef90: 2069 332a 6e62 3320 202b 2069 322a 6e62   i3*nb3  + i2*nb
+0005efa0: 3220 202b 2069 312a 6e62 3120 202b 2069  2  + i1*nb1  + i
+0005efb0: 302a 6e62 3029 3b0a 0a20 2020 2020 2020  0*nb0);..       
+0005efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005efd0: 2063 6f6e 7374 2066 6c6f 6174 2064 7930   const float dy0
+0005efe0: 203d 2064 795b 305d 3b0a 2020 2020 2020   = dy[0];.      
+0005eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f000: 2020 636f 6e73 7420 666c 6f61 7420 6479    const float dy
+0005f010: 3120 3d20 6479 5b31 5d3b 0a0a 2020 2020  1 = dy[1];..    
+0005f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f030: 2020 2020 6478 5b30 5d20 3d20 2020 6479      dx[0] =   dy
+0005f040: 302a 636f 735f 7468 6574 6120 2b20 6479  0*cos_theta + dy
+0005f050: 312a 7369 6e5f 7468 6574 613b 0a20 2020  1*sin_theta;.   
 0005f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f070: 2020 2064 785b 305d 203d 2020 2064 7930     dx[0] =   dy0
-0005f080: 2a63 6f73 5f74 6865 7461 202b 2064 7931  *cos_theta + dy1
-0005f090: 2a73 696e 5f74 6865 7461 3b0a 2020 2020  *sin_theta;.    
+0005f070: 2020 2020 2064 785b 315d 203d 202d 2064       dx[1] = - d
+0005f080: 7930 2a73 696e 5f74 6865 7461 202b 2064  y0*sin_theta + d
+0005f090: 7931 2a63 6f73 5f74 6865 7461 3b0a 2020  y1*cos_theta;.  
 0005f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f0b0: 2020 2020 6478 5b31 5d20 3d20 2d20 6479      dx[1] = - dy
-0005f0c0: 302a 7369 6e5f 7468 6574 6120 2b20 6479  0*sin_theta + dy
-0005f0d0: 312a 636f 735f 7468 6574 613b 0a20 2020  1*cos_theta;.   
-0005f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f0f0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0005f100: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0005f0b0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0005f0c0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+0005f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f0e0: 2066 6f72 2028 696e 7436 345f 7420 6962   for (int64_t ib
+0005f0f0: 203d 2030 3b20 6962 203c 206e 6530 2f6e   = 0; ib < ne0/n
+0005f100: 5f64 696d 733b 202b 2b69 6229 207b 0a20  _dims; ++ib) {. 
 0005f110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f120: 666f 7220 2869 6e74 3634 5f74 2069 6220  for (int64_t ib 
-0005f130: 3d20 303b 2069 6220 3c20 6e65 302f 6e5f  = 0; ib < ne0/n_
-0005f140: 6469 6d73 3b20 2b2b 6962 2920 7b0a 2020  dims; ++ib) {.  
-0005f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f160: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-0005f170: 5f74 2069 6320 3d20 303b 2069 6320 3c20  _t ic = 0; ic < 
-0005f180: 6e5f 6469 6d73 3b20 6963 202b 3d20 3229  n_dims; ic += 2)
-0005f190: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0005f1a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0005f1b0: 6f6e 7374 2066 6c6f 6174 2063 6f73 5f74  onst float cos_t
-0005f1c0: 6865 7461 203d 2063 6f73 6628 7468 6574  heta = cosf(thet
-0005f1d0: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
+0005f120: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+0005f130: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
+0005f140: 206e 5f64 696d 733b 2069 6320 2b3d 2032   n_dims; ic += 2
+0005f150: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0005f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f170: 636f 6e73 7420 666c 6f61 7420 636f 735f  const float cos_
+0005f180: 7468 6574 6120 3d20 636f 7366 2874 6865  theta = cosf(the
+0005f190: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
+0005f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f1b0: 2063 6f6e 7374 2066 6c6f 6174 2073 696e   const float sin
+0005f1c0: 5f74 6865 7461 203d 2073 696e 6628 7468  _theta = sinf(th
+0005f1d0: 6574 6129 3b0a 0a20 2020 2020 2020 2020  eta);..         
 0005f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f1f0: 636f 6e73 7420 666c 6f61 7420 7369 6e5f  const float sin_
-0005f200: 7468 6574 6120 3d20 7369 6e66 2874 6865  theta = sinf(the
-0005f210: 7461 293b 0a0a 2020 2020 2020 2020 2020  ta);..          
-0005f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f230: 2020 7468 6574 6120 2a3d 2074 6865 7461    theta *= theta
-0005f240: 5f73 6361 6c65 3b0a 0a20 2020 2020 2020  _scale;..       
+0005f1f0: 2020 2074 6865 7461 202a 3d20 7468 6574     theta *= thet
+0005f200: 615f 7363 616c 653b 0a0a 2020 2020 2020  a_scale;..      
+0005f210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f220: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+0005f230: 345f 7420 6930 203d 2069 622a 6e5f 6469  4_t i0 = ib*n_di
+0005f240: 6d73 202b 2069 632f 323b 0a0a 2020 2020  ms + ic/2;..    
 0005f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f260: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-0005f270: 5f74 2069 3020 3d20 6962 2a6e 5f64 696d  _t i0 = ib*n_dim
-0005f280: 7320 2b20 6963 2f32 3b0a 0a20 2020 2020  s + ic/2;..     
-0005f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f2a0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0005f2b0: 6174 202a 2063 6f6e 7374 2064 7920 203d  at * const dy  =
-0005f2c0: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
-0005f2d0: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-0005f2e0: 2069 332a 6e62 3033 202b 2069 322a 6e62   i3*nb03 + i2*nb
-0005f2f0: 3032 202b 2069 312a 6e62 3031 202b 2069  02 + i1*nb01 + i
-0005f300: 302a 6e62 3030 293b 0a20 2020 2020 2020  0*nb00);.       
-0005f310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f320: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-0005f330: 202a 2020 2020 2020 2064 7820 203d 2028   *       dx  = (
-0005f340: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-0005f350: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
-0005f360: 332a 6e62 3320 202b 2069 322a 6e62 3220  3*nb3  + i2*nb2 
-0005f370: 202b 2069 312a 6e62 3120 202b 2069 302a   + i1*nb1  + i0*
-0005f380: 6e62 3029 3b0a 0a20 2020 2020 2020 2020  nb0);..         
-0005f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f3a0: 2020 2063 6f6e 7374 2066 6c6f 6174 2064     const float d
-0005f3b0: 7930 203d 2064 795b 305d 3b0a 2020 2020  y0 = dy[0];.    
+0005f260: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+0005f270: 6f61 7420 2a20 636f 6e73 7420 6479 2020  oat * const dy  
+0005f280: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
+0005f290: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+0005f2a0: 2b20 6933 2a6e 6230 3320 2b20 6932 2a6e  + i3*nb03 + i2*n
+0005f2b0: 6230 3220 2b20 6931 2a6e 6230 3120 2b20  b02 + i1*nb01 + 
+0005f2c0: 6930 2a6e 6230 3029 3b0a 2020 2020 2020  i0*nb00);.      
+0005f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f2e0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+0005f2f0: 7420 2a20 2020 2020 2020 6478 2020 3d20  t *       dx  = 
+0005f300: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
+0005f310: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
+0005f320: 6933 2a6e 6233 2020 2b20 6932 2a6e 6232  i3*nb3  + i2*nb2
+0005f330: 2020 2b20 6931 2a6e 6231 2020 2b20 6930    + i1*nb1  + i0
+0005f340: 2a6e 6230 293b 0a0a 2020 2020 2020 2020  *nb0);..        
+0005f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f360: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+0005f370: 6479 3020 3d20 6479 5b30 5d3b 0a20 2020  dy0 = dy[0];.   
+0005f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f390: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+0005f3a0: 6c6f 6174 2064 7931 203d 2064 795b 6e5f  loat dy1 = dy[n_
+0005f3b0: 6469 6d73 2f32 5d3b 0a0a 2020 2020 2020  dims/2];..      
 0005f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f3d0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0005f3e0: 6f61 7420 6479 3120 3d20 6479 5b6e 5f64  oat dy1 = dy[n_d
-0005f3f0: 696d 732f 325d 3b0a 0a20 2020 2020 2020  ims/2];..       
-0005f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f410: 2020 2020 2064 785b 305d 2020 2020 2020       dx[0]      
-0005f420: 2020 3d20 2020 6479 302a 636f 735f 7468    =   dy0*cos_th
-0005f430: 6574 6120 2b20 6479 312a 7369 6e5f 7468  eta + dy1*sin_th
-0005f440: 6574 613b 0a20 2020 2020 2020 2020 2020  eta;.           
-0005f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f460: 2064 785b 6e5f 6469 6d73 2f32 5d20 3d20   dx[n_dims/2] = 
-0005f470: 2d20 6479 302a 7369 6e5f 7468 6574 6120  - dy0*sin_theta 
-0005f480: 2b20 6479 312a 636f 735f 7468 6574 613b  + dy1*cos_theta;
-0005f490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005f4a0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0005f4b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0005f4c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005f4d0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0005f4e0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0005f4f0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-0005f500: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-0005f510: 7761 7264 5f72 6f70 655f 6261 636b 5f66  ward_rope_back_f
-0005f520: 3136 280a 2020 2020 2020 2020 636f 6e73  16(.        cons
-0005f530: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-0005f540: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-0005f550: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-0005f560: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0005f570: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-0005f580: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0005f590: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0005f5a0: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-0005f5b0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0005f5c0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-0005f5d0: 2061 7373 6572 7428 7372 6331 2d3e 7479   assert(src1->ty
-0005f5e0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-0005f5f0: 4933 3229 3b0a 2020 2020 6173 7365 7274  I32);.    assert
-0005f600: 2867 676d 6c5f 6e65 6c65 6d65 6e74 7328  (ggml_nelements(
-0005f610: 7372 6331 2920 3d3d 2033 293b 0a0a 2020  src1) == 3);..  
-0005f620: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-0005f630: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-0005f640: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
-0005f650: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-0005f660: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-0005f670: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-0005f680: 2020 7d0a 0a20 2020 202f 2f20 7920 3d20    }..    // y = 
-0005f690: 726f 7065 2878 2c20 7372 6331 290a 2020  rope(x, src1).  
-0005f6a0: 2020 2f2f 2064 7820 3d20 726f 7065 5f62    // dx = rope_b
-0005f6b0: 6163 6b28 6479 2c20 7372 6331 290a 2020  ack(dy, src1).  
-0005f6c0: 2020 2f2f 2073 7263 3020 6973 2064 792c    // src0 is dy,
-0005f6d0: 2073 7263 3120 636f 6e74 6169 6e73 206f   src1 contains o
-0005f6e0: 7074 696f 6e73 0a0a 2020 2020 636f 6e73  ptions..    cons
-0005f6f0: 7420 696e 7420 6e5f 7061 7374 203d 2028  t int n_past = (
-0005f700: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-0005f710: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
-0005f720: 636f 6e73 7420 696e 7420 6e5f 6469 6d73  const int n_dims
-0005f730: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
-0005f740: 7372 6331 2d3e 6461 7461 295b 315d 3b0a  src1->data)[1];.
-0005f750: 2020 2020 636f 6e73 7420 696e 7420 6d6f      const int mo
-0005f760: 6465 2020 203d 2028 2869 6e74 3332 5f74  de   = ((int32_t
-0005f770: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-0005f780: 325d 3b0a 0a20 2020 2061 7373 6572 7428  2];..    assert(
-0005f790: 6e5f 7061 7374 203e 3d20 3029 3b0a 0a20  n_past >= 0);.. 
-0005f7a0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0005f7b0: 6e62 3030 203d 2073 7263 302d 3e6e 625b  nb00 = src0->nb[
-0005f7c0: 305d 3b0a 2020 2020 636f 6e73 7420 7369  0];.    const si
-0005f7d0: 7a65 5f74 206e 6230 3120 3d20 7372 6330  ze_t nb01 = src0
-0005f7e0: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
-0005f7f0: 7374 2073 697a 655f 7420 6e62 3032 203d  st size_t nb02 =
-0005f800: 2073 7263 302d 3e6e 625b 325d 3b0a 2020   src0->nb[2];.  
-0005f810: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0005f820: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
-0005f830: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
-0005f840: 7436 345f 7420 6e65 3020 3d20 6473 742d  t64_t ne0 = dst-
-0005f850: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-0005f860: 7420 696e 7436 345f 7420 6e65 3120 3d20  t int64_t ne1 = 
-0005f870: 6473 742d 3e6e 655b 315d 3b0a 2020 2020  dst->ne[1];.    
-0005f880: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0005f890: 3220 3d20 6473 742d 3e6e 655b 325d 3b0a  2 = dst->ne[2];.
-0005f8a0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0005f8b0: 7420 6e65 3320 3d20 6473 742d 3e6e 655b  t ne3 = dst->ne[
-0005f8c0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2073  3];..    const s
-0005f8d0: 697a 655f 7420 6e62 3020 3d20 6473 742d  ize_t nb0 = dst-
-0005f8e0: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-0005f8f0: 7420 7369 7a65 5f74 206e 6231 203d 2064  t size_t nb1 = d
-0005f900: 7374 2d3e 6e62 5b31 5d3b 0a20 2020 2063  st->nb[1];.    c
-0005f910: 6f6e 7374 2073 697a 655f 7420 6e62 3220  onst size_t nb2 
-0005f920: 3d20 6473 742d 3e6e 625b 325d 3b0a 2020  = dst->nb[2];.  
-0005f930: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0005f940: 6233 203d 2064 7374 2d3e 6e62 5b33 5d3b  b3 = dst->nb[3];
-0005f950: 0a0a 0a20 2020 202f 2f70 7269 6e74 6628  ...    //printf(
-0005f960: 226e 6530 3a20 2564 2c20 6e65 313a 2025  "ne0: %d, ne1: %
-0005f970: 642c 206e 6532 3a20 2564 2c20 6e65 333a  d, ne2: %d, ne3:
-0005f980: 2025 645c 6e22 2c20 6e65 302c 206e 6531   %d\n", ne0, ne1
-0005f990: 2c20 6e65 322c 206e 6533 293b 0a20 2020  , ne2, ne3);.   
-0005f9a0: 202f 2f70 7269 6e74 6628 226e 5f70 6173   //printf("n_pas
-0005f9b0: 7420 3d20 2564 2c20 6e65 3220 3d20 2564  t = %d, ne2 = %d
-0005f9c0: 5c6e 222c 206e 5f70 6173 742c 206e 6532  \n", n_past, ne2
-0005f9d0: 293b 0a0a 2020 2020 6173 7365 7274 286e  );..    assert(n
-0005f9e0: 6230 203d 3d20 7369 7a65 6f66 2867 676d  b0 == sizeof(ggm
-0005f9f0: 6c5f 6670 3136 5f74 2929 3b0a 0a20 2020  l_fp16_t));..   
-0005fa00: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
-0005fa10: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
-0005fa20: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
-0005fa30: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
-0005fa40: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-0005fa50: 203d 2067 676d 6c5f 6e72 6f77 7328 6473   = ggml_nrows(ds
-0005fa60: 7429 3b0a 0a20 2020 202f 2f20 726f 7773  t);..    // rows
-0005fa70: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
-0005fa80: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
-0005fa90: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
-0005faa0: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
-0005fab0: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
-0005fac0: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-0005fad0: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
-0005fae0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-0005faf0: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
-0005fb00: 722c 206e 7229 3b0a 0a20 2020 202f 2f20  r, nr);..    // 
-0005fb10: 726f 7720 696e 6465 7820 7573 6564 2074  row index used t
-0005fb20: 6f20 6465 7465 726d 696e 6520 7768 6963  o determine whic
-0005fb30: 6820 7468 7265 6164 2074 6f20 7573 650a  h thread to use.
-0005fb40: 2020 2020 696e 7420 6972 203d 2030 3b0a      int ir = 0;.
-0005fb50: 0a20 2020 2063 6f6e 7374 2066 6c6f 6174  .    const float
-0005fb60: 2074 6865 7461 5f73 6361 6c65 203d 2070   theta_scale = p
-0005fb70: 6f77 6628 3130 3030 302e 302c 202d 322e  owf(10000.0, -2.
-0005fb80: 3066 2f6e 5f64 696d 7329 3b0a 0a20 2020  0f/n_dims);..   
-0005fb90: 2063 6f6e 7374 2062 6f6f 6c20 6973 5f6e   const bool is_n
-0005fba0: 656f 7820 3d20 6d6f 6465 2026 2032 3b0a  eox = mode & 2;.
-0005fbb0: 0a20 2020 2066 6f72 2028 696e 7436 345f  .    for (int64_
-0005fbc0: 7420 6933 203d 2030 3b20 6933 203c 206e  t i3 = 0; i3 < n
-0005fbd0: 6533 3b20 6933 2b2b 2920 7b0a 2020 2020  e3; i3++) {.    
-0005fbe0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0005fbf0: 2069 3220 3d20 2828 6d6f 6465 2026 2031   i2 = ((mode & 1
-0005fc00: 2920 3d3d 2030 203f 2030 203a 206e 5f70  ) == 0 ? 0 : n_p
-0005fc10: 6173 7429 3b20 6932 203c 206e 6532 3b20  ast); i2 < ne2; 
-0005fc20: 6932 2b2b 2920 7b0a 2020 2020 2020 2020  i2++) {.        
-0005fc30: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0005fc40: 7420 7020 3d20 2828 6d6f 6465 2026 2031  t p = ((mode & 1
-0005fc50: 2920 3d3d 2030 203f 206e 5f70 6173 7420  ) == 0 ? n_past 
-0005fc60: 2b20 6932 203a 2069 3229 3b0a 2020 2020  + i2 : i2);.    
-0005fc70: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0005fc80: 3634 5f74 2069 3120 3d20 303b 2069 3120  64_t i1 = 0; i1 
-0005fc90: 3c20 6e65 313b 2069 312b 2b29 207b 0a20  < ne1; i1++) {. 
-0005fca0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0005fcb0: 6620 2869 722b 2b20 3c20 6972 3029 2063  f (ir++ < ir0) c
-0005fcc0: 6f6e 7469 6e75 653b 0a20 2020 2020 2020  ontinue;.       
-0005fcd0: 2020 2020 2020 2020 2069 6620 2869 7220           if (ir 
-0005fce0: 2020 3e20 6972 3129 2062 7265 616b 3b0a    > ir1) break;.
-0005fcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005fd00: 2066 6c6f 6174 2074 6865 7461 203d 2028   float theta = (
-0005fd10: 666c 6f61 7429 703b 0a0a 2020 2020 2020  float)p;..      
-0005fd20: 2020 2020 2020 2020 2020 6966 2028 2169            if (!i
-0005fd30: 735f 6e65 6f78 2920 7b0a 2020 2020 2020  s_neox) {.      
-0005fd40: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0005fd50: 7220 2869 6e74 3634 5f74 2069 3020 3d20  r (int64_t i0 = 
-0005fd60: 303b 2069 3020 3c20 6e65 303b 2069 3020  0; i0 < ne0; i0 
-0005fd70: 2b3d 2032 2920 7b0a 2020 2020 2020 2020  += 2) {.        
-0005fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fd90: 636f 6e73 7420 666c 6f61 7420 636f 735f  const float cos_
-0005fda0: 7468 6574 6120 3d20 636f 7366 2874 6865  theta = cosf(the
-0005fdb0: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
-0005fdc0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0005fdd0: 7374 2066 6c6f 6174 2073 696e 5f74 6865  st float sin_the
-0005fde0: 7461 203d 2073 696e 6628 7468 6574 6129  ta = sinf(theta)
-0005fdf0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0005fe00: 2020 2020 2020 2020 2020 2074 6865 7461             theta
-0005fe10: 202a 3d20 7468 6574 615f 7363 616c 653b   *= theta_scale;
-0005fe20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0005fe30: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0005fe40: 6767 6d6c 5f66 7031 365f 7420 2a20 636f  ggml_fp16_t * co
-0005fe50: 6e73 7420 6479 2020 3d20 2867 676d 6c5f  nst dy  = (ggml_
-0005fe60: 6670 3136 5f74 202a 2928 2863 6861 7220  fp16_t *)((char 
-0005fe70: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-0005fe80: 6933 2a6e 6230 3320 2b20 6932 2a6e 6230  i3*nb03 + i2*nb0
-0005fe90: 3220 2b20 6931 2a6e 6230 3120 2b20 6930  2 + i1*nb01 + i0
-0005fea0: 2a6e 6230 3029 3b0a 2020 2020 2020 2020  *nb00);.        
-0005feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fec0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
-0005fed0: 7420 2a20 2020 2020 2020 6478 2020 3d20  t *       dx  = 
-0005fee0: 2867 676d 6c5f 6670 3136 5f74 202a 2928  (ggml_fp16_t *)(
-0005fef0: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
-0005ff00: 6174 6120 2b20 6933 2a6e 6233 2020 2b20  ata + i3*nb3  + 
-0005ff10: 6932 2a6e 6232 2020 2b20 6931 2a6e 6231  i2*nb2  + i1*nb1
-0005ff20: 2020 2b20 6930 2a6e 6230 293b 0a0a 2020    + i0*nb0);..  
-0005ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ff40: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-0005ff50: 7420 6479 3020 3d20 4747 4d4c 5f46 5031  t dy0 = GGML_FP1
-0005ff60: 365f 544f 5f46 5033 3228 6479 5b30 5d29  6_TO_FP32(dy[0])
-0005ff70: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0005ff80: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0005ff90: 666c 6f61 7420 6479 3120 3d20 4747 4d4c  float dy1 = GGML
-0005ffa0: 5f46 5031 365f 544f 5f46 5033 3228 6479  _FP16_TO_FP32(dy
-0005ffb0: 5b31 5d29 3b0a 0a20 2020 2020 2020 2020  [1]);..         
-0005ffc0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0005ffd0: 785b 305d 203d 2047 474d 4c5f 4650 3332  x[0] = GGML_FP32
-0005ffe0: 5f54 4f5f 4650 3136 2820 6479 302a 636f  _TO_FP16( dy0*co
-0005fff0: 735f 7468 6574 6120 2b20 6479 312a 7369  s_theta + dy1*si
-00060000: 6e5f 7468 6574 6129 3b0a 2020 2020 2020  n_theta);.      
-00060010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060020: 2020 6478 5b31 5d20 3d20 4747 4d4c 5f46    dx[1] = GGML_F
-00060030: 5033 325f 544f 5f46 5031 3628 2d64 7930  P32_TO_FP16(-dy0
-00060040: 2a73 696e 5f74 6865 7461 202b 2064 7931  *sin_theta + dy1
-00060050: 2a63 6f73 5f74 6865 7461 293b 0a20 2020  *cos_theta);.   
-00060060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060070: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00060080: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0005f3d0: 2020 2020 2020 6478 5b30 5d20 2020 2020        dx[0]     
+0005f3e0: 2020 203d 2020 2064 7930 2a63 6f73 5f74     =   dy0*cos_t
+0005f3f0: 6865 7461 202b 2064 7931 2a73 696e 5f74  heta + dy1*sin_t
+0005f400: 6865 7461 3b0a 2020 2020 2020 2020 2020  heta;.          
+0005f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f420: 2020 6478 5b6e 5f64 696d 732f 325d 203d    dx[n_dims/2] =
+0005f430: 202d 2064 7930 2a73 696e 5f74 6865 7461   - dy0*sin_theta
+0005f440: 202b 2064 7931 2a63 6f73 5f74 6865 7461   + dy1*cos_theta
+0005f450: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005f460: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0005f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f480: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0005f490: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0005f4a0: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
+0005f4b0: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+0005f4c0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+0005f4d0: 7277 6172 645f 726f 7065 5f62 6163 6b5f  rward_rope_back_
+0005f4e0: 6631 3628 0a20 2020 2020 2020 2063 6f6e  f16(.        con
+0005f4f0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+0005f500: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+0005f510: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0005f520: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0005f530: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+0005f540: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0005f550: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0005f560: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+0005f570: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0005f580: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+0005f590: 2020 6173 7365 7274 2873 7263 312d 3e74    assert(src1->t
+0005f5a0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+0005f5b0: 5f49 3332 293b 0a20 2020 2061 7373 6572  _I32);.    asser
+0005f5c0: 7428 6767 6d6c 5f6e 656c 656d 656e 7473  t(ggml_nelements
+0005f5d0: 2873 7263 3129 203d 3d20 3329 3b0a 0a20  (src1) == 3);.. 
+0005f5e0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+0005f5f0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+0005f600: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
+0005f610: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0005f620: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
+0005f630: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+0005f640: 2020 207d 0a0a 2020 2020 2f2f 2079 203d     }..    // y =
+0005f650: 2072 6f70 6528 782c 2073 7263 3129 0a20   rope(x, src1). 
+0005f660: 2020 202f 2f20 6478 203d 2072 6f70 655f     // dx = rope_
+0005f670: 6261 636b 2864 792c 2073 7263 3129 0a20  back(dy, src1). 
+0005f680: 2020 202f 2f20 7372 6330 2069 7320 6479     // src0 is dy
+0005f690: 2c20 7372 6331 2063 6f6e 7461 696e 7320  , src1 contains 
+0005f6a0: 6f70 7469 6f6e 730a 0a20 2020 2063 6f6e  options..    con
+0005f6b0: 7374 2069 6e74 206e 5f70 6173 7420 3d20  st int n_past = 
+0005f6c0: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+0005f6d0: 312d 3e64 6174 6129 5b30 5d3b 0a20 2020  1->data)[0];.   
+0005f6e0: 2063 6f6e 7374 2069 6e74 206e 5f64 696d   const int n_dim
+0005f6f0: 7320 3d20 2828 696e 7433 325f 7420 2a29  s = ((int32_t *)
+0005f700: 2073 7263 312d 3e64 6174 6129 5b31 5d3b   src1->data)[1];
+0005f710: 0a20 2020 2063 6f6e 7374 2069 6e74 206d  .    const int m
+0005f720: 6f64 6520 2020 3d20 2828 696e 7433 325f  ode   = ((int32_
+0005f730: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
+0005f740: 5b32 5d3b 0a0a 2020 2020 6173 7365 7274  [2];..    assert
+0005f750: 286e 5f70 6173 7420 3e3d 2030 293b 0a0a  (n_past >= 0);..
+0005f760: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0005f770: 206e 6230 3020 3d20 7372 6330 2d3e 6e62   nb00 = src0->nb
+0005f780: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
+0005f790: 697a 655f 7420 6e62 3031 203d 2073 7263  ize_t nb01 = src
+0005f7a0: 302d 3e6e 625b 315d 3b0a 2020 2020 636f  0->nb[1];.    co
+0005f7b0: 6e73 7420 7369 7a65 5f74 206e 6230 3220  nst size_t nb02 
+0005f7c0: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
+0005f7d0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0005f7e0: 6e62 3033 203d 2073 7263 302d 3e6e 625b  nb03 = src0->nb[
+0005f7f0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
+0005f800: 6e74 3634 5f74 206e 6530 203d 2064 7374  nt64_t ne0 = dst
+0005f810: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+0005f820: 7374 2069 6e74 3634 5f74 206e 6531 203d  st int64_t ne1 =
+0005f830: 2064 7374 2d3e 6e65 5b31 5d3b 0a20 2020   dst->ne[1];.   
+0005f840: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0005f850: 6532 203d 2064 7374 2d3e 6e65 5b32 5d3b  e2 = dst->ne[2];
+0005f860: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0005f870: 5f74 206e 6533 203d 2064 7374 2d3e 6e65  _t ne3 = dst->ne
+0005f880: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+0005f890: 7369 7a65 5f74 206e 6230 203d 2064 7374  size_t nb0 = dst
+0005f8a0: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+0005f8b0: 7374 2073 697a 655f 7420 6e62 3120 3d20  st size_t nb1 = 
+0005f8c0: 6473 742d 3e6e 625b 315d 3b0a 2020 2020  dst->nb[1];.    
+0005f8d0: 636f 6e73 7420 7369 7a65 5f74 206e 6232  const size_t nb2
+0005f8e0: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
+0005f8f0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0005f900: 6e62 3320 3d20 6473 742d 3e6e 625b 335d  nb3 = dst->nb[3]
+0005f910: 3b0a 0a0a 2020 2020 2f2f 7072 696e 7466  ;...    //printf
+0005f920: 2822 6e65 303a 2025 642c 206e 6531 3a20  ("ne0: %d, ne1: 
+0005f930: 2564 2c20 6e65 323a 2025 642c 206e 6533  %d, ne2: %d, ne3
+0005f940: 3a20 2564 5c6e 222c 206e 6530 2c20 6e65  : %d\n", ne0, ne
+0005f950: 312c 206e 6532 2c20 6e65 3329 3b0a 2020  1, ne2, ne3);.  
+0005f960: 2020 2f2f 7072 696e 7466 2822 6e5f 7061    //printf("n_pa
+0005f970: 7374 203d 2025 642c 206e 6532 203d 2025  st = %d, ne2 = %
+0005f980: 645c 6e22 2c20 6e5f 7061 7374 2c20 6e65  d\n", n_past, ne
+0005f990: 3229 3b0a 0a20 2020 2061 7373 6572 7428  2);..    assert(
+0005f9a0: 6e62 3020 3d3d 2073 697a 656f 6628 6767  nb0 == sizeof(gg
+0005f9b0: 6d6c 5f66 7031 365f 7429 293b 0a0a 2020  ml_fp16_t));..  
+0005f9c0: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
+0005f9d0: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
+0005f9e0: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
+0005f9f0: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
+0005fa00: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005fa10: 7220 3d20 6767 6d6c 5f6e 726f 7773 2864  r = ggml_nrows(d
+0005fa20: 7374 293b 0a0a 2020 2020 2f2f 2072 6f77  st);..    // row
+0005fa30: 7320 7065 7220 7468 7265 6164 0a20 2020  s per thread.   
+0005fa40: 2063 6f6e 7374 2069 6e74 2064 7220 3d20   const int dr = 
+0005fa50: 286e 7220 2b20 6e74 6820 2d20 3129 2f6e  (nr + nth - 1)/n
+0005fa60: 7468 3b0a 0a20 2020 202f 2f20 726f 7720  th;..    // row 
+0005fa70: 7261 6e67 6520 666f 7220 7468 6973 2074  range for this t
+0005fa80: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
+0005fa90: 696e 7420 6972 3020 3d20 6472 2a69 7468  int ir0 = dr*ith
+0005faa0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0005fab0: 6972 3120 3d20 4d49 4e28 6972 3020 2b20  ir1 = MIN(ir0 + 
+0005fac0: 6472 2c20 6e72 293b 0a0a 2020 2020 2f2f  dr, nr);..    //
+0005fad0: 2072 6f77 2069 6e64 6578 2075 7365 6420   row index used 
+0005fae0: 746f 2064 6574 6572 6d69 6e65 2077 6869  to determine whi
+0005faf0: 6368 2074 6872 6561 6420 746f 2075 7365  ch thread to use
+0005fb00: 0a20 2020 2069 6e74 2069 7220 3d20 303b  .    int ir = 0;
+0005fb10: 0a0a 2020 2020 636f 6e73 7420 666c 6f61  ..    const floa
+0005fb20: 7420 7468 6574 615f 7363 616c 6520 3d20  t theta_scale = 
+0005fb30: 706f 7766 2831 3030 3030 2e30 2c20 2d32  powf(10000.0, -2
+0005fb40: 2e30 662f 6e5f 6469 6d73 293b 0a0a 2020  .0f/n_dims);..  
+0005fb50: 2020 636f 6e73 7420 626f 6f6c 2069 735f    const bool is_
+0005fb60: 6e65 6f78 203d 206d 6f64 6520 2620 323b  neox = mode & 2;
+0005fb70: 0a0a 2020 2020 666f 7220 2869 6e74 3634  ..    for (int64
+0005fb80: 5f74 2069 3320 3d20 303b 2069 3320 3c20  _t i3 = 0; i3 < 
+0005fb90: 6e65 333b 2069 332b 2b29 207b 0a20 2020  ne3; i3++) {.   
+0005fba0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+0005fbb0: 7420 6932 203d 2028 286d 6f64 6520 2620  t i2 = ((mode & 
+0005fbc0: 3129 203d 3d20 3020 3f20 3020 3a20 6e5f  1) == 0 ? 0 : n_
+0005fbd0: 7061 7374 293b 2069 3220 3c20 6e65 323b  past); i2 < ne2;
+0005fbe0: 2069 322b 2b29 207b 0a20 2020 2020 2020   i2++) {.       
+0005fbf0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
+0005fc00: 5f74 2070 203d 2028 286d 6f64 6520 2620  _t p = ((mode & 
+0005fc10: 3129 203d 3d20 3020 3f20 6e5f 7061 7374  1) == 0 ? n_past
+0005fc20: 202b 2069 3220 3a20 6932 293b 0a20 2020   + i2 : i2);.   
+0005fc30: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0005fc40: 7436 345f 7420 6931 203d 2030 3b20 6931  t64_t i1 = 0; i1
+0005fc50: 203c 206e 6531 3b20 6931 2b2b 2920 7b0a   < ne1; i1++) {.
+0005fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fc70: 6966 2028 6972 2b2b 203c 2069 7230 2920  if (ir++ < ir0) 
+0005fc80: 636f 6e74 696e 7565 3b0a 2020 2020 2020  continue;.      
+0005fc90: 2020 2020 2020 2020 2020 6966 2028 6972            if (ir
+0005fca0: 2020 203e 2069 7231 2920 6272 6561 6b3b     > ir1) break;
+0005fcb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0005fcc0: 2020 666c 6f61 7420 7468 6574 6120 3d20    float theta = 
+0005fcd0: 2866 6c6f 6174 2970 3b0a 0a20 2020 2020  (float)p;..     
+0005fce0: 2020 2020 2020 2020 2020 2069 6620 2821             if (!
+0005fcf0: 6973 5f6e 656f 7829 207b 0a20 2020 2020  is_neox) {.     
+0005fd00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0005fd10: 6f72 2028 696e 7436 345f 7420 6930 203d  or (int64_t i0 =
+0005fd20: 2030 3b20 6930 203c 206e 6530 3b20 6930   0; i0 < ne0; i0
+0005fd30: 202b 3d20 3229 207b 0a20 2020 2020 2020   += 2) {.       
+0005fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fd50: 2063 6f6e 7374 2066 6c6f 6174 2063 6f73   const float cos
+0005fd60: 5f74 6865 7461 203d 2063 6f73 6628 7468  _theta = cosf(th
+0005fd70: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
+0005fd80: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0005fd90: 6e73 7420 666c 6f61 7420 7369 6e5f 7468  nst float sin_th
+0005fda0: 6574 6120 3d20 7369 6e66 2874 6865 7461  eta = sinf(theta
+0005fdb0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0005fdc0: 2020 2020 2020 2020 2020 2020 7468 6574              thet
+0005fdd0: 6120 2a3d 2074 6865 7461 5f73 6361 6c65  a *= theta_scale
+0005fde0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0005fdf0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0005fe00: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
+0005fe10: 6f6e 7374 2064 7920 203d 2028 6767 6d6c  onst dy  = (ggml
+0005fe20: 5f66 7031 365f 7420 2a29 2828 6368 6172  _fp16_t *)((char
+0005fe30: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+0005fe40: 2069 332a 6e62 3033 202b 2069 322a 6e62   i3*nb03 + i2*nb
+0005fe50: 3032 202b 2069 312a 6e62 3031 202b 2069  02 + i1*nb01 + i
+0005fe60: 302a 6e62 3030 293b 0a20 2020 2020 2020  0*nb00);.       
+0005fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fe80: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
+0005fe90: 5f74 202a 2020 2020 2020 2064 7820 203d  _t *       dx  =
+0005fea0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+0005feb0: 2828 6368 6172 202a 2920 2064 7374 2d3e  ((char *)  dst->
+0005fec0: 6461 7461 202b 2069 332a 6e62 3320 202b  data + i3*nb3  +
+0005fed0: 2069 322a 6e62 3220 202b 2069 312a 6e62   i2*nb2  + i1*nb
+0005fee0: 3120 202b 2069 302a 6e62 3029 3b0a 0a20  1  + i0*nb0);.. 
+0005fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ff00: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0005ff10: 6174 2064 7930 203d 2047 474d 4c5f 4650  at dy0 = GGML_FP
+0005ff20: 3136 5f54 4f5f 4650 3332 2864 795b 305d  16_TO_FP32(dy[0]
+0005ff30: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0005ff40: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0005ff50: 2066 6c6f 6174 2064 7931 203d 2047 474d   float dy1 = GGM
+0005ff60: 4c5f 4650 3136 5f54 4f5f 4650 3332 2864  L_FP16_TO_FP32(d
+0005ff70: 795b 315d 293b 0a0a 2020 2020 2020 2020  y[1]);..        
+0005ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ff90: 6478 5b30 5d20 3d20 4747 4d4c 5f46 5033  dx[0] = GGML_FP3
+0005ffa0: 325f 544f 5f46 5031 3628 2064 7930 2a63  2_TO_FP16( dy0*c
+0005ffb0: 6f73 5f74 6865 7461 202b 2064 7931 2a73  os_theta + dy1*s
+0005ffc0: 696e 5f74 6865 7461 293b 0a20 2020 2020  in_theta);.     
+0005ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ffe0: 2020 2064 785b 315d 203d 2047 474d 4c5f     dx[1] = GGML_
+0005fff0: 4650 3332 5f54 4f5f 4650 3136 282d 6479  FP32_TO_FP16(-dy
+00060000: 302a 7369 6e5f 7468 6574 6120 2b20 6479  0*sin_theta + dy
+00060010: 312a 636f 735f 7468 6574 6129 3b0a 2020  1*cos_theta);.  
+00060020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060030: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00060040: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+00060050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060060: 2066 6f72 2028 696e 7436 345f 7420 6962   for (int64_t ib
+00060070: 203d 2030 3b20 6962 203c 206e 6530 2f6e   = 0; ib < ne0/n
+00060080: 5f64 696d 733b 202b 2b69 6229 207b 0a20  _dims; ++ib) {. 
 00060090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000600a0: 666f 7220 2869 6e74 3634 5f74 2069 6220  for (int64_t ib 
-000600b0: 3d20 303b 2069 6220 3c20 6e65 302f 6e5f  = 0; ib < ne0/n_
-000600c0: 6469 6d73 3b20 2b2b 6962 2920 7b0a 2020  dims; ++ib) {.  
-000600d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000600e0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-000600f0: 5f74 2069 6320 3d20 303b 2069 6320 3c20  _t ic = 0; ic < 
-00060100: 6e5f 6469 6d73 3b20 6963 202b 3d20 3229  n_dims; ic += 2)
-00060110: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00060120: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00060130: 6f6e 7374 2066 6c6f 6174 2063 6f73 5f74  onst float cos_t
-00060140: 6865 7461 203d 2063 6f73 6628 7468 6574  heta = cosf(thet
-00060150: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
+000600a0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+000600b0: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
+000600c0: 206e 5f64 696d 733b 2069 6320 2b3d 2032   n_dims; ic += 2
+000600d0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000600e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000600f0: 636f 6e73 7420 666c 6f61 7420 636f 735f  const float cos_
+00060100: 7468 6574 6120 3d20 636f 7366 2874 6865  theta = cosf(the
+00060110: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
+00060120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060130: 2063 6f6e 7374 2066 6c6f 6174 2073 696e   const float sin
+00060140: 5f74 6865 7461 203d 2073 696e 6628 7468  _theta = sinf(th
+00060150: 6574 6129 3b0a 0a20 2020 2020 2020 2020  eta);..         
 00060160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060170: 636f 6e73 7420 666c 6f61 7420 7369 6e5f  const float sin_
-00060180: 7468 6574 6120 3d20 7369 6e66 2874 6865  theta = sinf(the
-00060190: 7461 293b 0a0a 2020 2020 2020 2020 2020  ta);..          
-000601a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000601b0: 2020 7468 6574 6120 2a3d 2074 6865 7461    theta *= theta
-000601c0: 5f73 6361 6c65 3b0a 0a20 2020 2020 2020  _scale;..       
+00060170: 2020 2074 6865 7461 202a 3d20 7468 6574     theta *= thet
+00060180: 615f 7363 616c 653b 0a0a 2020 2020 2020  a_scale;..      
+00060190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000601a0: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+000601b0: 345f 7420 6930 203d 2069 622a 6e5f 6469  4_t i0 = ib*n_di
+000601c0: 6d73 202b 2069 632f 323b 0a0a 2020 2020  ms + ic/2;..    
 000601d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000601e0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-000601f0: 5f74 2069 3020 3d20 6962 2a6e 5f64 696d  _t i0 = ib*n_dim
-00060200: 7320 2b20 6963 2f32 3b0a 0a20 2020 2020  s + ic/2;..     
-00060210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060220: 2020 2020 2020 2063 6f6e 7374 2067 676d         const ggm
-00060230: 6c5f 6670 3136 5f74 202a 2063 6f6e 7374  l_fp16_t * const
-00060240: 2064 7920 203d 2028 6767 6d6c 5f66 7031   dy  = (ggml_fp1
-00060250: 365f 7420 2a29 2828 6368 6172 202a 2920  6_t *)((char *) 
-00060260: 7372 6330 2d3e 6461 7461 202b 2069 332a  src0->data + i3*
-00060270: 6e62 3033 202b 2069 322a 6e62 3032 202b  nb03 + i2*nb02 +
-00060280: 2069 312a 6e62 3031 202b 2069 302a 6e62   i1*nb01 + i0*nb
-00060290: 3030 293b 0a20 2020 2020 2020 2020 2020  00);.           
-000602a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000602b0: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
-000602c0: 5f74 202a 2020 2020 2020 2064 7820 203d  _t *       dx  =
-000602d0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-000602e0: 2828 6368 6172 202a 2920 2064 7374 2d3e  ((char *)  dst->
-000602f0: 6461 7461 202b 2069 332a 6e62 3320 202b  data + i3*nb3  +
-00060300: 2069 322a 6e62 3220 202b 2069 312a 6e62   i2*nb2  + i1*nb
-00060310: 3120 202b 2069 302a 6e62 3029 3b0a 0a20  1  + i0*nb0);.. 
-00060320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060330: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00060340: 2066 6c6f 6174 2064 7930 203d 2047 474d   float dy0 = GGM
-00060350: 4c5f 4650 3136 5f54 4f5f 4650 3332 2864  L_FP16_TO_FP32(d
-00060360: 795b 305d 293b 0a20 2020 2020 2020 2020  y[0]);.         
-00060370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060380: 2020 2063 6f6e 7374 2066 6c6f 6174 2064     const float d
-00060390: 7931 203d 2047 474d 4c5f 4650 3136 5f54  y1 = GGML_FP16_T
-000603a0: 4f5f 4650 3332 2864 795b 6e5f 6469 6d73  O_FP32(dy[n_dims
-000603b0: 2f32 5d29 3b0a 0a20 2020 2020 2020 2020  /2]);..         
-000603c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000603d0: 2020 2064 785b 305d 2020 2020 2020 2020     dx[0]        
-000603e0: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
-000603f0: 5031 3628 2064 7930 2a63 6f73 5f74 6865  P16( dy0*cos_the
-00060400: 7461 202b 2064 7931 2a73 696e 5f74 6865  ta + dy1*sin_the
-00060410: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
-00060420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060430: 2064 785b 6e5f 6469 6d73 2f32 5d20 3d20   dx[n_dims/2] = 
-00060440: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
-00060450: 3628 2d64 7930 2a73 696e 5f74 6865 7461  6(-dy0*sin_theta
-00060460: 202b 2064 7931 2a63 6f73 5f74 6865 7461   + dy1*cos_theta
-00060470: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00060480: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00060490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000604a0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-000604b0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000604c0: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
-000604d0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
-000604e0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-000604f0: 6f72 7761 7264 5f72 6f70 655f 6261 636b  orward_rope_back
-00060500: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-00060510: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00060520: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00060530: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-00060540: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00060550: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-00060560: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00060570: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00060580: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
-00060590: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000605a0: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
-000605b0: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
-000605c0: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
-000605d0: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
-000605e0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000605f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00060600: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00060610: 6172 645f 726f 7065 5f62 6163 6b5f 6631  ard_rope_back_f1
-00060620: 3628 7061 7261 6d73 2c20 7372 6330 2c20  6(params, src0, 
-00060630: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
-00060640: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00060650: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00060660: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
-00060670: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00060680: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00060690: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000606a0: 726f 7065 5f62 6163 6b5f 6633 3228 7061  rope_back_f32(pa
-000606b0: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
-000606c0: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-000606d0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-000606e0: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
-000606f0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00060700: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00060710: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-00060720: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00060730: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
-00060740: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00060750: 7277 6172 645f 636f 6e76 5f31 645f 3173  rward_conv_1d_1s
-00060760: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00060770: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00060780: 7264 5f63 6f6e 765f 3164 5f31 735f 6631  rd_conv_1d_1s_f1
-00060790: 365f 6633 3228 0a20 2020 2020 2020 2063  6_f32(.        c
-000607a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000607b0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-000607c0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-000607d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000607e0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-000607f0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00060800: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00060810: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-00060820: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-00060830: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00060840: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-00060850: 5353 4552 5428 7372 6330 2d3e 7479 7065  SSERT(src0->type
-00060860: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
-00060870: 3629 3b0a 2020 2020 4747 4d4c 5f41 5353  6);.    GGML_ASS
-00060880: 4552 5428 7372 6331 2d3e 7479 7065 203d  ERT(src1->type =
-00060890: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
-000608a0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-000608b0: 5428 2064 7374 2d3e 7479 7065 203d 3d20  T( dst->type == 
-000608c0: 4747 4d4c 5f54 5950 455f 4633 3229 3b0a  GGML_TYPE_F32);.
-000608d0: 0a20 2020 2069 6e74 3634 5f74 2074 3020  .    int64_t t0 
-000608e0: 3d20 6767 6d6c 5f70 6572 665f 7469 6d65  = ggml_perf_time
-000608f0: 5f75 7328 293b 0a20 2020 2055 4e55 5345  _us();.    UNUSE
-00060900: 4428 7430 293b 0a0a 2020 2020 636f 6e73  D(t0);..    cons
-00060910: 7420 696e 7436 345f 7420 6e65 3030 203d  t int64_t ne00 =
-00060920: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
-00060930: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00060940: 6e65 3031 203d 2073 7263 302d 3e6e 655b  ne01 = src0->ne[
-00060950: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-00060960: 7436 345f 7420 6e65 3032 203d 2073 7263  t64_t ne02 = src
-00060970: 302d 3e6e 655b 325d 3b0a 2020 2020 2f2f  0->ne[2];.    //
-00060980: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00060990: 3033 203d 2073 7263 302d 3e6e 655b 335d  03 = src0->ne[3]
-000609a0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-000609b0: 3634 5f74 206e 6531 3020 3d20 7372 6331  64_t ne10 = src1
-000609c0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
-000609d0: 7374 2069 6e74 3634 5f74 206e 6531 3120  st int64_t ne11 
-000609e0: 3d20 7372 6331 2d3e 6e65 5b31 5d3b 0a20  = src1->ne[1];. 
-000609f0: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
-00060a00: 5f74 206e 6531 3220 3d20 7372 6331 2d3e  _t ne12 = src1->
-00060a10: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
-00060a20: 7374 2069 6e74 3634 5f74 206e 6531 3320  st int64_t ne13 
-00060a30: 3d20 7372 6331 2d3e 6e65 5b33 5d3b 0a0a  = src1->ne[3];..
-00060a40: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
-00060a50: 345f 7420 6e65 3020 203d 2064 7374 2d3e  4_t ne0  = dst->
-00060a60: 6e65 5b30 5d3b 0a20 2020 202f 2f63 6f6e  ne[0];.    //con
-00060a70: 7374 2069 6e74 3634 5f74 206e 6531 2020  st int64_t ne1  
-00060a80: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
-00060a90: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
-00060aa0: 7420 6e65 3220 203d 2064 7374 2d3e 6e65  t ne2  = dst->ne
-00060ab0: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
-00060ac0: 2069 6e74 3634 5f74 206e 6533 2020 3d20   int64_t ne3  = 
-00060ad0: 6473 742d 3e6e 655b 335d 3b0a 2020 2020  dst->ne[3];.    
-00060ae0: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
-00060af0: 6e65 2020 203d 206e 6530 2a6e 6531 2a6e  ne   = ne0*ne1*n
-00060b00: 6532 2a6e 6533 3b0a 0a20 2020 2063 6f6e  e2*ne3;..    con
-00060b10: 7374 2069 6e74 206e 6230 3020 3d20 7372  st int nb00 = sr
-00060b20: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
-00060b30: 6f6e 7374 2069 6e74 206e 6230 3120 3d20  onst int nb01 = 
-00060b40: 7372 6330 2d3e 6e62 5b31 5d3b 0a20 2020  src0->nb[1];.   
-00060b50: 2063 6f6e 7374 2069 6e74 206e 6230 3220   const int nb02 
-00060b60: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
-00060b70: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-00060b80: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
-00060b90: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
-00060ba0: 7420 6e62 3130 203d 2073 7263 312d 3e6e  t nb10 = src1->n
-00060bb0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-00060bc0: 696e 7420 6e62 3131 203d 2073 7263 312d  int nb11 = src1-
-00060bd0: 3e6e 625b 315d 3b0a 2020 2020 2f2f 636f  >nb[1];.    //co
-00060be0: 6e73 7420 696e 7420 6e62 3132 203d 2073  nst int nb12 = s
-00060bf0: 7263 312d 3e6e 625b 325d 3b0a 2020 2020  rc1->nb[2];.    
-00060c00: 2f2f 636f 6e73 7420 696e 7420 6e62 3133  //const int nb13
-00060c10: 203d 2073 7263 312d 3e6e 625b 335d 3b0a   = src1->nb[3];.
-00060c20: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00060c30: 206e 6230 2020 3d20 6473 742d 3e6e 625b   nb0  = dst->nb[
-00060c40: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-00060c50: 7420 6e62 3120 203d 2064 7374 2d3e 6e62  t nb1  = dst->nb
-00060c60: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
-00060c70: 2069 6e74 206e 6232 2020 3d20 6473 742d   int nb2  = dst-
-00060c80: 3e6e 625b 325d 3b0a 2020 2020 2f2f 636f  >nb[2];.    //co
-00060c90: 6e73 7420 696e 7420 6e62 3320 203d 2064  nst int nb3  = d
-00060ca0: 7374 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  st->nb[3];..    
-00060cb0: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
-00060cc0: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
-00060cd0: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
-00060ce0: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
-00060cf0: 2020 2063 6f6e 7374 2069 6e74 206e 6b20     const int nk 
-00060d00: 3d20 6e65 3030 3b0a 2020 2020 636f 6e73  = ne00;.    cons
-00060d10: 7420 696e 7420 6e68 203d 206e 6b2f 323b  t int nh = nk/2;
-00060d20: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00060d30: 6577 3020 3d20 6767 6d6c 5f75 7033 3228  ew0 = ggml_up32(
-00060d40: 6e65 3031 293b 0a0a 2020 2020 4747 4d4c  ne01);..    GGML
-00060d50: 5f41 5353 4552 5428 6e65 3030 2025 2032  _ASSERT(ne00 % 2
-00060d60: 203d 3d20 3129 3b20 2f2f 2054 4f44 4f3a   == 1); // TODO:
-00060d70: 2073 7570 706f 7274 2065 7665 6e20 6b65   support even ke
-00060d80: 726e 656c 2073 697a 6573 0a20 2020 2047  rnel sizes.    G
-00060d90: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
-00060da0: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
-00060db0: 7031 365f 7429 293b 0a20 2020 2047 474d  p16_t));.    GGM
-00060dc0: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
-00060dd0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-00060de0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-00060df0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00060e00: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
-00060e10: 2020 2020 2f2f 2054 4f44 4f3a 2066 6978      // TODO: fix
-00060e20: 2074 6869 7320 6d65 6d73 6574 2028 7773   this memset (ws
-00060e30: 697a 6520 6973 206f 7665 7265 7374 696d  ize is overestim
-00060e40: 6174 6564 290a 2020 2020 2020 2020 6d65  ated).        me
-00060e50: 6d73 6574 2870 6172 616d 732d 3e77 6461  mset(params->wda
-00060e60: 7461 2c20 302c 2070 6172 616d 732d 3e77  ta, 0, params->w
-00060e70: 7369 7a65 293b 0a0a 2020 2020 2020 2020  size);..        
-00060e80: 2f2f 2070 7265 7061 7265 206b 6572 6e65  // prepare kerne
-00060e90: 6c20 6461 7461 2028 7372 6330 290a 2020  l data (src0).  
-00060ea0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00060eb0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-00060ec0: 2a20 636f 6e73 7420 7764 6174 6120 3d20  * const wdata = 
-00060ed0: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
-00060ee0: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
-00060ef0: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
-00060f00: 666f 7220 2869 6e74 3634 5f74 2069 3032  for (int64_t i02
-00060f10: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
-00060f20: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
-00060f30: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00060f40: 696e 7436 345f 7420 6930 3120 3d20 303b  int64_t i01 = 0;
-00060f50: 2069 3031 203c 206e 6530 313b 2069 3031   i01 < ne01; i01
-00060f60: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00060f70: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00060f80: 6767 6d6c 5f66 7031 365f 7420 2a20 636f  ggml_fp16_t * co
-00060f90: 6e73 7420 7372 6320 3d20 2867 676d 6c5f  nst src = (ggml_
-00060fa0: 6670 3136 5f74 202a 2928 2863 6861 7220  fp16_t *)((char 
-00060fb0: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00060fc0: 6930 322a 6e62 3032 202b 2069 3031 2a6e  i02*nb02 + i01*n
-00060fd0: 6230 3129 3b0a 2020 2020 2020 2020 2020  b01);.          
-00060fe0: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
-00060ff0: 7031 365f 7420 2a20 6473 745f 6461 7461  p16_t * dst_data
-00061000: 203d 2077 6461 7461 202b 2069 3032 2a65   = wdata + i02*e
-00061010: 7730 2a6e 6530 303b 0a20 2020 2020 2020  w0*ne00;.       
-00061020: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00061030: 2028 696e 7436 345f 7420 6930 3020 3d20   (int64_t i00 = 
-00061040: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
-00061050: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
-00061060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061070: 6473 745f 6461 7461 5b69 3030 2a65 7730  dst_data[i00*ew0
-00061080: 202b 2069 3031 5d20 3d20 7372 635b 6930   + i01] = src[i0
-00061090: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
-000610a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000610b0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-000610c0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000610d0: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
-000610e0: 7072 6570 6172 6520 736f 7572 6365 2064  prepare source d
-000610f0: 6174 6120 2873 7263 3129 0a20 2020 2020  ata (src1).     
-00061100: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00061110: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
-00061120: 6f6e 7374 2077 6461 7461 203d 2028 6767  onst wdata = (gg
-00061130: 6d6c 5f66 7031 365f 7420 2a29 2070 6172  ml_fp16_t *) par
-00061140: 616d 732d 3e77 6461 7461 202b 206e 6530  ams->wdata + ne0
-00061150: 322a 6577 302a 6e65 3030 3b0a 0a20 2020  2*ew0*ne00;..   
-00061160: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00061170: 7436 345f 7420 6931 3120 3d20 303b 2069  t64_t i11 = 0; i
-00061180: 3131 203c 206e 6531 313b 2069 3131 2b2b  11 < ne11; i11++
-00061190: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000611a0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-000611b0: 2a20 636f 6e73 7420 7372 6320 3d20 2866  * const src = (f
-000611c0: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
-000611d0: 2073 7263 312d 3e64 6174 6120 2b20 6931   src1->data + i1
-000611e0: 312a 6e62 3131 293b 0a20 2020 2020 2020  1*nb11);.       
-000611f0: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
-00061200: 3136 5f74 202a 2064 7374 5f64 6174 6120  16_t * dst_data 
-00061210: 3d20 7764 6174 613b 0a20 2020 2020 2020  = wdata;.       
-00061220: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00061230: 7436 345f 7420 6931 3020 3d20 303b 2069  t64_t i10 = 0; i
-00061240: 3130 203c 206e 6531 303b 2069 3130 2b2b  10 < ne10; i10++
-00061250: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00061260: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
-00061270: 5b28 6931 3020 2b20 6e68 292a 6577 3020  [(i10 + nh)*ew0 
-00061280: 2b20 6931 315d 203d 2047 474d 4c5f 4650  + i11] = GGML_FP
-00061290: 3332 5f54 4f5f 4650 3136 2873 7263 5b69  32_TO_FP16(src[i
-000612a0: 3130 5d29 3b0a 2020 2020 2020 2020 2020  10]);.          
-000612b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000612c0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-000612d0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-000612e0: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-000612f0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00061300: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-00061310: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-00061320: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00061330: 202f 2f20 746f 7461 6c20 726f 7773 2069   // total rows i
-00061340: 6e20 6473 740a 2020 2020 636f 6e73 7420  n dst.    const 
-00061350: 696e 7420 6e72 203d 206e 6530 323b 0a0a  int nr = ne02;..
-00061360: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
-00061370: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-00061380: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
-00061390: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
-000613a0: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
-000613b0: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
-000613c0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
-000613d0: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
-000613e0: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
-000613f0: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
-00061400: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-00061410: 2069 3120 3d20 6972 303b 2069 3120 3c20   i1 = ir0; i1 < 
-00061420: 6972 313b 2069 312b 2b29 207b 0a20 2020  ir1; i1++) {.   
-00061430: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
-00061440: 5f64 6174 6120 3d20 2866 6c6f 6174 202a  _data = (float *
-00061450: 2928 2863 6861 7220 2a29 2064 7374 2d3e  )((char *) dst->
-00061460: 6461 7461 202b 2069 312a 6e62 3129 3b0a  data + i1*nb1);.
-00061470: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00061480: 3634 5f74 2069 3020 3d20 303b 2069 3020  64_t i0 = 0; i0 
-00061490: 3c20 6e65 3130 3b20 2b2b 6930 2920 7b0a  < ne10; ++i0) {.
-000614a0: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-000614b0: 6461 7461 5b69 305d 203d 2030 3b0a 2020  data[i0] = 0;.  
-000614c0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-000614d0: 6e74 206b 203d 202d 6e68 3b20 6b20 3c3d  nt k = -nh; k <=
-000614e0: 206e 683b 206b 2b2b 2920 7b0a 2020 2020   nh; k++) {.    
-000614f0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-00061500: 7420 7620 3d20 302e 3066 3b0a 2020 2020  t v = 0.0f;.    
-00061510: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00061520: 5f76 6563 5f64 6f74 5f66 3136 2865 7730  _vec_dot_f16(ew0
-00061530: 2c20 2676 2c0a 2020 2020 2020 2020 2020  , &v,.          
-00061540: 2020 2020 2020 2020 2020 2020 2020 2867                (g
-00061550: 676d 6c5f 6670 3136 5f74 202a 2920 7061  gml_fp16_t *) pa
-00061560: 7261 6d73 2d3e 7764 6174 6120 2b20 2020  rams->wdata +   
-00061570: 6931 2a65 7730 2a6e 6530 3020 2b20 2020  i1*ew0*ne00 +   
-00061580: 2020 2028 6e68 202b 206b 292a 6577 302c     (nh + k)*ew0,
-00061590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000615a0: 2020 2020 2020 2020 2028 6767 6d6c 5f66           (ggml_f
-000615b0: 7031 365f 7420 2a29 2070 6172 616d 732d  p16_t *) params-
-000615c0: 3e77 6461 7461 202b 206e 6530 322a 6577  >wdata + ne02*ew
-000615d0: 302a 6e65 3030 202b 2028 6930 202b 206e  0*ne00 + (i0 + n
-000615e0: 6820 2b20 6b29 2a65 7730 293b 0a0a 2020  h + k)*ew0);..  
-000615f0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-00061600: 745f 6461 7461 5b69 305d 202b 3d20 763b  t_data[i0] += v;
-00061610: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00061620: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
-00061630: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00061640: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00061650: 7264 5f63 6f6e 765f 3164 5f31 735f 6633  rd_conv_1d_1s_f3
-00061660: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
-00061670: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00061680: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-00061690: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-000616a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000616b0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-000616c0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-000616d0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000616e0: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
-000616f0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00061700: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-00061710: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-00061720: 5428 7372 6330 2d3e 7479 7065 203d 3d20  T(src0->type == 
-00061730: 4747 4d4c 5f54 5950 455f 4633 3229 3b0a  GGML_TYPE_F32);.
-00061740: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00061750: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
-00061760: 4d4c 5f54 5950 455f 4633 3229 3b0a 2020  ML_TYPE_F32);.  
-00061770: 2020 4747 4d4c 5f41 5353 4552 5428 2064    GGML_ASSERT( d
-00061780: 7374 2d3e 7479 7065 203d 3d20 4747 4d4c  st->type == GGML
-00061790: 5f54 5950 455f 4633 3229 3b0a 0a20 2020  _TYPE_F32);..   
-000617a0: 2069 6e74 3634 5f74 2074 3020 3d20 6767   int64_t t0 = gg
-000617b0: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
-000617c0: 293b 0a20 2020 2055 4e55 5345 4428 7430  );.    UNUSED(t0
-000617d0: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
-000617e0: 7436 345f 7420 6e65 3030 203d 2073 7263  t64_t ne00 = src
-000617f0: 302d 3e6e 655b 305d 3b0a 2020 2020 636f  0->ne[0];.    co
-00061800: 6e73 7420 696e 7436 345f 7420 6e65 3031  nst int64_t ne01
-00061810: 203d 2073 7263 302d 3e6e 655b 315d 3b0a   = src0->ne[1];.
-00061820: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00061830: 7420 6e65 3032 203d 2073 7263 302d 3e6e  t ne02 = src0->n
-00061840: 655b 325d 3b0a 2020 2020 2f2f 636f 6e73  e[2];.    //cons
-00061850: 7420 696e 7436 345f 7420 6e65 3033 203d  t int64_t ne03 =
-00061860: 2073 7263 302d 3e6e 655b 335d 3b0a 0a20   src0->ne[3];.. 
-00061870: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00061880: 206e 6531 3020 3d20 7372 6331 2d3e 6e65   ne10 = src1->ne
-00061890: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-000618a0: 6e74 3634 5f74 206e 6531 3120 3d20 7372  nt64_t ne11 = sr
-000618b0: 6331 2d3e 6e65 5b31 5d3b 0a20 2020 202f  c1->ne[1];.    /
-000618c0: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-000618d0: 6531 3220 3d20 7372 6331 2d3e 6e65 5b32  e12 = src1->ne[2
-000618e0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
-000618f0: 6e74 3634 5f74 206e 6531 3320 3d20 7372  nt64_t ne13 = sr
-00061900: 6331 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c1->ne[3];..    
-00061910: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
-00061920: 6e65 3020 203d 2064 7374 2d3e 6e65 5b30  ne0  = dst->ne[0
-00061930: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
-00061940: 6e74 3634 5f74 206e 6531 2020 3d20 6473  nt64_t ne1  = ds
-00061950: 742d 3e6e 655b 315d 3b0a 2020 2020 2f2f  t->ne[1];.    //
-00061960: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00061970: 3220 203d 2064 7374 2d3e 6e65 5b32 5d3b  2  = dst->ne[2];
-00061980: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00061990: 3634 5f74 206e 6533 2020 3d20 6473 742d  64_t ne3  = dst-
-000619a0: 3e6e 655b 335d 3b0a 2020 2020 2f2f 636f  >ne[3];.    //co
-000619b0: 6e73 7420 696e 7436 345f 7420 6e65 2020  nst int64_t ne  
-000619c0: 203d 206e 6530 2a6e 6531 2a6e 6532 2a6e   = ne0*ne1*ne2*n
-000619d0: 6533 3b0a 0a20 2020 2063 6f6e 7374 2069  e3;..    const i
-000619e0: 6e74 206e 6230 3020 3d20 7372 6330 2d3e  nt nb00 = src0->
-000619f0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-00061a00: 2069 6e74 206e 6230 3120 3d20 7372 6330   int nb01 = src0
-00061a10: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
-00061a20: 7374 2069 6e74 206e 6230 3220 3d20 7372  st int nb02 = sr
-00061a30: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 202f  c0->nb[2];.    /
-00061a40: 2f63 6f6e 7374 2069 6e74 206e 6230 3320  /const int nb03 
-00061a50: 3d20 7372 6330 2d3e 6e62 5b33 5d3b 0a0a  = src0->nb[3];..
-00061a60: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00061a70: 3130 203d 2073 7263 312d 3e6e 625b 305d  10 = src1->nb[0]
-00061a80: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00061a90: 6e62 3131 203d 2073 7263 312d 3e6e 625b  nb11 = src1->nb[
-00061aa0: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
-00061ab0: 696e 7420 6e62 3132 203d 2073 7263 312d  int nb12 = src1-
-00061ac0: 3e6e 625b 325d 3b0a 2020 2020 2f2f 636f  >nb[2];.    //co
-00061ad0: 6e73 7420 696e 7420 6e62 3133 203d 2073  nst int nb13 = s
-00061ae0: 7263 312d 3e6e 625b 335d 3b0a 0a20 2020  rc1->nb[3];..   
-00061af0: 202f 2f63 6f6e 7374 2069 6e74 206e 6230   //const int nb0
-00061b00: 2020 3d20 6473 742d 3e6e 625b 305d 3b0a    = dst->nb[0];.
-00061b10: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00061b20: 3120 203d 2064 7374 2d3e 6e62 5b31 5d3b  1  = dst->nb[1];
-00061b30: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00061b40: 206e 6232 2020 3d20 6473 742d 3e6e 625b   nb2  = dst->nb[
-00061b50: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-00061b60: 696e 7420 6e62 3320 203d 2064 7374 2d3e  int nb3  = dst->
-00061b70: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-00061b80: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
-00061b90: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
-00061ba0: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
-00061bb0: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
-00061bc0: 6f6e 7374 2069 6e74 206e 6b20 3d20 6e65  onst int nk = ne
-00061bd0: 3030 3b0a 2020 2020 636f 6e73 7420 696e  00;.    const in
-00061be0: 7420 6e68 203d 206e 6b2f 323b 0a0a 2020  t nh = nk/2;..  
-00061bf0: 2020 636f 6e73 7420 696e 7420 6577 3020    const int ew0 
-00061c00: 3d20 6767 6d6c 5f75 7033 3228 6e65 3031  = ggml_up32(ne01
-00061c10: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
-00061c20: 4552 5428 6e65 3030 2025 2032 203d 3d20  ERT(ne00 % 2 == 
-00061c30: 3129 3b20 2f2f 2054 4f44 4f3a 2073 7570  1); // TODO: sup
-00061c40: 706f 7274 2065 7665 6e20 6b65 726e 656c  port even kernel
-00061c50: 2073 697a 6573 0a20 2020 2047 474d 4c5f   sizes.    GGML_
-00061c60: 4153 5345 5254 286e 6230 3020 3d3d 2073  ASSERT(nb00 == s
-00061c70: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
-00061c80: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00061c90: 6231 3020 3d3d 2073 697a 656f 6628 666c  b10 == sizeof(fl
-00061ca0: 6f61 7429 293b 0a0a 2020 2020 6966 2028  oat));..    if (
-00061cb0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00061cc0: 4747 4d4c 5f54 4153 4b5f 494e 4954 2920  GGML_TASK_INIT) 
-00061cd0: 7b0a 2020 2020 2020 2020 2f2f 2054 4f44  {.        // TOD
-00061ce0: 4f3a 2066 6978 2074 6869 7320 6d65 6d73  O: fix this mems
-00061cf0: 6574 2028 7773 697a 6520 6973 206f 7665  et (wsize is ove
-00061d00: 7265 7374 696d 6174 6564 290a 2020 2020  restimated).    
-00061d10: 2020 2020 6d65 6d73 6574 2870 6172 616d      memset(param
-00061d20: 732d 3e77 6461 7461 2c20 302c 2070 6172  s->wdata, 0, par
-00061d30: 616d 732d 3e77 7369 7a65 293b 0a0a 2020  ams->wsize);..  
-00061d40: 2020 2020 2020 2f2f 2070 7265 7061 7265        // prepare
-00061d50: 206b 6572 6e65 6c20 6461 7461 2028 7372   kernel data (sr
-00061d60: 6330 290a 2020 2020 2020 2020 7b0a 2020  c0).        {.  
-00061d70: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-00061d80: 2a20 636f 6e73 7420 7764 6174 6120 3d20  * const wdata = 
-00061d90: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
-00061da0: 2d3e 7764 6174 6120 2b20 303b 0a0a 2020  ->wdata + 0;..  
-00061db0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00061dc0: 6e74 3634 5f74 2069 3032 203d 2030 3b20  nt64_t i02 = 0; 
-00061dd0: 6930 3220 3c20 6e65 3032 3b20 6930 322b  i02 < ne02; i02+
-00061de0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00061df0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00061e00: 7420 6930 3120 3d20 303b 2069 3031 203c  t i01 = 0; i01 <
-00061e10: 206e 6530 313b 2069 3031 2b2b 2920 7b0a   ne01; i01++) {.
-00061e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061e30: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00061e40: 2a20 636f 6e73 7420 7372 6320 3d20 2866  * const src = (f
-00061e50: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
-00061e60: 2073 7263 302d 3e64 6174 6120 2b20 6930   src0->data + i0
-00061e70: 322a 6e62 3032 202b 2069 3031 2a6e 6230  2*nb02 + i01*nb0
-00061e80: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-00061e90: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-00061ea0: 6473 745f 6461 7461 203d 2077 6461 7461  dst_data = wdata
-00061eb0: 202b 2069 3032 2a65 7730 2a6e 6530 303b   + i02*ew0*ne00;
+000601e0: 2020 2020 2020 2020 636f 6e73 7420 6767          const gg
+000601f0: 6d6c 5f66 7031 365f 7420 2a20 636f 6e73  ml_fp16_t * cons
+00060200: 7420 6479 2020 3d20 2867 676d 6c5f 6670  t dy  = (ggml_fp
+00060210: 3136 5f74 202a 2928 2863 6861 7220 2a29  16_t *)((char *)
+00060220: 2073 7263 302d 3e64 6174 6120 2b20 6933   src0->data + i3
+00060230: 2a6e 6230 3320 2b20 6932 2a6e 6230 3220  *nb03 + i2*nb02 
+00060240: 2b20 6931 2a6e 6230 3120 2b20 6930 2a6e  + i1*nb01 + i0*n
+00060250: 6230 3029 3b0a 2020 2020 2020 2020 2020  b00);.          
+00060260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060270: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
+00060280: 365f 7420 2a20 2020 2020 2020 6478 2020  6_t *       dx  
+00060290: 3d20 2867 676d 6c5f 6670 3136 5f74 202a  = (ggml_fp16_t *
+000602a0: 2928 2863 6861 7220 2a29 2020 6473 742d  )((char *)  dst-
+000602b0: 3e64 6174 6120 2b20 6933 2a6e 6233 2020  >data + i3*nb3  
+000602c0: 2b20 6932 2a6e 6232 2020 2b20 6931 2a6e  + i2*nb2  + i1*n
+000602d0: 6231 2020 2b20 6930 2a6e 6230 293b 0a0a  b1  + i0*nb0);..
+000602e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000602f0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00060300: 7420 666c 6f61 7420 6479 3020 3d20 4747  t float dy0 = GG
+00060310: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
+00060320: 6479 5b30 5d29 3b0a 2020 2020 2020 2020  dy[0]);.        
+00060330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060340: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00060350: 6479 3120 3d20 4747 4d4c 5f46 5031 365f  dy1 = GGML_FP16_
+00060360: 544f 5f46 5033 3228 6479 5b6e 5f64 696d  TO_FP32(dy[n_dim
+00060370: 732f 325d 293b 0a0a 2020 2020 2020 2020  s/2]);..        
+00060380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060390: 2020 2020 6478 5b30 5d20 2020 2020 2020      dx[0]       
+000603a0: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
+000603b0: 4650 3136 2820 6479 302a 636f 735f 7468  FP16( dy0*cos_th
+000603c0: 6574 6120 2b20 6479 312a 7369 6e5f 7468  eta + dy1*sin_th
+000603d0: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
+000603e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000603f0: 2020 6478 5b6e 5f64 696d 732f 325d 203d    dx[n_dims/2] =
+00060400: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
+00060410: 3136 282d 6479 302a 7369 6e5f 7468 6574  16(-dy0*sin_thet
+00060420: 6120 2b20 6479 312a 636f 735f 7468 6574  a + dy1*cos_thet
+00060430: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
+00060440: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00060450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060460: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00060470: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00060480: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
+00060490: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+000604a0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+000604b0: 666f 7277 6172 645f 726f 7065 5f62 6163  forward_rope_bac
+000604c0: 6b28 0a20 2020 2020 2020 2063 6f6e 7374  k(.        const
+000604d0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+000604e0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+000604f0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00060500: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00060510: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00060520: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00060530: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00060540: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
+00060550: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00060560: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+00060570: 7377 6974 6368 2028 7372 6330 2d3e 7479  switch (src0->ty
+00060580: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
+00060590: 7365 2047 474d 4c5f 5459 5045 5f46 3136  se GGML_TYPE_F16
+000605a0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000605b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000605c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000605d0: 7761 7264 5f72 6f70 655f 6261 636b 5f66  ward_rope_back_f
+000605e0: 3136 2870 6172 616d 732c 2073 7263 302c  16(params, src0,
+000605f0: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
+00060600: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00060610: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00060620: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
+00060630: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00060640: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00060650: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00060660: 5f72 6f70 655f 6261 636b 5f66 3332 2870  _rope_back_f32(p
+00060670: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
+00060680: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
+00060690: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000606a0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+000606b0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000606c0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+000606d0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+000606e0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000606f0: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
+00060700: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+00060710: 6f72 7761 7264 5f63 6f6e 765f 3164 5f31  orward_conv_1d_1
+00060720: 730a 0a73 7461 7469 6320 766f 6964 2067  s..static void g
+00060730: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00060740: 6172 645f 636f 6e76 5f31 645f 3173 5f66  ard_conv_1d_1s_f
+00060750: 3136 5f66 3332 280a 2020 2020 2020 2020  16_f32(.        
+00060760: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00060770: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+00060780: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+00060790: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000607a0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+000607b0: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
+000607c0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+000607d0: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
+000607e0: 2020 2020 2020 2020 2020 2073 7472 7563             struc
+000607f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00060800: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
+00060810: 4153 5345 5254 2873 7263 302d 3e74 7970  ASSERT(src0->typ
+00060820: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+00060830: 3136 293b 0a20 2020 2047 474d 4c5f 4153  16);.    GGML_AS
+00060840: 5345 5254 2873 7263 312d 3e74 7970 6520  SERT(src1->type 
+00060850: 3d3d 2047 474d 4c5f 5459 5045 5f46 3332  == GGML_TYPE_F32
+00060860: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00060870: 5254 2820 6473 742d 3e74 7970 6520 3d3d  RT( dst->type ==
+00060880: 2047 474d 4c5f 5459 5045 5f46 3332 293b   GGML_TYPE_F32);
+00060890: 0a0a 2020 2020 696e 7436 345f 7420 7430  ..    int64_t t0
+000608a0: 203d 2067 676d 6c5f 7065 7266 5f74 696d   = ggml_perf_tim
+000608b0: 655f 7573 2829 3b0a 2020 2020 554e 5553  e_us();.    UNUS
+000608c0: 4544 2874 3029 3b0a 0a20 2020 2063 6f6e  ED(t0);..    con
+000608d0: 7374 2069 6e74 3634 5f74 206e 6530 3020  st int64_t ne00 
+000608e0: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
+000608f0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00060900: 206e 6530 3120 3d20 7372 6330 2d3e 6e65   ne01 = src0->ne
+00060910: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+00060920: 6e74 3634 5f74 206e 6530 3220 3d20 7372  nt64_t ne02 = sr
+00060930: 6330 2d3e 6e65 5b32 5d3b 0a20 2020 202f  c0->ne[2];.    /
+00060940: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+00060950: 6530 3320 3d20 7372 6330 2d3e 6e65 5b33  e03 = src0->ne[3
+00060960: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00060970: 7436 345f 7420 6e65 3130 203d 2073 7263  t64_t ne10 = src
+00060980: 312d 3e6e 655b 305d 3b0a 2020 2020 636f  1->ne[0];.    co
+00060990: 6e73 7420 696e 7436 345f 7420 6e65 3131  nst int64_t ne11
+000609a0: 203d 2073 7263 312d 3e6e 655b 315d 3b0a   = src1->ne[1];.
+000609b0: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
+000609c0: 345f 7420 6e65 3132 203d 2073 7263 312d  4_t ne12 = src1-
+000609d0: 3e6e 655b 325d 3b0a 2020 2020 2f2f 636f  >ne[2];.    //co
+000609e0: 6e73 7420 696e 7436 345f 7420 6e65 3133  nst int64_t ne13
+000609f0: 203d 2073 7263 312d 3e6e 655b 335d 3b0a   = src1->ne[3];.
+00060a00: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+00060a10: 3634 5f74 206e 6530 2020 3d20 6473 742d  64_t ne0  = dst-
+00060a20: 3e6e 655b 305d 3b0a 2020 2020 2f2f 636f  >ne[0];.    //co
+00060a30: 6e73 7420 696e 7436 345f 7420 6e65 3120  nst int64_t ne1 
+00060a40: 203d 2064 7374 2d3e 6e65 5b31 5d3b 0a20   = dst->ne[1];. 
+00060a50: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
+00060a60: 5f74 206e 6532 2020 3d20 6473 742d 3e6e  _t ne2  = dst->n
+00060a70: 655b 325d 3b0a 2020 2020 2f2f 636f 6e73  e[2];.    //cons
+00060a80: 7420 696e 7436 345f 7420 6e65 3320 203d  t int64_t ne3  =
+00060a90: 2064 7374 2d3e 6e65 5b33 5d3b 0a20 2020   dst->ne[3];.   
+00060aa0: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
+00060ab0: 206e 6520 2020 3d20 6e65 302a 6e65 312a   ne   = ne0*ne1*
+00060ac0: 6e65 322a 6e65 333b 0a0a 2020 2020 636f  ne2*ne3;..    co
+00060ad0: 6e73 7420 696e 7420 6e62 3030 203d 2073  nst int nb00 = s
+00060ae0: 7263 302d 3e6e 625b 305d 3b0a 2020 2020  rc0->nb[0];.    
+00060af0: 636f 6e73 7420 696e 7420 6e62 3031 203d  const int nb01 =
+00060b00: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
+00060b10: 2020 636f 6e73 7420 696e 7420 6e62 3032    const int nb02
+00060b20: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
+00060b30: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+00060b40: 6e62 3033 203d 2073 7263 302d 3e6e 625b  nb03 = src0->nb[
+00060b50: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
+00060b60: 6e74 206e 6231 3020 3d20 7372 6331 2d3e  nt nb10 = src1->
+00060b70: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+00060b80: 2069 6e74 206e 6231 3120 3d20 7372 6331   int nb11 = src1
+00060b90: 2d3e 6e62 5b31 5d3b 0a20 2020 202f 2f63  ->nb[1];.    //c
+00060ba0: 6f6e 7374 2069 6e74 206e 6231 3220 3d20  onst int nb12 = 
+00060bb0: 7372 6331 2d3e 6e62 5b32 5d3b 0a20 2020  src1->nb[2];.   
+00060bc0: 202f 2f63 6f6e 7374 2069 6e74 206e 6231   //const int nb1
+00060bd0: 3320 3d20 7372 6331 2d3e 6e62 5b33 5d3b  3 = src1->nb[3];
+00060be0: 0a0a 2020 2020 2f2f 636f 6e73 7420 696e  ..    //const in
+00060bf0: 7420 6e62 3020 203d 2064 7374 2d3e 6e62  t nb0  = dst->nb
+00060c00: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00060c10: 6e74 206e 6231 2020 3d20 6473 742d 3e6e  nt nb1  = dst->n
+00060c20: 625b 315d 3b0a 2020 2020 2f2f 636f 6e73  b[1];.    //cons
+00060c30: 7420 696e 7420 6e62 3220 203d 2064 7374  t int nb2  = dst
+00060c40: 2d3e 6e62 5b32 5d3b 0a20 2020 202f 2f63  ->nb[2];.    //c
+00060c50: 6f6e 7374 2069 6e74 206e 6233 2020 3d20  onst int nb3  = 
+00060c60: 6473 742d 3e6e 625b 335d 3b0a 0a20 2020  dst->nb[3];..   
+00060c70: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
+00060c80: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
+00060c90: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
+00060ca0: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
+00060cb0: 2020 2020 636f 6e73 7420 696e 7420 6e6b      const int nk
+00060cc0: 203d 206e 6530 303b 0a20 2020 2063 6f6e   = ne00;.    con
+00060cd0: 7374 2069 6e74 206e 6820 3d20 6e6b 2f32  st int nh = nk/2
+00060ce0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00060cf0: 2065 7730 203d 2067 676d 6c5f 7570 3332   ew0 = ggml_up32
+00060d00: 286e 6530 3129 3b0a 0a20 2020 2047 474d  (ne01);..    GGM
+00060d10: 4c5f 4153 5345 5254 286e 6530 3020 2520  L_ASSERT(ne00 % 
+00060d20: 3220 3d3d 2031 293b 202f 2f20 544f 444f  2 == 1); // TODO
+00060d30: 3a20 7375 7070 6f72 7420 6576 656e 206b  : support even k
+00060d40: 6572 6e65 6c20 7369 7a65 730a 2020 2020  ernel sizes.    
+00060d50: 4747 4d4c 5f41 5353 4552 5428 6e62 3030  GGML_ASSERT(nb00
+00060d60: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
+00060d70: 6670 3136 5f74 2929 3b0a 2020 2020 4747  fp16_t));.    GG
+00060d80: 4d4c 5f41 5353 4552 5428 6e62 3130 203d  ML_ASSERT(nb10 =
+00060d90: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
+00060da0: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+00060db0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00060dc0: 5441 534b 5f49 4e49 5429 207b 0a20 2020  TASK_INIT) {.   
+00060dd0: 2020 2020 202f 2f20 544f 444f 3a20 6669       // TODO: fi
+00060de0: 7820 7468 6973 206d 656d 7365 7420 2877  x this memset (w
+00060df0: 7369 7a65 2069 7320 6f76 6572 6573 7469  size is overesti
+00060e00: 6d61 7465 6429 0a20 2020 2020 2020 206d  mated).        m
+00060e10: 656d 7365 7428 7061 7261 6d73 2d3e 7764  emset(params->wd
+00060e20: 6174 612c 2030 2c20 7061 7261 6d73 2d3e  ata, 0, params->
+00060e30: 7773 697a 6529 3b0a 0a20 2020 2020 2020  wsize);..       
+00060e40: 202f 2f20 7072 6570 6172 6520 6b65 726e   // prepare kern
+00060e50: 656c 2064 6174 6120 2873 7263 3029 0a20  el data (src0). 
+00060e60: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00060e70: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+00060e80: 202a 2063 6f6e 7374 2077 6461 7461 203d   * const wdata =
+00060e90: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+00060ea0: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+00060eb0: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
+00060ec0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+00060ed0: 3220 3d20 303b 2069 3032 203c 206e 6530  2 = 0; i02 < ne0
+00060ee0: 323b 2069 3032 2b2b 2920 7b0a 2020 2020  2; i02++) {.    
+00060ef0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00060f00: 2869 6e74 3634 5f74 2069 3031 203d 2030  (int64_t i01 = 0
+00060f10: 3b20 6930 3120 3c20 6e65 3031 3b20 6930  ; i01 < ne01; i0
+00060f20: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
+00060f30: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00060f40: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
+00060f50: 6f6e 7374 2073 7263 203d 2028 6767 6d6c  onst src = (ggml
+00060f60: 5f66 7031 365f 7420 2a29 2828 6368 6172  _fp16_t *)((char
+00060f70: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00060f80: 2069 3032 2a6e 6230 3220 2b20 6930 312a   i02*nb02 + i01*
+00060f90: 6e62 3031 293b 0a20 2020 2020 2020 2020  nb01);.         
+00060fa0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00060fb0: 6670 3136 5f74 202a 2064 7374 5f64 6174  fp16_t * dst_dat
+00060fc0: 6120 3d20 7764 6174 6120 2b20 6930 322a  a = wdata + i02*
+00060fd0: 6577 302a 6e65 3030 3b0a 2020 2020 2020  ew0*ne00;.      
+00060fe0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00060ff0: 7220 2869 6e74 3634 5f74 2069 3030 203d  r (int64_t i00 =
+00061000: 2030 3b20 6930 3020 3c20 6e65 3030 3b20   0; i00 < ne00; 
+00061010: 6930 302b 2b29 207b 0a20 2020 2020 2020  i00++) {.       
+00061020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061030: 2064 7374 5f64 6174 615b 6930 302a 6577   dst_data[i00*ew
+00061040: 3020 2b20 6930 315d 203d 2073 7263 5b69  0 + i01] = src[i
+00061050: 3030 5d3b 0a20 2020 2020 2020 2020 2020  00];.           
+00061060: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00061070: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00061080: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00061090: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
+000610a0: 2070 7265 7061 7265 2073 6f75 7263 6520   prepare source 
+000610b0: 6461 7461 2028 7372 6331 290a 2020 2020  data (src1).    
+000610c0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000610d0: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
+000610e0: 636f 6e73 7420 7764 6174 6120 3d20 2867  const wdata = (g
+000610f0: 676d 6c5f 6670 3136 5f74 202a 2920 7061  gml_fp16_t *) pa
+00061100: 7261 6d73 2d3e 7764 6174 6120 2b20 6e65  rams->wdata + ne
+00061110: 3032 2a65 7730 2a6e 6530 303b 0a0a 2020  02*ew0*ne00;..  
+00061120: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00061130: 6e74 3634 5f74 2069 3131 203d 2030 3b20  nt64_t i11 = 0; 
+00061140: 6931 3120 3c20 6e65 3131 3b20 6931 312b  i11 < ne11; i11+
+00061150: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00061160: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00061170: 202a 2063 6f6e 7374 2073 7263 203d 2028   * const src = (
+00061180: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
+00061190: 2920 7372 6331 2d3e 6461 7461 202b 2069  ) src1->data + i
+000611a0: 3131 2a6e 6231 3129 3b0a 2020 2020 2020  11*nb11);.      
+000611b0: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
+000611c0: 7031 365f 7420 2a20 6473 745f 6461 7461  p16_t * dst_data
+000611d0: 203d 2077 6461 7461 3b0a 2020 2020 2020   = wdata;.      
+000611e0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+000611f0: 6e74 3634 5f74 2069 3130 203d 2030 3b20  nt64_t i10 = 0; 
+00061200: 6931 3020 3c20 6e65 3130 3b20 6931 302b  i10 < ne10; i10+
+00061210: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00061220: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
+00061230: 615b 2869 3130 202b 206e 6829 2a65 7730  a[(i10 + nh)*ew0
+00061240: 202b 2069 3131 5d20 3d20 4747 4d4c 5f46   + i11] = GGML_F
+00061250: 5033 325f 544f 5f46 5031 3628 7372 635b  P32_TO_FP16(src[
+00061260: 6931 305d 293b 0a20 2020 2020 2020 2020  i10]);.         
+00061270: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00061280: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00061290: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000612a0: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
+000612b0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+000612c0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+000612d0: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+000612e0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+000612f0: 2020 2f2f 2074 6f74 616c 2072 6f77 7320    // total rows 
+00061300: 696e 2064 7374 0a20 2020 2063 6f6e 7374  in dst.    const
+00061310: 2069 6e74 206e 7220 3d20 6e65 3032 3b0a   int nr = ne02;.
+00061320: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
+00061330: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+00061340: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
+00061350: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
+00061360: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
+00061370: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
+00061380: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+00061390: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
+000613a0: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
+000613b0: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
+000613c0: 7229 3b0a 0a20 2020 2066 6f72 2028 696e  r);..    for (in
+000613d0: 7420 6931 203d 2069 7230 3b20 6931 203c  t i1 = ir0; i1 <
+000613e0: 2069 7231 3b20 6931 2b2b 2920 7b0a 2020   ir1; i1++) {.  
+000613f0: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
+00061400: 745f 6461 7461 203d 2028 666c 6f61 7420  t_data = (float 
+00061410: 2a29 2828 6368 6172 202a 2920 6473 742d  *)((char *) dst-
+00061420: 3e64 6174 6120 2b20 6931 2a6e 6231 293b  >data + i1*nb1);
+00061430: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00061440: 7436 345f 7420 6930 203d 2030 3b20 6930  t64_t i0 = 0; i0
+00061450: 203c 206e 6531 303b 202b 2b69 3029 207b   < ne10; ++i0) {
+00061460: 0a20 2020 2020 2020 2020 2020 2064 7374  .            dst
+00061470: 5f64 6174 615b 6930 5d20 3d20 303b 0a20  _data[i0] = 0;. 
+00061480: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00061490: 696e 7420 6b20 3d20 2d6e 683b 206b 203c  int k = -nh; k <
+000614a0: 3d20 6e68 3b20 6b2b 2b29 207b 0a20 2020  = nh; k++) {.   
+000614b0: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+000614c0: 6174 2076 203d 2030 2e30 663b 0a20 2020  at v = 0.0f;.   
+000614d0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000614e0: 6c5f 7665 635f 646f 745f 6631 3628 6577  l_vec_dot_f16(ew
+000614f0: 302c 2026 762c 0a20 2020 2020 2020 2020  0, &v,.         
+00061500: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00061510: 6767 6d6c 5f66 7031 365f 7420 2a29 2070  ggml_fp16_t *) p
+00061520: 6172 616d 732d 3e77 6461 7461 202b 2020  arams->wdata +  
+00061530: 2069 312a 6577 302a 6e65 3030 202b 2020   i1*ew0*ne00 +  
+00061540: 2020 2020 286e 6820 2b20 6b29 2a65 7730      (nh + k)*ew0
+00061550: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00061560: 2020 2020 2020 2020 2020 2867 676d 6c5f            (ggml_
+00061570: 6670 3136 5f74 202a 2920 7061 7261 6d73  fp16_t *) params
+00061580: 2d3e 7764 6174 6120 2b20 6e65 3032 2a65  ->wdata + ne02*e
+00061590: 7730 2a6e 6530 3020 2b20 2869 3020 2b20  w0*ne00 + (i0 + 
+000615a0: 6e68 202b 206b 292a 6577 3029 3b0a 0a20  nh + k)*ew0);.. 
+000615b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000615c0: 7374 5f64 6174 615b 6930 5d20 2b3d 2076  st_data[i0] += v
+000615d0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+000615e0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+000615f0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+00061600: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00061610: 6172 645f 636f 6e76 5f31 645f 3173 5f66  ard_conv_1d_1s_f
+00061620: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
+00061630: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+00061640: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+00061650: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+00061660: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00061670: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+00061680: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00061690: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000616a0: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
+000616b0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+000616c0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+000616d0: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
+000616e0: 5254 2873 7263 302d 3e74 7970 6520 3d3d  RT(src0->type ==
+000616f0: 2047 474d 4c5f 5459 5045 5f46 3332 293b   GGML_TYPE_F32);
+00061700: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00061710: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
+00061720: 474d 4c5f 5459 5045 5f46 3332 293b 0a20  GML_TYPE_F32);. 
+00061730: 2020 2047 474d 4c5f 4153 5345 5254 2820     GGML_ASSERT( 
+00061740: 6473 742d 3e74 7970 6520 3d3d 2047 474d  dst->type == GGM
+00061750: 4c5f 5459 5045 5f46 3332 293b 0a0a 2020  L_TYPE_F32);..  
+00061760: 2020 696e 7436 345f 7420 7430 203d 2067    int64_t t0 = g
+00061770: 676d 6c5f 7065 7266 5f74 696d 655f 7573  gml_perf_time_us
+00061780: 2829 3b0a 2020 2020 554e 5553 4544 2874  ();.    UNUSED(t
+00061790: 3029 3b0a 0a20 2020 2063 6f6e 7374 2069  0);..    const i
+000617a0: 6e74 3634 5f74 206e 6530 3020 3d20 7372  nt64_t ne00 = sr
+000617b0: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
+000617c0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+000617d0: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
+000617e0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+000617f0: 5f74 206e 6530 3220 3d20 7372 6330 2d3e  _t ne02 = src0->
+00061800: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
+00061810: 7374 2069 6e74 3634 5f74 206e 6530 3320  st int64_t ne03 
+00061820: 3d20 7372 6330 2d3e 6e65 5b33 5d3b 0a0a  = src0->ne[3];..
+00061830: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00061840: 7420 6e65 3130 203d 2073 7263 312d 3e6e  t ne10 = src1->n
+00061850: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+00061860: 696e 7436 345f 7420 6e65 3131 203d 2073  int64_t ne11 = s
+00061870: 7263 312d 3e6e 655b 315d 3b0a 2020 2020  rc1->ne[1];.    
+00061880: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
+00061890: 6e65 3132 203d 2073 7263 312d 3e6e 655b  ne12 = src1->ne[
+000618a0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
+000618b0: 696e 7436 345f 7420 6e65 3133 203d 2073  int64_t ne13 = s
+000618c0: 7263 312d 3e6e 655b 335d 3b0a 0a20 2020  rc1->ne[3];..   
+000618d0: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
+000618e0: 206e 6530 2020 3d20 6473 742d 3e6e 655b   ne0  = dst->ne[
+000618f0: 305d 3b0a 2020 2020 2f2f 636f 6e73 7420  0];.    //const 
+00061900: 696e 7436 345f 7420 6e65 3120 203d 2064  int64_t ne1  = d
+00061910: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 202f  st->ne[1];.    /
+00061920: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+00061930: 6532 2020 3d20 6473 742d 3e6e 655b 325d  e2  = dst->ne[2]
+00061940: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00061950: 7436 345f 7420 6e65 3320 203d 2064 7374  t64_t ne3  = dst
+00061960: 2d3e 6e65 5b33 5d3b 0a20 2020 202f 2f63  ->ne[3];.    //c
+00061970: 6f6e 7374 2069 6e74 3634 5f74 206e 6520  onst int64_t ne 
+00061980: 2020 3d20 6e65 302a 6e65 312a 6e65 322a    = ne0*ne1*ne2*
+00061990: 6e65 333b 0a0a 2020 2020 636f 6e73 7420  ne3;..    const 
+000619a0: 696e 7420 6e62 3030 203d 2073 7263 302d  int nb00 = src0-
+000619b0: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
+000619c0: 7420 696e 7420 6e62 3031 203d 2073 7263  t int nb01 = src
+000619d0: 302d 3e6e 625b 315d 3b0a 2020 2020 636f  0->nb[1];.    co
+000619e0: 6e73 7420 696e 7420 6e62 3032 203d 2073  nst int nb02 = s
+000619f0: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
+00061a00: 2f2f 636f 6e73 7420 696e 7420 6e62 3033  //const int nb03
+00061a10: 203d 2073 7263 302d 3e6e 625b 335d 3b0a   = src0->nb[3];.
+00061a20: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00061a30: 6231 3020 3d20 7372 6331 2d3e 6e62 5b30  b10 = src1->nb[0
+00061a40: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00061a50: 206e 6231 3120 3d20 7372 6331 2d3e 6e62   nb11 = src1->nb
+00061a60: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
+00061a70: 2069 6e74 206e 6231 3220 3d20 7372 6331   int nb12 = src1
+00061a80: 2d3e 6e62 5b32 5d3b 0a20 2020 202f 2f63  ->nb[2];.    //c
+00061a90: 6f6e 7374 2069 6e74 206e 6231 3320 3d20  onst int nb13 = 
+00061aa0: 7372 6331 2d3e 6e62 5b33 5d3b 0a0a 2020  src1->nb[3];..  
+00061ab0: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
+00061ac0: 3020 203d 2064 7374 2d3e 6e62 5b30 5d3b  0  = dst->nb[0];
+00061ad0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00061ae0: 6231 2020 3d20 6473 742d 3e6e 625b 315d  b1  = dst->nb[1]
+00061af0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00061b00: 7420 6e62 3220 203d 2064 7374 2d3e 6e62  t nb2  = dst->nb
+00061b10: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
+00061b20: 2069 6e74 206e 6233 2020 3d20 6473 742d   int nb3  = dst-
+00061b30: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
+00061b40: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00061b50: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+00061b60: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+00061b70: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+00061b80: 636f 6e73 7420 696e 7420 6e6b 203d 206e  const int nk = n
+00061b90: 6530 303b 0a20 2020 2063 6f6e 7374 2069  e00;.    const i
+00061ba0: 6e74 206e 6820 3d20 6e6b 2f32 3b0a 0a20  nt nh = nk/2;.. 
+00061bb0: 2020 2063 6f6e 7374 2069 6e74 2065 7730     const int ew0
+00061bc0: 203d 2067 676d 6c5f 7570 3332 286e 6530   = ggml_up32(ne0
+00061bd0: 3129 3b0a 0a20 2020 2047 474d 4c5f 4153  1);..    GGML_AS
+00061be0: 5345 5254 286e 6530 3020 2520 3220 3d3d  SERT(ne00 % 2 ==
+00061bf0: 2031 293b 202f 2f20 544f 444f 3a20 7375   1); // TODO: su
+00061c00: 7070 6f72 7420 6576 656e 206b 6572 6e65  pport even kerne
+00061c10: 6c20 7369 7a65 730a 2020 2020 4747 4d4c  l sizes.    GGML
+00061c20: 5f41 5353 4552 5428 6e62 3030 203d 3d20  _ASSERT(nb00 == 
+00061c30: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+00061c40: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00061c50: 6e62 3130 203d 3d20 7369 7a65 6f66 2866  nb10 == sizeof(f
+00061c60: 6c6f 6174 2929 3b0a 0a20 2020 2069 6620  loat));..    if 
+00061c70: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00061c80: 2047 474d 4c5f 5441 534b 5f49 4e49 5429   GGML_TASK_INIT)
+00061c90: 207b 0a20 2020 2020 2020 202f 2f20 544f   {.        // TO
+00061ca0: 444f 3a20 6669 7820 7468 6973 206d 656d  DO: fix this mem
+00061cb0: 7365 7420 2877 7369 7a65 2069 7320 6f76  set (wsize is ov
+00061cc0: 6572 6573 7469 6d61 7465 6429 0a20 2020  erestimated).   
+00061cd0: 2020 2020 206d 656d 7365 7428 7061 7261       memset(para
+00061ce0: 6d73 2d3e 7764 6174 612c 2030 2c20 7061  ms->wdata, 0, pa
+00061cf0: 7261 6d73 2d3e 7773 697a 6529 3b0a 0a20  rams->wsize);.. 
+00061d00: 2020 2020 2020 202f 2f20 7072 6570 6172         // prepar
+00061d10: 6520 6b65 726e 656c 2064 6174 6120 2873  e kernel data (s
+00061d20: 7263 3029 0a20 2020 2020 2020 207b 0a20  rc0).        {. 
+00061d30: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+00061d40: 202a 2063 6f6e 7374 2077 6461 7461 203d   * const wdata =
+00061d50: 2028 666c 6f61 7420 2a29 2070 6172 616d   (float *) param
+00061d60: 732d 3e77 6461 7461 202b 2030 3b0a 0a20  s->wdata + 0;.. 
+00061d70: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00061d80: 696e 7436 345f 7420 6930 3220 3d20 303b  int64_t i02 = 0;
+00061d90: 2069 3032 203c 206e 6530 323b 2069 3032   i02 < ne02; i02
+00061da0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00061db0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+00061dc0: 5f74 2069 3031 203d 2030 3b20 6930 3120  _t i01 = 0; i01 
+00061dd0: 3c20 6e65 3031 3b20 6930 312b 2b29 207b  < ne01; i01++) {
+00061de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00061df0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00061e00: 202a 2063 6f6e 7374 2073 7263 203d 2028   * const src = (
+00061e10: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
+00061e20: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
+00061e30: 3032 2a6e 6230 3220 2b20 6930 312a 6e62  02*nb02 + i01*nb
+00061e40: 3031 293b 0a20 2020 2020 2020 2020 2020  01);.           
+00061e50: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+00061e60: 2064 7374 5f64 6174 6120 3d20 7764 6174   dst_data = wdat
+00061e70: 6120 2b20 6930 322a 6577 302a 6e65 3030  a + i02*ew0*ne00
+00061e80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00061e90: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+00061ea0: 5f74 2069 3030 203d 2030 3b20 6930 3020  _t i00 = 0; i00 
+00061eb0: 3c20 6e65 3030 3b20 6930 302b 2b29 207b  < ne00; i00++) {
 00061ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00061ed0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00061ee0: 7420 6930 3020 3d20 303b 2069 3030 203c  t i00 = 0; i00 <
-00061ef0: 206e 6530 303b 2069 3030 2b2b 2920 7b0a   ne00; i00++) {.
+00061ed0: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
+00061ee0: 615b 6930 302a 6577 3020 2b20 6930 315d  a[i00*ew0 + i01]
+00061ef0: 203d 2073 7263 5b69 3030 5d3b 0a20 2020   = src[i00];.   
 00061f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061f10: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
-00061f20: 5b69 3030 2a65 7730 202b 2069 3031 5d20  [i00*ew0 + i01] 
-00061f30: 3d20 7372 635b 6930 305d 3b0a 2020 2020  = src[i00];.    
-00061f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061f50: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00061f60: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00061f70: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-00061f80: 2020 2020 202f 2f20 7072 6570 6172 6520       // prepare 
-00061f90: 736f 7572 6365 2064 6174 6120 2873 7263  source data (src
-00061fa0: 3129 0a20 2020 2020 2020 207b 0a20 2020  1).        {.   
-00061fb0: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-00061fc0: 2063 6f6e 7374 2077 6461 7461 203d 2028   const wdata = (
-00061fd0: 666c 6f61 7420 2a29 2070 6172 616d 732d  float *) params-
-00061fe0: 3e77 6461 7461 202b 206e 6530 322a 6577  >wdata + ne02*ew
-00061ff0: 302a 6e65 3030 3b0a 0a20 2020 2020 2020  0*ne00;..       
-00062000: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00062010: 7420 6931 3120 3d20 303b 2069 3131 203c  t i11 = 0; i11 <
-00062020: 206e 6531 313b 2069 3131 2b2b 2920 7b0a   ne11; i11++) {.
-00062030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062040: 636f 6e73 7420 666c 6f61 7420 2a20 636f  const float * co
-00062050: 6e73 7420 7372 6320 3d20 2866 6c6f 6174  nst src = (float
-00062060: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
-00062070: 312d 3e64 6174 6120 2b20 6931 312a 6e62  1->data + i11*nb
-00062080: 3131 293b 0a20 2020 2020 2020 2020 2020  11);.           
-00062090: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
-000620a0: 5f64 6174 6120 3d20 7764 6174 613b 0a20  _data = wdata;. 
-000620b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000620c0: 6f72 2028 696e 7436 345f 7420 6931 3020  or (int64_t i10 
-000620d0: 3d20 303b 2069 3130 203c 206e 6531 303b  = 0; i10 < ne10;
-000620e0: 2069 3130 2b2b 2920 7b0a 2020 2020 2020   i10++) {.      
-000620f0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-00062100: 745f 6461 7461 5b28 6931 3020 2b20 6e68  t_data[(i10 + nh
-00062110: 292a 6577 3020 2b20 6931 315d 203d 2073  )*ew0 + i11] = s
-00062120: 7263 5b69 3130 5d3b 0a20 2020 2020 2020  rc[i10];.       
-00062130: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00062140: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00062150: 207d 0a0a 2020 2020 2020 2020 7265 7475   }..        retu
-00062160: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
-00062170: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-00062180: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-00062190: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-000621a0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-000621b0: 2020 2020 2f2f 2074 6f74 616c 2072 6f77      // total row
-000621c0: 7320 696e 2064 7374 0a20 2020 2063 6f6e  s in dst.    con
-000621d0: 7374 2069 6e74 206e 7220 3d20 6e65 3032  st int nr = ne02
-000621e0: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
-000621f0: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
-00062200: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
-00062210: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
-00062220: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
-00062230: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
-00062240: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-00062250: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
-00062260: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
-00062270: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
-00062280: 206e 7229 3b0a 0a20 2020 2066 6f72 2028   nr);..    for (
-00062290: 696e 7420 6931 203d 2069 7230 3b20 6931  int i1 = ir0; i1
-000622a0: 203c 2069 7231 3b20 6931 2b2b 2920 7b0a   < ir1; i1++) {.
-000622b0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-000622c0: 6473 745f 6461 7461 203d 2028 666c 6f61  dst_data = (floa
-000622d0: 7420 2a29 2828 6368 6172 202a 2920 6473  t *)((char *) ds
-000622e0: 742d 3e64 6174 6120 2b20 6931 2a6e 6231  t->data + i1*nb1
-000622f0: 293b 0a20 2020 2020 2020 2066 6f72 2028  );.        for (
-00062300: 696e 7436 345f 7420 6930 203d 2030 3b20  int64_t i0 = 0; 
-00062310: 6930 203c 206e 6531 303b 202b 2b69 3029  i0 < ne10; ++i0)
-00062320: 207b 0a20 2020 2020 2020 2020 2020 2064   {.            d
-00062330: 7374 5f64 6174 615b 6930 5d20 3d20 303b  st_data[i0] = 0;
-00062340: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00062350: 2028 696e 7420 6b20 3d20 2d6e 683b 206b   (int k = -nh; k
-00062360: 203c 3d20 6e68 3b20 6b2b 2b29 207b 0a20   <= nh; k++) {. 
-00062370: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00062380: 6c6f 6174 2076 203d 2030 2e30 663b 0a20  loat v = 0.0f;. 
-00062390: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000623a0: 676d 6c5f 7665 635f 646f 745f 6633 3228  gml_vec_dot_f32(
-000623b0: 6577 302c 2026 762c 0a20 2020 2020 2020  ew0, &v,.       
-000623c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000623d0: 2028 666c 6f61 7420 2a29 2070 6172 616d   (float *) param
-000623e0: 732d 3e77 6461 7461 202b 2020 2069 312a  s->wdata +   i1*
-000623f0: 6577 302a 6e65 3030 202b 2020 2020 2020  ew0*ne00 +      
-00062400: 286e 6820 2b20 6b29 2a65 7730 2c0a 2020  (nh + k)*ew0,.  
-00062410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062420: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-00062430: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
-00062440: 6e65 3032 2a65 7730 2a6e 6530 3020 2b20  ne02*ew0*ne00 + 
-00062450: 2869 3020 2b20 6e68 202b 206b 292a 6577  (i0 + nh + k)*ew
-00062460: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
-00062470: 2020 2020 2064 7374 5f64 6174 615b 6930       dst_data[i0
-00062480: 5d20 2b3d 2076 3b0a 2020 2020 2020 2020  ] += v;.        
-00062490: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-000624a0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-000624b0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-000624c0: 655f 666f 7277 6172 645f 636f 6e76 5f31  e_forward_conv_1
-000624d0: 645f 3173 280a 2020 2020 2020 2020 636f  d_1s(.        co
-000624e0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000624f0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00062500: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00062510: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00062520: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00062530: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00062540: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00062550: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
-00062560: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00062570: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-00062580: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
-00062590: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
-000625a0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-000625b0: 4631 363a 0a20 2020 2020 2020 2020 2020  F16:.           
-000625c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000625d0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-000625e0: 666f 7277 6172 645f 636f 6e76 5f31 645f  forward_conv_1d_
-000625f0: 3173 5f66 3136 5f66 3332 2870 6172 616d  1s_f16_f32(param
-00062600: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00062610: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00062620: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00062630: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00062640: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-00062650: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00062660: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00062670: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
-00062680: 5f31 735f 6633 3228 7061 7261 6d73 2c20  _1s_f32(params, 
-00062690: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
-000626a0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000626b0: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
-000626c0: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-000626d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000626e0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-000626f0: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-00062700: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00062710: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
-00062720: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00062730: 636f 6e76 5f31 645f 3273 0a0a 7374 6174  conv_1d_2s..stat
-00062740: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00062750: 7075 7465 5f66 6f72 7761 7264 5f63 6f6e  pute_forward_con
-00062760: 765f 3164 5f32 735f 6631 365f 6633 3228  v_1d_2s_f16_f32(
-00062770: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00062780: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00062790: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-000627a0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-000627b0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000627c0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-000627d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000627e0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000627f0: 7372 6331 2c0a 2020 2020 2020 2020 2020  src1,.          
-00062800: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00062810: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00062820: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00062830: 7372 6330 2d3e 7479 7065 203d 3d20 4747  src0->type == GG
-00062840: 4d4c 5f54 5950 455f 4631 3629 3b0a 2020  ML_TYPE_F16);.  
-00062850: 2020 4747 4d4c 5f41 5353 4552 5428 7372    GGML_ASSERT(sr
-00062860: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
-00062870: 5f54 5950 455f 4633 3229 3b0a 2020 2020  _TYPE_F32);.    
-00062880: 4747 4d4c 5f41 5353 4552 5428 2064 7374  GGML_ASSERT( dst
-00062890: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-000628a0: 5950 455f 4633 3229 3b0a 0a20 2020 2069  YPE_F32);..    i
-000628b0: 6e74 3634 5f74 2074 3020 3d20 6767 6d6c  nt64_t t0 = ggml
-000628c0: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
-000628d0: 0a20 2020 2055 4e55 5345 4428 7430 293b  .    UNUSED(t0);
-000628e0: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-000628f0: 345f 7420 6e65 3030 203d 2073 7263 302d  4_t ne00 = src0-
-00062900: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-00062910: 7420 696e 7436 345f 7420 6e65 3031 203d  t int64_t ne01 =
-00062920: 2073 7263 302d 3e6e 655b 315d 3b0a 2020   src0->ne[1];.  
-00062930: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00062940: 6e65 3032 203d 2073 7263 302d 3e6e 655b  ne02 = src0->ne[
-00062950: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-00062960: 696e 7436 345f 7420 6e65 3033 203d 2073  int64_t ne03 = s
-00062970: 7263 302d 3e6e 655b 335d 3b0a 0a20 2020  rc0->ne[3];..   
-00062980: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00062990: 6531 3020 3d20 7372 6331 2d3e 6e65 5b30  e10 = src1->ne[0
-000629a0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-000629b0: 3634 5f74 206e 6531 3120 3d20 7372 6331  64_t ne11 = src1
-000629c0: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
-000629d0: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-000629e0: 3220 3d20 7372 6331 2d3e 6e65 5b32 5d3b  2 = src1->ne[2];
-000629f0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00062a00: 3634 5f74 206e 6531 3320 3d20 7372 6331  64_t ne13 = src1
-00062a10: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 2f2f  ->ne[3];..    //
-00062a20: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00062a30: 3020 203d 2064 7374 2d3e 6e65 5b30 5d3b  0  = dst->ne[0];
-00062a40: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00062a50: 3634 5f74 206e 6531 2020 3d20 6473 742d  64_t ne1  = dst-
-00062a60: 3e6e 655b 315d 3b0a 2020 2020 2f2f 636f  >ne[1];.    //co
-00062a70: 6e73 7420 696e 7436 345f 7420 6e65 3220  nst int64_t ne2 
-00062a80: 203d 2064 7374 2d3e 6e65 5b32 5d3b 0a20   = dst->ne[2];. 
-00062a90: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
-00062aa0: 5f74 206e 6533 2020 3d20 6473 742d 3e6e  _t ne3  = dst->n
-00062ab0: 655b 335d 3b0a 2020 2020 2f2f 636f 6e73  e[3];.    //cons
-00062ac0: 7420 696e 7436 345f 7420 6e65 2020 203d  t int64_t ne   =
-00062ad0: 206e 6530 2a6e 6531 2a6e 6532 2a6e 6533   ne0*ne1*ne2*ne3
-00062ae0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00062af0: 206e 6230 3020 3d20 7372 6330 2d3e 6e62   nb00 = src0->nb
-00062b00: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-00062b10: 6e74 206e 6230 3120 3d20 7372 6330 2d3e  nt nb01 = src0->
-00062b20: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-00062b30: 2069 6e74 206e 6230 3220 3d20 7372 6330   int nb02 = src0
-00062b40: 2d3e 6e62 5b32 5d3b 0a20 2020 202f 2f63  ->nb[2];.    //c
-00062b50: 6f6e 7374 2069 6e74 206e 6230 3320 3d20  onst int nb03 = 
-00062b60: 7372 6330 2d3e 6e62 5b33 5d3b 0a0a 2020  src0->nb[3];..  
-00062b70: 2020 636f 6e73 7420 696e 7420 6e62 3130    const int nb10
-00062b80: 203d 2073 7263 312d 3e6e 625b 305d 3b0a   = src1->nb[0];.
-00062b90: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00062ba0: 3131 203d 2073 7263 312d 3e6e 625b 315d  11 = src1->nb[1]
-00062bb0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-00062bc0: 7420 6e62 3132 203d 2073 7263 312d 3e6e  t nb12 = src1->n
-00062bd0: 625b 325d 3b0a 2020 2020 2f2f 636f 6e73  b[2];.    //cons
-00062be0: 7420 696e 7420 6e62 3133 203d 2073 7263  t int nb13 = src
-00062bf0: 312d 3e6e 625b 335d 3b0a 0a20 2020 202f  1->nb[3];..    /
-00062c00: 2f63 6f6e 7374 2069 6e74 206e 6230 2020  /const int nb0  
-00062c10: 3d20 6473 742d 3e6e 625b 305d 3b0a 2020  = dst->nb[0];.  
-00062c20: 2020 636f 6e73 7420 696e 7420 6e62 3120    const int nb1 
-00062c30: 203d 2064 7374 2d3e 6e62 5b31 5d3b 0a20   = dst->nb[1];. 
-00062c40: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-00062c50: 6232 2020 3d20 6473 742d 3e6e 625b 325d  b2  = dst->nb[2]
-00062c60: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-00062c70: 7420 6e62 3320 203d 2064 7374 2d3e 6e62  t nb3  = dst->nb
-00062c80: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-00062c90: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
-00062ca0: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-00062cb0: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
-00062cc0: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
-00062cd0: 7374 2069 6e74 206e 6b20 3d20 6e65 3030  st int nk = ne00
-00062ce0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00062cf0: 6e68 203d 206e 6b2f 323b 0a0a 2020 2020  nh = nk/2;..    
-00062d00: 636f 6e73 7420 696e 7420 6577 3020 3d20  const int ew0 = 
-00062d10: 6767 6d6c 5f75 7033 3228 6e65 3031 293b  ggml_up32(ne01);
-00062d20: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00062d30: 5428 6e65 3030 2025 2032 203d 3d20 3129  T(ne00 % 2 == 1)
-00062d40: 3b20 2f2f 2054 4f44 4f3a 2073 7570 706f  ; // TODO: suppo
-00062d50: 7274 2065 7665 6e20 6b65 726e 656c 2073  rt even kernel s
-00062d60: 697a 6573 0a20 2020 2047 474d 4c5f 4153  izes.    GGML_AS
-00062d70: 5345 5254 286e 6230 3020 3d3d 2073 697a  SERT(nb00 == siz
-00062d80: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
-00062d90: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00062da0: 5254 286e 6231 3020 3d3d 2073 697a 656f  RT(nb10 == sizeo
-00062db0: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
-00062dc0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-00062dd0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-00062de0: 4954 2920 7b0a 2020 2020 2020 2020 2f2f  IT) {.        //
-00062df0: 2054 4f44 4f3a 2066 6978 2074 6869 7320   TODO: fix this 
-00062e00: 6d65 6d73 6574 2028 7773 697a 6520 6973  memset (wsize is
-00062e10: 206f 7665 7265 7374 696d 6174 6564 290a   overestimated).
-00062e20: 2020 2020 2020 2020 6d65 6d73 6574 2870          memset(p
-00062e30: 6172 616d 732d 3e77 6461 7461 2c20 302c  arams->wdata, 0,
-00062e40: 2070 6172 616d 732d 3e77 7369 7a65 293b   params->wsize);
-00062e50: 0a0a 2020 2020 2020 2020 2f2f 2070 7265  ..        // pre
-00062e60: 7061 7265 206b 6572 6e65 6c20 6461 7461  pare kernel data
-00062e70: 2028 7372 6330 290a 2020 2020 2020 2020   (src0).        
-00062e80: 7b0a 2020 2020 2020 2020 2020 2020 6767  {.            gg
-00062e90: 6d6c 5f66 7031 365f 7420 2a20 636f 6e73  ml_fp16_t * cons
-00062ea0: 7420 7764 6174 6120 3d20 2867 676d 6c5f  t wdata = (ggml_
-00062eb0: 6670 3136 5f74 202a 2920 7061 7261 6d73  fp16_t *) params
-00062ec0: 2d3e 7764 6174 6120 2b20 303b 0a0a 2020  ->wdata + 0;..  
-00062ed0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00062ee0: 6e74 3634 5f74 2069 3032 203d 2030 3b20  nt64_t i02 = 0; 
-00062ef0: 6930 3220 3c20 6e65 3032 3b20 6930 322b  i02 < ne02; i02+
-00062f00: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00062f10: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00062f20: 7420 6930 3120 3d20 303b 2069 3031 203c  t i01 = 0; i01 <
-00062f30: 206e 6530 313b 2069 3031 2b2b 2920 7b0a   ne01; i01++) {.
-00062f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062f50: 2020 2020 636f 6e73 7420 6767 6d6c 5f66      const ggml_f
-00062f60: 7031 365f 7420 2a20 636f 6e73 7420 7372  p16_t * const sr
-00062f70: 6320 3d20 2867 676d 6c5f 6670 3136 5f74  c = (ggml_fp16_t
-00062f80: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
-00062f90: 302d 3e64 6174 6120 2b20 6930 322a 6e62  0->data + i02*nb
-00062fa0: 3032 202b 2069 3031 2a6e 6230 3129 3b0a  02 + i01*nb01);.
-00062fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062fc0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-00062fd0: 2a20 6473 745f 6461 7461 203d 2077 6461  * dst_data = wda
-00062fe0: 7461 202b 2069 3032 2a65 7730 2a6e 6530  ta + i02*ew0*ne0
-00062ff0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-00063000: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00063010: 345f 7420 6930 3020 3d20 303b 2069 3030  4_t i00 = 0; i00
-00063020: 203c 206e 6530 303b 2069 3030 2b2b 2920   < ne00; i00++) 
-00063030: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00063040: 2020 2020 2020 2020 2020 6473 745f 6461            dst_da
-00063050: 7461 5b69 3030 2a65 7730 202b 2069 3031  ta[i00*ew0 + i01
-00063060: 5d20 3d20 7372 635b 6930 305d 3b0a 2020  ] = src[i00];.  
-00063070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063080: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00063090: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000630a0: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
-000630b0: 2020 2020 2020 202f 2f20 7072 6570 6172         // prepar
-000630c0: 6520 736f 7572 6365 2064 6174 6120 2873  e source data (s
-000630d0: 7263 3129 0a20 2020 2020 2020 207b 0a20  rc1).        {. 
-000630e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000630f0: 6670 3136 5f74 202a 2063 6f6e 7374 2077  fp16_t * const w
-00063100: 6461 7461 203d 2028 6767 6d6c 5f66 7031  data = (ggml_fp1
-00063110: 365f 7420 2a29 2070 6172 616d 732d 3e77  6_t *) params->w
-00063120: 6461 7461 202b 206e 6530 322a 6577 302a  data + ne02*ew0*
-00063130: 6e65 3030 3b0a 0a20 2020 2020 2020 2020  ne00;..         
-00063140: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-00063150: 6931 3120 3d20 303b 2069 3131 203c 206e  i11 = 0; i11 < n
-00063160: 6531 313b 2069 3131 2b2b 2920 7b0a 2020  e11; i11++) {.  
-00063170: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00063180: 6e73 7420 666c 6f61 7420 2a20 636f 6e73  nst float * cons
-00063190: 7420 7372 6320 3d20 2866 6c6f 6174 202a  t src = (float *
-000631a0: 2928 2863 6861 7220 2a29 2073 7263 312d  )((char *) src1-
-000631b0: 3e64 6174 6120 2b20 6931 312a 6e62 3131  >data + i11*nb11
-000631c0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000631d0: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
-000631e0: 2064 7374 5f64 6174 6120 3d20 7764 6174   dst_data = wdat
-000631f0: 613b 0a20 2020 2020 2020 2020 2020 2020  a;.             
-00063200: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-00063210: 6931 3020 3d20 303b 2069 3130 203c 206e  i10 = 0; i10 < n
-00063220: 6531 303b 2069 3130 2b2b 2920 7b0a 2020  e10; i10++) {.  
-00063230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063240: 2020 6473 745f 6461 7461 5b28 6931 3020    dst_data[(i10 
-00063250: 2b20 6e68 292a 6577 3020 2b20 6931 315d  + nh)*ew0 + i11]
-00063260: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
-00063270: 4650 3136 2873 7263 5b69 3130 5d29 3b0a  FP16(src[i10]);.
-00063280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063290: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-000632a0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-000632b0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-000632c0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-000632d0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-000632e0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-000632f0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00063300: 2020 2020 7d0a 0a20 2020 202f 2f20 746f      }..    // to
-00063310: 7461 6c20 726f 7773 2069 6e20 6473 740a  tal rows in dst.
-00063320: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-00063330: 203d 206e 6530 323b 0a0a 2020 2020 2f2f   = ne02;..    //
-00063340: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
-00063350: 0a20 2020 2063 6f6e 7374 2069 6e74 2064  .    const int d
-00063360: 7220 3d20 286e 7220 2b20 6e74 6820 2d20  r = (nr + nth - 
-00063370: 3129 2f6e 7468 3b0a 0a20 2020 202f 2f20  1)/nth;..    // 
-00063380: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
-00063390: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
-000633a0: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
-000633b0: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
-000633c0: 696e 7420 6972 3120 3d20 4d49 4e28 6972  int ir1 = MIN(ir
-000633d0: 3020 2b20 6472 2c20 6e72 293b 0a0a 2020  0 + dr, nr);..  
-000633e0: 2020 666f 7220 2869 6e74 2069 3120 3d20    for (int i1 = 
-000633f0: 6972 303b 2069 3120 3c20 6972 313b 2069  ir0; i1 < ir1; i
-00063400: 312b 2b29 207b 0a20 2020 2020 2020 2066  1++) {.        f
-00063410: 6c6f 6174 202a 2064 7374 5f64 6174 6120  loat * dst_data 
-00063420: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
-00063430: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
-00063440: 2069 312a 6e62 3129 3b0a 2020 2020 2020   i1*nb1);.      
-00063450: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-00063460: 3020 3d20 303b 2069 3020 3c20 6e65 3130  0 = 0; i0 < ne10
-00063470: 3b20 6930 202b 3d20 3229 207b 0a20 2020  ; i0 += 2) {.   
-00063480: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-00063490: 615b 6930 2f32 5d20 3d20 303b 0a20 2020  a[i0/2] = 0;.   
-000634a0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-000634b0: 7420 6b20 3d20 2d6e 683b 206b 203c 3d20  t k = -nh; k <= 
-000634c0: 6e68 3b20 6b2b 2b29 207b 0a20 2020 2020  nh; k++) {.     
-000634d0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-000634e0: 2076 203d 2030 2e30 663b 0a20 2020 2020   v = 0.0f;.     
-000634f0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00063500: 7665 635f 646f 745f 6631 3628 6577 302c  vec_dot_f16(ew0,
-00063510: 2026 762c 0a20 2020 2020 2020 2020 2020   &v,.           
-00063520: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
-00063530: 6d6c 5f66 7031 365f 7420 2a29 2070 6172  ml_fp16_t *) par
-00063540: 616d 732d 3e77 6461 7461 202b 2020 2069  ams->wdata +   i
-00063550: 312a 6577 302a 6e65 3030 202b 2020 2020  1*ew0*ne00 +    
-00063560: 2020 286e 6820 2b20 6b29 2a65 7730 2c0a    (nh + k)*ew0,.
-00063570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063580: 2020 2020 2020 2020 2867 676d 6c5f 6670          (ggml_fp
-00063590: 3136 5f74 202a 2920 7061 7261 6d73 2d3e  16_t *) params->
-000635a0: 7764 6174 6120 2b20 6e65 3032 2a65 7730  wdata + ne02*ew0
-000635b0: 2a6e 6530 3020 2b20 2869 3020 2b20 6e68  *ne00 + (i0 + nh
-000635c0: 202b 206b 292a 6577 3029 3b0a 0a20 2020   + k)*ew0);..   
-000635d0: 2020 2020 2020 2020 2020 2020 2064 7374               dst
-000635e0: 5f64 6174 615b 6930 2f32 5d20 2b3d 2076  _data[i0/2] += v
-000635f0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00063600: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00063610: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00063620: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00063630: 6172 645f 636f 6e76 5f31 645f 3273 5f66  ard_conv_1d_2s_f
-00063640: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
-00063650: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00063660: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00063670: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00063680: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00063690: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-000636a0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-000636b0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000636c0: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-000636d0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000636e0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-000636f0: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-00063700: 5254 2873 7263 302d 3e74 7970 6520 3d3d  RT(src0->type ==
-00063710: 2047 474d 4c5f 5459 5045 5f46 3332 293b   GGML_TYPE_F32);
-00063720: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00063730: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
-00063740: 474d 4c5f 5459 5045 5f46 3332 293b 0a20  GML_TYPE_F32);. 
-00063750: 2020 2047 474d 4c5f 4153 5345 5254 2820     GGML_ASSERT( 
-00063760: 6473 742d 3e74 7970 6520 3d3d 2047 474d  dst->type == GGM
-00063770: 4c5f 5459 5045 5f46 3332 293b 0a0a 2020  L_TYPE_F32);..  
-00063780: 2020 696e 7436 345f 7420 7430 203d 2067    int64_t t0 = g
-00063790: 676d 6c5f 7065 7266 5f74 696d 655f 7573  gml_perf_time_us
-000637a0: 2829 3b0a 2020 2020 554e 5553 4544 2874  ();.    UNUSED(t
-000637b0: 3029 3b0a 0a20 2020 2063 6f6e 7374 2069  0);..    const i
-000637c0: 6e74 3634 5f74 206e 6530 3020 3d20 7372  nt64_t ne00 = sr
-000637d0: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
-000637e0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
-000637f0: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
-00063800: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00063810: 5f74 206e 6530 3220 3d20 7372 6330 2d3e  _t ne02 = src0->
-00063820: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
-00063830: 7374 2069 6e74 3634 5f74 206e 6530 3320  st int64_t ne03 
-00063840: 3d20 7372 6330 2d3e 6e65 5b33 5d3b 0a0a  = src0->ne[3];..
-00063850: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00063860: 7420 6e65 3130 203d 2073 7263 312d 3e6e  t ne10 = src1->n
-00063870: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-00063880: 696e 7436 345f 7420 6e65 3131 203d 2073  int64_t ne11 = s
-00063890: 7263 312d 3e6e 655b 315d 3b0a 2020 2020  rc1->ne[1];.    
-000638a0: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
-000638b0: 6e65 3132 203d 2073 7263 312d 3e6e 655b  ne12 = src1->ne[
-000638c0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-000638d0: 696e 7436 345f 7420 6e65 3133 203d 2073  int64_t ne13 = s
-000638e0: 7263 312d 3e6e 655b 335d 3b0a 0a20 2020  rc1->ne[3];..   
-000638f0: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-00063900: 206e 6530 2020 3d20 6473 742d 3e6e 655b   ne0  = dst->ne[
-00063910: 305d 3b0a 2020 2020 2f2f 636f 6e73 7420  0];.    //const 
-00063920: 696e 7436 345f 7420 6e65 3120 203d 2064  int64_t ne1  = d
-00063930: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 202f  st->ne[1];.    /
-00063940: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-00063950: 6532 2020 3d20 6473 742d 3e6e 655b 325d  e2  = dst->ne[2]
-00063960: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-00063970: 7436 345f 7420 6e65 3320 203d 2064 7374  t64_t ne3  = dst
-00063980: 2d3e 6e65 5b33 5d3b 0a20 2020 202f 2f63  ->ne[3];.    //c
-00063990: 6f6e 7374 2069 6e74 3634 5f74 206e 6520  onst int64_t ne 
-000639a0: 2020 3d20 6e65 302a 6e65 312a 6e65 322a    = ne0*ne1*ne2*
-000639b0: 6e65 333b 0a0a 2020 2020 636f 6e73 7420  ne3;..    const 
-000639c0: 696e 7420 6e62 3030 203d 2073 7263 302d  int nb00 = src0-
-000639d0: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-000639e0: 7420 696e 7420 6e62 3031 203d 2073 7263  t int nb01 = src
-000639f0: 302d 3e6e 625b 315d 3b0a 2020 2020 636f  0->nb[1];.    co
-00063a00: 6e73 7420 696e 7420 6e62 3032 203d 2073  nst int nb02 = s
-00063a10: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
-00063a20: 2f2f 636f 6e73 7420 696e 7420 6e62 3033  //const int nb03
-00063a30: 203d 2073 7263 302d 3e6e 625b 335d 3b0a   = src0->nb[3];.
-00063a40: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00063a50: 6231 3020 3d20 7372 6331 2d3e 6e62 5b30  b10 = src1->nb[0
-00063a60: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00063a70: 206e 6231 3120 3d20 7372 6331 2d3e 6e62   nb11 = src1->nb
-00063a80: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
-00063a90: 2069 6e74 206e 6231 3220 3d20 7372 6331   int nb12 = src1
-00063aa0: 2d3e 6e62 5b32 5d3b 0a20 2020 202f 2f63  ->nb[2];.    //c
-00063ab0: 6f6e 7374 2069 6e74 206e 6231 3320 3d20  onst int nb13 = 
-00063ac0: 7372 6331 2d3e 6e62 5b33 5d3b 0a0a 2020  src1->nb[3];..  
-00063ad0: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
-00063ae0: 3020 203d 2064 7374 2d3e 6e62 5b30 5d3b  0  = dst->nb[0];
-00063af0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00063b00: 6231 2020 3d20 6473 742d 3e6e 625b 315d  b1  = dst->nb[1]
-00063b10: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-00063b20: 7420 6e62 3220 203d 2064 7374 2d3e 6e62  t nb2  = dst->nb
-00063b30: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
-00063b40: 2069 6e74 206e 6233 2020 3d20 6473 742d   int nb3  = dst-
-00063b50: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-00063b60: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
-00063b70: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
-00063b80: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
-00063b90: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
-00063ba0: 636f 6e73 7420 696e 7420 6e6b 203d 206e  const int nk = n
-00063bb0: 6530 303b 0a20 2020 2063 6f6e 7374 2069  e00;.    const i
-00063bc0: 6e74 206e 6820 3d20 6e6b 2f32 3b0a 0a20  nt nh = nk/2;.. 
-00063bd0: 2020 2063 6f6e 7374 2069 6e74 2065 7730     const int ew0
-00063be0: 203d 2067 676d 6c5f 7570 3332 286e 6530   = ggml_up32(ne0
-00063bf0: 3129 3b0a 0a20 2020 2047 474d 4c5f 4153  1);..    GGML_AS
-00063c00: 5345 5254 286e 6530 3020 2520 3220 3d3d  SERT(ne00 % 2 ==
-00063c10: 2031 293b 202f 2f20 544f 444f 3a20 7375   1); // TODO: su
-00063c20: 7070 6f72 7420 6576 656e 206b 6572 6e65  pport even kerne
-00063c30: 6c20 7369 7a65 730a 2020 2020 4747 4d4c  l sizes.    GGML
-00063c40: 5f41 5353 4552 5428 6e62 3030 203d 3d20  _ASSERT(nb00 == 
-00063c50: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00063c60: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00063c70: 6e62 3130 203d 3d20 7369 7a65 6f66 2866  nb10 == sizeof(f
-00063c80: 6c6f 6174 2929 3b0a 0a20 2020 2069 6620  loat));..    if 
-00063c90: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00063ca0: 2047 474d 4c5f 5441 534b 5f49 4e49 5429   GGML_TASK_INIT)
-00063cb0: 207b 0a20 2020 2020 2020 202f 2f20 544f   {.        // TO
-00063cc0: 444f 3a20 6669 7820 7468 6973 206d 656d  DO: fix this mem
-00063cd0: 7365 7420 2877 7369 7a65 2069 7320 6f76  set (wsize is ov
-00063ce0: 6572 6573 7469 6d61 7465 6429 0a20 2020  erestimated).   
-00063cf0: 2020 2020 206d 656d 7365 7428 7061 7261       memset(para
-00063d00: 6d73 2d3e 7764 6174 612c 2030 2c20 7061  ms->wdata, 0, pa
-00063d10: 7261 6d73 2d3e 7773 697a 6529 3b0a 0a20  rams->wsize);.. 
-00063d20: 2020 2020 2020 202f 2f20 7072 6570 6172         // prepar
-00063d30: 6520 6b65 726e 656c 2064 6174 6120 2873  e kernel data (s
-00063d40: 7263 3029 0a20 2020 2020 2020 207b 0a20  rc0).        {. 
-00063d50: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-00063d60: 202a 2063 6f6e 7374 2077 6461 7461 203d   * const wdata =
-00063d70: 2028 666c 6f61 7420 2a29 2070 6172 616d   (float *) param
-00063d80: 732d 3e77 6461 7461 202b 2030 3b0a 0a20  s->wdata + 0;.. 
-00063d90: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00063da0: 696e 7436 345f 7420 6930 3220 3d20 303b  int64_t i02 = 0;
-00063db0: 2069 3032 203c 206e 6530 323b 2069 3032   i02 < ne02; i02
-00063dc0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00063dd0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00063de0: 5f74 2069 3031 203d 2030 3b20 6930 3120  _t i01 = 0; i01 
-00063df0: 3c20 6e65 3031 3b20 6930 312b 2b29 207b  < ne01; i01++) {
-00063e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00063e10: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-00063e20: 202a 2063 6f6e 7374 2073 7263 203d 2028   * const src = (
-00063e30: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-00063e40: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
-00063e50: 3032 2a6e 6230 3220 2b20 6930 312a 6e62  02*nb02 + i01*nb
-00063e60: 3031 293b 0a20 2020 2020 2020 2020 2020  01);.           
-00063e70: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-00063e80: 2064 7374 5f64 6174 6120 3d20 7764 6174   dst_data = wdat
-00063e90: 6120 2b20 6930 322a 6577 302a 6e65 3030  a + i02*ew0*ne00
-00063ea0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00063eb0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00063ec0: 5f74 2069 3030 203d 2030 3b20 6930 3020  _t i00 = 0; i00 
-00063ed0: 3c20 6e65 3030 3b20 6930 302b 2b29 207b  < ne00; i00++) {
-00063ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00063ef0: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-00063f00: 615b 6930 302a 6577 3020 2b20 6930 315d  a[i00*ew0 + i01]
-00063f10: 203d 2073 7263 5b69 3030 5d3b 0a20 2020   = src[i00];.   
-00063f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063f30: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00063f40: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00063f50: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-00063f60: 2020 2020 2020 2f2f 2070 7265 7061 7265        // prepare
-00063f70: 2073 6f75 7263 6520 6461 7461 2028 7372   source data (sr
-00063f80: 6331 290a 2020 2020 2020 2020 7b0a 2020  c1).        {.  
-00063f90: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-00063fa0: 2a20 636f 6e73 7420 7764 6174 6120 3d20  * const wdata = 
-00063fb0: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
-00063fc0: 2d3e 7764 6174 6120 2b20 6e65 3032 2a65  ->wdata + ne02*e
-00063fd0: 7730 2a6e 6530 303b 0a0a 2020 2020 2020  w0*ne00;..      
-00063fe0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00063ff0: 5f74 2069 3131 203d 2030 3b20 6931 3120  _t i11 = 0; i11 
-00064000: 3c20 6e65 3131 3b20 6931 312b 2b29 207b  < ne11; i11++) {
-00064010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00064020: 2063 6f6e 7374 2066 6c6f 6174 202a 2063   const float * c
-00064030: 6f6e 7374 2073 7263 203d 2028 666c 6f61  onst src = (floa
-00064040: 7420 2a29 2828 6368 6172 202a 2920 7372  t *)((char *) sr
-00064050: 6331 2d3e 6461 7461 202b 2069 3131 2a6e  c1->data + i11*n
-00064060: 6231 3129 3b0a 2020 2020 2020 2020 2020  b11);.          
-00064070: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
-00064080: 745f 6461 7461 203d 2077 6461 7461 3b0a  t_data = wdata;.
+00061f10: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00061f20: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00061f30: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
+00061f40: 2020 2020 2020 2f2f 2070 7265 7061 7265        // prepare
+00061f50: 2073 6f75 7263 6520 6461 7461 2028 7372   source data (sr
+00061f60: 6331 290a 2020 2020 2020 2020 7b0a 2020  c1).        {.  
+00061f70: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00061f80: 2a20 636f 6e73 7420 7764 6174 6120 3d20  * const wdata = 
+00061f90: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
+00061fa0: 2d3e 7764 6174 6120 2b20 6e65 3032 2a65  ->wdata + ne02*e
+00061fb0: 7730 2a6e 6530 303b 0a0a 2020 2020 2020  w0*ne00;..      
+00061fc0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+00061fd0: 5f74 2069 3131 203d 2030 3b20 6931 3120  _t i11 = 0; i11 
+00061fe0: 3c20 6e65 3131 3b20 6931 312b 2b29 207b  < ne11; i11++) {
+00061ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00062000: 2063 6f6e 7374 2066 6c6f 6174 202a 2063   const float * c
+00062010: 6f6e 7374 2073 7263 203d 2028 666c 6f61  onst src = (floa
+00062020: 7420 2a29 2828 6368 6172 202a 2920 7372  t *)((char *) sr
+00062030: 6331 2d3e 6461 7461 202b 2069 3131 2a6e  c1->data + i11*n
+00062040: 6231 3129 3b0a 2020 2020 2020 2020 2020  b11);.          
+00062050: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
+00062060: 745f 6461 7461 203d 2077 6461 7461 3b0a  t_data = wdata;.
+00062070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062080: 666f 7220 2869 6e74 3634 5f74 2069 3130  for (int64_t i10
+00062090: 203d 2030 3b20 6931 3020 3c20 6e65 3130   = 0; i10 < ne10
+000620a0: 3b20 6931 302b 2b29 207b 0a20 2020 2020  ; i10++) {.     
+000620b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000620c0: 7374 5f64 6174 615b 2869 3130 202b 206e  st_data[(i10 + n
+000620d0: 6829 2a65 7730 202b 2069 3131 5d20 3d20  h)*ew0 + i11] = 
+000620e0: 7372 635b 6931 305d 3b0a 2020 2020 2020  src[i10];.      
+000620f0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00062100: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00062110: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
+00062120: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
+00062130: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+00062140: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00062150: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00062160: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00062170: 0a20 2020 202f 2f20 746f 7461 6c20 726f  .    // total ro
+00062180: 7773 2069 6e20 6473 740a 2020 2020 636f  ws in dst.    co
+00062190: 6e73 7420 696e 7420 6e72 203d 206e 6530  nst int nr = ne0
+000621a0: 323b 0a0a 2020 2020 2f2f 2072 6f77 7320  2;..    // rows 
+000621b0: 7065 7220 7468 7265 6164 0a20 2020 2063  per thread.    c
+000621c0: 6f6e 7374 2069 6e74 2064 7220 3d20 286e  onst int dr = (n
+000621d0: 7220 2b20 6e74 6820 2d20 3129 2f6e 7468  r + nth - 1)/nth
+000621e0: 3b0a 0a20 2020 202f 2f20 726f 7720 7261  ;..    // row ra
+000621f0: 6e67 6520 666f 7220 7468 6973 2074 6872  nge for this thr
+00062200: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
+00062210: 7420 6972 3020 3d20 6472 2a69 7468 3b0a  t ir0 = dr*ith;.
+00062220: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+00062230: 3120 3d20 4d49 4e28 6972 3020 2b20 6472  1 = MIN(ir0 + dr
+00062240: 2c20 6e72 293b 0a0a 2020 2020 666f 7220  , nr);..    for 
+00062250: 2869 6e74 2069 3120 3d20 6972 303b 2069  (int i1 = ir0; i
+00062260: 3120 3c20 6972 313b 2069 312b 2b29 207b  1 < ir1; i1++) {
+00062270: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
+00062280: 2064 7374 5f64 6174 6120 3d20 2866 6c6f   dst_data = (flo
+00062290: 6174 202a 2928 2863 6861 7220 2a29 2064  at *)((char *) d
+000622a0: 7374 2d3e 6461 7461 202b 2069 312a 6e62  st->data + i1*nb
+000622b0: 3129 3b0a 2020 2020 2020 2020 666f 7220  1);.        for 
+000622c0: 2869 6e74 3634 5f74 2069 3020 3d20 303b  (int64_t i0 = 0;
+000622d0: 2069 3020 3c20 6e65 3130 3b20 2b2b 6930   i0 < ne10; ++i0
+000622e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000622f0: 6473 745f 6461 7461 5b69 305d 203d 2030  dst_data[i0] = 0
+00062300: 3b0a 2020 2020 2020 2020 2020 2020 666f  ;.            fo
+00062310: 7220 2869 6e74 206b 203d 202d 6e68 3b20  r (int k = -nh; 
+00062320: 6b20 3c3d 206e 683b 206b 2b2b 2920 7b0a  k <= nh; k++) {.
+00062330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062340: 666c 6f61 7420 7620 3d20 302e 3066 3b0a  float v = 0.0f;.
+00062350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062360: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3332  ggml_vec_dot_f32
+00062370: 2865 7730 2c20 2676 2c0a 2020 2020 2020  (ew0, &v,.      
+00062380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062390: 2020 2866 6c6f 6174 202a 2920 7061 7261    (float *) para
+000623a0: 6d73 2d3e 7764 6174 6120 2b20 2020 6931  ms->wdata +   i1
+000623b0: 2a65 7730 2a6e 6530 3020 2b20 2020 2020  *ew0*ne00 +     
+000623c0: 2028 6e68 202b 206b 292a 6577 302c 0a20   (nh + k)*ew0,. 
+000623d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000623e0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+000623f0: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+00062400: 206e 6530 322a 6577 302a 6e65 3030 202b   ne02*ew0*ne00 +
+00062410: 2028 6930 202b 206e 6820 2b20 6b29 2a65   (i0 + nh + k)*e
+00062420: 7730 293b 0a0a 2020 2020 2020 2020 2020  w0);..          
+00062430: 2020 2020 2020 6473 745f 6461 7461 5b69        dst_data[i
+00062440: 305d 202b 3d20 763b 0a20 2020 2020 2020  0] += v;.       
+00062450: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00062460: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+00062470: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00062480: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
+00062490: 3164 5f31 7328 0a20 2020 2020 2020 2063  1d_1s(.        c
+000624a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+000624b0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+000624c0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+000624d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000624e0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+000624f0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
+00062500: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00062510: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
+00062520: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00062530: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+00062540: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
+00062550: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+00062560: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00062570: 5f46 3136 3a0a 2020 2020 2020 2020 2020  _F16:.          
+00062580: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00062590: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+000625a0: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
+000625b0: 5f31 735f 6631 365f 6633 3228 7061 7261  _1s_f16_f32(para
+000625c0: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+000625d0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+000625e0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000625f0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00062600: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
+00062610: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00062620: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00062630: 655f 666f 7277 6172 645f 636f 6e76 5f31  e_forward_conv_1
+00062640: 645f 3173 5f66 3332 2870 6172 616d 732c  d_1s_f32(params,
+00062650: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
+00062660: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00062670: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00062680: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+00062690: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000626a0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+000626b0: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+000626c0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000626d0: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
+000626e0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+000626f0: 5f63 6f6e 765f 3164 5f32 730a 0a73 7461  _conv_1d_2s..sta
+00062700: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00062710: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
+00062720: 6e76 5f31 645f 3273 5f66 3136 5f66 3332  nv_1d_2s_f16_f32
+00062730: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00062740: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00062750: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00062760: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00062770: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00062780: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00062790: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000627a0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000627b0: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
+000627c0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+000627d0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+000627e0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000627f0: 2873 7263 302d 3e74 7970 6520 3d3d 2047  (src0->type == G
+00062800: 474d 4c5f 5459 5045 5f46 3136 293b 0a20  GML_TYPE_F16);. 
+00062810: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
+00062820: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
+00062830: 4c5f 5459 5045 5f46 3332 293b 0a20 2020  L_TYPE_F32);.   
+00062840: 2047 474d 4c5f 4153 5345 5254 2820 6473   GGML_ASSERT( ds
+00062850: 742d 3e74 7970 6520 3d3d 2047 474d 4c5f  t->type == GGML_
+00062860: 5459 5045 5f46 3332 293b 0a0a 2020 2020  TYPE_F32);..    
+00062870: 696e 7436 345f 7420 7430 203d 2067 676d  int64_t t0 = ggm
+00062880: 6c5f 7065 7266 5f74 696d 655f 7573 2829  l_perf_time_us()
+00062890: 3b0a 2020 2020 554e 5553 4544 2874 3029  ;.    UNUSED(t0)
+000628a0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+000628b0: 3634 5f74 206e 6530 3020 3d20 7372 6330  64_t ne00 = src0
+000628c0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+000628d0: 7374 2069 6e74 3634 5f74 206e 6530 3120  st int64_t ne01 
+000628e0: 3d20 7372 6330 2d3e 6e65 5b31 5d3b 0a20  = src0->ne[1];. 
+000628f0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00062900: 206e 6530 3220 3d20 7372 6330 2d3e 6e65   ne02 = src0->ne
+00062910: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
+00062920: 2069 6e74 3634 5f74 206e 6530 3320 3d20   int64_t ne03 = 
+00062930: 7372 6330 2d3e 6e65 5b33 5d3b 0a0a 2020  src0->ne[3];..  
+00062940: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00062950: 6e65 3130 203d 2073 7263 312d 3e6e 655b  ne10 = src1->ne[
+00062960: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00062970: 7436 345f 7420 6e65 3131 203d 2073 7263  t64_t ne11 = src
+00062980: 312d 3e6e 655b 315d 3b0a 2020 2020 2f2f  1->ne[1];.    //
+00062990: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+000629a0: 3132 203d 2073 7263 312d 3e6e 655b 325d  12 = src1->ne[2]
+000629b0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+000629c0: 7436 345f 7420 6e65 3133 203d 2073 7263  t64_t ne13 = src
+000629d0: 312d 3e6e 655b 335d 3b0a 0a20 2020 202f  1->ne[3];..    /
+000629e0: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+000629f0: 6530 2020 3d20 6473 742d 3e6e 655b 305d  e0  = dst->ne[0]
+00062a00: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00062a10: 7436 345f 7420 6e65 3120 203d 2064 7374  t64_t ne1  = dst
+00062a20: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
+00062a30: 6f6e 7374 2069 6e74 3634 5f74 206e 6532  onst int64_t ne2
+00062a40: 2020 3d20 6473 742d 3e6e 655b 325d 3b0a    = dst->ne[2];.
+00062a50: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
+00062a60: 345f 7420 6e65 3320 203d 2064 7374 2d3e  4_t ne3  = dst->
+00062a70: 6e65 5b33 5d3b 0a20 2020 202f 2f63 6f6e  ne[3];.    //con
+00062a80: 7374 2069 6e74 3634 5f74 206e 6520 2020  st int64_t ne   
+00062a90: 3d20 6e65 302a 6e65 312a 6e65 322a 6e65  = ne0*ne1*ne2*ne
+00062aa0: 333b 0a0a 2020 2020 636f 6e73 7420 696e  3;..    const in
+00062ab0: 7420 6e62 3030 203d 2073 7263 302d 3e6e  t nb00 = src0->n
+00062ac0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+00062ad0: 696e 7420 6e62 3031 203d 2073 7263 302d  int nb01 = src0-
+00062ae0: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00062af0: 7420 696e 7420 6e62 3032 203d 2073 7263  t int nb02 = src
+00062b00: 302d 3e6e 625b 325d 3b0a 2020 2020 2f2f  0->nb[2];.    //
+00062b10: 636f 6e73 7420 696e 7420 6e62 3033 203d  const int nb03 =
+00062b20: 2073 7263 302d 3e6e 625b 335d 3b0a 0a20   src0->nb[3];.. 
+00062b30: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
+00062b40: 3020 3d20 7372 6331 2d3e 6e62 5b30 5d3b  0 = src1->nb[0];
+00062b50: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00062b60: 6231 3120 3d20 7372 6331 2d3e 6e62 5b31  b11 = src1->nb[1
+00062b70: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00062b80: 6e74 206e 6231 3220 3d20 7372 6331 2d3e  nt nb12 = src1->
+00062b90: 6e62 5b32 5d3b 0a20 2020 202f 2f63 6f6e  nb[2];.    //con
+00062ba0: 7374 2069 6e74 206e 6231 3320 3d20 7372  st int nb13 = sr
+00062bb0: 6331 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c1->nb[3];..    
+00062bc0: 2f2f 636f 6e73 7420 696e 7420 6e62 3020  //const int nb0 
+00062bd0: 203d 2064 7374 2d3e 6e62 5b30 5d3b 0a20   = dst->nb[0];. 
+00062be0: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
+00062bf0: 2020 3d20 6473 742d 3e6e 625b 315d 3b0a    = dst->nb[1];.
+00062c00: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+00062c10: 6e62 3220 203d 2064 7374 2d3e 6e62 5b32  nb2  = dst->nb[2
+00062c20: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00062c30: 6e74 206e 6233 2020 3d20 6473 742d 3e6e  nt nb3  = dst->n
+00062c40: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+00062c50: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
+00062c60: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
+00062c70: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
+00062c80: 6d73 2d3e 6e74 683b 0a0a 2020 2020 636f  ms->nth;..    co
+00062c90: 6e73 7420 696e 7420 6e6b 203d 206e 6530  nst int nk = ne0
+00062ca0: 303b 0a20 2020 2063 6f6e 7374 2069 6e74  0;.    const int
+00062cb0: 206e 6820 3d20 6e6b 2f32 3b0a 0a20 2020   nh = nk/2;..   
+00062cc0: 2063 6f6e 7374 2069 6e74 2065 7730 203d   const int ew0 =
+00062cd0: 2067 676d 6c5f 7570 3332 286e 6530 3129   ggml_up32(ne01)
+00062ce0: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00062cf0: 5254 286e 6530 3020 2520 3220 3d3d 2031  RT(ne00 % 2 == 1
+00062d00: 293b 202f 2f20 544f 444f 3a20 7375 7070  ); // TODO: supp
+00062d10: 6f72 7420 6576 656e 206b 6572 6e65 6c20  ort even kernel 
+00062d20: 7369 7a65 730a 2020 2020 4747 4d4c 5f41  sizes.    GGML_A
+00062d30: 5353 4552 5428 6e62 3030 203d 3d20 7369  SSERT(nb00 == si
+00062d40: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
+00062d50: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+00062d60: 4552 5428 6e62 3130 203d 3d20 7369 7a65  ERT(nb10 == size
+00062d70: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
+00062d80: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+00062d90: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+00062da0: 4e49 5429 207b 0a20 2020 2020 2020 202f  NIT) {.        /
+00062db0: 2f20 544f 444f 3a20 6669 7820 7468 6973  / TODO: fix this
+00062dc0: 206d 656d 7365 7420 2877 7369 7a65 2069   memset (wsize i
+00062dd0: 7320 6f76 6572 6573 7469 6d61 7465 6429  s overestimated)
+00062de0: 0a20 2020 2020 2020 206d 656d 7365 7428  .        memset(
+00062df0: 7061 7261 6d73 2d3e 7764 6174 612c 2030  params->wdata, 0
+00062e00: 2c20 7061 7261 6d73 2d3e 7773 697a 6529  , params->wsize)
+00062e10: 3b0a 0a20 2020 2020 2020 202f 2f20 7072  ;..        // pr
+00062e20: 6570 6172 6520 6b65 726e 656c 2064 6174  epare kernel dat
+00062e30: 6120 2873 7263 3029 0a20 2020 2020 2020  a (src0).       
+00062e40: 207b 0a20 2020 2020 2020 2020 2020 2067   {.            g
+00062e50: 676d 6c5f 6670 3136 5f74 202a 2063 6f6e  gml_fp16_t * con
+00062e60: 7374 2077 6461 7461 203d 2028 6767 6d6c  st wdata = (ggml
+00062e70: 5f66 7031 365f 7420 2a29 2070 6172 616d  _fp16_t *) param
+00062e80: 732d 3e77 6461 7461 202b 2030 3b0a 0a20  s->wdata + 0;.. 
+00062e90: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00062ea0: 696e 7436 345f 7420 6930 3220 3d20 303b  int64_t i02 = 0;
+00062eb0: 2069 3032 203c 206e 6530 323b 2069 3032   i02 < ne02; i02
+00062ec0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00062ed0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+00062ee0: 5f74 2069 3031 203d 2030 3b20 6930 3120  _t i01 = 0; i01 
+00062ef0: 3c20 6e65 3031 3b20 6930 312b 2b29 207b  < ne01; i01++) {
+00062f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00062f10: 2020 2020 2063 6f6e 7374 2067 676d 6c5f       const ggml_
+00062f20: 6670 3136 5f74 202a 2063 6f6e 7374 2073  fp16_t * const s
+00062f30: 7263 203d 2028 6767 6d6c 5f66 7031 365f  rc = (ggml_fp16_
+00062f40: 7420 2a29 2828 6368 6172 202a 2920 7372  t *)((char *) sr
+00062f50: 6330 2d3e 6461 7461 202b 2069 3032 2a6e  c0->data + i02*n
+00062f60: 6230 3220 2b20 6930 312a 6e62 3031 293b  b02 + i01*nb01);
+00062f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00062f80: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+00062f90: 202a 2064 7374 5f64 6174 6120 3d20 7764   * dst_data = wd
+00062fa0: 6174 6120 2b20 6930 322a 6577 302a 6e65  ata + i02*ew0*ne
+00062fb0: 3030 3b0a 2020 2020 2020 2020 2020 2020  00;.            
+00062fc0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00062fd0: 3634 5f74 2069 3030 203d 2030 3b20 6930  64_t i00 = 0; i0
+00062fe0: 3020 3c20 6e65 3030 3b20 6930 302b 2b29  0 < ne00; i00++)
+00062ff0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00063000: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
+00063010: 6174 615b 6930 302a 6577 3020 2b20 6930  ata[i00*ew0 + i0
+00063020: 315d 203d 2073 7263 5b69 3030 5d3b 0a20  1] = src[i00];. 
+00063030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063040: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00063050: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00063060: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
+00063070: 2020 2020 2020 2020 2f2f 2070 7265 7061          // prepa
+00063080: 7265 2073 6f75 7263 6520 6461 7461 2028  re source data (
+00063090: 7372 6331 290a 2020 2020 2020 2020 7b0a  src1).        {.
+000630a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000630b0: 5f66 7031 365f 7420 2a20 636f 6e73 7420  _fp16_t * const 
+000630c0: 7764 6174 6120 3d20 2867 676d 6c5f 6670  wdata = (ggml_fp
+000630d0: 3136 5f74 202a 2920 7061 7261 6d73 2d3e  16_t *) params->
+000630e0: 7764 6174 6120 2b20 6e65 3032 2a65 7730  wdata + ne02*ew0
+000630f0: 2a6e 6530 303b 0a0a 2020 2020 2020 2020  *ne00;..        
+00063100: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00063110: 2069 3131 203d 2030 3b20 6931 3120 3c20   i11 = 0; i11 < 
+00063120: 6e65 3131 3b20 6931 312b 2b29 207b 0a20  ne11; i11++) {. 
+00063130: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00063140: 6f6e 7374 2066 6c6f 6174 202a 2063 6f6e  onst float * con
+00063150: 7374 2073 7263 203d 2028 666c 6f61 7420  st src = (float 
+00063160: 2a29 2828 6368 6172 202a 2920 7372 6331  *)((char *) src1
+00063170: 2d3e 6461 7461 202b 2069 3131 2a6e 6231  ->data + i11*nb1
+00063180: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
+00063190: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
+000631a0: 2a20 6473 745f 6461 7461 203d 2077 6461  * dst_data = wda
+000631b0: 7461 3b0a 2020 2020 2020 2020 2020 2020  ta;.            
+000631c0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+000631d0: 2069 3130 203d 2030 3b20 6931 3020 3c20   i10 = 0; i10 < 
+000631e0: 6e65 3130 3b20 6931 302b 2b29 207b 0a20  ne10; i10++) {. 
+000631f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063200: 2020 2064 7374 5f64 6174 615b 2869 3130     dst_data[(i10
+00063210: 202b 206e 6829 2a65 7730 202b 2069 3131   + nh)*ew0 + i11
+00063220: 5d20 3d20 4747 4d4c 5f46 5033 325f 544f  ] = GGML_FP32_TO
+00063230: 5f46 5031 3628 7372 635b 6931 305d 293b  _FP16(src[i10]);
+00063240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00063250: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00063260: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00063270: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+00063280: 7d0a 0a20 2020 2069 6620 2870 6172 616d  }..    if (param
+00063290: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+000632a0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+000632b0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+000632c0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2074  .    }..    // t
+000632d0: 6f74 616c 2072 6f77 7320 696e 2064 7374  otal rows in dst
+000632e0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000632f0: 7220 3d20 6e65 3032 3b0a 0a20 2020 202f  r = ne02;..    /
+00063300: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
+00063310: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
+00063320: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
+00063330: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
+00063340: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
+00063350: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
+00063360: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
+00063370: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
+00063380: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
+00063390: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
+000633a0: 2020 2066 6f72 2028 696e 7420 6931 203d     for (int i1 =
+000633b0: 2069 7230 3b20 6931 203c 2069 7231 3b20   ir0; i1 < ir1; 
+000633c0: 6931 2b2b 2920 7b0a 2020 2020 2020 2020  i1++) {.        
+000633d0: 666c 6f61 7420 2a20 6473 745f 6461 7461  float * dst_data
+000633e0: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
+000633f0: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+00063400: 2b20 6931 2a6e 6231 293b 0a20 2020 2020  + i1*nb1);.     
+00063410: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+00063420: 6930 203d 2030 3b20 6930 203c 206e 6531  i0 = 0; i0 < ne1
+00063430: 303b 2069 3020 2b3d 2032 2920 7b0a 2020  0; i0 += 2) {.  
+00063440: 2020 2020 2020 2020 2020 6473 745f 6461            dst_da
+00063450: 7461 5b69 302f 325d 203d 2030 3b0a 2020  ta[i0/2] = 0;.  
+00063460: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00063470: 6e74 206b 203d 202d 6e68 3b20 6b20 3c3d  nt k = -nh; k <=
+00063480: 206e 683b 206b 2b2b 2920 7b0a 2020 2020   nh; k++) {.    
+00063490: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+000634a0: 7420 7620 3d20 302e 3066 3b0a 2020 2020  t v = 0.0f;.    
+000634b0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000634c0: 5f76 6563 5f64 6f74 5f66 3136 2865 7730  _vec_dot_f16(ew0
+000634d0: 2c20 2676 2c0a 2020 2020 2020 2020 2020  , &v,.          
+000634e0: 2020 2020 2020 2020 2020 2020 2020 2867                (g
+000634f0: 676d 6c5f 6670 3136 5f74 202a 2920 7061  gml_fp16_t *) pa
+00063500: 7261 6d73 2d3e 7764 6174 6120 2b20 2020  rams->wdata +   
+00063510: 6931 2a65 7730 2a6e 6530 3020 2b20 2020  i1*ew0*ne00 +   
+00063520: 2020 2028 6e68 202b 206b 292a 6577 302c     (nh + k)*ew0,
+00063530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00063540: 2020 2020 2020 2020 2028 6767 6d6c 5f66           (ggml_f
+00063550: 7031 365f 7420 2a29 2070 6172 616d 732d  p16_t *) params-
+00063560: 3e77 6461 7461 202b 206e 6530 322a 6577  >wdata + ne02*ew
+00063570: 302a 6e65 3030 202b 2028 6930 202b 206e  0*ne00 + (i0 + n
+00063580: 6820 2b20 6b29 2a65 7730 293b 0a0a 2020  h + k)*ew0);..  
+00063590: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+000635a0: 745f 6461 7461 5b69 302f 325d 202b 3d20  t_data[i0/2] += 
+000635b0: 763b 0a20 2020 2020 2020 2020 2020 207d  v;.            }
+000635c0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+000635d0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+000635e0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000635f0: 7761 7264 5f63 6f6e 765f 3164 5f32 735f  ward_conv_1d_2s_
+00063600: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
+00063610: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00063620: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00063630: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00063640: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00063650: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00063660: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00063670: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00063680: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+00063690: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+000636a0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+000636b0: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+000636c0: 4552 5428 7372 6330 2d3e 7479 7065 203d  ERT(src0->type =
+000636d0: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
+000636e0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+000636f0: 5428 7372 6331 2d3e 7479 7065 203d 3d20  T(src1->type == 
+00063700: 4747 4d4c 5f54 5950 455f 4633 3229 3b0a  GGML_TYPE_F32);.
+00063710: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00063720: 2064 7374 2d3e 7479 7065 203d 3d20 4747   dst->type == GG
+00063730: 4d4c 5f54 5950 455f 4633 3229 3b0a 0a20  ML_TYPE_F32);.. 
+00063740: 2020 2069 6e74 3634 5f74 2074 3020 3d20     int64_t t0 = 
+00063750: 6767 6d6c 5f70 6572 665f 7469 6d65 5f75  ggml_perf_time_u
+00063760: 7328 293b 0a20 2020 2055 4e55 5345 4428  s();.    UNUSED(
+00063770: 7430 293b 0a0a 2020 2020 636f 6e73 7420  t0);..    const 
+00063780: 696e 7436 345f 7420 6e65 3030 203d 2073  int64_t ne00 = s
+00063790: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
+000637a0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+000637b0: 3031 203d 2073 7263 302d 3e6e 655b 315d  01 = src0->ne[1]
+000637c0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+000637d0: 345f 7420 6e65 3032 203d 2073 7263 302d  4_t ne02 = src0-
+000637e0: 3e6e 655b 325d 3b0a 2020 2020 2f2f 636f  >ne[2];.    //co
+000637f0: 6e73 7420 696e 7436 345f 7420 6e65 3033  nst int64_t ne03
+00063800: 203d 2073 7263 302d 3e6e 655b 335d 3b0a   = src0->ne[3];.
+00063810: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00063820: 5f74 206e 6531 3020 3d20 7372 6331 2d3e  _t ne10 = src1->
+00063830: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+00063840: 2069 6e74 3634 5f74 206e 6531 3120 3d20   int64_t ne11 = 
+00063850: 7372 6331 2d3e 6e65 5b31 5d3b 0a20 2020  src1->ne[1];.   
+00063860: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
+00063870: 206e 6531 3220 3d20 7372 6331 2d3e 6e65   ne12 = src1->ne
+00063880: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
+00063890: 2069 6e74 3634 5f74 206e 6531 3320 3d20   int64_t ne13 = 
+000638a0: 7372 6331 2d3e 6e65 5b33 5d3b 0a0a 2020  src1->ne[3];..  
+000638b0: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+000638c0: 7420 6e65 3020 203d 2064 7374 2d3e 6e65  t ne0  = dst->ne
+000638d0: 5b30 5d3b 0a20 2020 202f 2f63 6f6e 7374  [0];.    //const
+000638e0: 2069 6e74 3634 5f74 206e 6531 2020 3d20   int64_t ne1  = 
+000638f0: 6473 742d 3e6e 655b 315d 3b0a 2020 2020  dst->ne[1];.    
+00063900: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
+00063910: 6e65 3220 203d 2064 7374 2d3e 6e65 5b32  ne2  = dst->ne[2
+00063920: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00063930: 6e74 3634 5f74 206e 6533 2020 3d20 6473  nt64_t ne3  = ds
+00063940: 742d 3e6e 655b 335d 3b0a 2020 2020 2f2f  t->ne[3];.    //
+00063950: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00063960: 2020 203d 206e 6530 2a6e 6531 2a6e 6532     = ne0*ne1*ne2
+00063970: 2a6e 6533 3b0a 0a20 2020 2063 6f6e 7374  *ne3;..    const
+00063980: 2069 6e74 206e 6230 3020 3d20 7372 6330   int nb00 = src0
+00063990: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+000639a0: 7374 2069 6e74 206e 6230 3120 3d20 7372  st int nb01 = sr
+000639b0: 6330 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c0->nb[1];.    c
+000639c0: 6f6e 7374 2069 6e74 206e 6230 3220 3d20  onst int nb02 = 
+000639d0: 7372 6330 2d3e 6e62 5b32 5d3b 0a20 2020  src0->nb[2];.   
+000639e0: 202f 2f63 6f6e 7374 2069 6e74 206e 6230   //const int nb0
+000639f0: 3320 3d20 7372 6330 2d3e 6e62 5b33 5d3b  3 = src0->nb[3];
+00063a00: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+00063a10: 6e62 3130 203d 2073 7263 312d 3e6e 625b  nb10 = src1->nb[
+00063a20: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00063a30: 7420 6e62 3131 203d 2073 7263 312d 3e6e  t nb11 = src1->n
+00063a40: 625b 315d 3b0a 2020 2020 2f2f 636f 6e73  b[1];.    //cons
+00063a50: 7420 696e 7420 6e62 3132 203d 2073 7263  t int nb12 = src
+00063a60: 312d 3e6e 625b 325d 3b0a 2020 2020 2f2f  1->nb[2];.    //
+00063a70: 636f 6e73 7420 696e 7420 6e62 3133 203d  const int nb13 =
+00063a80: 2073 7263 312d 3e6e 625b 335d 3b0a 0a20   src1->nb[3];.. 
+00063a90: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00063aa0: 6230 2020 3d20 6473 742d 3e6e 625b 305d  b0  = dst->nb[0]
+00063ab0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00063ac0: 6e62 3120 203d 2064 7374 2d3e 6e62 5b31  nb1  = dst->nb[1
+00063ad0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00063ae0: 6e74 206e 6232 2020 3d20 6473 742d 3e6e  nt nb2  = dst->n
+00063af0: 625b 325d 3b0a 2020 2020 2f2f 636f 6e73  b[2];.    //cons
+00063b00: 7420 696e 7420 6e62 3320 203d 2064 7374  t int nb3  = dst
+00063b10: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
+00063b20: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
+00063b30: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
+00063b40: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
+00063b50: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
+00063b60: 2063 6f6e 7374 2069 6e74 206e 6b20 3d20   const int nk = 
+00063b70: 6e65 3030 3b0a 2020 2020 636f 6e73 7420  ne00;.    const 
+00063b80: 696e 7420 6e68 203d 206e 6b2f 323b 0a0a  int nh = nk/2;..
+00063b90: 2020 2020 636f 6e73 7420 696e 7420 6577      const int ew
+00063ba0: 3020 3d20 6767 6d6c 5f75 7033 3228 6e65  0 = ggml_up32(ne
+00063bb0: 3031 293b 0a0a 2020 2020 4747 4d4c 5f41  01);..    GGML_A
+00063bc0: 5353 4552 5428 6e65 3030 2025 2032 203d  SSERT(ne00 % 2 =
+00063bd0: 3d20 3129 3b20 2f2f 2054 4f44 4f3a 2073  = 1); // TODO: s
+00063be0: 7570 706f 7274 2065 7665 6e20 6b65 726e  upport even kern
+00063bf0: 656c 2073 697a 6573 0a20 2020 2047 474d  el sizes.    GGM
+00063c00: 4c5f 4153 5345 5254 286e 6230 3020 3d3d  L_ASSERT(nb00 ==
+00063c10: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00063c20: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00063c30: 286e 6231 3020 3d3d 2073 697a 656f 6628  (nb10 == sizeof(
+00063c40: 666c 6f61 7429 293b 0a0a 2020 2020 6966  float));..    if
+00063c50: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00063c60: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00063c70: 2920 7b0a 2020 2020 2020 2020 2f2f 2054  ) {.        // T
+00063c80: 4f44 4f3a 2066 6978 2074 6869 7320 6d65  ODO: fix this me
+00063c90: 6d73 6574 2028 7773 697a 6520 6973 206f  mset (wsize is o
+00063ca0: 7665 7265 7374 696d 6174 6564 290a 2020  verestimated).  
+00063cb0: 2020 2020 2020 6d65 6d73 6574 2870 6172        memset(par
+00063cc0: 616d 732d 3e77 6461 7461 2c20 302c 2070  ams->wdata, 0, p
+00063cd0: 6172 616d 732d 3e77 7369 7a65 293b 0a0a  arams->wsize);..
+00063ce0: 2020 2020 2020 2020 2f2f 2070 7265 7061          // prepa
+00063cf0: 7265 206b 6572 6e65 6c20 6461 7461 2028  re kernel data (
+00063d00: 7372 6330 290a 2020 2020 2020 2020 7b0a  src0).        {.
+00063d10: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+00063d20: 7420 2a20 636f 6e73 7420 7764 6174 6120  t * const wdata 
+00063d30: 3d20 2866 6c6f 6174 202a 2920 7061 7261  = (float *) para
+00063d40: 6d73 2d3e 7764 6174 6120 2b20 303b 0a0a  ms->wdata + 0;..
+00063d50: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00063d60: 2869 6e74 3634 5f74 2069 3032 203d 2030  (int64_t i02 = 0
+00063d70: 3b20 6930 3220 3c20 6e65 3032 3b20 6930  ; i02 < ne02; i0
+00063d80: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
+00063d90: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00063da0: 345f 7420 6930 3120 3d20 303b 2069 3031  4_t i01 = 0; i01
+00063db0: 203c 206e 6530 313b 2069 3031 2b2b 2920   < ne01; i01++) 
+00063dc0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00063dd0: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+00063de0: 7420 2a20 636f 6e73 7420 7372 6320 3d20  t * const src = 
+00063df0: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
+00063e00: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+00063e10: 6930 322a 6e62 3032 202b 2069 3031 2a6e  i02*nb02 + i01*n
+00063e20: 6230 3129 3b0a 2020 2020 2020 2020 2020  b01);.          
+00063e30: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00063e40: 2a20 6473 745f 6461 7461 203d 2077 6461  * dst_data = wda
+00063e50: 7461 202b 2069 3032 2a65 7730 2a6e 6530  ta + i02*ew0*ne0
+00063e60: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+00063e70: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00063e80: 345f 7420 6930 3020 3d20 303b 2069 3030  4_t i00 = 0; i00
+00063e90: 203c 206e 6530 303b 2069 3030 2b2b 2920   < ne00; i00++) 
+00063ea0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00063eb0: 2020 2020 2020 2020 2020 6473 745f 6461            dst_da
+00063ec0: 7461 5b69 3030 2a65 7730 202b 2069 3031  ta[i00*ew0 + i01
+00063ed0: 5d20 3d20 7372 635b 6930 305d 3b0a 2020  ] = src[i00];.  
+00063ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063ef0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00063f00: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00063f10: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
+00063f20: 2020 2020 2020 202f 2f20 7072 6570 6172         // prepar
+00063f30: 6520 736f 7572 6365 2064 6174 6120 2873  e source data (s
+00063f40: 7263 3129 0a20 2020 2020 2020 207b 0a20  rc1).        {. 
+00063f50: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+00063f60: 202a 2063 6f6e 7374 2077 6461 7461 203d   * const wdata =
+00063f70: 2028 666c 6f61 7420 2a29 2070 6172 616d   (float *) param
+00063f80: 732d 3e77 6461 7461 202b 206e 6530 322a  s->wdata + ne02*
+00063f90: 6577 302a 6e65 3030 3b0a 0a20 2020 2020  ew0*ne00;..     
+00063fa0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00063fb0: 345f 7420 6931 3120 3d20 303b 2069 3131  4_t i11 = 0; i11
+00063fc0: 203c 206e 6531 313b 2069 3131 2b2b 2920   < ne11; i11++) 
+00063fd0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00063fe0: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
+00063ff0: 636f 6e73 7420 7372 6320 3d20 2866 6c6f  const src = (flo
+00064000: 6174 202a 2928 2863 6861 7220 2a29 2073  at *)((char *) s
+00064010: 7263 312d 3e64 6174 6120 2b20 6931 312a  rc1->data + i11*
+00064020: 6e62 3131 293b 0a20 2020 2020 2020 2020  nb11);.         
+00064030: 2020 2020 2020 2066 6c6f 6174 202a 2064         float * d
+00064040: 7374 5f64 6174 6120 3d20 7764 6174 613b  st_data = wdata;
+00064050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00064060: 2066 6f72 2028 696e 7436 345f 7420 6931   for (int64_t i1
+00064070: 3020 3d20 303b 2069 3130 203c 206e 6531  0 = 0; i10 < ne1
+00064080: 303b 2069 3130 2b2b 2920 7b0a 2020 2020  0; i10++) {.    
 00064090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000640a0: 666f 7220 2869 6e74 3634 5f74 2069 3130  for (int64_t i10
-000640b0: 203d 2030 3b20 6931 3020 3c20 6e65 3130   = 0; i10 < ne10
-000640c0: 3b20 6931 302b 2b29 207b 0a20 2020 2020  ; i10++) {.     
-000640d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000640e0: 7374 5f64 6174 615b 2869 3130 202b 206e  st_data[(i10 + n
-000640f0: 6829 2a65 7730 202b 2069 3131 5d20 3d20  h)*ew0 + i11] = 
-00064100: 7372 635b 6931 305d 3b0a 2020 2020 2020  src[i10];.      
-00064110: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00064120: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00064130: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
-00064140: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00064150: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-00064160: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-00064170: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-00064180: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-00064190: 0a20 2020 202f 2f20 746f 7461 6c20 726f  .    // total ro
-000641a0: 7773 2069 6e20 6473 740a 2020 2020 636f  ws in dst.    co
-000641b0: 6e73 7420 696e 7420 6e72 203d 206e 6530  nst int nr = ne0
-000641c0: 323b 0a0a 2020 2020 2f2f 2072 6f77 7320  2;..    // rows 
-000641d0: 7065 7220 7468 7265 6164 0a20 2020 2063  per thread.    c
-000641e0: 6f6e 7374 2069 6e74 2064 7220 3d20 286e  onst int dr = (n
-000641f0: 7220 2b20 6e74 6820 2d20 3129 2f6e 7468  r + nth - 1)/nth
-00064200: 3b0a 0a20 2020 202f 2f20 726f 7720 7261  ;..    // row ra
-00064210: 6e67 6520 666f 7220 7468 6973 2074 6872  nge for this thr
-00064220: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
-00064230: 7420 6972 3020 3d20 6472 2a69 7468 3b0a  t ir0 = dr*ith;.
-00064240: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
-00064250: 3120 3d20 4d49 4e28 6972 3020 2b20 6472  1 = MIN(ir0 + dr
-00064260: 2c20 6e72 293b 0a0a 2020 2020 666f 7220  , nr);..    for 
-00064270: 2869 6e74 2069 3120 3d20 6972 303b 2069  (int i1 = ir0; i
-00064280: 3120 3c20 6972 313b 2069 312b 2b29 207b  1 < ir1; i1++) {
-00064290: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
-000642a0: 2064 7374 5f64 6174 6120 3d20 2866 6c6f   dst_data = (flo
-000642b0: 6174 202a 2928 2863 6861 7220 2a29 2064  at *)((char *) d
-000642c0: 7374 2d3e 6461 7461 202b 2069 312a 6e62  st->data + i1*nb
-000642d0: 3129 3b0a 2020 2020 2020 2020 666f 7220  1);.        for 
-000642e0: 2869 6e74 3634 5f74 2069 3020 3d20 303b  (int64_t i0 = 0;
-000642f0: 2069 3020 3c20 6e65 3130 3b20 6930 202b   i0 < ne10; i0 +
-00064300: 3d20 3229 207b 0a20 2020 2020 2020 2020  = 2) {.         
-00064310: 2020 2064 7374 5f64 6174 615b 6930 2f32     dst_data[i0/2
-00064320: 5d20 3d20 303b 0a20 2020 2020 2020 2020  ] = 0;.         
-00064330: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
-00064340: 2d6e 683b 206b 203c 3d20 6e68 3b20 6b2b  -nh; k <= nh; k+
-00064350: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00064360: 2020 2020 2066 6c6f 6174 2076 203d 2030       float v = 0
-00064370: 2e30 663b 0a20 2020 2020 2020 2020 2020  .0f;.           
-00064380: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
-00064390: 745f 6633 3228 6577 302c 2026 762c 0a20  t_f32(ew0, &v,. 
-000643a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000643b0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-000643c0: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
-000643d0: 2020 2069 312a 6577 302a 6e65 3030 202b     i1*ew0*ne00 +
-000643e0: 2020 2020 2020 286e 6820 2b20 6b29 2a65        (nh + k)*e
-000643f0: 7730 2c0a 2020 2020 2020 2020 2020 2020  w0,.            
-00064400: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
-00064410: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
-00064420: 6174 6120 2b20 6e65 3032 2a65 7730 2a6e  ata + ne02*ew0*n
-00064430: 6530 3020 2b20 2869 3020 2b20 6e68 202b  e00 + (i0 + nh +
-00064440: 206b 292a 6577 3029 3b0a 0a20 2020 2020   k)*ew0);..     
-00064450: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
-00064460: 6174 615b 6930 2f32 5d20 2b3d 2076 3b0a  ata[i0/2] += v;.
-00064470: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00064480: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
-00064490: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-000644a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000644b0: 645f 636f 6e76 5f31 645f 3273 280a 2020  d_conv_1d_2s(.  
-000644c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000644d0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-000644e0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-000644f0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00064500: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00064510: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00064520: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00064530: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00064540: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
-00064550: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00064560: 6473 7429 207b 0a20 2020 2073 7769 7463  dst) {.    switc
-00064570: 6820 2873 7263 302d 3e74 7970 6529 207b  h (src0->type) {
-00064580: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00064590: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
-000645a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000645b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000645c0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000645d0: 636f 6e76 5f31 645f 3273 5f66 3136 5f66  conv_1d_2s_f16_f
-000645e0: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-000645f0: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-00064600: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00064610: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00064620: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
-00064630: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00064640: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00064650: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00064660: 5f63 6f6e 765f 3164 5f32 735f 6633 3228  _conv_1d_2s_f32(
-00064670: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-00064680: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-00064690: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000646a0: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
-000646b0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000646c0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-000646d0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-000646e0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000646f0: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-00064700: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
-00064710: 666f 7277 6172 645f 666c 6173 685f 6174  forward_flash_at
-00064720: 746e 0a0a 7374 6174 6963 2076 6f69 6420  tn..static void 
-00064730: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00064740: 7761 7264 5f66 6c61 7368 5f61 7474 6e5f  ward_flash_attn_
-00064750: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
-00064760: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00064770: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-00064780: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00064790: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000647a0: 6c5f 7465 6e73 6f72 202a 2071 2c0a 2020  l_tensor * q,.  
-000647b0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000647c0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000647d0: 206b 2c0a 2020 2020 2020 2020 636f 6e73   k,.        cons
-000647e0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000647f0: 6e73 6f72 202a 2076 2c0a 2020 2020 2020  nsor * v,.      
-00064800: 2020 636f 6e73 7420 626f 6f6c 206d 6173    const bool mas
-00064810: 6b65 642c 0a20 2020 2020 2020 2020 2020  ked,.           
-00064820: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00064830: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00064840: 2020 696e 7436 345f 7420 7430 203d 2067    int64_t t0 = g
-00064850: 676d 6c5f 7065 7266 5f74 696d 655f 7573  gml_perf_time_us
-00064860: 2829 3b0a 2020 2020 554e 5553 4544 2874  ();.    UNUSED(t
-00064870: 3029 3b0a 0a20 2020 2063 6f6e 7374 2069  0);..    const i
-00064880: 6e74 3634 5f74 206e 6571 3020 3d20 712d  nt64_t neq0 = q-
-00064890: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-000648a0: 7420 696e 7436 345f 7420 6e65 7131 203d  t int64_t neq1 =
-000648b0: 2071 2d3e 6e65 5b31 5d3b 0a20 2020 2063   q->ne[1];.    c
-000648c0: 6f6e 7374 2069 6e74 3634 5f74 206e 6571  onst int64_t neq
-000648d0: 3220 3d20 712d 3e6e 655b 325d 3b0a 2020  2 = q->ne[2];.  
-000648e0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000648f0: 6e65 7133 203d 2071 2d3e 6e65 5b33 5d3b  neq3 = q->ne[3];
-00064900: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-00064910: 345f 7420 6e65 6b30 203d 206b 2d3e 6e65  4_t nek0 = k->ne
-00064920: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-00064930: 6e74 3634 5f74 206e 656b 3120 3d20 6b2d  nt64_t nek1 = k-
-00064940: 3e6e 655b 315d 3b0a 2020 2020 2f2f 636f  >ne[1];.    //co
-00064950: 6e73 7420 696e 7436 345f 7420 6e65 6b32  nst int64_t nek2
-00064960: 203d 206b 2d3e 6e65 5b32 5d3b 0a20 2020   = k->ne[2];.   
-00064970: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-00064980: 206e 656b 3320 3d20 6b2d 3e6e 655b 335d   nek3 = k->ne[3]
-00064990: 3b0a 0a20 2020 202f 2f63 6f6e 7374 2069  ;..    //const i
-000649a0: 6e74 3634 5f74 206e 6576 3020 3d20 762d  nt64_t nev0 = v-
-000649b0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-000649c0: 7420 696e 7436 345f 7420 6e65 7631 203d  t int64_t nev1 =
-000649d0: 2076 2d3e 6e65 5b31 5d3b 0a20 2020 202f   v->ne[1];.    /
-000649e0: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-000649f0: 6576 3220 3d20 762d 3e6e 655b 325d 3b0a  ev2 = v->ne[2];.
-00064a00: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
-00064a10: 345f 7420 6e65 7633 203d 2076 2d3e 6e65  4_t nev3 = v->ne
-00064a20: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-00064a30: 696e 7436 345f 7420 6e65 3020 203d 2064  int64_t ne0  = d
-00064a40: 7374 2d3e 6e65 5b30 5d3b 0a20 2020 2063  st->ne[0];.    c
-00064a50: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-00064a60: 2020 3d20 6473 742d 3e6e 655b 315d 3b0a    = dst->ne[1];.
-00064a70: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
-00064a80: 345f 7420 6e65 3220 203d 2064 7374 2d3e  4_t ne2  = dst->
-00064a90: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
-00064aa0: 7374 2069 6e74 3634 5f74 206e 6533 2020  st int64_t ne3  
-00064ab0: 3d20 6473 742d 3e6e 655b 335d 3b0a 0a20  = dst->ne[3];.. 
-00064ac0: 2020 2063 6f6e 7374 2069 6e74 206e 626b     const int nbk
-00064ad0: 3020 3d20 6b2d 3e6e 625b 305d 3b0a 2020  0 = k->nb[0];.  
-00064ae0: 2020 636f 6e73 7420 696e 7420 6e62 6b31    const int nbk1
-00064af0: 203d 206b 2d3e 6e62 5b31 5d3b 0a20 2020   = k->nb[1];.   
-00064b00: 2063 6f6e 7374 2069 6e74 206e 626b 3220   const int nbk2 
-00064b10: 3d20 6b2d 3e6e 625b 325d 3b0a 2020 2020  = k->nb[2];.    
-00064b20: 636f 6e73 7420 696e 7420 6e62 6b33 203d  const int nbk3 =
-00064b30: 206b 2d3e 6e62 5b33 5d3b 0a0a 2020 2020   k->nb[3];..    
-00064b40: 636f 6e73 7420 696e 7420 6e62 7130 203d  const int nbq0 =
-00064b50: 2071 2d3e 6e62 5b30 5d3b 0a20 2020 2063   q->nb[0];.    c
-00064b60: 6f6e 7374 2069 6e74 206e 6271 3120 3d20  onst int nbq1 = 
-00064b70: 712d 3e6e 625b 315d 3b0a 2020 2020 636f  q->nb[1];.    co
-00064b80: 6e73 7420 696e 7420 6e62 7132 203d 2071  nst int nbq2 = q
-00064b90: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-00064ba0: 7374 2069 6e74 206e 6271 3320 3d20 712d  st int nbq3 = q-
-00064bb0: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-00064bc0: 7374 2069 6e74 206e 6276 3020 3d20 762d  st int nbv0 = v-
-00064bd0: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-00064be0: 7420 696e 7420 6e62 7631 203d 2076 2d3e  t int nbv1 = v->
-00064bf0: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-00064c00: 2069 6e74 206e 6276 3220 3d20 762d 3e6e   int nbv2 = v->n
-00064c10: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-00064c20: 696e 7420 6e62 7633 203d 2076 2d3e 6e62  int nbv3 = v->nb
-00064c30: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-00064c40: 696e 7420 6e62 3020 203d 2064 7374 2d3e  int nb0  = dst->
-00064c50: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-00064c60: 2069 6e74 206e 6231 2020 3d20 6473 742d   int nb1  = dst-
-00064c70: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-00064c80: 7420 696e 7420 6e62 3220 203d 2064 7374  t int nb2  = dst
-00064c90: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-00064ca0: 7374 2069 6e74 206e 6233 2020 3d20 6473  st int nb3  = ds
-00064cb0: 742d 3e6e 625b 335d 3b0a 0a20 2020 2063  t->nb[3];..    c
-00064cc0: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
-00064cd0: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
-00064ce0: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
-00064cf0: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
-00064d00: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00064d10: 4420 3d20 6e65 7130 3b0a 2020 2020 636f  D = neq0;.    co
-00064d20: 6e73 7420 696e 7436 345f 7420 4e20 3d20  nst int64_t N = 
-00064d30: 6e65 7131 3b0a 2020 2020 636f 6e73 7420  neq1;.    const 
-00064d40: 696e 7436 345f 7420 5020 3d20 6e65 6b31  int64_t P = nek1
-00064d50: 202d 204e 3b0a 2020 2020 636f 6e73 7420   - N;.    const 
-00064d60: 696e 7436 345f 7420 4d20 3d20 5020 2b20  int64_t M = P + 
-00064d70: 4e3b 0a0a 2020 2020 636f 6e73 7420 696e  N;..    const in
-00064d80: 7420 4d75 7020 3d20 6767 6d6c 5f75 7028  t Mup = ggml_up(
-00064d90: 4d2c 2047 474d 4c5f 534f 4654 5f4d 4158  M, GGML_SOFT_MAX
-00064da0: 5f55 4e52 4f4c 4c29 3b0a 0a20 2020 2047  _UNROLL);..    G
-00064db0: 474d 4c5f 4153 5345 5254 286e 6530 203d  GML_ASSERT(ne0 =
-00064dc0: 3d20 4429 3b0a 2020 2020 4747 4d4c 5f41  = D);.    GGML_A
-00064dd0: 5353 4552 5428 6e65 3120 3d3d 204e 293b  SSERT(ne1 == N);
-00064de0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00064df0: 2850 203e 3d20 3029 3b0a 0a20 2020 2047  (P >= 0);..    G
-00064e00: 474d 4c5f 4153 5345 5254 286e 6271 3020  GML_ASSERT(nbq0 
-00064e10: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-00064e20: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00064e30: 5254 286e 626b 3020 3d3d 2073 697a 656f  RT(nbk0 == sizeo
-00064e40: 6628 666c 6f61 7429 293b 0a20 2020 2047  f(float));.    G
-00064e50: 474d 4c5f 4153 5345 5254 286e 6276 3020  GML_ASSERT(nbv0 
-00064e60: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-00064e70: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
-00064e80: 4552 5428 6e65 7130 203d 3d20 4429 3b0a  ERT(neq0 == D);.
-00064e90: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00064ea0: 6e65 6b30 203d 3d20 4429 3b0a 2020 2020  nek0 == D);.    
-00064eb0: 4747 4d4c 5f41 5353 4552 5428 6e65 7631  GGML_ASSERT(nev1
-00064ec0: 203d 3d20 4429 3b0a 0a20 2020 2047 474d   == D);..    GGM
-00064ed0: 4c5f 4153 5345 5254 286e 6571 3120 3d3d  L_ASSERT(neq1 ==
-00064ee0: 204e 293b 0a20 2020 2047 474d 4c5f 4153   N);.    GGML_AS
-00064ef0: 5345 5254 286e 656b 3120 3d3d 204e 202b  SERT(nek1 == N +
-00064f00: 2050 293b 0a20 2020 2047 474d 4c5f 4153   P);.    GGML_AS
-00064f10: 5345 5254 286e 6576 3120 3d3d 2044 293b  SERT(nev1 == D);
-00064f20: 0a0a 2020 2020 2f2f 2064 7374 2063 616e  ..    // dst can
-00064f30: 6e6f 7420 6265 2074 7261 6e73 706f 7365  not be transpose
-00064f40: 6420 6f72 2070 6572 6d75 7465 640a 2020  d or permuted.  
-00064f50: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-00064f60: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-00064f70: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
-00064f80: 5345 5254 286e 6230 203c 3d20 6e62 3129  SERT(nb0 <= nb1)
-00064f90: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00064fa0: 5428 6e62 3120 3c3d 206e 6232 293b 0a20  T(nb1 <= nb2);. 
-00064fb0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00064fc0: 6232 203c 3d20 6e62 3329 3b0a 0a20 2020  b2 <= nb3);..   
-00064fd0: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00064fe0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-00064ff0: 4e49 5429 207b 0a20 2020 2020 2020 2072  NIT) {.        r
-00065000: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-00065010: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-00065020: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00065030: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-00065040: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00065050: 7d0a 0a20 2020 202f 2f20 7061 7261 6c6c  }..    // parall
-00065060: 656c 697a 6520 6279 2071 2072 6f77 7320  elize by q rows 
-00065070: 7573 696e 6720 6767 6d6c 5f76 6563 5f64  using ggml_vec_d
-00065080: 6f74 5f66 3332 0a0a 2020 2020 2f2f 2074  ot_f32..    // t
-00065090: 6f74 616c 2072 6f77 7320 696e 2071 0a20  otal rows in q. 
-000650a0: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
-000650b0: 3d20 6e65 7131 2a6e 6571 322a 6e65 7133  = neq1*neq2*neq3
-000650c0: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
-000650d0: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
-000650e0: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
-000650f0: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
-00065100: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
-00065110: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
-00065120: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-00065130: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
-00065140: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
-00065150: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
-00065160: 206e 7229 3b0a 0a20 2020 2063 6f6e 7374   nr);..    const
-00065170: 2066 6c6f 6174 2073 6361 6c65 203d 2031   float scale = 1
-00065180: 2e30 662f 7371 7274 6628 4429 3b0a 0a20  .0f/sqrtf(D);.. 
-00065190: 2020 202f 2f70 7269 6e74 6628 2250 3d25     //printf("P=%
-000651a0: 6420 4e3d 2564 2044 3d25 6420 6972 303d  d N=%d D=%d ir0=
-000651b0: 2564 2069 7231 3d25 6420 7363 616c 6520  %d ir1=%d scale 
-000651c0: 3d20 2566 5c6e 222c 2050 2c20 4e2c 2044  = %f\n", P, N, D
-000651d0: 2c20 6972 302c 2069 7231 2c20 7363 616c  , ir0, ir1, scal
-000651e0: 6529 3b0a 0a20 2020 2066 6f72 2028 696e  e);..    for (in
-000651f0: 7420 6972 203d 2069 7230 3b20 6972 203c  t ir = ir0; ir <
-00065200: 2069 7231 3b20 2b2b 6972 2920 7b0a 2020   ir1; ++ir) {.  
-00065210: 2020 2020 2020 2f2f 2071 2069 6e64 6963        // q indic
-00065220: 6573 0a20 2020 2020 2020 2063 6f6e 7374  es.        const
-00065230: 2069 6e74 2069 7133 203d 2069 722f 286e   int iq3 = ir/(n
-00065240: 6571 322a 6e65 7131 293b 0a20 2020 2020  eq2*neq1);.     
-00065250: 2020 2063 6f6e 7374 2069 6e74 2069 7132     const int iq2
-00065260: 203d 2028 6972 202d 2069 7133 2a6e 6571   = (ir - iq3*neq
-00065270: 322a 6e65 7131 292f 6e65 7131 3b0a 2020  2*neq1)/neq1;.  
-00065280: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00065290: 6971 3120 3d20 2869 7220 2d20 6971 332a  iq1 = (ir - iq3*
-000652a0: 6e65 7132 2a6e 6571 3120 2d20 6971 322a  neq2*neq1 - iq2*
-000652b0: 6e65 7131 293b 0a0a 2020 2020 2020 2020  neq1);..        
-000652c0: 666c 6f61 7420 2a20 5320 3d20 2866 6c6f  float * S = (flo
-000652d0: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
-000652e0: 6174 6120 2b20 6974 682a 284d 7570 202b  ata + ith*(Mup +
-000652f0: 2043 4143 4845 5f4c 494e 455f 5349 5a45   CACHE_LINE_SIZE
-00065300: 5f46 3332 293b 0a0a 2020 2020 2020 2020  _F32);..        
-00065310: 666f 7220 2869 6e74 2069 203d 204d 3b20  for (int i = M; 
-00065320: 6920 3c20 4d75 703b 202b 2b69 2920 7b0a  i < Mup; ++i) {.
-00065330: 2020 2020 2020 2020 2020 2020 535b 695d              S[i]
-00065340: 203d 202d 494e 4649 4e49 5459 3b0a 2020   = -INFINITY;.  
-00065350: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00065360: 2066 6f72 2028 696e 7436 345f 7420 6963   for (int64_t ic
-00065370: 203d 2030 3b20 6963 203c 206e 656b 313b   = 0; ic < nek1;
-00065380: 202b 2b69 6329 207b 0a20 2020 2020 2020   ++ic) {.       
-00065390: 2020 2020 202f 2f20 6b20 696e 6469 6365       // k indice
-000653a0: 730a 2020 2020 2020 2020 2020 2020 636f  s.            co
-000653b0: 6e73 7420 696e 7420 696b 3320 3d20 6971  nst int ik3 = iq
-000653c0: 333b 0a20 2020 2020 2020 2020 2020 2063  3;.            c
-000653d0: 6f6e 7374 2069 6e74 2069 6b32 203d 2069  onst int ik2 = i
-000653e0: 7132 3b0a 2020 2020 2020 2020 2020 2020  q2;.            
-000653f0: 636f 6e73 7420 696e 7420 696b 3120 3d20  const int ik1 = 
-00065400: 6963 3b0a 0a20 2020 2020 2020 2020 2020  ic;..           
-00065410: 202f 2f20 5320 696e 6469 6365 730a 2020   // S indices.  
-00065420: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00065430: 696e 7420 6931 203d 2069 6b31 3b0a 0a20  int i1 = ik1;.. 
-00065440: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00065450: 7665 635f 646f 745f 6633 3228 6e65 7130  vec_dot_f32(neq0
-00065460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00065470: 2020 2020 2020 5320 2b20 6931 2c0a 2020        S + i1,.  
-00065480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065490: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-000654a0: 6172 202a 2920 6b2d 3e64 6174 6120 2b20  ar *) k->data + 
-000654b0: 2869 6b31 2a6e 626b 3120 2b20 696b 322a  (ik1*nbk1 + ik2*
-000654c0: 6e62 6b32 202b 2069 6b33 2a6e 626b 3329  nbk2 + ik3*nbk3)
-000654d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000654e0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-000654f0: 2028 2863 6861 7220 2a29 2071 2d3e 6461   ((char *) q->da
-00065500: 7461 202b 2028 6971 312a 6e62 7131 202b  ta + (iq1*nbq1 +
-00065510: 2069 7132 2a6e 6271 3220 2b20 6971 332a   iq2*nbq2 + iq3*
-00065520: 6e62 7133 2929 293b 0a20 2020 2020 2020  nbq3)));.       
-00065530: 207d 0a0a 2020 2020 2020 2020 2f2f 2073   }..        // s
-00065540: 6361 6c65 0a20 2020 2020 2020 2067 676d  cale.        ggm
-00065550: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
-00065560: 6e65 6b31 2c20 532c 2073 6361 6c65 293b  nek1, S, scale);
-00065570: 0a0a 2020 2020 2020 2020 6966 2028 6d61  ..        if (ma
-00065580: 736b 6564 2920 7b0a 2020 2020 2020 2020  sked) {.        
-00065590: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-000655a0: 2069 203d 2050 3b20 6920 3c20 4d3b 2069   i = P; i < M; i
-000655b0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-000655c0: 2020 2020 2020 6966 2028 6920 3e20 5020        if (i > P 
-000655d0: 2b20 6971 3129 207b 0a20 2020 2020 2020  + iq1) {.       
-000655e0: 2020 2020 2020 2020 2020 2020 2053 5b69               S[i
-000655f0: 5d20 3d20 2d49 4e46 494e 4954 593b 0a20  ] = -INFINITY;. 
-00065600: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00065610: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00065620: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00065630: 2020 2f2f 2073 6f66 746d 6178 0a20 2020    // softmax.   
-00065640: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00065650: 2020 2066 6c6f 6174 206d 6178 203d 202d     float max = -
-00065660: 494e 4649 4e49 5459 3b0a 2020 2020 2020  INFINITY;.      
-00065670: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
-00065680: 6178 5f66 3332 284d 2c20 266d 6178 2c20  ax_f32(M, &max, 
-00065690: 5329 3b0a 0a20 2020 2020 2020 2020 2020  S);..           
-000656a0: 2067 676d 6c5f 666c 6f61 7420 7375 6d20   ggml_float sum 
-000656b0: 3d20 302e 303b 0a20 2020 2020 2020 2020  = 0.0;.         
-000656c0: 2020 207b 0a23 6966 6465 6620 4747 4d4c     {.#ifdef GGML
-000656d0: 5f53 4f46 545f 4d41 585f 4143 4345 4c45  _SOFT_MAX_ACCELE
-000656e0: 5241 5445 0a20 2020 2020 2020 2020 2020  RATE.           
-000656f0: 2020 2020 206d 6178 203d 202d 6d61 783b       max = -max;
-00065700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00065710: 2076 4453 505f 7673 6164 6428 532c 2031   vDSP_vsadd(S, 1
-00065720: 2c20 266d 6178 2c20 532c 2031 2c20 4d75  , &max, S, 1, Mu
-00065730: 7029 3b0a 2020 2020 2020 2020 2020 2020  p);.            
-00065740: 2020 2020 7676 6578 7066 2853 2c20 532c      vvexpf(S, S,
-00065750: 2026 4d75 7029 3b0a 2020 2020 2020 2020   &Mup);.        
-00065760: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-00065770: 5f73 756d 5f66 3332 284d 7570 2c20 2673  _sum_f32(Mup, &s
-00065780: 756d 2c20 5329 3b0a 2365 6c73 650a 2020  um, S);.#else.  
-00065790: 2020 2020 2020 2020 2020 2020 2020 7569                ui
-000657a0: 6e74 3136 5f74 2020 2073 6376 745b 4747  nt16_t   scvt[GG
-000657b0: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
-000657c0: 4c4c 5d3b 0a20 2020 2020 2020 2020 2020  LL];.           
-000657d0: 2020 2020 2067 676d 6c5f 666c 6f61 7420       ggml_float 
-000657e0: 7375 6d70 5b47 474d 4c5f 534f 4654 5f4d  sump[GGML_SOFT_M
-000657f0: 4158 5f55 4e52 4f4c 4c5d 203d 207b 2030  AX_UNROLL] = { 0
-00065800: 2e30 207d 3b0a 0a20 2020 2020 2020 2020  .0 };..         
-00065810: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00065820: 6920 3d20 303b 2069 203c 204d 7570 3b20  i = 0; i < Mup; 
-00065830: 6920 2b3d 2047 474d 4c5f 534f 4654 5f4d  i += GGML_SOFT_M
-00065840: 4158 5f55 4e52 4f4c 4c29 207b 0a20 2020  AX_UNROLL) {.   
-00065850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065860: 2066 6c6f 6174 202a 2053 5320 3d20 5320   float * SS = S 
-00065870: 2b20 693b 0a0a 2020 2020 2020 2020 2020  + i;..          
-00065880: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00065890: 6e74 206a 203d 2030 3b20 6a20 3c20 4747  nt j = 0; j < GG
-000658a0: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
-000658b0: 4c4c 3b20 2b2b 6a29 207b 0a20 2020 2020  LL; ++j) {.     
-000658c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000658d0: 2020 2069 6620 2853 535b 6a5d 203d 3d20     if (SS[j] == 
-000658e0: 2d49 4e46 494e 4954 5929 207b 0a20 2020  -INFINITY) {.   
-000658f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065900: 2020 2020 2020 2020 2053 535b 6a5d 203d           SS[j] =
-00065910: 2030 2e30 663b 0a20 2020 2020 2020 2020   0.0f;.         
-00065920: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00065930: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-00065940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065950: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-00065960: 7320 3d20 4747 4d4c 5f46 5033 325f 544f  s = GGML_FP32_TO
-00065970: 5f46 5031 3628 5353 5b6a 5d20 2d20 6d61  _FP16(SS[j] - ma
-00065980: 7829 3b0a 2020 2020 2020 2020 2020 2020  x);.            
+000640a0: 6473 745f 6461 7461 5b28 6931 3020 2b20  dst_data[(i10 + 
+000640b0: 6e68 292a 6577 3020 2b20 6931 315d 203d  nh)*ew0 + i11] =
+000640c0: 2073 7263 5b69 3130 5d3b 0a20 2020 2020   src[i10];.     
+000640d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000640e0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000640f0: 2020 207d 0a0a 2020 2020 2020 2020 7265     }..        re
+00064100: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+00064110: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+00064120: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+00064130: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+00064140: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+00064150: 0a0a 2020 2020 2f2f 2074 6f74 616c 2072  ..    // total r
+00064160: 6f77 7320 696e 2064 7374 0a20 2020 2063  ows in dst.    c
+00064170: 6f6e 7374 2069 6e74 206e 7220 3d20 6e65  onst int nr = ne
+00064180: 3032 3b0a 0a20 2020 202f 2f20 726f 7773  02;..    // rows
+00064190: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
+000641a0: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
+000641b0: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
+000641c0: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
+000641d0: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
+000641e0: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+000641f0: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
+00064200: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+00064210: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
+00064220: 722c 206e 7229 3b0a 0a20 2020 2066 6f72  r, nr);..    for
+00064230: 2028 696e 7420 6931 203d 2069 7230 3b20   (int i1 = ir0; 
+00064240: 6931 203c 2069 7231 3b20 6931 2b2b 2920  i1 < ir1; i1++) 
+00064250: 7b0a 2020 2020 2020 2020 666c 6f61 7420  {.        float 
+00064260: 2a20 6473 745f 6461 7461 203d 2028 666c  * dst_data = (fl
+00064270: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
+00064280: 6473 742d 3e64 6174 6120 2b20 6931 2a6e  dst->data + i1*n
+00064290: 6231 293b 0a20 2020 2020 2020 2066 6f72  b1);.        for
+000642a0: 2028 696e 7436 345f 7420 6930 203d 2030   (int64_t i0 = 0
+000642b0: 3b20 6930 203c 206e 6531 303b 2069 3020  ; i0 < ne10; i0 
+000642c0: 2b3d 2032 2920 7b0a 2020 2020 2020 2020  += 2) {.        
+000642d0: 2020 2020 6473 745f 6461 7461 5b69 302f      dst_data[i0/
+000642e0: 325d 203d 2030 3b0a 2020 2020 2020 2020  2] = 0;.        
+000642f0: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
+00064300: 202d 6e68 3b20 6b20 3c3d 206e 683b 206b   -nh; k <= nh; k
+00064310: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00064320: 2020 2020 2020 666c 6f61 7420 7620 3d20        float v = 
+00064330: 302e 3066 3b0a 2020 2020 2020 2020 2020  0.0f;.          
+00064340: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
+00064350: 6f74 5f66 3332 2865 7730 2c20 2676 2c0a  ot_f32(ew0, &v,.
+00064360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00064370: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+00064380: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
+00064390: 2b20 2020 6931 2a65 7730 2a6e 6530 3020  +   i1*ew0*ne00 
+000643a0: 2b20 2020 2020 2028 6e68 202b 206b 292a  +      (nh + k)*
+000643b0: 6577 302c 0a20 2020 2020 2020 2020 2020  ew0,.           
+000643c0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+000643d0: 6f61 7420 2a29 2070 6172 616d 732d 3e77  oat *) params->w
+000643e0: 6461 7461 202b 206e 6530 322a 6577 302a  data + ne02*ew0*
+000643f0: 6e65 3030 202b 2028 6930 202b 206e 6820  ne00 + (i0 + nh 
+00064400: 2b20 6b29 2a65 7730 293b 0a0a 2020 2020  + k)*ew0);..    
+00064410: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
+00064420: 6461 7461 5b69 302f 325d 202b 3d20 763b  data[i0/2] += v;
+00064430: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00064440: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+00064450: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00064460: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00064470: 7264 5f63 6f6e 765f 3164 5f32 7328 0a20  rd_conv_1d_2s(. 
+00064480: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00064490: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+000644a0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+000644b0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+000644c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000644d0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+000644e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000644f0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00064500: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+00064510: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00064520: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
+00064530: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
+00064540: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
+00064550: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
+00064560: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00064570: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00064580: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00064590: 5f63 6f6e 765f 3164 5f32 735f 6631 365f  _conv_1d_2s_f16_
+000645a0: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+000645b0: 2c20 7372 6331 2c20 6473 7429 3b0a 2020  , src1, dst);.  
+000645c0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+000645d0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+000645e0: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
+000645f0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00064600: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00064610: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00064620: 645f 636f 6e76 5f31 645f 3273 5f66 3332  d_conv_1d_2s_f32
+00064630: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+00064640: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+00064650: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00064660: 2020 2020 2020 2020 6465 6661 756c 743a          default:
+00064670: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00064680: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00064690: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+000646a0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000646b0: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+000646c0: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+000646d0: 5f66 6f72 7761 7264 5f66 6c61 7368 5f61  _forward_flash_a
+000646e0: 7474 6e0a 0a73 7461 7469 6320 766f 6964  ttn..static void
+000646f0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00064700: 7277 6172 645f 666c 6173 685f 6174 746e  rward_flash_attn
+00064710: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
+00064720: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00064730: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+00064740: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+00064750: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00064760: 6d6c 5f74 656e 736f 7220 2a20 712c 0a20  ml_tensor * q,. 
+00064770: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00064780: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00064790: 2a20 6b2c 0a20 2020 2020 2020 2063 6f6e  * k,.        con
+000647a0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000647b0: 656e 736f 7220 2a20 762c 0a20 2020 2020  ensor * v,.     
+000647c0: 2020 2063 6f6e 7374 2062 6f6f 6c20 6d61     const bool ma
+000647d0: 736b 6564 2c0a 2020 2020 2020 2020 2020  sked,.          
+000647e0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+000647f0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00064800: 2020 2069 6e74 3634 5f74 2074 3020 3d20     int64_t t0 = 
+00064810: 6767 6d6c 5f70 6572 665f 7469 6d65 5f75  ggml_perf_time_u
+00064820: 7328 293b 0a20 2020 2055 4e55 5345 4428  s();.    UNUSED(
+00064830: 7430 293b 0a0a 2020 2020 636f 6e73 7420  t0);..    const 
+00064840: 696e 7436 345f 7420 6e65 7130 203d 2071  int64_t neq0 = q
+00064850: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00064860: 7374 2069 6e74 3634 5f74 206e 6571 3120  st int64_t neq1 
+00064870: 3d20 712d 3e6e 655b 315d 3b0a 2020 2020  = q->ne[1];.    
+00064880: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00064890: 7132 203d 2071 2d3e 6e65 5b32 5d3b 0a20  q2 = q->ne[2];. 
+000648a0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+000648b0: 206e 6571 3320 3d20 712d 3e6e 655b 335d   neq3 = q->ne[3]
+000648c0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+000648d0: 3634 5f74 206e 656b 3020 3d20 6b2d 3e6e  64_t nek0 = k->n
+000648e0: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+000648f0: 696e 7436 345f 7420 6e65 6b31 203d 206b  int64_t nek1 = k
+00064900: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
+00064910: 6f6e 7374 2069 6e74 3634 5f74 206e 656b  onst int64_t nek
+00064920: 3220 3d20 6b2d 3e6e 655b 325d 3b0a 2020  2 = k->ne[2];.  
+00064930: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+00064940: 7420 6e65 6b33 203d 206b 2d3e 6e65 5b33  t nek3 = k->ne[3
+00064950: 5d3b 0a0a 2020 2020 2f2f 636f 6e73 7420  ];..    //const 
+00064960: 696e 7436 345f 7420 6e65 7630 203d 2076  int64_t nev0 = v
+00064970: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00064980: 7374 2069 6e74 3634 5f74 206e 6576 3120  st int64_t nev1 
+00064990: 3d20 762d 3e6e 655b 315d 3b0a 2020 2020  = v->ne[1];.    
+000649a0: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
+000649b0: 6e65 7632 203d 2076 2d3e 6e65 5b32 5d3b  nev2 = v->ne[2];
+000649c0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+000649d0: 3634 5f74 206e 6576 3320 3d20 762d 3e6e  64_t nev3 = v->n
+000649e0: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
+000649f0: 2069 6e74 3634 5f74 206e 6530 2020 3d20   int64_t ne0  = 
+00064a00: 6473 742d 3e6e 655b 305d 3b0a 2020 2020  dst->ne[0];.    
+00064a10: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00064a20: 3120 203d 2064 7374 2d3e 6e65 5b31 5d3b  1  = dst->ne[1];
+00064a30: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+00064a40: 3634 5f74 206e 6532 2020 3d20 6473 742d  64_t ne2  = dst-
+00064a50: 3e6e 655b 325d 3b0a 2020 2020 2f2f 636f  >ne[2];.    //co
+00064a60: 6e73 7420 696e 7436 345f 7420 6e65 3320  nst int64_t ne3 
+00064a70: 203d 2064 7374 2d3e 6e65 5b33 5d3b 0a0a   = dst->ne[3];..
+00064a80: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00064a90: 6b30 203d 206b 2d3e 6e62 5b30 5d3b 0a20  k0 = k->nb[0];. 
+00064aa0: 2020 2063 6f6e 7374 2069 6e74 206e 626b     const int nbk
+00064ab0: 3120 3d20 6b2d 3e6e 625b 315d 3b0a 2020  1 = k->nb[1];.  
+00064ac0: 2020 636f 6e73 7420 696e 7420 6e62 6b32    const int nbk2
+00064ad0: 203d 206b 2d3e 6e62 5b32 5d3b 0a20 2020   = k->nb[2];.   
+00064ae0: 2063 6f6e 7374 2069 6e74 206e 626b 3320   const int nbk3 
+00064af0: 3d20 6b2d 3e6e 625b 335d 3b0a 0a20 2020  = k->nb[3];..   
+00064b00: 2063 6f6e 7374 2069 6e74 206e 6271 3020   const int nbq0 
+00064b10: 3d20 712d 3e6e 625b 305d 3b0a 2020 2020  = q->nb[0];.    
+00064b20: 636f 6e73 7420 696e 7420 6e62 7131 203d  const int nbq1 =
+00064b30: 2071 2d3e 6e62 5b31 5d3b 0a20 2020 2063   q->nb[1];.    c
+00064b40: 6f6e 7374 2069 6e74 206e 6271 3220 3d20  onst int nbq2 = 
+00064b50: 712d 3e6e 625b 325d 3b0a 2020 2020 636f  q->nb[2];.    co
+00064b60: 6e73 7420 696e 7420 6e62 7133 203d 2071  nst int nbq3 = q
+00064b70: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
+00064b80: 6e73 7420 696e 7420 6e62 7630 203d 2076  nst int nbv0 = v
+00064b90: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+00064ba0: 7374 2069 6e74 206e 6276 3120 3d20 762d  st int nbv1 = v-
+00064bb0: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00064bc0: 7420 696e 7420 6e62 7632 203d 2076 2d3e  t int nbv2 = v->
+00064bd0: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+00064be0: 2069 6e74 206e 6276 3320 3d20 762d 3e6e   int nbv3 = v->n
+00064bf0: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+00064c00: 2069 6e74 206e 6230 2020 3d20 6473 742d   int nb0  = dst-
+00064c10: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
+00064c20: 7420 696e 7420 6e62 3120 203d 2064 7374  t int nb1  = dst
+00064c30: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
+00064c40: 7374 2069 6e74 206e 6232 2020 3d20 6473  st int nb2  = ds
+00064c50: 742d 3e6e 625b 325d 3b0a 2020 2020 636f  t->nb[2];.    co
+00064c60: 6e73 7420 696e 7420 6e62 3320 203d 2064  nst int nb3  = d
+00064c70: 7374 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  st->nb[3];..    
+00064c80: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
+00064c90: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
+00064ca0: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
+00064cb0: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
+00064cc0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00064cd0: 2044 203d 206e 6571 303b 0a20 2020 2063   D = neq0;.    c
+00064ce0: 6f6e 7374 2069 6e74 3634 5f74 204e 203d  onst int64_t N =
+00064cf0: 206e 6571 313b 0a20 2020 2063 6f6e 7374   neq1;.    const
+00064d00: 2069 6e74 3634 5f74 2050 203d 206e 656b   int64_t P = nek
+00064d10: 3120 2d20 4e3b 0a20 2020 2063 6f6e 7374  1 - N;.    const
+00064d20: 2069 6e74 3634 5f74 204d 203d 2050 202b   int64_t M = P +
+00064d30: 204e 3b0a 0a20 2020 2063 6f6e 7374 2069   N;..    const i
+00064d40: 6e74 204d 7570 203d 2067 676d 6c5f 7570  nt Mup = ggml_up
+00064d50: 284d 2c20 4747 4d4c 5f53 4f46 545f 4d41  (M, GGML_SOFT_MA
+00064d60: 585f 554e 524f 4c4c 293b 0a0a 2020 2020  X_UNROLL);..    
+00064d70: 4747 4d4c 5f41 5353 4552 5428 6e65 3020  GGML_ASSERT(ne0 
+00064d80: 3d3d 2044 293b 0a20 2020 2047 474d 4c5f  == D);.    GGML_
+00064d90: 4153 5345 5254 286e 6531 203d 3d20 4e29  ASSERT(ne1 == N)
+00064da0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00064db0: 5428 5020 3e3d 2030 293b 0a0a 2020 2020  T(P >= 0);..    
+00064dc0: 4747 4d4c 5f41 5353 4552 5428 6e62 7130  GGML_ASSERT(nbq0
+00064dd0: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
+00064de0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+00064df0: 4552 5428 6e62 6b30 203d 3d20 7369 7a65  ERT(nbk0 == size
+00064e00: 6f66 2866 6c6f 6174 2929 3b0a 2020 2020  of(float));.    
+00064e10: 4747 4d4c 5f41 5353 4552 5428 6e62 7630  GGML_ASSERT(nbv0
+00064e20: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
+00064e30: 2929 3b0a 0a20 2020 2047 474d 4c5f 4153  ));..    GGML_AS
+00064e40: 5345 5254 286e 6571 3020 3d3d 2044 293b  SERT(neq0 == D);
+00064e50: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00064e60: 286e 656b 3020 3d3d 2044 293b 0a20 2020  (nek0 == D);.   
+00064e70: 2047 474d 4c5f 4153 5345 5254 286e 6576   GGML_ASSERT(nev
+00064e80: 3120 3d3d 2044 293b 0a0a 2020 2020 4747  1 == D);..    GG
+00064e90: 4d4c 5f41 5353 4552 5428 6e65 7131 203d  ML_ASSERT(neq1 =
+00064ea0: 3d20 4e29 3b0a 2020 2020 4747 4d4c 5f41  = N);.    GGML_A
+00064eb0: 5353 4552 5428 6e65 6b31 203d 3d20 4e20  SSERT(nek1 == N 
+00064ec0: 2b20 5029 3b0a 2020 2020 4747 4d4c 5f41  + P);.    GGML_A
+00064ed0: 5353 4552 5428 6e65 7631 203d 3d20 4429  SSERT(nev1 == D)
+00064ee0: 3b0a 0a20 2020 202f 2f20 6473 7420 6361  ;..    // dst ca
+00064ef0: 6e6e 6f74 2062 6520 7472 616e 7370 6f73  nnot be transpos
+00064f00: 6564 206f 7220 7065 726d 7574 6564 0a20  ed or permuted. 
+00064f10: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+00064f20: 6230 203d 3d20 7369 7a65 6f66 2866 6c6f  b0 == sizeof(flo
+00064f30: 6174 2929 3b0a 2020 2020 4747 4d4c 5f41  at));.    GGML_A
+00064f40: 5353 4552 5428 6e62 3020 3c3d 206e 6231  SSERT(nb0 <= nb1
+00064f50: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00064f60: 5254 286e 6231 203c 3d20 6e62 3229 3b0a  RT(nb1 <= nb2);.
+00064f70: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00064f80: 6e62 3220 3c3d 206e 6233 293b 0a0a 2020  nb2 <= nb3);..  
+00064f90: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+00064fa0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00064fb0: 494e 4954 2920 7b0a 2020 2020 2020 2020  INIT) {.        
+00064fc0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+00064fd0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+00064fe0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+00064ff0: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
+00065000: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+00065010: 207d 0a0a 2020 2020 2f2f 2070 6172 616c   }..    // paral
+00065020: 6c65 6c69 7a65 2062 7920 7120 726f 7773  lelize by q rows
+00065030: 2075 7369 6e67 2067 676d 6c5f 7665 635f   using ggml_vec_
+00065040: 646f 745f 6633 320a 0a20 2020 202f 2f20  dot_f32..    // 
+00065050: 746f 7461 6c20 726f 7773 2069 6e20 710a  total rows in q.
+00065060: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
+00065070: 203d 206e 6571 312a 6e65 7132 2a6e 6571   = neq1*neq2*neq
+00065080: 333b 0a0a 2020 2020 2f2f 2072 6f77 7320  3;..    // rows 
+00065090: 7065 7220 7468 7265 6164 0a20 2020 2063  per thread.    c
+000650a0: 6f6e 7374 2069 6e74 2064 7220 3d20 286e  onst int dr = (n
+000650b0: 7220 2b20 6e74 6820 2d20 3129 2f6e 7468  r + nth - 1)/nth
+000650c0: 3b0a 0a20 2020 202f 2f20 726f 7720 7261  ;..    // row ra
+000650d0: 6e67 6520 666f 7220 7468 6973 2074 6872  nge for this thr
+000650e0: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
+000650f0: 7420 6972 3020 3d20 6472 2a69 7468 3b0a  t ir0 = dr*ith;.
+00065100: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+00065110: 3120 3d20 4d49 4e28 6972 3020 2b20 6472  1 = MIN(ir0 + dr
+00065120: 2c20 6e72 293b 0a0a 2020 2020 636f 6e73  , nr);..    cons
+00065130: 7420 666c 6f61 7420 7363 616c 6520 3d20  t float scale = 
+00065140: 312e 3066 2f73 7172 7466 2844 293b 0a0a  1.0f/sqrtf(D);..
+00065150: 2020 2020 2f2f 7072 696e 7466 2822 503d      //printf("P=
+00065160: 2564 204e 3d25 6420 443d 2564 2069 7230  %d N=%d D=%d ir0
+00065170: 3d25 6420 6972 313d 2564 2073 6361 6c65  =%d ir1=%d scale
+00065180: 203d 2025 665c 6e22 2c20 502c 204e 2c20   = %f\n", P, N, 
+00065190: 442c 2069 7230 2c20 6972 312c 2073 6361  D, ir0, ir1, sca
+000651a0: 6c65 293b 0a0a 2020 2020 666f 7220 2869  le);..    for (i
+000651b0: 6e74 2069 7220 3d20 6972 303b 2069 7220  nt ir = ir0; ir 
+000651c0: 3c20 6972 313b 202b 2b69 7229 207b 0a20  < ir1; ++ir) {. 
+000651d0: 2020 2020 2020 202f 2f20 7120 696e 6469         // q indi
+000651e0: 6365 730a 2020 2020 2020 2020 636f 6e73  ces.        cons
+000651f0: 7420 696e 7420 6971 3320 3d20 6972 2f28  t int iq3 = ir/(
+00065200: 6e65 7132 2a6e 6571 3129 3b0a 2020 2020  neq2*neq1);.    
+00065210: 2020 2020 636f 6e73 7420 696e 7420 6971      const int iq
+00065220: 3220 3d20 2869 7220 2d20 6971 332a 6e65  2 = (ir - iq3*ne
+00065230: 7132 2a6e 6571 3129 2f6e 6571 313b 0a20  q2*neq1)/neq1;. 
+00065240: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00065250: 2069 7131 203d 2028 6972 202d 2069 7133   iq1 = (ir - iq3
+00065260: 2a6e 6571 322a 6e65 7131 202d 2069 7132  *neq2*neq1 - iq2
+00065270: 2a6e 6571 3129 3b0a 0a20 2020 2020 2020  *neq1);..       
+00065280: 2066 6c6f 6174 202a 2053 203d 2028 666c   float * S = (fl
+00065290: 6f61 7420 2a29 2070 6172 616d 732d 3e77  oat *) params->w
+000652a0: 6461 7461 202b 2069 7468 2a28 4d75 7020  data + ith*(Mup 
+000652b0: 2b20 4341 4348 455f 4c49 4e45 5f53 495a  + CACHE_LINE_SIZ
+000652c0: 455f 4633 3229 3b0a 0a20 2020 2020 2020  E_F32);..       
+000652d0: 2066 6f72 2028 696e 7420 6920 3d20 4d3b   for (int i = M;
+000652e0: 2069 203c 204d 7570 3b20 2b2b 6929 207b   i < Mup; ++i) {
+000652f0: 0a20 2020 2020 2020 2020 2020 2053 5b69  .            S[i
+00065300: 5d20 3d20 2d49 4e46 494e 4954 593b 0a20  ] = -INFINITY;. 
+00065310: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00065320: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+00065330: 6320 3d20 303b 2069 6320 3c20 6e65 6b31  c = 0; ic < nek1
+00065340: 3b20 2b2b 6963 2920 7b0a 2020 2020 2020  ; ++ic) {.      
+00065350: 2020 2020 2020 2f2f 206b 2069 6e64 6963        // k indic
+00065360: 6573 0a20 2020 2020 2020 2020 2020 2063  es.            c
+00065370: 6f6e 7374 2069 6e74 2069 6b33 203d 2069  onst int ik3 = i
+00065380: 7133 3b0a 2020 2020 2020 2020 2020 2020  q3;.            
+00065390: 636f 6e73 7420 696e 7420 696b 3220 3d20  const int ik2 = 
+000653a0: 6971 323b 0a20 2020 2020 2020 2020 2020  iq2;.           
+000653b0: 2063 6f6e 7374 2069 6e74 2069 6b31 203d   const int ik1 =
+000653c0: 2069 633b 0a0a 2020 2020 2020 2020 2020   ic;..          
+000653d0: 2020 2f2f 2053 2069 6e64 6963 6573 0a20    // S indices. 
+000653e0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+000653f0: 2069 6e74 2069 3120 3d20 696b 313b 0a0a   int i1 = ik1;..
+00065400: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00065410: 5f76 6563 5f64 6f74 5f66 3332 286e 6571  _vec_dot_f32(neq
+00065420: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00065430: 2020 2020 2020 2053 202b 2069 312c 0a20         S + i1,. 
+00065440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065450: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+00065460: 6861 7220 2a29 206b 2d3e 6461 7461 202b  har *) k->data +
+00065470: 2028 696b 312a 6e62 6b31 202b 2069 6b32   (ik1*nbk1 + ik2
+00065480: 2a6e 626b 3220 2b20 696b 332a 6e62 6b33  *nbk2 + ik3*nbk3
+00065490: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+000654a0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+000654b0: 2920 2828 6368 6172 202a 2920 712d 3e64  ) ((char *) q->d
+000654c0: 6174 6120 2b20 2869 7131 2a6e 6271 3120  ata + (iq1*nbq1 
+000654d0: 2b20 6971 322a 6e62 7132 202b 2069 7133  + iq2*nbq2 + iq3
+000654e0: 2a6e 6271 3329 2929 3b0a 2020 2020 2020  *nbq3)));.      
+000654f0: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+00065500: 7363 616c 650a 2020 2020 2020 2020 6767  scale.        gg
+00065510: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
+00065520: 286e 656b 312c 2053 2c20 7363 616c 6529  (nek1, S, scale)
+00065530: 3b0a 0a20 2020 2020 2020 2069 6620 286d  ;..        if (m
+00065540: 6173 6b65 6429 207b 0a20 2020 2020 2020  asked) {.       
+00065550: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+00065560: 7420 6920 3d20 503b 2069 203c 204d 3b20  t i = P; i < M; 
+00065570: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
+00065580: 2020 2020 2020 2069 6620 2869 203e 2050         if (i > P
+00065590: 202b 2069 7131 2920 7b0a 2020 2020 2020   + iq1) {.      
+000655a0: 2020 2020 2020 2020 2020 2020 2020 535b                S[
+000655b0: 695d 203d 202d 494e 4649 4e49 5459 3b0a  i] = -INFINITY;.
+000655c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000655d0: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
+000655e0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000655f0: 2020 202f 2f20 736f 6674 6d61 780a 2020     // softmax.  
+00065600: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00065610: 2020 2020 666c 6f61 7420 6d61 7820 3d20      float max = 
+00065620: 2d49 4e46 494e 4954 593b 0a20 2020 2020  -INFINITY;.     
+00065630: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00065640: 6d61 785f 6633 3228 4d2c 2026 6d61 782c  max_f32(M, &max,
+00065650: 2053 293b 0a0a 2020 2020 2020 2020 2020   S);..          
+00065660: 2020 6767 6d6c 5f66 6c6f 6174 2073 756d    ggml_float sum
+00065670: 203d 2030 2e30 3b0a 2020 2020 2020 2020   = 0.0;.        
+00065680: 2020 2020 7b0a 2369 6664 6566 2047 474d      {.#ifdef GGM
+00065690: 4c5f 534f 4654 5f4d 4158 5f41 4343 454c  L_SOFT_MAX_ACCEL
+000656a0: 4552 4154 450a 2020 2020 2020 2020 2020  ERATE.          
+000656b0: 2020 2020 2020 6d61 7820 3d20 2d6d 6178        max = -max
+000656c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000656d0: 2020 7644 5350 5f76 7361 6464 2853 2c20    vDSP_vsadd(S, 
+000656e0: 312c 2026 6d61 782c 2053 2c20 312c 204d  1, &max, S, 1, M
+000656f0: 7570 293b 0a20 2020 2020 2020 2020 2020  up);.           
+00065700: 2020 2020 2076 7665 7870 6628 532c 2053       vvexpf(S, S
+00065710: 2c20 264d 7570 293b 0a20 2020 2020 2020  , &Mup);.       
+00065720: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+00065730: 635f 7375 6d5f 6633 3228 4d75 702c 2026  c_sum_f32(Mup, &
+00065740: 7375 6d2c 2053 293b 0a23 656c 7365 0a20  sum, S);.#else. 
+00065750: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00065760: 696e 7431 365f 7420 2020 7363 7674 5b47  int16_t   scvt[G
+00065770: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
+00065780: 4f4c 4c5d 3b0a 2020 2020 2020 2020 2020  OLL];.          
+00065790: 2020 2020 2020 6767 6d6c 5f66 6c6f 6174        ggml_float
+000657a0: 2073 756d 705b 4747 4d4c 5f53 4f46 545f   sump[GGML_SOFT_
+000657b0: 4d41 585f 554e 524f 4c4c 5d20 3d20 7b20  MAX_UNROLL] = { 
+000657c0: 302e 3020 7d3b 0a0a 2020 2020 2020 2020  0.0 };..        
+000657d0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+000657e0: 2069 203d 2030 3b20 6920 3c20 4d75 703b   i = 0; i < Mup;
+000657f0: 2069 202b 3d20 4747 4d4c 5f53 4f46 545f   i += GGML_SOFT_
+00065800: 4d41 585f 554e 524f 4c4c 2920 7b0a 2020  MAX_UNROLL) {.  
+00065810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065820: 2020 666c 6f61 7420 2a20 5353 203d 2053    float * SS = S
+00065830: 202b 2069 3b0a 0a20 2020 2020 2020 2020   + i;..         
+00065840: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00065850: 696e 7420 6a20 3d20 303b 206a 203c 2047  int j = 0; j < G
+00065860: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
+00065870: 4f4c 4c3b 202b 2b6a 2920 7b0a 2020 2020  OLL; ++j) {.    
+00065880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065890: 2020 2020 6966 2028 5353 5b6a 5d20 3d3d      if (SS[j] ==
+000658a0: 202d 494e 4649 4e49 5459 2920 7b0a 2020   -INFINITY) {.  
+000658b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000658c0: 2020 2020 2020 2020 2020 5353 5b6a 5d20            SS[j] 
+000658d0: 3d20 302e 3066 3b0a 2020 2020 2020 2020  = 0.0f;.        
+000658e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000658f0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+00065900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065910: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+00065920: 2073 203d 2047 474d 4c5f 4650 3332 5f54   s = GGML_FP32_T
+00065930: 4f5f 4650 3136 2853 535b 6a5d 202d 206d  O_FP16(SS[j] - m
+00065940: 6178 293b 0a20 2020 2020 2020 2020 2020  ax);.           
+00065950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065960: 206d 656d 6370 7928 2673 6376 745b 6a5d   memcpy(&scvt[j]
+00065970: 2c20 2673 2c20 7369 7a65 6f66 2875 696e  , &s, sizeof(uin
+00065980: 7431 365f 7429 293b 0a20 2020 2020 2020  t16_t));.       
 00065990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000659a0: 6d65 6d63 7079 2826 7363 7674 5b6a 5d2c  memcpy(&scvt[j],
-000659b0: 2026 732c 2073 697a 656f 6628 7569 6e74   &s, sizeof(uint
-000659c0: 3136 5f74 2929 3b0a 2020 2020 2020 2020  16_t));.        
-000659d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000659e0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-000659f0: 7661 6c20 3d20 4747 4d4c 5f46 5031 365f  val = GGML_FP16_
-00065a00: 544f 5f46 5033 3228 7461 626c 655f 6578  TO_FP32(table_ex
-00065a10: 705f 6631 365b 7363 7674 5b6a 5d5d 293b  p_f16[scvt[j]]);
-00065a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00065a30: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-00065a40: 705b 6a5d 202b 3d20 2867 676d 6c5f 666c  p[j] += (ggml_fl
-00065a50: 6f61 7429 7661 6c3b 0a20 2020 2020 2020  oat)val;.       
+000659a0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+000659b0: 2076 616c 203d 2047 474d 4c5f 4650 3136   val = GGML_FP16
+000659c0: 5f54 4f5f 4650 3332 2874 6162 6c65 5f65  _TO_FP32(table_e
+000659d0: 7870 5f66 3136 5b73 6376 745b 6a5d 5d29  xp_f16[scvt[j]])
+000659e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000659f0: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00065a00: 6d70 5b6a 5d20 2b3d 2028 6767 6d6c 5f66  mp[j] += (ggml_f
+00065a10: 6c6f 6174 2976 616c 3b0a 2020 2020 2020  loat)val;.      
+00065a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065a30: 2020 2020 2020 5353 5b6a 5d20 3d20 7661        SS[j] = va
+00065a40: 6c3b 0a20 2020 2020 2020 2020 2020 2020  l;.             
+00065a50: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
 00065a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065a70: 2020 2020 2053 535b 6a5d 203d 2076 616c       SS[j] = val
-00065a80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00065a90: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00065aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065ab0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00065ac0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-00065ad0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-00065ae0: 3d20 303b 2069 203c 2047 474d 4c5f 534f  = 0; i < GGML_SO
-00065af0: 4654 5f4d 4158 5f55 4e52 4f4c 4c3b 2069  FT_MAX_UNROLL; i
-00065b00: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00065b10: 2020 2020 2020 2020 2020 7375 6d20 2b3d            sum +=
-00065b20: 2073 756d 705b 695d 3b0a 2020 2020 2020   sump[i];.      
-00065b30: 2020 2020 2020 2020 2020 7d0a 2365 6e64            }.#end
-00065b40: 6966 0a20 2020 2020 2020 2020 2020 207d  if.            }
-00065b50: 0a0a 2020 2020 2020 2020 2020 2020 6173  ..            as
-00065b60: 7365 7274 2873 756d 203e 2030 2e30 293b  sert(sum > 0.0);
-00065b70: 0a0a 2020 2020 2020 2020 2020 2020 7375  ..            su
-00065b80: 6d20 3d20 312e 302f 7375 6d3b 0a20 2020  m = 1.0/sum;.   
-00065b90: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00065ba0: 635f 7363 616c 655f 6633 3228 4d2c 2053  c_scale_f32(M, S
-00065bb0: 2c20 7375 6d29 3b0a 0a23 6966 6e64 6566  , sum);..#ifndef
-00065bc0: 204e 4445 4255 470a 2020 2020 2020 2020   NDEBUG.        
-00065bd0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00065be0: 2030 3b20 6920 3c20 4d3b 202b 2b69 2920   0; i < M; ++i) 
-00065bf0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00065c00: 2020 6173 7365 7274 2821 6973 6e61 6e28    assert(!isnan(
-00065c10: 535b 695d 2929 3b0a 2020 2020 2020 2020  S[i]));.        
-00065c20: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
-00065c30: 6973 696e 6628 535b 695d 2929 3b0a 2020  isinf(S[i]));.  
-00065c40: 2020 2020 2020 2020 2020 7d0a 2365 6e64            }.#end
-00065c50: 6966 0a20 2020 2020 2020 207d 0a0a 2020  if.        }..  
-00065c60: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00065c70: 5f74 2069 6320 3d20 303b 2069 6320 3c20  _t ic = 0; ic < 
-00065c80: 6e65 7631 3b20 2b2b 6963 2920 7b0a 2020  nev1; ++ic) {.  
-00065c90: 2020 2020 2020 2020 2020 2f2f 2064 7374            // dst
-00065ca0: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-00065cb0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00065cc0: 3120 3d20 6971 313b 0a20 2020 2020 2020  1 = iq1;.       
-00065cd0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00065ce0: 3220 3d20 6971 323b 0a20 2020 2020 2020  2 = iq2;.       
-00065cf0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00065d00: 3320 3d20 6971 333b 0a0a 2020 2020 2020  3 = iq3;..      
-00065d10: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
-00065d20: 6f74 5f66 3332 286e 656b 312c 0a20 2020  ot_f32(nek1,.   
-00065d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065d40: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-00065d50: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
-00065d60: 2028 6963 2a6e 6230 202b 2069 312a 6e62   (ic*nb0 + i1*nb
-00065d70: 3120 202b 2069 322a 6e62 3220 202b 2069  1  + i2*nb2  + i
-00065d80: 332a 6e62 3329 292c 0a20 2020 2020 2020  3*nb3)),.       
-00065d90: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-00065da0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00065db0: 2076 2d3e 6461 7461 2020 202b 2028 2020   v->data   + (  
-00065dc0: 2020 2020 2020 2069 632a 6e62 7631 202b         ic*nbv1 +
-00065dd0: 2069 322a 6e62 7632 202b 2069 332a 6e62   i2*nbv2 + i3*nb
-00065de0: 7633 2929 2c0a 2020 2020 2020 2020 2020  v3)),.          
-00065df0: 2020 2020 2020 2020 2020 5329 3b0a 2020            S);.  
-00065e00: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
-00065e10: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00065e20: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00065e30: 645f 666c 6173 685f 6174 746e 5f66 3136  d_flash_attn_f16
-00065e40: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-00065e50: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00065e60: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00065e70: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-00065e80: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00065e90: 656e 736f 7220 2a20 712c 0a20 2020 2020  ensor * q,.     
-00065ea0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00065eb0: 6767 6d6c 5f74 656e 736f 7220 2a20 6b2c  ggml_tensor * k,
-00065ec0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00065ed0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00065ee0: 7220 2a20 762c 0a20 2020 2020 2020 2063  r * v,.        c
-00065ef0: 6f6e 7374 2062 6f6f 6c20 6d61 736b 6564  onst bool masked
-00065f00: 2c0a 2020 2020 2020 2020 2020 2020 2073  ,.             s
-00065f10: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00065f20: 7220 2a20 6473 7429 207b 0a20 2020 2069  r * dst) {.    i
-00065f30: 6e74 3634 5f74 2074 3020 3d20 6767 6d6c  nt64_t t0 = ggml
-00065f40: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
-00065f50: 0a20 2020 2055 4e55 5345 4428 7430 293b  .    UNUSED(t0);
-00065f60: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-00065f70: 345f 7420 6e65 7130 203d 2071 2d3e 6e65  4_t neq0 = q->ne
-00065f80: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-00065f90: 6e74 3634 5f74 206e 6571 3120 3d20 712d  nt64_t neq1 = q-
-00065fa0: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
-00065fb0: 7420 696e 7436 345f 7420 6e65 7132 203d  t int64_t neq2 =
-00065fc0: 2071 2d3e 6e65 5b32 5d3b 0a20 2020 2063   q->ne[2];.    c
-00065fd0: 6f6e 7374 2069 6e74 3634 5f74 206e 6571  onst int64_t neq
-00065fe0: 3320 3d20 712d 3e6e 655b 335d 3b0a 0a20  3 = q->ne[3];.. 
-00065ff0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00066000: 206e 656b 3020 3d20 6b2d 3e6e 655b 305d   nek0 = k->ne[0]
-00066010: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00066020: 345f 7420 6e65 6b31 203d 206b 2d3e 6e65  4_t nek1 = k->ne
-00066030: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
-00066040: 2069 6e74 3634 5f74 206e 656b 3220 3d20   int64_t nek2 = 
-00066050: 6b2d 3e6e 655b 325d 3b0a 2020 2020 2f2f  k->ne[2];.    //
-00066060: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00066070: 6b33 203d 206b 2d3e 6e65 5b33 5d3b 0a0a  k3 = k->ne[3];..
-00066080: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
-00066090: 345f 7420 6e65 7630 203d 2076 2d3e 6e65  4_t nev0 = v->ne
-000660a0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-000660b0: 6e74 3634 5f74 206e 6576 3120 3d20 762d  nt64_t nev1 = v-
-000660c0: 3e6e 655b 315d 3b0a 2020 2020 2f2f 636f  >ne[1];.    //co
-000660d0: 6e73 7420 696e 7436 345f 7420 6e65 7632  nst int64_t nev2
-000660e0: 203d 2076 2d3e 6e65 5b32 5d3b 0a20 2020   = v->ne[2];.   
-000660f0: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-00066100: 206e 6576 3320 3d20 762d 3e6e 655b 335d   nev3 = v->ne[3]
-00066110: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00066120: 3634 5f74 206e 6530 2020 3d20 6473 742d  64_t ne0  = dst-
-00066130: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-00066140: 7420 696e 7436 345f 7420 6e65 3120 203d  t int64_t ne1  =
-00066150: 2064 7374 2d3e 6e65 5b31 5d3b 0a20 2020   dst->ne[1];.   
-00066160: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-00066170: 206e 6532 2020 3d20 6473 742d 3e6e 655b   ne2  = dst->ne[
-00066180: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-00066190: 696e 7436 345f 7420 6e65 3320 203d 2064  int64_t ne3  = d
-000661a0: 7374 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  st->ne[3];..    
-000661b0: 636f 6e73 7420 696e 7420 6e62 6b30 203d  const int nbk0 =
-000661c0: 206b 2d3e 6e62 5b30 5d3b 0a20 2020 2063   k->nb[0];.    c
-000661d0: 6f6e 7374 2069 6e74 206e 626b 3120 3d20  onst int nbk1 = 
-000661e0: 6b2d 3e6e 625b 315d 3b0a 2020 2020 636f  k->nb[1];.    co
-000661f0: 6e73 7420 696e 7420 6e62 6b32 203d 206b  nst int nbk2 = k
-00066200: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-00066210: 7374 2069 6e74 206e 626b 3320 3d20 6b2d  st int nbk3 = k-
-00066220: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
-00066230: 7374 2069 6e74 206e 6271 3020 3d20 712d  st int nbq0 = q-
-00066240: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-00066250: 7420 696e 7420 6e62 7131 203d 2071 2d3e  t int nbq1 = q->
-00066260: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-00066270: 2069 6e74 206e 6271 3220 3d20 712d 3e6e   int nbq2 = q->n
-00066280: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-00066290: 696e 7420 6e62 7133 203d 2071 2d3e 6e62  int nbq3 = q->nb
-000662a0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-000662b0: 696e 7420 6e62 7630 203d 2076 2d3e 6e62  int nbv0 = v->nb
-000662c0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-000662d0: 6e74 206e 6276 3120 3d20 762d 3e6e 625b  nt nbv1 = v->nb[
-000662e0: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-000662f0: 7420 6e62 7632 203d 2076 2d3e 6e62 5b32  t nbv2 = v->nb[2
-00066300: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00066310: 206e 6276 3320 3d20 762d 3e6e 625b 335d   nbv3 = v->nb[3]
-00066320: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00066330: 206e 6230 2020 3d20 6473 742d 3e6e 625b   nb0  = dst->nb[
-00066340: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-00066350: 7420 6e62 3120 203d 2064 7374 2d3e 6e62  t nb1  = dst->nb
-00066360: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-00066370: 6e74 206e 6232 2020 3d20 6473 742d 3e6e  nt nb2  = dst->n
-00066380: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-00066390: 696e 7420 6e62 3320 203d 2064 7374 2d3e  int nb3  = dst->
-000663a0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-000663b0: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
-000663c0: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
-000663d0: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
-000663e0: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
-000663f0: 6f6e 7374 2069 6e74 3634 5f74 2044 203d  onst int64_t D =
-00066400: 206e 6571 303b 0a20 2020 2063 6f6e 7374   neq0;.    const
-00066410: 2069 6e74 3634 5f74 204e 203d 206e 6571   int64_t N = neq
-00066420: 313b 0a20 2020 2063 6f6e 7374 2069 6e74  1;.    const int
-00066430: 3634 5f74 2050 203d 206e 656b 3120 2d20  64_t P = nek1 - 
-00066440: 4e3b 0a20 2020 2063 6f6e 7374 2069 6e74  N;.    const int
-00066450: 3634 5f74 204d 203d 2050 202b 204e 3b0a  64_t M = P + N;.
-00066460: 0a20 2020 2063 6f6e 7374 2069 6e74 204d  .    const int M
-00066470: 7570 203d 2067 676d 6c5f 7570 284d 2c20  up = ggml_up(M, 
-00066480: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
-00066490: 524f 4c4c 293b 0a0a 2020 2020 4747 4d4c  ROLL);..    GGML
-000664a0: 5f41 5353 4552 5428 6e65 3020 3d3d 2044  _ASSERT(ne0 == D
-000664b0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000664c0: 5254 286e 6531 203d 3d20 4e29 3b0a 2020  RT(ne1 == N);.  
-000664d0: 2020 4747 4d4c 5f41 5353 4552 5428 5020    GGML_ASSERT(P 
-000664e0: 3e3d 2030 293b 0a0a 2020 2020 4747 4d4c  >= 0);..    GGML
-000664f0: 5f41 5353 4552 5428 6e62 7130 203d 3d20  _ASSERT(nbq0 == 
-00066500: 7369 7a65 6f66 2867 676d 6c5f 6670 3136  sizeof(ggml_fp16
-00066510: 5f74 2929 3b0a 2020 2020 4747 4d4c 5f41  _t));.    GGML_A
-00066520: 5353 4552 5428 6e62 6b30 203d 3d20 7369  SSERT(nbk0 == si
-00066530: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
-00066540: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00066550: 4552 5428 6e62 7630 203d 3d20 7369 7a65  ERT(nbv0 == size
-00066560: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
-00066570: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
-00066580: 5254 286e 6571 3020 3d3d 2044 293b 0a20  RT(neq0 == D);. 
-00066590: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-000665a0: 656b 3020 3d3d 2044 293b 0a20 2020 2047  ek0 == D);.    G
-000665b0: 474d 4c5f 4153 5345 5254 286e 6576 3120  GML_ASSERT(nev1 
-000665c0: 3d3d 2044 293b 0a0a 2020 2020 4747 4d4c  == D);..    GGML
-000665d0: 5f41 5353 4552 5428 6e65 7131 203d 3d20  _ASSERT(neq1 == 
-000665e0: 4e29 3b0a 2020 2020 4747 4d4c 5f41 5353  N);.    GGML_ASS
-000665f0: 4552 5428 6e65 6b31 203d 3d20 4e20 2b20  ERT(nek1 == N + 
-00066600: 5029 3b0a 2020 2020 4747 4d4c 5f41 5353  P);.    GGML_ASS
-00066610: 4552 5428 6e65 7631 203d 3d20 4429 3b0a  ERT(nev1 == D);.
-00066620: 0a20 2020 202f 2f20 6473 7420 6361 6e6e  .    // dst cann
-00066630: 6f74 2062 6520 7472 616e 7370 6f73 6564  ot be transposed
-00066640: 206f 7220 7065 726d 7574 6564 0a20 2020   or permuted.   
-00066650: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
-00066660: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-00066670: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00066680: 4552 5428 6e62 3020 3c3d 206e 6231 293b  ERT(nb0 <= nb1);
-00066690: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000666a0: 286e 6231 203c 3d20 6e62 3229 3b0a 2020  (nb1 <= nb2);.  
-000666b0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-000666c0: 3220 3c3d 206e 6233 293b 0a0a 2020 2020  2 <= nb3);..    
-000666d0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-000666e0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-000666f0: 4954 2920 7b0a 2020 2020 2020 2020 7265  IT) {.        re
-00066700: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00066710: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00066720: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00066730: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00066740: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-00066750: 0a0a 2020 2020 2f2f 2070 6172 616c 6c65  ..    // paralle
-00066760: 6c69 7a65 2062 7920 7120 726f 7773 2075  lize by q rows u
-00066770: 7369 6e67 2067 676d 6c5f 7665 635f 646f  sing ggml_vec_do
-00066780: 745f 6633 320a 0a20 2020 202f 2f20 746f  t_f32..    // to
-00066790: 7461 6c20 726f 7773 2069 6e20 710a 2020  tal rows in q.  
-000667a0: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
-000667b0: 206e 6571 312a 6e65 7132 2a6e 6571 333b   neq1*neq2*neq3;
-000667c0: 0a0a 2020 2020 2f2f 2072 6f77 7320 7065  ..    // rows pe
-000667d0: 7220 7468 7265 6164 0a20 2020 2063 6f6e  r thread.    con
-000667e0: 7374 2069 6e74 2064 7220 3d20 286e 7220  st int dr = (nr 
-000667f0: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
-00066800: 0a20 2020 202f 2f20 726f 7720 7261 6e67  .    // row rang
-00066810: 6520 666f 7220 7468 6973 2074 6872 6561  e for this threa
-00066820: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-00066830: 6972 3020 3d20 6472 2a69 7468 3b0a 2020  ir0 = dr*ith;.  
-00066840: 2020 636f 6e73 7420 696e 7420 6972 3120    const int ir1 
-00066850: 3d20 4d49 4e28 6972 3020 2b20 6472 2c20  = MIN(ir0 + dr, 
-00066860: 6e72 293b 0a0a 2020 2020 636f 6e73 7420  nr);..    const 
-00066870: 666c 6f61 7420 7363 616c 6520 3d20 312e  float scale = 1.
-00066880: 3066 2f73 7172 7466 2844 293b 0a0a 2020  0f/sqrtf(D);..  
-00066890: 2020 2f2f 7072 696e 7466 2822 503d 2564    //printf("P=%d
-000668a0: 204e 3d25 6420 443d 2564 2069 7230 3d25   N=%d D=%d ir0=%
-000668b0: 6420 6972 313d 2564 2073 6361 6c65 203d  d ir1=%d scale =
-000668c0: 2025 665c 6e22 2c20 502c 204e 2c20 442c   %f\n", P, N, D,
-000668d0: 2069 7230 2c20 6972 312c 2073 6361 6c65   ir0, ir1, scale
-000668e0: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-000668f0: 2069 7220 3d20 6972 303b 2069 7220 3c20   ir = ir0; ir < 
-00066900: 6972 313b 202b 2b69 7229 207b 0a20 2020  ir1; ++ir) {.   
-00066910: 2020 2020 202f 2f20 7120 696e 6469 6365       // q indice
-00066920: 730a 2020 2020 2020 2020 636f 6e73 7420  s.        const 
-00066930: 696e 7420 6971 3320 3d20 6972 2f28 6e65  int iq3 = ir/(ne
-00066940: 7132 2a6e 6571 3129 3b0a 2020 2020 2020  q2*neq1);.      
-00066950: 2020 636f 6e73 7420 696e 7420 6971 3220    const int iq2 
-00066960: 3d20 2869 7220 2d20 6971 332a 6e65 7132  = (ir - iq3*neq2
-00066970: 2a6e 6571 3129 2f6e 6571 313b 0a20 2020  *neq1)/neq1;.   
-00066980: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00066990: 7131 203d 2028 6972 202d 2069 7133 2a6e  q1 = (ir - iq3*n
-000669a0: 6571 322a 6e65 7131 202d 2069 7132 2a6e  eq2*neq1 - iq2*n
-000669b0: 6571 3129 3b0a 0a20 2020 2020 2020 2066  eq1);..        f
-000669c0: 6c6f 6174 202a 2053 203d 2028 666c 6f61  loat * S = (floa
-000669d0: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
-000669e0: 7461 202b 2069 7468 2a28 322a 4d75 7020  ta + ith*(2*Mup 
-000669f0: 2b20 4341 4348 455f 4c49 4e45 5f53 495a  + CACHE_LINE_SIZ
-00066a00: 455f 4633 3229 3b0a 0a20 2020 2020 2020  E_F32);..       
-00066a10: 2066 6f72 2028 696e 7420 6920 3d20 4d3b   for (int i = M;
-00066a20: 2069 203c 204d 7570 3b20 2b2b 6929 207b   i < Mup; ++i) {
-00066a30: 0a20 2020 2020 2020 2020 2020 2053 5b69  .            S[i
-00066a40: 5d20 3d20 2d49 4e46 494e 4954 593b 0a20  ] = -INFINITY;. 
-00066a50: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00066a60: 2020 6966 2028 4747 4d4c 5f56 4543 5f44    if (GGML_VEC_D
-00066a70: 4f54 5f55 4e52 4f4c 4c20 3e20 3220 7c7c  OT_UNROLL > 2 ||
-00066a80: 206e 656b 3120 2520 4747 4d4c 5f56 4543   nek1 % GGML_VEC
-00066a90: 5f44 4f54 5f55 4e52 4f4c 4c20 213d 2030  _DOT_UNROLL != 0
-00066aa0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00066ab0: 666f 7220 2869 6e74 3634 5f74 2069 6320  for (int64_t ic 
-00066ac0: 3d20 303b 2069 6320 3c20 6e65 6b31 3b20  = 0; ic < nek1; 
-00066ad0: 2b2b 6963 2920 7b0a 2020 2020 2020 2020  ++ic) {.        
-00066ae0: 2020 2020 2020 2020 2f2f 206b 2069 6e64          // k ind
-00066af0: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
-00066b00: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00066b10: 6b33 203d 2069 7133 3b0a 2020 2020 2020  k3 = iq3;.      
-00066b20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00066b30: 696e 7420 696b 3220 3d20 6971 323b 0a20  int ik2 = iq2;. 
-00066b40: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00066b50: 6f6e 7374 2069 6e74 2069 6b31 203d 2069  onst int ik1 = i
-00066b60: 633b 0a0a 2020 2020 2020 2020 2020 2020  c;..            
-00066b70: 2020 2020 2f2f 2053 2069 6e64 6963 6573      // S indices
-00066b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00066b90: 2063 6f6e 7374 2069 6e74 2069 3120 3d20   const int i1 = 
-00066ba0: 696b 313b 0a0a 2020 2020 2020 2020 2020  ik1;..          
-00066bb0: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
-00066bc0: 6f74 5f66 3136 286e 6571 302c 0a20 2020  ot_f16(neq0,.   
-00066bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066be0: 2020 2020 2053 202b 2069 312c 0a20 2020       S + i1,.   
-00066bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066c00: 2020 2020 2028 6767 6d6c 5f66 7031 365f       (ggml_fp16_
-00066c10: 7420 2a29 2028 2863 6861 7220 2a29 206b  t *) ((char *) k
-00066c20: 2d3e 6461 7461 202b 2028 696b 312a 6e62  ->data + (ik1*nb
-00066c30: 6b31 202b 2069 6b32 2a6e 626b 3220 2b20  k1 + ik2*nbk2 + 
-00066c40: 696b 332a 6e62 6b33 2929 2c0a 2020 2020  ik3*nbk3)),.    
-00066c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066c60: 2020 2020 2867 676d 6c5f 6670 3136 5f74      (ggml_fp16_t
-00066c70: 202a 2920 2828 6368 6172 202a 2920 712d   *) ((char *) q-
-00066c80: 3e64 6174 6120 2b20 2869 7131 2a6e 6271  >data + (iq1*nbq
-00066c90: 3120 2b20 6971 322a 6e62 7132 202b 2069  1 + iq2*nbq2 + i
-00066ca0: 7133 2a6e 6271 3329 2929 3b0a 2020 2020  q3*nbq3)));.    
-00066cb0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00066cc0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-00066cd0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00066ce0: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
-00066cf0: 206e 656b 313b 2069 6320 2b3d 2047 474d   nek1; ic += GGM
-00066d00: 4c5f 5645 435f 444f 545f 554e 524f 4c4c  L_VEC_DOT_UNROLL
-00066d10: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00066d20: 2020 2020 2f2f 206b 2069 6e64 6963 6573      // k indices
-00066d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00066d40: 2063 6f6e 7374 2069 6e74 2069 6b33 203d   const int ik3 =
-00066d50: 2069 7133 3b0a 2020 2020 2020 2020 2020   iq3;.          
-00066d60: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00066d70: 696b 3220 3d20 6971 323b 0a20 2020 2020  ik2 = iq2;.     
-00066d80: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00066d90: 2069 6e74 2069 6b31 203d 2069 633b 0a0a   int ik1 = ic;..
-00066da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066db0: 2f2f 2053 2069 6e64 6963 6573 0a20 2020  // S indices.   
-00066dc0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00066dd0: 7374 2069 6e74 2069 3120 3d20 696b 313b  st int i1 = ik1;
-00066de0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00066df0: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
-00066e00: 3136 5f75 6e72 6f6c 6c28 6e65 7130 2c20  16_unroll(neq0, 
-00066e10: 6e62 6b31 2c0a 2020 2020 2020 2020 2020  nbk1,.          
-00066e20: 2020 2020 2020 2020 2020 2020 2020 5320                S 
-00066e30: 2b20 6931 2c0a 2020 2020 2020 2020 2020  + i1,.          
-00066e40: 2020 2020 2020 2020 2020 2020 2020 2828                ((
-00066e50: 6368 6172 202a 2920 6b2d 3e64 6174 6120  char *) k->data 
-00066e60: 2b20 2869 6b31 2a6e 626b 3120 2b20 696b  + (ik1*nbk1 + ik
-00066e70: 322a 6e62 6b32 202b 2069 6b33 2a6e 626b  2*nbk2 + ik3*nbk
-00066e80: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
-00066e90: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
-00066ea0: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
-00066eb0: 6861 7220 2a29 2071 2d3e 6461 7461 202b  har *) q->data +
-00066ec0: 2028 6971 312a 6e62 7131 202b 2069 7132   (iq1*nbq1 + iq2
-00066ed0: 2a6e 6271 3220 2b20 6971 332a 6e62 7133  *nbq2 + iq3*nbq3
-00066ee0: 2929 293b 0a20 2020 2020 2020 2020 2020  )));.           
-00066ef0: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-00066f00: 2020 2020 2020 2f2f 2073 6361 6c65 0a20        // scale. 
-00066f10: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00066f20: 7363 616c 655f 6633 3228 6e65 6b31 2c20  scale_f32(nek1, 
-00066f30: 532c 2073 6361 6c65 293b 0a0a 2020 2020  S, scale);..    
-00066f40: 2020 2020 6966 2028 6d61 736b 6564 2920      if (masked) 
-00066f50: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
-00066f60: 7220 2869 6e74 3634 5f74 2069 203d 2050  r (int64_t i = P
-00066f70: 3b20 6920 3c20 4d3b 2069 2b2b 2920 7b0a  ; i < M; i++) {.
-00066f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066f90: 6966 2028 6920 3e20 5020 2b20 6971 3129  if (i > P + iq1)
-00066fa0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00066fb0: 2020 2020 2020 2053 5b69 5d20 3d20 2d49         S[i] = -I
-00066fc0: 4e46 494e 4954 593b 0a20 2020 2020 2020  NFINITY;.       
-00066fd0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00066fe0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00066ff0: 207d 0a0a 2020 2020 2020 2020 2f2f 2073   }..        // s
-00067000: 6f66 746d 6178 0a20 2020 2020 2020 207b  oftmax.        {
-00067010: 0a20 2020 2020 2020 2020 2020 2066 6c6f  .            flo
-00067020: 6174 206d 6178 203d 202d 494e 4649 4e49  at max = -INFINI
-00067030: 5459 3b0a 2020 2020 2020 2020 2020 2020  TY;.            
-00067040: 6767 6d6c 5f76 6563 5f6d 6178 5f66 3332  ggml_vec_max_f32
-00067050: 284d 2c20 266d 6178 2c20 5329 3b0a 0a20  (M, &max, S);.. 
-00067060: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00067070: 666c 6f61 7420 7375 6d20 3d20 302e 303b  float sum = 0.0;
-00067080: 0a20 2020 2020 2020 2020 2020 207b 0a23  .            {.#
-00067090: 6966 6465 6620 4747 4d4c 5f53 4f46 545f  ifdef GGML_SOFT_
-000670a0: 4d41 585f 4143 4345 4c45 5241 5445 0a20  MAX_ACCELERATE. 
-000670b0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000670c0: 6178 203d 202d 6d61 783b 0a20 2020 2020  ax = -max;.     
-000670d0: 2020 2020 2020 2020 2020 2076 4453 505f             vDSP_
-000670e0: 7673 6164 6428 532c 2031 2c20 266d 6178  vsadd(S, 1, &max
-000670f0: 2c20 532c 2031 2c20 4d75 7029 3b0a 2020  , S, 1, Mup);.  
-00067100: 2020 2020 2020 2020 2020 2020 2020 7676                vv
-00067110: 6578 7066 2853 2c20 532c 2026 4d75 7029  expf(S, S, &Mup)
-00067120: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00067130: 2020 6767 6d6c 5f76 6563 5f73 756d 5f66    ggml_vec_sum_f
-00067140: 3332 284d 7570 2c20 2673 756d 2c20 5329  32(Mup, &sum, S)
-00067150: 3b0a 2365 6c73 650a 2020 2020 2020 2020  ;.#else.        
-00067160: 2020 2020 2020 2020 7569 6e74 3136 5f74          uint16_t
-00067170: 2020 2073 6376 745b 4747 4d4c 5f53 4f46     scvt[GGML_SOF
-00067180: 545f 4d41 585f 554e 524f 4c4c 5d3b 0a20  T_MAX_UNROLL];. 
-00067190: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000671a0: 676d 6c5f 666c 6f61 7420 7375 6d70 5b47  gml_float sump[G
-000671b0: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
-000671c0: 4f4c 4c5d 203d 207b 2030 2e30 207d 3b0a  OLL] = { 0.0 };.
-000671d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000671e0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-000671f0: 2069 203c 204d 7570 3b20 6920 2b3d 2047   i < Mup; i += G
-00067200: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
-00067210: 4f4c 4c29 207b 0a20 2020 2020 2020 2020  OLL) {.         
-00067220: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-00067230: 202a 2053 5320 3d20 5320 2b20 693b 0a0a   * SS = S + i;..
-00067240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067250: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
-00067260: 2030 3b20 6a20 3c20 4747 4d4c 5f53 4f46   0; j < GGML_SOF
-00067270: 545f 4d41 585f 554e 524f 4c4c 3b20 2b2b  T_MAX_UNROLL; ++
-00067280: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
-00067290: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000672a0: 2853 535b 6a5d 203d 3d20 2d49 4e46 494e  (SS[j] == -INFIN
-000672b0: 4954 5929 207b 0a20 2020 2020 2020 2020  ITY) {.         
-000672c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000672d0: 2020 2053 535b 6a5d 203d 2030 2e30 663b     SS[j] = 0.0f;
-000672e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000672f0: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
-00067300: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00067310: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00067320: 6d6c 5f66 7031 365f 7420 7320 3d20 4747  ml_fp16_t s = GG
-00067330: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
-00067340: 5353 5b6a 5d20 2d20 6d61 7829 3b0a 2020  SS[j] - max);.  
-00067350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067360: 2020 2020 2020 2020 2020 6d65 6d63 7079            memcpy
-00067370: 2826 7363 7674 5b6a 5d2c 2026 732c 2073  (&scvt[j], &s, s
-00067380: 697a 656f 6628 7569 6e74 3136 5f74 2929  izeof(uint16_t))
-00067390: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000673a0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000673b0: 6e73 7420 666c 6f61 7420 7661 6c20 3d20  nst float val = 
-000673c0: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
-000673d0: 3228 7461 626c 655f 6578 705f 6631 365b  2(table_exp_f16[
-000673e0: 7363 7674 5b6a 5d5d 293b 0a20 2020 2020  scvt[j]]);.     
+00065a70: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00065a80: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+00065a90: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00065aa0: 203d 2030 3b20 6920 3c20 4747 4d4c 5f53   = 0; i < GGML_S
+00065ab0: 4f46 545f 4d41 585f 554e 524f 4c4c 3b20  OFT_MAX_UNROLL; 
+00065ac0: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
+00065ad0: 2020 2020 2020 2020 2020 2073 756d 202b             sum +
+00065ae0: 3d20 7375 6d70 5b69 5d3b 0a20 2020 2020  = sump[i];.     
+00065af0: 2020 2020 2020 2020 2020 207d 0a23 656e             }.#en
+00065b00: 6469 660a 2020 2020 2020 2020 2020 2020  dif.            
+00065b10: 7d0a 0a20 2020 2020 2020 2020 2020 2061  }..            a
+00065b20: 7373 6572 7428 7375 6d20 3e20 302e 3029  ssert(sum > 0.0)
+00065b30: 3b0a 0a20 2020 2020 2020 2020 2020 2073  ;..            s
+00065b40: 756d 203d 2031 2e30 2f73 756d 3b0a 2020  um = 1.0/sum;.  
+00065b50: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+00065b60: 6563 5f73 6361 6c65 5f66 3332 284d 2c20  ec_scale_f32(M, 
+00065b70: 532c 2073 756d 293b 0a0a 2369 666e 6465  S, sum);..#ifnde
+00065b80: 6620 4e44 4542 5547 0a20 2020 2020 2020  f NDEBUG.       
+00065b90: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00065ba0: 3d20 303b 2069 203c 204d 3b20 2b2b 6929  = 0; i < M; ++i)
+00065bb0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00065bc0: 2020 2061 7373 6572 7428 2169 736e 616e     assert(!isnan
+00065bd0: 2853 5b69 5d29 293b 0a20 2020 2020 2020  (S[i]));.       
+00065be0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
+00065bf0: 2169 7369 6e66 2853 5b69 5d29 293b 0a20  !isinf(S[i]));. 
+00065c00: 2020 2020 2020 2020 2020 207d 0a23 656e             }.#en
+00065c10: 6469 660a 2020 2020 2020 2020 7d0a 0a20  dif.        }.. 
+00065c20: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00065c30: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
+00065c40: 206e 6576 313b 202b 2b69 6329 207b 0a20   nev1; ++ic) {. 
+00065c50: 2020 2020 2020 2020 2020 202f 2f20 6473             // ds
+00065c60: 7420 696e 6469 6365 730a 2020 2020 2020  t indices.      
+00065c70: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00065c80: 6931 203d 2069 7131 3b0a 2020 2020 2020  i1 = iq1;.      
+00065c90: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00065ca0: 6932 203d 2069 7132 3b0a 2020 2020 2020  i2 = iq2;.      
+00065cb0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00065cc0: 6933 203d 2069 7133 3b0a 0a20 2020 2020  i3 = iq3;..     
+00065cd0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00065ce0: 646f 745f 6633 3228 6e65 6b31 2c0a 2020  dot_f32(nek1,.  
+00065cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065d00: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+00065d10: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+00065d20: 2b20 2869 632a 6e62 3020 2b20 6931 2a6e  + (ic*nb0 + i1*n
+00065d30: 6231 2020 2b20 6932 2a6e 6232 2020 2b20  b1  + i2*nb2  + 
+00065d40: 6933 2a6e 6233 2929 2c0a 2020 2020 2020  i3*nb3)),.      
+00065d50: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+00065d60: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00065d70: 2920 762d 3e64 6174 6120 2020 2b20 2820  ) v->data   + ( 
+00065d80: 2020 2020 2020 2020 6963 2a6e 6276 3120          ic*nbv1 
+00065d90: 2b20 6932 2a6e 6276 3220 2b20 6933 2a6e  + i2*nbv2 + i3*n
+00065da0: 6276 3329 292c 0a20 2020 2020 2020 2020  bv3)),.         
+00065db0: 2020 2020 2020 2020 2020 2053 293b 0a20             S);. 
+00065dc0: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+00065dd0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00065de0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00065df0: 7264 5f66 6c61 7368 5f61 7474 6e5f 6631  rd_flash_attn_f1
+00065e00: 3628 0a20 2020 2020 2020 2063 6f6e 7374  6(.        const
+00065e10: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00065e20: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00065e30: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00065e40: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00065e50: 7465 6e73 6f72 202a 2071 2c0a 2020 2020  tensor * q,.    
+00065e60: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00065e70: 2067 676d 6c5f 7465 6e73 6f72 202a 206b   ggml_tensor * k
+00065e80: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00065e90: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00065ea0: 6f72 202a 2076 2c0a 2020 2020 2020 2020  or * v,.        
+00065eb0: 636f 6e73 7420 626f 6f6c 206d 6173 6b65  const bool maske
+00065ec0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00065ed0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00065ee0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+00065ef0: 696e 7436 345f 7420 7430 203d 2067 676d  int64_t t0 = ggm
+00065f00: 6c5f 7065 7266 5f74 696d 655f 7573 2829  l_perf_time_us()
+00065f10: 3b0a 2020 2020 554e 5553 4544 2874 3029  ;.    UNUSED(t0)
+00065f20: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00065f30: 3634 5f74 206e 6571 3020 3d20 712d 3e6e  64_t neq0 = q->n
+00065f40: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+00065f50: 696e 7436 345f 7420 6e65 7131 203d 2071  int64_t neq1 = q
+00065f60: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
+00065f70: 7374 2069 6e74 3634 5f74 206e 6571 3220  st int64_t neq2 
+00065f80: 3d20 712d 3e6e 655b 325d 3b0a 2020 2020  = q->ne[2];.    
+00065f90: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00065fa0: 7133 203d 2071 2d3e 6e65 5b33 5d3b 0a0a  q3 = q->ne[3];..
+00065fb0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00065fc0: 7420 6e65 6b30 203d 206b 2d3e 6e65 5b30  t nek0 = k->ne[0
+00065fd0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00065fe0: 3634 5f74 206e 656b 3120 3d20 6b2d 3e6e  64_t nek1 = k->n
+00065ff0: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
+00066000: 7420 696e 7436 345f 7420 6e65 6b32 203d  t int64_t nek2 =
+00066010: 206b 2d3e 6e65 5b32 5d3b 0a20 2020 202f   k->ne[2];.    /
+00066020: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+00066030: 656b 3320 3d20 6b2d 3e6e 655b 335d 3b0a  ek3 = k->ne[3];.
+00066040: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+00066050: 3634 5f74 206e 6576 3020 3d20 762d 3e6e  64_t nev0 = v->n
+00066060: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+00066070: 696e 7436 345f 7420 6e65 7631 203d 2076  int64_t nev1 = v
+00066080: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
+00066090: 6f6e 7374 2069 6e74 3634 5f74 206e 6576  onst int64_t nev
+000660a0: 3220 3d20 762d 3e6e 655b 325d 3b0a 2020  2 = v->ne[2];.  
+000660b0: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+000660c0: 7420 6e65 7633 203d 2076 2d3e 6e65 5b33  t nev3 = v->ne[3
+000660d0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+000660e0: 7436 345f 7420 6e65 3020 203d 2064 7374  t64_t ne0  = dst
+000660f0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00066100: 7374 2069 6e74 3634 5f74 206e 6531 2020  st int64_t ne1  
+00066110: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
+00066120: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+00066130: 7420 6e65 3220 203d 2064 7374 2d3e 6e65  t ne2  = dst->ne
+00066140: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
+00066150: 2069 6e74 3634 5f74 206e 6533 2020 3d20   int64_t ne3  = 
+00066160: 6473 742d 3e6e 655b 335d 3b0a 0a20 2020  dst->ne[3];..   
+00066170: 2063 6f6e 7374 2069 6e74 206e 626b 3020   const int nbk0 
+00066180: 3d20 6b2d 3e6e 625b 305d 3b0a 2020 2020  = k->nb[0];.    
+00066190: 636f 6e73 7420 696e 7420 6e62 6b31 203d  const int nbk1 =
+000661a0: 206b 2d3e 6e62 5b31 5d3b 0a20 2020 2063   k->nb[1];.    c
+000661b0: 6f6e 7374 2069 6e74 206e 626b 3220 3d20  onst int nbk2 = 
+000661c0: 6b2d 3e6e 625b 325d 3b0a 2020 2020 636f  k->nb[2];.    co
+000661d0: 6e73 7420 696e 7420 6e62 6b33 203d 206b  nst int nbk3 = k
+000661e0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
+000661f0: 6e73 7420 696e 7420 6e62 7130 203d 2071  nst int nbq0 = q
+00066200: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+00066210: 7374 2069 6e74 206e 6271 3120 3d20 712d  st int nbq1 = q-
+00066220: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00066230: 7420 696e 7420 6e62 7132 203d 2071 2d3e  t int nbq2 = q->
+00066240: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+00066250: 2069 6e74 206e 6271 3320 3d20 712d 3e6e   int nbq3 = q->n
+00066260: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+00066270: 2069 6e74 206e 6276 3020 3d20 762d 3e6e   int nbv0 = v->n
+00066280: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+00066290: 696e 7420 6e62 7631 203d 2076 2d3e 6e62  int nbv1 = v->nb
+000662a0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+000662b0: 6e74 206e 6276 3220 3d20 762d 3e6e 625b  nt nbv2 = v->nb[
+000662c0: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+000662d0: 7420 6e62 7633 203d 2076 2d3e 6e62 5b33  t nbv3 = v->nb[3
+000662e0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+000662f0: 7420 6e62 3020 203d 2064 7374 2d3e 6e62  t nb0  = dst->nb
+00066300: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00066310: 6e74 206e 6231 2020 3d20 6473 742d 3e6e  nt nb1  = dst->n
+00066320: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+00066330: 696e 7420 6e62 3220 203d 2064 7374 2d3e  int nb2  = dst->
+00066340: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+00066350: 2069 6e74 206e 6233 2020 3d20 6473 742d   int nb3  = dst-
+00066360: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
+00066370: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00066380: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+00066390: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+000663a0: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+000663b0: 636f 6e73 7420 696e 7436 345f 7420 4420  const int64_t D 
+000663c0: 3d20 6e65 7130 3b0a 2020 2020 636f 6e73  = neq0;.    cons
+000663d0: 7420 696e 7436 345f 7420 4e20 3d20 6e65  t int64_t N = ne
+000663e0: 7131 3b0a 2020 2020 636f 6e73 7420 696e  q1;.    const in
+000663f0: 7436 345f 7420 5020 3d20 6e65 6b31 202d  t64_t P = nek1 -
+00066400: 204e 3b0a 2020 2020 636f 6e73 7420 696e   N;.    const in
+00066410: 7436 345f 7420 4d20 3d20 5020 2b20 4e3b  t64_t M = P + N;
+00066420: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+00066430: 4d75 7020 3d20 6767 6d6c 5f75 7028 4d2c  Mup = ggml_up(M,
+00066440: 2047 474d 4c5f 534f 4654 5f4d 4158 5f55   GGML_SOFT_MAX_U
+00066450: 4e52 4f4c 4c29 3b0a 0a20 2020 2047 474d  NROLL);..    GGM
+00066460: 4c5f 4153 5345 5254 286e 6530 203d 3d20  L_ASSERT(ne0 == 
+00066470: 4429 3b0a 2020 2020 4747 4d4c 5f41 5353  D);.    GGML_ASS
+00066480: 4552 5428 6e65 3120 3d3d 204e 293b 0a20  ERT(ne1 == N);. 
+00066490: 2020 2047 474d 4c5f 4153 5345 5254 2850     GGML_ASSERT(P
+000664a0: 203e 3d20 3029 3b0a 0a20 2020 2047 474d   >= 0);..    GGM
+000664b0: 4c5f 4153 5345 5254 286e 6271 3020 3d3d  L_ASSERT(nbq0 ==
+000664c0: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
+000664d0: 365f 7429 293b 0a20 2020 2047 474d 4c5f  6_t));.    GGML_
+000664e0: 4153 5345 5254 286e 626b 3020 3d3d 2073  ASSERT(nbk0 == s
+000664f0: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
+00066500: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+00066510: 5345 5254 286e 6276 3020 3d3d 2073 697a  SERT(nbv0 == siz
+00066520: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
+00066530: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
+00066540: 4552 5428 6e65 7130 203d 3d20 4429 3b0a  ERT(neq0 == D);.
+00066550: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00066560: 6e65 6b30 203d 3d20 4429 3b0a 2020 2020  nek0 == D);.    
+00066570: 4747 4d4c 5f41 5353 4552 5428 6e65 7631  GGML_ASSERT(nev1
+00066580: 203d 3d20 4429 3b0a 0a20 2020 2047 474d   == D);..    GGM
+00066590: 4c5f 4153 5345 5254 286e 6571 3120 3d3d  L_ASSERT(neq1 ==
+000665a0: 204e 293b 0a20 2020 2047 474d 4c5f 4153   N);.    GGML_AS
+000665b0: 5345 5254 286e 656b 3120 3d3d 204e 202b  SERT(nek1 == N +
+000665c0: 2050 293b 0a20 2020 2047 474d 4c5f 4153   P);.    GGML_AS
+000665d0: 5345 5254 286e 6576 3120 3d3d 2044 293b  SERT(nev1 == D);
+000665e0: 0a0a 2020 2020 2f2f 2064 7374 2063 616e  ..    // dst can
+000665f0: 6e6f 7420 6265 2074 7261 6e73 706f 7365  not be transpose
+00066600: 6420 6f72 2070 6572 6d75 7465 640a 2020  d or permuted.  
+00066610: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+00066620: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
+00066630: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+00066640: 5345 5254 286e 6230 203c 3d20 6e62 3129  SERT(nb0 <= nb1)
+00066650: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00066660: 5428 6e62 3120 3c3d 206e 6232 293b 0a20  T(nb1 <= nb2);. 
+00066670: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+00066680: 6232 203c 3d20 6e62 3329 3b0a 0a20 2020  b2 <= nb3);..   
+00066690: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+000666a0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+000666b0: 4e49 5429 207b 0a20 2020 2020 2020 2072  NIT) {.        r
+000666c0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+000666d0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+000666e0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+000666f0: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+00066700: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+00066710: 7d0a 0a20 2020 202f 2f20 7061 7261 6c6c  }..    // parall
+00066720: 656c 697a 6520 6279 2071 2072 6f77 7320  elize by q rows 
+00066730: 7573 696e 6720 6767 6d6c 5f76 6563 5f64  using ggml_vec_d
+00066740: 6f74 5f66 3332 0a0a 2020 2020 2f2f 2074  ot_f32..    // t
+00066750: 6f74 616c 2072 6f77 7320 696e 2071 0a20  otal rows in q. 
+00066760: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
+00066770: 3d20 6e65 7131 2a6e 6571 322a 6e65 7133  = neq1*neq2*neq3
+00066780: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
+00066790: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
+000667a0: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
+000667b0: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
+000667c0: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
+000667d0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
+000667e0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+000667f0: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
+00066800: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
+00066810: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
+00066820: 206e 7229 3b0a 0a20 2020 2063 6f6e 7374   nr);..    const
+00066830: 2066 6c6f 6174 2073 6361 6c65 203d 2031   float scale = 1
+00066840: 2e30 662f 7371 7274 6628 4429 3b0a 0a20  .0f/sqrtf(D);.. 
+00066850: 2020 202f 2f70 7269 6e74 6628 2250 3d25     //printf("P=%
+00066860: 6420 4e3d 2564 2044 3d25 6420 6972 303d  d N=%d D=%d ir0=
+00066870: 2564 2069 7231 3d25 6420 7363 616c 6520  %d ir1=%d scale 
+00066880: 3d20 2566 5c6e 222c 2050 2c20 4e2c 2044  = %f\n", P, N, D
+00066890: 2c20 6972 302c 2069 7231 2c20 7363 616c  , ir0, ir1, scal
+000668a0: 6529 3b0a 0a20 2020 2066 6f72 2028 696e  e);..    for (in
+000668b0: 7420 6972 203d 2069 7230 3b20 6972 203c  t ir = ir0; ir <
+000668c0: 2069 7231 3b20 2b2b 6972 2920 7b0a 2020   ir1; ++ir) {.  
+000668d0: 2020 2020 2020 2f2f 2071 2069 6e64 6963        // q indic
+000668e0: 6573 0a20 2020 2020 2020 2063 6f6e 7374  es.        const
+000668f0: 2069 6e74 2069 7133 203d 2069 722f 286e   int iq3 = ir/(n
+00066900: 6571 322a 6e65 7131 293b 0a20 2020 2020  eq2*neq1);.     
+00066910: 2020 2063 6f6e 7374 2069 6e74 2069 7132     const int iq2
+00066920: 203d 2028 6972 202d 2069 7133 2a6e 6571   = (ir - iq3*neq
+00066930: 322a 6e65 7131 292f 6e65 7131 3b0a 2020  2*neq1)/neq1;.  
+00066940: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00066950: 6971 3120 3d20 2869 7220 2d20 6971 332a  iq1 = (ir - iq3*
+00066960: 6e65 7132 2a6e 6571 3120 2d20 6971 322a  neq2*neq1 - iq2*
+00066970: 6e65 7131 293b 0a0a 2020 2020 2020 2020  neq1);..        
+00066980: 666c 6f61 7420 2a20 5320 3d20 2866 6c6f  float * S = (flo
+00066990: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
+000669a0: 6174 6120 2b20 6974 682a 2832 2a4d 7570  ata + ith*(2*Mup
+000669b0: 202b 2043 4143 4845 5f4c 494e 455f 5349   + CACHE_LINE_SI
+000669c0: 5a45 5f46 3332 293b 0a0a 2020 2020 2020  ZE_F32);..      
+000669d0: 2020 666f 7220 2869 6e74 2069 203d 204d    for (int i = M
+000669e0: 3b20 6920 3c20 4d75 703b 202b 2b69 2920  ; i < Mup; ++i) 
+000669f0: 7b0a 2020 2020 2020 2020 2020 2020 535b  {.            S[
+00066a00: 695d 203d 202d 494e 4649 4e49 5459 3b0a  i] = -INFINITY;.
+00066a10: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00066a20: 2020 2069 6620 2847 474d 4c5f 5645 435f     if (GGML_VEC_
+00066a30: 444f 545f 554e 524f 4c4c 203e 2032 207c  DOT_UNROLL > 2 |
+00066a40: 7c20 6e65 6b31 2025 2047 474d 4c5f 5645  | nek1 % GGML_VE
+00066a50: 435f 444f 545f 554e 524f 4c4c 2021 3d20  C_DOT_UNROLL != 
+00066a60: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+00066a70: 2066 6f72 2028 696e 7436 345f 7420 6963   for (int64_t ic
+00066a80: 203d 2030 3b20 6963 203c 206e 656b 313b   = 0; ic < nek1;
+00066a90: 202b 2b69 6329 207b 0a20 2020 2020 2020   ++ic) {.       
+00066aa0: 2020 2020 2020 2020 202f 2f20 6b20 696e           // k in
+00066ab0: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
+00066ac0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00066ad0: 696b 3320 3d20 6971 333b 0a20 2020 2020  ik3 = iq3;.     
+00066ae0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00066af0: 2069 6e74 2069 6b32 203d 2069 7132 3b0a   int ik2 = iq2;.
+00066b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066b10: 636f 6e73 7420 696e 7420 696b 3120 3d20  const int ik1 = 
+00066b20: 6963 3b0a 0a20 2020 2020 2020 2020 2020  ic;..           
+00066b30: 2020 2020 202f 2f20 5320 696e 6469 6365       // S indice
+00066b40: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00066b50: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
+00066b60: 2069 6b31 3b0a 0a20 2020 2020 2020 2020   ik1;..         
+00066b70: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00066b80: 646f 745f 6631 3628 6e65 7130 2c0a 2020  dot_f16(neq0,.  
+00066b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066ba0: 2020 2020 2020 5320 2b20 6931 2c0a 2020        S + i1,.  
+00066bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066bc0: 2020 2020 2020 2867 676d 6c5f 6670 3136        (ggml_fp16
+00066bd0: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
+00066be0: 6b2d 3e64 6174 6120 2b20 2869 6b31 2a6e  k->data + (ik1*n
+00066bf0: 626b 3120 2b20 696b 322a 6e62 6b32 202b  bk1 + ik2*nbk2 +
+00066c00: 2069 6b33 2a6e 626b 3329 292c 0a20 2020   ik3*nbk3)),.   
+00066c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066c20: 2020 2020 2028 6767 6d6c 5f66 7031 365f       (ggml_fp16_
+00066c30: 7420 2a29 2028 2863 6861 7220 2a29 2071  t *) ((char *) q
+00066c40: 2d3e 6461 7461 202b 2028 6971 312a 6e62  ->data + (iq1*nb
+00066c50: 7131 202b 2069 7132 2a6e 6271 3220 2b20  q1 + iq2*nbq2 + 
+00066c60: 6971 332a 6e62 7133 2929 293b 0a20 2020  iq3*nbq3)));.   
+00066c70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00066c80: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+00066c90: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00066ca0: 3634 5f74 2069 6320 3d20 303b 2069 6320  64_t ic = 0; ic 
+00066cb0: 3c20 6e65 6b31 3b20 6963 202b 3d20 4747  < nek1; ic += GG
+00066cc0: 4d4c 5f56 4543 5f44 4f54 5f55 4e52 4f4c  ML_VEC_DOT_UNROL
+00066cd0: 4c29 207b 0a20 2020 2020 2020 2020 2020  L) {.           
+00066ce0: 2020 2020 202f 2f20 6b20 696e 6469 6365       // k indice
+00066cf0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00066d00: 2020 636f 6e73 7420 696e 7420 696b 3320    const int ik3 
+00066d10: 3d20 6971 333b 0a20 2020 2020 2020 2020  = iq3;.         
+00066d20: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00066d30: 2069 6b32 203d 2069 7132 3b0a 2020 2020   ik2 = iq2;.    
+00066d40: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00066d50: 7420 696e 7420 696b 3120 3d20 6963 3b0a  t int ik1 = ic;.
+00066d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00066d70: 202f 2f20 5320 696e 6469 6365 730a 2020   // S indices.  
+00066d80: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00066d90: 6e73 7420 696e 7420 6931 203d 2069 6b31  nst int i1 = ik1
+00066da0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00066db0: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
+00066dc0: 6631 365f 756e 726f 6c6c 286e 6571 302c  f16_unroll(neq0,
+00066dd0: 206e 626b 312c 0a20 2020 2020 2020 2020   nbk1,.         
+00066de0: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+00066df0: 202b 2069 312c 0a20 2020 2020 2020 2020   + i1,.         
+00066e00: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00066e10: 2863 6861 7220 2a29 206b 2d3e 6461 7461  (char *) k->data
+00066e20: 202b 2028 696b 312a 6e62 6b31 202b 2069   + (ik1*nbk1 + i
+00066e30: 6b32 2a6e 626b 3220 2b20 696b 332a 6e62  k2*nbk2 + ik3*nb
+00066e40: 6b33 2929 2c0a 2020 2020 2020 2020 2020  k3)),.          
+00066e50: 2020 2020 2020 2020 2020 2020 2020 2867                (g
+00066e60: 676d 6c5f 6670 3136 5f74 202a 2920 2828  gml_fp16_t *) ((
+00066e70: 6368 6172 202a 2920 712d 3e64 6174 6120  char *) q->data 
+00066e80: 2b20 2869 7131 2a6e 6271 3120 2b20 6971  + (iq1*nbq1 + iq
+00066e90: 322a 6e62 7132 202b 2069 7133 2a6e 6271  2*nbq2 + iq3*nbq
+00066ea0: 3329 2929 3b0a 2020 2020 2020 2020 2020  3)));.          
+00066eb0: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
+00066ec0: 2020 2020 2020 202f 2f20 7363 616c 650a         // scale.
+00066ed0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00066ee0: 5f73 6361 6c65 5f66 3332 286e 656b 312c  _scale_f32(nek1,
+00066ef0: 2053 2c20 7363 616c 6529 3b0a 0a20 2020   S, scale);..   
+00066f00: 2020 2020 2069 6620 286d 6173 6b65 6429       if (masked)
+00066f10: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+00066f20: 6f72 2028 696e 7436 345f 7420 6920 3d20  or (int64_t i = 
+00066f30: 503b 2069 203c 204d 3b20 692b 2b29 207b  P; i < M; i++) {
+00066f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00066f50: 2069 6620 2869 203e 2050 202b 2069 7131   if (i > P + iq1
+00066f60: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00066f70: 2020 2020 2020 2020 535b 695d 203d 202d          S[i] = -
+00066f80: 494e 4649 4e49 5459 3b0a 2020 2020 2020  INFINITY;.      
+00066f90: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00066fa0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00066fb0: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+00066fc0: 736f 6674 6d61 780a 2020 2020 2020 2020  softmax.        
+00066fd0: 7b0a 2020 2020 2020 2020 2020 2020 666c  {.            fl
+00066fe0: 6f61 7420 6d61 7820 3d20 2d49 4e46 494e  oat max = -INFIN
+00066ff0: 4954 593b 0a20 2020 2020 2020 2020 2020  ITY;.           
+00067000: 2067 676d 6c5f 7665 635f 6d61 785f 6633   ggml_vec_max_f3
+00067010: 3228 4d2c 2026 6d61 782c 2053 293b 0a0a  2(M, &max, S);..
+00067020: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00067030: 5f66 6c6f 6174 2073 756d 203d 2030 2e30  _float sum = 0.0
+00067040: 3b0a 2020 2020 2020 2020 2020 2020 7b0a  ;.            {.
+00067050: 2369 6664 6566 2047 474d 4c5f 534f 4654  #ifdef GGML_SOFT
+00067060: 5f4d 4158 5f41 4343 454c 4552 4154 450a  _MAX_ACCELERATE.
+00067070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067080: 6d61 7820 3d20 2d6d 6178 3b0a 2020 2020  max = -max;.    
+00067090: 2020 2020 2020 2020 2020 2020 7644 5350              vDSP
+000670a0: 5f76 7361 6464 2853 2c20 312c 2026 6d61  _vsadd(S, 1, &ma
+000670b0: 782c 2053 2c20 312c 204d 7570 293b 0a20  x, S, 1, Mup);. 
+000670c0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+000670d0: 7665 7870 6628 532c 2053 2c20 264d 7570  vexpf(S, S, &Mup
+000670e0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+000670f0: 2020 2067 676d 6c5f 7665 635f 7375 6d5f     ggml_vec_sum_
+00067100: 6633 3228 4d75 702c 2026 7375 6d2c 2053  f32(Mup, &sum, S
+00067110: 293b 0a23 656c 7365 0a20 2020 2020 2020  );.#else.       
+00067120: 2020 2020 2020 2020 2075 696e 7431 365f           uint16_
+00067130: 7420 2020 7363 7674 5b47 474d 4c5f 534f  t   scvt[GGML_SO
+00067140: 4654 5f4d 4158 5f55 4e52 4f4c 4c5d 3b0a  FT_MAX_UNROLL];.
+00067150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067160: 6767 6d6c 5f66 6c6f 6174 2073 756d 705b  ggml_float sump[
+00067170: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
+00067180: 524f 4c4c 5d20 3d20 7b20 302e 3020 7d3b  ROLL] = { 0.0 };
+00067190: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000671a0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+000671b0: 3b20 6920 3c20 4d75 703b 2069 202b 3d20  ; i < Mup; i += 
+000671c0: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
+000671d0: 524f 4c4c 2920 7b0a 2020 2020 2020 2020  ROLL) {.        
+000671e0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+000671f0: 7420 2a20 5353 203d 2053 202b 2069 3b0a  t * SS = S + i;.
+00067200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00067210: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+00067220: 3d20 303b 206a 203c 2047 474d 4c5f 534f  = 0; j < GGML_SO
+00067230: 4654 5f4d 4158 5f55 4e52 4f4c 4c3b 202b  FT_MAX_UNROLL; +
+00067240: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
+00067250: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00067260: 2028 5353 5b6a 5d20 3d3d 202d 494e 4649   (SS[j] == -INFI
+00067270: 4e49 5459 2920 7b0a 2020 2020 2020 2020  NITY) {.        
+00067280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067290: 2020 2020 5353 5b6a 5d20 3d20 302e 3066      SS[j] = 0.0f
+000672a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000672b0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+000672c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000672d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000672e0: 676d 6c5f 6670 3136 5f74 2073 203d 2047  gml_fp16_t s = G
+000672f0: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+00067300: 2853 535b 6a5d 202d 206d 6178 293b 0a20  (SS[j] - max);. 
+00067310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067320: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
+00067330: 7928 2673 6376 745b 6a5d 2c20 2673 2c20  y(&scvt[j], &s, 
+00067340: 7369 7a65 6f66 2875 696e 7431 365f 7429  sizeof(uint16_t)
+00067350: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00067360: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00067370: 6f6e 7374 2066 6c6f 6174 2076 616c 203d  onst float val =
+00067380: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
+00067390: 3332 2874 6162 6c65 5f65 7870 5f66 3136  32(table_exp_f16
+000673a0: 5b73 6376 745b 6a5d 5d29 3b0a 2020 2020  [scvt[j]]);.    
+000673b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000673c0: 2020 2020 2020 2020 7375 6d70 5b6a 5d20          sump[j] 
+000673d0: 2b3d 2028 6767 6d6c 5f66 6c6f 6174 2976  += (ggml_float)v
+000673e0: 616c 3b0a 2020 2020 2020 2020 2020 2020  al;.            
 000673f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067400: 2020 2020 2020 2073 756d 705b 6a5d 202b         sump[j] +
-00067410: 3d20 2867 676d 6c5f 666c 6f61 7429 7661  = (ggml_float)va
-00067420: 6c3b 0a20 2020 2020 2020 2020 2020 2020  l;.             
-00067430: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-00067440: 535b 6a5d 203d 2076 616c 3b0a 2020 2020  S[j] = val;.    
+00067400: 5353 5b6a 5d20 3d20 7661 6c3b 0a20 2020  SS[j] = val;.   
+00067410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067420: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00067430: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00067440: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
 00067450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067460: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00067470: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00067480: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-00067490: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000674a0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-000674b0: 203c 2047 474d 4c5f 534f 4654 5f4d 4158   < GGML_SOFT_MAX
-000674c0: 5f55 4e52 4f4c 4c3b 2069 2b2b 2920 7b0a  _UNROLL; i++) {.
-000674d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000674e0: 2020 2020 7375 6d20 2b3d 2073 756d 705b      sum += sump[
-000674f0: 695d 3b0a 2020 2020 2020 2020 2020 2020  i];.            
-00067500: 2020 2020 7d0a 2365 6e64 6966 0a20 2020      }.#endif.   
-00067510: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00067520: 2020 2020 2020 2020 6173 7365 7274 2873          assert(s
-00067530: 756d 203e 2030 2e30 293b 0a0a 2020 2020  um > 0.0);..    
-00067540: 2020 2020 2020 2020 7375 6d20 3d20 312e          sum = 1.
-00067550: 302f 7375 6d3b 0a20 2020 2020 2020 2020  0/sum;.         
-00067560: 2020 2067 676d 6c5f 7665 635f 7363 616c     ggml_vec_scal
-00067570: 655f 6633 3228 4d2c 2053 2c20 7375 6d29  e_f32(M, S, sum)
-00067580: 3b0a 0a23 6966 6e64 6566 204e 4445 4255  ;..#ifndef NDEBU
-00067590: 470a 2020 2020 2020 2020 2020 2020 666f  G.            fo
-000675a0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-000675b0: 3c20 4d3b 202b 2b69 2920 7b0a 2020 2020  < M; ++i) {.    
-000675c0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000675d0: 7274 2821 6973 6e61 6e28 535b 695d 2929  rt(!isnan(S[i]))
-000675e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000675f0: 2020 6173 7365 7274 2821 6973 696e 6628    assert(!isinf(
-00067600: 535b 695d 2929 3b0a 2020 2020 2020 2020  S[i]));.        
-00067610: 2020 2020 7d0a 2365 6e64 6966 0a20 2020      }.#endif.   
-00067620: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00067630: 6767 6d6c 5f66 7031 365f 7420 2a20 5331  ggml_fp16_t * S1
-00067640: 3620 3d20 2867 676d 6c5f 6670 3136 5f74  6 = (ggml_fp16_t
-00067650: 202a 2920 2828 666c 6f61 7420 2a29 2070   *) ((float *) p
-00067660: 6172 616d 732d 3e77 6461 7461 202b 2069  arams->wdata + i
-00067670: 7468 2a28 322a 4d75 7020 2b20 4341 4348  th*(2*Mup + CACH
-00067680: 455f 4c49 4e45 5f53 495a 455f 4633 3229  E_LINE_SIZE_F32)
-00067690: 202b 204d 7570 293b 0a0a 2020 2020 2020   + Mup);..      
-000676a0: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-000676b0: 203d 2030 3b20 6920 3c20 4d3b 2069 2b2b   = 0; i < M; i++
-000676c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000676d0: 5331 365b 695d 203d 2047 474d 4c5f 4650  S16[i] = GGML_FP
-000676e0: 3332 5f54 4f5f 4650 3136 2853 5b69 5d29  32_TO_FP16(S[i])
-000676f0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-00067700: 2020 2020 2069 6620 2847 474d 4c5f 5645       if (GGML_VE
-00067710: 435f 444f 545f 554e 524f 4c4c 203d 3d20  C_DOT_UNROLL == 
-00067720: 3120 7c7c 2028 6e65 7631 2025 2047 474d  1 || (nev1 % GGM
-00067730: 4c5f 5645 435f 444f 545f 554e 524f 4c4c  L_VEC_DOT_UNROLL
-00067740: 2021 3d20 3029 2920 7b0a 2020 2020 2020   != 0)) {.      
-00067750: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00067760: 5f74 2069 6320 3d20 303b 2069 6320 3c20  _t ic = 0; ic < 
-00067770: 6e65 7631 3b20 2b2b 6963 2920 7b0a 2020  nev1; ++ic) {.  
-00067780: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-00067790: 2064 7374 2069 6e64 6963 6573 0a20 2020   dst indices.   
-000677a0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-000677b0: 7374 2069 6e74 2069 3120 3d20 6971 313b  st int i1 = iq1;
-000677c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000677d0: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
-000677e0: 6971 323b 0a20 2020 2020 2020 2020 2020  iq2;.           
-000677f0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00067800: 3320 3d20 6971 333b 0a0a 2020 2020 2020  3 = iq3;..      
-00067810: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-00067820: 6563 5f64 6f74 5f66 3136 286e 656b 312c  ec_dot_f16(nek1,
-00067830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067840: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-00067850: 2a29 2020 2020 2020 2028 2863 6861 7220  *)       ((char 
-00067860: 2a29 2064 7374 2d3e 6461 7461 202b 2028  *) dst->data + (
-00067870: 6963 2a6e 6230 202b 2069 312a 6e62 3120  ic*nb0 + i1*nb1 
-00067880: 202b 2069 322a 6e62 3220 202b 2069 332a   + i2*nb2  + i3*
-00067890: 6e62 3329 292c 0a20 2020 2020 2020 2020  nb3)),.         
-000678a0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000678b0: 6767 6d6c 5f66 7031 365f 7420 2a29 2028  ggml_fp16_t *) (
-000678c0: 2863 6861 7220 2a29 2076 2d3e 6461 7461  (char *) v->data
-000678d0: 2020 202b 2028 2020 2020 2020 2020 2069     + (         i
-000678e0: 632a 6e62 7631 202b 2069 322a 6e62 7632  c*nbv1 + i2*nbv2
-000678f0: 202b 2069 332a 6e62 7633 2929 2c0a 2020   + i3*nbv3)),.  
-00067900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067910: 2020 2020 2020 5331 3629 3b0a 2020 2020        S16);.    
-00067920: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00067930: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-00067940: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00067950: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
-00067960: 206e 6576 313b 2069 6320 2b3d 2047 474d   nev1; ic += GGM
-00067970: 4c5f 5645 435f 444f 545f 554e 524f 4c4c  L_VEC_DOT_UNROLL
-00067980: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00067990: 2020 2020 2f2f 2064 7374 2069 6e64 6963      // dst indic
-000679a0: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-000679b0: 2020 2063 6f6e 7374 2069 6e74 2069 3120     const int i1 
-000679c0: 3d20 6971 313b 0a20 2020 2020 2020 2020  = iq1;.         
-000679d0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-000679e0: 2069 3220 3d20 6971 323b 0a20 2020 2020   i2 = iq2;.     
-000679f0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00067a00: 2069 6e74 2069 3320 3d20 6971 333b 0a0a   int i3 = iq3;..
-00067a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067a20: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3136  ggml_vec_dot_f16
-00067a30: 5f75 6e72 6f6c 6c28 6e65 6b31 2c20 6e62  _unroll(nek1, nb
-00067a40: 7631 2c0a 2020 2020 2020 2020 2020 2020  v1,.            
-00067a50: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
-00067a60: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-00067a70: 6473 742d 3e64 6174 6120 2b20 2869 632a  dst->data + (ic*
-00067a80: 6e62 3020 2b20 6931 2a6e 6231 2020 2b20  nb0 + i1*nb1  + 
-00067a90: 6932 2a6e 6232 2020 2b20 6933 2a6e 6233  i2*nb2  + i3*nb3
-00067aa0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00067ab0: 2020 2020 2020 2020 2020 2020 2828 6368              ((ch
-00067ac0: 6172 202a 2920 762d 3e64 6174 6120 2020  ar *) v->data   
-00067ad0: 2b20 2820 2020 2020 2020 2020 6963 2a6e  + (         ic*n
-00067ae0: 6276 3120 2b20 6932 2a6e 6276 3220 2b20  bv1 + i2*nbv2 + 
-00067af0: 6933 2a6e 6276 3329 292c 0a20 2020 2020  i3*nbv3)),.     
-00067b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067b10: 2020 2053 3136 293b 0a20 2020 2020 2020     S16);.       
-00067b20: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00067b30: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-00067b40: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00067b50: 7465 5f66 6f72 7761 7264 5f66 6c61 7368  te_forward_flash
-00067b60: 5f61 7474 6e28 0a20 2020 2020 2020 2063  _attn(.        c
-00067b70: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00067b80: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00067b90: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00067ba0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00067bb0: 676d 6c5f 7465 6e73 6f72 202a 2071 2c0a  gml_tensor * q,.
-00067bc0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00067bd0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00067be0: 202a 206b 2c0a 2020 2020 2020 2020 636f   * k,.        co
-00067bf0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00067c00: 7465 6e73 6f72 202a 2076 2c0a 2020 2020  tensor * v,.    
-00067c10: 2020 2020 636f 6e73 7420 626f 6f6c 206d      const bool m
-00067c20: 6173 6b65 642c 0a20 2020 2020 2020 2073  asked,.        s
-00067c30: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00067c40: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
-00067c50: 7769 7463 6820 2871 2d3e 7479 7065 2920  witch (q->type) 
-00067c60: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-00067c70: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-00067c80: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00067c90: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00067ca0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00067cb0: 5f66 6c61 7368 5f61 7474 6e5f 6631 3628  _flash_attn_f16(
-00067cc0: 7061 7261 6d73 2c20 712c 206b 2c20 762c  params, q, k, v,
-00067cd0: 206d 6173 6b65 642c 2064 7374 293b 0a20   masked, dst);. 
-00067ce0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00067cf0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00067d00: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-00067d10: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00067d20: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00067d30: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00067d40: 7264 5f66 6c61 7368 5f61 7474 6e5f 6633  rd_flash_attn_f3
-00067d50: 3228 7061 7261 6d73 2c20 712c 206b 2c20  2(params, q, k, 
-00067d60: 762c 206d 6173 6b65 642c 2064 7374 293b  v, masked, dst);
-00067d70: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00067d80: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
-00067d90: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
-00067da0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00067db0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00067dc0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00067dd0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00067de0: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
-00067df0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f66  ompute_forward_f
-00067e00: 6c61 7368 5f66 660a 0a73 7461 7469 6320  lash_ff..static 
-00067e10: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-00067e20: 655f 666f 7277 6172 645f 666c 6173 685f  e_forward_flash_
-00067e30: 6666 5f66 3136 280a 2020 2020 2020 2020  ff_f16(.        
-00067e40: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00067e50: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00067e60: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00067e70: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00067e80: 6767 6d6c 5f74 656e 736f 7220 2a20 612c  ggml_tensor * a,
-00067e90: 2020 2f2f 2046 3136 0a20 2020 2020 2020    // F16.       
-00067ea0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00067eb0: 6d6c 5f74 656e 736f 7220 2a20 6230 2c20  ml_tensor * b0, 
-00067ec0: 2f2f 2046 3136 2066 635f 770a 2020 2020  // F16 fc_w.    
-00067ed0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00067ee0: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
-00067ef0: 312c 202f 2f20 4633 3220 6663 5f62 0a20  1, // F32 fc_b. 
-00067f00: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00067f10: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00067f20: 2a20 6330 2c20 2f2f 2046 3136 2070 726f  * c0, // F16 pro
-00067f30: 6a5f 770a 2020 2020 2020 2020 636f 6e73  j_w.        cons
-00067f40: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00067f50: 6e73 6f72 202a 2063 312c 202f 2f20 4633  nsor * c1, // F3
-00067f60: 3220 7072 6f6a 5f62 0a20 2020 2020 2020  2 proj_b.       
-00067f70: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00067f80: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00067f90: 2069 6e74 3634 5f74 2074 3020 3d20 6767   int64_t t0 = gg
-00067fa0: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
-00067fb0: 293b 0a20 2020 2055 4e55 5345 4428 7430  );.    UNUSED(t0
-00067fc0: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
-00067fd0: 7436 345f 7420 6e65 6130 203d 2061 2d3e  t64_t nea0 = a->
-00067fe0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-00067ff0: 2069 6e74 3634 5f74 206e 6561 3120 3d20   int64_t nea1 = 
-00068000: 612d 3e6e 655b 315d 3b0a 2020 2020 636f  a->ne[1];.    co
-00068010: 6e73 7420 696e 7436 345f 7420 6e65 6132  nst int64_t nea2
-00068020: 203d 2061 2d3e 6e65 5b32 5d3b 0a20 2020   = a->ne[2];.   
-00068030: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00068040: 6561 3320 3d20 612d 3e6e 655b 335d 3b0a  ea3 = a->ne[3];.
-00068050: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00068060: 5f74 206e 6562 3030 203d 2062 302d 3e6e  _t neb00 = b0->n
-00068070: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-00068080: 696e 7436 345f 7420 6e65 6230 3120 3d20  int64_t neb01 = 
-00068090: 6230 2d3e 6e65 5b31 5d3b 0a20 2020 202f  b0->ne[1];.    /
-000680a0: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-000680b0: 6562 3032 203d 2062 302d 3e6e 655b 325d  eb02 = b0->ne[2]
-000680c0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-000680d0: 7436 345f 7420 6e65 6230 3320 3d20 6230  t64_t neb03 = b0
-000680e0: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
-000680f0: 6e73 7420 696e 7436 345f 7420 6e65 6231  nst int64_t neb1
-00068100: 3020 3d20 6231 2d3e 6e65 5b30 5d3b 0a20  0 = b1->ne[0];. 
-00068110: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00068120: 206e 6562 3131 203d 2062 312d 3e6e 655b   neb11 = b1->ne[
-00068130: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
-00068140: 696e 7436 345f 7420 6e65 6231 3220 3d20  int64_t neb12 = 
-00068150: 6231 2d3e 6e65 5b32 5d3b 0a20 2020 202f  b1->ne[2];.    /
-00068160: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-00068170: 6562 3133 203d 2062 312d 3e6e 655b 335d  eb13 = b1->ne[3]
-00068180: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00068190: 3634 5f74 206e 6563 3030 203d 2063 302d  64_t nec00 = c0-
-000681a0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-000681b0: 7420 696e 7436 345f 7420 6e65 6330 3120  t int64_t nec01 
-000681c0: 3d20 6330 2d3e 6e65 5b31 5d3b 0a20 2020  = c0->ne[1];.   
-000681d0: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-000681e0: 206e 6563 3032 203d 2063 302d 3e6e 655b   nec02 = c0->ne[
-000681f0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-00068200: 696e 7436 345f 7420 6e65 6330 3320 3d20  int64_t nec03 = 
-00068210: 6330 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c0->ne[3];..    
-00068220: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00068230: 6331 3020 3d20 6331 2d3e 6e65 5b30 5d3b  c10 = c1->ne[0];
-00068240: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00068250: 5f74 206e 6563 3131 203d 2063 312d 3e6e  _t nec11 = c1->n
-00068260: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
-00068270: 7420 696e 7436 345f 7420 6e65 6331 3220  t int64_t nec12 
-00068280: 3d20 6331 2d3e 6e65 5b32 5d3b 0a20 2020  = c1->ne[2];.   
-00068290: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-000682a0: 206e 6563 3133 203d 2063 312d 3e6e 655b   nec13 = c1->ne[
-000682b0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-000682c0: 6e74 3634 5f74 206e 6530 203d 2064 7374  nt64_t ne0 = dst
-000682d0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
-000682e0: 7374 2069 6e74 3634 5f74 206e 6531 203d  st int64_t ne1 =
-000682f0: 2064 7374 2d3e 6e65 5b31 5d3b 0a20 2020   dst->ne[1];.   
-00068300: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00068310: 6532 203d 2064 7374 2d3e 6e65 5b32 5d3b  e2 = dst->ne[2];
-00068320: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00068330: 3634 5f74 206e 6533 203d 2064 7374 2d3e  64_t ne3 = dst->
-00068340: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
-00068350: 7420 696e 7420 6e62 6130 203d 2061 2d3e  t int nba0 = a->
-00068360: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-00068370: 2069 6e74 206e 6261 3120 3d20 612d 3e6e   int nba1 = a->n
-00068380: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
-00068390: 696e 7420 6e62 6132 203d 2061 2d3e 6e62  int nba2 = a->nb
-000683a0: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
-000683b0: 6e74 206e 6261 3320 3d20 612d 3e6e 625b  nt nba3 = a->nb[
-000683c0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-000683d0: 6e74 206e 6262 3030 203d 2062 302d 3e6e  nt nbb00 = b0->n
-000683e0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-000683f0: 696e 7420 6e62 6230 3120 3d20 6230 2d3e  int nbb01 = b0->
-00068400: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-00068410: 2069 6e74 206e 6262 3032 203d 2062 302d   int nbb02 = b0-
-00068420: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
-00068430: 7420 696e 7420 6e62 6230 3320 3d20 6230  t int nbb03 = b0
-00068440: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
-00068450: 6e73 7420 696e 7420 6e62 6231 3020 3d20  nst int nbb10 = 
-00068460: 6231 2d3e 6e62 5b30 5d3b 0a20 2020 202f  b1->nb[0];.    /
-00068470: 2f63 6f6e 7374 2069 6e74 206e 6262 3131  /const int nbb11
-00068480: 203d 2062 312d 3e6e 625b 315d 3b0a 2020   = b1->nb[1];.  
-00068490: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
-000684a0: 6231 3220 3d20 6231 2d3e 6e62 5b32 5d3b  b12 = b1->nb[2];
-000684b0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-000684c0: 206e 6262 3133 203d 2062 312d 3e6e 625b   nbb13 = b1->nb[
-000684d0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-000684e0: 6e74 206e 6263 3030 203d 2063 302d 3e6e  nt nbc00 = c0->n
-000684f0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-00068500: 696e 7420 6e62 6330 3120 3d20 6330 2d3e  int nbc01 = c0->
-00068510: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-00068520: 2069 6e74 206e 6263 3032 203d 2063 302d   int nbc02 = c0-
-00068530: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
-00068540: 7420 696e 7420 6e62 6330 3320 3d20 6330  t int nbc03 = c0
-00068550: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
-00068560: 6e73 7420 696e 7420 6e62 6331 3020 3d20  nst int nbc10 = 
-00068570: 6331 2d3e 6e62 5b30 5d3b 0a20 2020 202f  c1->nb[0];.    /
-00068580: 2f63 6f6e 7374 2069 6e74 206e 6263 3131  /const int nbc11
-00068590: 203d 2063 312d 3e6e 625b 315d 3b0a 2020   = c1->nb[1];.  
-000685a0: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
-000685b0: 6331 3220 3d20 6331 2d3e 6e62 5b32 5d3b  c12 = c1->nb[2];
-000685c0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-000685d0: 206e 6263 3133 203d 2063 312d 3e6e 625b   nbc13 = c1->nb[
-000685e0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-000685f0: 6e74 206e 6230 203d 2064 7374 2d3e 6e62  nt nb0 = dst->nb
-00068600: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-00068610: 6e74 206e 6231 203d 2064 7374 2d3e 6e62  nt nb1 = dst->nb
-00068620: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-00068630: 6e74 206e 6232 203d 2064 7374 2d3e 6e62  nt nb2 = dst->nb
-00068640: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
-00068650: 6e74 206e 6233 203d 2064 7374 2d3e 6e62  nt nb3 = dst->nb
-00068660: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-00068670: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
-00068680: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-00068690: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
-000686a0: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
-000686b0: 7374 2069 6e74 3634 5f74 2044 203d 206e  st int64_t D = n
-000686c0: 6561 303b 0a20 2020 202f 2f63 6f6e 7374  ea0;.    //const
-000686d0: 2069 6e74 3634 5f74 204e 203d 206e 6561   int64_t N = nea
-000686e0: 313b 0a20 2020 2063 6f6e 7374 2069 6e74  1;.    const int
-000686f0: 3634 5f74 204d 203d 206e 6562 3031 3b0a  64_t M = neb01;.
-00068700: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00068710: 286e 6530 203d 3d20 6e65 6130 293b 0a20  (ne0 == nea0);. 
-00068720: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00068730: 6531 203d 3d20 6e65 6131 293b 0a20 2020  e1 == nea1);.   
-00068740: 2047 474d 4c5f 4153 5345 5254 286e 6532   GGML_ASSERT(ne2
-00068750: 203d 3d20 6e65 6132 293b 0a0a 2020 2020   == nea2);..    
-00068760: 4747 4d4c 5f41 5353 4552 5428 6e62 6130  GGML_ASSERT(nba0
-00068770: 2020 3d3d 2073 697a 656f 6628 6767 6d6c    == sizeof(ggml
-00068780: 5f66 7031 365f 7429 293b 0a20 2020 2047  _fp16_t));.    G
-00068790: 474d 4c5f 4153 5345 5254 286e 6262 3030  GML_ASSERT(nbb00
-000687a0: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
-000687b0: 6670 3136 5f74 2929 3b0a 2020 2020 4747  fp16_t));.    GG
-000687c0: 4d4c 5f41 5353 4552 5428 6e62 6231 3020  ML_ASSERT(nbb10 
-000687d0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-000687e0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000687f0: 5254 286e 6263 3030 203d 3d20 7369 7a65  RT(nbc00 == size
-00068800: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
-00068810: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00068820: 5428 6e62 6331 3020 3d3d 2073 697a 656f  T(nbc10 == sizeo
-00068830: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
-00068840: 4747 4d4c 5f41 5353 4552 5428 6e65 6230  GGML_ASSERT(neb0
-00068850: 3020 3d3d 2044 293b 0a20 2020 2047 474d  0 == D);.    GGM
-00068860: 4c5f 4153 5345 5254 286e 6562 3031 203d  L_ASSERT(neb01 =
-00068870: 3d20 4d29 3b0a 2020 2020 4747 4d4c 5f41  = M);.    GGML_A
-00068880: 5353 4552 5428 6e65 6231 3020 3d3d 204d  SSERT(neb10 == M
-00068890: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000688a0: 5254 286e 6562 3131 203d 3d20 3129 3b0a  RT(neb11 == 1);.
-000688b0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000688c0: 286e 6563 3030 203d 3d20 4d29 3b0a 2020  (nec00 == M);.  
-000688d0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-000688e0: 6330 3120 3d3d 2044 293b 0a20 2020 2047  c01 == D);.    G
-000688f0: 474d 4c5f 4153 5345 5254 286e 6563 3130  GML_ASSERT(nec10
-00068900: 203d 3d20 4429 3b0a 2020 2020 4747 4d4c   == D);.    GGML
-00068910: 5f41 5353 4552 5428 6e65 6331 3120 3d3d  _ASSERT(nec11 ==
-00068920: 2031 293b 0a0a 2020 2020 2f2f 2064 7374   1);..    // dst
-00068930: 2063 616e 6e6f 7420 6265 2074 7261 6e73   cannot be trans
-00068940: 706f 7365 6420 6f72 2070 6572 6d75 7465  posed or permute
-00068950: 640a 2020 2020 4747 4d4c 5f41 5353 4552  d.    GGML_ASSER
-00068960: 5428 6e62 3020 3d3d 2073 697a 656f 6628  T(nb0 == sizeof(
-00068970: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
-00068980: 4c5f 4153 5345 5254 286e 6230 203c 3d20  L_ASSERT(nb0 <= 
-00068990: 6e62 3129 3b0a 2020 2020 4747 4d4c 5f41  nb1);.    GGML_A
-000689a0: 5353 4552 5428 6e62 3120 3c3d 206e 6232  SSERT(nb1 <= nb2
-000689b0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000689c0: 5254 286e 6232 203c 3d20 6e62 3329 3b0a  RT(nb2 <= nb3);.
-000689d0: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-000689e0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-000689f0: 534b 5f49 4e49 5429 207b 0a20 2020 2020  SK_INIT) {.     
-00068a00: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-00068a10: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-00068a20: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00068a30: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-00068a40: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00068a50: 2020 2020 7d0a 0a20 2020 202f 2f20 7061      }..    // pa
-00068a60: 7261 6c6c 656c 697a 6520 6279 2061 2072  rallelize by a r
-00068a70: 6f77 7320 7573 696e 6720 6767 6d6c 5f76  ows using ggml_v
-00068a80: 6563 5f64 6f74 5f66 3332 0a0a 2020 2020  ec_dot_f32..    
-00068a90: 2f2f 2074 6f74 616c 2072 6f77 7320 696e  // total rows in
-00068aa0: 2061 0a20 2020 2063 6f6e 7374 2069 6e74   a.    const int
-00068ab0: 206e 7220 3d20 6e65 6131 2a6e 6561 322a   nr = nea1*nea2*
-00068ac0: 6e65 6133 3b0a 0a20 2020 202f 2f20 726f  nea3;..    // ro
-00068ad0: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
-00068ae0: 2020 636f 6e73 7420 696e 7420 6472 203d    const int dr =
-00068af0: 2028 6e72 202b 206e 7468 202d 2031 292f   (nr + nth - 1)/
-00068b00: 6e74 683b 0a0a 2020 2020 2f2f 2072 6f77  nth;..    // row
-00068b10: 2072 616e 6765 2066 6f72 2074 6869 7320   range for this 
-00068b20: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-00068b30: 2069 6e74 2069 7230 203d 2064 722a 6974   int ir0 = dr*it
-00068b40: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-00068b50: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
-00068b60: 2064 722c 206e 7229 3b0a 0a20 2020 2066   dr, nr);..    f
-00068b70: 6f72 2028 696e 7420 6972 203d 2069 7230  or (int ir = ir0
-00068b80: 3b20 6972 203c 2069 7231 3b20 2b2b 6972  ; ir < ir1; ++ir
-00068b90: 2920 7b0a 2020 2020 2020 2020 2f2f 2061  ) {.        // a
-00068ba0: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-00068bb0: 2063 6f6e 7374 2069 6e74 2069 6133 203d   const int ia3 =
-00068bc0: 2069 722f 286e 6561 322a 6e65 6131 293b   ir/(nea2*nea1);
-00068bd0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-00068be0: 6e74 2069 6132 203d 2028 6972 202d 2069  nt ia2 = (ir - i
-00068bf0: 6133 2a6e 6561 322a 6e65 6131 292f 6e65  a3*nea2*nea1)/ne
-00068c00: 6131 3b0a 2020 2020 2020 2020 636f 6e73  a1;.        cons
-00068c10: 7420 696e 7420 6961 3120 3d20 2869 7220  t int ia1 = (ir 
-00068c20: 2d20 6961 332a 6e65 6132 2a6e 6561 3120  - ia3*nea2*nea1 
-00068c30: 2d20 6961 322a 6e65 6131 293b 0a0a 2020  - ia2*nea1);..  
-00068c40: 2020 2020 2020 666c 6f61 7420 2a20 5320        float * S 
-00068c50: 3d20 2866 6c6f 6174 202a 2920 7061 7261  = (float *) para
-00068c60: 6d73 2d3e 7764 6174 6120 2b20 6974 682a  ms->wdata + ith*
-00068c70: 2832 2a4d 202b 2043 4143 4845 5f4c 494e  (2*M + CACHE_LIN
-00068c80: 455f 5349 5a45 5f46 3332 293b 0a0a 2020  E_SIZE_F32);..  
-00068c90: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00068ca0: 5f74 2069 6320 3d20 303b 2069 6320 3c20  _t ic = 0; ic < 
-00068cb0: 6e65 6230 313b 202b 2b69 6329 207b 0a20  neb01; ++ic) {. 
-00068cc0: 2020 2020 2020 2020 2020 202f 2f20 6230             // b0
-00068cd0: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-00068ce0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00068cf0: 6230 3320 3d20 6961 333b 0a20 2020 2020  b03 = ia3;.     
-00068d00: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00068d10: 2069 6230 3220 3d20 6961 323b 0a20 2020   ib02 = ia2;.   
-00068d20: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00068d30: 6e74 2069 6230 3120 3d20 6963 3b0a 0a20  nt ib01 = ic;.. 
-00068d40: 2020 2020 2020 2020 2020 202f 2f20 5320             // S 
-00068d50: 696e 6469 6365 730a 2020 2020 2020 2020  indices.        
-00068d60: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
-00068d70: 203d 2069 6230 313b 0a0a 2020 2020 2020   = ib01;..      
-00068d80: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
-00068d90: 6f74 5f66 3136 286e 6561 302c 0a20 2020  ot_f16(nea0,.   
-00068da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068db0: 2053 202b 2069 312c 0a20 2020 2020 2020   S + i1,.       
-00068dc0: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
-00068dd0: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
-00068de0: 6861 7220 2a29 2062 302d 3e64 6174 6120  har *) b0->data 
-00068df0: 2b20 2869 6230 312a 6e62 6230 3120 2b20  + (ib01*nbb01 + 
-00068e00: 6962 3032 2a6e 6262 3032 202b 2069 6230  ib02*nbb02 + ib0
-00068e10: 332a 6e62 6230 3329 292c 0a20 2020 2020  3*nbb03)),.     
-00068e20: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00068e30: 6767 6d6c 5f66 7031 365f 7420 2a29 2028  ggml_fp16_t *) (
-00068e40: 2863 6861 7220 2a29 2020 612d 3e64 6174  (char *)  a->dat
-00068e50: 6120 2b20 2820 6961 312a 6e62 6131 2020  a + ( ia1*nba1  
-00068e60: 2b20 2069 6132 2a6e 6261 3220 202b 2020  +  ia2*nba2  +  
-00068e70: 6961 332a 6e62 6133 2929 293b 0a20 2020  ia3*nba3)));.   
-00068e80: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00068e90: 6767 6d6c 5f76 6563 5f61 6464 5f66 3332  ggml_vec_add_f32
-00068ea0: 286e 6562 3031 2c20 532c 2053 2c20 2866  (neb01, S, S, (f
-00068eb0: 6c6f 6174 202a 2920 6231 2d3e 6461 7461  loat *) b1->data
-00068ec0: 293b 0a20 2020 2020 2020 202f 2f67 676d  );.        //ggm
-00068ed0: 6c5f 7665 635f 6765 6c75 5f66 3332 286e  l_vec_gelu_f32(n
-00068ee0: 6562 3031 2c20 532c 2053 293b 0a0a 2020  eb01, S, S);..  
-00068ef0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
-00068f00: 7420 2a20 5331 3620 3d20 2867 676d 6c5f  t * S16 = (ggml_
-00068f10: 6670 3136 5f74 202a 2920 2828 666c 6f61  fp16_t *) ((floa
-00068f20: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
-00068f30: 7461 202b 2069 7468 2a28 322a 4d20 2b20  ta + ith*(2*M + 
-00068f40: 4341 4348 455f 4c49 4e45 5f53 495a 455f  CACHE_LINE_SIZE_
-00068f50: 4633 3229 202b 204d 293b 0a0a 2020 2020  F32) + M);..    
-00068f60: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-00068f70: 2069 203d 2030 3b20 6920 3c20 4d3b 2069   i = 0; i < M; i
-00068f80: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00068f90: 2020 5331 365b 695d 203d 2047 474d 4c5f    S16[i] = GGML_
-00068fa0: 4650 3332 5f54 4f5f 4650 3136 2853 5b69  FP32_TO_FP16(S[i
-00068fb0: 5d29 3b0a 2020 2020 2020 2020 7d0a 0a20  ]);.        }.. 
-00068fc0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00068fd0: 6765 6c75 5f66 3136 286e 6562 3031 2c20  gelu_f16(neb01, 
-00068fe0: 5331 362c 2053 3136 293b 0a0a 2020 2020  S16, S16);..    
-00068ff0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00069000: 2020 2f2f 2064 7374 2069 6e64 6963 6573    // dst indices
-00069010: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00069020: 7374 2069 6e74 2069 3120 3d20 6961 313b  st int i1 = ia1;
-00069030: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00069040: 7374 2069 6e74 2069 3220 3d20 6961 323b  st int i2 = ia2;
-00069050: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00069060: 7374 2069 6e74 2069 3320 3d20 6961 333b  st int i3 = ia3;
-00069070: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-00069080: 7220 2869 6e74 3634 5f74 2069 6320 3d20  r (int64_t ic = 
-00069090: 303b 2069 6320 3c20 6e65 6330 313b 202b  0; ic < nec01; +
-000690a0: 2b69 6329 207b 0a0a 2020 2020 2020 2020  +ic) {..        
-000690b0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-000690c0: 5f64 6f74 5f66 3136 286e 6562 3031 2c0a  _dot_f16(neb01,.
-000690d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000690e0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-000690f0: 2920 2020 2020 2020 2828 6368 6172 202a  )       ((char *
-00069100: 2920 6473 742d 3e64 6174 6120 2b20 2869  ) dst->data + (i
-00069110: 632a 6e62 3020 2b20 6931 2a6e 6231 2020  c*nb0 + i1*nb1  
-00069120: 202b 2069 322a 6e62 3220 2020 2b20 6933   + i2*nb2   + i3
-00069130: 2a6e 6233 2929 2c0a 2020 2020 2020 2020  *nb3)),.        
-00069140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069150: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
-00069160: 2828 6368 6172 202a 2920 6330 2d3e 6461  ((char *) c0->da
-00069170: 7461 2020 2b20 2820 2020 2020 2020 2020  ta  + (         
-00069180: 6963 2a6e 6263 3031 202b 2069 322a 6e62  ic*nbc01 + i2*nb
-00069190: 6330 3220 2b20 6933 2a6e 6263 3033 2929  c02 + i3*nbc03))
-000691a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000691b0: 2020 2020 2020 2020 2020 5331 3629 3b0a            S16);.
-000691c0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-000691d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000691e0: 7665 635f 6164 645f 6633 3228 6e65 6330  vec_add_f32(nec0
-000691f0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-00069200: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-00069210: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
-00069220: 6461 7461 202b 2028 6931 2a6e 6231 202b  data + (i1*nb1 +
-00069230: 2069 322a 6e62 3220 2b20 6933 2a6e 6233   i2*nb2 + i3*nb3
-00069240: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00069250: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-00069260: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
-00069270: 3e64 6174 6120 2b20 2869 312a 6e62 3120  >data + (i1*nb1 
-00069280: 2b20 6932 2a6e 6232 202b 2069 332a 6e62  + i2*nb2 + i3*nb
-00069290: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
-000692a0: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-000692b0: 2a29 2063 312d 3e64 6174 6129 3b0a 2020  *) c1->data);.  
-000692c0: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
-000692d0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-000692e0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000692f0: 645f 666c 6173 685f 6666 280a 2020 2020  d_flash_ff(.    
-00069300: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00069310: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00069320: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00069330: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00069340: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00069350: 2a20 612c 0a20 2020 2020 2020 2063 6f6e  * a,.        con
-00069360: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00069370: 656e 736f 7220 2a20 6230 2c0a 2020 2020  ensor * b0,.    
-00069380: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00069390: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
-000693a0: 312c 0a20 2020 2020 2020 2063 6f6e 7374  1,.        const
-000693b0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000693c0: 736f 7220 2a20 6330 2c0a 2020 2020 2020  sor * c0,.      
-000693d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000693e0: 676d 6c5f 7465 6e73 6f72 202a 2063 312c  gml_tensor * c1,
-000693f0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00069400: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00069410: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
-00069420: 2862 302d 3e74 7970 6529 207b 0a20 2020  (b0->type) {.   
-00069430: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00069440: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
-00069450: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00069460: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00069470: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
-00069480: 685f 6666 5f66 3136 2870 6172 616d 732c  h_ff_f16(params,
-00069490: 2061 2c20 6230 2c20 6231 2c20 6330 2c20   a, b0, b1, c0, 
-000694a0: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-000694b0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000694c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000694d0: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-000694e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000694f0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00069500: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
-00069510: 544f 444f 0a20 2020 2020 2020 2020 2020  TODO.           
-00069520: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00069530: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
-00069540: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00069550: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00069560: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00069570: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00069580: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
-00069590: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000695a0: 7264 5f66 6c61 7368 5f61 7474 6e5f 6261  rd_flash_attn_ba
-000695b0: 636b 0a0a 7374 6174 6963 2076 6f69 6420  ck..static void 
-000695c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-000695d0: 7761 7264 5f66 6c61 7368 5f61 7474 6e5f  ward_flash_attn_
-000695e0: 6261 636b 5f66 3332 280a 2020 2020 2020  back_f32(.      
-000695f0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00069600: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00069610: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00069620: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00069630: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00069640: 712c 0a20 2020 2020 2020 2063 6f6e 7374  q,.        const
-00069650: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00069660: 736f 7220 2a20 6b2c 0a20 2020 2020 2020  sor * k,.       
-00069670: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00069680: 6d6c 5f74 656e 736f 7220 2a20 762c 0a20  ml_tensor * v,. 
-00069690: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-000696a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000696b0: 2a20 642c 0a20 2020 2020 2020 2063 6f6e  * d,.        con
-000696c0: 7374 2062 6f6f 6c20 6d61 736b 6564 2c0a  st bool masked,.
-000696d0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-000696e0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000696f0: 202a 2064 7374 2920 7b0a 2020 2020 696e   * dst) {.    in
-00069700: 7436 345f 7420 7430 203d 2067 676d 6c5f  t64_t t0 = ggml_
-00069710: 7065 7266 5f74 696d 655f 7573 2829 3b0a  perf_time_us();.
-00069720: 2020 2020 554e 5553 4544 2874 3029 3b0a      UNUSED(t0);.
-00069730: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00069740: 5f74 206e 6571 3020 3d20 712d 3e6e 655b  _t neq0 = q->ne[
-00069750: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-00069760: 7436 345f 7420 6e65 7131 203d 2071 2d3e  t64_t neq1 = q->
-00069770: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
-00069780: 2069 6e74 3634 5f74 206e 6571 3220 3d20   int64_t neq2 = 
-00069790: 712d 3e6e 655b 325d 3b0a 2020 2020 636f  q->ne[2];.    co
-000697a0: 6e73 7420 696e 7436 345f 7420 6e65 7133  nst int64_t neq3
-000697b0: 203d 2071 2d3e 6e65 5b33 5d3b 0a0a 2020   = q->ne[3];..  
-000697c0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000697d0: 6e65 6b30 203d 206b 2d3e 6e65 5b30 5d3b  nek0 = k->ne[0];
-000697e0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-000697f0: 5f74 206e 656b 3120 3d20 6b2d 3e6e 655b  _t nek1 = k->ne[
-00069800: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
-00069810: 696e 7436 345f 7420 6e65 6b32 203d 206b  int64_t nek2 = k
-00069820: 2d3e 6e65 5b32 5d3b 0a20 2020 202f 2f63  ->ne[2];.    //c
-00069830: 6f6e 7374 2069 6e74 3634 5f74 206e 656b  onst int64_t nek
-00069840: 3320 3d20 6b2d 3e6e 655b 335d 3b0a 0a20  3 = k->ne[3];.. 
-00069850: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00069860: 206e 6576 3020 3d20 762d 3e6e 655b 305d   nev0 = v->ne[0]
-00069870: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00069880: 345f 7420 6e65 7631 203d 2076 2d3e 6e65  4_t nev1 = v->ne
-00069890: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
-000698a0: 2069 6e74 3634 5f74 206e 6576 3220 3d20   int64_t nev2 = 
-000698b0: 762d 3e6e 655b 325d 3b0a 2020 2020 2f2f  v->ne[2];.    //
-000698c0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-000698d0: 7633 203d 2076 2d3e 6e65 5b33 5d3b 0a0a  v3 = v->ne[3];..
-000698e0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-000698f0: 7420 6e65 6430 203d 2064 2d3e 6e65 5b30  t ned0 = d->ne[0
-00069900: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00069910: 3634 5f74 206e 6564 3120 3d20 642d 3e6e  64_t ned1 = d->n
-00069920: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
-00069930: 7420 696e 7436 345f 7420 6e65 6432 203d  t int64_t ned2 =
-00069940: 2064 2d3e 6e65 5b32 5d3b 0a20 2020 202f   d->ne[2];.    /
-00069950: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-00069960: 6564 3320 3d20 642d 3e6e 655b 335d 3b0a  ed3 = d->ne[3];.
-00069970: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00069980: 5f74 206e 6530 2020 3d20 6473 742d 3e6e  _t ne0  = dst->n
-00069990: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-000699a0: 696e 7436 345f 7420 6e65 3120 203d 2064  int64_t ne1  = d
-000699b0: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 2063  st->ne[1];.    c
-000699c0: 6f6e 7374 2069 6e74 3634 5f74 206e 6532  onst int64_t ne2
-000699d0: 2020 3d20 6473 742d 3e6e 655b 325d 3b0a    = dst->ne[2];.
-000699e0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-000699f0: 7420 6e65 3320 203d 2064 7374 2d3e 6e65  t ne3  = dst->ne
-00069a00: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-00069a10: 696e 7420 6e62 6b30 203d 206b 2d3e 6e62  int nbk0 = k->nb
-00069a20: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-00069a30: 6e74 206e 626b 3120 3d20 6b2d 3e6e 625b  nt nbk1 = k->nb[
-00069a40: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-00069a50: 7420 6e62 6b32 203d 206b 2d3e 6e62 5b32  t nbk2 = k->nb[2
+00067460: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+00067470: 6920 3c20 4747 4d4c 5f53 4f46 545f 4d41  i < GGML_SOFT_MA
+00067480: 585f 554e 524f 4c4c 3b20 692b 2b29 207b  X_UNROLL; i++) {
+00067490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000674a0: 2020 2020 2073 756d 202b 3d20 7375 6d70       sum += sump
+000674b0: 5b69 5d3b 0a20 2020 2020 2020 2020 2020  [i];.           
+000674c0: 2020 2020 207d 0a23 656e 6469 660a 2020       }.#endif.  
+000674d0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+000674e0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
+000674f0: 7375 6d20 3e20 302e 3029 3b0a 0a20 2020  sum > 0.0);..   
+00067500: 2020 2020 2020 2020 2073 756d 203d 2031           sum = 1
+00067510: 2e30 2f73 756d 3b0a 2020 2020 2020 2020  .0/sum;.        
+00067520: 2020 2020 6767 6d6c 5f76 6563 5f73 6361      ggml_vec_sca
+00067530: 6c65 5f66 3332 284d 2c20 532c 2073 756d  le_f32(M, S, sum
+00067540: 293b 0a0a 2369 666e 6465 6620 4e44 4542  );..#ifndef NDEB
+00067550: 5547 0a20 2020 2020 2020 2020 2020 2066  UG.            f
+00067560: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00067570: 203c 204d 3b20 2b2b 6929 207b 0a20 2020   < M; ++i) {.   
+00067580: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+00067590: 6572 7428 2169 736e 616e 2853 5b69 5d29  ert(!isnan(S[i])
+000675a0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+000675b0: 2020 2061 7373 6572 7428 2169 7369 6e66     assert(!isinf
+000675c0: 2853 5b69 5d29 293b 0a20 2020 2020 2020  (S[i]));.       
+000675d0: 2020 2020 207d 0a23 656e 6469 660a 2020       }.#endif.  
+000675e0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+000675f0: 2067 676d 6c5f 6670 3136 5f74 202a 2053   ggml_fp16_t * S
+00067600: 3136 203d 2028 6767 6d6c 5f66 7031 365f  16 = (ggml_fp16_
+00067610: 7420 2a29 2028 2866 6c6f 6174 202a 2920  t *) ((float *) 
+00067620: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
+00067630: 6974 682a 2832 2a4d 7570 202b 2043 4143  ith*(2*Mup + CAC
+00067640: 4845 5f4c 494e 455f 5349 5a45 5f46 3332  HE_LINE_SIZE_F32
+00067650: 2920 2b20 4d75 7029 3b0a 0a20 2020 2020  ) + Mup);..     
+00067660: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+00067670: 6920 3d20 303b 2069 203c 204d 3b20 692b  i = 0; i < M; i+
+00067680: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00067690: 2053 3136 5b69 5d20 3d20 4747 4d4c 5f46   S16[i] = GGML_F
+000676a0: 5033 325f 544f 5f46 5031 3628 535b 695d  P32_TO_FP16(S[i]
+000676b0: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
+000676c0: 2020 2020 2020 6966 2028 4747 4d4c 5f56        if (GGML_V
+000676d0: 4543 5f44 4f54 5f55 4e52 4f4c 4c20 3d3d  EC_DOT_UNROLL ==
+000676e0: 2031 207c 7c20 286e 6576 3120 2520 4747   1 || (nev1 % GG
+000676f0: 4d4c 5f56 4543 5f44 4f54 5f55 4e52 4f4c  ML_VEC_DOT_UNROL
+00067700: 4c20 213d 2030 2929 207b 0a20 2020 2020  L != 0)) {.     
+00067710: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00067720: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
+00067730: 206e 6576 313b 202b 2b69 6329 207b 0a20   nev1; ++ic) {. 
+00067740: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00067750: 2f20 6473 7420 696e 6469 6365 730a 2020  / dst indices.  
+00067760: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00067770: 6e73 7420 696e 7420 6931 203d 2069 7131  nst int i1 = iq1
+00067780: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00067790: 2020 636f 6e73 7420 696e 7420 6932 203d    const int i2 =
+000677a0: 2069 7132 3b0a 2020 2020 2020 2020 2020   iq2;.          
+000677b0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+000677c0: 6933 203d 2069 7133 3b0a 0a20 2020 2020  i3 = iq3;..     
+000677d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000677e0: 7665 635f 646f 745f 6631 3628 6e65 6b31  vec_dot_f16(nek1
+000677f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00067800: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+00067810: 202a 2920 2020 2020 2020 2828 6368 6172   *)       ((char
+00067820: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
+00067830: 2869 632a 6e62 3020 2b20 6931 2a6e 6231  (ic*nb0 + i1*nb1
+00067840: 2020 2b20 6932 2a6e 6232 2020 2b20 6933    + i2*nb2  + i3
+00067850: 2a6e 6233 2929 2c0a 2020 2020 2020 2020  *nb3)),.        
+00067860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067870: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
+00067880: 2828 6368 6172 202a 2920 762d 3e64 6174  ((char *) v->dat
+00067890: 6120 2020 2b20 2820 2020 2020 2020 2020  a   + (         
+000678a0: 6963 2a6e 6276 3120 2b20 6932 2a6e 6276  ic*nbv1 + i2*nbv
+000678b0: 3220 2b20 6933 2a6e 6276 3329 292c 0a20  2 + i3*nbv3)),. 
+000678c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000678d0: 2020 2020 2020 2053 3136 293b 0a20 2020         S16);.   
+000678e0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000678f0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+00067900: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00067910: 3634 5f74 2069 6320 3d20 303b 2069 6320  64_t ic = 0; ic 
+00067920: 3c20 6e65 7631 3b20 6963 202b 3d20 4747  < nev1; ic += GG
+00067930: 4d4c 5f56 4543 5f44 4f54 5f55 4e52 4f4c  ML_VEC_DOT_UNROL
+00067940: 4c29 207b 0a20 2020 2020 2020 2020 2020  L) {.           
+00067950: 2020 2020 202f 2f20 6473 7420 696e 6469       // dst indi
+00067960: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
+00067970: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
+00067980: 203d 2069 7131 3b0a 2020 2020 2020 2020   = iq1;.        
+00067990: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+000679a0: 7420 6932 203d 2069 7132 3b0a 2020 2020  t i2 = iq2;.    
+000679b0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000679c0: 7420 696e 7420 6933 203d 2069 7133 3b0a  t int i3 = iq3;.
+000679d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000679e0: 2067 676d 6c5f 7665 635f 646f 745f 6631   ggml_vec_dot_f1
+000679f0: 365f 756e 726f 6c6c 286e 656b 312c 206e  6_unroll(nek1, n
+00067a00: 6276 312c 0a20 2020 2020 2020 2020 2020  bv1,.           
+00067a10: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+00067a20: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+00067a30: 2064 7374 2d3e 6461 7461 202b 2028 6963   dst->data + (ic
+00067a40: 2a6e 6230 202b 2069 312a 6e62 3120 202b  *nb0 + i1*nb1  +
+00067a50: 2069 322a 6e62 3220 202b 2069 332a 6e62   i2*nb2  + i3*nb
+00067a60: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
+00067a70: 2020 2020 2020 2020 2020 2020 2028 2863               ((c
+00067a80: 6861 7220 2a29 2076 2d3e 6461 7461 2020  har *) v->data  
+00067a90: 202b 2028 2020 2020 2020 2020 2069 632a   + (         ic*
+00067aa0: 6e62 7631 202b 2069 322a 6e62 7632 202b  nbv1 + i2*nbv2 +
+00067ab0: 2069 332a 6e62 7633 2929 2c0a 2020 2020   i3*nbv3)),.    
+00067ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067ad0: 2020 2020 5331 3629 3b0a 2020 2020 2020      S16);.      
+00067ae0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00067af0: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
+00067b00: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+00067b10: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
+00067b20: 685f 6174 746e 280a 2020 2020 2020 2020  h_attn(.        
+00067b30: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00067b40: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+00067b50: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+00067b60: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00067b70: 6767 6d6c 5f74 656e 736f 7220 2a20 712c  ggml_tensor * q,
+00067b80: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00067b90: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00067ba0: 7220 2a20 6b2c 0a20 2020 2020 2020 2063  r * k,.        c
+00067bb0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00067bc0: 5f74 656e 736f 7220 2a20 762c 0a20 2020  _tensor * v,.   
+00067bd0: 2020 2020 2063 6f6e 7374 2062 6f6f 6c20       const bool 
+00067be0: 6d61 736b 6564 2c0a 2020 2020 2020 2020  masked,.        
+00067bf0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00067c00: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+00067c10: 7377 6974 6368 2028 712d 3e74 7970 6529  switch (q->type)
+00067c20: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+00067c30: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+00067c40: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00067c50: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00067c60: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00067c70: 645f 666c 6173 685f 6174 746e 5f66 3136  d_flash_attn_f16
+00067c80: 2870 6172 616d 732c 2071 2c20 6b2c 2076  (params, q, k, v
+00067c90: 2c20 6d61 736b 6564 2c20 6473 7429 3b0a  , masked, dst);.
+00067ca0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00067cb0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00067cc0: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+00067cd0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00067ce0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00067cf0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00067d00: 6172 645f 666c 6173 685f 6174 746e 5f66  ard_flash_attn_f
+00067d10: 3332 2870 6172 616d 732c 2071 2c20 6b2c  32(params, q, k,
+00067d20: 2076 2c20 6d61 736b 6564 2c20 6473 7429   v, masked, dst)
+00067d30: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00067d40: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
+00067d50: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
+00067d60: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00067d70: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00067d80: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+00067d90: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00067da0: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
+00067db0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00067dc0: 666c 6173 685f 6666 0a0a 7374 6174 6963  flash_ff..static
+00067dd0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00067de0: 7465 5f66 6f72 7761 7264 5f66 6c61 7368  te_forward_flash
+00067df0: 5f66 665f 6631 3628 0a20 2020 2020 2020  _ff_f16(.       
+00067e00: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00067e10: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00067e20: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00067e30: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00067e40: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
+00067e50: 2c20 202f 2f20 4631 360a 2020 2020 2020  ,  // F16.      
+00067e60: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00067e70: 676d 6c5f 7465 6e73 6f72 202a 2062 302c  gml_tensor * b0,
+00067e80: 202f 2f20 4631 3620 6663 5f77 0a20 2020   // F16 fc_w.   
+00067e90: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00067ea0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00067eb0: 6231 2c20 2f2f 2046 3332 2066 635f 620a  b1, // F32 fc_b.
+00067ec0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00067ed0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00067ee0: 202a 2063 302c 202f 2f20 4631 3620 7072   * c0, // F16 pr
+00067ef0: 6f6a 5f77 0a20 2020 2020 2020 2063 6f6e  oj_w.        con
+00067f00: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00067f10: 656e 736f 7220 2a20 6331 2c20 2f2f 2046  ensor * c1, // F
+00067f20: 3332 2070 726f 6a5f 620a 2020 2020 2020  32 proj_b.      
+00067f30: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00067f40: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00067f50: 2020 696e 7436 345f 7420 7430 203d 2067    int64_t t0 = g
+00067f60: 676d 6c5f 7065 7266 5f74 696d 655f 7573  gml_perf_time_us
+00067f70: 2829 3b0a 2020 2020 554e 5553 4544 2874  ();.    UNUSED(t
+00067f80: 3029 3b0a 0a20 2020 2063 6f6e 7374 2069  0);..    const i
+00067f90: 6e74 3634 5f74 206e 6561 3020 3d20 612d  nt64_t nea0 = a-
+00067fa0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+00067fb0: 7420 696e 7436 345f 7420 6e65 6131 203d  t int64_t nea1 =
+00067fc0: 2061 2d3e 6e65 5b31 5d3b 0a20 2020 2063   a->ne[1];.    c
+00067fd0: 6f6e 7374 2069 6e74 3634 5f74 206e 6561  onst int64_t nea
+00067fe0: 3220 3d20 612d 3e6e 655b 325d 3b0a 2020  2 = a->ne[2];.  
+00067ff0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00068000: 6e65 6133 203d 2061 2d3e 6e65 5b33 5d3b  nea3 = a->ne[3];
+00068010: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
+00068020: 345f 7420 6e65 6230 3020 3d20 6230 2d3e  4_t neb00 = b0->
+00068030: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+00068040: 2069 6e74 3634 5f74 206e 6562 3031 203d   int64_t neb01 =
+00068050: 2062 302d 3e6e 655b 315d 3b0a 2020 2020   b0->ne[1];.    
+00068060: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
+00068070: 6e65 6230 3220 3d20 6230 2d3e 6e65 5b32  neb02 = b0->ne[2
+00068080: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00068090: 6e74 3634 5f74 206e 6562 3033 203d 2062  nt64_t neb03 = b
+000680a0: 302d 3e6e 655b 335d 3b0a 0a20 2020 2063  0->ne[3];..    c
+000680b0: 6f6e 7374 2069 6e74 3634 5f74 206e 6562  onst int64_t neb
+000680c0: 3130 203d 2062 312d 3e6e 655b 305d 3b0a  10 = b1->ne[0];.
+000680d0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+000680e0: 7420 6e65 6231 3120 3d20 6231 2d3e 6e65  t neb11 = b1->ne
+000680f0: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
+00068100: 2069 6e74 3634 5f74 206e 6562 3132 203d   int64_t neb12 =
+00068110: 2062 312d 3e6e 655b 325d 3b0a 2020 2020   b1->ne[2];.    
+00068120: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
+00068130: 6e65 6231 3320 3d20 6231 2d3e 6e65 5b33  neb13 = b1->ne[3
+00068140: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00068150: 7436 345f 7420 6e65 6330 3020 3d20 6330  t64_t nec00 = c0
+00068160: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+00068170: 7374 2069 6e74 3634 5f74 206e 6563 3031  st int64_t nec01
+00068180: 203d 2063 302d 3e6e 655b 315d 3b0a 2020   = c0->ne[1];.  
+00068190: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+000681a0: 7420 6e65 6330 3220 3d20 6330 2d3e 6e65  t nec02 = c0->ne
+000681b0: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
+000681c0: 2069 6e74 3634 5f74 206e 6563 3033 203d   int64_t nec03 =
+000681d0: 2063 302d 3e6e 655b 335d 3b0a 0a20 2020   c0->ne[3];..   
+000681e0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+000681f0: 6563 3130 203d 2063 312d 3e6e 655b 305d  ec10 = c1->ne[0]
+00068200: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+00068210: 345f 7420 6e65 6331 3120 3d20 6331 2d3e  4_t nec11 = c1->
+00068220: 6e65 5b31 5d3b 0a20 2020 202f 2f63 6f6e  ne[1];.    //con
+00068230: 7374 2069 6e74 3634 5f74 206e 6563 3132  st int64_t nec12
+00068240: 203d 2063 312d 3e6e 655b 325d 3b0a 2020   = c1->ne[2];.  
+00068250: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+00068260: 7420 6e65 6331 3320 3d20 6331 2d3e 6e65  t nec13 = c1->ne
+00068270: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+00068280: 696e 7436 345f 7420 6e65 3020 3d20 6473  int64_t ne0 = ds
+00068290: 742d 3e6e 655b 305d 3b0a 2020 2020 636f  t->ne[0];.    co
+000682a0: 6e73 7420 696e 7436 345f 7420 6e65 3120  nst int64_t ne1 
+000682b0: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
+000682c0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+000682d0: 6e65 3220 3d20 6473 742d 3e6e 655b 325d  ne2 = dst->ne[2]
+000682e0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+000682f0: 7436 345f 7420 6e65 3320 3d20 6473 742d  t64_t ne3 = dst-
+00068300: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
+00068310: 7374 2069 6e74 206e 6261 3020 3d20 612d  st int nba0 = a-
+00068320: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
+00068330: 7420 696e 7420 6e62 6131 203d 2061 2d3e  t int nba1 = a->
+00068340: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
+00068350: 2069 6e74 206e 6261 3220 3d20 612d 3e6e   int nba2 = a->n
+00068360: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+00068370: 696e 7420 6e62 6133 203d 2061 2d3e 6e62  int nba3 = a->nb
+00068380: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+00068390: 696e 7420 6e62 6230 3020 3d20 6230 2d3e  int nbb00 = b0->
+000683a0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+000683b0: 2069 6e74 206e 6262 3031 203d 2062 302d   int nbb01 = b0-
+000683c0: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+000683d0: 7420 696e 7420 6e62 6230 3220 3d20 6230  t int nbb02 = b0
+000683e0: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
+000683f0: 7374 2069 6e74 206e 6262 3033 203d 2062  st int nbb03 = b
+00068400: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
+00068410: 6f6e 7374 2069 6e74 206e 6262 3130 203d  onst int nbb10 =
+00068420: 2062 312d 3e6e 625b 305d 3b0a 2020 2020   b1->nb[0];.    
+00068430: 2f2f 636f 6e73 7420 696e 7420 6e62 6231  //const int nbb1
+00068440: 3120 3d20 6231 2d3e 6e62 5b31 5d3b 0a20  1 = b1->nb[1];. 
+00068450: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00068460: 6262 3132 203d 2062 312d 3e6e 625b 325d  bb12 = b1->nb[2]
+00068470: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00068480: 7420 6e62 6231 3320 3d20 6231 2d3e 6e62  t nbb13 = b1->nb
+00068490: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+000684a0: 696e 7420 6e62 6330 3020 3d20 6330 2d3e  int nbc00 = c0->
+000684b0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+000684c0: 2069 6e74 206e 6263 3031 203d 2063 302d   int nbc01 = c0-
+000684d0: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+000684e0: 7420 696e 7420 6e62 6330 3220 3d20 6330  t int nbc02 = c0
+000684f0: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
+00068500: 7374 2069 6e74 206e 6263 3033 203d 2063  st int nbc03 = c
+00068510: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
+00068520: 6f6e 7374 2069 6e74 206e 6263 3130 203d  onst int nbc10 =
+00068530: 2063 312d 3e6e 625b 305d 3b0a 2020 2020   c1->nb[0];.    
+00068540: 2f2f 636f 6e73 7420 696e 7420 6e62 6331  //const int nbc1
+00068550: 3120 3d20 6331 2d3e 6e62 5b31 5d3b 0a20  1 = c1->nb[1];. 
+00068560: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00068570: 6263 3132 203d 2063 312d 3e6e 625b 325d  bc12 = c1->nb[2]
+00068580: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00068590: 7420 6e62 6331 3320 3d20 6331 2d3e 6e62  t nbc13 = c1->nb
+000685a0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+000685b0: 696e 7420 6e62 3020 3d20 6473 742d 3e6e  int nb0 = dst->n
+000685c0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+000685d0: 696e 7420 6e62 3120 3d20 6473 742d 3e6e  int nb1 = dst->n
+000685e0: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+000685f0: 696e 7420 6e62 3220 3d20 6473 742d 3e6e  int nb2 = dst->n
+00068600: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+00068610: 696e 7420 6e62 3320 3d20 6473 742d 3e6e  int nb3 = dst->n
+00068620: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+00068630: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
+00068640: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
+00068650: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
+00068660: 6d73 2d3e 6e74 683b 0a0a 2020 2020 636f  ms->nth;..    co
+00068670: 6e73 7420 696e 7436 345f 7420 4420 3d20  nst int64_t D = 
+00068680: 6e65 6130 3b0a 2020 2020 2f2f 636f 6e73  nea0;.    //cons
+00068690: 7420 696e 7436 345f 7420 4e20 3d20 6e65  t int64_t N = ne
+000686a0: 6131 3b0a 2020 2020 636f 6e73 7420 696e  a1;.    const in
+000686b0: 7436 345f 7420 4d20 3d20 6e65 6230 313b  t64_t M = neb01;
+000686c0: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
+000686d0: 5428 6e65 3020 3d3d 206e 6561 3029 3b0a  T(ne0 == nea0);.
+000686e0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000686f0: 6e65 3120 3d3d 206e 6561 3129 3b0a 2020  ne1 == nea1);.  
+00068700: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+00068710: 3220 3d3d 206e 6561 3229 3b0a 0a20 2020  2 == nea2);..   
+00068720: 2047 474d 4c5f 4153 5345 5254 286e 6261   GGML_ASSERT(nba
+00068730: 3020 203d 3d20 7369 7a65 6f66 2867 676d  0  == sizeof(ggm
+00068740: 6c5f 6670 3136 5f74 2929 3b0a 2020 2020  l_fp16_t));.    
+00068750: 4747 4d4c 5f41 5353 4552 5428 6e62 6230  GGML_ASSERT(nbb0
+00068760: 3020 3d3d 2073 697a 656f 6628 6767 6d6c  0 == sizeof(ggml
+00068770: 5f66 7031 365f 7429 293b 0a20 2020 2047  _fp16_t));.    G
+00068780: 474d 4c5f 4153 5345 5254 286e 6262 3130  GML_ASSERT(nbb10
+00068790: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
+000687a0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+000687b0: 4552 5428 6e62 6330 3020 3d3d 2073 697a  ERT(nbc00 == siz
+000687c0: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
+000687d0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+000687e0: 5254 286e 6263 3130 203d 3d20 7369 7a65  RT(nbc10 == size
+000687f0: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
+00068800: 2047 474d 4c5f 4153 5345 5254 286e 6562   GGML_ASSERT(neb
+00068810: 3030 203d 3d20 4429 3b0a 2020 2020 4747  00 == D);.    GG
+00068820: 4d4c 5f41 5353 4552 5428 6e65 6230 3120  ML_ASSERT(neb01 
+00068830: 3d3d 204d 293b 0a20 2020 2047 474d 4c5f  == M);.    GGML_
+00068840: 4153 5345 5254 286e 6562 3130 203d 3d20  ASSERT(neb10 == 
+00068850: 4d29 3b0a 2020 2020 4747 4d4c 5f41 5353  M);.    GGML_ASS
+00068860: 4552 5428 6e65 6231 3120 3d3d 2031 293b  ERT(neb11 == 1);
+00068870: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
+00068880: 5428 6e65 6330 3020 3d3d 204d 293b 0a20  T(nec00 == M);. 
+00068890: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+000688a0: 6563 3031 203d 3d20 4429 3b0a 2020 2020  ec01 == D);.    
+000688b0: 4747 4d4c 5f41 5353 4552 5428 6e65 6331  GGML_ASSERT(nec1
+000688c0: 3020 3d3d 2044 293b 0a20 2020 2047 474d  0 == D);.    GGM
+000688d0: 4c5f 4153 5345 5254 286e 6563 3131 203d  L_ASSERT(nec11 =
+000688e0: 3d20 3129 3b0a 0a20 2020 202f 2f20 6473  = 1);..    // ds
+000688f0: 7420 6361 6e6e 6f74 2062 6520 7472 616e  t cannot be tran
+00068900: 7370 6f73 6564 206f 7220 7065 726d 7574  sposed or permut
+00068910: 6564 0a20 2020 2047 474d 4c5f 4153 5345  ed.    GGML_ASSE
+00068920: 5254 286e 6230 203d 3d20 7369 7a65 6f66  RT(nb0 == sizeof
+00068930: 2866 6c6f 6174 2929 3b0a 2020 2020 4747  (float));.    GG
+00068940: 4d4c 5f41 5353 4552 5428 6e62 3020 3c3d  ML_ASSERT(nb0 <=
+00068950: 206e 6231 293b 0a20 2020 2047 474d 4c5f   nb1);.    GGML_
+00068960: 4153 5345 5254 286e 6231 203c 3d20 6e62  ASSERT(nb1 <= nb
+00068970: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
+00068980: 4552 5428 6e62 3220 3c3d 206e 6233 293b  ERT(nb2 <= nb3);
+00068990: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+000689a0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+000689b0: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
+000689c0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+000689d0: 7d0a 0a20 2020 2069 6620 2870 6172 616d  }..    if (param
+000689e0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+000689f0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+00068a00: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+00068a10: 0a20 2020 207d 0a0a 2020 2020 2f2f 2070  .    }..    // p
+00068a20: 6172 616c 6c65 6c69 7a65 2062 7920 6120  arallelize by a 
+00068a30: 726f 7773 2075 7369 6e67 2067 676d 6c5f  rows using ggml_
+00068a40: 7665 635f 646f 745f 6633 320a 0a20 2020  vec_dot_f32..   
+00068a50: 202f 2f20 746f 7461 6c20 726f 7773 2069   // total rows i
+00068a60: 6e20 610a 2020 2020 636f 6e73 7420 696e  n a.    const in
+00068a70: 7420 6e72 203d 206e 6561 312a 6e65 6132  t nr = nea1*nea2
+00068a80: 2a6e 6561 333b 0a0a 2020 2020 2f2f 2072  *nea3;..    // r
+00068a90: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
+00068aa0: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
+00068ab0: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
+00068ac0: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
+00068ad0: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
+00068ae0: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+00068af0: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
+00068b00: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+00068b10: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
+00068b20: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
+00068b30: 666f 7220 2869 6e74 2069 7220 3d20 6972  for (int ir = ir
+00068b40: 303b 2069 7220 3c20 6972 313b 202b 2b69  0; ir < ir1; ++i
+00068b50: 7229 207b 0a20 2020 2020 2020 202f 2f20  r) {.        // 
+00068b60: 6120 696e 6469 6365 730a 2020 2020 2020  a indices.      
+00068b70: 2020 636f 6e73 7420 696e 7420 6961 3320    const int ia3 
+00068b80: 3d20 6972 2f28 6e65 6132 2a6e 6561 3129  = ir/(nea2*nea1)
+00068b90: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
+00068ba0: 696e 7420 6961 3220 3d20 2869 7220 2d20  int ia2 = (ir - 
+00068bb0: 6961 332a 6e65 6132 2a6e 6561 3129 2f6e  ia3*nea2*nea1)/n
+00068bc0: 6561 313b 0a20 2020 2020 2020 2063 6f6e  ea1;.        con
+00068bd0: 7374 2069 6e74 2069 6131 203d 2028 6972  st int ia1 = (ir
+00068be0: 202d 2069 6133 2a6e 6561 322a 6e65 6131   - ia3*nea2*nea1
+00068bf0: 202d 2069 6132 2a6e 6561 3129 3b0a 0a20   - ia2*nea1);.. 
+00068c00: 2020 2020 2020 2066 6c6f 6174 202a 2053         float * S
+00068c10: 203d 2028 666c 6f61 7420 2a29 2070 6172   = (float *) par
+00068c20: 616d 732d 3e77 6461 7461 202b 2069 7468  ams->wdata + ith
+00068c30: 2a28 322a 4d20 2b20 4341 4348 455f 4c49  *(2*M + CACHE_LI
+00068c40: 4e45 5f53 495a 455f 4633 3229 3b0a 0a20  NE_SIZE_F32);.. 
+00068c50: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00068c60: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
+00068c70: 206e 6562 3031 3b20 2b2b 6963 2920 7b0a   neb01; ++ic) {.
+00068c80: 2020 2020 2020 2020 2020 2020 2f2f 2062              // b
+00068c90: 3020 696e 6469 6365 730a 2020 2020 2020  0 indices.      
+00068ca0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00068cb0: 6962 3033 203d 2069 6133 3b0a 2020 2020  ib03 = ia3;.    
+00068cc0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00068cd0: 7420 6962 3032 203d 2069 6132 3b0a 2020  t ib02 = ia2;.  
+00068ce0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00068cf0: 696e 7420 6962 3031 203d 2069 633b 0a0a  int ib01 = ic;..
+00068d00: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
+00068d10: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
+00068d20: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+00068d30: 3120 3d20 6962 3031 3b0a 0a20 2020 2020  1 = ib01;..     
+00068d40: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00068d50: 646f 745f 6631 3628 6e65 6130 2c0a 2020  dot_f16(nea0,.  
+00068d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068d70: 2020 5320 2b20 6931 2c0a 2020 2020 2020    S + i1,.      
+00068d80: 2020 2020 2020 2020 2020 2020 2020 2867                (g
+00068d90: 676d 6c5f 6670 3136 5f74 202a 2920 2828  gml_fp16_t *) ((
+00068da0: 6368 6172 202a 2920 6230 2d3e 6461 7461  char *) b0->data
+00068db0: 202b 2028 6962 3031 2a6e 6262 3031 202b   + (ib01*nbb01 +
+00068dc0: 2069 6230 322a 6e62 6230 3220 2b20 6962   ib02*nbb02 + ib
+00068dd0: 3033 2a6e 6262 3033 2929 2c0a 2020 2020  03*nbb03)),.    
+00068de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068df0: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
+00068e00: 2828 6368 6172 202a 2920 2061 2d3e 6461  ((char *)  a->da
+00068e10: 7461 202b 2028 2069 6131 2a6e 6261 3120  ta + ( ia1*nba1 
+00068e20: 202b 2020 6961 322a 6e62 6132 2020 2b20   +  ia2*nba2  + 
+00068e30: 2069 6133 2a6e 6261 3329 2929 3b0a 2020   ia3*nba3)));.  
+00068e40: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00068e50: 2067 676d 6c5f 7665 635f 6164 645f 6633   ggml_vec_add_f3
+00068e60: 3228 6e65 6230 312c 2053 2c20 532c 2028  2(neb01, S, S, (
+00068e70: 666c 6f61 7420 2a29 2062 312d 3e64 6174  float *) b1->dat
+00068e80: 6129 3b0a 2020 2020 2020 2020 2f2f 6767  a);.        //gg
+00068e90: 6d6c 5f76 6563 5f67 656c 755f 6633 3228  ml_vec_gelu_f32(
+00068ea0: 6e65 6230 312c 2053 2c20 5329 3b0a 0a20  neb01, S, S);.. 
+00068eb0: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
+00068ec0: 5f74 202a 2053 3136 203d 2028 6767 6d6c  _t * S16 = (ggml
+00068ed0: 5f66 7031 365f 7420 2a29 2028 2866 6c6f  _fp16_t *) ((flo
+00068ee0: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
+00068ef0: 6174 6120 2b20 6974 682a 2832 2a4d 202b  ata + ith*(2*M +
+00068f00: 2043 4143 4845 5f4c 494e 455f 5349 5a45   CACHE_LINE_SIZE
+00068f10: 5f46 3332 2920 2b20 4d29 3b0a 0a20 2020  _F32) + M);..   
+00068f20: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+00068f30: 7420 6920 3d20 303b 2069 203c 204d 3b20  t i = 0; i < M; 
+00068f40: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
+00068f50: 2020 2053 3136 5b69 5d20 3d20 4747 4d4c     S16[i] = GGML
+00068f60: 5f46 5033 325f 544f 5f46 5031 3628 535b  _FP32_TO_FP16(S[
+00068f70: 695d 293b 0a20 2020 2020 2020 207d 0a0a  i]);.        }..
+00068f80: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00068f90: 5f67 656c 755f 6631 3628 6e65 6230 312c  _gelu_f16(neb01,
+00068fa0: 2053 3136 2c20 5331 3629 3b0a 0a20 2020   S16, S16);..   
+00068fb0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00068fc0: 2020 202f 2f20 6473 7420 696e 6469 6365     // dst indice
+00068fd0: 730a 2020 2020 2020 2020 2020 2020 636f  s.            co
+00068fe0: 6e73 7420 696e 7420 6931 203d 2069 6131  nst int i1 = ia1
+00068ff0: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+00069000: 6e73 7420 696e 7420 6932 203d 2069 6132  nst int i2 = ia2
+00069010: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+00069020: 6e73 7420 696e 7420 6933 203d 2069 6133  nst int i3 = ia3
+00069030: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
+00069040: 6f72 2028 696e 7436 345f 7420 6963 203d  or (int64_t ic =
+00069050: 2030 3b20 6963 203c 206e 6563 3031 3b20   0; ic < nec01; 
+00069060: 2b2b 6963 2920 7b0a 0a20 2020 2020 2020  ++ic) {..       
+00069070: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+00069080: 635f 646f 745f 6631 3628 6e65 6230 312c  c_dot_f16(neb01,
+00069090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000690a0: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+000690b0: 2a29 2020 2020 2020 2028 2863 6861 7220  *)       ((char 
+000690c0: 2a29 2064 7374 2d3e 6461 7461 202b 2028  *) dst->data + (
+000690d0: 6963 2a6e 6230 202b 2069 312a 6e62 3120  ic*nb0 + i1*nb1 
+000690e0: 2020 2b20 6932 2a6e 6232 2020 202b 2069    + i2*nb2   + i
+000690f0: 332a 6e62 3329 292c 0a20 2020 2020 2020  3*nb3)),.       
+00069100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069110: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+00069120: 2028 2863 6861 7220 2a29 2063 302d 3e64   ((char *) c0->d
+00069130: 6174 6120 202b 2028 2020 2020 2020 2020  ata  + (        
+00069140: 2069 632a 6e62 6330 3120 2b20 6932 2a6e   ic*nbc01 + i2*n
+00069150: 6263 3032 202b 2069 332a 6e62 6330 3329  bc02 + i3*nbc03)
+00069160: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00069170: 2020 2020 2020 2020 2020 2053 3136 293b             S16);
+00069180: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+00069190: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000691a0: 5f76 6563 5f61 6464 5f66 3332 286e 6563  _vec_add_f32(nec
+000691b0: 3031 2c0a 2020 2020 2020 2020 2020 2020  01,.            
+000691c0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+000691d0: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
+000691e0: 3e64 6174 6120 2b20 2869 312a 6e62 3120  >data + (i1*nb1 
+000691f0: 2b20 6932 2a6e 6232 202b 2069 332a 6e62  + i2*nb2 + i3*nb
+00069200: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
+00069210: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+00069220: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
+00069230: 2d3e 6461 7461 202b 2028 6931 2a6e 6231  ->data + (i1*nb1
+00069240: 202b 2069 322a 6e62 3220 2b20 6933 2a6e   + i2*nb2 + i3*n
+00069250: 6233 2929 2c0a 2020 2020 2020 2020 2020  b3)),.          
+00069260: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+00069270: 202a 2920 6331 2d3e 6461 7461 293b 0a20   *) c1->data);. 
+00069280: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+00069290: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+000692a0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000692b0: 7264 5f66 6c61 7368 5f66 6628 0a20 2020  rd_flash_ff(.   
+000692c0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000692d0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+000692e0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+000692f0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00069300: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00069310: 202a 2061 2c0a 2020 2020 2020 2020 636f   * a,.        co
+00069320: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00069330: 7465 6e73 6f72 202a 2062 302c 0a20 2020  tensor * b0,.   
+00069340: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00069350: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00069360: 6231 2c0a 2020 2020 2020 2020 636f 6e73  b1,.        cons
+00069370: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00069380: 6e73 6f72 202a 2063 302c 0a20 2020 2020  nsor * c0,.     
+00069390: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000693a0: 6767 6d6c 5f74 656e 736f 7220 2a20 6331  ggml_tensor * c1
+000693b0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+000693c0: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+000693d0: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
+000693e0: 2028 6230 2d3e 7479 7065 2920 7b0a 2020   (b0->type) {.  
+000693f0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00069400: 5459 5045 5f46 3136 3a0a 2020 2020 2020  TYPE_F16:.      
+00069410: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00069420: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00069430: 7075 7465 5f66 6f72 7761 7264 5f66 6c61  pute_forward_fla
+00069440: 7368 5f66 665f 6631 3628 7061 7261 6d73  sh_ff_f16(params
+00069450: 2c20 612c 2062 302c 2062 312c 2063 302c  , a, b0, b1, c0,
+00069460: 2063 312c 2064 7374 293b 0a20 2020 2020   c1, dst);.     
+00069470: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00069480: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00069490: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+000694a0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000694b0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+000694c0: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+000694d0: 2054 4f44 4f0a 2020 2020 2020 2020 2020   TODO.          
+000694e0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000694f0: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00069500: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00069510: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00069520: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00069530: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00069540: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+00069550: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00069560: 6172 645f 666c 6173 685f 6174 746e 5f62  ard_flash_attn_b
+00069570: 6163 6b0a 0a73 7461 7469 6320 766f 6964  ack..static void
+00069580: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00069590: 7277 6172 645f 666c 6173 685f 6174 746e  rward_flash_attn
+000695a0: 5f62 6163 6b5f 6633 3228 0a20 2020 2020  _back_f32(.     
+000695b0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000695c0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+000695d0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+000695e0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000695f0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00069600: 2071 2c0a 2020 2020 2020 2020 636f 6e73   q,.        cons
+00069610: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00069620: 6e73 6f72 202a 206b 2c0a 2020 2020 2020  nsor * k,.      
+00069630: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00069640: 676d 6c5f 7465 6e73 6f72 202a 2076 2c0a  gml_tensor * v,.
+00069650: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00069660: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00069670: 202a 2064 2c0a 2020 2020 2020 2020 636f   * d,.        co
+00069680: 6e73 7420 626f 6f6c 206d 6173 6b65 642c  nst bool masked,
+00069690: 0a20 2020 2020 2020 2020 2020 2020 2073  .              s
+000696a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000696b0: 7220 2a20 6473 7429 207b 0a20 2020 2069  r * dst) {.    i
+000696c0: 6e74 3634 5f74 2074 3020 3d20 6767 6d6c  nt64_t t0 = ggml
+000696d0: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
+000696e0: 0a20 2020 2055 4e55 5345 4428 7430 293b  .    UNUSED(t0);
+000696f0: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
+00069700: 345f 7420 6e65 7130 203d 2071 2d3e 6e65  4_t neq0 = q->ne
+00069710: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00069720: 6e74 3634 5f74 206e 6571 3120 3d20 712d  nt64_t neq1 = q-
+00069730: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
+00069740: 7420 696e 7436 345f 7420 6e65 7132 203d  t int64_t neq2 =
+00069750: 2071 2d3e 6e65 5b32 5d3b 0a20 2020 2063   q->ne[2];.    c
+00069760: 6f6e 7374 2069 6e74 3634 5f74 206e 6571  onst int64_t neq
+00069770: 3320 3d20 712d 3e6e 655b 335d 3b0a 0a20  3 = q->ne[3];.. 
+00069780: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00069790: 206e 656b 3020 3d20 6b2d 3e6e 655b 305d   nek0 = k->ne[0]
+000697a0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+000697b0: 345f 7420 6e65 6b31 203d 206b 2d3e 6e65  4_t nek1 = k->ne
+000697c0: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
+000697d0: 2069 6e74 3634 5f74 206e 656b 3220 3d20   int64_t nek2 = 
+000697e0: 6b2d 3e6e 655b 325d 3b0a 2020 2020 2f2f  k->ne[2];.    //
+000697f0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00069800: 6b33 203d 206b 2d3e 6e65 5b33 5d3b 0a0a  k3 = k->ne[3];..
+00069810: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00069820: 7420 6e65 7630 203d 2076 2d3e 6e65 5b30  t nev0 = v->ne[0
+00069830: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00069840: 3634 5f74 206e 6576 3120 3d20 762d 3e6e  64_t nev1 = v->n
+00069850: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
+00069860: 7420 696e 7436 345f 7420 6e65 7632 203d  t int64_t nev2 =
+00069870: 2076 2d3e 6e65 5b32 5d3b 0a20 2020 202f   v->ne[2];.    /
+00069880: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+00069890: 6576 3320 3d20 762d 3e6e 655b 335d 3b0a  ev3 = v->ne[3];.
+000698a0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+000698b0: 5f74 206e 6564 3020 3d20 642d 3e6e 655b  _t ned0 = d->ne[
+000698c0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+000698d0: 7436 345f 7420 6e65 6431 203d 2064 2d3e  t64_t ned1 = d->
+000698e0: 6e65 5b31 5d3b 0a20 2020 202f 2f63 6f6e  ne[1];.    //con
+000698f0: 7374 2069 6e74 3634 5f74 206e 6564 3220  st int64_t ned2 
+00069900: 3d20 642d 3e6e 655b 325d 3b0a 2020 2020  = d->ne[2];.    
+00069910: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
+00069920: 6e65 6433 203d 2064 2d3e 6e65 5b33 5d3b  ned3 = d->ne[3];
+00069930: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
+00069940: 345f 7420 6e65 3020 203d 2064 7374 2d3e  4_t ne0  = dst->
+00069950: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+00069960: 2069 6e74 3634 5f74 206e 6531 2020 3d20   int64_t ne1  = 
+00069970: 6473 742d 3e6e 655b 315d 3b0a 2020 2020  dst->ne[1];.    
+00069980: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00069990: 3220 203d 2064 7374 2d3e 6e65 5b32 5d3b  2  = dst->ne[2];
+000699a0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+000699b0: 5f74 206e 6533 2020 3d20 6473 742d 3e6e  _t ne3  = dst->n
+000699c0: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
+000699d0: 2069 6e74 206e 626b 3020 3d20 6b2d 3e6e   int nbk0 = k->n
+000699e0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+000699f0: 696e 7420 6e62 6b31 203d 206b 2d3e 6e62  int nbk1 = k->nb
+00069a00: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+00069a10: 6e74 206e 626b 3220 3d20 6b2d 3e6e 625b  nt nbk2 = k->nb[
+00069a20: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+00069a30: 7420 6e62 6b33 203d 206b 2d3e 6e62 5b33  t nbk3 = k->nb[3
+00069a40: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00069a50: 7420 6e62 7130 203d 2071 2d3e 6e62 5b30  t nbq0 = q->nb[0
 00069a60: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00069a70: 206e 626b 3320 3d20 6b2d 3e6e 625b 335d   nbk3 = k->nb[3]
-00069a80: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00069a90: 206e 6271 3020 3d20 712d 3e6e 625b 305d   nbq0 = q->nb[0]
-00069aa0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00069ab0: 6e62 7131 203d 2071 2d3e 6e62 5b31 5d3b  nbq1 = q->nb[1];
+00069a70: 206e 6271 3120 3d20 712d 3e6e 625b 315d   nbq1 = q->nb[1]
+00069a80: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00069a90: 6e62 7132 203d 2071 2d3e 6e62 5b32 5d3b  nbq2 = q->nb[2];
+00069aa0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00069ab0: 6271 3320 3d20 712d 3e6e 625b 335d 3b0a  bq3 = q->nb[3];.
 00069ac0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00069ad0: 6271 3220 3d20 712d 3e6e 625b 325d 3b0a  bq2 = q->nb[2];.
+00069ad0: 6276 3020 3d20 762d 3e6e 625b 305d 3b0a  bv0 = v->nb[0];.
 00069ae0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00069af0: 7133 203d 2071 2d3e 6e62 5b33 5d3b 0a0a  q3 = q->nb[3];..
-00069b00: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00069b10: 7630 203d 2076 2d3e 6e62 5b30 5d3b 0a20  v0 = v->nb[0];. 
-00069b20: 2020 2063 6f6e 7374 2069 6e74 206e 6276     const int nbv
-00069b30: 3120 3d20 762d 3e6e 625b 315d 3b0a 2020  1 = v->nb[1];.  
-00069b40: 2020 636f 6e73 7420 696e 7420 6e62 7632    const int nbv2
-00069b50: 203d 2076 2d3e 6e62 5b32 5d3b 0a20 2020   = v->nb[2];.   
-00069b60: 2063 6f6e 7374 2069 6e74 206e 6276 3320   const int nbv3 
-00069b70: 3d20 762d 3e6e 625b 335d 3b0a 0a20 2020  = v->nb[3];..   
-00069b80: 2063 6f6e 7374 2069 6e74 206e 6264 3020   const int nbd0 
-00069b90: 3d20 642d 3e6e 625b 305d 3b0a 2020 2020  = d->nb[0];.    
-00069ba0: 636f 6e73 7420 696e 7420 6e62 6431 203d  const int nbd1 =
-00069bb0: 2064 2d3e 6e62 5b31 5d3b 0a20 2020 2063   d->nb[1];.    c
-00069bc0: 6f6e 7374 2069 6e74 206e 6264 3220 3d20  onst int nbd2 = 
-00069bd0: 642d 3e6e 625b 325d 3b0a 2020 2020 636f  d->nb[2];.    co
-00069be0: 6e73 7420 696e 7420 6e62 6433 203d 2064  nst int nbd3 = d
-00069bf0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
-00069c00: 6e73 7420 696e 7420 6e62 3020 203d 2064  nst int nb0  = d
-00069c10: 7374 2d3e 6e62 5b30 5d3b 0a20 2020 2063  st->nb[0];.    c
-00069c20: 6f6e 7374 2069 6e74 206e 6231 2020 3d20  onst int nb1  = 
-00069c30: 6473 742d 3e6e 625b 315d 3b0a 2020 2020  dst->nb[1];.    
-00069c40: 636f 6e73 7420 696e 7420 6e62 3220 203d  const int nb2  =
-00069c50: 2064 7374 2d3e 6e62 5b32 5d3b 0a20 2020   dst->nb[2];.   
-00069c60: 2063 6f6e 7374 2069 6e74 206e 6233 2020   const int nb3  
-00069c70: 3d20 6473 742d 3e6e 625b 335d 3b0a 0a20  = dst->nb[3];.. 
-00069c80: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-00069c90: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-00069ca0: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-00069cb0: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-00069cc0: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-00069cd0: 345f 7420 4420 3d20 6e65 7130 3b0a 2020  4_t D = neq0;.  
-00069ce0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00069cf0: 4e20 3d20 6e65 7131 3b0a 2020 2020 636f  N = neq1;.    co
-00069d00: 6e73 7420 696e 7436 345f 7420 5020 3d20  nst int64_t P = 
-00069d10: 6e65 6b31 202d 204e 3b0a 2020 2020 636f  nek1 - N;.    co
-00069d20: 6e73 7420 696e 7436 345f 7420 4d20 3d20  nst int64_t M = 
-00069d30: 5020 2b20 4e3b 0a0a 2020 2020 636f 6e73  P + N;..    cons
-00069d40: 7420 696e 7420 4d75 7020 203d 2067 676d  t int Mup  = ggm
-00069d50: 6c5f 7570 284d 2c20 4747 4d4c 5f53 4f46  l_up(M, GGML_SOF
-00069d60: 545f 4d41 585f 554e 524f 4c4c 293b 0a20  T_MAX_UNROLL);. 
-00069d70: 2020 2063 6f6e 7374 2069 6e74 206d 7844     const int mxD
-00069d80: 4d20 3d20 4d41 5828 442c 204d 7570 293b  M = MAX(D, Mup);
-00069d90: 0a0a 2020 2020 2f2f 2047 474d 4c5f 4153  ..    // GGML_AS
-00069da0: 5345 5254 286e 6530 203d 3d20 4429 3b0a  SERT(ne0 == D);.
-00069db0: 2020 2020 2f2f 2047 474d 4c5f 4153 5345      // GGML_ASSE
-00069dc0: 5254 286e 6531 203d 3d20 4e29 3b0a 2020  RT(ne1 == N);.  
-00069dd0: 2020 4747 4d4c 5f41 5353 4552 5428 5020    GGML_ASSERT(P 
-00069de0: 3e3d 2030 293b 0a0a 2020 2020 4747 4d4c  >= 0);..    GGML
-00069df0: 5f41 5353 4552 5428 6e62 7130 203d 3d20  _ASSERT(nbq0 == 
-00069e00: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00069e10: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00069e20: 6e62 6b30 203d 3d20 7369 7a65 6f66 2866  nbk0 == sizeof(f
-00069e30: 6c6f 6174 2929 3b0a 2020 2020 4747 4d4c  loat));.    GGML
-00069e40: 5f41 5353 4552 5428 6e62 7630 203d 3d20  _ASSERT(nbv0 == 
-00069e50: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00069e60: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00069e70: 286e 6571 3020 3d3d 2044 293b 0a20 2020  (neq0 == D);.   
-00069e80: 2047 474d 4c5f 4153 5345 5254 286e 656b   GGML_ASSERT(nek
-00069e90: 3020 3d3d 2044 293b 0a20 2020 2047 474d  0 == D);.    GGM
-00069ea0: 4c5f 4153 5345 5254 286e 6576 3120 3d3d  L_ASSERT(nev1 ==
-00069eb0: 2044 293b 0a20 2020 2047 474d 4c5f 4153   D);.    GGML_AS
-00069ec0: 5345 5254 286e 6564 3020 3d3d 2044 293b  SERT(ned0 == D);
-00069ed0: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00069ee0: 5428 6e65 7131 203d 3d20 4e29 3b0a 2020  T(neq1 == N);.  
-00069ef0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-00069f00: 6b31 203d 3d20 4e20 2b20 5029 3b0a 2020  k1 == N + P);.  
-00069f10: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-00069f20: 7631 203d 3d20 4429 3b0a 2020 2020 4747  v1 == D);.    GG
-00069f30: 4d4c 5f41 5353 4552 5428 6e65 6431 203d  ML_ASSERT(ned1 =
-00069f40: 3d20 4e29 3b0a 0a20 2020 202f 2f20 6473  = N);..    // ds
-00069f50: 7420 6361 6e6e 6f74 2062 6520 7472 616e  t cannot be tran
-00069f60: 7370 6f73 6564 206f 7220 7065 726d 7574  sposed or permut
-00069f70: 6564 0a20 2020 2047 474d 4c5f 4153 5345  ed.    GGML_ASSE
-00069f80: 5254 286e 6230 203d 3d20 7369 7a65 6f66  RT(nb0 == sizeof
-00069f90: 2866 6c6f 6174 2929 3b0a 2020 2020 4747  (float));.    GG
-00069fa0: 4d4c 5f41 5353 4552 5428 6e62 3020 3c3d  ML_ASSERT(nb0 <=
-00069fb0: 206e 6231 293b 0a20 2020 2047 474d 4c5f   nb1);.    GGML_
-00069fc0: 4153 5345 5254 286e 6231 203c 3d20 6e62  ASSERT(nb1 <= nb
-00069fd0: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
-00069fe0: 4552 5428 6e62 3220 3c3d 206e 6233 293b  ERT(nb2 <= nb3);
-00069ff0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-0006a000: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0006a010: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
-0006a020: 2020 2020 6966 2028 6974 6820 3d3d 2030      if (ith == 0
-0006a030: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0006a040: 6d65 6d73 6574 2864 7374 2d3e 6461 7461  memset(dst->data
-0006a050: 2c20 302c 206e 6230 2a6e 6530 2a6e 6531  , 0, nb0*ne0*ne1
-0006a060: 2a6e 6532 2a6e 6533 293b 0a20 2020 2020  *ne2*ne3);.     
-0006a070: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
-0006a080: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-0006a090: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-0006a0a0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-0006a0b0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-0006a0c0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-0006a0d0: 0a20 2020 202f 2f20 7061 7261 6c6c 656c  .    // parallel
-0006a0e0: 697a 6520 6279 2071 2072 6f77 7320 7573  ize by q rows us
-0006a0f0: 696e 6720 6767 6d6c 5f76 6563 5f64 6f74  ing ggml_vec_dot
-0006a100: 5f66 3332 0a0a 2020 2020 2f2f 2074 6f74  _f32..    // tot
-0006a110: 616c 2072 6f77 7320 696e 2071 0a20 2020  al rows in q.   
-0006a120: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
-0006a130: 6e65 7132 2a6e 6571 333b 0a0a 2020 2020  neq2*neq3;..    
-0006a140: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
-0006a150: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-0006a160: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
-0006a170: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
-0006a180: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
-0006a190: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
-0006a1a0: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
-0006a1b0: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
-0006a1c0: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
-0006a1d0: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
-0006a1e0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0006a1f0: 7363 616c 6520 3d20 312e 3066 2f73 7172  scale = 1.0f/sqr
-0006a200: 7466 2844 293b 0a0a 2020 2020 2f2f 7072  tf(D);..    //pr
-0006a210: 696e 7466 2822 503d 2564 204e 3d25 6420  intf("P=%d N=%d 
-0006a220: 443d 2564 2069 7230 3d25 6420 6972 313d  D=%d ir0=%d ir1=
-0006a230: 2564 2073 6361 6c65 203d 2025 665c 6e22  %d scale = %f\n"
-0006a240: 2c20 502c 204e 2c20 442c 2069 7230 2c20  , P, N, D, ir0, 
-0006a250: 6972 312c 2073 6361 6c65 293b 0a0a 2020  ir1, scale);..  
-0006a260: 2020 666f 7220 2869 6e74 2069 7220 3d20    for (int ir = 
-0006a270: 6972 303b 2069 7220 3c20 6972 313b 202b  ir0; ir < ir1; +
-0006a280: 2b69 7229 207b 0a20 2020 2020 2020 202f  +ir) {.        /
-0006a290: 2f20 7120 696e 6469 6365 730a 2020 2020  / q indices.    
-0006a2a0: 2020 2020 636f 6e73 7420 696e 7420 6971      const int iq
-0006a2b0: 3320 3d20 6972 2f28 6e65 7132 293b 0a20  3 = ir/(neq2);. 
-0006a2c0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0006a2d0: 2069 7132 203d 2069 7220 2d20 6971 332a   iq2 = ir - iq3*
-0006a2e0: 6e65 7132 3b0a 2020 2020 2020 2020 666f  neq2;.        fo
-0006a2f0: 7220 2820 696e 7420 6971 3120 3d20 303b  r ( int iq1 = 0;
-0006a300: 2069 7131 203c 206e 6571 313b 202b 2b69   iq1 < neq1; ++i
-0006a310: 7131 2920 7b0a 0a0a 2020 2020 2020 2020  q1) {...        
-0006a320: 2020 2020 2f2f 206e 6f74 2073 7572 6520      // not sure 
-0006a330: 6162 6f75 7420 4341 4348 455f 4c49 4e45  about CACHE_LINE
-0006a340: 5f53 495a 455f 4633 322e 2e0a 2020 2020  _SIZE_F32...    
-0006a350: 2020 2020 2020 2020 2f2f 202d 206d 6179          // - may
-0006a360: 6265 2069 7420 6d75 7374 206e 6f74 2062  be it must not b
-0006a370: 6520 6d75 6c74 6970 6c69 6564 2062 7920  e multiplied by 
-0006a380: 3220 616e 6420 6578 636c 7564 6564 2066  2 and excluded f
-0006a390: 726f 6d20 2e2e 2069 6e20 534d 2031 2a28  rom .. in SM 1*(
-0006a3a0: 2e2e 2920 6f66 6673 6574 3f0a 2020 2020  ..) offset?.    
-0006a3b0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-0006a3c0: 5320 203d 2028 666c 6f61 7420 2a29 2070  S  = (float *) p
-0006a3d0: 6172 616d 732d 3e77 6461 7461 202b 2069  arams->wdata + i
-0006a3e0: 7468 2a32 2a28 6d78 444d 202b 2043 4143  th*2*(mxDM + CAC
-0006a3f0: 4845 5f4c 494e 455f 5349 5a45 5f46 3332  HE_LINE_SIZE_F32
-0006a400: 2920 2b20 302a 286d 7844 4d2b 4341 4348  ) + 0*(mxDM+CACH
-0006a410: 455f 4c49 4e45 5f53 495a 455f 4633 3229  E_LINE_SIZE_F32)
-0006a420: 3b0a 2020 2020 2020 2020 2020 2020 666c  ;.            fl
-0006a430: 6f61 7420 2a20 534d 203d 2028 666c 6f61  oat * SM = (floa
-0006a440: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
-0006a450: 7461 202b 2069 7468 2a32 2a28 6d78 444d  ta + ith*2*(mxDM
-0006a460: 202b 2043 4143 4845 5f4c 494e 455f 5349   + CACHE_LINE_SI
-0006a470: 5a45 5f46 3332 2920 2b20 312a 286d 7844  ZE_F32) + 1*(mxD
-0006a480: 4d2b 4341 4348 455f 4c49 4e45 5f53 495a  M+CACHE_LINE_SIZ
-0006a490: 455f 4633 3229 3b0a 0a20 2020 2020 2020  E_F32);..       
-0006a4a0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-0006a4b0: 3d20 4d3b 2069 203c 204d 7570 3b20 2b2b  = M; i < Mup; ++
-0006a4c0: 6929 207b 0a20 2020 2020 2020 2020 2020  i) {.           
-0006a4d0: 2020 2020 2053 5b69 5d20 3d20 2d49 4e46       S[i] = -INF
-0006a4e0: 494e 4954 593b 0a20 2020 2020 2020 2020  INITY;.         
-0006a4f0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-0006a500: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-0006a510: 6320 3d20 303b 2069 6320 3c20 6e65 6b31  c = 0; ic < nek1
-0006a520: 3b20 2b2b 6963 2920 7b0a 2020 2020 2020  ; ++ic) {.      
-0006a530: 2020 2020 2020 2020 2020 2f2f 206b 2069            // k i
-0006a540: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
-0006a550: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0006a560: 2069 6b33 203d 2069 7133 3b0a 2020 2020   ik3 = iq3;.    
-0006a570: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0006a580: 7420 696e 7420 696b 3220 3d20 6971 323b  t int ik2 = iq2;
-0006a590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006a5a0: 2063 6f6e 7374 2069 6e74 2069 6b31 203d   const int ik1 =
-0006a5b0: 2069 633b 0a0a 2020 2020 2020 2020 2020   ic;..          
-0006a5c0: 2020 2020 2020 2f2f 2053 2069 6e64 6963        // S indic
-0006a5d0: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-0006a5e0: 2020 2063 6f6e 7374 2069 6e74 2069 3120     const int i1 
-0006a5f0: 3d20 696b 313b 0a0a 2020 2020 2020 2020  = ik1;..        
-0006a600: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0006a610: 5f64 6f74 5f66 3332 286e 6571 302c 0a20  _dot_f32(neq0,. 
-0006a620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a630: 2020 2020 2020 2053 202b 2069 312c 0a20         S + i1,. 
-0006a640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a650: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-0006a660: 2028 2863 6861 7220 2a29 206b 2d3e 6461   ((char *) k->da
-0006a670: 7461 202b 2028 696b 312a 6e62 6b31 202b  ta + (ik1*nbk1 +
-0006a680: 2069 6b32 2a6e 626b 3220 2b20 696b 332a   ik2*nbk2 + ik3*
-0006a690: 6e62 6b33 2929 2c0a 2020 2020 2020 2020  nbk3)),.        
-0006a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a6b0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-0006a6c0: 202a 2920 712d 3e64 6174 6120 2b20 2869   *) q->data + (i
-0006a6d0: 7131 2a6e 6271 3120 2b20 6971 322a 6e62  q1*nbq1 + iq2*nb
-0006a6e0: 7132 202b 2069 7133 2a6e 6271 3329 2929  q2 + iq3*nbq3)))
-0006a6f0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-0006a700: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0006a710: 7363 616c 650a 2020 2020 2020 2020 2020  scale.          
-0006a720: 2020 6767 6d6c 5f76 6563 5f73 6361 6c65    ggml_vec_scale
-0006a730: 5f66 3332 286e 656b 312c 2053 2c20 7363  _f32(nek1, S, sc
-0006a740: 616c 6529 3b0a 0a20 2020 2020 2020 2020  ale);..         
-0006a750: 2020 2069 6620 286d 6173 6b65 6429 207b     if (masked) {
-0006a760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006a770: 2066 6f72 2028 696e 7436 345f 7420 6920   for (int64_t i 
-0006a780: 3d20 503b 2069 203c 204d 3b20 692b 2b29  = P; i < M; i++)
-0006a790: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0006a7a0: 2020 2020 2020 2069 6620 2869 203e 2050         if (i > P
-0006a7b0: 202b 2069 7131 2920 7b0a 2020 2020 2020   + iq1) {.      
-0006a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a7d0: 2020 535b 695d 203d 202d 494e 4649 4e49    S[i] = -INFINI
-0006a7e0: 5459 3b0a 2020 2020 2020 2020 2020 2020  TY;.            
-0006a7f0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0006a800: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0006a810: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0006a820: 2020 2020 2020 202f 2f20 736f 6674 6d61         // softma
-0006a830: 780a 2020 2020 2020 2020 2020 2020 7b0a  x.            {.
-0006a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a850: 666c 6f61 7420 6d61 7820 3d20 2d49 4e46  float max = -INF
-0006a860: 494e 4954 593b 0a20 2020 2020 2020 2020  INITY;.         
-0006a870: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0006a880: 6d61 785f 6633 3228 4d2c 2026 6d61 782c  max_f32(M, &max,
-0006a890: 2053 293b 0a0a 2020 2020 2020 2020 2020   S);..          
-0006a8a0: 2020 2020 2020 6767 6d6c 5f66 6c6f 6174        ggml_float
-0006a8b0: 2073 756d 203d 2030 2e30 3b0a 2020 2020   sum = 0.0;.    
-0006a8c0: 2020 2020 2020 2020 2020 2020 7b0a 2369              {.#i
-0006a8d0: 6664 6566 2047 474d 4c5f 534f 4654 5f4d  fdef GGML_SOFT_M
-0006a8e0: 4158 5f41 4343 454c 4552 4154 450a 2020  AX_ACCELERATE.  
-0006a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a900: 2020 6d61 7820 3d20 2d6d 6178 3b0a 2020    max = -max;.  
-0006a910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a920: 2020 7644 5350 5f76 7361 6464 2853 4d2c    vDSP_vsadd(SM,
-0006a930: 2031 2c20 266d 6178 2c20 534d 2c20 312c   1, &max, SM, 1,
-0006a940: 204d 7570 293b 0a20 2020 2020 2020 2020   Mup);.         
-0006a950: 2020 2020 2020 2020 2020 2076 7665 7870             vvexp
-0006a960: 6628 534d 2c20 534d 2c20 264d 7570 293b  f(SM, SM, &Mup);
-0006a970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006a980: 2020 2020 2067 676d 6c5f 7665 635f 7375       ggml_vec_su
-0006a990: 6d5f 6633 3228 4d75 702c 2026 7375 6d2c  m_f32(Mup, &sum,
-0006a9a0: 2053 4d29 3b0a 2365 6c73 650a 2020 2020   SM);.#else.    
-0006a9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a9c0: 7569 6e74 3136 5f74 2020 2073 6376 745b  uint16_t   scvt[
-0006a9d0: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
-0006a9e0: 524f 4c4c 5d3b 0a20 2020 2020 2020 2020  ROLL];.         
-0006a9f0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0006aa00: 666c 6f61 7420 7375 6d70 5b47 474d 4c5f  float sump[GGML_
-0006aa10: 534f 4654 5f4d 4158 5f55 4e52 4f4c 4c5d  SOFT_MAX_UNROLL]
-0006aa20: 203d 207b 2030 2e30 207d 3b0a 0a20 2020   = { 0.0 };..   
-0006aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006aa40: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0006aa50: 2069 203c 204d 7570 3b20 6920 2b3d 2047   i < Mup; i += G
-0006aa60: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
-0006aa70: 4f4c 4c29 207b 0a20 2020 2020 2020 2020  OLL) {.         
-0006aa80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0006aa90: 6c6f 6174 202a 2053 5220 3d20 2053 202b  loat * SR =  S +
-0006aaa0: 2069 3b0a 2020 2020 2020 2020 2020 2020   i;.            
-0006aab0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-0006aac0: 7420 2a20 5357 203d 2053 4d20 2b20 693b  t * SW = SM + i;
-0006aad0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0006aae0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0006aaf0: 6e74 206a 203d 2030 3b20 6a20 3c20 4747  nt j = 0; j < GG
-0006ab00: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
-0006ab10: 4c4c 3b20 2b2b 6a29 207b 0a20 2020 2020  LL; ++j) {.     
+00069af0: 7631 203d 2076 2d3e 6e62 5b31 5d3b 0a20  v1 = v->nb[1];. 
+00069b00: 2020 2063 6f6e 7374 2069 6e74 206e 6276     const int nbv
+00069b10: 3220 3d20 762d 3e6e 625b 325d 3b0a 2020  2 = v->nb[2];.  
+00069b20: 2020 636f 6e73 7420 696e 7420 6e62 7633    const int nbv3
+00069b30: 203d 2076 2d3e 6e62 5b33 5d3b 0a0a 2020   = v->nb[3];..  
+00069b40: 2020 636f 6e73 7420 696e 7420 6e62 6430    const int nbd0
+00069b50: 203d 2064 2d3e 6e62 5b30 5d3b 0a20 2020   = d->nb[0];.   
+00069b60: 2063 6f6e 7374 2069 6e74 206e 6264 3120   const int nbd1 
+00069b70: 3d20 642d 3e6e 625b 315d 3b0a 2020 2020  = d->nb[1];.    
+00069b80: 636f 6e73 7420 696e 7420 6e62 6432 203d  const int nbd2 =
+00069b90: 2064 2d3e 6e62 5b32 5d3b 0a20 2020 2063   d->nb[2];.    c
+00069ba0: 6f6e 7374 2069 6e74 206e 6264 3320 3d20  onst int nbd3 = 
+00069bb0: 642d 3e6e 625b 335d 3b0a 0a20 2020 2063  d->nb[3];..    c
+00069bc0: 6f6e 7374 2069 6e74 206e 6230 2020 3d20  onst int nb0  = 
+00069bd0: 6473 742d 3e6e 625b 305d 3b0a 2020 2020  dst->nb[0];.    
+00069be0: 636f 6e73 7420 696e 7420 6e62 3120 203d  const int nb1  =
+00069bf0: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
+00069c00: 2063 6f6e 7374 2069 6e74 206e 6232 2020   const int nb2  
+00069c10: 3d20 6473 742d 3e6e 625b 325d 3b0a 2020  = dst->nb[2];.  
+00069c20: 2020 636f 6e73 7420 696e 7420 6e62 3320    const int nb3 
+00069c30: 203d 2064 7374 2d3e 6e62 5b33 5d3b 0a0a   = dst->nb[3];..
+00069c40: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+00069c50: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+00069c60: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00069c70: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+00069c80: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00069c90: 3634 5f74 2044 203d 206e 6571 303b 0a20  64_t D = neq0;. 
+00069ca0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00069cb0: 204e 203d 206e 6571 313b 0a20 2020 2063   N = neq1;.    c
+00069cc0: 6f6e 7374 2069 6e74 3634 5f74 2050 203d  onst int64_t P =
+00069cd0: 206e 656b 3120 2d20 4e3b 0a20 2020 2063   nek1 - N;.    c
+00069ce0: 6f6e 7374 2069 6e74 3634 5f74 204d 203d  onst int64_t M =
+00069cf0: 2050 202b 204e 3b0a 0a20 2020 2063 6f6e   P + N;..    con
+00069d00: 7374 2069 6e74 204d 7570 2020 3d20 6767  st int Mup  = gg
+00069d10: 6d6c 5f75 7028 4d2c 2047 474d 4c5f 534f  ml_up(M, GGML_SO
+00069d20: 4654 5f4d 4158 5f55 4e52 4f4c 4c29 3b0a  FT_MAX_UNROLL);.
+00069d30: 2020 2020 636f 6e73 7420 696e 7420 6d78      const int mx
+00069d40: 444d 203d 204d 4158 2844 2c20 4d75 7029  DM = MAX(D, Mup)
+00069d50: 3b0a 0a20 2020 202f 2f20 4747 4d4c 5f41  ;..    // GGML_A
+00069d60: 5353 4552 5428 6e65 3020 3d3d 2044 293b  SSERT(ne0 == D);
+00069d70: 0a20 2020 202f 2f20 4747 4d4c 5f41 5353  .    // GGML_ASS
+00069d80: 4552 5428 6e65 3120 3d3d 204e 293b 0a20  ERT(ne1 == N);. 
+00069d90: 2020 2047 474d 4c5f 4153 5345 5254 2850     GGML_ASSERT(P
+00069da0: 203e 3d20 3029 3b0a 0a20 2020 2047 474d   >= 0);..    GGM
+00069db0: 4c5f 4153 5345 5254 286e 6271 3020 3d3d  L_ASSERT(nbq0 ==
+00069dc0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00069dd0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00069de0: 286e 626b 3020 3d3d 2073 697a 656f 6628  (nbk0 == sizeof(
+00069df0: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
+00069e00: 4c5f 4153 5345 5254 286e 6276 3020 3d3d  L_ASSERT(nbv0 ==
+00069e10: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00069e20: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
+00069e30: 5428 6e65 7130 203d 3d20 4429 3b0a 2020  T(neq0 == D);.  
+00069e40: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+00069e50: 6b30 203d 3d20 4429 3b0a 2020 2020 4747  k0 == D);.    GG
+00069e60: 4d4c 5f41 5353 4552 5428 6e65 7631 203d  ML_ASSERT(nev1 =
+00069e70: 3d20 4429 3b0a 2020 2020 4747 4d4c 5f41  = D);.    GGML_A
+00069e80: 5353 4552 5428 6e65 6430 203d 3d20 4429  SSERT(ned0 == D)
+00069e90: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00069ea0: 5254 286e 6571 3120 3d3d 204e 293b 0a20  RT(neq1 == N);. 
+00069eb0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+00069ec0: 656b 3120 3d3d 204e 202b 2050 293b 0a20  ek1 == N + P);. 
+00069ed0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+00069ee0: 6576 3120 3d3d 2044 293b 0a20 2020 2047  ev1 == D);.    G
+00069ef0: 474d 4c5f 4153 5345 5254 286e 6564 3120  GML_ASSERT(ned1 
+00069f00: 3d3d 204e 293b 0a0a 2020 2020 2f2f 2064  == N);..    // d
+00069f10: 7374 2063 616e 6e6f 7420 6265 2074 7261  st cannot be tra
+00069f20: 6e73 706f 7365 6420 6f72 2070 6572 6d75  nsposed or permu
+00069f30: 7465 640a 2020 2020 4747 4d4c 5f41 5353  ted.    GGML_ASS
+00069f40: 4552 5428 6e62 3020 3d3d 2073 697a 656f  ERT(nb0 == sizeo
+00069f50: 6628 666c 6f61 7429 293b 0a20 2020 2047  f(float));.    G
+00069f60: 474d 4c5f 4153 5345 5254 286e 6230 203c  GML_ASSERT(nb0 <
+00069f70: 3d20 6e62 3129 3b0a 2020 2020 4747 4d4c  = nb1);.    GGML
+00069f80: 5f41 5353 4552 5428 6e62 3120 3c3d 206e  _ASSERT(nb1 <= n
+00069f90: 6232 293b 0a20 2020 2047 474d 4c5f 4153  b2);.    GGML_AS
+00069fa0: 5345 5254 286e 6232 203c 3d20 6e62 3329  SERT(nb2 <= nb3)
+00069fb0: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+00069fc0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00069fd0: 5441 534b 5f49 4e49 5429 207b 0a20 2020  TASK_INIT) {.   
+00069fe0: 2020 2020 2069 6620 2869 7468 203d 3d20       if (ith == 
+00069ff0: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+0006a000: 206d 656d 7365 7428 6473 742d 3e64 6174   memset(dst->dat
+0006a010: 612c 2030 2c20 6e62 302a 6e65 302a 6e65  a, 0, nb0*ne0*ne
+0006a020: 312a 6e65 322a 6e65 3329 3b0a 2020 2020  1*ne2*ne3);.    
+0006a030: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
+0006a040: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+0006a050: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+0006a060: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+0006a070: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+0006a080: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+0006a090: 0a0a 2020 2020 2f2f 2070 6172 616c 6c65  ..    // paralle
+0006a0a0: 6c69 7a65 2062 7920 7120 726f 7773 2075  lize by q rows u
+0006a0b0: 7369 6e67 2067 676d 6c5f 7665 635f 646f  sing ggml_vec_do
+0006a0c0: 745f 6633 320a 0a20 2020 202f 2f20 746f  t_f32..    // to
+0006a0d0: 7461 6c20 726f 7773 2069 6e20 710a 2020  tal rows in q.  
+0006a0e0: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
+0006a0f0: 206e 6571 322a 6e65 7133 3b0a 0a20 2020   neq2*neq3;..   
+0006a100: 202f 2f20 726f 7773 2070 6572 2074 6872   // rows per thr
+0006a110: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
+0006a120: 7420 6472 203d 2028 6e72 202b 206e 7468  t dr = (nr + nth
+0006a130: 202d 2031 292f 6e74 683b 0a0a 2020 2020   - 1)/nth;..    
+0006a140: 2f2f 2072 6f77 2072 616e 6765 2066 6f72  // row range for
+0006a150: 2074 6869 7320 7468 7265 6164 0a20 2020   this thread.   
+0006a160: 2063 6f6e 7374 2069 6e74 2069 7230 203d   const int ir0 =
+0006a170: 2064 722a 6974 683b 0a20 2020 2063 6f6e   dr*ith;.    con
+0006a180: 7374 2069 6e74 2069 7231 203d 204d 494e  st int ir1 = MIN
+0006a190: 2869 7230 202b 2064 722c 206e 7229 3b0a  (ir0 + dr, nr);.
+0006a1a0: 0a20 2020 2063 6f6e 7374 2066 6c6f 6174  .    const float
+0006a1b0: 2073 6361 6c65 203d 2031 2e30 662f 7371   scale = 1.0f/sq
+0006a1c0: 7274 6628 4429 3b0a 0a20 2020 202f 2f70  rtf(D);..    //p
+0006a1d0: 7269 6e74 6628 2250 3d25 6420 4e3d 2564  rintf("P=%d N=%d
+0006a1e0: 2044 3d25 6420 6972 303d 2564 2069 7231   D=%d ir0=%d ir1
+0006a1f0: 3d25 6420 7363 616c 6520 3d20 2566 5c6e  =%d scale = %f\n
+0006a200: 222c 2050 2c20 4e2c 2044 2c20 6972 302c  ", P, N, D, ir0,
+0006a210: 2069 7231 2c20 7363 616c 6529 3b0a 0a20   ir1, scale);.. 
+0006a220: 2020 2066 6f72 2028 696e 7420 6972 203d     for (int ir =
+0006a230: 2069 7230 3b20 6972 203c 2069 7231 3b20   ir0; ir < ir1; 
+0006a240: 2b2b 6972 2920 7b0a 2020 2020 2020 2020  ++ir) {.        
+0006a250: 2f2f 2071 2069 6e64 6963 6573 0a20 2020  // q indices.   
+0006a260: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0006a270: 7133 203d 2069 722f 286e 6571 3229 3b0a  q3 = ir/(neq2);.
+0006a280: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0006a290: 7420 6971 3220 3d20 6972 202d 2069 7133  t iq2 = ir - iq3
+0006a2a0: 2a6e 6571 323b 0a20 2020 2020 2020 2066  *neq2;.        f
+0006a2b0: 6f72 2028 2069 6e74 2069 7131 203d 2030  or ( int iq1 = 0
+0006a2c0: 3b20 6971 3120 3c20 6e65 7131 3b20 2b2b  ; iq1 < neq1; ++
+0006a2d0: 6971 3129 207b 0a0a 0a20 2020 2020 2020  iq1) {...       
+0006a2e0: 2020 2020 202f 2f20 6e6f 7420 7375 7265       // not sure
+0006a2f0: 2061 626f 7574 2043 4143 4845 5f4c 494e   about CACHE_LIN
+0006a300: 455f 5349 5a45 5f46 3332 2e2e 0a20 2020  E_SIZE_F32...   
+0006a310: 2020 2020 2020 2020 202f 2f20 2d20 6d61           // - ma
+0006a320: 7962 6520 6974 206d 7573 7420 6e6f 7420  ybe it must not 
+0006a330: 6265 206d 756c 7469 706c 6965 6420 6279  be multiplied by
+0006a340: 2032 2061 6e64 2065 7863 6c75 6465 6420   2 and excluded 
+0006a350: 6672 6f6d 202e 2e20 696e 2053 4d20 312a  from .. in SM 1*
+0006a360: 282e 2e29 206f 6666 7365 743f 0a20 2020  (..) offset?.   
+0006a370: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+0006a380: 2053 2020 3d20 2866 6c6f 6174 202a 2920   S  = (float *) 
+0006a390: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
+0006a3a0: 6974 682a 322a 286d 7844 4d20 2b20 4341  ith*2*(mxDM + CA
+0006a3b0: 4348 455f 4c49 4e45 5f53 495a 455f 4633  CHE_LINE_SIZE_F3
+0006a3c0: 3229 202b 2030 2a28 6d78 444d 2b43 4143  2) + 0*(mxDM+CAC
+0006a3d0: 4845 5f4c 494e 455f 5349 5a45 5f46 3332  HE_LINE_SIZE_F32
+0006a3e0: 293b 0a20 2020 2020 2020 2020 2020 2066  );.            f
+0006a3f0: 6c6f 6174 202a 2053 4d20 3d20 2866 6c6f  loat * SM = (flo
+0006a400: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
+0006a410: 6174 6120 2b20 6974 682a 322a 286d 7844  ata + ith*2*(mxD
+0006a420: 4d20 2b20 4341 4348 455f 4c49 4e45 5f53  M + CACHE_LINE_S
+0006a430: 495a 455f 4633 3229 202b 2031 2a28 6d78  IZE_F32) + 1*(mx
+0006a440: 444d 2b43 4143 4845 5f4c 494e 455f 5349  DM+CACHE_LINE_SI
+0006a450: 5a45 5f46 3332 293b 0a0a 2020 2020 2020  ZE_F32);..      
+0006a460: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0006a470: 203d 204d 3b20 6920 3c20 4d75 703b 202b   = M; i < Mup; +
+0006a480: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
+0006a490: 2020 2020 2020 535b 695d 203d 202d 494e        S[i] = -IN
+0006a4a0: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
+0006a4b0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0006a4c0: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+0006a4d0: 6963 203d 2030 3b20 6963 203c 206e 656b  ic = 0; ic < nek
+0006a4e0: 313b 202b 2b69 6329 207b 0a20 2020 2020  1; ++ic) {.     
+0006a4f0: 2020 2020 2020 2020 2020 202f 2f20 6b20             // k 
+0006a500: 696e 6469 6365 730a 2020 2020 2020 2020  indices.        
+0006a510: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0006a520: 7420 696b 3320 3d20 6971 333b 0a20 2020  t ik3 = iq3;.   
+0006a530: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0006a540: 7374 2069 6e74 2069 6b32 203d 2069 7132  st int ik2 = iq2
+0006a550: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006a560: 2020 636f 6e73 7420 696e 7420 696b 3120    const int ik1 
+0006a570: 3d20 6963 3b0a 0a20 2020 2020 2020 2020  = ic;..         
+0006a580: 2020 2020 2020 202f 2f20 5320 696e 6469         // S indi
+0006a590: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
+0006a5a0: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
+0006a5b0: 203d 2069 6b31 3b0a 0a20 2020 2020 2020   = ik1;..       
+0006a5c0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+0006a5d0: 635f 646f 745f 6633 3228 6e65 7130 2c0a  c_dot_f32(neq0,.
+0006a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a5f0: 2020 2020 2020 2020 5320 2b20 6931 2c0a          S + i1,.
+0006a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a610: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+0006a620: 2920 2828 6368 6172 202a 2920 6b2d 3e64  ) ((char *) k->d
+0006a630: 6174 6120 2b20 2869 6b31 2a6e 626b 3120  ata + (ik1*nbk1 
+0006a640: 2b20 696b 322a 6e62 6b32 202b 2069 6b33  + ik2*nbk2 + ik3
+0006a650: 2a6e 626b 3329 292c 0a20 2020 2020 2020  *nbk3)),.       
+0006a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a670: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+0006a680: 7220 2a29 2071 2d3e 6461 7461 202b 2028  r *) q->data + (
+0006a690: 6971 312a 6e62 7131 202b 2069 7132 2a6e  iq1*nbq1 + iq2*n
+0006a6a0: 6271 3220 2b20 6971 332a 6e62 7133 2929  bq2 + iq3*nbq3))
+0006a6b0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+0006a6c0: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
+0006a6d0: 2073 6361 6c65 0a20 2020 2020 2020 2020   scale.         
+0006a6e0: 2020 2067 676d 6c5f 7665 635f 7363 616c     ggml_vec_scal
+0006a6f0: 655f 6633 3228 6e65 6b31 2c20 532c 2073  e_f32(nek1, S, s
+0006a700: 6361 6c65 293b 0a0a 2020 2020 2020 2020  cale);..        
+0006a710: 2020 2020 6966 2028 6d61 736b 6564 2920      if (masked) 
+0006a720: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006a730: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0006a740: 203d 2050 3b20 6920 3c20 4d3b 2069 2b2b   = P; i < M; i++
+0006a750: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0006a760: 2020 2020 2020 2020 6966 2028 6920 3e20          if (i > 
+0006a770: 5020 2b20 6971 3129 207b 0a20 2020 2020  P + iq1) {.     
+0006a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a790: 2020 2053 5b69 5d20 3d20 2d49 4e46 494e     S[i] = -INFIN
+0006a7a0: 4954 593b 0a20 2020 2020 2020 2020 2020  ITY;.           
+0006a7b0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0006a7c0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0006a7d0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+0006a7e0: 2020 2020 2020 2020 2f2f 2073 6f66 746d          // softm
+0006a7f0: 6178 0a20 2020 2020 2020 2020 2020 207b  ax.            {
+0006a800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006a810: 2066 6c6f 6174 206d 6178 203d 202d 494e   float max = -IN
+0006a820: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
+0006a830: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0006a840: 5f6d 6178 5f66 3332 284d 2c20 266d 6178  _max_f32(M, &max
+0006a850: 2c20 5329 3b0a 0a20 2020 2020 2020 2020  , S);..         
+0006a860: 2020 2020 2020 2067 676d 6c5f 666c 6f61         ggml_floa
+0006a870: 7420 7375 6d20 3d20 302e 303b 0a20 2020  t sum = 0.0;.   
+0006a880: 2020 2020 2020 2020 2020 2020 207b 0a23               {.#
+0006a890: 6966 6465 6620 4747 4d4c 5f53 4f46 545f  ifdef GGML_SOFT_
+0006a8a0: 4d41 585f 4143 4345 4c45 5241 5445 0a20  MAX_ACCELERATE. 
+0006a8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a8c0: 2020 206d 6178 203d 202d 6d61 783b 0a20     max = -max;. 
+0006a8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a8e0: 2020 2076 4453 505f 7673 6164 6428 534d     vDSP_vsadd(SM
+0006a8f0: 2c20 312c 2026 6d61 782c 2053 4d2c 2031  , 1, &max, SM, 1
+0006a900: 2c20 4d75 7029 3b0a 2020 2020 2020 2020  , Mup);.        
+0006a910: 2020 2020 2020 2020 2020 2020 7676 6578              vvex
+0006a920: 7066 2853 4d2c 2053 4d2c 2026 4d75 7029  pf(SM, SM, &Mup)
+0006a930: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006a940: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+0006a950: 756d 5f66 3332 284d 7570 2c20 2673 756d  um_f32(Mup, &sum
+0006a960: 2c20 534d 293b 0a23 656c 7365 0a20 2020  , SM);.#else.   
+0006a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a980: 2075 696e 7431 365f 7420 2020 7363 7674   uint16_t   scvt
+0006a990: 5b47 474d 4c5f 534f 4654 5f4d 4158 5f55  [GGML_SOFT_MAX_U
+0006a9a0: 4e52 4f4c 4c5d 3b0a 2020 2020 2020 2020  NROLL];.        
+0006a9b0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0006a9c0: 5f66 6c6f 6174 2073 756d 705b 4747 4d4c  _float sump[GGML
+0006a9d0: 5f53 4f46 545f 4d41 585f 554e 524f 4c4c  _SOFT_MAX_UNROLL
+0006a9e0: 5d20 3d20 7b20 302e 3020 7d3b 0a0a 2020  ] = { 0.0 };..  
+0006a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006aa00: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0006aa10: 3b20 6920 3c20 4d75 703b 2069 202b 3d20  ; i < Mup; i += 
+0006aa20: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
+0006aa30: 524f 4c4c 2920 7b0a 2020 2020 2020 2020  ROLL) {.        
+0006aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006aa50: 666c 6f61 7420 2a20 5352 203d 2020 5320  float * SR =  S 
+0006aa60: 2b20 693b 0a20 2020 2020 2020 2020 2020  + i;.           
+0006aa70: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+0006aa80: 6174 202a 2053 5720 3d20 534d 202b 2069  at * SW = SM + i
+0006aa90: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0006aaa0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0006aab0: 696e 7420 6a20 3d20 303b 206a 203c 2047  int j = 0; j < G
+0006aac0: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
+0006aad0: 4f4c 4c3b 202b 2b6a 2920 7b0a 2020 2020  OLL; ++j) {.    
+0006aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006aaf0: 2020 2020 2020 2020 6966 2028 5352 5b6a          if (SR[j
+0006ab00: 5d20 3d3d 202d 494e 4649 4e49 5459 2920  ] == -INFINITY) 
+0006ab10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
 0006ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ab30: 2020 2020 2020 2069 6620 2853 525b 6a5d         if (SR[j]
-0006ab40: 203d 3d20 2d49 4e46 494e 4954 5929 207b   == -INFINITY) {
-0006ab50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ab70: 2053 575b 6a5d 203d 2030 2e30 663b 0a20   SW[j] = 0.0f;. 
-0006ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ab90: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-0006aba0: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
-0006abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006abc0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-0006abd0: 7320 3d20 4747 4d4c 5f46 5033 325f 544f  s = GGML_FP32_TO
-0006abe0: 5f46 5031 3628 5352 5b6a 5d20 2d20 6d61  _FP16(SR[j] - ma
-0006abf0: 7829 3b0a 2020 2020 2020 2020 2020 2020  x);.            
+0006ab30: 2020 5357 5b6a 5d20 3d20 302e 3066 3b0a    SW[j] = 0.0f;.
+0006ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ab50: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+0006ab60: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+0006ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ab80: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+0006ab90: 2073 203d 2047 474d 4c5f 4650 3332 5f54   s = GGML_FP32_T
+0006aba0: 4f5f 4650 3136 2853 525b 6a5d 202d 206d  O_FP16(SR[j] - m
+0006abb0: 6178 293b 0a20 2020 2020 2020 2020 2020  ax);.           
+0006abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006abd0: 2020 2020 206d 656d 6370 7928 2673 6376       memcpy(&scv
+0006abe0: 745b 6a5d 2c20 2673 2c20 7369 7a65 6f66  t[j], &s, sizeof
+0006abf0: 2875 696e 7431 365f 7429 293b 0a20 2020  (uint16_t));.   
 0006ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ac10: 2020 2020 6d65 6d63 7079 2826 7363 7674      memcpy(&scvt
-0006ac20: 5b6a 5d2c 2026 732c 2073 697a 656f 6628  [j], &s, sizeof(
-0006ac30: 7569 6e74 3136 5f74 2929 3b0a 2020 2020  uint16_t));.    
-0006ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ac50: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0006ac60: 7420 666c 6f61 7420 7661 6c20 3d20 4747  t float val = GG
-0006ac70: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
-0006ac80: 7461 626c 655f 6578 705f 6631 365b 7363  table_exp_f16[sc
-0006ac90: 7674 5b6a 5d5d 293b 0a20 2020 2020 2020  vt[j]]);.       
+0006ac10: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0006ac20: 7374 2066 6c6f 6174 2076 616c 203d 2047  st float val = G
+0006ac30: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
+0006ac40: 2874 6162 6c65 5f65 7870 5f66 3136 5b73  (table_exp_f16[s
+0006ac50: 6376 745b 6a5d 5d29 3b0a 2020 2020 2020  cvt[j]]);.      
+0006ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ac70: 2020 2020 2020 2020 2020 7375 6d70 5b6a            sump[j
+0006ac80: 5d20 2b3d 2028 6767 6d6c 5f66 6c6f 6174  ] += (ggml_float
+0006ac90: 2976 616c 3b0a 2020 2020 2020 2020 2020  )val;.          
 0006aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006acb0: 2020 2020 2020 2020 2073 756d 705b 6a5d           sump[j]
-0006acc0: 202b 3d20 2867 676d 6c5f 666c 6f61 7429   += (ggml_float)
-0006acd0: 7661 6c3b 0a20 2020 2020 2020 2020 2020  val;.           
-0006ace0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006acf0: 2020 2020 2053 575b 6a5d 203d 2076 616c       SW[j] = val
-0006ad00: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0006ad10: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0006ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ad30: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0006ad40: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0006ad50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006ad60: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-0006ad70: 3d20 303b 2069 203c 2047 474d 4c5f 534f  = 0; i < GGML_SO
-0006ad80: 4654 5f4d 4158 5f55 4e52 4f4c 4c3b 2069  FT_MAX_UNROLL; i
-0006ad90: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-0006ada0: 2020 2020 2020 2020 2020 2020 2020 7375                su
-0006adb0: 6d20 2b3d 2073 756d 705b 695d 3b0a 2020  m += sump[i];.  
-0006adc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006add0: 2020 7d0a 2365 6e64 6966 0a20 2020 2020    }.#endif.     
-0006ade0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-0006adf0: 2020 2020 2020 2020 2020 2020 2020 6173                as
-0006ae00: 7365 7274 2873 756d 203e 2030 2e30 293b  sert(sum > 0.0);
-0006ae10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0006ae20: 2020 7375 6d20 3d20 312e 302f 7375 6d3b    sum = 1.0/sum;
-0006ae30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006ae40: 2067 676d 6c5f 7665 635f 7363 616c 655f   ggml_vec_scale_
-0006ae50: 6633 3228 4d2c 2053 4d2c 2073 756d 293b  f32(M, SM, sum);
-0006ae60: 0a0a 2020 2020 2020 2020 2020 2020 7d0a  ..            }.
-0006ae70: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0006ae80: 7374 6570 2d62 792d 7374 6570 2065 7870  step-by-step exp
-0006ae90: 6c61 6e61 7469 6f6e 0a20 2020 2020 2020  lanation.       
-0006aea0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0006aeb0: 2020 2020 2020 202f 2f20 666f 7277 6172         // forwar
-0006aec0: 642d 7072 6f63 6573 7320 2020 2020 2020  d-process       
-0006aed0: 2020 2020 2020 2020 2020 2020 7368 6170              shap
-0006aee0: 6520 2020 2020 2067 7261 6473 2066 726f  e      grads fro
-0006aef0: 6d20 6261 636b 7761 7264 2070 726f 6365  m backward proce
-0006af00: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
-0006af10: 2020 202f 2f20 7061 7261 6c6c 656c 5f66     // parallel_f
-0006af20: 6f72 2069 7132 2c69 7133 3a0a 2020 2020  or iq2,iq3:.    
-0006af30: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
-0006af40: 6b5b 3a44 2c3a 4d2c 3a2c 3a5d 2020 2020  k[:D,:M,:,:]    
-0006af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006af60: 205b 442c 4d2c 3a2c 3a5d 2020 6772 6164   [D,M,:,:]  grad
-0006af70: 5b6b 5d5b 3a44 2c3a 4d2c 6971 322c 6971  [k][:D,:M,iq2,iq
-0006af80: 335d 2020 2b3d 2067 7261 645b 6b63 7572  3]  += grad[kcur
-0006af90: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0006afa0: 2020 2f2f 2020 715b 3a44 2c3a 4e2c 3a2c    //  q[:D,:N,:,
-0006afb0: 3a5d 2020 2020 2020 2020 2020 2020 2020  :]              
-0006afc0: 2020 2020 2020 205b 442c 4e2c 3a2c 3a5d         [D,N,:,:]
-0006afd0: 2020 6772 6164 5b71 5d5b 3a44 2c69 7131    grad[q][:D,iq1
-0006afe0: 2c69 7132 2c69 7133 5d20 2b3d 2067 7261  ,iq2,iq3] += gra
-0006aff0: 645b 7163 7572 5d0a 2020 2020 2020 2020  d[qcur].        
-0006b000: 2020 2020 2020 2020 2f2f 2020 765b 3a4d          //  v[:M
-0006b010: 2c3a 442c 3a2c 3a5d 2020 2020 2020 2020  ,:D,:,:]        
-0006b020: 2020 2020 2020 2020 2020 2020 205b 4d2c               [M,
-0006b030: 442c 3a2c 3a5d 2020 6772 6164 5b76 5d5b  D,:,:]  grad[v][
-0006b040: 3a4d 2c3a 442c 6971 322c 6971 335d 2020  :M,:D,iq2,iq3]  
-0006b050: 2b3d 2067 7261 645b 7663 7572 5d0a 2020  += grad[vcur].  
-0006b060: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006b070: 2020 666f 7220 6971 313a 0a20 2020 2020    for iq1:.     
-0006b080: 2020 2020 2020 2020 2020 202f 2f20 2020             //   
-0006b090: 6b63 7572 2020 203d 206b 5b3a 442c 3a4d  kcur   = k[:D,:M
-0006b0a0: 2c69 7132 2c69 7133 5d20 2020 2020 2020  ,iq2,iq3]       
-0006b0b0: 5b44 2c4d 2c31 2c31 5d20 2067 7261 645b  [D,M,1,1]  grad[
-0006b0c0: 6b63 7572 5d20 3d20 6772 6164 5b53 315d  kcur] = grad[S1]
-0006b0d0: 2e54 2040 2071 6375 720a 2020 2020 2020  .T @ qcur.      
-0006b0e0: 2020 2020 2020 2020 2020 2f2f 2020 2071            //   q
-0006b0f0: 6375 7220 2020 3d20 715b 3a44 2c69 7131  cur   = q[:D,iq1
-0006b100: 2c69 7132 2c69 7133 5d20 2020 2020 205b  ,iq2,iq3]      [
-0006b110: 442c 312c 312c 315d 2020 6772 6164 5b71  D,1,1,1]  grad[q
-0006b120: 6375 725d 203d 2067 7261 645b 5331 5d20  cur] = grad[S1] 
-0006b130: 2020 4020 6b63 7572 0a20 2020 2020 2020    @ kcur.       
-0006b140: 2020 2020 2020 2020 202f 2f20 2020 7663           //   vc
-0006b150: 7572 2020 203d 2076 5b3a 4d2c 3a44 2c69  ur   = v[:M,:D,i
-0006b160: 7132 2c69 7133 5d20 2020 2020 2020 5b4d  q2,iq3]       [M
-0006b170: 2c44 2c31 2c31 5d20 2067 7261 645b 7663  ,D,1,1]  grad[vc
-0006b180: 7572 5d20 3d20 6772 6164 5b53 355d 2e54  ur] = grad[S5].T
-0006b190: 2040 2053 340a 2020 2020 2020 2020 2020   @ S4.          
-0006b1a0: 2020 2020 2020 2f2f 2020 2053 3020 2020        //   S0   
-0006b1b0: 2020 3d20 2d49 6e66 2020 2020 2020 2020    = -Inf        
-0006b1c0: 2020 2020 2020 2020 2020 205b 442c 312c             [D,1,
-0006b1d0: 312c 315d 0a20 2020 2020 2020 2020 2020  1,1].           
-0006b1e0: 2020 2020 202f 2f20 207e 5331 5b69 5d20       //  ~S1[i] 
-0006b1f0: 203d 2064 6f74 286b 6375 725b 3a44 2c69   = dot(kcur[:D,i
-0006b200: 5d2c 2071 6375 7229 0a20 2020 2020 2020  ], qcur).       
-0006b210: 2020 2020 2020 2020 202f 2f20 2020 5331           //   S1
-0006b220: 2020 2020 203d 2071 6375 7220 4020 6b63       = qcur @ kc
-0006b230: 7572 2e54 2020 2020 2020 2020 2020 5b4d  ur.T          [M
-0006b240: 2c31 2c31 2c31 5d20 2067 7261 645b 5331  ,1,1,1]  grad[S1
-0006b250: 5d20 2020 3d20 6772 6164 5b53 325d 202a  ]   = grad[S2] *
-0006b260: 2073 6361 6c65 0a20 2020 2020 2020 2020   scale.         
-0006b270: 2020 2020 2020 202f 2f20 2020 5332 2020         //   S2  
-0006b280: 2020 203d 2053 3120 2a20 7363 616c 6520     = S1 * scale 
-0006b290: 2020 2020 2020 2020 2020 2020 5b4d 2c31              [M,1
-0006b2a0: 2c31 2c31 5d20 2067 7261 645b 5332 5d20  ,1,1]  grad[S2] 
-0006b2b0: 2020 3d20 6469 6167 5f6d 6173 6b5f 7a65    = diag_mask_ze
-0006b2c0: 726f 2867 7261 645b 5333 5d2c 2050 290a  ro(grad[S3], P).
-0006b2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b2e0: 2f2f 2020 2053 3320 2020 2020 3d20 6469  //   S3     = di
-0006b2f0: 6167 5f6d 6173 6b5f 696e 6628 5332 2c20  ag_mask_inf(S2, 
-0006b300: 5029 2020 205b 4d2c 312c 312c 315d 2020  P)   [M,1,1,1]  
-0006b310: 6772 6164 5b53 335d 2020 203d 2053 3420  grad[S3]   = S4 
-0006b320: 2a20 2867 7261 645b 5334 5d20 2d20 646f  * (grad[S4] - do
-0006b330: 7428 5334 2c20 6772 6164 5b53 345d 2929  t(S4, grad[S4]))
-0006b340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006b350: 202f 2f20 2020 5334 2020 2020 203d 2073   //   S4     = s
-0006b360: 6f66 746d 6178 2853 3329 2020 2020 2020  oftmax(S3)      
-0006b370: 2020 2020 2020 5b4d 2c31 2c31 2c31 5d20        [M,1,1,1] 
-0006b380: 2067 7261 645b 5334 5d20 2020 3d20 6772   grad[S4]   = gr
-0006b390: 6164 5b53 355d 2040 2076 6375 720a 2020  ad[S5] @ vcur.  
-0006b3a0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006b3b0: 2020 7e53 355b 695d 2020 3d20 646f 7428    ~S5[i]  = dot(
-0006b3c0: 7663 7572 5b3a 2c69 5d2c 2053 3429 0a20  vcur[:,i], S4). 
-0006b3d0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006b3e0: 2f20 2020 5335 2020 2020 203d 2053 3420  /   S5     = S4 
-0006b3f0: 4020 7663 7572 2e54 2020 2020 2020 2020  @ vcur.T        
-0006b400: 2020 2020 5b44 2c31 2c31 2c31 5d20 2067      [D,1,1,1]  g
-0006b410: 7261 645b 5335 5d20 2020 3d20 645b 3a44  rad[S5]   = d[:D
-0006b420: 2c69 7131 2c69 7132 2c69 7133 5d0a 2020  ,iq1,iq2,iq3].  
-0006b430: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006b440: 2020 7e64 7374 5b69 2c69 7131 2c69 7132    ~dst[i,iq1,iq2
-0006b450: 2c69 7133 5d20 203d 2053 355b 695d 2020  ,iq3]  = S5[i]  
-0006b460: 2020 2020 2020 2020 2020 2020 5e0a 2020              ^.  
-0006b470: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006b480: 2020 2064 7374 5b3a 442c 6971 312c 6971     dst[:D,iq1,iq
-0006b490: 322c 6971 335d 203d 2053 3520 2020 2020  2,iq3] = S5     
-0006b4a0: 2020 2020 2020 2020 2020 2020 7c20 6772              | gr
-0006b4b0: 6164 5b64 7374 5b3a 442c 6971 312c 6971  ad[dst[:D,iq1,iq
-0006b4c0: 322c 6971 335d 5d20 3d20 645b 3a44 2c69  2,iq3]] = d[:D,i
-0006b4d0: 7131 2c69 7132 2c69 7133 5d0a 2020 2020  q1,iq2,iq3].    
-0006b4e0: 2020 2020 2020 2020 2020 2020 2f2f 2064              // d
-0006b4f0: 7374 2020 2020 2020 2020 2020 2020 2020  st              
-0006b500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b510: 2062 6163 6b77 6172 642d 2f20 6772 6164   backward-/ grad
-0006b520: 5b64 7374 5d20 2020 2020 2020 2020 2020  [dst]           
-0006b530: 2020 2020 2020 3d20 640a 2020 2020 2020        = d.      
-0006b540: 2020 2020 2020 2020 2020 2f2f 0a20 2020            //.   
-0006b550: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006b560: 6f75 7470 7574 2067 7261 6469 656e 7473  output gradients
-0006b570: 2077 6974 6820 7468 6569 7220 6465 7065   with their depe
-0006b580: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-0006b590: 2020 2020 2020 2020 2020 2f2f 0a20 2020            //.   
-0006b5a0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006b5b0: 6772 6164 5b6b 6375 725d 203d 2067 7261  grad[kcur] = gra
-0006b5c0: 645b 5331 5d2e 5420 4020 7163 7572 0a20  d[S1].T @ qcur. 
-0006b5d0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006b5e0: 2f20 6772 6164 5b53 315d 2020 203d 2064  / grad[S1]   = d
-0006b5f0: 6961 675f 6d61 736b 5f7a 6572 6f28 6772  iag_mask_zero(gr
-0006b600: 6164 5b53 335d 2c20 5029 202a 2073 6361  ad[S3], P) * sca
-0006b610: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
-0006b620: 2020 202f 2f20 6772 6164 5b53 335d 2020     // grad[S3]  
-0006b630: 203d 2053 3420 2a20 2867 7261 645b 5334   = S4 * (grad[S4
-0006b640: 5d20 2d20 646f 7428 5334 2c20 6772 6164  ] - dot(S4, grad
-0006b650: 5b53 345d 2929 0a20 2020 2020 2020 2020  [S4])).         
-0006b660: 2020 2020 2020 202f 2f20 6772 6164 5b53         // grad[S
-0006b670: 345d 2020 203d 2067 7261 645b 5335 5d20  4]   = grad[S5] 
-0006b680: 4020 7663 7572 0a20 2020 2020 2020 2020  @ vcur.         
-0006b690: 2020 2020 2020 202f 2f20 6772 6164 5b53         // grad[S
-0006b6a0: 345d 2020 203d 2064 5b3a 442c 6971 312c  4]   = d[:D,iq1,
-0006b6b0: 6971 322c 6971 335d 2040 2076 6375 720a  iq2,iq3] @ vcur.
-0006b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b6d0: 2f2f 2067 7261 645b 7163 7572 5d20 3d20  // grad[qcur] = 
-0006b6e0: 6772 6164 5b53 315d 2020 2040 206b 6375  grad[S1]   @ kcu
-0006b6f0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0006b700: 2020 2f2f 2067 7261 645b 7663 7572 5d20    // grad[vcur] 
-0006b710: 3d20 6772 6164 5b53 355d 2e54 2040 2053  = grad[S5].T @ S
-0006b720: 340a 2020 2020 2020 2020 2020 2020 2020  4.              
-0006b730: 2020 2f2f 2067 7261 645b 7663 7572 5d20    // grad[vcur] 
-0006b740: 3d20 645b 3a44 2c69 7131 2c69 7132 2c69  = d[:D,iq1,iq2,i
-0006b750: 7133 5d2e 5420 4020 5334 0a20 2020 2020  q3].T @ S4.     
-0006b760: 2020 2020 2020 2020 2020 202f 2f0a 2020             //.  
-0006b770: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006b780: 2069 6e20 706f 7374 2d6f 7264 6572 3a0a   in post-order:.
-0006b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b7a0: 2f2f 0a20 2020 2020 2020 2020 2020 2020  //.             
-0006b7b0: 2020 202f 2f20 5331 2020 2020 2020 2020     // S1        
-0006b7c0: 203d 2071 6375 7220 4020 6b63 7572 2e54   = qcur @ kcur.T
-0006b7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006b7e0: 202f 2f20 5332 2020 2020 2020 2020 203d   // S2         =
-0006b7f0: 2053 3120 2a20 7363 616c 650a 2020 2020   S1 * scale.    
-0006b800: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
-0006b810: 3320 2020 2020 2020 2020 3d20 6469 6167  3         = diag
-0006b820: 5f6d 6173 6b5f 696e 6628 5332 2c20 5029  _mask_inf(S2, P)
-0006b830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006b840: 202f 2f20 5334 2020 2020 2020 2020 203d   // S4         =
-0006b850: 2073 6f66 746d 6178 2853 3329 0a20 2020   softmax(S3).   
-0006b860: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006b870: 6772 6164 5b53 345d 2020 203d 2064 5b3a  grad[S4]   = d[:
-0006b880: 442c 6971 312c 6971 322c 6971 335d 2040  D,iq1,iq2,iq3] @
-0006b890: 2076 6375 720a 2020 2020 2020 2020 2020   vcur.          
-0006b8a0: 2020 2020 2020 2f2f 2067 7261 645b 5333        // grad[S3
-0006b8b0: 5d20 2020 3d20 5334 202a 2028 6772 6164  ]   = S4 * (grad
-0006b8c0: 5b53 345d 202d 2064 6f74 2853 342c 2067  [S4] - dot(S4, g
-0006b8d0: 7261 645b 5334 5d29 290a 2020 2020 2020  rad[S4])).      
-0006b8e0: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
-0006b8f0: 645b 5331 5d20 2020 3d20 6469 6167 5f6d  d[S1]   = diag_m
-0006b900: 6173 6b5f 7a65 726f 2867 7261 645b 5333  ask_zero(grad[S3
-0006b910: 5d2c 2050 2920 2a20 7363 616c 650a 2020  ], P) * scale.  
-0006b920: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006b930: 2067 7261 645b 7163 7572 5d20 3d20 6772   grad[qcur] = gr
-0006b940: 6164 5b53 315d 2020 2040 206b 6375 720a  ad[S1]   @ kcur.
-0006b950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b960: 2f2f 2067 7261 645b 6b63 7572 5d20 3d20  // grad[kcur] = 
-0006b970: 6772 6164 5b53 315d 2e54 2040 2071 6375  grad[S1].T @ qcu
-0006b980: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0006b990: 2020 2f2f 2067 7261 645b 7663 7572 5d20    // grad[vcur] 
-0006b9a0: 3d20 645b 3a44 2c69 7131 2c69 7132 2c69  = d[:D,iq1,iq2,i
-0006b9b0: 7133 5d2e 5420 4020 5334 0a20 2020 2020  q3].T @ S4.     
-0006b9c0: 2020 2020 2020 2020 2020 202f 2f0a 2020             //.  
-0006b9d0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006b9e0: 2075 7369 6e67 206c 6573 7320 7661 7269   using less vari
-0006b9f0: 6162 6c65 7320 2853 4d3d 5334 293a 0a20  ables (SM=S4):. 
-0006ba00: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006ba10: 2f0a 2020 2020 2020 2020 2020 2020 2020  /.              
-0006ba20: 2020 2f2f 2053 2020 2020 2020 2020 2020    // S          
-0006ba30: 2020 203d 2064 6961 675f 6d61 736b 5f69     = diag_mask_i
-0006ba40: 6e66 2871 6375 7220 4020 6b63 7572 2e54  nf(qcur @ kcur.T
-0006ba50: 202a 2073 6361 6c65 2c20 5029 0a20 2020   * scale, P).   
-0006ba60: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006ba70: 534d 2020 2020 2020 2020 2020 2020 3d20  SM            = 
-0006ba80: 736f 6674 6d61 7828 5329 0a20 2020 2020  softmax(S).     
-0006ba90: 2020 2020 2020 2020 2020 202f 2f20 5320             // S 
-0006baa0: 2020 2020 2020 2020 2020 2020 3d20 645b              = d[
-0006bab0: 3a44 2c69 7131 2c69 7132 2c69 7133 5d20  :D,iq1,iq2,iq3] 
-0006bac0: 4020 7663 7572 0a20 2020 2020 2020 2020  @ vcur.         
-0006bad0: 2020 2020 2020 202f 2f20 646f 745f 534d         // dot_SM
-0006bae0: 5f67 7261 6453 4d20 3d20 646f 7428 534d  _gradSM = dot(SM
-0006baf0: 2c20 5329 0a20 2020 2020 2020 2020 2020  , S).           
-0006bb00: 2020 2020 202f 2f20 5320 2020 2020 2020       // S       
-0006bb10: 2020 2020 2020 3d20 534d 202a 2028 5320        = SM * (S 
-0006bb20: 2d20 646f 7428 534d 2c20 5329 290a 2020  - dot(SM, S)).  
-0006bb30: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006bb40: 2053 2020 2020 2020 2020 2020 2020 203d   S             =
-0006bb50: 2064 6961 675f 6d61 736b 5f7a 6572 6f28   diag_mask_zero(
-0006bb60: 532c 2050 2920 2a20 7363 616c 650a 2020  S, P) * scale.  
-0006bb70: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006bb80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006bb90: 202f 2f20 6772 6164 5b71 5d5b 3a44 2c69   // grad[q][:D,i
-0006bba0: 7131 2c69 7132 2c69 7133 5d20 2b3d 2053  q1,iq2,iq3] += S
-0006bbb0: 2020 2040 206b 6375 720a 2020 2020 2020     @ kcur.      
-0006bbc0: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
-0006bbd0: 645b 6b5d 5b3a 442c 3a4d 2c69 7132 2c69  d[k][:D,:M,iq2,i
-0006bbe0: 7133 5d20 202b 3d20 532e 5420 4020 7163  q3]  += S.T @ qc
-0006bbf0: 7572 0a20 2020 2020 2020 2020 2020 2020  ur.             
-0006bc00: 2020 202f 2f20 6772 6164 5b76 5d5b 3a4d     // grad[v][:M
-0006bc10: 2c3a 442c 6971 322c 6971 335d 2020 2b3d  ,:D,iq2,iq3]  +=
-0006bc20: 2064 5b3a 442c 6971 312c 6971 322c 6971   d[:D,iq1,iq2,iq
-0006bc30: 335d 2e54 2040 2053 4d0a 2020 2020 2020  3].T @ SM.      
-0006bc40: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0006bc50: 2020 2020 202f 2f20 5320 3d20 6772 6164       // S = grad
-0006bc60: 534d 203d 2064 5b3a 442c 6971 312c 6971  SM = d[:D,iq1,iq
-0006bc70: 322c 6971 335d 2040 2076 6375 720a 2020  2,iq3] @ vcur.  
-0006bc80: 2020 2020 2020 2020 2020 2f2f 2053 203d            // S =
-0006bc90: 2064 5b3a 442c 6971 312c 6971 322c 6971   d[:D,iq1,iq2,iq
-0006bca0: 335d 2040 2076 6375 720a 2020 2020 2020  3] @ vcur.      
-0006bcb0: 2020 2020 2020 2f2f 2053 5b3a 4d5d 202b        // S[:M] +
-0006bcc0: 3d20 7663 7572 5b3a 4d2c 6963 5d20 2a20  = vcur[:M,ic] * 
-0006bcd0: 645b 6963 2c69 7131 2c69 7132 2c69 7133  d[ic,iq1,iq2,iq3
-0006bce0: 5d0a 2020 2020 2020 2020 2020 2020 6767  ].            gg
-0006bcf0: 6d6c 5f76 6563 5f73 6574 5f66 3332 284d  ml_vec_set_f32(M
-0006bd00: 2c20 532c 2030 293b 0a20 2020 2020 2020  , S, 0);.       
-0006bd10: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-0006bd20: 7420 6963 203d 2030 3b20 6963 203c 2044  t ic = 0; ic < D
-0006bd30: 3b20 2b2b 6963 2920 7b0a 2020 2020 2020  ; ++ic) {.      
-0006bd40: 2020 2020 2020 2020 2020 2f2f 2064 7374            // dst
-0006bd50: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
-0006bd60: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-0006bd70: 6e74 2069 3120 3d20 6971 313b 0a20 2020  nt i1 = iq1;.   
-0006bd80: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0006bd90: 7374 2069 6e74 2069 3220 3d20 6971 323b  st int i2 = iq2;
-0006bda0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006bdb0: 2063 6f6e 7374 2069 6e74 2069 3320 3d20   const int i3 = 
-0006bdc0: 6971 333b 0a0a 2020 2020 2020 2020 2020  iq3;..          
-0006bdd0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
-0006bde0: 6164 5f66 3332 284d 2c0a 2020 2020 2020  ad_f32(M,.      
-0006bdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006be00: 2020 532c 0a20 2020 2020 2020 2020 2020    S,.           
-0006be10: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-0006be20: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-0006be30: 2920 762d 3e64 6174 6120 2b20 2820 2020  ) v->data + (   
-0006be40: 2020 2020 2020 2069 632a 6e62 7631 202b         ic*nbv1 +
-0006be50: 2069 322a 6e62 7632 202b 2069 332a 6e62   i2*nbv2 + i3*nb
-0006be60: 7633 2929 2c0a 2020 2020 2020 2020 2020  v3)),.          
-0006be70: 2020 2020 2020 2020 2020 2020 2020 2a28                *(
-0006be80: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-0006be90: 2a29 2064 2d3e 6461 7461 202b 2028 6963  *) d->data + (ic
-0006bea0: 2a6e 6264 3020 2b20 6931 2a6e 6264 3120  *nbd0 + i1*nbd1 
-0006beb0: 2b20 6932 2a6e 6264 3220 2b20 6933 2a6e  + i2*nbd2 + i3*n
-0006bec0: 6264 3329 2929 3b0a 2020 2020 2020 2020  bd3)));.        
-0006bed0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-0006bee0: 2020 202f 2f20 5320 3d20 534d 202a 2028     // S = SM * (
-0006bef0: 5320 2d20 646f 7428 534d 2c20 5329 290a  S - dot(SM, S)).
-0006bf00: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-0006bf10: 7420 646f 745f 534d 5f67 7261 6453 4d20  t dot_SM_gradSM 
-0006bf20: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-0006bf30: 2067 676d 6c5f 7665 635f 646f 745f 6633   ggml_vec_dot_f3
-0006bf40: 3220 284d 2c20 2664 6f74 5f53 4d5f 6772  2 (M, &dot_SM_gr
-0006bf50: 6164 534d 2c20 534d 2c20 5329 3b0a 2020  adSM, SM, S);.  
-0006bf60: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-0006bf70: 6563 5f61 6363 315f 6633 3228 4d2c 2053  ec_acc1_f32(M, S
-0006bf80: 2c20 2d64 6f74 5f53 4d5f 6772 6164 534d  , -dot_SM_gradSM
-0006bf90: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
-0006bfa0: 676d 6c5f 7665 635f 6d75 6c5f 6633 3220  gml_vec_mul_f32 
-0006bfb0: 284d 2c20 532c 2053 2c20 534d 293b 0a0a  (M, S, S, SM);..
-0006bfc0: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
-0006bfd0: 203d 2064 6961 675f 6d61 736b 5f7a 6572   = diag_mask_zer
-0006bfe0: 6f28 532c 2050 2920 2a20 7363 616c 650a  o(S, P) * scale.
-0006bff0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0006c000: 6d61 736b 6564 2920 7b0a 2020 2020 2020  masked) {.      
-0006c010: 2020 2020 2020 2020 2020 2f2f 2066 6f72            // for
-0006c020: 2028 696e 7436 345f 7420 6920 3d20 5020   (int64_t i = P 
-0006c030: 2b20 6971 3120 2b20 313b 2069 203c 204d  + iq1 + 1; i < M
-0006c040: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-0006c050: 2020 2020 2020 2020 202f 2f20 2020 2020           //     
-0006c060: 535b 695d 203d 2030 3b0a 2020 2020 2020  S[i] = 0;.      
-0006c070: 2020 2020 2020 2020 2020 2f2f 207d 0a20            // }. 
-0006c080: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0006c090: 6f72 2028 696e 7436 345f 7420 6920 3d20  or (int64_t i = 
-0006c0a0: 503b 2069 203c 204d 3b20 692b 2b29 207b  P; i < M; i++) {
-0006c0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006c0c0: 2020 2020 2069 6620 2869 203e 2050 202b       if (i > P +
-0006c0d0: 2069 7131 2920 7b0a 2020 2020 2020 2020   iq1) {.        
-0006c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c0f0: 535b 695d 203d 2030 3b0a 2020 2020 2020  S[i] = 0;.      
-0006c100: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0006c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c120: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-0006c130: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0006c140: 5f76 6563 5f73 6361 6c65 5f66 3332 284d  _vec_scale_f32(M
-0006c150: 2c20 532c 2073 6361 6c65 293b 0a0a 2020  , S, scale);..  
-0006c160: 2020 2020 2020 2020 2020 766f 6964 202a            void *
-0006c170: 2067 7261 645f 7120 3d20 2863 6861 7220   grad_q = (char 
-0006c180: 2a29 2064 7374 2d3e 6461 7461 3b0a 2020  *) dst->data;.  
-0006c190: 2020 2020 2020 2020 2020 766f 6964 202a            void *
-0006c1a0: 2067 7261 645f 6b20 3d20 2863 6861 7220   grad_k = (char 
-0006c1b0: 2a29 2064 7374 2d3e 6461 7461 202b 206e  *) dst->data + n
-0006c1c0: 6230 2a44 2a4e 2a6e 6571 322a 6e65 7133  b0*D*N*neq2*neq3
-0006c1d0: 3b0a 2020 2020 2020 2020 2020 2020 766f  ;.            vo
-0006c1e0: 6964 202a 2067 7261 645f 7620 3d20 2863  id * grad_v = (c
-0006c1f0: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
-0006c200: 202b 206e 6230 2a44 2a4e 2a6e 6571 322a   + nb0*D*N*neq2*
-0006c210: 6e65 7133 202b 206e 6230 2a44 2a4d 2a6e  neq3 + nb0*D*M*n
-0006c220: 6571 322a 6e65 7133 3b0a 0a20 2020 2020  eq2*neq3;..     
-0006c230: 2020 2020 2020 2063 6f6e 7374 2073 697a         const siz
-0006c240: 655f 7420 6e62 6771 3120 3d20 6e62 302a  e_t nbgq1 = nb0*
-0006c250: 6e65 7130 3b0a 2020 2020 2020 2020 2020  neq0;.          
-0006c260: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0006c270: 6267 7132 203d 206e 6230 2a6e 6571 302a  bgq2 = nb0*neq0*
-0006c280: 6e65 7131 3b0a 2020 2020 2020 2020 2020  neq1;.          
-0006c290: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-0006c2a0: 6267 7133 203d 206e 6230 2a6e 6571 302a  bgq3 = nb0*neq0*
-0006c2b0: 6e65 7131 2a6e 6571 323b 0a0a 2020 2020  neq1*neq2;..    
-0006c2c0: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
-0006c2d0: 7a65 5f74 206e 6267 6b31 203d 206e 6230  ze_t nbgk1 = nb0
-0006c2e0: 2a6e 656b 303b 0a20 2020 2020 2020 2020  *nek0;.         
-0006c2f0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0006c300: 6e62 676b 3220 3d20 6e62 302a 6e65 6b30  nbgk2 = nb0*nek0
-0006c310: 2a6e 656b 313b 0a20 2020 2020 2020 2020  *nek1;.         
-0006c320: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0006c330: 6e62 676b 3320 3d20 6e62 302a 6e65 6b30  nbgk3 = nb0*nek0
-0006c340: 2a6e 656b 312a 6e65 7132 3b0a 0a20 2020  *nek1*neq2;..   
-0006c350: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-0006c360: 697a 655f 7420 6e62 6776 3120 3d20 6e62  ize_t nbgv1 = nb
-0006c370: 302a 6e65 7630 3b0a 2020 2020 2020 2020  0*nev0;.        
-0006c380: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0006c390: 206e 6267 7632 203d 206e 6230 2a6e 6576   nbgv2 = nb0*nev
-0006c3a0: 302a 6e65 7631 3b0a 2020 2020 2020 2020  0*nev1;.        
-0006c3b0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0006c3c0: 206e 6267 7633 203d 206e 6230 2a6e 6576   nbgv3 = nb0*nev
-0006c3d0: 302a 6e65 7631 2a6e 6571 323b 0a0a 2020  0*nev1*neq2;..  
-0006c3e0: 2020 2020 2020 2020 2020 2f2f 2053 2020            // S  
-0006c3f0: 2020 7368 6170 6520 5b4d 2c31 5d0a 2020    shape [M,1].  
-0006c400: 2020 2020 2020 2020 2020 2f2f 2053 4d20            // SM 
-0006c410: 2020 7368 6170 6520 5b4d 2c31 5d0a 2020    shape [M,1].  
-0006c420: 2020 2020 2020 2020 2020 2f2f 206b 6375            // kcu
-0006c430: 7220 7368 6170 6520 5b44 2c4d 5d0a 2020  r shape [D,M].  
-0006c440: 2020 2020 2020 2020 2020 2f2f 2071 6375            // qcu
-0006c450: 7220 7368 6170 6520 5b44 2c31 5d0a 2020  r shape [D,1].  
-0006c460: 2020 2020 2020 2020 2020 2f2f 2076 6375            // vcu
-0006c470: 7220 7368 6170 6520 5b4d 2c44 5d0a 2020  r shape [M,D].  
-0006c480: 2020 2020 2020 2020 2020 2f2f 0a20 2020            //.   
-0006c490: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
-0006c4a0: 5b71 5d5b 3a44 2c69 7131 2c69 7132 2c69  [q][:D,iq1,iq2,i
-0006c4b0: 7133 5d20 2b3d 2053 2040 206b 6375 720a  q3] += S @ kcur.
-0006c4c0: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
-0006c4d0: 7261 645b 715d 5b3a 442c 6971 312c 6971  rad[q][:D,iq1,iq
-0006c4e0: 322c 6971 335d 202b 3d20 7368 6170 655b  2,iq3] += shape[
-0006c4f0: 4d2c 315d 2040 2073 6861 7065 5b44 2c4d  M,1] @ shape[D,M
-0006c500: 5d0a 2020 2020 2020 2020 2020 2020 2f2f  ].            //
-0006c510: 2067 7261 645b 715d 5b3a 442c 6971 312c   grad[q][:D,iq1,
-0006c520: 6971 322c 6971 335d 202b 3d20 535b 6963  iq2,iq3] += S[ic
-0006c530: 5d20 2a20 6b63 7572 5b3a 442c 6963 5d0a  ] * kcur[:D,ic].
-0006c540: 2020 2020 2020 2020 2020 2020 2f2f 0a20              //. 
-0006c550: 2020 2020 2020 2020 2020 202f 2f2f 2f20             //// 
-0006c560: 6772 6164 5b71 5d5b 6963 2c69 7131 2c69  grad[q][ic,iq1,i
-0006c570: 7132 2c69 7133 5d20 2b3d 2064 6f74 286b  q2,iq3] += dot(k
-0006c580: 6375 725b 3a2c 6963 5d2c 532e 5429 0a20  cur[:,ic],S.T). 
-0006c590: 2020 2020 2020 2020 2020 202f 2f2f 2f20             //// 
-0006c5a0: 6772 6164 5b71 5d5b 6963 2c69 7131 2c69  grad[q][ic,iq1,i
-0006c5b0: 7132 2c69 7133 5d20 2b3d 2064 6f74 286b  q2,iq3] += dot(k
-0006c5c0: 5b3a 442c 6963 2c69 7132 2c69 7133 5d2c  [:D,ic,iq2,iq3],
-0006c5d0: 532e 5429 0a20 2020 2020 2020 2020 2020  S.T).           
-0006c5e0: 2066 6f72 2028 696e 7436 345f 7420 6963   for (int64_t ic
-0006c5f0: 203d 2030 3b20 6963 203c 204d 3b20 2b2b   = 0; ic < M; ++
-0006c600: 6963 2920 7b0a 2020 2020 2020 2020 2020  ic) {.          
-0006c610: 2020 2020 2020 2f2f 2064 7374 2069 6e64        // dst ind
-0006c620: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
-0006c630: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0006c640: 3120 3d20 6971 313b 0a20 2020 2020 2020  1 = iq1;.       
-0006c650: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-0006c660: 6e74 2069 3220 3d20 6971 323b 0a20 2020  nt i2 = iq2;.   
-0006c670: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0006c680: 7374 2069 6e74 2069 3320 3d20 6971 333b  st int i3 = iq3;
-0006c690: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0006c6a0: 2020 6767 6d6c 5f76 6563 5f6d 6164 5f66    ggml_vec_mad_f
-0006c6b0: 3332 2844 2c0a 2020 2020 2020 2020 2020  32(D,.          
-0006c6c0: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-0006c6d0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-0006c6e0: 2920 6772 6164 5f71 2020 2b20 2869 312a  ) grad_q  + (i1*
-0006c6f0: 6e62 6771 3120 202b 2069 322a 6e62 6771  nbgq1  + i2*nbgq
-0006c700: 3220 202b 2069 332a 6e62 6771 3329 292c  2  + i3*nbgq3)),
-0006c710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006c720: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-0006c730: 2a29 2028 2863 6861 7220 2a29 206b 2d3e  *) ((char *) k->
-0006c740: 6461 7461 202b 2028 6963 2a6e 626b 3120  data + (ic*nbk1 
-0006c750: 2020 2b20 6932 2a6e 626b 3220 2020 2b20    + i2*nbk2   + 
-0006c760: 6933 2a6e 626b 3329 292c 0a20 2020 2020  i3*nbk3)),.     
-0006c770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c780: 2020 2053 5b69 635d 293b 0a20 2020 2020     S[ic]);.     
-0006c790: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0006c7a0: 2020 2020 2020 2f2f 2067 7261 645b 6b5d        // grad[k]
-0006c7b0: 5b3a 442c 3a4d 2c69 7132 2c69 7133 5d20  [:D,:M,iq2,iq3] 
-0006c7c0: 2b3d 2053 2e54 2020 2020 2020 2040 2071  += S.T       @ q
-0006c7d0: 6375 720a 2020 2020 2020 2020 2020 2020  cur.            
-0006c7e0: 2f2f 2067 7261 645b 6b5d 5b3a 442c 6963  // grad[k][:D,ic
-0006c7f0: 2c69 7132 2c69 7133 5d20 2b3d 2053 2e54  ,iq2,iq3] += S.T
-0006c800: 5b30 2c69 635d 202a 2071 6375 725b 3a44  [0,ic] * qcur[:D
-0006c810: 2c30 5d0a 2020 2020 2020 2020 2020 2020  ,0].            
-0006c820: 2f2f 2067 7261 645b 6b5d 5b3a 442c 6963  // grad[k][:D,ic
-0006c830: 2c69 7132 2c69 7133 5d20 2b3d 2053 5b69  ,iq2,iq3] += S[i
-0006c840: 635d 2020 2020 202a 2071 6375 725b 3a44  c]     * qcur[:D
-0006c850: 2c30 5d0a 2020 2020 2020 2020 2020 2020  ,0].            
-0006c860: 666f 7220 2869 6e74 3634 5f74 2069 6320  for (int64_t ic 
-0006c870: 3d20 303b 2069 6320 3c20 4d3b 202b 2b69  = 0; ic < M; ++i
-0006c880: 6329 207b 0a20 2020 2020 2020 2020 2020  c) {.           
-0006c890: 2020 2020 202f 2f20 6473 7420 696e 6469       // dst indi
-0006c8a0: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
-0006c8b0: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
-0006c8c0: 203d 2069 7131 3b0a 2020 2020 2020 2020   = iq1;.        
-0006c8d0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0006c8e0: 7420 6932 203d 2069 7132 3b0a 2020 2020  t i2 = iq2;.    
-0006c8f0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0006c900: 7420 696e 7420 6933 203d 2069 7133 3b0a  t int i3 = iq3;.
-0006c910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006c920: 202f 2f20 6767 6d6c 5f76 6563 5f73 6574   // ggml_vec_set
-0006c930: 5f66 3332 2844 2c0a 2020 2020 2020 2020  _f32(D,.        
-0006c940: 2020 2020 2020 2020 2f2f 2020 2020 2020          //      
-0006c950: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-0006c960: 6861 7220 2a29 2067 7261 645f 6b20 202b  har *) grad_k  +
-0006c970: 2028 6963 2a6e 6267 6b31 2020 2b20 6932   (ic*nbgk1  + i2
-0006c980: 2a6e 6267 6b32 2020 2b20 6933 2a6e 6267  *nbgk2  + i3*nbg
-0006c990: 6b33 2929 2c0a 2020 2020 2020 2020 2020  k3)),.          
-0006c9a0: 2020 2020 2020 2f2f 2020 2020 2020 2020        //        
-0006c9b0: 2030 293b 0a20 2020 2020 2020 2020 2020   0);.           
-0006c9c0: 2020 2020 2067 676d 6c5f 7665 635f 6d61       ggml_vec_ma
-0006c9d0: 645f 6633 3228 442c 0a20 2020 2020 2020  d_f32(D,.       
-0006c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c9f0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-0006ca00: 7220 2a29 2067 7261 645f 6b20 202b 2028  r *) grad_k  + (
-0006ca10: 6963 2a6e 6267 6b31 2020 2b20 6932 2a6e  ic*nbgk1  + i2*n
-0006ca20: 6267 6b32 2020 2b20 6933 2a6e 6267 6b33  bgk2  + i3*nbgk3
-0006ca30: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0006ca40: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
-0006ca50: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-0006ca60: 712d 3e64 6174 6120 2b20 2869 312a 6e62  q->data + (i1*nb
-0006ca70: 7131 2020 202b 2069 322a 6e62 7132 2020  q1   + i2*nbq2  
-0006ca80: 202b 2069 332a 6e62 7133 2929 2c0a 2020   + i3*nbq3)),.  
-0006ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006caa0: 2020 2020 2020 535b 6963 5d29 3b0a 2020        S[ic]);.  
-0006cab0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-0006cac0: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
-0006cad0: 5b76 5d5b 3a4d 2c3a 442c 6971 322c 6971  [v][:M,:D,iq2,iq
-0006cae0: 335d 202b 3d20 645b 3a44 2c69 7131 2c69  3] += d[:D,iq1,i
-0006caf0: 7132 2c69 7133 5d2e 5420 2020 2020 2020  q2,iq3].T       
-0006cb00: 4020 534d 0a20 2020 2020 2020 2020 2020  @ SM.           
-0006cb10: 202f 2f20 6772 6164 5b76 5d5b 3a4d 2c69   // grad[v][:M,i
-0006cb20: 632c 6971 322c 6971 335d 202b 3d20 645b  c,iq2,iq3] += d[
-0006cb30: 3a44 2c69 7131 2c69 7132 2c69 7133 5d2e  :D,iq1,iq2,iq3].
-0006cb40: 545b 302c 6963 5d20 2a20 534d 5b3a 4d5d  T[0,ic] * SM[:M]
-0006cb50: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0006cb60: 6772 6164 5b76 5d5b 3a4d 2c69 632c 6971  grad[v][:M,ic,iq
-0006cb70: 322c 6971 335d 202b 3d20 645b 6963 2c69  2,iq3] += d[ic,i
-0006cb80: 7131 2c69 7132 2c69 7133 5d20 2020 2020  q1,iq2,iq3]     
-0006cb90: 2020 2020 2a20 534d 5b3a 4d5d 0a20 2020      * SM[:M].   
-0006cba0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0006cbb0: 7436 345f 7420 6963 203d 2030 3b20 6963  t64_t ic = 0; ic
-0006cbc0: 203c 2044 3b20 2b2b 6963 2920 7b0a 2020   < D; ++ic) {.  
-0006cbd0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006cbe0: 2064 7374 2069 6e64 6963 6573 0a20 2020   dst indices.   
-0006cbf0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0006cc00: 7374 2069 6e74 2069 3120 3d20 6971 313b  st int i1 = iq1;
-0006cc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006cc20: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
-0006cc30: 6971 323b 0a20 2020 2020 2020 2020 2020  iq2;.           
-0006cc40: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0006cc50: 3320 3d20 6971 333b 0a0a 2020 2020 2020  3 = iq3;..      
-0006cc60: 2020 2020 2020 2020 2020 2f2f 2067 676d            // ggm
-0006cc70: 6c5f 7665 635f 7365 745f 6633 3228 4d2c  l_vec_set_f32(M,
-0006cc80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006cc90: 202f 2f20 2020 2020 2020 2020 2866 6c6f   //         (flo
-0006cca0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-0006ccb0: 6772 6164 5f76 2020 202b 2028 2020 2020  grad_v   + (    
-0006ccc0: 2020 2020 2020 6963 2a6e 6267 7631 202b        ic*nbgv1 +
-0006ccd0: 2069 322a 6e62 6776 3220 2b20 6933 2a6e   i2*nbgv2 + i3*n
-0006cce0: 6267 7633 2929 2c0a 2020 2020 2020 2020  bgv3)),.        
-0006ccf0: 2020 2020 2020 2020 2f2f 2020 2020 2020          //      
-0006cd00: 2020 2030 293b 0a20 2020 2020 2020 2020     0);.         
-0006cd10: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0006cd20: 6d61 645f 6633 3228 4d2c 0a20 2020 2020  mad_f32(M,.     
-0006cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cd40: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-0006cd50: 6861 7220 2a29 2067 7261 645f 7620 2020  har *) grad_v   
-0006cd60: 2b20 2820 2020 2020 2020 2020 2069 632a  + (          ic*
-0006cd70: 6e62 6776 3120 2b20 6932 2a6e 6267 7632  nbgv1 + i2*nbgv2
-0006cd80: 202b 2069 332a 6e62 6776 3329 292c 0a20   + i3*nbgv3)),. 
-0006cd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cda0: 2020 2020 2020 2053 4d2c 0a20 2020 2020         SM,.     
-0006cdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cdc0: 2020 202a 2866 6c6f 6174 202a 2920 2828     *(float *) ((
-0006cdd0: 6368 6172 202a 2920 642d 3e64 6174 6120  char *) d->data 
-0006cde0: 2b20 2869 632a 6e62 6430 202b 2069 312a  + (ic*nbd0 + i1*
-0006cdf0: 6e62 6431 2020 2b20 6932 2a6e 6264 3220  nbd1  + i2*nbd2 
-0006ce00: 202b 2069 332a 6e62 6433 2929 293b 0a20   + i3*nbd3)));. 
-0006ce10: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0006ce20: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
-0006ce30: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-0006ce40: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0006ce50: 5f66 6c61 7368 5f61 7474 6e5f 6261 636b  _flash_attn_back
-0006ce60: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-0006ce70: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-0006ce80: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-0006ce90: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-0006cea0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-0006ceb0: 656e 736f 7220 2a20 712c 0a20 2020 2020  ensor * q,.     
-0006cec0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0006ced0: 6767 6d6c 5f74 656e 736f 7220 2a20 6b2c  ggml_tensor * k,
-0006cee0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0006cef0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0006cf00: 7220 2a20 762c 0a20 2020 2020 2020 2063  r * v,.        c
-0006cf10: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0006cf20: 5f74 656e 736f 7220 2a20 642c 0a20 2020  _tensor * d,.   
-0006cf30: 2020 2020 2063 6f6e 7374 2062 6f6f 6c20       const bool 
-0006cf40: 6d61 736b 6564 2c0a 2020 2020 2020 2020  masked,.        
-0006cf50: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0006cf60: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-0006cf70: 7377 6974 6368 2028 712d 3e74 7970 6529  switch (q->type)
-0006cf80: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-0006cf90: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
-0006cfa0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0006cfb0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0006cfc0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0006cfd0: 645f 666c 6173 685f 6174 746e 5f62 6163  d_flash_attn_bac
-0006cfe0: 6b5f 6633 3228 7061 7261 6d73 2c20 712c  k_f32(params, q,
-0006cff0: 206b 2c20 762c 2064 2c20 6d61 736b 6564   k, v, d, masked
-0006d000: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-0006d010: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0006d020: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
-0006d030: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0006d040: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0006d050: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-0006d060: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0006d070: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
-0006d080: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-0006d090: 7277 6172 645f 6d61 705f 756e 6172 790a  rward_map_unary.
-0006d0a0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-0006d0b0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0006d0c0: 645f 6d61 705f 756e 6172 795f 6633 3228  d_map_unary_f32(
-0006d0d0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0006d0e0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0006d0f0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-0006d100: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-0006d110: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0006d120: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-0006d130: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0006d140: 5f74 656e 736f 7220 2a20 6473 742c 0a20  _tensor * dst,. 
-0006d150: 2020 2020 2020 2063 6f6e 7374 2067 676d         const ggm
-0006d160: 6c5f 756e 6172 795f 6f70 5f66 3332 5f74  l_unary_op_f32_t
-0006d170: 2066 756e 2920 7b0a 2020 2020 4747 4d4c   fun) {.    GGML
-0006d180: 5f41 5353 4552 5428 6767 6d6c 5f61 7265  _ASSERT(ggml_are
-0006d190: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
-0006d1a0: 2c20 6473 7429 293b 0a0a 2020 2020 6966  , dst));..    if
-0006d1b0: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
-0006d1c0: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
-0006d1d0: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
-0006d1e0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-0006d1f0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-0006d200: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-0006d210: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0006d220: 2020 3d20 6767 6d6c 5f6e 726f 7773 2873    = ggml_nrows(s
-0006d230: 7263 3029 3b0a 2020 2020 636f 6e73 7420  rc0);.    const 
-0006d240: 696e 7420 6e63 203d 2073 7263 302d 3e6e  int nc = src0->n
-0006d250: 655b 305d 3b0a 0a20 2020 2061 7373 6572  e[0];..    asser
-0006d260: 7428 2064 7374 2d3e 6e62 5b30 5d20 3d3d  t( dst->nb[0] ==
-0006d270: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-0006d280: 0a20 2020 2061 7373 6572 7428 7372 6330  .    assert(src0
-0006d290: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
-0006d2a0: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
-0006d2b0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0006d2c0: 6920 3c20 6e3b 2069 2b2b 2920 7b0a 2020  i < n; i++) {.  
-0006d2d0: 2020 2020 2020 6675 6e28 6e63 2c0a 2020        fun(nc,.  
-0006d2e0: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-0006d2f0: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-0006d300: 2920 6473 742d 3e64 6174 6120 202b 2069  ) dst->data  + i
-0006d310: 2a28 2064 7374 2d3e 6e62 5b31 5d29 292c  *( dst->nb[1])),
-0006d320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006d330: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-0006d340: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-0006d350: 2b20 692a 2873 7263 302d 3e6e 625b 315d  + i*(src0->nb[1]
-0006d360: 2929 293b 0a20 2020 207d 0a7d 0a0a 0a73  )));.    }.}...s
-0006d370: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0006d380: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0006d390: 6d61 705f 756e 6172 7928 0a20 2020 2020  map_unary(.     
-0006d3a0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0006d3b0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-0006d3c0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-0006d3d0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0006d3e0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0006d3f0: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
-0006d400: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0006d410: 7220 2a20 6473 742c 0a20 2020 2020 2020  r * dst,.       
-0006d420: 2063 6f6e 7374 2067 676d 6c5f 756e 6172   const ggml_unar
-0006d430: 795f 6f70 5f66 3332 5f74 2066 756e 2920  y_op_f32_t fun) 
-0006d440: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
-0006d450: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
-0006d460: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-0006d470: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
-0006d480: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0006d490: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-0006d4a0: 7465 5f66 6f72 7761 7264 5f6d 6170 5f75  te_forward_map_u
-0006d4b0: 6e61 7279 5f66 3332 2870 6172 616d 732c  nary_f32(params,
-0006d4c0: 2073 7263 302c 2064 7374 2c20 6675 6e29   src0, dst, fun)
-0006d4d0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-0006d4e0: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
-0006d4f0: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-0006d500: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0006d510: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0006d520: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-0006d530: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0006d540: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
-0006d550: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0006d560: 6d61 705f 6269 6e61 7279 0a0a 7374 6174  map_binary..stat
-0006d570: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-0006d580: 7075 7465 5f66 6f72 7761 7264 5f6d 6170  pute_forward_map
-0006d590: 5f62 696e 6172 795f 6633 3228 0a20 2020  _binary_f32(.   
-0006d5a0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0006d5b0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-0006d5c0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-0006d5d0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0006d5e0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0006d5f0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-0006d600: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0006d610: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-0006d620: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0006d630: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-0006d640: 7374 2c0a 2020 2020 2020 2020 636f 6e73  st,.        cons
-0006d650: 7420 6767 6d6c 5f62 696e 6172 795f 6f70  t ggml_binary_op
-0006d660: 5f66 3332 5f74 2066 756e 2920 7b0a 2020  _f32_t fun) {.  
-0006d670: 2020 6173 7365 7274 2870 6172 616d 732d    assert(params-
-0006d680: 3e69 7468 203d 3d20 3029 3b0a 2020 2020  >ith == 0);.    
-0006d690: 6173 7365 7274 2867 676d 6c5f 6172 655f  assert(ggml_are_
-0006d6a0: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
-0006d6b0: 2073 7263 3129 2026 2620 6767 6d6c 5f61   src1) && ggml_a
-0006d6c0: 7265 5f73 616d 655f 7368 6170 6528 7372  re_same_shape(sr
-0006d6d0: 6330 2c20 6473 7429 293b 0a0a 2020 2020  c0, dst));..    
-0006d6e0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-0006d6f0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-0006d700: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
-0006d710: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-0006d720: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-0006d730: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-0006d740: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
-0006d750: 206e 2020 3d20 6767 6d6c 5f6e 726f 7773   n  = ggml_nrows
-0006d760: 2873 7263 3029 3b0a 2020 2020 636f 6e73  (src0);.    cons
-0006d770: 7420 696e 7420 6e63 203d 2073 7263 302d  t int nc = src0-
-0006d780: 3e6e 655b 305d 3b0a 0a20 2020 2061 7373  >ne[0];..    ass
-0006d790: 6572 7428 2064 7374 2d3e 6e62 5b30 5d20  ert( dst->nb[0] 
-0006d7a0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-0006d7b0: 293b 0a20 2020 2061 7373 6572 7428 7372  );.    assert(sr
-0006d7c0: 6330 2d3e 6e62 5b30 5d20 3d3d 2073 697a  c0->nb[0] == siz
-0006d7d0: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-0006d7e0: 2061 7373 6572 7428 7372 6331 2d3e 6e62   assert(src1->nb
-0006d7f0: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
-0006d800: 6f61 7429 293b 0a0a 2020 2020 666f 7220  oat));..    for 
-0006d810: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-0006d820: 6e3b 2069 2b2b 2920 7b0a 2020 2020 2020  n; i++) {.      
-0006d830: 2020 6675 6e28 6e63 2c0a 2020 2020 2020    fun(nc,.      
-0006d840: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-0006d850: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-0006d860: 742d 3e64 6174 6120 202b 2069 2a28 2064  t->data  + i*( d
-0006d870: 7374 2d3e 6e62 5b31 5d29 292c 0a20 2020  st->nb[1])),.   
-0006d880: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-0006d890: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-0006d8a0: 2073 7263 302d 3e64 6174 6120 2b20 692a   src0->data + i*
-0006d8b0: 2873 7263 302d 3e6e 625b 315d 2929 2c0a  (src0->nb[1])),.
-0006d8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d8d0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-0006d8e0: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
-0006d8f0: 2069 2a28 7372 6331 2d3e 6e62 5b31 5d29   i*(src1->nb[1])
-0006d900: 2929 3b0a 2020 2020 7d0a 7d0a 0a0a 7374  ));.    }.}...st
-0006d910: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-0006d920: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-0006d930: 6170 5f62 696e 6172 7928 0a20 2020 2020  ap_binary(.     
-0006d940: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0006d950: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-0006d960: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-0006d970: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0006d980: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0006d990: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-0006d9a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0006d9b0: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-0006d9c0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0006d9d0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-0006d9e0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-0006d9f0: 6767 6d6c 5f62 696e 6172 795f 6f70 5f66  ggml_binary_op_f
-0006da00: 3332 5f74 2066 756e 2920 7b0a 2020 2020  32_t fun) {.    
-0006da10: 7377 6974 6368 2028 7372 6330 2d3e 7479  switch (src0->ty
-0006da20: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
-0006da30: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
-0006da40: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0006da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006da60: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-0006da70: 7761 7264 5f6d 6170 5f62 696e 6172 795f  ward_map_binary_
-0006da80: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
-0006da90: 2c20 7372 6331 2c20 6473 742c 2066 756e  , src1, dst, fun
-0006daa0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0006dab0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0006dac0: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-0006dad0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0006dae0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0006daf0: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-0006db00: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0006db10: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
-0006db20: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0006db30: 5f63 726f 7373 5f65 6e74 726f 7079 5f6c  _cross_entropy_l
-0006db40: 6f73 730a 0a73 7461 7469 6320 766f 6964  oss..static void
-0006db50: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-0006db60: 7277 6172 645f 6372 6f73 735f 656e 7472  rward_cross_entr
-0006db70: 6f70 795f 6c6f 7373 5f66 3332 280a 2020  opy_loss_f32(.  
-0006db80: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0006db90: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-0006dba0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-0006dbb0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0006dbc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0006dbd0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-0006dbe0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0006dbf0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-0006dc00: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
-0006dc10: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0006dc20: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
-0006dc30: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
-0006dc40: 6f6e 7469 6775 6f75 7328 7372 6330 2929  ontiguous(src0))
-0006dc50: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0006dc60: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-0006dc70: 756f 7573 2873 7263 3129 293b 0a20 2020  uous(src1));.   
-0006dc80: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-0006dc90: 6c5f 6973 5f73 6361 6c61 7228 6473 7429  l_is_scalar(dst)
-0006dca0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0006dcb0: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-0006dcc0: 5f73 6861 7065 2873 7263 302c 2073 7263  _shape(src0, src
-0006dcd0: 3129 293b 0a0a 2020 2020 636f 6e73 7420  1));..    const 
-0006dce0: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
-0006dcf0: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-0006dd00: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
-0006dd10: 732d 3e6e 7468 3b0a 0a20 2020 2066 6c6f  s->nth;..    flo
-0006dd20: 6174 202a 2073 756d 7320 3d20 2866 6c6f  at * sums = (flo
-0006dd30: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
-0006dd40: 6174 613b 0a0a 2020 2020 2f2f 2054 4f44  ata;..    // TOD
-0006dd50: 4f3a 2068 616e 646c 6520 7472 616e 7370  O: handle transp
-0006dd60: 6f73 6564 2f70 6572 6d75 7465 6420 6d61  osed/permuted ma
-0006dd70: 7472 6963 6573 0a20 2020 2063 6f6e 7374  trices.    const
-0006dd80: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
-0006dd90: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-0006dda0: 2069 6e74 206e 7220 3d20 6767 6d6c 5f6e   int nr = ggml_n
-0006ddb0: 726f 7773 2873 7263 3029 3b0a 0a20 2020  rows(src0);..   
-0006ddc0: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-0006ddd0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-0006dde0: 4e49 5429 207b 0a20 2020 2020 2020 2069  NIT) {.        i
-0006ddf0: 6620 2869 7468 203d 3d20 3029 207b 0a20  f (ith == 0) {. 
-0006de00: 2020 2020 2020 2020 2020 206d 656d 7365             memse
-0006de10: 7428 7375 6d73 2c20 302c 2073 697a 656f  t(sums, 0, sizeo
-0006de20: 6628 666c 6f61 7429 202a 2028 6e74 6820  f(float) * (nth 
-0006de30: 2b20 6e74 6820 2a20 6e63 2929 3b0a 2020  + nth * nc));.  
-0006de40: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0006de50: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-0006de60: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-0006de70: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0006de80: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-0006de90: 2020 2020 2069 6620 2869 7468 203d 3d20       if (ith == 
-0006dea0: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
-0006deb0: 2066 6c6f 6174 202a 2064 7020 3d20 2866   float * dp = (f
-0006dec0: 6c6f 6174 202a 2920 6473 742d 3e64 6174  loat *) dst->dat
-0006ded0: 613b 0a20 2020 2020 2020 2020 2020 2067  a;.            g
-0006dee0: 676d 6c5f 7665 635f 7375 6d5f 6633 3228  gml_vec_sum_f32(
-0006def0: 6e74 682c 2064 702c 2073 756d 7329 3b0a  nth, dp, sums);.
-0006df00: 2020 2020 2020 2020 2020 2020 6470 5b30              dp[0
-0006df10: 5d20 2a3d 202d 312e 3066 3b0a 2020 2020  ] *= -1.0f;.    
-0006df20: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
-0006df30: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-0006df40: 2063 6f6e 7374 2064 6f75 626c 6520 6570   const double ep
-0006df50: 7320 3d20 3165 2d39 3b0a 0a20 2020 202f  s = 1e-9;..    /
-0006df60: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-0006df70: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-0006df80: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-0006df90: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
-0006dfa0: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
-0006dfb0: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
-0006dfc0: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
-0006dfd0: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
-0006dfe0: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-0006dff0: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-0006e000: 2020 2066 6f72 2028 696e 7420 6931 203d     for (int i1 =
-0006e010: 2069 7230 3b20 6931 203c 2069 7231 3b20   ir0; i1 < ir1; 
-0006e020: 6931 2b2b 2920 7b0a 2020 2020 2020 2020  i1++) {.        
-0006e030: 666c 6f61 7420 2a20 7330 203d 2028 666c  float * s0 = (fl
-0006e040: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
-0006e050: 7372 6330 2d3e 6461 7461 202b 2069 312a  src0->data + i1*
-0006e060: 7372 6330 2d3e 6e62 5b31 5d29 3b0a 2020  src0->nb[1]);.  
-0006e070: 2020 2020 2020 666c 6f61 7420 2a20 7331        float * s1
-0006e080: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
-0006e090: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
-0006e0a0: 202b 2069 312a 7372 6331 2d3e 6e62 5b31   + i1*src1->nb[1
-0006e0b0: 5d29 3b0a 2020 2020 2020 2020 666c 6f61  ]);.        floa
-0006e0c0: 7420 2a20 7374 203d 2028 666c 6f61 7420  t * st = (float 
-0006e0d0: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
-0006e0e0: 202b 206e 7468 202b 2069 7468 2a6e 633b   + nth + ith*nc;
-0006e0f0: 0a0a 2369 666e 6465 6620 4e44 4542 5547  ..#ifndef NDEBUG
-0006e100: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-0006e110: 7420 6920 3d20 303b 2069 203c 206e 633b  t i = 0; i < nc;
-0006e120: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-0006e130: 2020 2020 2f2f 7072 696e 7466 2822 705b      //printf("p[
-0006e140: 2564 5d20 3d20 2566 5c6e 222c 2069 2c20  %d] = %f\n", i, 
-0006e150: 705b 695d 293b 0a20 2020 2020 2020 2020  p[i]);.         
-0006e160: 2020 2061 7373 6572 7428 2169 736e 616e     assert(!isnan
-0006e170: 2873 305b 695d 2929 3b0a 2020 2020 2020  (s0[i]));.      
-0006e180: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
-0006e190: 6e61 6e28 7331 5b69 5d29 293b 0a20 2020  nan(s1[i]));.   
-0006e1a0: 2020 2020 207d 0a23 656e 6469 660a 2020       }.#endif.  
-0006e1b0: 2020 2020 2020 2f2f 2073 6f66 745f 6d61        // soft_ma
-0006e1c0: 780a 2020 2020 2020 2020 6767 6d6c 5f66  x.        ggml_f
-0006e1d0: 6c6f 6174 2073 756d 203d 2030 2e30 3b0a  loat sum = 0.0;.
-0006e1e0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0006e1f0: 2020 2020 2020 666c 6f61 7420 6d61 7820        float max 
-0006e200: 3d20 2d49 4e46 494e 4954 593b 0a20 2020  = -INFINITY;.   
-0006e210: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0006e220: 635f 6d61 785f 6633 3228 6e63 2c20 266d  c_max_f32(nc, &m
-0006e230: 6178 2c20 7330 293b 0a0a 2020 2020 2020  ax, s0);..      
-0006e240: 2020 2020 2020 7569 6e74 3136 5f74 2073        uint16_t s
-0006e250: 6376 743b 0a20 2020 2020 2020 2020 2020  cvt;.           
-0006e260: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0006e270: 2069 203c 206e 633b 2069 2b2b 2920 7b0a   i < nc; i++) {.
-0006e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e290: 6966 2028 7330 5b69 5d20 3d3d 202d 494e  if (s0[i] == -IN
-0006e2a0: 4649 4e49 5459 2920 7b0a 2020 2020 2020  FINITY) {.      
-0006e2b0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0006e2c0: 5b69 5d20 3d20 302e 3066 3b0a 2020 2020  [i] = 0.0f;.    
-0006e2d0: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-0006e2e0: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
-0006e2f0: 2020 2020 2020 2020 202f 2f20 636f 6e73           // cons
-0006e300: 7420 666c 6f61 7420 7661 6c20 3d20 2873  t float val = (s
-0006e310: 305b 695d 203d 3d20 2d49 4e46 494e 4954  0[i] == -INFINIT
-0006e320: 5929 203f 2030 2e30 203a 2065 7870 2873  Y) ? 0.0 : exp(s
-0006e330: 305b 695d 202d 206d 6178 293b 0a20 2020  0[i] - max);.   
-0006e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e350: 2067 676d 6c5f 6670 3136 5f74 2073 203d   ggml_fp16_t s =
-0006e360: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
-0006e370: 3136 2873 305b 695d 202d 206d 6178 293b  16(s0[i] - max);
-0006e380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006e390: 2020 2020 206d 656d 6370 7928 2673 6376       memcpy(&scv
-0006e3a0: 742c 2026 732c 2073 697a 656f 6628 7363  t, &s, sizeof(sc
-0006e3b0: 7674 2929 3b0a 2020 2020 2020 2020 2020  vt));.          
-0006e3c0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0006e3d0: 666c 6f61 7420 7661 6c20 3d20 4747 4d4c  float val = GGML
-0006e3e0: 5f46 5031 365f 544f 5f46 5033 3228 7461  _FP16_TO_FP32(ta
-0006e3f0: 626c 655f 6578 705f 6631 365b 7363 7674  ble_exp_f16[scvt
-0006e400: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
-0006e410: 2020 2020 2020 2020 7375 6d20 2b3d 2028          sum += (
-0006e420: 6767 6d6c 5f66 6c6f 6174 2976 616c 3b0a  ggml_float)val;.
-0006e430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e440: 2020 2020 7374 5b69 5d20 3d20 7661 6c3b      st[i] = val;
-0006e450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006e460: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0006e470: 0a0a 2020 2020 2020 2020 2020 2020 6173  ..            as
-0006e480: 7365 7274 2873 756d 203e 2030 2e30 293b  sert(sum > 0.0);
-0006e490: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0006e4a0: 7375 6d20 3d20 312e 302f 7375 6d3b 0a20  sum = 1.0/sum;. 
-0006e4b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0006e4c0: 202f 2f20 6176 6f69 6420 6c6f 6728 3029   // avoid log(0)
-0006e4d0: 2062 7920 7265 7363 616c 696e 6720 6672   by rescaling fr
-0006e4e0: 6f6d 205b 302e 2e31 5d20 746f 205b 6570  om [0..1] to [ep
-0006e4f0: 732e 2e31 5d0a 2020 2020 2020 2020 7375  s..1].        su
-0006e500: 6d20 3d20 2831 2e30 202d 2065 7073 2920  m = (1.0 - eps) 
-0006e510: 2f20 7375 6d3b 0a20 2020 2020 2020 2067  / sum;.        g
-0006e520: 676d 6c5f 7665 635f 7363 616c 655f 6633  gml_vec_scale_f3
-0006e530: 3228 6e63 2c20 7374 2c20 7375 6d29 3b0a  2(nc, st, sum);.
-0006e540: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0006e550: 5f61 6464 315f 6633 3228 6e63 2c20 7374  _add1_f32(nc, st
-0006e560: 2c20 7374 2c20 6570 7329 3b0a 2020 2020  , st, eps);.    
-0006e570: 2020 2020 6767 6d6c 5f76 6563 5f6c 6f67      ggml_vec_log
-0006e580: 5f66 3332 286e 632c 2073 742c 2073 7429  _f32(nc, st, st)
-0006e590: 3b0a 2020 2020 2020 2020 6767 6d6c 5f76  ;.        ggml_v
-0006e5a0: 6563 5f6d 756c 5f66 3332 286e 632c 2073  ec_mul_f32(nc, s
-0006e5b0: 742c 2073 742c 2073 3129 3b0a 0a20 2020  t, st, s1);..   
-0006e5c0: 2020 2020 2067 676d 6c5f 7665 635f 7375       ggml_vec_su
-0006e5d0: 6d5f 6633 3228 6e63 2c20 7375 6d73 202b  m_f32(nc, sums +
-0006e5e0: 2069 7468 2c20 7374 293b 0a0a 2369 666e   ith, st);..#ifn
-0006e5f0: 6465 6620 4e44 4542 5547 0a20 2020 2020  def NDEBUG.     
-0006e600: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-0006e610: 303b 2069 203c 206e 633b 202b 2b69 2920  0; i < nc; ++i) 
-0006e620: 7b0a 2020 2020 2020 2020 2020 2020 6173  {.            as
-0006e630: 7365 7274 2821 6973 6e61 6e28 7374 5b69  sert(!isnan(st[i
-0006e640: 5d29 293b 0a20 2020 2020 2020 2020 2020  ]));.           
-0006e650: 2061 7373 6572 7428 2169 7369 6e66 2873   assert(!isinf(s
-0006e660: 745b 695d 2929 3b0a 2020 2020 2020 2020  t[i]));.        
-0006e670: 7d0a 2365 6e64 6966 0a20 2020 207d 0a0a  }.#endif.    }..
-0006e680: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-0006e690: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-0006e6a0: 6172 645f 6372 6f73 735f 656e 7472 6f70  ard_cross_entrop
-0006e6b0: 795f 6c6f 7373 280a 2020 2020 2020 2020  y_loss(.        
-0006e6c0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0006e6d0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-0006e6e0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-0006e6f0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0006e700: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-0006e710: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-0006e720: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0006e730: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-0006e740: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0006e750: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-0006e760: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-0006e770: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-0006e780: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0006e790: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-0006e7a0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0006e7b0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-0006e7c0: 655f 666f 7277 6172 645f 6372 6f73 735f  e_forward_cross_
-0006e7d0: 656e 7472 6f70 795f 6c6f 7373 5f66 3332  entropy_loss_f32
-0006e7e0: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
-0006e7f0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
-0006e800: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0006e810: 2020 2020 2020 2020 6465 6661 756c 743a          default:
-0006e820: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0006e830: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-0006e840: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-0006e850: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0006e860: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-0006e870: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
-0006e880: 5f66 6f72 7761 7264 5f63 726f 7373 5f65  _forward_cross_e
-0006e890: 6e74 726f 7079 5f6c 6f73 735f 6261 636b  ntropy_loss_back
-0006e8a0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-0006e8b0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0006e8c0: 7264 5f63 726f 7373 5f65 6e74 726f 7079  rd_cross_entropy
-0006e8d0: 5f6c 6f73 735f 6261 636b 5f66 3332 280a  _loss_back_f32(.
-0006e8e0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0006e8f0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-0006e900: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-0006e910: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-0006e920: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0006e930: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-0006e940: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0006e950: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-0006e960: 7263 312c 0a20 2020 2020 2020 2063 6f6e  rc1,.        con
-0006e970: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-0006e980: 656e 736f 7220 2a20 6f70 7430 2c0a 2020  ensor * opt0,.  
-0006e990: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0006e9a0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-0006e9b0: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-0006e9c0: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-0006e9d0: 756f 7573 2864 7374 2929 3b0a 2020 2020  uous(dst));.    
-0006e9e0: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-0006e9f0: 5f69 735f 636f 6e74 6967 756f 7573 2873  _is_contiguous(s
-0006ea00: 7263 3029 293b 0a20 2020 2047 474d 4c5f  rc0));.    GGML_
-0006ea10: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
-0006ea20: 6f6e 7469 6775 6f75 7328 7372 6331 2929  ontiguous(src1))
-0006ea30: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0006ea40: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-0006ea50: 756f 7573 286f 7074 3029 293b 0a20 2020  uous(opt0));.   
-0006ea60: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-0006ea70: 6c5f 6172 655f 7361 6d65 5f73 6861 7065  l_are_same_shape
-0006ea80: 2873 7263 302c 2073 7263 3129 2026 2620  (src0, src1) && 
-0006ea90: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
-0006eaa0: 6170 6528 7372 6330 2c20 6473 7429 293b  ape(src0, dst));
-0006eab0: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-0006eac0: 345f 7420 6974 6820 3d20 7061 7261 6d73  4_t ith = params
-0006ead0: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-0006eae0: 2069 6e74 3634 5f74 206e 7468 203d 2070   int64_t nth = p
-0006eaf0: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
-0006eb00: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-0006eb10: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-0006eb20: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
-0006eb30: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0006eb40: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-0006eb50: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-0006eb60: 207d 0a0a 2020 2020 636f 6e73 7420 666c   }..    const fl
-0006eb70: 6f61 7420 6570 7320 3d20 3165 2d39 663b  oat eps = 1e-9f;
-0006eb80: 0a0a 2020 2020 2f2f 2054 4f44 4f3a 2068  ..    // TODO: h
-0006eb90: 616e 646c 6520 7472 616e 7370 6f73 6564  andle transposed
-0006eba0: 2f70 6572 6d75 7465 6420 6d61 7472 6963  /permuted matric
-0006ebb0: 6573 0a20 2020 2063 6f6e 7374 2069 6e74  es.    const int
-0006ebc0: 3634 5f74 206e 6320 3d20 7372 6330 2d3e  64_t nc = src0->
-0006ebd0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-0006ebe0: 2069 6e74 3634 5f74 206e 7220 3d20 6767   int64_t nr = gg
-0006ebf0: 6d6c 5f6e 726f 7773 2873 7263 3029 3b0a  ml_nrows(src0);.
-0006ec00: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
-0006ec10: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-0006ec20: 7420 696e 7436 345f 7420 6472 203d 2028  t int64_t dr = (
-0006ec30: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
-0006ec40: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
-0006ec50: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
-0006ec60: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-0006ec70: 6e74 3634 5f74 2069 7230 203d 2064 722a  nt64_t ir0 = dr*
-0006ec80: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-0006ec90: 6e74 3634 5f74 2069 7231 203d 204d 494e  nt64_t ir1 = MIN
-0006eca0: 2869 7230 202b 2064 722c 206e 7229 3b0a  (ir0 + dr, nr);.
-0006ecb0: 0a20 2020 2066 6c6f 6174 202a 2064 2020  .    float * d  
-0006ecc0: 203d 2028 666c 6f61 7420 2a29 206f 7074   = (float *) opt
-0006ecd0: 302d 3e64 6174 613b 0a0a 2020 2020 666f  0->data;..    fo
-0006ece0: 7220 2869 6e74 3634 5f74 2069 3120 3d20  r (int64_t i1 = 
-0006ecf0: 6972 303b 2069 3120 3c20 6972 313b 2069  ir0; i1 < ir1; i
-0006ed00: 312b 2b29 207b 0a20 2020 2020 2020 2066  1++) {.        f
-0006ed10: 6c6f 6174 202a 2064 7330 203d 2028 666c  loat * ds0 = (fl
-0006ed20: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
-0006ed30: 6473 742d 3e64 6174 6120 202b 2069 312a  dst->data  + i1*
-0006ed40: 6473 742d 3e6e 625b 315d 293b 0a20 2020  dst->nb[1]);.   
-0006ed50: 2020 2020 2066 6c6f 6174 202a 2073 3020       float * s0 
-0006ed60: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
-0006ed70: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-0006ed80: 202b 2069 312a 7372 6330 2d3e 6e62 5b31   + i1*src0->nb[1
-0006ed90: 5d29 3b0a 2020 2020 2020 2020 666c 6f61  ]);.        floa
-0006eda0: 7420 2a20 7331 2020 3d20 2866 6c6f 6174  t * s1  = (float
-0006edb0: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
-0006edc0: 312d 3e64 6174 6120 2b20 6931 2a73 7263  1->data + i1*src
-0006edd0: 312d 3e6e 625b 315d 293b 0a20 2020 2020  1->nb[1]);.     
-0006ede0: 2020 2066 6c6f 6174 202a 2073 6d20 203d     float * sm  =
-0006edf0: 2028 666c 6f61 7420 2a29 2070 6172 616d   (float *) param
-0006ee00: 732d 3e77 6461 7461 202b 2069 7468 2a6e  s->wdata + ith*n
-0006ee10: 633b 0a0a 2369 666e 6465 6620 4e44 4542  c;..#ifndef NDEB
-0006ee20: 5547 0a20 2020 2020 2020 2066 6f72 2028  UG.        for (
-0006ee30: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-0006ee40: 633b 202b 2b69 2920 7b0a 2020 2020 2020  c; ++i) {.      
-0006ee50: 2020 2020 2020 2f2f 7072 696e 7466 2822        //printf("
-0006ee60: 705b 2564 5d20 3d20 2566 5c6e 222c 2069  p[%d] = %f\n", i
-0006ee70: 2c20 705b 695d 293b 0a20 2020 2020 2020  , p[i]);.       
-0006ee80: 2020 2020 2061 7373 6572 7428 2169 736e       assert(!isn
-0006ee90: 616e 2873 305b 695d 2929 3b0a 2020 2020  an(s0[i]));.    
-0006eea0: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
-0006eeb0: 6973 6e61 6e28 7331 5b69 5d29 293b 0a20  isnan(s1[i]));. 
-0006eec0: 2020 2020 2020 207d 0a23 656e 6469 660a         }.#endif.
-0006eed0: 2020 2020 2020 2020 2f2f 2073 7465 7020          // step 
-0006eee0: 6279 2073 7465 7020 6578 706c 616e 6174  by step explanat
-0006eef0: 696f 6e3a 0a20 2020 2020 2020 207b 0a20  ion:.        {. 
-0006ef00: 2020 2020 2020 2020 2020 202f 2f66 6c6f             //flo
-0006ef10: 6174 202a 2073 756d 7320 3d20 2866 6c6f  at * sums = (flo
-0006ef20: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
-0006ef30: 6174 613b 0a0a 2020 2020 2020 2020 2020  ata;..          
-0006ef40: 2020 2f2f 2066 6f72 7761 7264 2070 6173    // forward pas
-0006ef50: 7320 7769 7468 2061 6e6e 6f74 6174 6564  s with annotated
-0006ef60: 2067 7261 6469 656e 7473 2066 726f 6d20   gradients from 
-0006ef70: 6261 636b 7761 7264 2070 6173 730a 2020  backward pass.  
-0006ef80: 2020 2020 2020 2020 2020 2f2f 2028 6275            // (bu
-0006ef90: 696c 7420 6279 2067 6f69 6e67 2069 6e20  ilt by going in 
-0006efa0: 7265 7665 7273 6520 6f70 6572 6174 696f  reverse operatio
-0006efb0: 6e20 6f72 6465 722c 2061 6464 696e 6720  n order, adding 
-0006efc0: 746f 2067 7261 6469 656e 7473 206f 6620  to gradients of 
-0006efd0: 6375 7272 656e 7420 6f70 6572 6174 696f  current operatio
-0006efe0: 6e20 6172 6773 290a 2020 2020 2020 2020  n args).        
-0006eff0: 2020 2020 2f2f 2073 7430 203d 2065 7870      // st0 = exp
-0006f000: 2873 302d 6d61 7828 7330 2929 2020 2020  (s0-max(s0))    
-0006f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006acb0: 2020 2020 2020 5357 5b6a 5d20 3d20 7661        SW[j] = va
+0006acc0: 6c3b 0a20 2020 2020 2020 2020 2020 2020  l;.             
+0006acd0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0006ace0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006acf0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0006ad00: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0006ad10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0006ad20: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0006ad30: 203d 2030 3b20 6920 3c20 4747 4d4c 5f53   = 0; i < GGML_S
+0006ad40: 4f46 545f 4d41 585f 554e 524f 4c4c 3b20  OFT_MAX_UNROLL; 
+0006ad50: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
+0006ad60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0006ad70: 756d 202b 3d20 7375 6d70 5b69 5d3b 0a20  um += sump[i];. 
+0006ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ad90: 2020 207d 0a23 656e 6469 660a 2020 2020     }.#endif.    
+0006ada0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0006adb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0006adc0: 7373 6572 7428 7375 6d20 3e20 302e 3029  ssert(sum > 0.0)
+0006add0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0006ade0: 2020 2073 756d 203d 2031 2e30 2f73 756d     sum = 1.0/sum
+0006adf0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006ae00: 2020 6767 6d6c 5f76 6563 5f73 6361 6c65    ggml_vec_scale
+0006ae10: 5f66 3332 284d 2c20 534d 2c20 7375 6d29  _f32(M, SM, sum)
+0006ae20: 3b0a 0a20 2020 2020 2020 2020 2020 207d  ;..            }
+0006ae30: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
+0006ae40: 2073 7465 702d 6279 2d73 7465 7020 6578   step-by-step ex
+0006ae50: 706c 616e 6174 696f 6e0a 2020 2020 2020  planation.      
+0006ae60: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0006ae70: 2020 2020 2020 2020 2f2f 2066 6f72 7761          // forwa
+0006ae80: 7264 2d70 726f 6365 7373 2020 2020 2020  rd-process      
+0006ae90: 2020 2020 2020 2020 2020 2020 2073 6861               sha
+0006aea0: 7065 2020 2020 2020 6772 6164 7320 6672  pe      grads fr
+0006aeb0: 6f6d 2062 6163 6b77 6172 6420 7072 6f63  om backward proc
+0006aec0: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
+0006aed0: 2020 2020 2f2f 2070 6172 616c 6c65 6c5f      // parallel_
+0006aee0: 666f 7220 6971 322c 6971 333a 0a20 2020  for iq2,iq3:.   
+0006aef0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0006af00: 206b 5b3a 442c 3a4d 2c3a 2c3a 5d20 2020   k[:D,:M,:,:]   
+0006af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006af20: 2020 5b44 2c4d 2c3a 2c3a 5d20 2067 7261    [D,M,:,:]  gra
+0006af30: 645b 6b5d 5b3a 442c 3a4d 2c69 7132 2c69  d[k][:D,:M,iq2,i
+0006af40: 7133 5d20 202b 3d20 6772 6164 5b6b 6375  q3]  += grad[kcu
+0006af50: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
+0006af60: 2020 202f 2f20 2071 5b3a 442c 3a4e 2c3a     //  q[:D,:N,:
+0006af70: 2c3a 5d20 2020 2020 2020 2020 2020 2020  ,:]             
+0006af80: 2020 2020 2020 2020 5b44 2c4e 2c3a 2c3a          [D,N,:,:
+0006af90: 5d20 2067 7261 645b 715d 5b3a 442c 6971  ]  grad[q][:D,iq
+0006afa0: 312c 6971 322c 6971 335d 202b 3d20 6772  1,iq2,iq3] += gr
+0006afb0: 6164 5b71 6375 725d 0a20 2020 2020 2020  ad[qcur].       
+0006afc0: 2020 2020 2020 2020 202f 2f20 2076 5b3a           //  v[:
+0006afd0: 4d2c 3a44 2c3a 2c3a 5d20 2020 2020 2020  M,:D,:,:]       
+0006afe0: 2020 2020 2020 2020 2020 2020 2020 5b4d                [M
+0006aff0: 2c44 2c3a 2c3a 5d20 2067 7261 645b 765d  ,D,:,:]  grad[v]
+0006b000: 5b3a 4d2c 3a44 2c69 7132 2c69 7133 5d20  [:M,:D,iq2,iq3] 
+0006b010: 202b 3d20 6772 6164 5b76 6375 725d 0a20   += grad[vcur]. 
+0006b020: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006b030: 2f20 2066 6f72 2069 7131 3a0a 2020 2020  /  for iq1:.    
+0006b040: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
+0006b050: 206b 6375 7220 2020 3d20 6b5b 3a44 2c3a   kcur   = k[:D,:
+0006b060: 4d2c 6971 322c 6971 335d 2020 2020 2020  M,iq2,iq3]      
+0006b070: 205b 442c 4d2c 312c 315d 2020 6772 6164   [D,M,1,1]  grad
+0006b080: 5b6b 6375 725d 203d 2067 7261 645b 5331  [kcur] = grad[S1
+0006b090: 5d2e 5420 4020 7163 7572 0a20 2020 2020  ].T @ qcur.     
+0006b0a0: 2020 2020 2020 2020 2020 202f 2f20 2020             //   
+0006b0b0: 7163 7572 2020 203d 2071 5b3a 442c 6971  qcur   = q[:D,iq
+0006b0c0: 312c 6971 322c 6971 335d 2020 2020 2020  1,iq2,iq3]      
+0006b0d0: 5b44 2c31 2c31 2c31 5d20 2067 7261 645b  [D,1,1,1]  grad[
+0006b0e0: 7163 7572 5d20 3d20 6772 6164 5b53 315d  qcur] = grad[S1]
+0006b0f0: 2020 2040 206b 6375 720a 2020 2020 2020     @ kcur.      
+0006b100: 2020 2020 2020 2020 2020 2f2f 2020 2076            //   v
+0006b110: 6375 7220 2020 3d20 765b 3a4d 2c3a 442c  cur   = v[:M,:D,
+0006b120: 6971 322c 6971 335d 2020 2020 2020 205b  iq2,iq3]       [
+0006b130: 4d2c 442c 312c 315d 2020 6772 6164 5b76  M,D,1,1]  grad[v
+0006b140: 6375 725d 203d 2067 7261 645b 5335 5d2e  cur] = grad[S5].
+0006b150: 5420 4020 5334 0a20 2020 2020 2020 2020  T @ S4.         
+0006b160: 2020 2020 2020 202f 2f20 2020 5330 2020         //   S0  
+0006b170: 2020 203d 202d 496e 6620 2020 2020 2020     = -Inf       
+0006b180: 2020 2020 2020 2020 2020 2020 5b44 2c31              [D,1
+0006b190: 2c31 2c31 5d0a 2020 2020 2020 2020 2020  ,1,1].          
+0006b1a0: 2020 2020 2020 2f2f 2020 7e53 315b 695d        //  ~S1[i]
+0006b1b0: 2020 3d20 646f 7428 6b63 7572 5b3a 442c    = dot(kcur[:D,
+0006b1c0: 695d 2c20 7163 7572 290a 2020 2020 2020  i], qcur).      
+0006b1d0: 2020 2020 2020 2020 2020 2f2f 2020 2053            //   S
+0006b1e0: 3120 2020 2020 3d20 7163 7572 2040 206b  1     = qcur @ k
+0006b1f0: 6375 722e 5420 2020 2020 2020 2020 205b  cur.T          [
+0006b200: 4d2c 312c 312c 315d 2020 6772 6164 5b53  M,1,1,1]  grad[S
+0006b210: 315d 2020 203d 2067 7261 645b 5332 5d20  1]   = grad[S2] 
+0006b220: 2a20 7363 616c 650a 2020 2020 2020 2020  * scale.        
+0006b230: 2020 2020 2020 2020 2f2f 2020 2053 3220          //   S2 
+0006b240: 2020 2020 3d20 5331 202a 2073 6361 6c65      = S1 * scale
+0006b250: 2020 2020 2020 2020 2020 2020 205b 4d2c               [M,
+0006b260: 312c 312c 315d 2020 6772 6164 5b53 325d  1,1,1]  grad[S2]
+0006b270: 2020 203d 2064 6961 675f 6d61 736b 5f7a     = diag_mask_z
+0006b280: 6572 6f28 6772 6164 5b53 335d 2c20 5029  ero(grad[S3], P)
+0006b290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b2a0: 202f 2f20 2020 5333 2020 2020 203d 2064   //   S3     = d
+0006b2b0: 6961 675f 6d61 736b 5f69 6e66 2853 322c  iag_mask_inf(S2,
+0006b2c0: 2050 2920 2020 5b4d 2c31 2c31 2c31 5d20   P)   [M,1,1,1] 
+0006b2d0: 2067 7261 645b 5333 5d20 2020 3d20 5334   grad[S3]   = S4
+0006b2e0: 202a 2028 6772 6164 5b53 345d 202d 2064   * (grad[S4] - d
+0006b2f0: 6f74 2853 342c 2067 7261 645b 5334 5d29  ot(S4, grad[S4])
+0006b300: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0006b310: 2020 2f2f 2020 2053 3420 2020 2020 3d20    //   S4     = 
+0006b320: 736f 6674 6d61 7828 5333 2920 2020 2020  softmax(S3)     
+0006b330: 2020 2020 2020 205b 4d2c 312c 312c 315d         [M,1,1,1]
+0006b340: 2020 6772 6164 5b53 345d 2020 203d 2067    grad[S4]   = g
+0006b350: 7261 645b 5335 5d20 4020 7663 7572 0a20  rad[S5] @ vcur. 
+0006b360: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006b370: 2f20 207e 5335 5b69 5d20 203d 2064 6f74  /  ~S5[i]  = dot
+0006b380: 2876 6375 725b 3a2c 695d 2c20 5334 290a  (vcur[:,i], S4).
+0006b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b3a0: 2f2f 2020 2053 3520 2020 2020 3d20 5334  //   S5     = S4
+0006b3b0: 2040 2076 6375 722e 5420 2020 2020 2020   @ vcur.T       
+0006b3c0: 2020 2020 205b 442c 312c 312c 315d 2020       [D,1,1,1]  
+0006b3d0: 6772 6164 5b53 355d 2020 203d 2064 5b3a  grad[S5]   = d[:
+0006b3e0: 442c 6971 312c 6971 322c 6971 335d 0a20  D,iq1,iq2,iq3]. 
+0006b3f0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006b400: 2f20 207e 6473 745b 692c 6971 312c 6971  /  ~dst[i,iq1,iq
+0006b410: 322c 6971 335d 2020 3d20 5335 5b69 5d20  2,iq3]  = S5[i] 
+0006b420: 2020 2020 2020 2020 2020 2020 205e 0a20               ^. 
+0006b430: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006b440: 2f20 2020 6473 745b 3a44 2c69 7131 2c69  /   dst[:D,iq1,i
+0006b450: 7132 2c69 7133 5d20 3d20 5335 2020 2020  q2,iq3] = S5    
+0006b460: 2020 2020 2020 2020 2020 2020 207c 2067               | g
+0006b470: 7261 645b 6473 745b 3a44 2c69 7131 2c69  rad[dst[:D,iq1,i
+0006b480: 7132 2c69 7133 5d5d 203d 2064 5b3a 442c  q2,iq3]] = d[:D,
+0006b490: 6971 312c 6971 322c 6971 335d 0a20 2020  iq1,iq2,iq3].   
+0006b4a0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0006b4b0: 6473 7420 2020 2020 2020 2020 2020 2020  dst             
+0006b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b4d0: 2020 6261 636b 7761 7264 2d2f 2067 7261    backward-/ gra
+0006b4e0: 645b 6473 745d 2020 2020 2020 2020 2020  d[dst]          
+0006b4f0: 2020 2020 2020 203d 2064 0a20 2020 2020         = d.     
+0006b500: 2020 2020 2020 2020 2020 202f 2f0a 2020             //.  
+0006b510: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006b520: 206f 7574 7075 7420 6772 6164 6965 6e74   output gradient
+0006b530: 7320 7769 7468 2074 6865 6972 2064 6570  s with their dep
+0006b540: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+0006b550: 2020 2020 2020 2020 2020 202f 2f0a 2020             //.  
+0006b560: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006b570: 2067 7261 645b 6b63 7572 5d20 3d20 6772   grad[kcur] = gr
+0006b580: 6164 5b53 315d 2e54 2040 2071 6375 720a  ad[S1].T @ qcur.
+0006b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b5a0: 2f2f 2067 7261 645b 5331 5d20 2020 3d20  // grad[S1]   = 
+0006b5b0: 6469 6167 5f6d 6173 6b5f 7a65 726f 2867  diag_mask_zero(g
+0006b5c0: 7261 645b 5333 5d2c 2050 2920 2a20 7363  rad[S3], P) * sc
+0006b5d0: 616c 650a 2020 2020 2020 2020 2020 2020  ale.            
+0006b5e0: 2020 2020 2f2f 2067 7261 645b 5333 5d20      // grad[S3] 
+0006b5f0: 2020 3d20 5334 202a 2028 6772 6164 5b53    = S4 * (grad[S
+0006b600: 345d 202d 2064 6f74 2853 342c 2067 7261  4] - dot(S4, gra
+0006b610: 645b 5334 5d29 290a 2020 2020 2020 2020  d[S4])).        
+0006b620: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+0006b630: 5334 5d20 2020 3d20 6772 6164 5b53 355d  S4]   = grad[S5]
+0006b640: 2040 2076 6375 720a 2020 2020 2020 2020   @ vcur.        
+0006b650: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+0006b660: 5334 5d20 2020 3d20 645b 3a44 2c69 7131  S4]   = d[:D,iq1
+0006b670: 2c69 7132 2c69 7133 5d20 4020 7663 7572  ,iq2,iq3] @ vcur
+0006b680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b690: 202f 2f20 6772 6164 5b71 6375 725d 203d   // grad[qcur] =
+0006b6a0: 2067 7261 645b 5331 5d20 2020 4020 6b63   grad[S1]   @ kc
+0006b6b0: 7572 0a20 2020 2020 2020 2020 2020 2020  ur.             
+0006b6c0: 2020 202f 2f20 6772 6164 5b76 6375 725d     // grad[vcur]
+0006b6d0: 203d 2067 7261 645b 5335 5d2e 5420 4020   = grad[S5].T @ 
+0006b6e0: 5334 0a20 2020 2020 2020 2020 2020 2020  S4.             
+0006b6f0: 2020 202f 2f20 6772 6164 5b76 6375 725d     // grad[vcur]
+0006b700: 203d 2064 5b3a 442c 6971 312c 6971 322c   = d[:D,iq1,iq2,
+0006b710: 6971 335d 2e54 2040 2053 340a 2020 2020  iq3].T @ S4.    
+0006b720: 2020 2020 2020 2020 2020 2020 2f2f 0a20              //. 
+0006b730: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006b740: 2f20 696e 2070 6f73 742d 6f72 6465 723a  / in post-order:
+0006b750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b760: 202f 2f0a 2020 2020 2020 2020 2020 2020   //.            
+0006b770: 2020 2020 2f2f 2053 3120 2020 2020 2020      // S1       
+0006b780: 2020 3d20 7163 7572 2040 206b 6375 722e    = qcur @ kcur.
+0006b790: 540a 2020 2020 2020 2020 2020 2020 2020  T.              
+0006b7a0: 2020 2f2f 2053 3220 2020 2020 2020 2020    // S2         
+0006b7b0: 3d20 5331 202a 2073 6361 6c65 0a20 2020  = S1 * scale.   
+0006b7c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0006b7d0: 5333 2020 2020 2020 2020 203d 2064 6961  S3         = dia
+0006b7e0: 675f 6d61 736b 5f69 6e66 2853 322c 2050  g_mask_inf(S2, P
+0006b7f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0006b800: 2020 2f2f 2053 3420 2020 2020 2020 2020    // S4         
+0006b810: 3d20 736f 6674 6d61 7828 5333 290a 2020  = softmax(S3).  
+0006b820: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006b830: 2067 7261 645b 5334 5d20 2020 3d20 645b   grad[S4]   = d[
+0006b840: 3a44 2c69 7131 2c69 7132 2c69 7133 5d20  :D,iq1,iq2,iq3] 
+0006b850: 4020 7663 7572 0a20 2020 2020 2020 2020  @ vcur.         
+0006b860: 2020 2020 2020 202f 2f20 6772 6164 5b53         // grad[S
+0006b870: 335d 2020 203d 2053 3420 2a20 2867 7261  3]   = S4 * (gra
+0006b880: 645b 5334 5d20 2d20 646f 7428 5334 2c20  d[S4] - dot(S4, 
+0006b890: 6772 6164 5b53 345d 2929 0a20 2020 2020  grad[S4])).     
+0006b8a0: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
+0006b8b0: 6164 5b53 315d 2020 203d 2064 6961 675f  ad[S1]   = diag_
+0006b8c0: 6d61 736b 5f7a 6572 6f28 6772 6164 5b53  mask_zero(grad[S
+0006b8d0: 335d 2c20 5029 202a 2073 6361 6c65 0a20  3], P) * scale. 
+0006b8e0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006b8f0: 2f20 6772 6164 5b71 6375 725d 203d 2067  / grad[qcur] = g
+0006b900: 7261 645b 5331 5d20 2020 4020 6b63 7572  rad[S1]   @ kcur
+0006b910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b920: 202f 2f20 6772 6164 5b6b 6375 725d 203d   // grad[kcur] =
+0006b930: 2067 7261 645b 5331 5d2e 5420 4020 7163   grad[S1].T @ qc
+0006b940: 7572 0a20 2020 2020 2020 2020 2020 2020  ur.             
+0006b950: 2020 202f 2f20 6772 6164 5b76 6375 725d     // grad[vcur]
+0006b960: 203d 2064 5b3a 442c 6971 312c 6971 322c   = d[:D,iq1,iq2,
+0006b970: 6971 335d 2e54 2040 2053 340a 2020 2020  iq3].T @ S4.    
+0006b980: 2020 2020 2020 2020 2020 2020 2f2f 0a20              //. 
+0006b990: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006b9a0: 2f20 7573 696e 6720 6c65 7373 2076 6172  / using less var
+0006b9b0: 6961 626c 6573 2028 534d 3d53 3429 3a0a  iables (SM=S4):.
+0006b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b9d0: 2f2f 0a20 2020 2020 2020 2020 2020 2020  //.             
+0006b9e0: 2020 202f 2f20 5320 2020 2020 2020 2020     // S         
+0006b9f0: 2020 2020 3d20 6469 6167 5f6d 6173 6b5f      = diag_mask_
+0006ba00: 696e 6628 7163 7572 2040 206b 6375 722e  inf(qcur @ kcur.
+0006ba10: 5420 2a20 7363 616c 652c 2050 290a 2020  T * scale, P).  
+0006ba20: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006ba30: 2053 4d20 2020 2020 2020 2020 2020 203d   SM            =
+0006ba40: 2073 6f66 746d 6178 2853 290a 2020 2020   softmax(S).    
+0006ba50: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
+0006ba60: 2020 2020 2020 2020 2020 2020 203d 2064               = d
+0006ba70: 5b3a 442c 6971 312c 6971 322c 6971 335d  [:D,iq1,iq2,iq3]
+0006ba80: 2040 2076 6375 720a 2020 2020 2020 2020   @ vcur.        
+0006ba90: 2020 2020 2020 2020 2f2f 2064 6f74 5f53          // dot_S
+0006baa0: 4d5f 6772 6164 534d 203d 2064 6f74 2853  M_gradSM = dot(S
+0006bab0: 4d2c 2053 290a 2020 2020 2020 2020 2020  M, S).          
+0006bac0: 2020 2020 2020 2f2f 2053 2020 2020 2020        // S      
+0006bad0: 2020 2020 2020 203d 2053 4d20 2a20 2853         = SM * (S
+0006bae0: 202d 2064 6f74 2853 4d2c 2053 2929 0a20   - dot(SM, S)). 
+0006baf0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006bb00: 2f20 5320 2020 2020 2020 2020 2020 2020  / S             
+0006bb10: 3d20 6469 6167 5f6d 6173 6b5f 7a65 726f  = diag_mask_zero
+0006bb20: 2853 2c20 5029 202a 2073 6361 6c65 0a20  (S, P) * scale. 
+0006bb30: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006bb40: 2f0a 2020 2020 2020 2020 2020 2020 2020  /.              
+0006bb50: 2020 2f2f 2067 7261 645b 715d 5b3a 442c    // grad[q][:D,
+0006bb60: 6971 312c 6971 322c 6971 335d 202b 3d20  iq1,iq2,iq3] += 
+0006bb70: 5320 2020 4020 6b63 7572 0a20 2020 2020  S   @ kcur.     
+0006bb80: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
+0006bb90: 6164 5b6b 5d5b 3a44 2c3a 4d2c 6971 322c  ad[k][:D,:M,iq2,
+0006bba0: 6971 335d 2020 2b3d 2053 2e54 2040 2071  iq3]  += S.T @ q
+0006bbb0: 6375 720a 2020 2020 2020 2020 2020 2020  cur.            
+0006bbc0: 2020 2020 2f2f 2067 7261 645b 765d 5b3a      // grad[v][:
+0006bbd0: 4d2c 3a44 2c69 7132 2c69 7133 5d20 202b  M,:D,iq2,iq3]  +
+0006bbe0: 3d20 645b 3a44 2c69 7131 2c69 7132 2c69  = d[:D,iq1,iq2,i
+0006bbf0: 7133 5d2e 5420 4020 534d 0a20 2020 2020  q3].T @ SM.     
+0006bc00: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0006bc10: 2020 2020 2020 2f2f 2053 203d 2067 7261        // S = gra
+0006bc20: 6453 4d20 3d20 645b 3a44 2c69 7131 2c69  dSM = d[:D,iq1,i
+0006bc30: 7132 2c69 7133 5d20 4020 7663 7572 0a20  q2,iq3] @ vcur. 
+0006bc40: 2020 2020 2020 2020 2020 202f 2f20 5320             // S 
+0006bc50: 3d20 645b 3a44 2c69 7131 2c69 7132 2c69  = d[:D,iq1,iq2,i
+0006bc60: 7133 5d20 4020 7663 7572 0a20 2020 2020  q3] @ vcur.     
+0006bc70: 2020 2020 2020 202f 2f20 535b 3a4d 5d20         // S[:M] 
+0006bc80: 2b3d 2076 6375 725b 3a4d 2c69 635d 202a  += vcur[:M,ic] *
+0006bc90: 2064 5b69 632c 6971 312c 6971 322c 6971   d[ic,iq1,iq2,iq
+0006bca0: 335d 0a20 2020 2020 2020 2020 2020 2067  3].            g
+0006bcb0: 676d 6c5f 7665 635f 7365 745f 6633 3228  gml_vec_set_f32(
+0006bcc0: 4d2c 2053 2c20 3029 3b0a 2020 2020 2020  M, S, 0);.      
+0006bcd0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0006bce0: 5f74 2069 6320 3d20 303b 2069 6320 3c20  _t ic = 0; ic < 
+0006bcf0: 443b 202b 2b69 6329 207b 0a20 2020 2020  D; ++ic) {.     
+0006bd00: 2020 2020 2020 2020 2020 202f 2f20 6473             // ds
+0006bd10: 7420 696e 6469 6365 730a 2020 2020 2020  t indices.      
+0006bd20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0006bd30: 696e 7420 6931 203d 2069 7131 3b0a 2020  int i1 = iq1;.  
+0006bd40: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0006bd50: 6e73 7420 696e 7420 6932 203d 2069 7132  nst int i2 = iq2
+0006bd60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006bd70: 2020 636f 6e73 7420 696e 7420 6933 203d    const int i3 =
+0006bd80: 2069 7133 3b0a 0a20 2020 2020 2020 2020   iq3;..         
+0006bd90: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0006bda0: 6d61 645f 6633 3228 4d2c 0a20 2020 2020  mad_f32(M,.     
+0006bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006bdc0: 2020 2053 2c0a 2020 2020 2020 2020 2020     S,.          
+0006bdd0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0006bde0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+0006bdf0: 2a29 2076 2d3e 6461 7461 202b 2028 2020  *) v->data + (  
+0006be00: 2020 2020 2020 2020 6963 2a6e 6276 3120          ic*nbv1 
+0006be10: 2b20 6932 2a6e 6276 3220 2b20 6933 2a6e  + i2*nbv2 + i3*n
+0006be20: 6276 3329 292c 0a20 2020 2020 2020 2020  bv3)),.         
+0006be30: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+0006be40: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+0006be50: 202a 2920 642d 3e64 6174 6120 2b20 2869   *) d->data + (i
+0006be60: 632a 6e62 6430 202b 2069 312a 6e62 6431  c*nbd0 + i1*nbd1
+0006be70: 202b 2069 322a 6e62 6432 202b 2069 332a   + i2*nbd2 + i3*
+0006be80: 6e62 6433 2929 293b 0a20 2020 2020 2020  nbd3)));.       
+0006be90: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0006bea0: 2020 2020 2f2f 2053 203d 2053 4d20 2a20      // S = SM * 
+0006beb0: 2853 202d 2064 6f74 2853 4d2c 2053 2929  (S - dot(SM, S))
+0006bec0: 0a20 2020 2020 2020 2020 2020 2066 6c6f  .            flo
+0006bed0: 6174 2064 6f74 5f53 4d5f 6772 6164 534d  at dot_SM_gradSM
+0006bee0: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+0006bef0: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
+0006bf00: 3332 2028 4d2c 2026 646f 745f 534d 5f67  32 (M, &dot_SM_g
+0006bf10: 7261 6453 4d2c 2053 4d2c 2053 293b 0a20  radSM, SM, S);. 
+0006bf20: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0006bf30: 7665 635f 6163 6331 5f66 3332 284d 2c20  vec_acc1_f32(M, 
+0006bf40: 532c 202d 646f 745f 534d 5f67 7261 6453  S, -dot_SM_gradS
+0006bf50: 4d29 3b0a 2020 2020 2020 2020 2020 2020  M);.            
+0006bf60: 6767 6d6c 5f76 6563 5f6d 756c 5f66 3332  ggml_vec_mul_f32
+0006bf70: 2028 4d2c 2053 2c20 532c 2053 4d29 3b0a   (M, S, S, SM);.
+0006bf80: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0006bf90: 5320 3d20 6469 6167 5f6d 6173 6b5f 7a65  S = diag_mask_ze
+0006bfa0: 726f 2853 2c20 5029 202a 2073 6361 6c65  ro(S, P) * scale
+0006bfb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0006bfc0: 286d 6173 6b65 6429 207b 0a20 2020 2020  (masked) {.     
+0006bfd0: 2020 2020 2020 2020 2020 202f 2f20 666f             // fo
+0006bfe0: 7220 2869 6e74 3634 5f74 2069 203d 2050  r (int64_t i = P
+0006bff0: 202b 2069 7131 202b 2031 3b20 6920 3c20   + iq1 + 1; i < 
+0006c000: 4d3b 2069 2b2b 2920 7b0a 2020 2020 2020  M; i++) {.      
+0006c010: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
+0006c020: 2053 5b69 5d20 3d20 303b 0a20 2020 2020   S[i] = 0;.     
+0006c030: 2020 2020 2020 2020 2020 202f 2f20 7d0a             // }.
+0006c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c050: 666f 7220 2869 6e74 3634 5f74 2069 203d  for (int64_t i =
+0006c060: 2050 3b20 6920 3c20 4d3b 2069 2b2b 2920   P; i < M; i++) 
+0006c070: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006c080: 2020 2020 2020 6966 2028 6920 3e20 5020        if (i > P 
+0006c090: 2b20 6971 3129 207b 0a20 2020 2020 2020  + iq1) {.       
+0006c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c0b0: 2053 5b69 5d20 3d20 303b 0a20 2020 2020   S[i] = 0;.     
+0006c0c0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0006c0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006c0e0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0006c0f0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0006c100: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
+0006c110: 4d2c 2053 2c20 7363 616c 6529 3b0a 0a20  M, S, scale);.. 
+0006c120: 2020 2020 2020 2020 2020 2076 6f69 6420             void 
+0006c130: 2a20 6772 6164 5f71 203d 2028 6368 6172  * grad_q = (char
+0006c140: 202a 2920 6473 742d 3e64 6174 613b 0a20   *) dst->data;. 
+0006c150: 2020 2020 2020 2020 2020 2076 6f69 6420             void 
+0006c160: 2a20 6772 6164 5f6b 203d 2028 6368 6172  * grad_k = (char
+0006c170: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
+0006c180: 6e62 302a 442a 4e2a 6e65 7132 2a6e 6571  nb0*D*N*neq2*neq
+0006c190: 333b 0a20 2020 2020 2020 2020 2020 2076  3;.            v
+0006c1a0: 6f69 6420 2a20 6772 6164 5f76 203d 2028  oid * grad_v = (
+0006c1b0: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+0006c1c0: 6120 2b20 6e62 302a 442a 4e2a 6e65 7132  a + nb0*D*N*neq2
+0006c1d0: 2a6e 6571 3320 2b20 6e62 302a 442a 4d2a  *neq3 + nb0*D*M*
+0006c1e0: 6e65 7132 2a6e 6571 333b 0a0a 2020 2020  neq2*neq3;..    
+0006c1f0: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+0006c200: 7a65 5f74 206e 6267 7131 203d 206e 6230  ze_t nbgq1 = nb0
+0006c210: 2a6e 6571 303b 0a20 2020 2020 2020 2020  *neq0;.         
+0006c220: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0006c230: 6e62 6771 3220 3d20 6e62 302a 6e65 7130  nbgq2 = nb0*neq0
+0006c240: 2a6e 6571 313b 0a20 2020 2020 2020 2020  *neq1;.         
+0006c250: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0006c260: 6e62 6771 3320 3d20 6e62 302a 6e65 7130  nbgq3 = nb0*neq0
+0006c270: 2a6e 6571 312a 6e65 7132 3b0a 0a20 2020  *neq1*neq2;..   
+0006c280: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
+0006c290: 697a 655f 7420 6e62 676b 3120 3d20 6e62  ize_t nbgk1 = nb
+0006c2a0: 302a 6e65 6b30 3b0a 2020 2020 2020 2020  0*nek0;.        
+0006c2b0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0006c2c0: 206e 6267 6b32 203d 206e 6230 2a6e 656b   nbgk2 = nb0*nek
+0006c2d0: 302a 6e65 6b31 3b0a 2020 2020 2020 2020  0*nek1;.        
+0006c2e0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+0006c2f0: 206e 6267 6b33 203d 206e 6230 2a6e 656b   nbgk3 = nb0*nek
+0006c300: 302a 6e65 6b31 2a6e 6571 323b 0a0a 2020  0*nek1*neq2;..  
+0006c310: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0006c320: 7369 7a65 5f74 206e 6267 7631 203d 206e  size_t nbgv1 = n
+0006c330: 6230 2a6e 6576 303b 0a20 2020 2020 2020  b0*nev0;.       
+0006c340: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+0006c350: 7420 6e62 6776 3220 3d20 6e62 302a 6e65  t nbgv2 = nb0*ne
+0006c360: 7630 2a6e 6576 313b 0a20 2020 2020 2020  v0*nev1;.       
+0006c370: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+0006c380: 7420 6e62 6776 3320 3d20 6e62 302a 6e65  t nbgv3 = nb0*ne
+0006c390: 7630 2a6e 6576 312a 6e65 7132 3b0a 0a20  v0*nev1*neq2;.. 
+0006c3a0: 2020 2020 2020 2020 2020 202f 2f20 5320             // S 
+0006c3b0: 2020 2073 6861 7065 205b 4d2c 315d 0a20     shape [M,1]. 
+0006c3c0: 2020 2020 2020 2020 2020 202f 2f20 534d             // SM
+0006c3d0: 2020 2073 6861 7065 205b 4d2c 315d 0a20     shape [M,1]. 
+0006c3e0: 2020 2020 2020 2020 2020 202f 2f20 6b63             // kc
+0006c3f0: 7572 2073 6861 7065 205b 442c 4d5d 0a20  ur shape [D,M]. 
+0006c400: 2020 2020 2020 2020 2020 202f 2f20 7163             // qc
+0006c410: 7572 2073 6861 7065 205b 442c 315d 0a20  ur shape [D,1]. 
+0006c420: 2020 2020 2020 2020 2020 202f 2f20 7663             // vc
+0006c430: 7572 2073 6861 7065 205b 4d2c 445d 0a20  ur shape [M,D]. 
+0006c440: 2020 2020 2020 2020 2020 202f 2f0a 2020             //.  
+0006c450: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
+0006c460: 645b 715d 5b3a 442c 6971 312c 6971 322c  d[q][:D,iq1,iq2,
+0006c470: 6971 335d 202b 3d20 5320 4020 6b63 7572  iq3] += S @ kcur
+0006c480: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0006c490: 6772 6164 5b71 5d5b 3a44 2c69 7131 2c69  grad[q][:D,iq1,i
+0006c4a0: 7132 2c69 7133 5d20 2b3d 2073 6861 7065  q2,iq3] += shape
+0006c4b0: 5b4d 2c31 5d20 4020 7368 6170 655b 442c  [M,1] @ shape[D,
+0006c4c0: 4d5d 0a20 2020 2020 2020 2020 2020 202f  M].            /
+0006c4d0: 2f20 6772 6164 5b71 5d5b 3a44 2c69 7131  / grad[q][:D,iq1
+0006c4e0: 2c69 7132 2c69 7133 5d20 2b3d 2053 5b69  ,iq2,iq3] += S[i
+0006c4f0: 635d 202a 206b 6375 725b 3a44 2c69 635d  c] * kcur[:D,ic]
+0006c500: 0a20 2020 2020 2020 2020 2020 202f 2f0a  .            //.
+0006c510: 2020 2020 2020 2020 2020 2020 2f2f 2f2f              ////
+0006c520: 2067 7261 645b 715d 5b69 632c 6971 312c   grad[q][ic,iq1,
+0006c530: 6971 322c 6971 335d 202b 3d20 646f 7428  iq2,iq3] += dot(
+0006c540: 6b63 7572 5b3a 2c69 635d 2c53 2e54 290a  kcur[:,ic],S.T).
+0006c550: 2020 2020 2020 2020 2020 2020 2f2f 2f2f              ////
+0006c560: 2067 7261 645b 715d 5b69 632c 6971 312c   grad[q][ic,iq1,
+0006c570: 6971 322c 6971 335d 202b 3d20 646f 7428  iq2,iq3] += dot(
+0006c580: 6b5b 3a44 2c69 632c 6971 322c 6971 335d  k[:D,ic,iq2,iq3]
+0006c590: 2c53 2e54 290a 2020 2020 2020 2020 2020  ,S.T).          
+0006c5a0: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0006c5b0: 6320 3d20 303b 2069 6320 3c20 4d3b 202b  c = 0; ic < M; +
+0006c5c0: 2b69 6329 207b 0a20 2020 2020 2020 2020  +ic) {.         
+0006c5d0: 2020 2020 2020 202f 2f20 6473 7420 696e         // dst in
+0006c5e0: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
+0006c5f0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0006c600: 6931 203d 2069 7131 3b0a 2020 2020 2020  i1 = iq1;.      
+0006c610: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0006c620: 696e 7420 6932 203d 2069 7132 3b0a 2020  int i2 = iq2;.  
+0006c630: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0006c640: 6e73 7420 696e 7420 6933 203d 2069 7133  nst int i3 = iq3
+0006c650: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0006c660: 2020 2067 676d 6c5f 7665 635f 6d61 645f     ggml_vec_mad_
+0006c670: 6633 3228 442c 0a20 2020 2020 2020 2020  f32(D,.         
+0006c680: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0006c690: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+0006c6a0: 2a29 2067 7261 645f 7120 202b 2028 6931  *) grad_q  + (i1
+0006c6b0: 2a6e 6267 7131 2020 2b20 6932 2a6e 6267  *nbgq1  + i2*nbg
+0006c6c0: 7132 2020 2b20 6933 2a6e 6267 7133 2929  q2  + i3*nbgq3))
+0006c6d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006c6e0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+0006c6f0: 202a 2920 2828 6368 6172 202a 2920 6b2d   *) ((char *) k-
+0006c700: 3e64 6174 6120 2b20 2869 632a 6e62 6b31  >data + (ic*nbk1
+0006c710: 2020 202b 2069 322a 6e62 6b32 2020 202b     + i2*nbk2   +
+0006c720: 2069 332a 6e62 6b33 2929 2c0a 2020 2020   i3*nbk3)),.    
+0006c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c740: 2020 2020 535b 6963 5d29 3b0a 2020 2020      S[ic]);.    
+0006c750: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0006c760: 2020 2020 2020 202f 2f20 6772 6164 5b6b         // grad[k
+0006c770: 5d5b 3a44 2c3a 4d2c 6971 322c 6971 335d  ][:D,:M,iq2,iq3]
+0006c780: 202b 3d20 532e 5420 2020 2020 2020 4020   += S.T       @ 
+0006c790: 7163 7572 0a20 2020 2020 2020 2020 2020  qcur.           
+0006c7a0: 202f 2f20 6772 6164 5b6b 5d5b 3a44 2c69   // grad[k][:D,i
+0006c7b0: 632c 6971 322c 6971 335d 202b 3d20 532e  c,iq2,iq3] += S.
+0006c7c0: 545b 302c 6963 5d20 2a20 7163 7572 5b3a  T[0,ic] * qcur[:
+0006c7d0: 442c 305d 0a20 2020 2020 2020 2020 2020  D,0].           
+0006c7e0: 202f 2f20 6772 6164 5b6b 5d5b 3a44 2c69   // grad[k][:D,i
+0006c7f0: 632c 6971 322c 6971 335d 202b 3d20 535b  c,iq2,iq3] += S[
+0006c800: 6963 5d20 2020 2020 2a20 7163 7572 5b3a  ic]     * qcur[:
+0006c810: 442c 305d 0a20 2020 2020 2020 2020 2020  D,0].           
+0006c820: 2066 6f72 2028 696e 7436 345f 7420 6963   for (int64_t ic
+0006c830: 203d 2030 3b20 6963 203c 204d 3b20 2b2b   = 0; ic < M; ++
+0006c840: 6963 2920 7b0a 2020 2020 2020 2020 2020  ic) {.          
+0006c850: 2020 2020 2020 2f2f 2064 7374 2069 6e64        // dst ind
+0006c860: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
+0006c870: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0006c880: 3120 3d20 6971 313b 0a20 2020 2020 2020  1 = iq1;.       
+0006c890: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+0006c8a0: 6e74 2069 3220 3d20 6971 323b 0a20 2020  nt i2 = iq2;.   
+0006c8b0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0006c8c0: 7374 2069 6e74 2069 3320 3d20 6971 333b  st int i3 = iq3;
+0006c8d0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0006c8e0: 2020 2f2f 2067 676d 6c5f 7665 635f 7365    // ggml_vec_se
+0006c8f0: 745f 6633 3228 442c 0a20 2020 2020 2020  t_f32(D,.       
+0006c900: 2020 2020 2020 2020 202f 2f20 2020 2020           //     
+0006c910: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+0006c920: 6368 6172 202a 2920 6772 6164 5f6b 2020  char *) grad_k  
+0006c930: 2b20 2869 632a 6e62 676b 3120 202b 2069  + (ic*nbgk1  + i
+0006c940: 322a 6e62 676b 3220 202b 2069 332a 6e62  2*nbgk2  + i3*nb
+0006c950: 676b 3329 292c 0a20 2020 2020 2020 2020  gk3)),.         
+0006c960: 2020 2020 2020 202f 2f20 2020 2020 2020         //       
+0006c970: 2020 3029 3b0a 2020 2020 2020 2020 2020    0);.          
+0006c980: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
+0006c990: 6164 5f66 3332 2844 2c0a 2020 2020 2020  ad_f32(D,.      
+0006c9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c9b0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+0006c9c0: 6172 202a 2920 6772 6164 5f6b 2020 2b20  ar *) grad_k  + 
+0006c9d0: 2869 632a 6e62 676b 3120 202b 2069 322a  (ic*nbgk1  + i2*
+0006c9e0: 6e62 676b 3220 202b 2069 332a 6e62 676b  nbgk2  + i3*nbgk
+0006c9f0: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
+0006ca00: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+0006ca10: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+0006ca20: 2071 2d3e 6461 7461 202b 2028 6931 2a6e   q->data + (i1*n
+0006ca30: 6271 3120 2020 2b20 6932 2a6e 6271 3220  bq1   + i2*nbq2 
+0006ca40: 2020 2b20 6933 2a6e 6271 3329 292c 0a20    + i3*nbq3)),. 
+0006ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ca60: 2020 2020 2020 2053 5b69 635d 293b 0a20         S[ic]);. 
+0006ca70: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+0006ca80: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
+0006ca90: 645b 765d 5b3a 4d2c 3a44 2c69 7132 2c69  d[v][:M,:D,iq2,i
+0006caa0: 7133 5d20 2b3d 2064 5b3a 442c 6971 312c  q3] += d[:D,iq1,
+0006cab0: 6971 322c 6971 335d 2e54 2020 2020 2020  iq2,iq3].T      
+0006cac0: 2040 2053 4d0a 2020 2020 2020 2020 2020   @ SM.          
+0006cad0: 2020 2f2f 2067 7261 645b 765d 5b3a 4d2c    // grad[v][:M,
+0006cae0: 6963 2c69 7132 2c69 7133 5d20 2b3d 2064  ic,iq2,iq3] += d
+0006caf0: 5b3a 442c 6971 312c 6971 322c 6971 335d  [:D,iq1,iq2,iq3]
+0006cb00: 2e54 5b30 2c69 635d 202a 2053 4d5b 3a4d  .T[0,ic] * SM[:M
+0006cb10: 5d0a 2020 2020 2020 2020 2020 2020 2f2f  ].            //
+0006cb20: 2067 7261 645b 765d 5b3a 4d2c 6963 2c69   grad[v][:M,ic,i
+0006cb30: 7132 2c69 7133 5d20 2b3d 2064 5b69 632c  q2,iq3] += d[ic,
+0006cb40: 6971 312c 6971 322c 6971 335d 2020 2020  iq1,iq2,iq3]    
+0006cb50: 2020 2020 202a 2053 4d5b 3a4d 5d0a 2020       * SM[:M].  
+0006cb60: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0006cb70: 6e74 3634 5f74 2069 6320 3d20 303b 2069  nt64_t ic = 0; i
+0006cb80: 6320 3c20 443b 202b 2b69 6329 207b 0a20  c < D; ++ic) {. 
+0006cb90: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006cba0: 2f20 6473 7420 696e 6469 6365 730a 2020  / dst indices.  
+0006cbb0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0006cbc0: 6e73 7420 696e 7420 6931 203d 2069 7131  nst int i1 = iq1
+0006cbd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006cbe0: 2020 636f 6e73 7420 696e 7420 6932 203d    const int i2 =
+0006cbf0: 2069 7132 3b0a 2020 2020 2020 2020 2020   iq2;.          
+0006cc00: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0006cc10: 6933 203d 2069 7133 3b0a 0a20 2020 2020  i3 = iq3;..     
+0006cc20: 2020 2020 2020 2020 2020 202f 2f20 6767             // gg
+0006cc30: 6d6c 5f76 6563 5f73 6574 5f66 3332 284d  ml_vec_set_f32(M
+0006cc40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006cc50: 2020 2f2f 2020 2020 2020 2020 2028 666c    //         (fl
+0006cc60: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+0006cc70: 2067 7261 645f 7620 2020 2b20 2820 2020   grad_v   + (   
+0006cc80: 2020 2020 2020 2069 632a 6e62 6776 3120         ic*nbgv1 
+0006cc90: 2b20 6932 2a6e 6267 7632 202b 2069 332a  + i2*nbgv2 + i3*
+0006cca0: 6e62 6776 3329 292c 0a20 2020 2020 2020  nbgv3)),.       
+0006ccb0: 2020 2020 2020 2020 202f 2f20 2020 2020           //     
+0006ccc0: 2020 2020 3029 3b0a 2020 2020 2020 2020      0);.        
+0006ccd0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0006cce0: 5f6d 6164 5f66 3332 284d 2c0a 2020 2020  _mad_f32(M,.    
+0006ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cd00: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+0006cd10: 6368 6172 202a 2920 6772 6164 5f76 2020  char *) grad_v  
+0006cd20: 202b 2028 2020 2020 2020 2020 2020 6963   + (          ic
+0006cd30: 2a6e 6267 7631 202b 2069 322a 6e62 6776  *nbgv1 + i2*nbgv
+0006cd40: 3220 2b20 6933 2a6e 6267 7633 2929 2c0a  2 + i3*nbgv3)),.
+0006cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cd60: 2020 2020 2020 2020 534d 2c0a 2020 2020          SM,.    
+0006cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cd80: 2020 2020 2a28 666c 6f61 7420 2a29 2028      *(float *) (
+0006cd90: 2863 6861 7220 2a29 2064 2d3e 6461 7461  (char *) d->data
+0006cda0: 202b 2028 6963 2a6e 6264 3020 2b20 6931   + (ic*nbd0 + i1
+0006cdb0: 2a6e 6264 3120 202b 2069 322a 6e62 6432  *nbd1  + i2*nbd2
+0006cdc0: 2020 2b20 6933 2a6e 6264 3329 2929 3b0a    + i3*nbd3)));.
+0006cdd0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0006cde0: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
+0006cdf0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+0006ce00: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0006ce10: 645f 666c 6173 685f 6174 746e 5f62 6163  d_flash_attn_bac
+0006ce20: 6b28 0a20 2020 2020 2020 2063 6f6e 7374  k(.        const
+0006ce30: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+0006ce40: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+0006ce50: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+0006ce60: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0006ce70: 7465 6e73 6f72 202a 2071 2c0a 2020 2020  tensor * q,.    
+0006ce80: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0006ce90: 2067 676d 6c5f 7465 6e73 6f72 202a 206b   ggml_tensor * k
+0006cea0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0006ceb0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0006cec0: 6f72 202a 2076 2c0a 2020 2020 2020 2020  or * v,.        
+0006ced0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0006cee0: 6c5f 7465 6e73 6f72 202a 2064 2c0a 2020  l_tensor * d,.  
+0006cef0: 2020 2020 2020 636f 6e73 7420 626f 6f6c        const bool
+0006cf00: 206d 6173 6b65 642c 0a20 2020 2020 2020   masked,.       
+0006cf10: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0006cf20: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+0006cf30: 2073 7769 7463 6820 2871 2d3e 7479 7065   switch (q->type
+0006cf40: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+0006cf50: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
+0006cf60: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0006cf70: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006cf80: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0006cf90: 7264 5f66 6c61 7368 5f61 7474 6e5f 6261  rd_flash_attn_ba
+0006cfa0: 636b 5f66 3332 2870 6172 616d 732c 2071  ck_f32(params, q
+0006cfb0: 2c20 6b2c 2076 2c20 642c 206d 6173 6b65  , k, v, d, maske
+0006cfc0: 642c 2064 7374 293b 0a20 2020 2020 2020  d, dst);.       
+0006cfd0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0006cfe0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+0006cff0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0006d000: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+0006d010: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+0006d020: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0006d030: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
+0006d040: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+0006d050: 6f72 7761 7264 5f6d 6170 5f75 6e61 7279  orward_map_unary
+0006d060: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+0006d070: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0006d080: 7264 5f6d 6170 5f75 6e61 7279 5f66 3332  rd_map_unary_f32
+0006d090: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0006d0a0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0006d0b0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0006d0c0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0006d0d0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0006d0e0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0006d0f0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0006d100: 6c5f 7465 6e73 6f72 202a 2064 7374 2c0a  l_tensor * dst,.
+0006d110: 2020 2020 2020 2020 636f 6e73 7420 6767          const gg
+0006d120: 6d6c 5f75 6e61 7279 5f6f 705f 6633 325f  ml_unary_op_f32_
+0006d130: 7420 6675 6e29 207b 0a20 2020 2047 474d  t fun) {.    GGM
+0006d140: 4c5f 4153 5345 5254 2867 676d 6c5f 6172  L_ASSERT(ggml_ar
+0006d150: 655f 7361 6d65 5f73 6861 7065 2873 7263  e_same_shape(src
+0006d160: 302c 2064 7374 2929 3b0a 0a20 2020 2069  0, dst));..    i
+0006d170: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+0006d180: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+0006d190: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
+0006d1a0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+0006d1b0: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+0006d1c0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+0006d1d0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0006d1e0: 6e20 203d 2067 676d 6c5f 6e72 6f77 7328  n  = ggml_nrows(
+0006d1f0: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
+0006d200: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
+0006d210: 6e65 5b30 5d3b 0a0a 2020 2020 6173 7365  ne[0];..    asse
+0006d220: 7274 2820 6473 742d 3e6e 625b 305d 203d  rt( dst->nb[0] =
+0006d230: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
+0006d240: 3b0a 2020 2020 6173 7365 7274 2873 7263  ;.    assert(src
+0006d250: 302d 3e6e 625b 305d 203d 3d20 7369 7a65  0->nb[0] == size
+0006d260: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
+0006d270: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0006d280: 2069 203c 206e 3b20 692b 2b29 207b 0a20   i < n; i++) {. 
+0006d290: 2020 2020 2020 2066 756e 286e 632c 0a20         fun(nc,. 
+0006d2a0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0006d2b0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+0006d2c0: 2a29 2064 7374 2d3e 6461 7461 2020 2b20  *) dst->data  + 
+0006d2d0: 692a 2820 6473 742d 3e6e 625b 315d 2929  i*( dst->nb[1]))
+0006d2e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006d2f0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+0006d300: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+0006d310: 202b 2069 2a28 7372 6330 2d3e 6e62 5b31   + i*(src0->nb[1
+0006d320: 5d29 2929 3b0a 2020 2020 7d0a 7d0a 0a0a  ])));.    }.}...
+0006d330: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+0006d340: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0006d350: 5f6d 6170 5f75 6e61 7279 280a 2020 2020  _map_unary(.    
+0006d360: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0006d370: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+0006d380: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+0006d390: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0006d3a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0006d3b0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+0006d3c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0006d3d0: 6f72 202a 2064 7374 2c0a 2020 2020 2020  or * dst,.      
+0006d3e0: 2020 636f 6e73 7420 6767 6d6c 5f75 6e61    const ggml_una
+0006d3f0: 7279 5f6f 705f 6633 325f 7420 6675 6e29  ry_op_f32_t fun)
+0006d400: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
+0006d410: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
+0006d420: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0006d430: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+0006d440: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0006d450: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+0006d460: 7574 655f 666f 7277 6172 645f 6d61 705f  ute_forward_map_
+0006d470: 756e 6172 795f 6633 3228 7061 7261 6d73  unary_f32(params
+0006d480: 2c20 7372 6330 2c20 6473 742c 2066 756e  , src0, dst, fun
+0006d490: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+0006d4a0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0006d4b0: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+0006d4c0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0006d4d0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+0006d4e0: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+0006d4f0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0006d500: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
+0006d510: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0006d520: 5f6d 6170 5f62 696e 6172 790a 0a73 7461  _map_binary..sta
+0006d530: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+0006d540: 6d70 7574 655f 666f 7277 6172 645f 6d61  mpute_forward_ma
+0006d550: 705f 6269 6e61 7279 5f66 3332 280a 2020  p_binary_f32(.  
+0006d560: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0006d570: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+0006d580: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+0006d590: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0006d5a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0006d5b0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+0006d5c0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0006d5d0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+0006d5e0: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
+0006d5f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0006d600: 6473 742c 0a20 2020 2020 2020 2063 6f6e  dst,.        con
+0006d610: 7374 2067 676d 6c5f 6269 6e61 7279 5f6f  st ggml_binary_o
+0006d620: 705f 6633 325f 7420 6675 6e29 207b 0a20  p_f32_t fun) {. 
+0006d630: 2020 2061 7373 6572 7428 7061 7261 6d73     assert(params
+0006d640: 2d3e 6974 6820 3d3d 2030 293b 0a20 2020  ->ith == 0);.   
+0006d650: 2061 7373 6572 7428 6767 6d6c 5f61 7265   assert(ggml_are
+0006d660: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
+0006d670: 2c20 7372 6331 2920 2626 2067 676d 6c5f  , src1) && ggml_
+0006d680: 6172 655f 7361 6d65 5f73 6861 7065 2873  are_same_shape(s
+0006d690: 7263 302c 2064 7374 2929 3b0a 0a20 2020  rc0, dst));..   
+0006d6a0: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+0006d6b0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+0006d6c0: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
+0006d6d0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+0006d6e0: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
+0006d6f0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+0006d700: 207d 0a0a 2020 2020 636f 6e73 7420 696e   }..    const in
+0006d710: 7420 6e20 203d 2067 676d 6c5f 6e72 6f77  t n  = ggml_nrow
+0006d720: 7328 7372 6330 293b 0a20 2020 2063 6f6e  s(src0);.    con
+0006d730: 7374 2069 6e74 206e 6320 3d20 7372 6330  st int nc = src0
+0006d740: 2d3e 6e65 5b30 5d3b 0a0a 2020 2020 6173  ->ne[0];..    as
+0006d750: 7365 7274 2820 6473 742d 3e6e 625b 305d  sert( dst->nb[0]
+0006d760: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
+0006d770: 2929 3b0a 2020 2020 6173 7365 7274 2873  ));.    assert(s
+0006d780: 7263 302d 3e6e 625b 305d 203d 3d20 7369  rc0->nb[0] == si
+0006d790: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
+0006d7a0: 2020 6173 7365 7274 2873 7263 312d 3e6e    assert(src1->n
+0006d7b0: 625b 305d 203d 3d20 7369 7a65 6f66 2866  b[0] == sizeof(f
+0006d7c0: 6c6f 6174 2929 3b0a 0a20 2020 2066 6f72  loat));..    for
+0006d7d0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+0006d7e0: 206e 3b20 692b 2b29 207b 0a20 2020 2020   n; i++) {.     
+0006d7f0: 2020 2066 756e 286e 632c 0a20 2020 2020     fun(nc,.     
+0006d800: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+0006d810: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
+0006d820: 7374 2d3e 6461 7461 2020 2b20 692a 2820  st->data  + i*( 
+0006d830: 6473 742d 3e6e 625b 315d 2929 2c0a 2020  dst->nb[1])),.  
+0006d840: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+0006d850: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+0006d860: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
+0006d870: 2a28 7372 6330 2d3e 6e62 5b31 5d29 292c  *(src0->nb[1])),
+0006d880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006d890: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+0006d8a0: 7220 2a29 2073 7263 312d 3e64 6174 6120  r *) src1->data 
+0006d8b0: 2b20 692a 2873 7263 312d 3e6e 625b 315d  + i*(src1->nb[1]
+0006d8c0: 2929 293b 0a20 2020 207d 0a7d 0a0a 0a73  )));.    }.}...s
+0006d8d0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+0006d8e0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0006d8f0: 6d61 705f 6269 6e61 7279 280a 2020 2020  map_binary(.    
+0006d900: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0006d910: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+0006d920: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+0006d930: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0006d940: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0006d950: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+0006d960: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0006d970: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+0006d980: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0006d990: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+0006d9a0: 742c 0a20 2020 2020 2020 2063 6f6e 7374  t,.        const
+0006d9b0: 2067 676d 6c5f 6269 6e61 7279 5f6f 705f   ggml_binary_op_
+0006d9c0: 6633 325f 7420 6675 6e29 207b 0a20 2020  f32_t fun) {.   
+0006d9d0: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
+0006d9e0: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
+0006d9f0: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
+0006da00: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
+0006da10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006da20: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+0006da30: 7277 6172 645f 6d61 705f 6269 6e61 7279  rward_map_binary
+0006da40: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
+0006da50: 302c 2073 7263 312c 2064 7374 2c20 6675  0, src1, dst, fu
+0006da60: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
+0006da70: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0006da80: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
+0006da90: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0006daa0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0006dab0: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+0006dac0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0006dad0: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
+0006dae0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0006daf0: 645f 6372 6f73 735f 656e 7472 6f70 795f  d_cross_entropy_
+0006db00: 6c6f 7373 0a0a 7374 6174 6963 2076 6f69  loss..static voi
+0006db10: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+0006db20: 6f72 7761 7264 5f63 726f 7373 5f65 6e74  orward_cross_ent
+0006db30: 726f 7079 5f6c 6f73 735f 6633 3228 0a20  ropy_loss_f32(. 
+0006db40: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0006db50: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+0006db60: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+0006db70: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0006db80: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0006db90: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+0006dba0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0006dbb0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+0006dbc0: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+0006dbd0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0006dbe0: 2064 7374 2920 7b0a 2020 2020 4747 4d4c   dst) {.    GGML
+0006dbf0: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
+0006dc00: 636f 6e74 6967 756f 7573 2873 7263 3029  contiguous(src0)
+0006dc10: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0006dc20: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
+0006dc30: 6775 6f75 7328 7372 6331 2929 3b0a 2020  guous(src1));.  
+0006dc40: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0006dc50: 6d6c 5f69 735f 7363 616c 6172 2864 7374  ml_is_scalar(dst
+0006dc60: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+0006dc70: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
+0006dc80: 655f 7368 6170 6528 7372 6330 2c20 7372  e_shape(src0, sr
+0006dc90: 6331 2929 3b0a 0a20 2020 2063 6f6e 7374  c1));..    const
+0006dca0: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
+0006dcb0: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
+0006dcc0: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
+0006dcd0: 6d73 2d3e 6e74 683b 0a0a 2020 2020 666c  ms->nth;..    fl
+0006dce0: 6f61 7420 2a20 7375 6d73 203d 2028 666c  oat * sums = (fl
+0006dcf0: 6f61 7420 2a29 2070 6172 616d 732d 3e77  oat *) params->w
+0006dd00: 6461 7461 3b0a 0a20 2020 202f 2f20 544f  data;..    // TO
+0006dd10: 444f 3a20 6861 6e64 6c65 2074 7261 6e73  DO: handle trans
+0006dd20: 706f 7365 642f 7065 726d 7574 6564 206d  posed/permuted m
+0006dd30: 6174 7269 6365 730a 2020 2020 636f 6e73  atrices.    cons
+0006dd40: 7420 696e 7420 6e63 203d 2073 7263 302d  t int nc = src0-
+0006dd50: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+0006dd60: 7420 696e 7420 6e72 203d 2067 676d 6c5f  t int nr = ggml_
+0006dd70: 6e72 6f77 7328 7372 6330 293b 0a0a 2020  nrows(src0);..  
+0006dd80: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+0006dd90: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+0006dda0: 494e 4954 2920 7b0a 2020 2020 2020 2020  INIT) {.        
+0006ddb0: 6966 2028 6974 6820 3d3d 2030 2920 7b0a  if (ith == 0) {.
+0006ddc0: 2020 2020 2020 2020 2020 2020 6d65 6d73              mems
+0006ddd0: 6574 2873 756d 732c 2030 2c20 7369 7a65  et(sums, 0, size
+0006dde0: 6f66 2866 6c6f 6174 2920 2a20 286e 7468  of(float) * (nth
+0006ddf0: 202b 206e 7468 202a 206e 6329 293b 0a20   + nth * nc));. 
+0006de00: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0006de10: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+0006de20: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+0006de30: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+0006de40: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+0006de50: 2020 2020 2020 6966 2028 6974 6820 3d3d        if (ith ==
+0006de60: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
+0006de70: 2020 666c 6f61 7420 2a20 6470 203d 2028    float * dp = (
+0006de80: 666c 6f61 7420 2a29 2064 7374 2d3e 6461  float *) dst->da
+0006de90: 7461 3b0a 2020 2020 2020 2020 2020 2020  ta;.            
+0006dea0: 6767 6d6c 5f76 6563 5f73 756d 5f66 3332  ggml_vec_sum_f32
+0006deb0: 286e 7468 2c20 6470 2c20 7375 6d73 293b  (nth, dp, sums);
+0006dec0: 0a20 2020 2020 2020 2020 2020 2064 705b  .            dp[
+0006ded0: 305d 202a 3d20 2d31 2e30 663b 0a20 2020  0] *= -1.0f;.   
+0006dee0: 2020 2020 207d 0a20 2020 2020 2020 2072       }.        r
+0006def0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0006df00: 2020 636f 6e73 7420 646f 7562 6c65 2065    const double e
+0006df10: 7073 203d 2031 652d 393b 0a0a 2020 2020  ps = 1e-9;..    
+0006df20: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
+0006df30: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+0006df40: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
+0006df50: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
+0006df60: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
+0006df70: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
+0006df80: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
+0006df90: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
+0006dfa0: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
+0006dfb0: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
+0006dfc0: 2020 2020 666f 7220 2869 6e74 2069 3120      for (int i1 
+0006dfd0: 3d20 6972 303b 2069 3120 3c20 6972 313b  = ir0; i1 < ir1;
+0006dfe0: 2069 312b 2b29 207b 0a20 2020 2020 2020   i1++) {.       
+0006dff0: 2066 6c6f 6174 202a 2073 3020 3d20 2866   float * s0 = (f
+0006e000: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+0006e010: 2073 7263 302d 3e64 6174 6120 2b20 6931   src0->data + i1
+0006e020: 2a73 7263 302d 3e6e 625b 315d 293b 0a20  *src0->nb[1]);. 
+0006e030: 2020 2020 2020 2066 6c6f 6174 202a 2073         float * s
+0006e040: 3120 3d20 2866 6c6f 6174 202a 2928 2863  1 = (float *)((c
+0006e050: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
+0006e060: 6120 2b20 6931 2a73 7263 312d 3e6e 625b  a + i1*src1->nb[
+0006e070: 315d 293b 0a20 2020 2020 2020 2066 6c6f  1]);.        flo
+0006e080: 6174 202a 2073 7420 3d20 2866 6c6f 6174  at * st = (float
+0006e090: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+0006e0a0: 6120 2b20 6e74 6820 2b20 6974 682a 6e63  a + nth + ith*nc
+0006e0b0: 3b0a 0a23 6966 6e64 6566 204e 4445 4255  ;..#ifndef NDEBU
+0006e0c0: 470a 2020 2020 2020 2020 666f 7220 2869  G.        for (i
+0006e0d0: 6e74 2069 203d 2030 3b20 6920 3c20 6e63  nt i = 0; i < nc
+0006e0e0: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
+0006e0f0: 2020 2020 202f 2f70 7269 6e74 6628 2270       //printf("p
+0006e100: 5b25 645d 203d 2025 665c 6e22 2c20 692c  [%d] = %f\n", i,
+0006e110: 2070 5b69 5d29 3b0a 2020 2020 2020 2020   p[i]);.        
+0006e120: 2020 2020 6173 7365 7274 2821 6973 6e61      assert(!isna
+0006e130: 6e28 7330 5b69 5d29 293b 0a20 2020 2020  n(s0[i]));.     
+0006e140: 2020 2020 2020 2061 7373 6572 7428 2169         assert(!i
+0006e150: 736e 616e 2873 315b 695d 2929 3b0a 2020  snan(s1[i]));.  
+0006e160: 2020 2020 2020 7d0a 2365 6e64 6966 0a20        }.#endif. 
+0006e170: 2020 2020 2020 202f 2f20 736f 6674 5f6d         // soft_m
+0006e180: 6178 0a20 2020 2020 2020 2067 676d 6c5f  ax.        ggml_
+0006e190: 666c 6f61 7420 7375 6d20 3d20 302e 303b  float sum = 0.0;
+0006e1a0: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
+0006e1b0: 2020 2020 2020 2066 6c6f 6174 206d 6178         float max
+0006e1c0: 203d 202d 494e 4649 4e49 5459 3b0a 2020   = -INFINITY;.  
+0006e1d0: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+0006e1e0: 6563 5f6d 6178 5f66 3332 286e 632c 2026  ec_max_f32(nc, &
+0006e1f0: 6d61 782c 2073 3029 3b0a 0a20 2020 2020  max, s0);..     
+0006e200: 2020 2020 2020 2075 696e 7431 365f 7420         uint16_t 
+0006e210: 7363 7674 3b0a 2020 2020 2020 2020 2020  scvt;.          
+0006e220: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0006e230: 3b20 6920 3c20 6e63 3b20 692b 2b29 207b  ; i < nc; i++) {
+0006e240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006e250: 2069 6620 2873 305b 695d 203d 3d20 2d49   if (s0[i] == -I
+0006e260: 4e46 494e 4954 5929 207b 0a20 2020 2020  NFINITY) {.     
+0006e270: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0006e280: 745b 695d 203d 2030 2e30 663b 0a20 2020  t[i] = 0.0f;.   
+0006e290: 2020 2020 2020 2020 2020 2020 207d 2065               } e
+0006e2a0: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+0006e2b0: 2020 2020 2020 2020 2020 2f2f 2063 6f6e            // con
+0006e2c0: 7374 2066 6c6f 6174 2076 616c 203d 2028  st float val = (
+0006e2d0: 7330 5b69 5d20 3d3d 202d 494e 4649 4e49  s0[i] == -INFINI
+0006e2e0: 5459 2920 3f20 302e 3020 3a20 6578 7028  TY) ? 0.0 : exp(
+0006e2f0: 7330 5b69 5d20 2d20 6d61 7829 3b0a 2020  s0[i] - max);.  
+0006e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e310: 2020 6767 6d6c 5f66 7031 365f 7420 7320    ggml_fp16_t s 
+0006e320: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
+0006e330: 5031 3628 7330 5b69 5d20 2d20 6d61 7829  P16(s0[i] - max)
+0006e340: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006e350: 2020 2020 2020 6d65 6d63 7079 2826 7363        memcpy(&sc
+0006e360: 7674 2c20 2673 2c20 7369 7a65 6f66 2873  vt, &s, sizeof(s
+0006e370: 6376 7429 293b 0a20 2020 2020 2020 2020  cvt));.         
+0006e380: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0006e390: 2066 6c6f 6174 2076 616c 203d 2047 474d   float val = GGM
+0006e3a0: 4c5f 4650 3136 5f54 4f5f 4650 3332 2874  L_FP16_TO_FP32(t
+0006e3b0: 6162 6c65 5f65 7870 5f66 3136 5b73 6376  able_exp_f16[scv
+0006e3c0: 745d 293b 0a20 2020 2020 2020 2020 2020  t]);.           
+0006e3d0: 2020 2020 2020 2020 2073 756d 202b 3d20           sum += 
+0006e3e0: 2867 676d 6c5f 666c 6f61 7429 7661 6c3b  (ggml_float)val;
+0006e3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006e400: 2020 2020 2073 745b 695d 203d 2076 616c       st[i] = val
+0006e410: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006e420: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0006e430: 7d0a 0a20 2020 2020 2020 2020 2020 2061  }..            a
+0006e440: 7373 6572 7428 7375 6d20 3e20 302e 3029  ssert(sum > 0.0)
+0006e450: 3b0a 2020 2020 2020 2020 2020 2020 2f2f  ;.            //
+0006e460: 2073 756d 203d 2031 2e30 2f73 756d 3b0a   sum = 1.0/sum;.
+0006e470: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0006e480: 2020 2f2f 2061 766f 6964 206c 6f67 2830    // avoid log(0
+0006e490: 2920 6279 2072 6573 6361 6c69 6e67 2066  ) by rescaling f
+0006e4a0: 726f 6d20 5b30 2e2e 315d 2074 6f20 5b65  rom [0..1] to [e
+0006e4b0: 7073 2e2e 315d 0a20 2020 2020 2020 2073  ps..1].        s
+0006e4c0: 756d 203d 2028 312e 3020 2d20 6570 7329  um = (1.0 - eps)
+0006e4d0: 202f 2073 756d 3b0a 2020 2020 2020 2020   / sum;.        
+0006e4e0: 6767 6d6c 5f76 6563 5f73 6361 6c65 5f66  ggml_vec_scale_f
+0006e4f0: 3332 286e 632c 2073 742c 2073 756d 293b  32(nc, st, sum);
+0006e500: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
+0006e510: 635f 6164 6431 5f66 3332 286e 632c 2073  c_add1_f32(nc, s
+0006e520: 742c 2073 742c 2065 7073 293b 0a20 2020  t, st, eps);.   
+0006e530: 2020 2020 2067 676d 6c5f 7665 635f 6c6f       ggml_vec_lo
+0006e540: 675f 6633 3228 6e63 2c20 7374 2c20 7374  g_f32(nc, st, st
+0006e550: 293b 0a20 2020 2020 2020 2067 676d 6c5f  );.        ggml_
+0006e560: 7665 635f 6d75 6c5f 6633 3228 6e63 2c20  vec_mul_f32(nc, 
+0006e570: 7374 2c20 7374 2c20 7331 293b 0a0a 2020  st, st, s1);..  
+0006e580: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+0006e590: 756d 5f66 3332 286e 632c 2073 756d 7320  um_f32(nc, sums 
+0006e5a0: 2b20 6974 682c 2073 7429 3b0a 0a23 6966  + ith, st);..#if
+0006e5b0: 6e64 6566 204e 4445 4255 470a 2020 2020  ndef NDEBUG.    
+0006e5c0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+0006e5d0: 2030 3b20 6920 3c20 6e63 3b20 2b2b 6929   0; i < nc; ++i)
+0006e5e0: 207b 0a20 2020 2020 2020 2020 2020 2061   {.            a
+0006e5f0: 7373 6572 7428 2169 736e 616e 2873 745b  ssert(!isnan(st[
+0006e600: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
+0006e610: 2020 6173 7365 7274 2821 6973 696e 6628    assert(!isinf(
+0006e620: 7374 5b69 5d29 293b 0a20 2020 2020 2020  st[i]));.       
+0006e630: 207d 0a23 656e 6469 660a 2020 2020 7d0a   }.#endif.    }.
+0006e640: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+0006e650: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+0006e660: 7761 7264 5f63 726f 7373 5f65 6e74 726f  ward_cross_entro
+0006e670: 7079 5f6c 6f73 7328 0a20 2020 2020 2020  py_loss(.       
+0006e680: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0006e690: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+0006e6a0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+0006e6b0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0006e6c0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+0006e6d0: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+0006e6e0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0006e6f0: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+0006e700: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0006e710: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+0006e720: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
+0006e730: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
+0006e740: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0006e750: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+0006e760: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0006e770: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+0006e780: 7465 5f66 6f72 7761 7264 5f63 726f 7373  te_forward_cross
+0006e790: 5f65 6e74 726f 7079 5f6c 6f73 735f 6633  _entropy_loss_f3
+0006e7a0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+0006e7b0: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+0006e7c0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0006e7d0: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+0006e7e0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0006e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e800: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+0006e810: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+0006e820: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+0006e830: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
+0006e840: 655f 666f 7277 6172 645f 6372 6f73 735f  e_forward_cross_
+0006e850: 656e 7472 6f70 795f 6c6f 7373 5f62 6163  entropy_loss_bac
+0006e860: 6b0a 0a73 7461 7469 6320 766f 6964 2067  k..static void g
+0006e870: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0006e880: 6172 645f 6372 6f73 735f 656e 7472 6f70  ard_cross_entrop
+0006e890: 795f 6c6f 7373 5f62 6163 6b5f 6633 3228  y_loss_back_f32(
+0006e8a0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0006e8b0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+0006e8c0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+0006e8d0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+0006e8e0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+0006e8f0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+0006e900: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0006e910: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0006e920: 7372 6331 2c0a 2020 2020 2020 2020 636f  src1,.        co
+0006e930: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0006e940: 7465 6e73 6f72 202a 206f 7074 302c 0a20  tensor * opt0,. 
+0006e950: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0006e960: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+0006e970: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
+0006e980: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
+0006e990: 6775 6f75 7328 6473 7429 293b 0a20 2020  guous(dst));.   
+0006e9a0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+0006e9b0: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
+0006e9c0: 7372 6330 2929 3b0a 2020 2020 4747 4d4c  src0));.    GGML
+0006e9d0: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
+0006e9e0: 636f 6e74 6967 756f 7573 2873 7263 3129  contiguous(src1)
+0006e9f0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0006ea00: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
+0006ea10: 6775 6f75 7328 6f70 7430 2929 3b0a 2020  guous(opt0));.  
+0006ea20: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0006ea30: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
+0006ea40: 6528 7372 6330 2c20 7372 6331 2920 2626  e(src0, src1) &&
+0006ea50: 2067 676d 6c5f 6172 655f 7361 6d65 5f73   ggml_are_same_s
+0006ea60: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
+0006ea70: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0006ea80: 3634 5f74 2069 7468 203d 2070 6172 616d  64_t ith = param
+0006ea90: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
+0006eaa0: 7420 696e 7436 345f 7420 6e74 6820 3d20  t int64_t nth = 
+0006eab0: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
+0006eac0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+0006ead0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+0006eae0: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
+0006eaf0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+0006eb00: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+0006eb10: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+0006eb20: 2020 7d0a 0a20 2020 2063 6f6e 7374 2066    }..    const f
+0006eb30: 6c6f 6174 2065 7073 203d 2031 652d 3966  loat eps = 1e-9f
+0006eb40: 3b0a 0a20 2020 202f 2f20 544f 444f 3a20  ;..    // TODO: 
+0006eb50: 6861 6e64 6c65 2074 7261 6e73 706f 7365  handle transpose
+0006eb60: 642f 7065 726d 7574 6564 206d 6174 7269  d/permuted matri
+0006eb70: 6365 730a 2020 2020 636f 6e73 7420 696e  ces.    const in
+0006eb80: 7436 345f 7420 6e63 203d 2073 7263 302d  t64_t nc = src0-
+0006eb90: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+0006eba0: 7420 696e 7436 345f 7420 6e72 203d 2067  t int64_t nr = g
+0006ebb0: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
+0006ebc0: 0a0a 2020 2020 2f2f 2072 6f77 7320 7065  ..    // rows pe
+0006ebd0: 7220 7468 7265 6164 0a20 2020 2063 6f6e  r thread.    con
+0006ebe0: 7374 2069 6e74 3634 5f74 2064 7220 3d20  st int64_t dr = 
+0006ebf0: 286e 7220 2b20 6e74 6820 2d20 3129 2f6e  (nr + nth - 1)/n
+0006ec00: 7468 3b0a 0a20 2020 202f 2f20 726f 7720  th;..    // row 
+0006ec10: 7261 6e67 6520 666f 7220 7468 6973 2074  range for this t
+0006ec20: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
+0006ec30: 696e 7436 345f 7420 6972 3020 3d20 6472  int64_t ir0 = dr
+0006ec40: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
+0006ec50: 696e 7436 345f 7420 6972 3120 3d20 4d49  int64_t ir1 = MI
+0006ec60: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
+0006ec70: 0a0a 2020 2020 666c 6f61 7420 2a20 6420  ..    float * d 
+0006ec80: 2020 3d20 2866 6c6f 6174 202a 2920 6f70    = (float *) op
+0006ec90: 7430 2d3e 6461 7461 3b0a 0a20 2020 2066  t0->data;..    f
+0006eca0: 6f72 2028 696e 7436 345f 7420 6931 203d  or (int64_t i1 =
+0006ecb0: 2069 7230 3b20 6931 203c 2069 7231 3b20   ir0; i1 < ir1; 
+0006ecc0: 6931 2b2b 2920 7b0a 2020 2020 2020 2020  i1++) {.        
+0006ecd0: 666c 6f61 7420 2a20 6473 3020 3d20 2866  float * ds0 = (f
+0006ece0: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+0006ecf0: 2064 7374 2d3e 6461 7461 2020 2b20 6931   dst->data  + i1
+0006ed00: 2a64 7374 2d3e 6e62 5b31 5d29 3b0a 2020  *dst->nb[1]);.  
+0006ed10: 2020 2020 2020 666c 6f61 7420 2a20 7330        float * s0
+0006ed20: 2020 3d20 2866 6c6f 6174 202a 2928 2863    = (float *)((c
+0006ed30: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+0006ed40: 6120 2b20 6931 2a73 7263 302d 3e6e 625b  a + i1*src0->nb[
+0006ed50: 315d 293b 0a20 2020 2020 2020 2066 6c6f  1]);.        flo
+0006ed60: 6174 202a 2073 3120 203d 2028 666c 6f61  at * s1  = (floa
+0006ed70: 7420 2a29 2828 6368 6172 202a 2920 7372  t *)((char *) sr
+0006ed80: 6331 2d3e 6461 7461 202b 2069 312a 7372  c1->data + i1*sr
+0006ed90: 6331 2d3e 6e62 5b31 5d29 3b0a 2020 2020  c1->nb[1]);.    
+0006eda0: 2020 2020 666c 6f61 7420 2a20 736d 2020      float * sm  
+0006edb0: 3d20 2866 6c6f 6174 202a 2920 7061 7261  = (float *) para
+0006edc0: 6d73 2d3e 7764 6174 6120 2b20 6974 682a  ms->wdata + ith*
+0006edd0: 6e63 3b0a 0a23 6966 6e64 6566 204e 4445  nc;..#ifndef NDE
+0006ede0: 4255 470a 2020 2020 2020 2020 666f 7220  BUG.        for 
+0006edf0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+0006ee00: 6e63 3b20 2b2b 6929 207b 0a20 2020 2020  nc; ++i) {.     
+0006ee10: 2020 2020 2020 202f 2f70 7269 6e74 6628         //printf(
+0006ee20: 2270 5b25 645d 203d 2025 665c 6e22 2c20  "p[%d] = %f\n", 
+0006ee30: 692c 2070 5b69 5d29 3b0a 2020 2020 2020  i, p[i]);.      
+0006ee40: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
+0006ee50: 6e61 6e28 7330 5b69 5d29 293b 0a20 2020  nan(s0[i]));.   
+0006ee60: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
+0006ee70: 2169 736e 616e 2873 315b 695d 2929 3b0a  !isnan(s1[i]));.
+0006ee80: 2020 2020 2020 2020 7d0a 2365 6e64 6966          }.#endif
+0006ee90: 0a20 2020 2020 2020 202f 2f20 7374 6570  .        // step
+0006eea0: 2062 7920 7374 6570 2065 7870 6c61 6e61   by step explana
+0006eeb0: 7469 6f6e 3a0a 2020 2020 2020 2020 7b0a  tion:.        {.
+0006eec0: 2020 2020 2020 2020 2020 2020 2f2f 666c              //fl
+0006eed0: 6f61 7420 2a20 7375 6d73 203d 2028 666c  oat * sums = (fl
+0006eee0: 6f61 7420 2a29 2070 6172 616d 732d 3e77  oat *) params->w
+0006eef0: 6461 7461 3b0a 0a20 2020 2020 2020 2020  data;..         
+0006ef00: 2020 202f 2f20 666f 7277 6172 6420 7061     // forward pa
+0006ef10: 7373 2077 6974 6820 616e 6e6f 7461 7465  ss with annotate
+0006ef20: 6420 6772 6164 6965 6e74 7320 6672 6f6d  d gradients from
+0006ef30: 2062 6163 6b77 6172 6420 7061 7373 0a20   backward pass. 
+0006ef40: 2020 2020 2020 2020 2020 202f 2f20 2862             // (b
+0006ef50: 7569 6c74 2062 7920 676f 696e 6720 696e  uilt by going in
+0006ef60: 2072 6576 6572 7365 206f 7065 7261 7469   reverse operati
+0006ef70: 6f6e 206f 7264 6572 2c20 6164 6469 6e67  on order, adding
+0006ef80: 2074 6f20 6772 6164 6965 6e74 7320 6f66   to gradients of
+0006ef90: 2063 7572 7265 6e74 206f 7065 7261 7469   current operati
+0006efa0: 6f6e 2061 7267 7329 0a20 2020 2020 2020  on args).       
+0006efb0: 2020 2020 202f 2f20 7374 3020 3d20 6578       // st0 = ex
+0006efc0: 7028 7330 2d6d 6178 2873 3029 2920 2020  p(s0-max(s0))   
+0006efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f000: 2020 2020 6772 6164 5b73 7430 5d20 3d20      grad[st0] = 
+0006f010: 6772 6164 5b73 7431 5d2a 2831 2e30 202d  grad[st1]*(1.0 -
+0006f020: 2065 7073 292f 7375 6d0a 2020 2020 2020   eps)/sum.      
 0006f030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f040: 2020 2067 7261 645b 7374 305d 203d 2067     grad[st0] = g
-0006f050: 7261 645b 7374 315d 2a28 312e 3020 2d20  rad[st1]*(1.0 - 
-0006f060: 6570 7329 2f73 756d 0a20 2020 2020 2020  eps)/sum.       
-0006f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f0a0: 2020 202f 2f20 6672 6f6d 2073 6f66 746d     // from softm
-0006f0b0: 6178 5f62 6163 6b3a 2020 2020 2020 2020  ax_back:        
-0006f0c0: 2020 2020 6772 6164 5b73 305d 2020 3d20      grad[s0]  = 
-0006f0d0: 7374 315f 6b20 2a20 2867 7261 645b 7374  st1_k * (grad[st
-0006f0e0: 315d 5f6b 202d 2064 6f74 2873 7431 2c20  1]_k - dot(st1, 
-0006f0f0: 6772 6164 5b73 7431 5d29 290a 2020 2020  grad[st1])).    
-0006f100: 2020 2020 2020 2020 2f2f 2067 676d 6c5f          // ggml_
-0006f110: 7665 635f 7363 616c 655f 6633 3228 6e63  vec_scale_f32(nc
-0006f120: 2c20 7374 2c20 7375 6d29 3b20 2020 2020  , st, sum);     
-0006f130: 2020 2020 2020 2f2f 2073 7431 203d 2073        // st1 = s
-0006f140: 7430 2a2f 7375 6d20 3d20 736f 6674 6d61  t0*/sum = softma
-0006f150: 7828 7330 2920 2067 7261 645b 7374 315d  x(s0)  grad[st1]
-0006f160: 203d 2067 7261 645b 7374 325d 2a28 312e   = grad[st2]*(1.
-0006f170: 3020 2d20 6570 7329 0a20 2020 2020 2020  0 - eps).       
-0006f180: 2020 2020 202f 2f20 6767 6d6c 5f76 6563       // ggml_vec
-0006f190: 5f73 6361 6c65 5f66 3332 286e 632c 2073  _scale_f32(nc, s
-0006f1a0: 742c 2028 312e 3066 202d 2065 7073 2929  t, (1.0f - eps))
-0006f1b0: 3b20 202f 2f20 7374 3220 3d20 7374 312a  ;  // st2 = st1*
-0006f1c0: 2831 2e30 202d 2065 7073 2920 2020 2020  (1.0 - eps)     
-0006f1d0: 2020 2020 6772 6164 5b73 7432 5d20 3d20      grad[st2] = 
-0006f1e0: 6772 6164 5b73 7433 5d0a 2020 2020 2020  grad[st3].      
-0006f1f0: 2020 2020 2020 2f2f 2067 676d 6c5f 7665        // ggml_ve
-0006f200: 635f 6164 6431 5f66 3332 286e 632c 2073  c_add1_f32(nc, s
-0006f210: 742c 2073 742c 2065 7073 293b 2020 2020  t, st, eps);    
-0006f220: 2020 2020 2f2f 2073 7433 203d 2073 7432      // st3 = st2
-0006f230: 202b 2065 7073 2020 2020 2020 2020 2020   + eps          
-0006f240: 2020 2020 2067 7261 645b 7374 335d 203d       grad[st3] =
-0006f250: 2067 7261 645b 7374 345d 2f73 7433 0a20   grad[st4]/st3. 
-0006f260: 2020 2020 2020 2020 2020 202f 2f20 6767             // gg
-0006f270: 6d6c 5f76 6563 5f6c 6f67 5f66 3332 286e  ml_vec_log_f32(n
-0006f280: 632c 2073 742c 2073 7429 3b20 2020 2020  c, st, st);     
-0006f290: 2020 2020 2020 2020 202f 2f20 7374 3420           // st4 
-0006f2a0: 3d20 6c6f 6728 7374 3329 2020 2020 2020  = log(st3)      
-0006f2b0: 2020 2020 2020 2020 2020 6772 6164 5b73            grad[s
-0006f2c0: 7434 5d20 3d20 6772 6164 5b73 7435 5d20  t4] = grad[st5] 
-0006f2d0: 2a20 7331 0a20 2020 2020 2020 2020 2020  * s1.           
-0006f2e0: 202f 2f20 6767 6d6c 5f76 6563 5f6d 756c   // ggml_vec_mul
-0006f2f0: 5f66 3332 286e 632c 2073 742c 2073 742c  _f32(nc, st, st,
-0006f300: 2073 3129 3b20 2020 2020 2020 2020 202f   s1);          /
-0006f310: 2f20 7374 3520 3d20 7374 3420 2a20 7331  / st5 = st4 * s1
-0006f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f330: 6772 6164 5b73 7435 5d20 3d20 6772 6164  grad[st5] = grad
-0006f340: 5b73 756d 735b 6974 685d 5d0a 2020 2020  [sums[ith]].    
-0006f350: 2020 2020 2020 2020 2f2f 2067 676d 6c5f          // ggml_
-0006f360: 7665 635f 7375 6d5f 6633 3228 6e63 2c20  vec_sum_f32(nc, 
-0006f370: 7375 6d73 202b 2069 7468 2c20 7374 293b  sums + ith, st);
-0006f380: 2020 2020 2020 2f2f 2073 756d 735b 6974        // sums[it
-0006f390: 685d 203d 2073 7435 2020 2020 2020 2020  h] = st5        
-0006f3a0: 2020 2020 2020 2067 7261 645b 7375 6d73         grad[sums
-0006f3b0: 5b69 7468 5d5d 203d 2067 7261 645b 6372  [ith]] = grad[cr
-0006f3c0: 6f73 735f 656e 7472 6f70 795f 6c6f 7373  oss_entropy_loss
-0006f3d0: 5d20 3d20 2d67 7261 645b 6365 6c5d 0a0a  ] = -grad[cel]..
-0006f3e0: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
-0006f3f0: 7562 7374 6974 7574 6520 696e 746f 2067  ubstitute into g
-0006f400: 7261 645b 7374 315d 2c20 6265 6361 7573  rad[st1], becaus
-0006f410: 6520 7765 2063 616e 2072 6575 7365 2073  e we can reuse s
-0006f420: 6f66 746d 6178 5f62 6163 6b20 6672 6f6d  oftmax_back from
-0006f430: 2074 6869 7320 706f 696e 7420 6f6e 0a20   this point on. 
-0006f440: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
-0006f450: 6164 5b73 7431 5d20 3d20 2d67 7261 645b  ad[st1] = -grad[
-0006f460: 6365 6c5d 2a73 312a 2831 2e30 202d 2065  cel]*s1*(1.0 - e
-0006f470: 7073 292f 2865 7073 202b 2073 6f66 746d  ps)/(eps + softm
-0006f480: 6178 2873 3029 2a28 312e 3020 2d20 6570  ax(s0)*(1.0 - ep
-0006f490: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0006f4a0: 2f2f 2070 6f73 746f 7264 6572 3a0a 2020  // postorder:.  
-0006f4b0: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
-0006f4c0: 645b 7374 315d 203a 3d20 736f 6674 6d61  d[st1] := softma
-0006f4d0: 7828 7330 290a 2020 2020 2020 2020 2020  x(s0).          
-0006f4e0: 2020 2f2f 2067 7261 645b 7374 315d 203a    // grad[st1] :
-0006f4f0: 3d20 6772 6164 5b73 7431 5d2a 2831 2e30  = grad[st1]*(1.0
-0006f500: 202d 2065 7073 290a 2020 2020 2020 2020   - eps).        
-0006f510: 2020 2020 2f2f 2067 7261 645b 7374 315d      // grad[st1]
-0006f520: 203a 3d20 6772 6164 5b73 7431 5d20 2b20   := grad[st1] + 
-0006f530: 6570 730a 2020 2020 2020 2020 2020 2020  eps.            
-0006f540: 2f2f 2067 7261 645b 7374 315d 203a 3d20  // grad[st1] := 
-0006f550: 7331 202f 2067 7261 645b 7374 315d 0a20  s1 / grad[st1]. 
-0006f560: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
-0006f570: 6164 5b73 7431 5d20 3a3d 2067 7261 645b  ad[st1] := grad[
-0006f580: 7374 315d 2a28 312e 302d 6570 7329 2a2d  st1]*(1.0-eps)*-
-0006f590: 6772 6164 5b63 656c 5d0a 0a20 2020 2020  grad[cel]..     
-0006f5a0: 2020 2020 2020 202f 2f20 7372 6330 2067         // src0 g
-0006f5b0: 7261 6469 656e 7473 2062 7920 676f 696e  radients by goin
-0006f5c0: 6720 7468 726f 7567 6820 736f 6674 6d61  g through softma
-0006f5d0: 785f 6261 636b 0a20 2020 2020 2020 2020  x_back.         
-0006f5e0: 2020 202f 2f20 6772 6164 5b73 305d 203d     // grad[s0] =
-0006f5f0: 2073 7431 5f6b 202a 2028 6772 6164 5b73   st1_k * (grad[s
-0006f600: 7431 5d5f 6b20 2d20 646f 7428 7374 312c  t1]_k - dot(st1,
-0006f610: 2067 7261 645b 7374 315d 2929 0a20 2020   grad[st1])).   
-0006f620: 2020 2020 2020 2020 202f 2f20 2020 6672           //   fr
-0006f630: 6f6d 2073 6f66 746d 6178 5f62 6163 6b3a  om softmax_back:
-0006f640: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0006f650: 2020 6478 6b20 3d20 796b 202a 2028 6479    dxk = yk * (dy
-0006f660: 6b20 2d20 646f 7428 792c 2064 7929 290a  k - dot(y, dy)).
-0006f670: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
-0006f680: 2064 6f74 5f79 5f64 7920 3a3d 2064 6f74   dot_y_dy := dot
-0006f690: 2879 2c20 6479 290a 2020 2020 2020 2020  (y, dy).        
+0006f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f060: 2020 2020 2f2f 2066 726f 6d20 736f 6674      // from soft
+0006f070: 6d61 785f 6261 636b 3a20 2020 2020 2020  max_back:       
+0006f080: 2020 2020 2067 7261 645b 7330 5d20 203d       grad[s0]  =
+0006f090: 2073 7431 5f6b 202a 2028 6772 6164 5b73   st1_k * (grad[s
+0006f0a0: 7431 5d5f 6b20 2d20 646f 7428 7374 312c  t1]_k - dot(st1,
+0006f0b0: 2067 7261 645b 7374 315d 2929 0a20 2020   grad[st1])).   
+0006f0c0: 2020 2020 2020 2020 202f 2f20 6767 6d6c           // ggml
+0006f0d0: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
+0006f0e0: 632c 2073 742c 2073 756d 293b 2020 2020  c, st, sum);    
+0006f0f0: 2020 2020 2020 202f 2f20 7374 3120 3d20         // st1 = 
+0006f100: 7374 302a 2f73 756d 203d 2073 6f66 746d  st0*/sum = softm
+0006f110: 6178 2873 3029 2020 6772 6164 5b73 7431  ax(s0)  grad[st1
+0006f120: 5d20 3d20 6772 6164 5b73 7432 5d2a 2831  ] = grad[st2]*(1
+0006f130: 2e30 202d 2065 7073 290a 2020 2020 2020  .0 - eps).      
+0006f140: 2020 2020 2020 2f2f 2067 676d 6c5f 7665        // ggml_ve
+0006f150: 635f 7363 616c 655f 6633 3228 6e63 2c20  c_scale_f32(nc, 
+0006f160: 7374 2c20 2831 2e30 6620 2d20 6570 7329  st, (1.0f - eps)
+0006f170: 293b 2020 2f2f 2073 7432 203d 2073 7431  );  // st2 = st1
+0006f180: 2a28 312e 3020 2d20 6570 7329 2020 2020  *(1.0 - eps)    
+0006f190: 2020 2020 2067 7261 645b 7374 325d 203d       grad[st2] =
+0006f1a0: 2067 7261 645b 7374 335d 0a20 2020 2020   grad[st3].     
+0006f1b0: 2020 2020 2020 202f 2f20 6767 6d6c 5f76         // ggml_v
+0006f1c0: 6563 5f61 6464 315f 6633 3228 6e63 2c20  ec_add1_f32(nc, 
+0006f1d0: 7374 2c20 7374 2c20 6570 7329 3b20 2020  st, st, eps);   
+0006f1e0: 2020 2020 202f 2f20 7374 3320 3d20 7374       // st3 = st
+0006f1f0: 3220 2b20 6570 7320 2020 2020 2020 2020  2 + eps         
+0006f200: 2020 2020 2020 6772 6164 5b73 7433 5d20        grad[st3] 
+0006f210: 3d20 6772 6164 5b73 7434 5d2f 7374 330a  = grad[st4]/st3.
+0006f220: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0006f230: 676d 6c5f 7665 635f 6c6f 675f 6633 3228  gml_vec_log_f32(
+0006f240: 6e63 2c20 7374 2c20 7374 293b 2020 2020  nc, st, st);    
+0006f250: 2020 2020 2020 2020 2020 2f2f 2073 7434            // st4
+0006f260: 203d 206c 6f67 2873 7433 2920 2020 2020   = log(st3)     
+0006f270: 2020 2020 2020 2020 2020 2067 7261 645b             grad[
+0006f280: 7374 345d 203d 2067 7261 645b 7374 355d  st4] = grad[st5]
+0006f290: 202a 2073 310a 2020 2020 2020 2020 2020   * s1.          
+0006f2a0: 2020 2f2f 2067 676d 6c5f 7665 635f 6d75    // ggml_vec_mu
+0006f2b0: 6c5f 6633 3228 6e63 2c20 7374 2c20 7374  l_f32(nc, st, st
+0006f2c0: 2c20 7331 293b 2020 2020 2020 2020 2020  , s1);          
+0006f2d0: 2f2f 2073 7435 203d 2073 7434 202a 2073  // st5 = st4 * s
+0006f2e0: 3120 2020 2020 2020 2020 2020 2020 2020  1               
+0006f2f0: 2067 7261 645b 7374 355d 203d 2067 7261   grad[st5] = gra
+0006f300: 645b 7375 6d73 5b69 7468 5d5d 0a20 2020  d[sums[ith]].   
+0006f310: 2020 2020 2020 2020 202f 2f20 6767 6d6c           // ggml
+0006f320: 5f76 6563 5f73 756d 5f66 3332 286e 632c  _vec_sum_f32(nc,
+0006f330: 2073 756d 7320 2b20 6974 682c 2073 7429   sums + ith, st)
+0006f340: 3b20 2020 2020 202f 2f20 7375 6d73 5b69  ;      // sums[i
+0006f350: 7468 5d20 3d20 7374 3520 2020 2020 2020  th] = st5       
+0006f360: 2020 2020 2020 2020 6772 6164 5b73 756d          grad[sum
+0006f370: 735b 6974 685d 5d20 3d20 6772 6164 5b63  s[ith]] = grad[c
+0006f380: 726f 7373 5f65 6e74 726f 7079 5f6c 6f73  ross_entropy_los
+0006f390: 735d 203d 202d 6772 6164 5b63 656c 5d0a  s] = -grad[cel].
+0006f3a0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0006f3b0: 7375 6273 7469 7475 7465 2069 6e74 6f20  substitute into 
+0006f3c0: 6772 6164 5b73 7431 5d2c 2062 6563 6175  grad[st1], becau
+0006f3d0: 7365 2077 6520 6361 6e20 7265 7573 6520  se we can reuse 
+0006f3e0: 736f 6674 6d61 785f 6261 636b 2066 726f  softmax_back fro
+0006f3f0: 6d20 7468 6973 2070 6f69 6e74 206f 6e0a  m this point on.
+0006f400: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0006f410: 7261 645b 7374 315d 203d 202d 6772 6164  rad[st1] = -grad
+0006f420: 5b63 656c 5d2a 7331 2a28 312e 3020 2d20  [cel]*s1*(1.0 - 
+0006f430: 6570 7329 2f28 6570 7320 2b20 736f 6674  eps)/(eps + soft
+0006f440: 6d61 7828 7330 292a 2831 2e30 202d 2065  max(s0)*(1.0 - e
+0006f450: 7073 2929 0a20 2020 2020 2020 2020 2020  ps)).           
+0006f460: 202f 2f20 706f 7374 6f72 6465 723a 0a20   // postorder:. 
+0006f470: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
+0006f480: 6164 5b73 7431 5d20 3a3d 2073 6f66 746d  ad[st1] := softm
+0006f490: 6178 2873 3029 0a20 2020 2020 2020 2020  ax(s0).         
+0006f4a0: 2020 202f 2f20 6772 6164 5b73 7431 5d20     // grad[st1] 
+0006f4b0: 3a3d 2067 7261 645b 7374 315d 2a28 312e  := grad[st1]*(1.
+0006f4c0: 3020 2d20 6570 7329 0a20 2020 2020 2020  0 - eps).       
+0006f4d0: 2020 2020 202f 2f20 6772 6164 5b73 7431       // grad[st1
+0006f4e0: 5d20 3a3d 2067 7261 645b 7374 315d 202b  ] := grad[st1] +
+0006f4f0: 2065 7073 0a20 2020 2020 2020 2020 2020   eps.           
+0006f500: 202f 2f20 6772 6164 5b73 7431 5d20 3a3d   // grad[st1] :=
+0006f510: 2073 3120 2f20 6772 6164 5b73 7431 5d0a   s1 / grad[st1].
+0006f520: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0006f530: 7261 645b 7374 315d 203a 3d20 6772 6164  rad[st1] := grad
+0006f540: 5b73 7431 5d2a 2831 2e30 2d65 7073 292a  [st1]*(1.0-eps)*
+0006f550: 2d67 7261 645b 6365 6c5d 0a0a 2020 2020  -grad[cel]..    
+0006f560: 2020 2020 2020 2020 2f2f 2073 7263 3020          // src0 
+0006f570: 6772 6164 6965 6e74 7320 6279 2067 6f69  gradients by goi
+0006f580: 6e67 2074 6872 6f75 6768 2073 6f66 746d  ng through softm
+0006f590: 6178 5f62 6163 6b0a 2020 2020 2020 2020  ax_back.        
+0006f5a0: 2020 2020 2f2f 2067 7261 645b 7330 5d20      // grad[s0] 
+0006f5b0: 3d20 7374 315f 6b20 2a20 2867 7261 645b  = st1_k * (grad[
+0006f5c0: 7374 315d 5f6b 202d 2064 6f74 2873 7431  st1]_k - dot(st1
+0006f5d0: 2c20 6772 6164 5b73 7431 5d29 290a 2020  , grad[st1])).  
+0006f5e0: 2020 2020 2020 2020 2020 2f2f 2020 2066            //   f
+0006f5f0: 726f 6d20 736f 6674 6d61 785f 6261 636b  rom softmax_back
+0006f600: 3a0a 2020 2020 2020 2020 2020 2020 2f2f  :.            //
+0006f610: 2020 2064 786b 203d 2079 6b20 2a20 2864     dxk = yk * (d
+0006f620: 796b 202d 2064 6f74 2879 2c20 6479 2929  yk - dot(y, dy))
+0006f630: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0006f640: 2020 646f 745f 795f 6479 203a 3d20 646f    dot_y_dy := do
+0006f650: 7428 792c 2064 7929 0a20 2020 2020 2020  t(y, dy).       
+0006f660: 2020 2020 202f 2f20 2020 6478 203a 3d20       //   dx := 
+0006f670: 6479 0a20 2020 2020 2020 2020 2020 202f  dy.            /
+0006f680: 2f20 2020 6478 203a 3d20 6478 202d 2064  /   dx := dx - d
+0006f690: 6f74 5f79 5f64 790a 2020 2020 2020 2020  ot_y_dy.        
 0006f6a0: 2020 2020 2f2f 2020 2064 7820 3a3d 2064      //   dx := d
-0006f6b0: 790a 2020 2020 2020 2020 2020 2020 2f2f  y.            //
-0006f6c0: 2020 2064 7820 3a3d 2064 7820 2d20 646f     dx := dx - do
-0006f6d0: 745f 795f 6479 0a20 2020 2020 2020 2020  t_y_dy.         
-0006f6e0: 2020 202f 2f20 2020 6478 203a 3d20 6478     //   dx := dx
-0006f6f0: 202a 2079 0a20 2020 2020 2020 2020 2020   * y.           
-0006f700: 202f 2f20 2020 706f 7374 6f72 6465 723a   //   postorder:
-0006f710: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0006f720: 2020 646f 745f 7374 315f 6473 7431 203a    dot_st1_dst1 :
-0006f730: 3d20 646f 7428 7374 312c 2067 7261 645b  = dot(st1, grad[
-0006f740: 7374 315d 290a 2020 2020 2020 2020 2020  st1]).          
-0006f750: 2020 2f2f 2020 2067 7261 645b 7330 5d20    //   grad[s0] 
-0006f760: 3a3d 2067 7261 645b 7374 315d 0a20 2020  := grad[st1].   
-0006f770: 2020 2020 2020 2020 202f 2f20 2020 6772           //   gr
-0006f780: 6164 5b73 305d 203a 3d20 6772 6164 5b73  ad[s0] := grad[s
-0006f790: 305d 202d 2064 6f74 5f73 7431 5f64 7374  0] - dot_st1_dst
-0006f7a0: 310a 2020 2020 2020 2020 2020 2020 2f2f  1.            //
-0006f7b0: 2020 2067 7261 645b 7330 5d20 3a3d 2067     grad[s0] := g
-0006f7c0: 7261 645b 7330 5d20 2a20 7374 310a 0a20  rad[s0] * st1.. 
-0006f7d0: 2020 2020 2020 2020 2020 202f 2f20 7072             // pr
-0006f7e0: 6570 656e 6420 706f 7374 6f72 6465 7220  epend postorder 
-0006f7f0: 6672 6f6d 2067 7261 645b 7374 315d 2064  from grad[st1] d
-0006f800: 6972 6563 746c 7920 7573 696e 6720 6772  irectly using gr
-0006f810: 6164 5b73 305d 2061 7320 6d65 6d6f 7279  ad[s0] as memory
-0006f820: 206c 6f63 6174 696f 6e2c 2061 7320 7765   location, as we
-0006f830: 2077 696c 6c20 6772 6164 5b73 305d 203a   will grad[s0] :
-0006f840: 3d20 6772 6164 5b73 7431 5d0a 2020 2020  = grad[st1].    
-0006f850: 2020 2020 2020 2020 2f2f 2073 6d20 2020          // sm   
-0006f860: 2020 2020 2020 2020 3a3d 2073 6f66 746d          := softm
-0006f870: 6178 2873 3029 0a20 2020 2020 2020 2020  ax(s0).         
-0006f880: 2020 202f 2f20 6772 6164 5b73 305d 2020     // grad[s0]  
-0006f890: 2020 203a 3d20 736d 2a28 312e 3020 2d20     := sm*(1.0 - 
-0006f8a0: 6570 7329 0a20 2020 2020 2020 2020 2020  eps).           
-0006f8b0: 202f 2f20 6772 6164 5b73 305d 2020 2020   // grad[s0]    
-0006f8c0: 203a 3d20 6772 6164 5b73 305d 202b 2065   := grad[s0] + e
-0006f8d0: 7073 0a20 2020 2020 2020 2020 2020 202f  ps.            /
-0006f8e0: 2f20 6772 6164 5b73 305d 2020 2020 203a  / grad[s0]     :
-0006f8f0: 3d20 7331 202f 2067 7261 645b 7330 5d0a  = s1 / grad[s0].
-0006f900: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
-0006f910: 7261 645b 7330 5d20 2020 2020 3a3d 2067  rad[s0]     := g
-0006f920: 7261 645b 7330 5d2a 2831 2e30 2d65 7073  rad[s0]*(1.0-eps
-0006f930: 292a 2d67 7261 645b 6365 6c5d 0a20 2020  )*-grad[cel].   
-0006f940: 2020 2020 2020 2020 202f 2f20 646f 745f           // dot_
-0006f950: 7374 315f 6473 7431 203a 3d20 646f 7428  st1_dst1 := dot(
-0006f960: 736d 2c20 6772 6164 5b73 305d 290a 2020  sm, grad[s0]).  
-0006f970: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
-0006f980: 645b 7330 5d20 2020 2020 3a3d 2067 7261  d[s0]     := gra
-0006f990: 645b 7330 5d20 2d20 646f 745f 7374 315f  d[s0] - dot_st1_
-0006f9a0: 6473 7431 0a20 2020 2020 2020 2020 2020  dst1.           
-0006f9b0: 202f 2f20 6772 6164 5b73 305d 2020 2020   // grad[s0]    
-0006f9c0: 203a 3d20 6772 6164 5b73 305d 202a 2073   := grad[s0] * s
-0006f9d0: 6d0a 2020 2020 2020 2020 7d0a 0a20 2020  m.        }..   
-0006f9e0: 2020 2020 202f 2f20 736f 6674 5f6d 6178       // soft_max
-0006f9f0: 0a20 2020 2020 2020 2067 676d 6c5f 666c  .        ggml_fl
-0006fa00: 6f61 7420 7375 6d20 3d20 302e 303b 0a20  oat sum = 0.0;. 
-0006fa10: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0006fa20: 2020 2020 2066 6c6f 6174 206d 6178 203d       float max =
-0006fa30: 202d 494e 4649 4e49 5459 3b0a 2020 2020   -INFINITY;.    
-0006fa40: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0006fa50: 5f6d 6178 5f66 3332 286e 632c 2026 6d61  _max_f32(nc, &ma
-0006fa60: 782c 2073 3029 3b0a 0a20 2020 2020 2020  x, s0);..       
-0006fa70: 2020 2020 2075 696e 7431 365f 7420 7363       uint16_t sc
-0006fa80: 7674 3b0a 2020 2020 2020 2020 2020 2020  vt;.            
-0006fa90: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0006faa0: 6920 3c20 6e63 3b20 692b 2b29 207b 0a20  i < nc; i++) {. 
-0006fab0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0006fac0: 6620 2873 305b 695d 203d 3d20 2d49 4e46  f (s0[i] == -INF
-0006fad0: 494e 4954 5929 207b 0a20 2020 2020 2020  INITY) {.       
-0006fae0: 2020 2020 2020 2020 2020 2020 2073 6d5b               sm[
-0006faf0: 695d 203d 2030 2e30 663b 0a20 2020 2020  i] = 0.0f;.     
-0006fb00: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-0006fb10: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
-0006fb20: 2020 2020 2020 2020 2f2f 2063 6f6e 7374          // const
-0006fb30: 2066 6c6f 6174 2076 616c 203d 2028 7330   float val = (s0
-0006fb40: 5b69 5d20 3d3d 202d 494e 4649 4e49 5459  [i] == -INFINITY
-0006fb50: 2920 3f20 302e 3020 3a20 6578 7028 7330  ) ? 0.0 : exp(s0
-0006fb60: 5b69 5d20 2d20 6d61 7829 3b0a 2020 2020  [i] - max);.    
-0006fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fb80: 6767 6d6c 5f66 7031 365f 7420 7320 3d20  ggml_fp16_t s = 
-0006fb90: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
-0006fba0: 3628 7330 5b69 5d20 2d20 6d61 7829 3b0a  6(s0[i] - max);.
-0006fbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fbc0: 2020 2020 6d65 6d63 7079 2826 7363 7674      memcpy(&scvt
-0006fbd0: 2c20 2673 2c20 7369 7a65 6f66 2873 6376  , &s, sizeof(scv
-0006fbe0: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
-0006fbf0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0006fc00: 6c6f 6174 2076 616c 203d 2047 474d 4c5f  loat val = GGML_
-0006fc10: 4650 3136 5f54 4f5f 4650 3332 2874 6162  FP16_TO_FP32(tab
-0006fc20: 6c65 5f65 7870 5f66 3136 5b73 6376 745d  le_exp_f16[scvt]
-0006fc30: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0006fc40: 2020 2020 2020 2073 756d 202b 3d20 2867         sum += (g
-0006fc50: 676d 6c5f 666c 6f61 7429 7661 6c3b 0a20  gml_float)val;. 
-0006fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fc70: 2020 2073 6d5b 695d 203d 2076 616c 3b0a     sm[i] = val;.
-0006fc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fc90: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-0006fca0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0006fcb0: 6572 7428 7375 6d20 3e20 302e 3029 3b0a  ert(sum > 0.0);.
-0006fcc0: 2020 2020 2020 2020 2020 2020 7375 6d20              sum 
-0006fcd0: 3d20 312e 302f 7375 6d3b 0a20 2020 2020  = 1.0/sum;.     
-0006fce0: 2020 207d 0a0a 2020 2020 2020 2020 666c     }..        fl
-0006fcf0: 6f61 7420 646f 745f 7374 315f 6473 7431  oat dot_st1_dst1
-0006fd00: 203d 2030 3b0a 2020 2020 2020 2020 6767   = 0;.        gg
-0006fd10: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
-0006fd20: 286e 632c 2073 6d2c 2073 756d 293b 0a20  (nc, sm, sum);. 
-0006fd30: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0006fd40: 6370 795f 6633 3220 2028 6e63 2c20 6473  cpy_f32  (nc, ds
-0006fd50: 302c 2073 6d29 3b0a 2020 2020 2020 2020  0, sm);.        
-0006fd60: 6767 6d6c 5f76 6563 5f73 6361 6c65 5f66  ggml_vec_scale_f
-0006fd70: 3332 286e 632c 2064 7330 2c20 2831 2e30  32(nc, ds0, (1.0
-0006fd80: 6620 2d20 6570 7329 293b 0a20 2020 2020  f - eps));.     
-0006fd90: 2020 2067 676d 6c5f 7665 635f 6164 6431     ggml_vec_add1
-0006fda0: 5f66 3332 2028 6e63 2c20 6473 302c 2064  _f32 (nc, ds0, d
-0006fdb0: 7330 2c20 6570 7329 3b0a 2020 2020 2020  s0, eps);.      
-0006fdc0: 2020 6767 6d6c 5f76 6563 5f64 6976 5f66    ggml_vec_div_f
-0006fdd0: 3332 2020 286e 632c 2064 7330 2c20 7331  32  (nc, ds0, s1
-0006fde0: 2c20 6473 3029 3b0a 2020 2020 2020 2020  , ds0);.        
-0006fdf0: 6767 6d6c 5f76 6563 5f73 6361 6c65 5f66  ggml_vec_scale_f
-0006fe00: 3332 286e 632c 2064 7330 2c20 2d28 312e  32(nc, ds0, -(1.
-0006fe10: 3066 202d 2065 7073 292a 645b 305d 293b  0f - eps)*d[0]);
-0006fe20: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-0006fe30: 635f 646f 745f 6633 3220 2028 6e63 2c20  c_dot_f32  (nc, 
-0006fe40: 2664 6f74 5f73 7431 5f64 7374 312c 2073  &dot_st1_dst1, s
-0006fe50: 6d2c 2064 7330 293b 0a20 2020 2020 2020  m, ds0);.       
-0006fe60: 2067 676d 6c5f 7665 635f 6163 6331 5f66   ggml_vec_acc1_f
-0006fe70: 3332 2028 6e63 2c20 6473 302c 202d 646f  32 (nc, ds0, -do
-0006fe80: 745f 7374 315f 6473 7431 293b 0a20 2020  t_st1_dst1);.   
-0006fe90: 2020 2020 2067 676d 6c5f 7665 635f 6d75       ggml_vec_mu
-0006fea0: 6c5f 6633 3220 2028 6e63 2c20 6473 302c  l_f32  (nc, ds0,
-0006feb0: 2064 7330 2c20 736d 293b 0a0a 2369 666e   ds0, sm);..#ifn
-0006fec0: 6465 6620 4e44 4542 5547 0a20 2020 2020  def NDEBUG.     
-0006fed0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-0006fee0: 303b 2069 203c 206e 633b 202b 2b69 2920  0; i < nc; ++i) 
-0006fef0: 7b0a 2020 2020 2020 2020 2020 2020 6173  {.            as
-0006ff00: 7365 7274 2821 6973 6e61 6e28 736d 5b69  sert(!isnan(sm[i
-0006ff10: 5d29 293b 0a20 2020 2020 2020 2020 2020  ]));.           
-0006ff20: 2061 7373 6572 7428 2169 7369 6e66 2873   assert(!isinf(s
-0006ff30: 6d5b 695d 2929 3b0a 2020 2020 2020 2020  m[i]));.        
-0006ff40: 2020 2020 6173 7365 7274 2821 6973 6e61      assert(!isna
-0006ff50: 6e28 6473 305b 695d 2929 3b0a 2020 2020  n(ds0[i]));.    
-0006ff60: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
-0006ff70: 6973 696e 6628 6473 305b 695d 2929 3b0a  isinf(ds0[i]));.
-0006ff80: 2020 2020 2020 2020 7d0a 2365 6e64 6966          }.#endif
-0006ff90: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-0006ffa0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-0006ffb0: 7465 5f66 6f72 7761 7264 5f63 726f 7373  te_forward_cross
-0006ffc0: 5f65 6e74 726f 7079 5f6c 6f73 735f 6261  _entropy_loss_ba
-0006ffd0: 636b 280a 2020 2020 2020 2020 636f 6e73  ck(.        cons
-0006ffe0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-0006fff0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00070000: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00070010: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00070020: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00070030: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00070040: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00070050: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-00070060: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00070070: 6d6c 5f74 656e 736f 7220 2a20 6f70 7430  ml_tensor * opt0
-00070080: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00070090: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-000700a0: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
-000700b0: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
-000700c0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000700d0: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
-000700e0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000700f0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00070100: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-00070110: 726f 7373 5f65 6e74 726f 7079 5f6c 6f73  ross_entropy_los
-00070120: 735f 6261 636b 5f66 3332 2870 6172 616d  s_back_f32(param
-00070130: 732c 2073 7263 302c 2073 7263 312c 206f  s, src0, src1, o
-00070140: 7074 302c 2064 7374 293b 0a20 2020 2020  pt0, dst);.     
-00070150: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00070160: 2020 2020 2020 2020 6465 6661 756c 743a          default:
-00070170: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00070180: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00070190: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-000701a0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000701b0: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-000701c0: 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ..//////////////
-000701d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000701e0: 2f2f 2f0a 0a73 7461 7469 6320 766f 6964  ///..static void
-000701f0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00070200: 7277 6172 6428 7374 7275 6374 2067 676d  rward(struct ggm
-00070210: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00070220: 202a 2070 6172 616d 732c 2073 7472 7563   * params, struc
-00070230: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00070240: 7465 6e73 6f72 2920 7b0a 2020 2020 4747  tensor) {.    GG
-00070250: 4d4c 5f41 5353 4552 5428 7061 7261 6d73  ML_ASSERT(params
-00070260: 293b 0a0a 2369 6664 6566 2047 474d 4c5f  );..#ifdef GGML_
-00070270: 5553 455f 4355 424c 4153 0a20 2020 2062  USE_CUBLAS.    b
-00070280: 6f6f 6c20 736b 6970 5f63 7075 203d 2067  ool skip_cpu = g
-00070290: 676d 6c5f 6375 6461 5f63 6f6d 7075 7465  gml_cuda_compute
-000702a0: 5f66 6f72 7761 7264 2870 6172 616d 732c  _forward(params,
-000702b0: 2074 656e 736f 7229 3b0a 2020 2020 6966   tensor);.    if
-000702c0: 2028 736b 6970 5f63 7075 2920 7b0a 2020   (skip_cpu) {.  
-000702d0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-000702e0: 2020 7d0a 2020 2020 4747 4d4c 5f41 5353    }.    GGML_ASS
-000702f0: 4552 5428 7465 6e73 6f72 2d3e 7372 6330  ERT(tensor->src0
-00070300: 2d3e 6261 636b 656e 6420 3d3d 2047 474d  ->backend == GGM
-00070310: 4c5f 4241 434b 454e 445f 4350 5529 3b0a  L_BACKEND_CPU);.
-00070320: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00070330: 7465 6e73 6f72 2d3e 7372 6331 203d 3d20  tensor->src1 == 
-00070340: 4e55 4c4c 207c 7c20 7465 6e73 6f72 2d3e  NULL || tensor->
-00070350: 7372 6331 2d3e 6261 636b 656e 6420 3d3d  src1->backend ==
-00070360: 2047 474d 4c5f 4241 434b 454e 445f 4350   GGML_BACKEND_CP
-00070370: 5529 3b0a 2365 6e64 6966 202f 2f20 4747  U);.#endif // GG
-00070380: 4d4c 5f55 5345 5f43 5542 4c41 530a 0a20  ML_USE_CUBLAS.. 
-00070390: 2020 2073 7769 7463 6820 2874 656e 736f     switch (tenso
-000703a0: 722d 3e6f 7029 207b 0a20 2020 2020 2020  r->op) {.       
-000703b0: 2063 6173 6520 4747 4d4c 5f4f 505f 4455   case GGML_OP_DU
-000703c0: 503a 0a20 2020 2020 2020 2020 2020 207b  P:.            {
-000703d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000703e0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-000703f0: 7277 6172 645f 6475 7028 7061 7261 6d73  rward_dup(params
-00070400: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00070410: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00070420: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00070430: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00070440: 4f50 5f41 4444 3a0a 2020 2020 2020 2020  OP_ADD:.        
-00070450: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00070460: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00070470: 7465 5f66 6f72 7761 7264 5f61 6464 2870  te_forward_add(p
-00070480: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-00070490: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
-000704a0: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
-000704b0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000704c0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000704d0: 4d4c 5f4f 505f 4144 4431 3a0a 2020 2020  ML_OP_ADD1:.    
-000704e0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000704f0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00070500: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
-00070510: 6464 3128 7061 7261 6d73 2c20 7465 6e73  dd1(params, tens
-00070520: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-00070530: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
-00070540: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00070550: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00070560: 7365 2047 474d 4c5f 4f50 5f41 4343 3a0a  se GGML_OP_ACC:.
-00070570: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00070580: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00070590: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000705a0: 7264 5f61 6363 2870 6172 616d 732c 2074  rd_acc(params, t
-000705b0: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-000705c0: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
-000705d0: 722d 3e6f 7074 5b30 5d2c 2074 656e 736f  r->opt[0], tenso
-000705e0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-000705f0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00070600: 2063 6173 6520 4747 4d4c 5f4f 505f 5355   case GGML_OP_SU
-00070610: 423a 0a20 2020 2020 2020 2020 2020 207b  B:.            {
-00070620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00070630: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00070640: 7277 6172 645f 7375 6228 7061 7261 6d73  rward_sub(params
-00070650: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00070660: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
-00070670: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00070680: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00070690: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000706a0: 5f4d 554c 3a0a 2020 2020 2020 2020 2020  _MUL:.          
-000706b0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000706c0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-000706d0: 5f66 6f72 7761 7264 5f6d 756c 2870 6172  _forward_mul(par
-000706e0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-000706f0: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
-00070700: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00070710: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00070720: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00070730: 5f4f 505f 4449 563a 0a20 2020 2020 2020  _OP_DIV:.       
-00070740: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00070750: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00070760: 7574 655f 666f 7277 6172 645f 6469 7628  ute_forward_div(
-00070770: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00070780: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
-00070790: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
-000707a0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000707b0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000707c0: 474d 4c5f 4f50 5f53 5152 3a0a 2020 2020  GML_OP_SQR:.    
-000707d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000707e0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-000707f0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
-00070800: 7172 2870 6172 616d 732c 2074 656e 736f  qr(params, tenso
-00070810: 722d 3e73 7263 302c 2074 656e 736f 7229  r->src0, tensor)
-00070820: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00070830: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00070840: 6173 6520 4747 4d4c 5f4f 505f 5351 5254  ase GGML_OP_SQRT
-00070850: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00070860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070870: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00070880: 7761 7264 5f73 7172 7428 7061 7261 6d73  ward_sqrt(params
-00070890: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-000708a0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-000708b0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000708c0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000708d0: 4f50 5f4c 4f47 3a0a 2020 2020 2020 2020  OP_LOG:.        
-000708e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000708f0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00070900: 7465 5f66 6f72 7761 7264 5f6c 6f67 2870  te_forward_log(p
-00070910: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-00070920: 7263 302c 2074 656e 736f 7229 3b0a 2020  rc0, tensor);.  
-00070930: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00070940: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00070950: 4747 4d4c 5f4f 505f 5355 4d3a 0a20 2020  GGML_OP_SUM:.   
-00070960: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00070970: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00070980: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00070990: 7375 6d28 7061 7261 6d73 2c20 7465 6e73  sum(params, tens
-000709a0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-000709b0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000709c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000709d0: 6361 7365 2047 474d 4c5f 4f50 5f53 554d  case GGML_OP_SUM
-000709e0: 5f52 4f57 533a 0a20 2020 2020 2020 2020  _ROWS:.         
-000709f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00070a00: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00070a10: 655f 666f 7277 6172 645f 7375 6d5f 726f  e_forward_sum_ro
-00070a20: 7773 2870 6172 616d 732c 2074 656e 736f  ws(params, tenso
-00070a30: 722d 3e73 7263 302c 2074 656e 736f 7229  r->src0, tensor)
-00070a40: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00070a50: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00070a60: 6173 6520 4747 4d4c 5f4f 505f 4d45 414e  ase GGML_OP_MEAN
-00070a70: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00070a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070a90: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00070aa0: 7761 7264 5f6d 6561 6e28 7061 7261 6d73  ward_mean(params
-00070ab0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00070ac0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00070ad0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00070ae0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00070af0: 4f50 5f52 4550 4541 543a 0a20 2020 2020  OP_REPEAT:.     
-00070b00: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00070b10: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00070b20: 6d70 7574 655f 666f 7277 6172 645f 7265  mpute_forward_re
-00070b30: 7065 6174 2870 6172 616d 732c 2074 656e  peat(params, ten
-00070b40: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00070b50: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00070b60: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00070b70: 2063 6173 6520 4747 4d4c 5f4f 505f 5245   case GGML_OP_RE
-00070b80: 5045 4154 5f42 4143 4b3a 0a20 2020 2020  PEAT_BACK:.     
-00070b90: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00070ba0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00070bb0: 6d70 7574 655f 666f 7277 6172 645f 7265  mpute_forward_re
-00070bc0: 7065 6174 5f62 6163 6b28 7061 7261 6d73  peat_back(params
-00070bd0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00070be0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00070bf0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00070c00: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00070c10: 4f50 5f52 4550 4541 5432 3a0a 2020 2020  OP_REPEAT2:.    
-00070c20: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00070c30: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00070c40: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
-00070c50: 6570 6561 7432 2870 6172 616d 732c 2074  epeat2(params, t
-00070c60: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-00070c70: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-00070c80: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00070c90: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00070ca0: 4142 533a 0a20 2020 2020 2020 2020 2020  ABS:.           
-00070cb0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00070cc0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00070cd0: 666f 7277 6172 645f 6162 7328 7061 7261  forward_abs(para
-00070ce0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00070cf0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00070d00: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00070d10: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00070d20: 4c5f 4f50 5f53 474e 3a0a 2020 2020 2020  L_OP_SGN:.      
-00070d30: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00070d40: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00070d50: 7075 7465 5f66 6f72 7761 7264 5f73 676e  pute_forward_sgn
-00070d60: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00070d70: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
-00070d80: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00070d90: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00070da0: 6520 4747 4d4c 5f4f 505f 4e45 473a 0a20  e GGML_OP_NEG:. 
-00070db0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00070dc0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00070dd0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00070de0: 645f 6e65 6728 7061 7261 6d73 2c20 7465  d_neg(params, te
-00070df0: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
-00070e00: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00070e10: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00070e20: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
-00070e30: 5445 503a 0a20 2020 2020 2020 2020 2020  TEP:.           
-00070e40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00070e50: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00070e60: 666f 7277 6172 645f 7374 6570 2870 6172  forward_step(par
-00070e70: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00070e80: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
-00070e90: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00070ea0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00070eb0: 4d4c 5f4f 505f 5245 4c55 3a0a 2020 2020  ML_OP_RELU:.    
-00070ec0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00070ed0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00070ee0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
-00070ef0: 656c 7528 7061 7261 6d73 2c20 7465 6e73  elu(params, tens
-00070f00: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-00070f10: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00070f20: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00070f30: 6361 7365 2047 474d 4c5f 4f50 5f47 454c  case GGML_OP_GEL
-00070f40: 553a 0a20 2020 2020 2020 2020 2020 207b  U:.            {
-00070f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00070f60: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00070f70: 7277 6172 645f 6765 6c75 2870 6172 616d  rward_gelu(param
-00070f80: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-00070f90: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00070fa0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00070fb0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00070fc0: 5f4f 505f 5349 4c55 3a0a 2020 2020 2020  _OP_SILU:.      
-00070fd0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00070fe0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00070ff0: 7075 7465 5f66 6f72 7761 7264 5f73 696c  pute_forward_sil
-00071000: 7528 7061 7261 6d73 2c20 7465 6e73 6f72  u(params, tensor
-00071010: 2d3e 7372 6330 2c20 7465 6e73 6f72 293b  ->src0, tensor);
-00071020: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00071030: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00071040: 7365 2047 474d 4c5f 4f50 5f53 494c 555f  se GGML_OP_SILU_
-00071050: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
-00071060: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00071070: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00071080: 5f66 6f72 7761 7264 5f73 696c 755f 6261  _forward_silu_ba
-00071090: 636b 2870 6172 616d 732c 2074 656e 736f  ck(params, tenso
-000710a0: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
-000710b0: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
-000710c0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000710d0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000710e0: 6520 4747 4d4c 5f4f 505f 4e4f 524d 3a0a  e GGML_OP_NORM:.
-000710f0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00071100: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00071110: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00071120: 7264 5f6e 6f72 6d28 7061 7261 6d73 2c20  rd_norm(params, 
-00071130: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-00071140: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00071150: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00071160: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00071170: 5f52 4d53 5f4e 4f52 4d3a 0a20 2020 2020  _RMS_NORM:.     
-00071180: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00071190: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-000711a0: 6d70 7574 655f 666f 7277 6172 645f 726d  mpute_forward_rm
-000711b0: 735f 6e6f 726d 2870 6172 616d 732c 2074  s_norm(params, t
-000711c0: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-000711d0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-000711e0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-000711f0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00071200: 524d 535f 4e4f 524d 5f42 4143 4b3a 0a20  RMS_NORM_BACK:. 
-00071210: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00071220: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00071230: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00071240: 645f 726d 735f 6e6f 726d 5f62 6163 6b28  d_rms_norm_back(
-00071250: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00071260: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
-00071270: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
-00071280: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00071290: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000712a0: 474d 4c5f 4f50 5f4d 554c 5f4d 4154 3a0a  GML_OP_MUL_MAT:.
-000712b0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000712c0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-000712d0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000712e0: 7264 5f6d 756c 5f6d 6174 2870 6172 616d  rd_mul_mat(param
-000712f0: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-00071300: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
-00071310: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00071320: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00071330: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00071340: 505f 4f55 545f 5052 4f44 3a0a 2020 2020  P_OUT_PROD:.    
-00071350: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00071360: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00071370: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6f  ompute_forward_o
-00071380: 7574 5f70 726f 6428 7061 7261 6d73 2c20  ut_prod(params, 
-00071390: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-000713a0: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
-000713b0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-000713c0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000713d0: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
-000713e0: 4341 4c45 3a0a 2020 2020 2020 2020 2020  CALE:.          
-000713f0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00071400: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00071410: 5f66 6f72 7761 7264 5f73 6361 6c65 2870  _forward_scale(p
-00071420: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-00071430: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
-00071440: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
-00071450: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00071460: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00071470: 4d4c 5f4f 505f 5345 543a 0a20 2020 2020  ML_OP_SET:.     
-00071480: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00071490: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-000714a0: 6d70 7574 655f 666f 7277 6172 645f 7365  mpute_forward_se
-000714b0: 7428 7061 7261 6d73 2c20 7465 6e73 6f72  t(params, tensor
-000714c0: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
-000714d0: 7372 6331 2c20 7465 6e73 6f72 2d3e 6f70  src1, tensor->op
-000714e0: 745b 305d 2c20 7465 6e73 6f72 293b 0a20  t[0], tensor);. 
-000714f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00071500: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00071510: 2047 474d 4c5f 4f50 5f43 5059 3a0a 2020   GGML_OP_CPY:.  
-00071520: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00071530: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00071540: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00071550: 5f63 7079 2870 6172 616d 732c 2074 656e  _cpy(params, ten
-00071560: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00071570: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00071580: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00071590: 2063 6173 6520 4747 4d4c 5f4f 505f 434f   case GGML_OP_CO
-000715a0: 4e54 3a0a 2020 2020 2020 2020 2020 2020  NT:.            
-000715b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000715c0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-000715d0: 6f72 7761 7264 5f63 6f6e 7428 7061 7261  orward_cont(para
-000715e0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-000715f0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00071600: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00071610: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00071620: 4c5f 4f50 5f52 4553 4841 5045 3a0a 2020  L_OP_RESHAPE:.  
-00071630: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00071640: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00071650: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00071660: 5f72 6573 6861 7065 2870 6172 616d 732c  _reshape(params,
-00071670: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-00071680: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00071690: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-000716a0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000716b0: 505f 5649 4557 3a0a 2020 2020 2020 2020  P_VIEW:.        
-000716c0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000716d0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-000716e0: 7465 5f66 6f72 7761 7264 5f76 6965 7728  te_forward_view(
-000716f0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00071700: 7372 6330 293b 0a20 2020 2020 2020 2020  src0);.         
-00071710: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00071720: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00071730: 5f50 4552 4d55 5445 3a0a 2020 2020 2020  _PERMUTE:.      
-00071740: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00071750: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00071760: 7075 7465 5f66 6f72 7761 7264 5f70 6572  pute_forward_per
-00071770: 6d75 7465 2870 6172 616d 732c 2074 656e  mute(params, ten
-00071780: 736f 722d 3e73 7263 3029 3b0a 2020 2020  sor->src0);.    
-00071790: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000717a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000717b0: 4d4c 5f4f 505f 5452 414e 5350 4f53 453a  ML_OP_TRANSPOSE:
-000717c0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000717d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000717e0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000717f0: 6172 645f 7472 616e 7370 6f73 6528 7061  ard_transpose(pa
-00071800: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00071810: 6330 293b 0a20 2020 2020 2020 2020 2020  c0);.           
-00071820: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00071830: 2020 6361 7365 2047 474d 4c5f 4f50 5f47    case GGML_OP_G
-00071840: 4554 5f52 4f57 533a 0a20 2020 2020 2020  ET_ROWS:.       
-00071850: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00071860: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00071870: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
-00071880: 726f 7773 2870 6172 616d 732c 2074 656e  rows(params, ten
-00071890: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-000718a0: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
-000718b0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000718c0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-000718d0: 6173 6520 4747 4d4c 5f4f 505f 4745 545f  ase GGML_OP_GET_
-000718e0: 524f 5753 5f42 4143 4b3a 0a20 2020 2020  ROWS_BACK:.     
-000718f0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00071900: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00071910: 6d70 7574 655f 666f 7277 6172 645f 6765  mpute_forward_ge
-00071920: 745f 726f 7773 5f62 6163 6b28 7061 7261  t_rows_back(para
-00071930: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00071940: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
-00071950: 7465 6e73 6f72 2d3e 6f70 745b 305d 2c20  tensor->opt[0], 
-00071960: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00071970: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00071980: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00071990: 4f50 5f44 4941 473a 0a20 2020 2020 2020  OP_DIAG:.       
-000719a0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-000719b0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-000719c0: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
-000719d0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-000719e0: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
-000719f0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00071a00: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00071a10: 6520 4747 4d4c 5f4f 505f 4449 4147 5f4d  e GGML_OP_DIAG_M
-00071a20: 4153 4b5f 494e 463a 0a20 2020 2020 2020  ASK_INF:.       
-00071a30: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00071a40: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00071a50: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
-00071a60: 5f6d 6173 6b5f 696e 6628 7061 7261 6d73  _mask_inf(params
-00071a70: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00071a80: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
-00071a90: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00071aa0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00071ab0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00071ac0: 5f44 4941 475f 4d41 534b 5f5a 4552 4f3a  _DIAG_MASK_ZERO:
-00071ad0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00071ae0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00071af0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00071b00: 6172 645f 6469 6167 5f6d 6173 6b5f 7a65  ard_diag_mask_ze
-00071b10: 726f 2870 6172 616d 732c 2074 656e 736f  ro(params, tenso
-00071b20: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
-00071b30: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
-00071b40: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00071b50: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00071b60: 6520 4747 4d4c 5f4f 505f 534f 4654 5f4d  e GGML_OP_SOFT_M
-00071b70: 4158 3a0a 2020 2020 2020 2020 2020 2020  AX:.            
-00071b80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00071b90: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00071ba0: 6f72 7761 7264 5f73 6f66 745f 6d61 7828  orward_soft_max(
-00071bb0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00071bc0: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
-00071bd0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00071be0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00071bf0: 2047 474d 4c5f 4f50 5f53 4f46 545f 4d41   GGML_OP_SOFT_MA
-00071c00: 585f 4241 434b 3a0a 2020 2020 2020 2020  X_BACK:.        
-00071c10: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00071c20: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00071c30: 7465 5f66 6f72 7761 7264 5f73 6f66 745f  te_forward_soft_
-00071c40: 6d61 785f 6261 636b 2870 6172 616d 732c  max_back(params,
-00071c50: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-00071c60: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
-00071c70: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-00071c80: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00071c90: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00071ca0: 524f 5045 3a0a 2020 2020 2020 2020 2020  ROPE:.          
-00071cb0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00071cc0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00071cd0: 5f66 6f72 7761 7264 5f72 6f70 6528 7061  _forward_rope(pa
-00071ce0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00071cf0: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
-00071d00: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00071d10: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00071d20: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00071d30: 4c5f 4f50 5f52 4f50 455f 4241 434b 3a0a  L_OP_ROPE_BACK:.
-00071d40: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00071d50: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00071d60: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00071d70: 7264 5f72 6f70 655f 6261 636b 2870 6172  rd_rope_back(par
-00071d80: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00071d90: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
-00071da0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00071db0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00071dc0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00071dd0: 5f4f 505f 414c 4942 493a 0a20 2020 2020  _OP_ALIBI:.     
-00071de0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00071df0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00071e00: 6d70 7574 655f 666f 7277 6172 645f 616c  mpute_forward_al
-00071e10: 6962 6928 7061 7261 6d73 2c20 7465 6e73  ibi(params, tens
-00071e20: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-00071e30: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
-00071e40: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00071e50: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00071e60: 7365 2047 474d 4c5f 4f50 5f43 4c41 4d50  se GGML_OP_CLAMP
-00071e70: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00071e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00071e90: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00071ea0: 7761 7264 5f63 6c61 6d70 2870 6172 616d  ward_clamp(param
-00071eb0: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-00071ec0: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
-00071ed0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00071ee0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00071ef0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00071f00: 505f 434f 4e56 5f31 445f 3153 3a0a 2020  P_CONV_1D_1S:.  
-00071f10: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00071f20: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00071f30: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00071f40: 5f63 6f6e 765f 3164 5f31 7328 7061 7261  _conv_1d_1s(para
-00071f50: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00071f60: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
-00071f70: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00071f80: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00071f90: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00071fa0: 4f50 5f43 4f4e 565f 3144 5f32 533a 0a20  OP_CONV_1D_2S:. 
-00071fb0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00071fc0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00071fd0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00071fe0: 645f 636f 6e76 5f31 645f 3273 2870 6172  d_conv_1d_2s(par
-00071ff0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00072000: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
-00072010: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00072020: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00072030: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00072040: 5f4f 505f 464c 4153 485f 4154 544e 3a0a  _OP_FLASH_ATTN:.
-00072050: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00072060: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00072070: 7433 325f 7420 7420 3d20 6767 6d6c 5f67  t32_t t = ggml_g
-00072080: 6574 5f69 3332 5f31 6428 7465 6e73 6f72  et_i32_1d(tensor
-00072090: 2d3e 6f70 745b 315d 2c20 3029 3b0a 2020  ->opt[1], 0);.  
-000720a0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-000720b0: 4d4c 5f41 5353 4552 5428 7420 3d3d 2030  ML_ASSERT(t == 0
-000720c0: 207c 7c20 7420 3d3d 2031 293b 0a20 2020   || t == 1);.   
-000720d0: 2020 2020 2020 2020 2020 2020 2062 6f6f               boo
-000720e0: 6c20 6d61 736b 6564 203d 2074 2021 3d20  l masked = t != 
-000720f0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-00072100: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00072110: 666f 7277 6172 645f 666c 6173 685f 6174  forward_flash_at
-00072120: 746e 2870 6172 616d 732c 2074 656e 736f  tn(params, tenso
-00072130: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
-00072140: 3e73 7263 312c 2074 656e 736f 722d 3e6f  >src1, tensor->o
-00072150: 7074 5b30 5d2c 206d 6173 6b65 642c 2074  pt[0], masked, t
-00072160: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00072170: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00072180: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00072190: 505f 464c 4153 485f 4646 3a0a 2020 2020  P_FLASH_FF:.    
-000721a0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000721b0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-000721c0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f66  ompute_forward_f
-000721d0: 6c61 7368 5f66 6628 7061 7261 6d73 2c20  lash_ff(params, 
-000721e0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-000721f0: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
-00072200: 6f72 2d3e 6f70 745b 305d 2c20 7465 6e73  or->opt[0], tens
-00072210: 6f72 2d3e 6f70 745b 315d 2c20 7465 6e73  or->opt[1], tens
-00072220: 6f72 2d3e 6f70 745b 325d 2c20 7465 6e73  or->opt[2], tens
-00072230: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00072240: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00072250: 2020 6361 7365 2047 474d 4c5f 4f50 5f46    case GGML_OP_F
-00072260: 4c41 5348 5f41 5454 4e5f 4241 434b 3a0a  LASH_ATTN_BACK:.
-00072270: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00072280: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00072290: 7433 325f 7420 7420 3d20 6767 6d6c 5f67  t32_t t = ggml_g
-000722a0: 6574 5f69 3332 5f31 6428 7465 6e73 6f72  et_i32_1d(tensor
-000722b0: 2d3e 6f70 745b 325d 2c20 3029 3b0a 2020  ->opt[2], 0);.  
-000722c0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-000722d0: 4d4c 5f41 5353 4552 5428 7420 3d3d 2030  ML_ASSERT(t == 0
-000722e0: 207c 7c20 7420 3d3d 2031 293b 0a20 2020   || t == 1);.   
-000722f0: 2020 2020 2020 2020 2020 2020 2062 6f6f               boo
-00072300: 6c20 6d61 736b 6564 203d 2074 2021 3d20  l masked = t != 
-00072310: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-00072320: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00072330: 666f 7277 6172 645f 666c 6173 685f 6174  forward_flash_at
-00072340: 746e 5f62 6163 6b28 7061 7261 6d73 2c20  tn_back(params, 
-00072350: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-00072360: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
-00072370: 6f72 2d3e 6f70 745b 305d 2c20 7465 6e73  or->opt[0], tens
-00072380: 6f72 2d3e 6f70 745b 315d 2c20 6d61 736b  or->opt[1], mask
-00072390: 6564 2c20 7465 6e73 6f72 293b 0a20 2020  ed, tensor);.   
-000723a0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000723b0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000723c0: 474d 4c5f 4f50 5f4d 4150 5f55 4e41 5259  GML_OP_MAP_UNARY
-000723d0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000723e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000723f0: 636f 6e73 7420 6767 6d6c 5f75 6e61 7279  const ggml_unary
-00072400: 5f6f 705f 6633 325f 7420 6675 6e20 3d20  _op_f32_t fun = 
-00072410: 2a28 2867 676d 6c5f 756e 6172 795f 6f70  *((ggml_unary_op
-00072420: 5f66 3332 5f74 202a 2974 656e 736f 722d  _f32_t *)tensor-
-00072430: 3e6f 7074 5b30 5d2d 3e64 6174 6129 3b0a  >opt[0]->data);.
-00072440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072450: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00072460: 7761 7264 5f6d 6170 5f75 6e61 7279 2870  ward_map_unary(p
-00072470: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-00072480: 7263 302c 2074 656e 736f 722c 2066 756e  rc0, tensor, fun
-00072490: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000724a0: 0a20 2020 2020 2020 2020 2020 2062 7265  .            bre
-000724b0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-000724c0: 2047 474d 4c5f 4f50 5f4d 4150 5f42 494e   GGML_OP_MAP_BIN
-000724d0: 4152 593a 0a20 2020 2020 2020 2020 2020  ARY:.           
-000724e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000724f0: 2020 2063 6f6e 7374 2067 676d 6c5f 6269     const ggml_bi
-00072500: 6e61 7279 5f6f 705f 6633 325f 7420 6675  nary_op_f32_t fu
-00072510: 6e20 3d20 2a28 2867 676d 6c5f 6269 6e61  n = *((ggml_bina
-00072520: 7279 5f6f 705f 6633 325f 7420 2a29 7465  ry_op_f32_t *)te
-00072530: 6e73 6f72 2d3e 6f70 745b 305d 2d3e 6461  nsor->opt[0]->da
-00072540: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
-00072550: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00072560: 655f 666f 7277 6172 645f 6d61 705f 6269  e_forward_map_bi
-00072570: 6e61 7279 2870 6172 616d 732c 2074 656e  nary(params, ten
-00072580: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00072590: 722d 3e73 7263 312c 2074 656e 736f 722c  r->src1, tensor,
-000725a0: 2066 756e 293b 0a20 2020 2020 2020 2020   fun);.         
-000725b0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000725c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000725d0: 6361 7365 2047 474d 4c5f 4f50 5f43 524f  case GGML_OP_CRO
-000725e0: 5353 5f45 4e54 524f 5059 5f4c 4f53 533a  SS_ENTROPY_LOSS:
-000725f0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00072600: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00072610: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00072620: 6172 645f 6372 6f73 735f 656e 7472 6f70  ard_cross_entrop
-00072630: 795f 6c6f 7373 2870 6172 616d 732c 2074  y_loss(params, t
-00072640: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-00072650: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
-00072660: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00072670: 7d0a 2020 2020 2020 2020 2020 2020 6272  }.            br
-00072680: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00072690: 6520 4747 4d4c 5f4f 505f 4352 4f53 535f  e GGML_OP_CROSS_
-000726a0: 454e 5452 4f50 595f 4c4f 5353 5f42 4143  ENTROPY_LOSS_BAC
-000726b0: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
-000726c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000726d0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-000726e0: 7277 6172 645f 6372 6f73 735f 656e 7472  rward_cross_entr
-000726f0: 6f70 795f 6c6f 7373 5f62 6163 6b28 7061  opy_loss_back(pa
-00072700: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00072710: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
-00072720: 2c20 7465 6e73 6f72 2d3e 6f70 745b 305d  , tensor->opt[0]
-00072730: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00072740: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00072750: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
-00072760: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00072770: 5f4e 4f4e 453a 0a20 2020 2020 2020 2020  _NONE:.         
-00072780: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00072790: 2020 2020 202f 2f20 6e6f 700a 2020 2020       // nop.    
-000727a0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000727b0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000727c0: 4d4c 5f4f 505f 434f 554e 543a 0a20 2020  ML_OP_COUNT:.   
-000727d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000727e0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-000727f0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-00072800: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00072810: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f2f  ak;.    }.}..///
-00072820: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00072830: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00072840: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00072850: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00072860: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a 0a73  /////////////..s
-00072870: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00072880: 636f 6d70 7574 655f 6261 636b 7761 7264  compute_backward
-00072890: 2873 7472 7563 7420 6767 6d6c 5f63 6f6e  (struct ggml_con
-000728a0: 7465 7874 202a 2063 7478 2c20 7374 7275  text * ctx, stru
-000728b0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000728c0: 2074 656e 736f 722c 2062 6f6f 6c20 696e   tensor, bool in
-000728d0: 706c 6163 6529 207b 0a20 2020 2073 7472  place) {.    str
-000728e0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000728f0: 2a20 7372 6330 203d 2074 656e 736f 722d  * src0 = tensor-
-00072900: 3e73 7263 303b 0a20 2020 2073 7472 7563  >src0;.    struc
-00072910: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00072920: 7372 6331 203d 2074 656e 736f 722d 3e73  src1 = tensor->s
-00072930: 7263 313b 0a0a 2020 2020 7377 6974 6368  rc1;..    switch
-00072940: 2028 7465 6e73 6f72 2d3e 6f70 2920 7b0a   (tensor->op) {.
-00072950: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00072960: 4c5f 4f50 5f44 5550 3a0a 2020 2020 2020  L_OP_DUP:.      
-00072970: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00072980: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
-00072990: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-000729a0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-000729b0: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
-000729c0: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
-000729d0: 6330 2d3e 6772 6164 2c20 7465 6e73 6f72  c0->grad, tensor
-000729e0: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
-000729f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00072a00: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00072a10: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00072a20: 2063 6173 6520 4747 4d4c 5f4f 505f 4144   case GGML_OP_AD
-00072a30: 443a 0a20 2020 2020 2020 2020 2020 207b  D:.            {
-00072a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00072a50: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
-00072a60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00072a70: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-00072a80: 6420 3d20 6767 6d6c 5f61 6464 5f69 6d70  d = ggml_add_imp
-00072a90: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
-00072aa0: 642c 2074 656e 736f 722d 3e67 7261 642c  d, tensor->grad,
-00072ab0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-00072ac0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00072ad0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00072ae0: 2873 7263 312d 3e67 7261 6429 207b 0a20  (src1->grad) {. 
+0006f6b0: 7820 2a20 790a 2020 2020 2020 2020 2020  x * y.          
+0006f6c0: 2020 2f2f 2020 2070 6f73 746f 7264 6572    //   postorder
+0006f6d0: 3a0a 2020 2020 2020 2020 2020 2020 2f2f  :.            //
+0006f6e0: 2020 2064 6f74 5f73 7431 5f64 7374 3120     dot_st1_dst1 
+0006f6f0: 3a3d 2064 6f74 2873 7431 2c20 6772 6164  := dot(st1, grad
+0006f700: 5b73 7431 5d29 0a20 2020 2020 2020 2020  [st1]).         
+0006f710: 2020 202f 2f20 2020 6772 6164 5b73 305d     //   grad[s0]
+0006f720: 203a 3d20 6772 6164 5b73 7431 5d0a 2020   := grad[st1].  
+0006f730: 2020 2020 2020 2020 2020 2f2f 2020 2067            //   g
+0006f740: 7261 645b 7330 5d20 3a3d 2067 7261 645b  rad[s0] := grad[
+0006f750: 7330 5d20 2d20 646f 745f 7374 315f 6473  s0] - dot_st1_ds
+0006f760: 7431 0a20 2020 2020 2020 2020 2020 202f  t1.            /
+0006f770: 2f20 2020 6772 6164 5b73 305d 203a 3d20  /   grad[s0] := 
+0006f780: 6772 6164 5b73 305d 202a 2073 7431 0a0a  grad[s0] * st1..
+0006f790: 2020 2020 2020 2020 2020 2020 2f2f 2070              // p
+0006f7a0: 7265 7065 6e64 2070 6f73 746f 7264 6572  repend postorder
+0006f7b0: 2066 726f 6d20 6772 6164 5b73 7431 5d20   from grad[st1] 
+0006f7c0: 6469 7265 6374 6c79 2075 7369 6e67 2067  directly using g
+0006f7d0: 7261 645b 7330 5d20 6173 206d 656d 6f72  rad[s0] as memor
+0006f7e0: 7920 6c6f 6361 7469 6f6e 2c20 6173 2077  y location, as w
+0006f7f0: 6520 7769 6c6c 2067 7261 645b 7330 5d20  e will grad[s0] 
+0006f800: 3a3d 2067 7261 645b 7374 315d 0a20 2020  := grad[st1].   
+0006f810: 2020 2020 2020 2020 202f 2f20 736d 2020           // sm  
+0006f820: 2020 2020 2020 2020 203a 3d20 736f 6674           := soft
+0006f830: 6d61 7828 7330 290a 2020 2020 2020 2020  max(s0).        
+0006f840: 2020 2020 2f2f 2067 7261 645b 7330 5d20      // grad[s0] 
+0006f850: 2020 2020 3a3d 2073 6d2a 2831 2e30 202d      := sm*(1.0 -
+0006f860: 2065 7073 290a 2020 2020 2020 2020 2020   eps).          
+0006f870: 2020 2f2f 2067 7261 645b 7330 5d20 2020    // grad[s0]   
+0006f880: 2020 3a3d 2067 7261 645b 7330 5d20 2b20    := grad[s0] + 
+0006f890: 6570 730a 2020 2020 2020 2020 2020 2020  eps.            
+0006f8a0: 2f2f 2067 7261 645b 7330 5d20 2020 2020  // grad[s0]     
+0006f8b0: 3a3d 2073 3120 2f20 6772 6164 5b73 305d  := s1 / grad[s0]
+0006f8c0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0006f8d0: 6772 6164 5b73 305d 2020 2020 203a 3d20  grad[s0]     := 
+0006f8e0: 6772 6164 5b73 305d 2a28 312e 302d 6570  grad[s0]*(1.0-ep
+0006f8f0: 7329 2a2d 6772 6164 5b63 656c 5d0a 2020  s)*-grad[cel].  
+0006f900: 2020 2020 2020 2020 2020 2f2f 2064 6f74            // dot
+0006f910: 5f73 7431 5f64 7374 3120 3a3d 2064 6f74  _st1_dst1 := dot
+0006f920: 2873 6d2c 2067 7261 645b 7330 5d29 0a20  (sm, grad[s0]). 
+0006f930: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
+0006f940: 6164 5b73 305d 2020 2020 203a 3d20 6772  ad[s0]     := gr
+0006f950: 6164 5b73 305d 202d 2064 6f74 5f73 7431  ad[s0] - dot_st1
+0006f960: 5f64 7374 310a 2020 2020 2020 2020 2020  _dst1.          
+0006f970: 2020 2f2f 2067 7261 645b 7330 5d20 2020    // grad[s0]   
+0006f980: 2020 3a3d 2067 7261 645b 7330 5d20 2a20    := grad[s0] * 
+0006f990: 736d 0a20 2020 2020 2020 207d 0a0a 2020  sm.        }..  
+0006f9a0: 2020 2020 2020 2f2f 2073 6f66 745f 6d61        // soft_ma
+0006f9b0: 780a 2020 2020 2020 2020 6767 6d6c 5f66  x.        ggml_f
+0006f9c0: 6c6f 6174 2073 756d 203d 2030 2e30 3b0a  loat sum = 0.0;.
+0006f9d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0006f9e0: 2020 2020 2020 666c 6f61 7420 6d61 7820        float max 
+0006f9f0: 3d20 2d49 4e46 494e 4954 593b 0a20 2020  = -INFINITY;.   
+0006fa00: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+0006fa10: 635f 6d61 785f 6633 3228 6e63 2c20 266d  c_max_f32(nc, &m
+0006fa20: 6178 2c20 7330 293b 0a0a 2020 2020 2020  ax, s0);..      
+0006fa30: 2020 2020 2020 7569 6e74 3136 5f74 2073        uint16_t s
+0006fa40: 6376 743b 0a20 2020 2020 2020 2020 2020  cvt;.           
+0006fa50: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0006fa60: 2069 203c 206e 633b 2069 2b2b 2920 7b0a   i < nc; i++) {.
+0006fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006fa80: 6966 2028 7330 5b69 5d20 3d3d 202d 494e  if (s0[i] == -IN
+0006fa90: 4649 4e49 5459 2920 7b0a 2020 2020 2020  FINITY) {.      
+0006faa0: 2020 2020 2020 2020 2020 2020 2020 736d                sm
+0006fab0: 5b69 5d20 3d20 302e 3066 3b0a 2020 2020  [i] = 0.0f;.    
+0006fac0: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+0006fad0: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+0006fae0: 2020 2020 2020 2020 202f 2f20 636f 6e73           // cons
+0006faf0: 7420 666c 6f61 7420 7661 6c20 3d20 2873  t float val = (s
+0006fb00: 305b 695d 203d 3d20 2d49 4e46 494e 4954  0[i] == -INFINIT
+0006fb10: 5929 203f 2030 2e30 203a 2065 7870 2873  Y) ? 0.0 : exp(s
+0006fb20: 305b 695d 202d 206d 6178 293b 0a20 2020  0[i] - max);.   
+0006fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006fb40: 2067 676d 6c5f 6670 3136 5f74 2073 203d   ggml_fp16_t s =
+0006fb50: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
+0006fb60: 3136 2873 305b 695d 202d 206d 6178 293b  16(s0[i] - max);
+0006fb70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006fb80: 2020 2020 206d 656d 6370 7928 2673 6376       memcpy(&scv
+0006fb90: 742c 2026 732c 2073 697a 656f 6628 7363  t, &s, sizeof(sc
+0006fba0: 7674 2929 3b0a 2020 2020 2020 2020 2020  vt));.          
+0006fbb0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0006fbc0: 666c 6f61 7420 7661 6c20 3d20 4747 4d4c  float val = GGML
+0006fbd0: 5f46 5031 365f 544f 5f46 5033 3228 7461  _FP16_TO_FP32(ta
+0006fbe0: 626c 655f 6578 705f 6631 365b 7363 7674  ble_exp_f16[scvt
+0006fbf0: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
+0006fc00: 2020 2020 2020 2020 7375 6d20 2b3d 2028          sum += (
+0006fc10: 6767 6d6c 5f66 6c6f 6174 2976 616c 3b0a  ggml_float)val;.
+0006fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006fc30: 2020 2020 736d 5b69 5d20 3d20 7661 6c3b      sm[i] = val;
+0006fc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006fc50: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0006fc60: 0a0a 2020 2020 2020 2020 2020 2020 6173  ..            as
+0006fc70: 7365 7274 2873 756d 203e 2030 2e30 293b  sert(sum > 0.0);
+0006fc80: 0a20 2020 2020 2020 2020 2020 2073 756d  .            sum
+0006fc90: 203d 2031 2e30 2f73 756d 3b0a 2020 2020   = 1.0/sum;.    
+0006fca0: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
+0006fcb0: 6c6f 6174 2064 6f74 5f73 7431 5f64 7374  loat dot_st1_dst
+0006fcc0: 3120 3d20 303b 0a20 2020 2020 2020 2067  1 = 0;.        g
+0006fcd0: 676d 6c5f 7665 635f 7363 616c 655f 6633  gml_vec_scale_f3
+0006fce0: 3228 6e63 2c20 736d 2c20 7375 6d29 3b0a  2(nc, sm, sum);.
+0006fcf0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0006fd00: 5f63 7079 5f66 3332 2020 286e 632c 2064  _cpy_f32  (nc, d
+0006fd10: 7330 2c20 736d 293b 0a20 2020 2020 2020  s0, sm);.       
+0006fd20: 2067 676d 6c5f 7665 635f 7363 616c 655f   ggml_vec_scale_
+0006fd30: 6633 3228 6e63 2c20 6473 302c 2028 312e  f32(nc, ds0, (1.
+0006fd40: 3066 202d 2065 7073 2929 3b0a 2020 2020  0f - eps));.    
+0006fd50: 2020 2020 6767 6d6c 5f76 6563 5f61 6464      ggml_vec_add
+0006fd60: 315f 6633 3220 286e 632c 2064 7330 2c20  1_f32 (nc, ds0, 
+0006fd70: 6473 302c 2065 7073 293b 0a20 2020 2020  ds0, eps);.     
+0006fd80: 2020 2067 676d 6c5f 7665 635f 6469 765f     ggml_vec_div_
+0006fd90: 6633 3220 2028 6e63 2c20 6473 302c 2073  f32  (nc, ds0, s
+0006fda0: 312c 2064 7330 293b 0a20 2020 2020 2020  1, ds0);.       
+0006fdb0: 2067 676d 6c5f 7665 635f 7363 616c 655f   ggml_vec_scale_
+0006fdc0: 6633 3228 6e63 2c20 6473 302c 202d 2831  f32(nc, ds0, -(1
+0006fdd0: 2e30 6620 2d20 6570 7329 2a64 5b30 5d29  .0f - eps)*d[0])
+0006fde0: 3b0a 2020 2020 2020 2020 6767 6d6c 5f76  ;.        ggml_v
+0006fdf0: 6563 5f64 6f74 5f66 3332 2020 286e 632c  ec_dot_f32  (nc,
+0006fe00: 2026 646f 745f 7374 315f 6473 7431 2c20   &dot_st1_dst1, 
+0006fe10: 736d 2c20 6473 3029 3b0a 2020 2020 2020  sm, ds0);.      
+0006fe20: 2020 6767 6d6c 5f76 6563 5f61 6363 315f    ggml_vec_acc1_
+0006fe30: 6633 3220 286e 632c 2064 7330 2c20 2d64  f32 (nc, ds0, -d
+0006fe40: 6f74 5f73 7431 5f64 7374 3129 3b0a 2020  ot_st1_dst1);.  
+0006fe50: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
+0006fe60: 756c 5f66 3332 2020 286e 632c 2064 7330  ul_f32  (nc, ds0
+0006fe70: 2c20 6473 302c 2073 6d29 3b0a 0a23 6966  , ds0, sm);..#if
+0006fe80: 6e64 6566 204e 4445 4255 470a 2020 2020  ndef NDEBUG.    
+0006fe90: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+0006fea0: 2030 3b20 6920 3c20 6e63 3b20 2b2b 6929   0; i < nc; ++i)
+0006feb0: 207b 0a20 2020 2020 2020 2020 2020 2061   {.            a
+0006fec0: 7373 6572 7428 2169 736e 616e 2873 6d5b  ssert(!isnan(sm[
+0006fed0: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
+0006fee0: 2020 6173 7365 7274 2821 6973 696e 6628    assert(!isinf(
+0006fef0: 736d 5b69 5d29 293b 0a20 2020 2020 2020  sm[i]));.       
+0006ff00: 2020 2020 2061 7373 6572 7428 2169 736e       assert(!isn
+0006ff10: 616e 2864 7330 5b69 5d29 293b 0a20 2020  an(ds0[i]));.   
+0006ff20: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
+0006ff30: 2169 7369 6e66 2864 7330 5b69 5d29 293b  !isinf(ds0[i]));
+0006ff40: 0a20 2020 2020 2020 207d 0a23 656e 6469  .        }.#endi
+0006ff50: 660a 2020 2020 7d0a 7d0a 0a73 7461 7469  f.    }.}..stati
+0006ff60: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+0006ff70: 7574 655f 666f 7277 6172 645f 6372 6f73  ute_forward_cros
+0006ff80: 735f 656e 7472 6f70 795f 6c6f 7373 5f62  s_entropy_loss_b
+0006ff90: 6163 6b28 0a20 2020 2020 2020 2063 6f6e  ack(.        con
+0006ffa0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+0006ffb0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+0006ffc0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0006ffd0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0006ffe0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+0006fff0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00070000: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00070010: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+00070020: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00070030: 676d 6c5f 7465 6e73 6f72 202a 206f 7074  gml_tensor * opt
+00070040: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
+00070050: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00070060: 6473 7429 207b 0a20 2020 2073 7769 7463  dst) {.    switc
+00070070: 6820 2873 7263 302d 3e74 7970 6529 207b  h (src0->type) {
+00070080: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00070090: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
+000700a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000700b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000700c0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000700d0: 6372 6f73 735f 656e 7472 6f70 795f 6c6f  cross_entropy_lo
+000700e0: 7373 5f62 6163 6b5f 6633 3228 7061 7261  ss_back_f32(para
+000700f0: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+00070100: 6f70 7430 2c20 6473 7429 3b0a 2020 2020  opt0, dst);.    
+00070110: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00070120: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+00070130: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00070140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070150: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00070160: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00070170: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+00070180: 0a0a 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .../////////////
+00070190: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000701a0: 2f2f 2f2f 0a0a 7374 6174 6963 2076 6f69  ////..static voi
+000701b0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+000701c0: 6f72 7761 7264 2873 7472 7563 7420 6767  orward(struct gg
+000701d0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+000701e0: 7320 2a20 7061 7261 6d73 2c20 7374 7275  s * params, stru
+000701f0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00070200: 2074 656e 736f 7229 207b 0a20 2020 2047   tensor) {.    G
+00070210: 474d 4c5f 4153 5345 5254 2870 6172 616d  GML_ASSERT(param
+00070220: 7329 3b0a 0a23 6966 6465 6620 4747 4d4c  s);..#ifdef GGML
+00070230: 5f55 5345 5f43 5542 4c41 530a 2020 2020  _USE_CUBLAS.    
+00070240: 626f 6f6c 2073 6b69 705f 6370 7520 3d20  bool skip_cpu = 
+00070250: 6767 6d6c 5f63 7564 615f 636f 6d70 7574  ggml_cuda_comput
+00070260: 655f 666f 7277 6172 6428 7061 7261 6d73  e_forward(params
+00070270: 2c20 7465 6e73 6f72 293b 0a20 2020 2069  , tensor);.    i
+00070280: 6620 2873 6b69 705f 6370 7529 207b 0a20  f (skip_cpu) {. 
+00070290: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+000702a0: 2020 207d 0a20 2020 2047 474d 4c5f 4153     }.    GGML_AS
+000702b0: 5345 5254 2874 656e 736f 722d 3e73 7263  SERT(tensor->src
+000702c0: 302d 3e62 6163 6b65 6e64 203d 3d20 4747  0->backend == GG
+000702d0: 4d4c 5f42 4143 4b45 4e44 5f43 5055 293b  ML_BACKEND_CPU);
+000702e0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000702f0: 2874 656e 736f 722d 3e73 7263 3120 3d3d  (tensor->src1 ==
+00070300: 204e 554c 4c20 7c7c 2074 656e 736f 722d   NULL || tensor-
+00070310: 3e73 7263 312d 3e62 6163 6b65 6e64 203d  >src1->backend =
+00070320: 3d20 4747 4d4c 5f42 4143 4b45 4e44 5f43  = GGML_BACKEND_C
+00070330: 5055 293b 0a23 656e 6469 6620 2f2f 2047  PU);.#endif // G
+00070340: 474d 4c5f 5553 455f 4355 424c 4153 0a0a  GML_USE_CUBLAS..
+00070350: 2020 2020 7377 6974 6368 2028 7465 6e73      switch (tens
+00070360: 6f72 2d3e 6f70 2920 7b0a 2020 2020 2020  or->op) {.      
+00070370: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
+00070380: 5550 3a0a 2020 2020 2020 2020 2020 2020  UP:.            
+00070390: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000703a0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+000703b0: 6f72 7761 7264 5f64 7570 2870 6172 616d  orward_dup(param
+000703c0: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+000703d0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+000703e0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+000703f0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00070400: 5f4f 505f 4144 443a 0a20 2020 2020 2020  _OP_ADD:.       
+00070410: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00070420: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00070430: 7574 655f 666f 7277 6172 645f 6164 6428  ute_forward_add(
+00070440: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00070450: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+00070460: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
+00070470: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00070480: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00070490: 474d 4c5f 4f50 5f41 4444 313a 0a20 2020  GML_OP_ADD1:.   
+000704a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000704b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000704c0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000704d0: 6164 6431 2870 6172 616d 732c 2074 656e  add1(params, ten
+000704e0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+000704f0: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
+00070500: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00070510: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00070520: 6173 6520 4747 4d4c 5f4f 505f 4143 433a  ase GGML_OP_ACC:
+00070530: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00070540: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00070550: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00070560: 6172 645f 6163 6328 7061 7261 6d73 2c20  ard_acc(params, 
+00070570: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+00070580: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
+00070590: 6f72 2d3e 6f70 745b 305d 2c20 7465 6e73  or->opt[0], tens
+000705a0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+000705b0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+000705c0: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+000705d0: 5542 3a0a 2020 2020 2020 2020 2020 2020  UB:.            
+000705e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000705f0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00070600: 6f72 7761 7264 5f73 7562 2870 6172 616d  orward_sub(param
+00070610: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00070620: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
+00070630: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+00070640: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00070650: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00070660: 505f 4d55 4c3a 0a20 2020 2020 2020 2020  P_MUL:.         
+00070670: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00070680: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00070690: 655f 666f 7277 6172 645f 6d75 6c28 7061  e_forward_mul(pa
+000706a0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+000706b0: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
+000706c0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+000706d0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000706e0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000706f0: 4c5f 4f50 5f44 4956 3a0a 2020 2020 2020  L_OP_DIV:.      
+00070700: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00070710: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00070720: 7075 7465 5f66 6f72 7761 7264 5f64 6976  pute_forward_div
+00070730: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00070740: 3e73 7263 302c 2074 656e 736f 722d 3e73  >src0, tensor->s
+00070750: 7263 312c 2074 656e 736f 7229 3b0a 2020  rc1, tensor);.  
+00070760: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00070770: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00070780: 4747 4d4c 5f4f 505f 5351 523a 0a20 2020  GGML_OP_SQR:.   
+00070790: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000707a0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000707b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000707c0: 7371 7228 7061 7261 6d73 2c20 7465 6e73  sqr(params, tens
+000707d0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+000707e0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000707f0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00070800: 6361 7365 2047 474d 4c5f 4f50 5f53 5152  case GGML_OP_SQR
+00070810: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
+00070820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00070830: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00070840: 7277 6172 645f 7371 7274 2870 6172 616d  rward_sqrt(param
+00070850: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00070860: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00070870: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00070880: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00070890: 5f4f 505f 4c4f 473a 0a20 2020 2020 2020  _OP_LOG:.       
+000708a0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000708b0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+000708c0: 7574 655f 666f 7277 6172 645f 6c6f 6728  ute_forward_log(
+000708d0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+000708e0: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
+000708f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00070900: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00070910: 2047 474d 4c5f 4f50 5f53 554d 3a0a 2020   GGML_OP_SUM:.  
+00070920: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00070930: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00070940: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00070950: 5f73 756d 2870 6172 616d 732c 2074 656e  _sum(params, ten
+00070960: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+00070970: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00070980: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00070990: 2063 6173 6520 4747 4d4c 5f4f 505f 5355   case GGML_OP_SU
+000709a0: 4d5f 524f 5753 3a0a 2020 2020 2020 2020  M_ROWS:.        
+000709b0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000709c0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+000709d0: 7465 5f66 6f72 7761 7264 5f73 756d 5f72  te_forward_sum_r
+000709e0: 6f77 7328 7061 7261 6d73 2c20 7465 6e73  ows(params, tens
+000709f0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+00070a00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00070a10: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00070a20: 6361 7365 2047 474d 4c5f 4f50 5f4d 4541  case GGML_OP_MEA
+00070a30: 4e3a 0a20 2020 2020 2020 2020 2020 207b  N:.            {
+00070a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00070a50: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00070a60: 7277 6172 645f 6d65 616e 2870 6172 616d  rward_mean(param
+00070a70: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00070a80: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00070a90: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00070aa0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00070ab0: 5f4f 505f 5245 5045 4154 3a0a 2020 2020  _OP_REPEAT:.    
+00070ac0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00070ad0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00070ae0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+00070af0: 6570 6561 7428 7061 7261 6d73 2c20 7465  epeat(params, te
+00070b00: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
+00070b10: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00070b20: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00070b30: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
+00070b40: 4550 4541 545f 4241 434b 3a0a 2020 2020  EPEAT_BACK:.    
+00070b50: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00070b60: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00070b70: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+00070b80: 6570 6561 745f 6261 636b 2870 6172 616d  epeat_back(param
+00070b90: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00070ba0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00070bb0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00070bc0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00070bd0: 5f4f 505f 4142 533a 0a20 2020 2020 2020  _OP_ABS:.       
+00070be0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00070bf0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00070c00: 7574 655f 666f 7277 6172 645f 6162 7328  ute_forward_abs(
+00070c10: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00070c20: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
+00070c30: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00070c40: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00070c50: 2047 474d 4c5f 4f50 5f53 474e 3a0a 2020   GGML_OP_SGN:.  
+00070c60: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00070c70: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00070c80: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00070c90: 5f73 676e 2870 6172 616d 732c 2074 656e  _sgn(params, ten
+00070ca0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+00070cb0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00070cc0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00070cd0: 2063 6173 6520 4747 4d4c 5f4f 505f 4e45   case GGML_OP_NE
+00070ce0: 473a 0a20 2020 2020 2020 2020 2020 207b  G:.            {
+00070cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00070d00: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00070d10: 7277 6172 645f 6e65 6728 7061 7261 6d73  rward_neg(params
+00070d20: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+00070d30: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+00070d40: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00070d50: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00070d60: 4f50 5f53 5445 503a 0a20 2020 2020 2020  OP_STEP:.       
+00070d70: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00070d80: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00070d90: 7574 655f 666f 7277 6172 645f 7374 6570  ute_forward_step
+00070da0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00070db0: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
+00070dc0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00070dd0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00070de0: 6520 4747 4d4c 5f4f 505f 5245 4c55 3a0a  e GGML_OP_RELU:.
+00070df0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00070e00: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00070e10: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00070e20: 7264 5f72 656c 7528 7061 7261 6d73 2c20  rd_relu(params, 
+00070e30: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+00070e40: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+00070e50: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00070e60: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00070e70: 5f47 454c 553a 0a20 2020 2020 2020 2020  _GELU:.         
+00070e80: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00070e90: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00070ea0: 655f 666f 7277 6172 645f 6765 6c75 2870  e_forward_gelu(p
+00070eb0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00070ec0: 7263 302c 2074 656e 736f 7229 3b0a 2020  rc0, tensor);.  
+00070ed0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00070ee0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00070ef0: 4747 4d4c 5f4f 505f 5349 4c55 3a0a 2020  GGML_OP_SILU:.  
+00070f00: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00070f10: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00070f20: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00070f30: 5f73 696c 7528 7061 7261 6d73 2c20 7465  _silu(params, te
+00070f40: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
+00070f50: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00070f60: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00070f70: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+00070f80: 494c 555f 4241 434b 3a0a 2020 2020 2020  ILU_BACK:.      
+00070f90: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00070fa0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00070fb0: 7075 7465 5f66 6f72 7761 7264 5f73 696c  pute_forward_sil
+00070fc0: 755f 6261 636b 2870 6172 616d 732c 2074  u_back(params, t
+00070fd0: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+00070fe0: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
+00070ff0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00071000: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00071010: 2063 6173 6520 4747 4d4c 5f4f 505f 4e4f   case GGML_OP_NO
+00071020: 524d 3a0a 2020 2020 2020 2020 2020 2020  RM:.            
+00071030: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00071040: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00071050: 6f72 7761 7264 5f6e 6f72 6d28 7061 7261  orward_norm(para
+00071060: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+00071070: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+00071080: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00071090: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000710a0: 4c5f 4f50 5f52 4d53 5f4e 4f52 4d3a 0a20  L_OP_RMS_NORM:. 
+000710b0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000710c0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000710d0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000710e0: 645f 726d 735f 6e6f 726d 2870 6172 616d  d_rms_norm(param
+000710f0: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00071100: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00071110: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00071120: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00071130: 5f4f 505f 524d 535f 4e4f 524d 5f42 4143  _OP_RMS_NORM_BAC
+00071140: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
+00071150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00071160: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00071170: 7277 6172 645f 726d 735f 6e6f 726d 5f62  rward_rms_norm_b
+00071180: 6163 6b28 7061 7261 6d73 2c20 7465 6e73  ack(params, tens
+00071190: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+000711a0: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
+000711b0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000711c0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+000711d0: 7365 2047 474d 4c5f 4f50 5f4d 554c 5f4d  se GGML_OP_MUL_M
+000711e0: 4154 3a0a 2020 2020 2020 2020 2020 2020  AT:.            
+000711f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00071200: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00071210: 6f72 7761 7264 5f6d 756c 5f6d 6174 2870  orward_mul_mat(p
+00071220: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00071230: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
+00071240: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
+00071250: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00071260: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00071270: 4d4c 5f4f 505f 4f55 545f 5052 4f44 3a0a  ML_OP_OUT_PROD:.
+00071280: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00071290: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000712a0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000712b0: 7264 5f6f 7574 5f70 726f 6428 7061 7261  rd_out_prod(para
+000712c0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+000712d0: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
+000712e0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+000712f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00071300: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00071310: 4f50 5f53 4341 4c45 3a0a 2020 2020 2020  OP_SCALE:.      
+00071320: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00071330: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00071340: 7075 7465 5f66 6f72 7761 7264 5f73 6361  pute_forward_sca
+00071350: 6c65 2870 6172 616d 732c 2074 656e 736f  le(params, tenso
+00071360: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
+00071370: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
+00071380: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00071390: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000713a0: 6520 4747 4d4c 5f4f 505f 5345 543a 0a20  e GGML_OP_SET:. 
+000713b0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000713c0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000713d0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000713e0: 645f 7365 7428 7061 7261 6d73 2c20 7465  d_set(params, te
+000713f0: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
+00071400: 6f72 2d3e 7372 6331 2c20 7465 6e73 6f72  or->src1, tensor
+00071410: 2d3e 6f70 745b 305d 2c20 7465 6e73 6f72  ->opt[0], tensor
+00071420: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00071430: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00071440: 6361 7365 2047 474d 4c5f 4f50 5f43 5059  case GGML_OP_CPY
+00071450: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00071460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00071470: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00071480: 7761 7264 5f63 7079 2870 6172 616d 732c  ward_cpy(params,
+00071490: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+000714a0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+000714b0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000714c0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000714d0: 505f 434f 4e54 3a0a 2020 2020 2020 2020  P_CONT:.        
+000714e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000714f0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00071500: 7465 5f66 6f72 7761 7264 5f63 6f6e 7428  te_forward_cont(
+00071510: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00071520: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
+00071530: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00071540: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00071550: 2047 474d 4c5f 4f50 5f52 4553 4841 5045   GGML_OP_RESHAPE
+00071560: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00071570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00071580: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00071590: 7761 7264 5f72 6573 6861 7065 2870 6172  ward_reshape(par
+000715a0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+000715b0: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
+000715c0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+000715d0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000715e0: 4d4c 5f4f 505f 5649 4557 3a0a 2020 2020  ML_OP_VIEW:.    
+000715f0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00071600: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00071610: 6f6d 7075 7465 5f66 6f72 7761 7264 5f76  ompute_forward_v
+00071620: 6965 7728 7061 7261 6d73 2c20 7465 6e73  iew(params, tens
+00071630: 6f72 2d3e 7372 6330 293b 0a20 2020 2020  or->src0);.     
+00071640: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00071650: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00071660: 4c5f 4f50 5f50 4552 4d55 5445 3a0a 2020  L_OP_PERMUTE:.  
+00071670: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00071680: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00071690: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+000716a0: 5f70 6572 6d75 7465 2870 6172 616d 732c  _permute(params,
+000716b0: 2074 656e 736f 722d 3e73 7263 3029 3b0a   tensor->src0);.
+000716c0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000716d0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000716e0: 6520 4747 4d4c 5f4f 505f 5452 414e 5350  e GGML_OP_TRANSP
+000716f0: 4f53 453a 0a20 2020 2020 2020 2020 2020  OSE:.           
+00071700: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00071710: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00071720: 666f 7277 6172 645f 7472 616e 7370 6f73  forward_transpos
+00071730: 6528 7061 7261 6d73 2c20 7465 6e73 6f72  e(params, tensor
+00071740: 2d3e 7372 6330 293b 0a20 2020 2020 2020  ->src0);.       
+00071750: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00071760: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00071770: 4f50 5f47 4554 5f52 4f57 533a 0a20 2020  OP_GET_ROWS:.   
+00071780: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00071790: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000717a0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000717b0: 6765 745f 726f 7773 2870 6172 616d 732c  get_rows(params,
+000717c0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+000717d0: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
+000717e0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+000717f0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00071800: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00071810: 4745 545f 524f 5753 5f42 4143 4b3a 0a20  GET_ROWS_BACK:. 
+00071820: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00071830: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00071840: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00071850: 645f 6765 745f 726f 7773 5f62 6163 6b28  d_get_rows_back(
+00071860: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00071870: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+00071880: 6331 2c20 7465 6e73 6f72 2d3e 6f70 745b  c1, tensor->opt[
+00071890: 305d 2c20 7465 6e73 6f72 293b 0a20 2020  0], tensor);.   
+000718a0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+000718b0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+000718c0: 474d 4c5f 4f50 5f44 4941 473a 0a20 2020  GML_OP_DIAG:.   
+000718d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000718e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000718f0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00071900: 6469 6167 2870 6172 616d 732c 2074 656e  diag(params, ten
+00071910: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+00071920: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00071930: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00071940: 2063 6173 6520 4747 4d4c 5f4f 505f 4449   case GGML_OP_DI
+00071950: 4147 5f4d 4153 4b5f 494e 463a 0a20 2020  AG_MASK_INF:.   
+00071960: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00071970: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00071980: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00071990: 6469 6167 5f6d 6173 6b5f 696e 6628 7061  diag_mask_inf(pa
+000719a0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+000719b0: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
+000719c0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+000719d0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+000719e0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000719f0: 4c5f 4f50 5f44 4941 475f 4d41 534b 5f5a  L_OP_DIAG_MASK_Z
+00071a00: 4552 4f3a 0a20 2020 2020 2020 2020 2020  ERO:.           
+00071a10: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00071a20: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00071a30: 666f 7277 6172 645f 6469 6167 5f6d 6173  forward_diag_mas
+00071a40: 6b5f 7a65 726f 2870 6172 616d 732c 2074  k_zero(params, t
+00071a50: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+00071a60: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
+00071a70: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00071a80: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00071a90: 2063 6173 6520 4747 4d4c 5f4f 505f 534f   case GGML_OP_SO
+00071aa0: 4654 5f4d 4158 3a0a 2020 2020 2020 2020  FT_MAX:.        
+00071ab0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00071ac0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00071ad0: 7465 5f66 6f72 7761 7264 5f73 6f66 745f  te_forward_soft_
+00071ae0: 6d61 7828 7061 7261 6d73 2c20 7465 6e73  max(params, tens
+00071af0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+00071b00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00071b10: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00071b20: 6361 7365 2047 474d 4c5f 4f50 5f53 4f46  case GGML_OP_SOF
+00071b30: 545f 4d41 585f 4241 434b 3a0a 2020 2020  T_MAX_BACK:.    
+00071b40: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00071b50: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00071b60: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00071b70: 6f66 745f 6d61 785f 6261 636b 2870 6172  oft_max_back(par
+00071b80: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00071b90: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
+00071ba0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00071bb0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00071bc0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00071bd0: 5f4f 505f 524f 5045 3a0a 2020 2020 2020  _OP_ROPE:.      
+00071be0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00071bf0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00071c00: 7075 7465 5f66 6f72 7761 7264 5f72 6f70  pute_forward_rop
+00071c10: 6528 7061 7261 6d73 2c20 7465 6e73 6f72  e(params, tensor
+00071c20: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
+00071c30: 7372 6331 2c20 7465 6e73 6f72 293b 0a20  src1, tensor);. 
+00071c40: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00071c50: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00071c60: 2047 474d 4c5f 4f50 5f52 4f50 455f 4241   GGML_OP_ROPE_BA
+00071c70: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+00071c80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00071c90: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00071ca0: 6f72 7761 7264 5f72 6f70 655f 6261 636b  orward_rope_back
+00071cb0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00071cc0: 3e73 7263 302c 2074 656e 736f 722d 3e73  >src0, tensor->s
+00071cd0: 7263 312c 2074 656e 736f 7229 3b0a 2020  rc1, tensor);.  
+00071ce0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00071cf0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00071d00: 4747 4d4c 5f4f 505f 414c 4942 493a 0a20  GGML_OP_ALIBI:. 
+00071d10: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00071d20: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00071d30: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00071d40: 645f 616c 6962 6928 7061 7261 6d73 2c20  d_alibi(params, 
+00071d50: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+00071d60: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
+00071d70: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00071d80: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00071d90: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
+00071da0: 4c41 4d50 3a0a 2020 2020 2020 2020 2020  LAMP:.          
+00071db0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00071dc0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00071dd0: 5f66 6f72 7761 7264 5f63 6c61 6d70 2870  _forward_clamp(p
+00071de0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00071df0: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
+00071e00: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
+00071e10: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00071e20: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00071e30: 4d4c 5f4f 505f 434f 4e56 5f31 445f 3153  ML_OP_CONV_1D_1S
+00071e40: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00071e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00071e60: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00071e70: 7761 7264 5f63 6f6e 765f 3164 5f31 7328  ward_conv_1d_1s(
+00071e80: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00071e90: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+00071ea0: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
+00071eb0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00071ec0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00071ed0: 474d 4c5f 4f50 5f43 4f4e 565f 3144 5f32  GML_OP_CONV_1D_2
+00071ee0: 533a 0a20 2020 2020 2020 2020 2020 207b  S:.            {
+00071ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00071f00: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00071f10: 7277 6172 645f 636f 6e76 5f31 645f 3273  rward_conv_1d_2s
+00071f20: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00071f30: 3e73 7263 302c 2074 656e 736f 722d 3e73  >src0, tensor->s
+00071f40: 7263 312c 2074 656e 736f 7229 3b0a 2020  rc1, tensor);.  
+00071f50: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00071f60: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00071f70: 4747 4d4c 5f4f 505f 464c 4153 485f 4154  GGML_OP_FLASH_AT
+00071f80: 544e 3a0a 2020 2020 2020 2020 2020 2020  TN:.            
+00071f90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00071fa0: 2020 696e 7433 325f 7420 7420 3d20 6767    int32_t t = gg
+00071fb0: 6d6c 5f67 6574 5f69 3332 5f31 6428 7465  ml_get_i32_1d(te
+00071fc0: 6e73 6f72 2d3e 6f70 745b 315d 2c20 3029  nsor->opt[1], 0)
+00071fd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00071fe0: 2020 4747 4d4c 5f41 5353 4552 5428 7420    GGML_ASSERT(t 
+00071ff0: 3d3d 2030 207c 7c20 7420 3d3d 2031 293b  == 0 || t == 1);
+00072000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072010: 2062 6f6f 6c20 6d61 736b 6564 203d 2074   bool masked = t
+00072020: 2021 3d20 303b 0a20 2020 2020 2020 2020   != 0;.         
+00072030: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00072040: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
+00072050: 685f 6174 746e 2870 6172 616d 732c 2074  h_attn(params, t
+00072060: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+00072070: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
+00072080: 722d 3e6f 7074 5b30 5d2c 206d 6173 6b65  r->opt[0], maske
+00072090: 642c 2074 656e 736f 7229 3b0a 2020 2020  d, tensor);.    
+000720a0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+000720b0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000720c0: 4d4c 5f4f 505f 464c 4153 485f 4646 3a0a  ML_OP_FLASH_FF:.
+000720d0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000720e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000720f0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00072100: 7264 5f66 6c61 7368 5f66 6628 7061 7261  rd_flash_ff(para
+00072110: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+00072120: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
+00072130: 7465 6e73 6f72 2d3e 6f70 745b 305d 2c20  tensor->opt[0], 
+00072140: 7465 6e73 6f72 2d3e 6f70 745b 315d 2c20  tensor->opt[1], 
+00072150: 7465 6e73 6f72 2d3e 6f70 745b 325d 2c20  tensor->opt[2], 
+00072160: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+00072170: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00072180: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00072190: 4f50 5f46 4c41 5348 5f41 5454 4e5f 4241  OP_FLASH_ATTN_BA
+000721a0: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+000721b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000721c0: 2020 696e 7433 325f 7420 7420 3d20 6767    int32_t t = gg
+000721d0: 6d6c 5f67 6574 5f69 3332 5f31 6428 7465  ml_get_i32_1d(te
+000721e0: 6e73 6f72 2d3e 6f70 745b 325d 2c20 3029  nsor->opt[2], 0)
+000721f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00072200: 2020 4747 4d4c 5f41 5353 4552 5428 7420    GGML_ASSERT(t 
+00072210: 3d3d 2030 207c 7c20 7420 3d3d 2031 293b  == 0 || t == 1);
+00072220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072230: 2062 6f6f 6c20 6d61 736b 6564 203d 2074   bool masked = t
+00072240: 2021 3d20 303b 0a20 2020 2020 2020 2020   != 0;.         
+00072250: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00072260: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
+00072270: 685f 6174 746e 5f62 6163 6b28 7061 7261  h_attn_back(para
+00072280: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+00072290: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
+000722a0: 7465 6e73 6f72 2d3e 6f70 745b 305d 2c20  tensor->opt[0], 
+000722b0: 7465 6e73 6f72 2d3e 6f70 745b 315d 2c20  tensor->opt[1], 
+000722c0: 6d61 736b 6564 2c20 7465 6e73 6f72 293b  masked, tensor);
+000722d0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000722e0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+000722f0: 7365 2047 474d 4c5f 4f50 5f4d 4150 5f55  se GGML_OP_MAP_U
+00072300: 4e41 5259 3a0a 2020 2020 2020 2020 2020  NARY:.          
+00072310: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00072320: 2020 2020 636f 6e73 7420 6767 6d6c 5f75      const ggml_u
+00072330: 6e61 7279 5f6f 705f 6633 325f 7420 6675  nary_op_f32_t fu
+00072340: 6e20 3d20 2a28 2867 676d 6c5f 756e 6172  n = *((ggml_unar
+00072350: 795f 6f70 5f66 3332 5f74 202a 2974 656e  y_op_f32_t *)ten
+00072360: 736f 722d 3e6f 7074 5b30 5d2d 3e64 6174  sor->opt[0]->dat
+00072370: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
+00072380: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00072390: 5f66 6f72 7761 7264 5f6d 6170 5f75 6e61  _forward_map_una
+000723a0: 7279 2870 6172 616d 732c 2074 656e 736f  ry(params, tenso
+000723b0: 722d 3e73 7263 302c 2074 656e 736f 722c  r->src0, tensor,
+000723c0: 2066 756e 293b 0a20 2020 2020 2020 2020   fun);.         
+000723d0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+000723e0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000723f0: 6361 7365 2047 474d 4c5f 4f50 5f4d 4150  case GGML_OP_MAP
+00072400: 5f42 494e 4152 593a 0a20 2020 2020 2020  _BINARY:.       
+00072410: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00072420: 2020 2020 2020 2063 6f6e 7374 2067 676d         const ggm
+00072430: 6c5f 6269 6e61 7279 5f6f 705f 6633 325f  l_binary_op_f32_
+00072440: 7420 6675 6e20 3d20 2a28 2867 676d 6c5f  t fun = *((ggml_
+00072450: 6269 6e61 7279 5f6f 705f 6633 325f 7420  binary_op_f32_t 
+00072460: 2a29 7465 6e73 6f72 2d3e 6f70 745b 305d  *)tensor->opt[0]
+00072470: 2d3e 6461 7461 293b 0a20 2020 2020 2020  ->data);.       
+00072480: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00072490: 6d70 7574 655f 666f 7277 6172 645f 6d61  mpute_forward_ma
+000724a0: 705f 6269 6e61 7279 2870 6172 616d 732c  p_binary(params,
+000724b0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+000724c0: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
+000724d0: 736f 722c 2066 756e 293b 0a20 2020 2020  sor, fun);.     
+000724e0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000724f0: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
+00072500: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00072510: 5f43 524f 5353 5f45 4e54 524f 5059 5f4c  _CROSS_ENTROPY_L
+00072520: 4f53 533a 0a20 2020 2020 2020 2020 2020  OSS:.           
+00072530: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00072540: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00072550: 666f 7277 6172 645f 6372 6f73 735f 656e  forward_cross_en
+00072560: 7472 6f70 795f 6c6f 7373 2870 6172 616d  tropy_loss(param
+00072570: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00072580: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
+00072590: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+000725a0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000725b0: 2020 6272 6561 6b3b 0a20 2020 2020 2020    break;.       
+000725c0: 2063 6173 6520 4747 4d4c 5f4f 505f 4352   case GGML_OP_CR
+000725d0: 4f53 535f 454e 5452 4f50 595f 4c4f 5353  OSS_ENTROPY_LOSS
+000725e0: 5f42 4143 4b3a 0a20 2020 2020 2020 2020  _BACK:.         
+000725f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00072600: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00072610: 655f 666f 7277 6172 645f 6372 6f73 735f  e_forward_cross_
+00072620: 656e 7472 6f70 795f 6c6f 7373 5f62 6163  entropy_loss_bac
+00072630: 6b28 7061 7261 6d73 2c20 7465 6e73 6f72  k(params, tensor
+00072640: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
+00072650: 7372 6331 2c20 7465 6e73 6f72 2d3e 6f70  src1, tensor->op
+00072660: 745b 305d 2c20 7465 6e73 6f72 293b 0a20  t[0], tensor);. 
+00072670: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00072680: 2020 2020 2020 2020 2062 7265 616b 3b0a           break;.
+00072690: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000726a0: 4c5f 4f50 5f4e 4f4e 453a 0a20 2020 2020  L_OP_NONE:.     
+000726b0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000726c0: 2020 2020 2020 2020 202f 2f20 6e6f 700a           // nop.
+000726d0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000726e0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000726f0: 6520 4747 4d4c 5f4f 505f 434f 554e 543a  e GGML_OP_COUNT:
+00072700: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00072710: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00072720: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00072730: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00072740: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+00072750: 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .///////////////
+00072760: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00072770: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00072780: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00072790: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000727a0: 2f0a 0a73 7461 7469 6320 766f 6964 2067  /..static void g
+000727b0: 676d 6c5f 636f 6d70 7574 655f 6261 636b  gml_compute_back
+000727c0: 7761 7264 2873 7472 7563 7420 6767 6d6c  ward(struct ggml
+000727d0: 5f63 6f6e 7465 7874 202a 2063 7478 2c20  _context * ctx, 
+000727e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000727f0: 6f72 202a 2074 656e 736f 722c 2062 6f6f  or * tensor, boo
+00072800: 6c20 696e 706c 6163 6529 207b 0a20 2020  l inplace) {.   
+00072810: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00072820: 736f 7220 2a20 7372 6330 203d 2074 656e  sor * src0 = ten
+00072830: 736f 722d 3e73 7263 303b 0a20 2020 2073  sor->src0;.    s
+00072840: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00072850: 7220 2a20 7372 6331 203d 2074 656e 736f  r * src1 = tenso
+00072860: 722d 3e73 7263 313b 0a0a 2020 2020 7377  r->src1;..    sw
+00072870: 6974 6368 2028 7465 6e73 6f72 2d3e 6f70  itch (tensor->op
+00072880: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+00072890: 2047 474d 4c5f 4f50 5f44 5550 3a0a 2020   GGML_OP_DUP:.  
+000728a0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000728b0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+000728c0: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+000728d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000728e0: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
+000728f0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+00072900: 2c20 7372 6330 2d3e 6772 6164 2c20 7465  , src0->grad, te
+00072910: 6e73 6f72 2d3e 6772 6164 2c20 696e 706c  nsor->grad, inpl
+00072920: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+00072930: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00072940: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00072950: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00072960: 505f 4144 443a 0a20 2020 2020 2020 2020  P_ADD:.         
+00072970: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00072980: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+00072990: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+000729a0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+000729b0: 3e67 7261 6420 3d20 6767 6d6c 5f61 6464  >grad = ggml_add
+000729c0: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
+000729d0: 3e67 7261 642c 2074 656e 736f 722d 3e67  >grad, tensor->g
+000729e0: 7261 642c 2069 6e70 6c61 6365 293b 0a20  rad, inplace);. 
+000729f0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00072a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072a10: 2069 6620 2873 7263 312d 3e67 7261 6429   if (src1->grad)
+00072a20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00072a30: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
+00072a40: 6420 3d20 6767 6d6c 5f61 6464 5f69 6d70  d = ggml_add_imp
+00072a50: 6c28 6374 782c 2073 7263 312d 3e67 7261  l(ctx, src1->gra
+00072a60: 642c 2074 656e 736f 722d 3e67 7261 642c  d, tensor->grad,
+00072a70: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+00072a80: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00072a90: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00072aa0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00072ab0: 474d 4c5f 4f50 5f41 4444 313a 0a20 2020  GML_OP_ADD1:.   
+00072ac0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00072ad0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+00072ae0: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
 00072af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072b00: 2020 2073 7263 312d 3e67 7261 6420 3d20     src1->grad = 
-00072b10: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
-00072b20: 782c 2073 7263 312d 3e67 7261 642c 2074  x, src1->grad, t
-00072b30: 656e 736f 722d 3e67 7261 642c 2069 6e70  ensor->grad, inp
-00072b40: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-00072b50: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00072b60: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00072b70: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00072b80: 4f50 5f41 4444 313a 0a20 2020 2020 2020  OP_ADD1:.       
-00072b90: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00072ba0: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
-00072bb0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-00072bc0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00072bd0: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
-00072be0: 6464 5f69 6d70 6c28 6374 782c 2073 7263  dd_impl(ctx, src
-00072bf0: 302d 3e67 7261 642c 2074 656e 736f 722d  0->grad, tensor-
-00072c00: 3e67 7261 642c 2069 6e70 6c61 6365 293b  >grad, inplace);
-00072c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00072c20: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00072c30: 2020 2069 6620 2873 7263 312d 3e67 7261     if (src1->gra
-00072c40: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-00072c50: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
-00072c60: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
-00072c70: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
-00072c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072c90: 2073 7263 312d 3e67 7261 642c 0a20 2020   src1->grad,.   
-00072ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072cb0: 2020 2020 2067 676d 6c5f 6d65 616e 2863       ggml_mean(c
-00072cc0: 7478 2c20 7465 6e73 6f72 2d3e 6772 6164  tx, tensor->grad
-00072cd0: 292c 202f 2f20 544f 444f 3a20 7368 6f75  ), // TODO: shou
-00072ce0: 6c64 2070 726f 6261 626c 7920 6265 2073  ld probably be s
-00072cf0: 756d 2069 6e73 7465 6164 206f 6620 6d65  um instead of me
-00072d00: 616e 0a20 2020 2020 2020 2020 2020 2020  an.             
-00072d10: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-00072d20: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-00072d30: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00072d40: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00072d50: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00072d60: 5f41 4343 3a0a 2020 2020 2020 2020 2020  _ACC:.          
-00072d70: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00072d80: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-00072d90: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-00072da0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00072db0: 6772 6164 203d 2067 676d 6c5f 6164 645f  grad = ggml_add_
-00072dc0: 696d 706c 2863 7478 2c20 7372 6330 2d3e  impl(ctx, src0->
-00072dd0: 6772 6164 2c20 7465 6e73 6f72 2d3e 6772  grad, tensor->gr
-00072de0: 6164 2c20 696e 706c 6163 6529 3b0a 2020  ad, inplace);.  
-00072df0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00072e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072e10: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
-00072e20: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00072e30: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00072e40: 5428 6767 6d6c 5f6e 656c 656d 656e 7473  T(ggml_nelements
-00072e50: 2874 656e 736f 722d 3e6f 7074 5b30 5d29  (tensor->opt[0])
-00072e60: 203d 3d20 3529 3b0a 2020 2020 2020 2020   == 5);.        
-00072e70: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00072e80: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
-00072e90: 6f70 745b 305d 2d3e 7479 7065 203d 3d20  opt[0]->type == 
-00072ea0: 4747 4d4c 5f54 5950 455f 4933 3229 3b0a  GGML_TYPE_I32);.
-00072eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072ec0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00072ed0: 206e 6231 2020 2020 203d 2028 2820 696e   nb1     = (( in
-00072ee0: 7433 325f 7420 2a20 2920 7465 6e73 6f72  t32_t * ) tensor
-00072ef0: 2d3e 6f70 745b 305d 2d3e 6461 7461 295b  ->opt[0]->data)[
-00072f00: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
-00072f10: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
-00072f20: 7a65 5f74 206e 6232 2020 2020 203d 2028  ze_t nb2     = (
-00072f30: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
-00072f40: 6e73 6f72 2d3e 6f70 745b 305d 2d3e 6461  nsor->opt[0]->da
-00072f50: 7461 295b 315d 3b0a 2020 2020 2020 2020  ta)[1];.        
-00072f60: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00072f70: 7420 7369 7a65 5f74 206e 6233 2020 2020  t size_t nb3    
-00072f80: 203d 2028 2820 696e 7433 325f 7420 2a20   = (( int32_t * 
-00072f90: 2920 7465 6e73 6f72 2d3e 6f70 745b 305d  ) tensor->opt[0]
-00072fa0: 2d3e 6461 7461 295b 325d 3b0a 2020 2020  ->data)[2];.    
+00072b00: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
+00072b10: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+00072b20: 2073 7263 302d 3e67 7261 642c 2074 656e   src0->grad, ten
+00072b30: 736f 722d 3e67 7261 642c 2069 6e70 6c61  sor->grad, inpla
+00072b40: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+00072b50: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00072b60: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
+00072b70: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+00072b80: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00072b90: 312d 3e67 7261 6420 3d20 6767 6d6c 5f61  1->grad = ggml_a
+00072ba0: 6464 5f69 6d70 6c28 6374 782c 0a20 2020  dd_impl(ctx,.   
+00072bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072bc0: 2020 2020 2073 7263 312d 3e67 7261 642c       src1->grad,
+00072bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072be0: 2020 2020 2020 2020 2067 676d 6c5f 6d65           ggml_me
+00072bf0: 616e 2863 7478 2c20 7465 6e73 6f72 2d3e  an(ctx, tensor->
+00072c00: 6772 6164 292c 202f 2f20 544f 444f 3a20  grad), // TODO: 
+00072c10: 7368 6f75 6c64 2070 726f 6261 626c 7920  should probably 
+00072c20: 6265 2073 756d 2069 6e73 7465 6164 206f  be sum instead o
+00072c30: 6620 6d65 616e 0a20 2020 2020 2020 2020  f mean.         
+00072c40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00072c50: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+00072c60: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00072c70: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00072c80: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00072c90: 4c5f 4f50 5f41 4343 3a0a 2020 2020 2020  L_OP_ACC:.      
+00072ca0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00072cb0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+00072cc0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00072cd0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00072ce0: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
+00072cf0: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
+00072d00: 6330 2d3e 6772 6164 2c20 7465 6e73 6f72  c0->grad, tensor
+00072d10: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
+00072d20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00072d30: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00072d40: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
+00072d50: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+00072d60: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00072d70: 5353 4552 5428 6767 6d6c 5f6e 656c 656d  SSERT(ggml_nelem
+00072d80: 656e 7473 2874 656e 736f 722d 3e6f 7074  ents(tensor->opt
+00072d90: 5b30 5d29 203d 3d20 3529 3b0a 2020 2020  [0]) == 5);.    
+00072da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072db0: 4747 4d4c 5f41 5353 4552 5428 7465 6e73  GGML_ASSERT(tens
+00072dc0: 6f72 2d3e 6f70 745b 305d 2d3e 7479 7065  or->opt[0]->type
+00072dd0: 203d 3d20 4747 4d4c 5f54 5950 455f 4933   == GGML_TYPE_I3
+00072de0: 3229 3b0a 2020 2020 2020 2020 2020 2020  2);.            
+00072df0: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+00072e00: 7a65 5f74 206e 6231 2020 2020 203d 2028  ze_t nb1     = (
+00072e10: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
+00072e20: 6e73 6f72 2d3e 6f70 745b 305d 2d3e 6461  nsor->opt[0]->da
+00072e30: 7461 295b 305d 3b0a 2020 2020 2020 2020  ta)[0];.        
+00072e40: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00072e50: 7420 7369 7a65 5f74 206e 6232 2020 2020  t size_t nb2    
+00072e60: 203d 2028 2820 696e 7433 325f 7420 2a20   = (( int32_t * 
+00072e70: 2920 7465 6e73 6f72 2d3e 6f70 745b 305d  ) tensor->opt[0]
+00072e80: 2d3e 6461 7461 295b 315d 3b0a 2020 2020  ->data)[1];.    
+00072e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072ea0: 636f 6e73 7420 7369 7a65 5f74 206e 6233  const size_t nb3
+00072eb0: 2020 2020 203d 2028 2820 696e 7433 325f       = (( int32_
+00072ec0: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
+00072ed0: 745b 305d 2d3e 6461 7461 295b 325d 3b0a  t[0]->data)[2];.
+00072ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072ef0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00072f00: 206f 6666 7365 7420 203d 2028 2820 696e   offset  = (( in
+00072f10: 7433 325f 7420 2a20 2920 7465 6e73 6f72  t32_t * ) tensor
+00072f20: 2d3e 6f70 745b 305d 2d3e 6461 7461 295b  ->opt[0]->data)[
+00072f30: 335d 3b0a 0a20 2020 2020 2020 2020 2020  3];..           
+00072f40: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+00072f50: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
+00072f60: 6e73 6f72 5f67 7261 645f 7669 6577 203d  nsor_grad_view =
+00072f70: 2067 676d 6c5f 7669 6577 5f34 6428 6374   ggml_view_4d(ct
+00072f80: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00072f90: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+00072fa0: 722d 3e67 7261 642c 0a20 2020 2020 2020  r->grad,.       
 00072fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072fc0: 636f 6e73 7420 7369 7a65 5f74 206f 6666  const size_t off
-00072fd0: 7365 7420 203d 2028 2820 696e 7433 325f  set  = (( int32_
-00072fe0: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
-00072ff0: 745b 305d 2d3e 6461 7461 295b 335d 3b0a  t[0]->data)[3];.
-00073000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00073010: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00073020: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
-00073030: 5f67 7261 645f 7669 6577 203d 2067 676d  _grad_view = ggm
-00073040: 6c5f 7669 6577 5f34 6428 6374 782c 0a20  l_view_4d(ctx,. 
-00073050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073060: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
-00073070: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-00073080: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00073090: 312d 3e67 7261 642d 3e6e 655b 305d 2c0a  1->grad->ne[0],.
-000730a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000730b0: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
-000730c0: 6164 2d3e 6e65 5b31 5d2c 0a20 2020 2020  ad->ne[1],.     
-000730d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000730e0: 2020 2073 7263 312d 3e67 7261 642d 3e6e     src1->grad->n
-000730f0: 655b 325d 2c0a 2020 2020 2020 2020 2020  e[2],.          
-00073100: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00073110: 6331 2d3e 6772 6164 2d3e 6e65 5b33 5d2c  c1->grad->ne[3],
-00073120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00073130: 2020 2020 2020 2020 206e 6231 2c20 6e62           nb1, nb
-00073140: 322c 206e 6233 2c20 6f66 6673 6574 293b  2, nb3, offset);
-00073150: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00073160: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
-00073170: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
-00073180: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00073190: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
+00072fc0: 2073 7263 312d 3e67 7261 642d 3e6e 655b   src1->grad->ne[
+00072fd0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00072fe0: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+00072ff0: 2d3e 6772 6164 2d3e 6e65 5b31 5d2c 0a20  ->grad->ne[1],. 
+00073000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073010: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
+00073020: 642d 3e6e 655b 325d 2c0a 2020 2020 2020  d->ne[2],.      
+00073030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073040: 2020 7372 6331 2d3e 6772 6164 2d3e 6e65    src1->grad->ne
+00073050: 5b33 5d2c 0a20 2020 2020 2020 2020 2020  [3],.           
+00073060: 2020 2020 2020 2020 2020 2020 206e 6231               nb1
+00073070: 2c20 6e62 322c 206e 6233 2c20 6f66 6673  , nb2, nb3, offs
+00073080: 6574 293b 0a0a 2020 2020 2020 2020 2020  et);..          
+00073090: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+000730a0: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
+000730b0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000730c0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+000730d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000730e0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+000730f0: 6331 2d3e 6772 6164 2c0a 2020 2020 2020  c1->grad,.      
+00073100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073110: 2020 2020 2020 6767 6d6c 5f72 6573 6861        ggml_resha
+00073120: 7065 2863 7478 2c0a 2020 2020 2020 2020  pe(ctx,.        
+00073130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073140: 2020 2020 2020 2020 6767 6d6c 5f63 6f6e          ggml_con
+00073150: 7428 6374 782c 2074 656e 736f 725f 6772  t(ctx, tensor_gr
+00073160: 6164 5f76 6965 7729 2c0a 2020 2020 2020  ad_view),.      
+00073170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073180: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+00073190: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
 000731a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000731b0: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-000731c0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-000731d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000731e0: 2020 6767 6d6c 5f72 6573 6861 7065 2863    ggml_reshape(c
-000731f0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-00073200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073210: 2020 2020 6767 6d6c 5f63 6f6e 7428 6374      ggml_cont(ct
-00073220: 782c 2074 656e 736f 725f 6772 6164 5f76  x, tensor_grad_v
-00073230: 6965 7729 2c0a 2020 2020 2020 2020 2020  iew),.          
-00073240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073250: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
-00073260: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00073270: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00073280: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-00073290: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000732a0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-000732b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000732c0: 4c5f 4f50 5f53 5542 3a0a 2020 2020 2020  L_OP_SUB:.      
-000732d0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000732e0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
-000732f0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-00073300: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00073310: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
-00073320: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
-00073330: 6330 2d3e 6772 6164 2c20 7465 6e73 6f72  c0->grad, tensor
-00073340: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
-00073350: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00073360: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00073370: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
-00073380: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-00073390: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-000733a0: 6772 6164 203d 2067 676d 6c5f 7375 625f  grad = ggml_sub_
-000733b0: 696d 706c 2863 7478 2c20 7372 6331 2d3e  impl(ctx, src1->
-000733c0: 6772 6164 2c20 7465 6e73 6f72 2d3e 6772  grad, tensor->gr
-000733d0: 6164 2c20 696e 706c 6163 6529 3b0a 2020  ad, inplace);.  
-000733e0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-000733f0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00073400: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00073410: 6520 4747 4d4c 5f4f 505f 4d55 4c3a 0a20  e GGML_OP_MUL:. 
-00073420: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00073430: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00073440: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-00073450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073460: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
-00073470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073480: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
-00073490: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
+000731b0: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
+000731c0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000731d0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000731e0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+000731f0: 2047 474d 4c5f 4f50 5f53 5542 3a0a 2020   GGML_OP_SUB:.  
+00073200: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00073210: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00073220: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+00073230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073240: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
+00073250: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+00073260: 2c20 7372 6330 2d3e 6772 6164 2c20 7465  , src0->grad, te
+00073270: 6e73 6f72 2d3e 6772 6164 2c20 696e 706c  nsor->grad, inpl
+00073280: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+00073290: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000732a0: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
+000732b0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+000732c0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+000732d0: 6331 2d3e 6772 6164 203d 2067 676d 6c5f  c1->grad = ggml_
+000732e0: 7375 625f 696d 706c 2863 7478 2c20 7372  sub_impl(ctx, sr
+000732f0: 6331 2d3e 6772 6164 2c20 7465 6e73 6f72  c1->grad, tensor
+00073300: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
+00073310: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00073320: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00073330: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00073340: 2063 6173 6520 4747 4d4c 5f4f 505f 4d55   case GGML_OP_MU
+00073350: 4c3a 0a20 2020 2020 2020 2020 2020 207b  L:.            {
+00073360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073370: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+00073380: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00073390: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+000733a0: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+000733b0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000733c0: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
+000733d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000733e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000733f0: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+00073400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073410: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00073420: 6d75 6c28 6374 782c 2073 7263 312c 2074  mul(ctx, src1, t
+00073430: 656e 736f 722d 3e67 7261 6429 2c0a 2020  ensor->grad),.  
+00073440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073450: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00073460: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+00073470: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00073480: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+00073490: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
 000734a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000734b0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-000734c0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-000734d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000734e0: 2020 2020 2020 2067 676d 6c5f 6d75 6c28         ggml_mul(
-000734f0: 6374 782c 2073 7263 312c 2074 656e 736f  ctx, src1, tenso
-00073500: 722d 3e67 7261 6429 2c0a 2020 2020 2020  r->grad),.      
-00073510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073520: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-00073530: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00073540: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00073550: 2020 2020 2020 6966 2028 7372 6331 2d3e        if (src1->
-00073560: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-00073570: 2020 2020 2020 2020 2020 2020 7372 6331              src1
-00073580: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
-00073590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000735a0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-000735b0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-000735c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000735d0: 2020 2020 7372 6331 2d3e 6772 6164 2c0a      src1->grad,.
-000735e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000735f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073600: 6767 6d6c 5f6d 756c 2863 7478 2c20 7372  ggml_mul(ctx, sr
-00073610: 6330 2c20 7465 6e73 6f72 2d3e 6772 6164  c0, tensor->grad
-00073620: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00073630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073640: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
-00073650: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00073660: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00073670: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00073680: 2047 474d 4c5f 4f50 5f44 4956 3a0a 2020   GGML_OP_DIV:.  
-00073690: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000736a0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-000736b0: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
-000736c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000736d0: 2020 7372 6330 2d3e 6772 6164 203d 0a20    src0->grad =. 
-000736e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000736f0: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
-00073700: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
-00073710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073720: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00073730: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-00073740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073750: 2020 2020 2020 6767 6d6c 5f64 6976 2863        ggml_div(c
-00073760: 7478 2c20 7465 6e73 6f72 2d3e 6772 6164  tx, tensor->grad
-00073770: 2c20 7372 6331 292c 0a20 2020 2020 2020  , src1),.       
-00073780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073790: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-000737a0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000737b0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000737c0: 2020 2020 2069 6620 2873 7263 312d 3e67       if (src1->g
-000737d0: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
-000737e0: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-000737f0: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
-00073800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073810: 6767 6d6c 5f73 7562 5f69 6d70 6c28 6374  ggml_sub_impl(ct
-00073820: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+000734b0: 7372 6331 2d3e 6772 6164 203d 0a20 2020  src1->grad =.   
+000734c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000734d0: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
+000734e0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+000734f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073500: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
+00073510: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+00073520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073530: 2020 2020 6767 6d6c 5f6d 756c 2863 7478      ggml_mul(ctx
+00073540: 2c20 7372 6330 2c20 7465 6e73 6f72 2d3e  , src0, tensor->
+00073550: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
+00073560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073570: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+00073580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073590: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+000735a0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000735b0: 6361 7365 2047 474d 4c5f 4f50 5f44 4956  case GGML_OP_DIV
+000735c0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000735d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000735e0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+000735f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00073600: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+00073610: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
+00073620: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00073630: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
+00073640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073650: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00073660: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
+00073670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073680: 2020 2020 2020 2020 2020 6767 6d6c 5f64            ggml_d
+00073690: 6976 2863 7478 2c20 7465 6e73 6f72 2d3e  iv(ctx, tensor->
+000736a0: 6772 6164 2c20 7372 6331 292c 0a20 2020  grad, src1),.   
+000736b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000736c0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+000736d0: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+000736e0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000736f0: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+00073700: 312d 3e67 7261 6429 207b 0a20 2020 2020  1->grad) {.     
+00073710: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00073720: 7263 312d 3e67 7261 6420 3d0a 2020 2020  rc1->grad =.    
+00073730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073740: 2020 2020 6767 6d6c 5f73 7562 5f69 6d70      ggml_sub_imp
+00073750: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+00073760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073770: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
+00073780: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00073790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000737a0: 2020 2067 676d 6c5f 6d75 6c28 6374 782c     ggml_mul(ctx,
+000737b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000737c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000737d0: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
+000737e0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+000737f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073800: 2020 2020 2020 2067 676d 6c5f 6469 7628         ggml_div(
+00073810: 6374 782c 2074 656e 736f 722c 2073 7263  ctx, tensor, src
+00073820: 3129 292c 0a20 2020 2020 2020 2020 2020  1)),.           
 00073830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073840: 2020 2073 7263 312d 3e67 7261 642c 0a20     src1->grad,. 
-00073850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073860: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00073870: 676d 6c5f 6d75 6c28 6374 782c 0a20 2020  gml_mul(ctx,.   
-00073880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000738a0: 2074 656e 736f 722d 3e67 7261 642c 0a20   tensor->grad,. 
-000738b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073840: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
+00073850: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00073860: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00073870: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00073880: 7365 2047 474d 4c5f 4f50 5f53 5152 3a0a  se GGML_OP_SQR:.
+00073890: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000738a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000738b0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
 000738c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000738d0: 2020 2067 676d 6c5f 6469 7628 6374 782c     ggml_div(ctx,
-000738e0: 2074 656e 736f 722c 2073 7263 3129 292c   tensor, src1)),
-000738f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00073900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073910: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-00073920: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00073930: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00073940: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00073950: 474d 4c5f 4f50 5f53 5152 3a0a 2020 2020  GML_OP_SQR:.    
-00073960: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00073970: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-00073980: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-00073990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000739a0: 7372 6330 2d3e 6772 6164 203d 0a20 2020  src0->grad =.   
+000738d0: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
+000738e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000738f0: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
+00073900: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
+00073910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073920: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+00073930: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+00073940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073950: 2020 2020 2020 2020 6767 6d6c 5f73 6361          ggml_sca
+00073960: 6c65 2863 7478 2c0a 2020 2020 2020 2020  le(ctx,.        
+00073970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073980: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00073990: 5f6d 756c 2863 7478 2c20 7372 6330 2c20  _mul(ctx, src0, 
+000739a0: 7465 6e73 6f72 2d3e 6772 6164 292c 0a20  tensor->grad),. 
 000739b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000739c0: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
-000739d0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
-000739e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000739f0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00073a00: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-00073a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073a20: 2020 2020 6767 6d6c 5f73 6361 6c65 2863      ggml_scale(c
-00073a30: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-00073a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073a50: 2020 2020 2020 2020 6767 6d6c 5f6d 756c          ggml_mul
-00073a60: 2863 7478 2c20 7372 6330 2c20 7465 6e73  (ctx, src0, tens
-00073a70: 6f72 2d3e 6772 6164 292c 0a20 2020 2020  or->grad),.     
-00073a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073a90: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00073aa0: 676d 6c5f 6e65 775f 6633 3228 6374 782c  gml_new_f32(ctx,
-00073ab0: 2032 2e30 6629 292c 0a20 2020 2020 2020   2.0f)),.       
-00073ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073ad0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-00073ae0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00073af0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00073b00: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00073b10: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
-00073b20: 5152 543a 0a20 2020 2020 2020 2020 2020  QRT:.           
-00073b30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00073b40: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-00073b50: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-00073b60: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-00073b70: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
-00073b80: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00073b90: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-00073ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000739c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000739d0: 2020 2067 676d 6c5f 6e65 775f 6633 3228     ggml_new_f32(
+000739e0: 6374 782c 2032 2e30 6629 292c 0a20 2020  ctx, 2.0f)),.   
+000739f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073a00: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00073a10: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+00073a20: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00073a30: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00073a40: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00073a50: 4f50 5f53 5152 543a 0a20 2020 2020 2020  OP_SQRT:.       
+00073a60: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00073a70: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
+00073a80: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+00073a90: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00073aa0: 302d 3e67 7261 6420 3d0a 2020 2020 2020  0->grad =.      
+00073ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073ac0: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
+00073ad0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+00073ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073af0: 2020 2020 2073 7263 302d 3e67 7261 642c       src0->grad,
+00073b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073b20: 2067 676d 6c5f 7363 616c 6528 6374 782c   ggml_scale(ctx,
+00073b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073b50: 2020 2020 2067 676d 6c5f 6469 7628 6374       ggml_div(ct
+00073b60: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00073b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073b80: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+00073b90: 722d 3e67 7261 642c 0a20 2020 2020 2020  r->grad,.       
+00073ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00073bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073bc0: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
+00073bc0: 2074 656e 736f 7229 2c0a 2020 2020 2020   tensor),.      
 00073bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073be0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00073bf0: 6c5f 7363 616c 6528 6374 782c 0a20 2020  l_scale(ctx,.   
-00073c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073be0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00073bf0: 6d6c 5f6e 6577 5f66 3332 2863 7478 2c20  ml_new_f32(ctx, 
+00073c00: 302e 3566 2929 2c0a 2020 2020 2020 2020  0.5f)),.        
 00073c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073c20: 2067 676d 6c5f 6469 7628 6374 782c 0a20   ggml_div(ctx,. 
-00073c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073c50: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
-00073c60: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-00073c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073c80: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-00073c90: 736f 7229 2c0a 2020 2020 2020 2020 2020  sor),.          
-00073ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073cb0: 2020 2020 2020 2020 2020 6767 6d6c 5f6e            ggml_n
-00073cc0: 6577 5f66 3332 2863 7478 2c20 302e 3566  ew_f32(ctx, 0.5f
-00073cd0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00073ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073cf0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
-00073d00: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00073d10: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00073d20: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00073d30: 6520 4747 4d4c 5f4f 505f 4c4f 473a 0a20  e GGML_OP_LOG:. 
-00073d40: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00073d50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00073d60: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-00073d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073d80: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
-00073d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073da0: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
-00073db0: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
-00073dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073dd0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-00073de0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-00073df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073e00: 2020 2020 2020 2067 676d 6c5f 6469 7628         ggml_div(
-00073e10: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00073e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073e30: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
-00073e40: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-00073e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073e60: 2020 2020 2020 2020 2020 2073 7263 3029             src0)
-00073e70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00073e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073e90: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-00073ea0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00073eb0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00073ec0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00073ed0: 4747 4d4c 5f4f 505f 5355 4d3a 0a20 2020  GGML_OP_SUM:.   
-00073ee0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00073ef0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-00073f00: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-00073f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073f20: 2073 7263 302d 3e67 7261 6420 3d0a 2020   src0->grad =.  
-00073f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073f40: 2020 2020 2020 6767 6d6c 5f61 6464 315f        ggml_add1_
-00073f50: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
-00073f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073f70: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00073f80: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-00073f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073fa0: 2020 2020 2020 7465 6e73 6f72 2d3e 6772        tensor->gr
-00073fb0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-00073fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073fd0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
-00073fe0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00073ff0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00074000: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00074010: 6520 4747 4d4c 5f4f 505f 5355 4d5f 524f  e GGML_OP_SUM_RO
-00074020: 5753 3a0a 2020 2020 2020 2020 2020 2020  WS:.            
-00074030: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00074040: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-00074050: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00074060: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00074070: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
-00074080: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00074090: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
+00073c20: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+00073c30: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00073c40: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00073c50: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00073c60: 2063 6173 6520 4747 4d4c 5f4f 505f 4c4f   case GGML_OP_LO
+00073c70: 473a 0a20 2020 2020 2020 2020 2020 207b  G:.            {
+00073c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073c90: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+00073ca0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00073cb0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+00073cc0: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+00073cd0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00073ce0: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
+00073cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073d00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00073d10: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+00073d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073d30: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00073d40: 6469 7628 6374 782c 0a20 2020 2020 2020  div(ctx,.       
+00073d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073d60: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+00073d70: 736f 722d 3e67 7261 642c 0a20 2020 2020  sor->grad,.     
+00073d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073d90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00073da0: 7263 3029 2c0a 2020 2020 2020 2020 2020  rc0),.          
+00073db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073dc0: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
+00073dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073de0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
+00073df0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00073e00: 6173 6520 4747 4d4c 5f4f 505f 5355 4d3a  ase GGML_OP_SUM:
+00073e10: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00073e20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00073e30: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
+00073e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073e50: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
+00073e60: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
+00073e70: 2020 2020 2020 2020 2020 6767 6d6c 5f61            ggml_a
+00073e80: 6464 315f 696d 706c 2863 7478 2c0a 2020  dd1_impl(ctx,.  
+00073e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073ea0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00073eb0: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
+00073ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073ed0: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+00073ee0: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+00073ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073f00: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+00073f10: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00073f20: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00073f30: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00073f40: 2063 6173 6520 4747 4d4c 5f4f 505f 5355   case GGML_OP_SU
+00073f50: 4d5f 524f 5753 3a0a 2020 2020 2020 2020  M_ROWS:.        
+00073f60: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00073f70: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+00073f80: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00073f90: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+00073fa0: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+00073fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073fc0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+00073fd0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+00073fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073ff0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
+00074000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074020: 6767 6d6c 5f72 6570 6561 7428 6374 782c  ggml_repeat(ctx,
+00074030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00074040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074050: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
+00074060: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00074070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074080: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+00074090: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
 000740a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000740b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000740c0: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
-000740d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000740e0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000740f0: 5f72 6570 6561 7428 6374 782c 0a20 2020  _repeat(ctx,.   
-00074100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074120: 2074 656e 736f 722d 3e67 7261 642c 0a20   tensor->grad,. 
-00074130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074150: 2020 2073 7263 302d 3e67 7261 6429 2c0a     src0->grad),.
-00074160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074180: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-00074190: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-000741a0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000741b0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000741c0: 4d4c 5f4f 505f 4d45 414e 3a0a 2020 2020  ML_OP_MEAN:.    
-000741d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000741e0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-000741f0: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
-00074200: 2054 4f44 4f3a 2069 6d70 6c65 6d65 6e74   TODO: implement
-00074210: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00074220: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00074230: 7365 2047 474d 4c5f 4f50 5f52 4550 4541  se GGML_OP_REPEA
-00074240: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
-00074250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00074260: 202f 2f20 6e65 6365 7373 6172 7920 666f   // necessary fo
-00074270: 7220 6c6c 616d 610a 2020 2020 2020 2020  r llama.        
-00074280: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
-00074290: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-000742a0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-000742b0: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
-000742c0: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
-000742d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000742e0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-000742f0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-00074300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074310: 2020 6767 6d6c 5f72 6570 6561 745f 6261    ggml_repeat_ba
-00074320: 636b 2863 7478 2c20 7465 6e73 6f72 2d3e  ck(ctx, tensor->
-00074330: 6772 6164 2c20 7372 6330 2d3e 6772 6164  grad, src0->grad
-00074340: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00074350: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00074360: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-00074370: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00074380: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00074390: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000743a0: 4c5f 4f50 5f52 4550 4541 545f 4241 434b  L_OP_REPEAT_BACK
-000743b0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000743c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000743d0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-000743e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000743f0: 2020 2020 2020 2f2f 2054 4f44 4f3a 2074        // TODO: t
-00074400: 6573 7420 7468 6973 0a20 2020 2020 2020  est this.       
-00074410: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00074420: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
-00074430: 6464 5f69 6d70 6c28 6374 782c 0a20 2020  dd_impl(ctx,.   
-00074440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074450: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-00074460: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-00074470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074480: 2067 676d 6c5f 7265 7065 6174 2863 7478   ggml_repeat(ctx
-00074490: 2c20 7465 6e73 6f72 2d3e 6772 6164 2c20  , tensor->grad, 
-000744a0: 7372 6330 2d3e 6772 6164 292c 0a20 2020  src0->grad),.   
-000744b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000744c0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-000744d0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000744e0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000744f0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00074500: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-00074510: 4550 4541 5432 3a0a 2020 2020 2020 2020  EPEAT2:.        
-00074520: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00074530: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00074540: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
-00074550: 4f3a 206e 6f74 2069 6d70 6c65 6d65 6e74  O: not implement
-00074560: 6564 0a20 2020 2020 2020 2020 2020 207d  ed.            }
-00074570: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00074580: 6361 7365 2047 474d 4c5f 4f50 5f41 4253  case GGML_OP_ABS
-00074590: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000745a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000745b0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-000745c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000745d0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-000745e0: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
-000745f0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00074600: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
-00074610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074620: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00074630: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
-00074640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074650: 2020 2020 2020 2020 2020 6767 6d6c 5f6d            ggml_m
-00074660: 756c 2863 7478 2c0a 2020 2020 2020 2020  ul(ctx,.        
-00074670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074680: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00074690: 5f73 676e 2863 7478 2c20 7372 6330 292c  _sgn(ctx, src0),
-000746a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000746b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000746c0: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
-000746d0: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-000746e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000746f0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
-00074700: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00074710: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00074720: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00074730: 6520 4747 4d4c 5f4f 505f 5347 4e3a 0a20  e GGML_OP_SGN:. 
-00074740: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00074750: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00074760: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-00074770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074780: 2020 202f 2f20 6e6f 6f70 0a20 2020 2020     // noop.     
-00074790: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-000747a0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000747b0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000747c0: 474d 4c5f 4f50 5f4e 4547 3a0a 2020 2020  GML_OP_NEG:.    
-000747d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000747e0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-000747f0: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-00074800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074810: 7372 6330 2d3e 6772 6164 203d 2067 676d  src0->grad = ggm
-00074820: 6c5f 7375 625f 696d 706c 2863 7478 2c20  l_sub_impl(ctx, 
-00074830: 7372 6330 2d3e 6772 6164 2c20 7465 6e73  src0->grad, tens
-00074840: 6f72 2d3e 6772 6164 2c20 696e 706c 6163  or->grad, inplac
-00074850: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00074860: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00074870: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00074880: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00074890: 5354 4550 3a0a 2020 2020 2020 2020 2020  STEP:.          
-000748a0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000748b0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-000748c0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-000748d0: 2020 2020 2020 2020 2020 2f2f 206e 6f6f            // noo
-000748e0: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
-000748f0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00074900: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00074910: 2063 6173 6520 4747 4d4c 5f4f 505f 5245   case GGML_OP_RE
-00074920: 4c55 3a0a 2020 2020 2020 2020 2020 2020  LU:.            
-00074930: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00074940: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-00074950: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00074960: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00074970: 6164 203d 2067 676d 6c5f 7375 625f 696d  ad = ggml_sub_im
-00074980: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
-00074990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000749a0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-000749b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000749c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000749d0: 5f6d 756c 2863 7478 2c0a 2020 2020 2020  _mul(ctx,.      
-000749e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000749f0: 2020 2020 2020 2020 2020 6767 6d6c 5f73            ggml_s
-00074a00: 7465 7028 6374 782c 2073 7263 3029 2c0a  tep(ctx, src0),.
-00074a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074a30: 7465 6e73 6f72 2d3e 6772 6164 292c 0a20  tensor->grad),. 
-00074a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074a50: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-00074a60: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-00074a70: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00074a80: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00074a90: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00074aa0: 5f47 454c 553a 0a20 2020 2020 2020 2020  _GELU:.         
-00074ab0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00074ac0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00074ad0: 2866 616c 7365 293b 202f 2f20 544f 444f  (false); // TODO
-00074ae0: 3a20 6e6f 7420 696d 706c 656d 656e 7465  : not implemente
-00074af0: 640a 2020 2020 2020 2020 2020 2020 7d20  d.            } 
-00074b00: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00074b10: 6173 6520 4747 4d4c 5f4f 505f 414c 4942  ase GGML_OP_ALIB
-00074b20: 493a 0a20 2020 2020 2020 2020 2020 207b  I:.            {
-00074b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00074b40: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00074b50: 7365 293b 202f 2f20 544f 444f 3a20 6e6f  se); // TODO: no
-00074b60: 7420 696d 706c 656d 656e 7465 640a 2020  t implemented.  
-00074b70: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00074b80: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00074b90: 4747 4d4c 5f4f 505f 434c 414d 503a 0a20  GGML_OP_CLAMP:. 
-00074ba0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00074bb0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00074bc0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00074bd0: 202f 2f20 544f 444f 3a20 6e6f 7420 696d   // TODO: not im
-00074be0: 706c 656d 656e 7465 640a 2020 2020 2020  plemented.      
-00074bf0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00074c00: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00074c10: 5f4f 505f 5349 4c55 3a0a 2020 2020 2020  _OP_SILU:.      
-00074c20: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00074c30: 2020 2020 2020 2020 2f2f 206e 6563 6573          // neces
-00074c40: 7361 7279 2066 6f72 206c 6c61 6d61 0a20  sary for llama. 
-00074c50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00074c60: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
-00074c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00074c80: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-00074c90: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
-00074ca0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00074cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074cc0: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
-00074cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074ce0: 2020 2020 2020 2020 2067 676d 6c5f 7369           ggml_si
-00074cf0: 6c75 5f62 6163 6b28 6374 782c 2073 7263  lu_back(ctx, src
-00074d00: 302c 2074 656e 736f 722d 3e67 7261 6429  0, tensor->grad)
-00074d10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00074d20: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00074d30: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-00074d40: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00074d50: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00074d60: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00074d70: 5f4f 505f 5349 4c55 5f42 4143 4b3a 0a20  _OP_SILU_BACK:. 
-00074d80: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00074d90: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00074da0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00074db0: 202f 2f20 544f 444f 3a20 6e6f 7420 696d   // TODO: not im
-00074dc0: 706c 656d 656e 7465 640a 2020 2020 2020  plemented.      
-00074dd0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00074de0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00074df0: 5f4f 505f 4e4f 524d 3a0a 2020 2020 2020  _OP_NORM:.      
-00074e00: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00074e10: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00074e20: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
-00074e30: 4f44 4f3a 206e 6f74 2069 6d70 6c65 6d65  ODO: not impleme
-00074e40: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
-00074e50: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00074e60: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-00074e70: 4d53 5f4e 4f52 4d3a 0a20 2020 2020 2020  MS_NORM:.       
-00074e80: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00074e90: 2020 2020 2020 202f 2f20 6e65 6365 7373         // necess
-00074ea0: 6172 7920 666f 7220 6c6c 616d 610a 2020  ary for llama.  
-00074eb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00074ec0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-00074ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074ee0: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-00074ef0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-00074f00: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-00074f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074f20: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
-00074f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074f40: 2020 2020 2020 2020 6767 6d6c 5f72 6d73          ggml_rms
-00074f50: 5f6e 6f72 6d5f 6261 636b 2863 7478 2c20  _norm_back(ctx, 
-00074f60: 7372 6330 2c20 7465 6e73 6f72 2d3e 6772  src0, tensor->gr
-00074f70: 6164 292c 0a20 2020 2020 2020 2020 2020  ad),.           
-00074f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074f90: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-00074fa0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00074fb0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00074fc0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00074fd0: 474d 4c5f 4f50 5f52 4d53 5f4e 4f52 4d5f  GML_OP_RMS_NORM_
-00074fe0: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
-00074ff0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00075000: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00075010: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-00075020: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
-00075030: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00075040: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00075050: 7365 2047 474d 4c5f 4f50 5f4d 554c 5f4d  se GGML_OP_MUL_M
-00075060: 4154 3a0a 2020 2020 2020 2020 2020 2020  AT:.            
-00075070: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00075080: 2020 2f2f 2068 7474 7073 3a2f 2f63 7332    // https://cs2
-00075090: 3331 6e2e 6769 7468 7562 2e69 6f2f 6f70  31n.github.io/op
-000750a0: 7469 6d69 7a61 7469 6f6e 2d32 2f23 7374  timization-2/#st
-000750b0: 6167 6564 0a20 2020 2020 2020 2020 2020  aged.           
-000750c0: 2020 2020 202f 2f20 2320 666f 7277 6172       // # forwar
-000750d0: 6420 7061 7373 0a20 2020 2020 2020 2020  d pass.         
-000750e0: 2020 2020 2020 202f 2f20 7330 203d 206e         // s0 = n
-000750f0: 702e 7261 6e64 6f6d 2e72 616e 646e 2835  p.random.randn(5
-00075100: 2c20 3130 290a 2020 2020 2020 2020 2020  , 10).          
-00075110: 2020 2020 2020 2f2f 2073 3120 3d20 6e70        // s1 = np
-00075120: 2e72 616e 646f 6d2e 7261 6e64 6e28 3130  .random.randn(10
-00075130: 2c20 3329 0a20 2020 2020 2020 2020 2020  , 3).           
-00075140: 2020 2020 202f 2f20 7420 3d20 7330 2e64       // t = s0.d
-00075150: 6f74 2873 3129 0a0a 2020 2020 2020 2020  ot(s1)..        
-00075160: 2020 2020 2020 2020 2f2f 2023 206e 6f77          // # now
-00075170: 2073 7570 706f 7365 2077 6520 6861 6420   suppose we had 
-00075180: 7468 6520 6772 6164 6965 6e74 206f 6e20  the gradient on 
-00075190: 7420 6672 6f6d 2061 626f 7665 2069 6e20  t from above in 
-000751a0: 7468 6520 6369 7263 7569 740a 2020 2020  the circuit.    
-000751b0: 2020 2020 2020 2020 2020 2020 2f2f 2064              // d
-000751c0: 7420 3d20 6e70 2e72 616e 646f 6d2e 7261  t = np.random.ra
-000751d0: 6e64 6e28 2a74 2e73 6861 7065 2920 2320  ndn(*t.shape) # 
-000751e0: 7361 6d65 2073 6861 7065 2061 7320 740a  same shape as t.
-000751f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075200: 2f2f 2064 7330 203d 2064 742e 646f 7428  // ds0 = dt.dot(
-00075210: 7331 2e54 2920 232e 5420 6769 7665 7320  s1.T) #.T gives 
-00075220: 7468 6520 7472 616e 7370 6f73 6520 6f66  the transpose of
-00075230: 2074 6865 206d 6174 7269 780a 2020 2020   the matrix.    
-00075240: 2020 2020 2020 2020 2020 2020 2f2f 2064              // d
-00075250: 7331 203d 2074 2e54 2e64 6f74 2864 7429  s1 = t.T.dot(dt)
-00075260: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00075270: 2020 2f2f 2074 656e 736f 722e 7368 6170    // tensor.shap
-00075280: 6520 5b6d 2c70 5d0a 2020 2020 2020 2020  e [m,p].        
-00075290: 2020 2020 2020 2020 2f2f 2073 7263 302e          // src0.
-000752a0: 7368 6170 6520 2020 5b6e 2c6d 5d0a 2020  shape   [n,m].  
-000752b0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-000752c0: 2073 7263 312e 7368 6170 6520 2020 5b6e   src1.shape   [n
-000752d0: 2c70 5d0a 0a20 2020 2020 2020 2020 2020  ,p]..           
-000752e0: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
-000752f0: 7920 666f 7220 6c6c 616d 610a 2020 2020  y for llama.    
-00075300: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00075310: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
-00075320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075330: 2020 7372 6330 2d3e 6772 6164 203d 0a20    src0->grad =. 
-00075340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075350: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
-00075360: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
-00075370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075380: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00075390: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-000753a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000753b0: 2020 2020 2020 6767 6d6c 5f6f 7574 5f70        ggml_out_p
-000753c0: 726f 6428 6374 782c 202f 2f20 5b6e 2c6d  rod(ctx, // [n,m
-000753d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000740b0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+000740c0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000740d0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000740e0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000740f0: 6520 4747 4d4c 5f4f 505f 4d45 414e 3a0a  e GGML_OP_MEAN:.
+00074100: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00074110: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00074120: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+00074130: 3b20 2f2f 2054 4f44 4f3a 2069 6d70 6c65  ; // TODO: imple
+00074140: 6d65 6e74 0a20 2020 2020 2020 2020 2020  ment.           
+00074150: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00074160: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
+00074170: 4550 4541 543a 0a20 2020 2020 2020 2020  EPEAT:.         
+00074180: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00074190: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
+000741a0: 7920 666f 7220 6c6c 616d 610a 2020 2020  y for llama.    
+000741b0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+000741c0: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+000741d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000741e0: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
+000741f0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+00074200: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00074210: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00074220: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
+00074230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074240: 2020 2020 2020 6767 6d6c 5f72 6570 6561        ggml_repea
+00074250: 745f 6261 636b 2863 7478 2c20 7465 6e73  t_back(ctx, tens
+00074260: 6f72 2d3e 6772 6164 2c20 7372 6330 2d3e  or->grad, src0->
+00074270: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
+00074280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074290: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
+000742a0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000742b0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000742c0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+000742d0: 2047 474d 4c5f 4f50 5f52 4550 4541 545f   GGML_OP_REPEAT_
+000742e0: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
+000742f0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00074300: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
+00074310: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+00074320: 2020 2020 2020 2020 2020 2f2f 2054 4f44            // TOD
+00074330: 4f3a 2074 6573 7420 7468 6973 0a20 2020  O: test this.   
+00074340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074350: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
+00074360: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+00074370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00074380: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00074390: 302d 3e67 7261 642c 0a20 2020 2020 2020  0->grad,.       
+000743a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000743b0: 2020 2020 2067 676d 6c5f 7265 7065 6174       ggml_repeat
+000743c0: 2863 7478 2c20 7465 6e73 6f72 2d3e 6772  (ctx, tensor->gr
+000743d0: 6164 2c20 7372 6330 2d3e 6772 6164 292c  ad, src0->grad),
+000743e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000743f0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00074400: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+00074410: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00074420: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00074430: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00074440: 4f50 5f41 4253 3a0a 2020 2020 2020 2020  OP_ABS:.        
+00074450: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00074460: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+00074470: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00074480: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+00074490: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+000744a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000744b0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+000744c0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+000744d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000744e0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
+000744f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074510: 6767 6d6c 5f6d 756c 2863 7478 2c0a 2020  ggml_mul(ctx,.  
+00074520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074540: 2020 6767 6d6c 5f73 676e 2863 7478 2c20    ggml_sgn(ctx, 
+00074550: 7372 6330 292c 0a20 2020 2020 2020 2020  src0),.         
+00074560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074570: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+00074580: 722d 3e67 7261 6429 2c0a 2020 2020 2020  r->grad),.      
+00074590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000745a0: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
+000745b0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+000745c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000745d0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000745e0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+000745f0: 5347 4e3a 0a20 2020 2020 2020 2020 2020  SGN:.           
+00074600: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00074610: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+00074620: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00074630: 2020 2020 2020 2020 202f 2f20 6e6f 6f70           // noop
+00074640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00074650: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00074660: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00074670: 6361 7365 2047 474d 4c5f 4f50 5f4e 4547  case GGML_OP_NEG
+00074680: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00074690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000746a0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+000746b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000746c0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+000746d0: 203d 2067 676d 6c5f 7375 625f 696d 706c   = ggml_sub_impl
+000746e0: 2863 7478 2c20 7372 6330 2d3e 6772 6164  (ctx, src0->grad
+000746f0: 2c20 7465 6e73 6f72 2d3e 6772 6164 2c20  , tensor->grad, 
+00074700: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+00074710: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00074720: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00074730: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00074740: 4d4c 5f4f 505f 5354 4550 3a0a 2020 2020  ML_OP_STEP:.    
+00074750: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00074760: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+00074770: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
+00074780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074790: 2f2f 206e 6f6f 700a 2020 2020 2020 2020  // noop.        
+000747a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000747b0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+000747c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000747d0: 5f4f 505f 5245 4c55 3a0a 2020 2020 2020  _OP_RELU:.      
+000747e0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000747f0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+00074800: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00074810: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00074820: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
+00074830: 7375 625f 696d 706c 2863 7478 2c0a 2020  sub_impl(ctx,.  
+00074840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074850: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+00074860: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+00074870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074880: 2020 6767 6d6c 5f6d 756c 2863 7478 2c0a    ggml_mul(ctx,.
+00074890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000748a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000748b0: 6767 6d6c 5f73 7465 7028 6374 782c 2073  ggml_step(ctx, s
+000748c0: 7263 3029 2c0a 2020 2020 2020 2020 2020  rc0),.          
+000748d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000748e0: 2020 2020 2020 7465 6e73 6f72 2d3e 6772        tensor->gr
+000748f0: 6164 292c 0a20 2020 2020 2020 2020 2020  ad),.           
+00074900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074910: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+00074920: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00074930: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00074940: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00074950: 474d 4c5f 4f50 5f47 454c 553a 0a20 2020  GML_OP_GELU:.   
+00074960: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00074970: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00074980: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
+00074990: 2f20 544f 444f 3a20 6e6f 7420 696d 706c  / TODO: not impl
+000749a0: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
+000749b0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000749c0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000749d0: 505f 414c 4942 493a 0a20 2020 2020 2020  P_ALIBI:.       
+000749e0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000749f0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00074a00: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
+00074a10: 444f 3a20 6e6f 7420 696d 706c 656d 656e  DO: not implemen
+00074a20: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+00074a30: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00074a40: 2063 6173 6520 4747 4d4c 5f4f 505f 434c   case GGML_OP_CL
+00074a50: 414d 503a 0a20 2020 2020 2020 2020 2020  AMP:.           
+00074a60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00074a70: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00074a80: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+00074a90: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
+00074aa0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00074ab0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00074ac0: 6520 4747 4d4c 5f4f 505f 5349 4c55 3a0a  e GGML_OP_SILU:.
+00074ad0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00074ae0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00074af0: 206e 6563 6573 7361 7279 2066 6f72 206c   necessary for l
+00074b00: 6c61 6d61 0a20 2020 2020 2020 2020 2020  lama.           
+00074b10: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+00074b20: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+00074b30: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+00074b40: 3e67 7261 6420 3d20 6767 6d6c 5f61 6464  >grad = ggml_add
+00074b50: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
+00074b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074b70: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+00074b80: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00074b90: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00074ba0: 676d 6c5f 7369 6c75 5f62 6163 6b28 6374  gml_silu_back(ct
+00074bb0: 782c 2073 7263 302c 2074 656e 736f 722d  x, src0, tensor-
+00074bc0: 3e67 7261 6429 2c0a 2020 2020 2020 2020  >grad),.        
+00074bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074be0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+00074bf0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00074c00: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00074c10: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00074c20: 6520 4747 4d4c 5f4f 505f 5349 4c55 5f42  e GGML_OP_SILU_B
+00074c30: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
+00074c40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00074c50: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00074c60: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+00074c70: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
+00074c80: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00074c90: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00074ca0: 6520 4747 4d4c 5f4f 505f 4e4f 524d 3a0a  e GGML_OP_NORM:.
+00074cb0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00074cc0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00074cd0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+00074ce0: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
+00074cf0: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
+00074d00: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00074d10: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00074d20: 4c5f 4f50 5f52 4d53 5f4e 4f52 4d3a 0a20  L_OP_RMS_NORM:. 
+00074d30: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00074d40: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00074d50: 6e65 6365 7373 6172 7920 666f 7220 6c6c  necessary for ll
+00074d60: 616d 610a 2020 2020 2020 2020 2020 2020  ama.            
+00074d70: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
+00074d80: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+00074d90: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+00074da0: 6772 6164 203d 2067 676d 6c5f 6164 645f  grad = ggml_add_
+00074db0: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
+00074dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074dd0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+00074de0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00074df0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00074e00: 6d6c 5f72 6d73 5f6e 6f72 6d5f 6261 636b  ml_rms_norm_back
+00074e10: 2863 7478 2c20 7372 6330 2c20 7465 6e73  (ctx, src0, tens
+00074e20: 6f72 2d3e 6772 6164 292c 0a20 2020 2020  or->grad),.     
+00074e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074e40: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+00074e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00074e60: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00074e70: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00074e80: 6361 7365 2047 474d 4c5f 4f50 5f52 4d53  case GGML_OP_RMS
+00074e90: 5f4e 4f52 4d5f 4241 434b 3a0a 2020 2020  _NORM_BACK:.    
+00074ea0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00074eb0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00074ec0: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+00074ed0: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
+00074ee0: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
+00074ef0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00074f00: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00074f10: 5f4d 554c 5f4d 4154 3a0a 2020 2020 2020  _MUL_MAT:.      
+00074f20: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00074f30: 2020 2020 2020 2020 2f2f 2068 7474 7073          // https
+00074f40: 3a2f 2f63 7332 3331 6e2e 6769 7468 7562  ://cs231n.github
+00074f50: 2e69 6f2f 6f70 7469 6d69 7a61 7469 6f6e  .io/optimization
+00074f60: 2d32 2f23 7374 6167 6564 0a20 2020 2020  -2/#staged.     
+00074f70: 2020 2020 2020 2020 2020 202f 2f20 2320             // # 
+00074f80: 666f 7277 6172 6420 7061 7373 0a20 2020  forward pass.   
+00074f90: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00074fa0: 7330 203d 206e 702e 7261 6e64 6f6d 2e72  s0 = np.random.r
+00074fb0: 616e 646e 2835 2c20 3130 290a 2020 2020  andn(5, 10).    
+00074fc0: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
+00074fd0: 3120 3d20 6e70 2e72 616e 646f 6d2e 7261  1 = np.random.ra
+00074fe0: 6e64 6e28 3130 2c20 3329 0a20 2020 2020  ndn(10, 3).     
+00074ff0: 2020 2020 2020 2020 2020 202f 2f20 7420             // t 
+00075000: 3d20 7330 2e64 6f74 2873 3129 0a0a 2020  = s0.dot(s1)..  
+00075010: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00075020: 2023 206e 6f77 2073 7570 706f 7365 2077   # now suppose w
+00075030: 6520 6861 6420 7468 6520 6772 6164 6965  e had the gradie
+00075040: 6e74 206f 6e20 7420 6672 6f6d 2061 626f  nt on t from abo
+00075050: 7665 2069 6e20 7468 6520 6369 7263 7569  ve in the circui
+00075060: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00075070: 2020 2f2f 2064 7420 3d20 6e70 2e72 616e    // dt = np.ran
+00075080: 646f 6d2e 7261 6e64 6e28 2a74 2e73 6861  dom.randn(*t.sha
+00075090: 7065 2920 2320 7361 6d65 2073 6861 7065  pe) # same shape
+000750a0: 2061 7320 740a 2020 2020 2020 2020 2020   as t.          
+000750b0: 2020 2020 2020 2f2f 2064 7330 203d 2064        // ds0 = d
+000750c0: 742e 646f 7428 7331 2e54 2920 232e 5420  t.dot(s1.T) #.T 
+000750d0: 6769 7665 7320 7468 6520 7472 616e 7370  gives the transp
+000750e0: 6f73 6520 6f66 2074 6865 206d 6174 7269  ose of the matri
+000750f0: 780a 2020 2020 2020 2020 2020 2020 2020  x.              
+00075100: 2020 2f2f 2064 7331 203d 2074 2e54 2e64    // ds1 = t.T.d
+00075110: 6f74 2864 7429 0a0a 2020 2020 2020 2020  ot(dt)..        
+00075120: 2020 2020 2020 2020 2f2f 2074 656e 736f          // tenso
+00075130: 722e 7368 6170 6520 5b6d 2c70 5d0a 2020  r.shape [m,p].  
+00075140: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00075150: 2073 7263 302e 7368 6170 6520 2020 5b6e   src0.shape   [n
+00075160: 2c6d 5d0a 2020 2020 2020 2020 2020 2020  ,m].            
+00075170: 2020 2020 2f2f 2073 7263 312e 7368 6170      // src1.shap
+00075180: 6520 2020 5b6e 2c70 5d0a 0a20 2020 2020  e   [n,p]..     
+00075190: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
+000751a0: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
+000751b0: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+000751c0: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+000751d0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000751e0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+000751f0: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
+00075200: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00075210: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
+00075220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075240: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
+00075250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075260: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00075270: 5f6f 7574 5f70 726f 6428 6374 782c 202f  _out_prod(ctx, /
+00075280: 2f20 5b6e 2c6d 5d0a 2020 2020 2020 2020  / [n,m].        
+00075290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000752a0: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+000752b0: 2c20 2020 2020 2020 2020 202f 2f20 5b6e  ,          // [n
+000752c0: 2c70 5d0a 2020 2020 2020 2020 2020 2020  ,p].            
+000752d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000752e0: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
+000752f0: 6772 6164 292c 202f 2f20 5b6d 2c70 5d0a  grad), // [m,p].
+00075300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075320: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+00075330: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00075340: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00075350: 7372 6331 2d3e 6772 6164 2920 7b0a 2020  src1->grad) {.  
+00075360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075370: 2020 7372 6331 2d3e 6772 6164 203d 0a20    src1->grad =. 
+00075380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075390: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
+000753a0: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
+000753b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000753c0: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+000753d0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
 000753e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000753f0: 2020 2020 2020 7372 6331 2c20 2020 2020        src1,     
-00075400: 2020 2020 202f 2f20 5b6e 2c70 5d0a 2020       // [n,p].  
-00075410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075430: 2020 7465 6e73 6f72 2d3e 6772 6164 292c    tensor->grad),
-00075440: 202f 2f20 5b6d 2c70 5d0a 2020 2020 2020   // [m,p].      
-00075450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075460: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-00075470: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00075480: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00075490: 2020 2020 2020 6966 2028 7372 6331 2d3e        if (src1->
-000754a0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-000754b0: 2020 2020 2020 2020 2020 2020 7372 6331              src1
-000754c0: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+000753f0: 2020 2020 2020 2f2f 2067 676d 6c5f 6d75        // ggml_mu
+00075400: 6c5f 6d61 7428 6374 782c 2020 2020 2020  l_mat(ctx,      
+00075410: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00075420: 5b6e 2c70 5d0a 2020 2020 2020 2020 2020  [n,p].          
+00075430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075440: 2020 2020 2020 2f2f 2020 2020 2067 676d        //     ggm
+00075450: 6c5f 636f 6e74 2863 7478 2c20 2020 2020  l_cont(ctx,     
+00075460: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00075470: 5b6d 2c6e 5d0a 2020 2020 2020 2020 2020  [m,n].          
+00075480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075490: 2020 2020 2020 2f2f 2020 2020 2020 2020        //        
+000754a0: 2067 676d 6c5f 7472 616e 7370 6f73 6528   ggml_transpose(
+000754b0: 6374 782c 2073 7263 3029 292c 202f 2f20  ctx, src0)), // 
+000754c0: 5b6d 2c6e 5d0a 2020 2020 2020 2020 2020  [m,n].          
 000754d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000754e0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-000754f0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-00075500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075510: 2020 2020 7372 6331 2d3e 6772 6164 2c0a      src1->grad,.
+000754e0: 2020 2020 2020 2f2f 2020 2020 2074 656e        //     ten
+000754f0: 736f 722d 3e67 7261 6429 2c20 2020 2020  sor->grad),     
+00075500: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00075510: 5b6d 2c70 5d0a 0a20 2020 2020 2020 2020  [m,p]..         
 00075520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075540: 2f2f 2067 676d 6c5f 6d75 6c5f 6d61 7428  // ggml_mul_mat(
-00075550: 6374 782c 2020 2020 2020 2020 2020 2020  ctx,            
-00075560: 2020 2020 2020 202f 2f20 5b6e 2c70 5d0a         // [n,p].
-00075570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075590: 2f2f 2020 2020 2067 676d 6c5f 636f 6e74  //     ggml_cont
-000755a0: 2863 7478 2c20 2020 2020 2020 2020 2020  (ctx,           
-000755b0: 2020 2020 2020 202f 2f20 5b6d 2c6e 5d0a         // [m,n].
-000755c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000755d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000755e0: 2f2f 2020 2020 2020 2020 2067 676d 6c5f  //         ggml_
-000755f0: 7472 616e 7370 6f73 6528 6374 782c 2073  transpose(ctx, s
-00075600: 7263 3029 292c 202f 2f20 5b6d 2c6e 5d0a  rc0)), // [m,n].
-00075610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075630: 2f2f 2020 2020 2074 656e 736f 722d 3e67  //     tensor->g
-00075640: 7261 6429 2c20 2020 2020 2020 2020 2020  rad),           
-00075650: 2020 2020 2020 202f 2f20 5b6d 2c70 5d0a         // [m,p].
-00075660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075680: 202f 2f20 2f2f 2077 6865 6e20 7372 6330   // // when src0
-00075690: 2069 7320 6269 6767 6572 2074 6861 6e20   is bigger than 
-000756a0: 7465 6e73 6f72 2d3e 6772 6164 2028 7468  tensor->grad (th
-000756b0: 6973 2069 7320 6d6f 7374 6c79 2074 6865  is is mostly the
-000756c0: 2063 6173 6520 696e 206c 6c61 6d61 292c   case in llama),
-000756d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000756e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000756f0: 202f 2f20 2f2f 2061 766f 6964 2074 7261   // // avoid tra
-00075700: 6e73 706f 7365 206f 6620 7372 6330 2c20  nspose of src0, 
-00075710: 7261 7468 6572 2074 7261 6e73 706f 7365  rather transpose
-00075720: 2073 6d61 6c6c 6572 2074 656e 736f 722d   smaller tensor-
-00075730: 3e67 7261 640a 2020 2020 2020 2020 2020  >grad.          
-00075740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075750: 2020 2020 2020 2f2f 202f 2f20 616e 6420        // // and 
-00075760: 7468 656e 2075 7365 2067 676d 6c5f 6f75  then use ggml_ou
-00075770: 745f 7072 6f64 0a20 2020 2020 2020 2020  t_prod.         
-00075780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075790: 2020 2020 2020 2067 676d 6c5f 6f75 745f         ggml_out_
-000757a0: 7072 6f64 2863 7478 2c20 2020 2020 2020  prod(ctx,       
-000757b0: 2020 2020 2020 2020 2020 202f 2f20 5b6e             // [n
-000757c0: 2c70 5d0a 2020 2020 2020 2020 2020 2020  ,p].            
-000757d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000757e0: 2020 2020 2020 2020 7372 6330 2c20 2020          src0,   
-000757f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075800: 2020 2020 2020 2020 2f2f 205b 6e2c 6d5d          // [n,m]
-00075810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075830: 2020 2020 2067 676d 6c5f 7472 616e 7370       ggml_transp
-00075840: 6f73 6528 6374 782c 2020 2020 2020 2020  ose(ctx,        
-00075850: 2020 2020 202f 2f20 5b70 2c6d 5d0a 2020       // [p,m].  
-00075860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075880: 2020 2020 2020 7465 6e73 6f72 2d3e 6772        tensor->gr
-00075890: 6164 2929 2c20 2020 2020 2020 2020 2020  ad)),           
-000758a0: 2020 2f2f 205b 6d2c 705d 0a20 2020 2020    // [m,p].     
-000758b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000758c0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-000758d0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-000758e0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000758f0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00075900: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00075910: 5f4f 5554 5f50 524f 443a 0a20 2020 2020  _OUT_PROD:.     
-00075920: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00075930: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00075940: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
-00075950: 544f 444f 3a20 6e6f 7420 696d 706c 656d  TODO: not implem
-00075960: 656e 7465 640a 2020 2020 2020 2020 2020  ented.          
-00075970: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00075980: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00075990: 5343 414c 453a 0a20 2020 2020 2020 2020  SCALE:.         
-000759a0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000759b0: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
-000759c0: 7920 666f 7220 6c6c 616d 610a 2020 2020  y for llama.    
-000759d0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-000759e0: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
-000759f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075a00: 2020 7372 6330 2d3e 6772 6164 203d 0a20    src0->grad =. 
+00075530: 2020 2020 2020 202f 2f20 2f2f 2077 6865         // // whe
+00075540: 6e20 7372 6330 2069 7320 6269 6767 6572  n src0 is bigger
+00075550: 2074 6861 6e20 7465 6e73 6f72 2d3e 6772   than tensor->gr
+00075560: 6164 2028 7468 6973 2069 7320 6d6f 7374  ad (this is most
+00075570: 6c79 2074 6865 2063 6173 6520 696e 206c  ly the case in l
+00075580: 6c61 6d61 292c 0a20 2020 2020 2020 2020  lama),.         
+00075590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000755a0: 2020 2020 2020 202f 2f20 2f2f 2061 766f         // // avo
+000755b0: 6964 2074 7261 6e73 706f 7365 206f 6620  id transpose of 
+000755c0: 7372 6330 2c20 7261 7468 6572 2074 7261  src0, rather tra
+000755d0: 6e73 706f 7365 2073 6d61 6c6c 6572 2074  nspose smaller t
+000755e0: 656e 736f 722d 3e67 7261 640a 2020 2020  ensor->grad.    
+000755f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075600: 2020 2020 2020 2020 2020 2020 2f2f 202f              // /
+00075610: 2f20 616e 6420 7468 656e 2075 7365 2067  / and then use g
+00075620: 676d 6c5f 6f75 745f 7072 6f64 0a20 2020  gml_out_prod.   
+00075630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075640: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00075650: 6c5f 6f75 745f 7072 6f64 2863 7478 2c20  l_out_prod(ctx, 
+00075660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075670: 202f 2f20 5b6e 2c70 5d0a 2020 2020 2020   // [n,p].      
+00075680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075690: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+000756a0: 6330 2c20 2020 2020 2020 2020 2020 2020  c0,             
+000756b0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+000756c0: 205b 6e2c 6d5d 0a20 2020 2020 2020 2020   [n,m].         
+000756d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000756e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000756f0: 7472 616e 7370 6f73 6528 6374 782c 2020  transpose(ctx,  
+00075700: 2020 2020 2020 2020 2020 202f 2f20 5b70             // [p
+00075710: 2c6d 5d0a 2020 2020 2020 2020 2020 2020  ,m].            
+00075720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075730: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+00075740: 6f72 2d3e 6772 6164 2929 2c20 2020 2020  or->grad)),     
+00075750: 2020 2020 2020 2020 2f2f 205b 6d2c 705d          // [m,p]
+00075760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00075770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075780: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+00075790: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000757a0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+000757b0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+000757c0: 474d 4c5f 4f50 5f4f 5554 5f50 524f 443a  GML_OP_OUT_PROD:
+000757d0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000757e0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+000757f0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00075800: 293b 202f 2f20 544f 444f 3a20 6e6f 7420  ); // TODO: not 
+00075810: 696d 706c 656d 656e 7465 640a 2020 2020  implemented.    
+00075820: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00075830: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00075840: 4d4c 5f4f 505f 5343 414c 453a 0a20 2020  ML_OP_SCALE:.   
+00075850: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00075860: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
+00075870: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
+00075880: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+00075890: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+000758a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000758b0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+000758c0: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
+000758d0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000758e0: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
+000758f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075900: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+00075910: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+00075920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075930: 2020 2020 6767 6d6c 5f73 6361 6c65 5f69      ggml_scale_i
+00075940: 6d70 6c28 6374 782c 2074 656e 736f 722d  mpl(ctx, tensor-
+00075950: 3e67 7261 642c 2073 7263 312c 2066 616c  >grad, src1, fal
+00075960: 7365 292c 0a20 2020 2020 2020 2020 2020  se),.           
+00075970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075980: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+00075990: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000759a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000759b0: 2873 7263 312d 3e67 7261 6429 207b 0a20  (src1->grad) {. 
+000759c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000759d0: 2020 2073 7263 312d 3e67 7261 6420 3d0a     src1->grad =.
+000759e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000759f0: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
+00075a00: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
 00075a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075a20: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
-00075a30: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
-00075a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075a50: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-00075a60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00075a70: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00075a80: 6d6c 5f73 6361 6c65 5f69 6d70 6c28 6374  ml_scale_impl(ct
-00075a90: 782c 2074 656e 736f 722d 3e67 7261 642c  x, tensor->grad,
-00075aa0: 2073 7263 312c 2066 616c 7365 292c 0a20   src1, false),. 
-00075ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075ac0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-00075ad0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-00075ae0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00075af0: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
-00075b00: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-00075b10: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00075b20: 312d 3e67 7261 6420 3d0a 2020 2020 2020  1->grad =.      
-00075b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075b40: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
-00075b50: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00075b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075b70: 2073 7263 312d 3e67 7261 642c 0a20 2020   src1->grad,.   
-00075b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075b90: 2020 2020 2020 2020 2067 676d 6c5f 7375           ggml_su
-00075ba0: 6d28 6374 782c 2067 676d 6c5f 6d75 6c5f  m(ctx, ggml_mul_
-00075bb0: 696d 706c 2863 7478 2c20 7465 6e73 6f72  impl(ctx, tensor
-00075bc0: 2d3e 6772 6164 2c20 7372 6330 2c20 6661  ->grad, src0, fa
-00075bd0: 6c73 6529 292c 0a20 2020 2020 2020 2020  lse)),.         
-00075be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075bf0: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
-00075c00: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00075c10: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00075c20: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00075c30: 2047 474d 4c5f 4f50 5f53 4554 3a0a 2020   GGML_OP_SET:.  
-00075c40: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00075c50: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00075c60: 5f41 5353 4552 5428 6767 6d6c 5f6e 656c  _ASSERT(ggml_nel
-00075c70: 656d 656e 7473 2874 656e 736f 722d 3e6f  ements(tensor->o
-00075c80: 7074 5b30 5d29 203d 3d20 3529 3b0a 2020  pt[0]) == 5);.  
-00075c90: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00075ca0: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
-00075cb0: 2d3e 6f70 745b 305d 2d3e 7479 7065 203d  ->opt[0]->type =
-00075cc0: 3d20 4747 4d4c 5f54 5950 455f 4933 3229  = GGML_TYPE_I32)
-00075cd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00075ce0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00075cf0: 6231 2020 2020 203d 2028 2820 696e 7433  b1     = (( int3
-00075d00: 325f 7420 2a20 2920 7465 6e73 6f72 2d3e  2_t * ) tensor->
-00075d10: 6f70 745b 305d 2d3e 6461 7461 295b 305d  opt[0]->data)[0]
-00075d20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00075d30: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00075d40: 6232 2020 2020 203d 2028 2820 696e 7433  b2     = (( int3
-00075d50: 325f 7420 2a20 2920 7465 6e73 6f72 2d3e  2_t * ) tensor->
-00075d60: 6f70 745b 305d 2d3e 6461 7461 295b 315d  opt[0]->data)[1]
-00075d70: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00075d80: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-00075d90: 6233 2020 2020 203d 2028 2820 696e 7433  b3     = (( int3
-00075da0: 325f 7420 2a20 2920 7465 6e73 6f72 2d3e  2_t * ) tensor->
-00075db0: 6f70 745b 305d 2d3e 6461 7461 295b 325d  opt[0]->data)[2]
-00075dc0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00075dd0: 2020 636f 6e73 7420 7369 7a65 5f74 206f    const size_t o
-00075de0: 6666 7365 7420 203d 2028 2820 696e 7433  ffset  = (( int3
-00075df0: 325f 7420 2a20 2920 7465 6e73 6f72 2d3e  2_t * ) tensor->
-00075e00: 6f70 745b 305d 2d3e 6461 7461 295b 335d  opt[0]->data)[3]
-00075e10: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00075e20: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00075e30: 656e 736f 7220 2a20 7465 6e73 6f72 5f67  ensor * tensor_g
-00075e40: 7261 645f 7669 6577 203d 204e 554c 4c3b  rad_view = NULL;
-00075e50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00075e60: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-00075e70: 207c 7c20 7372 6331 2d3e 6772 6164 2920   || src1->grad) 
-00075e80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00075e90: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00075ea0: 5428 7372 6330 2d3e 7479 7065 203d 3d20  T(src0->type == 
-00075eb0: 7465 6e73 6f72 2d3e 7479 7065 293b 0a20  tensor->type);. 
+00075a20: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
+00075a30: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00075a40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00075a50: 676d 6c5f 7375 6d28 6374 782c 2067 676d  gml_sum(ctx, ggm
+00075a60: 6c5f 6d75 6c5f 696d 706c 2863 7478 2c20  l_mul_impl(ctx, 
+00075a70: 7465 6e73 6f72 2d3e 6772 6164 2c20 7372  tensor->grad, sr
+00075a80: 6330 2c20 6661 6c73 6529 292c 0a20 2020  c0, false)),.   
+00075a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075aa0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+00075ab0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00075ac0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00075ad0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00075ae0: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+00075af0: 4554 3a0a 2020 2020 2020 2020 2020 2020  ET:.            
+00075b00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00075b10: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+00075b20: 6d6c 5f6e 656c 656d 656e 7473 2874 656e  ml_nelements(ten
+00075b30: 736f 722d 3e6f 7074 5b30 5d29 203d 3d20  sor->opt[0]) == 
+00075b40: 3529 3b0a 2020 2020 2020 2020 2020 2020  5);.            
+00075b50: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00075b60: 7465 6e73 6f72 2d3e 6f70 745b 305d 2d3e  tensor->opt[0]->
+00075b70: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+00075b80: 455f 4933 3229 3b0a 2020 2020 2020 2020  E_I32);.        
+00075b90: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+00075ba0: 7a65 5f74 206e 6231 2020 2020 203d 2028  ze_t nb1     = (
+00075bb0: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
+00075bc0: 6e73 6f72 2d3e 6f70 745b 305d 2d3e 6461  nsor->opt[0]->da
+00075bd0: 7461 295b 305d 3b0a 2020 2020 2020 2020  ta)[0];.        
+00075be0: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+00075bf0: 7a65 5f74 206e 6232 2020 2020 203d 2028  ze_t nb2     = (
+00075c00: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
+00075c10: 6e73 6f72 2d3e 6f70 745b 305d 2d3e 6461  nsor->opt[0]->da
+00075c20: 7461 295b 315d 3b0a 2020 2020 2020 2020  ta)[1];.        
+00075c30: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+00075c40: 7a65 5f74 206e 6233 2020 2020 203d 2028  ze_t nb3     = (
+00075c50: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
+00075c60: 6e73 6f72 2d3e 6f70 745b 305d 2d3e 6461  nsor->opt[0]->da
+00075c70: 7461 295b 325d 3b0a 2020 2020 2020 2020  ta)[2];.        
+00075c80: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+00075c90: 7a65 5f74 206f 6666 7365 7420 203d 2028  ze_t offset  = (
+00075ca0: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
+00075cb0: 6e73 6f72 2d3e 6f70 745b 305d 2d3e 6461  nsor->opt[0]->da
+00075cc0: 7461 295b 335d 3b0a 0a20 2020 2020 2020  ta)[3];..       
+00075cd0: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+00075ce0: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
+00075cf0: 6e73 6f72 5f67 7261 645f 7669 6577 203d  nsor_grad_view =
+00075d00: 204e 554c 4c3b 0a0a 2020 2020 2020 2020   NULL;..        
+00075d10: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+00075d20: 2d3e 6772 6164 207c 7c20 7372 6331 2d3e  ->grad || src1->
+00075d30: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00075d40: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00075d50: 5f41 5353 4552 5428 7372 6330 2d3e 7479  _ASSERT(src0->ty
+00075d60: 7065 203d 3d20 7465 6e73 6f72 2d3e 7479  pe == tensor->ty
+00075d70: 7065 293b 0a20 2020 2020 2020 2020 2020  pe);.           
+00075d80: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00075d90: 5345 5254 2874 656e 736f 722d 3e67 7261  SERT(tensor->gra
+00075da0: 642d 3e74 7970 6520 3d3d 2074 656e 736f  d->type == tenso
+00075db0: 722d 3e74 7970 6529 3b0a 2020 2020 2020  r->type);.      
+00075dc0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00075dd0: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
+00075de0: 2d3e 6772 6164 2d3e 7479 7065 203d 3d20  ->grad->type == 
+00075df0: 7372 6331 2d3e 6772 6164 2d3e 7479 7065  src1->grad->type
+00075e00: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00075e10: 2020 2020 2020 2020 7465 6e73 6f72 5f67          tensor_g
+00075e20: 7261 645f 7669 6577 203d 2067 676d 6c5f  rad_view = ggml_
+00075e30: 7669 6577 5f34 6428 6374 782c 0a20 2020  view_4d(ctx,.   
+00075e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075e50: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
+00075e60: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00075e70: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
+00075e80: 3e67 7261 642d 3e6e 655b 305d 2c0a 2020  >grad->ne[0],.  
+00075e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075ea0: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
+00075eb0: 2d3e 6e65 5b31 5d2c 0a20 2020 2020 2020  ->ne[1],.       
 00075ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075ed0: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
-00075ee0: 656e 736f 722d 3e67 7261 642d 3e74 7970  ensor->grad->typ
-00075ef0: 6520 3d3d 2074 656e 736f 722d 3e74 7970  e == tensor->typ
-00075f00: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00075f10: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00075f20: 4552 5428 7465 6e73 6f72 2d3e 6772 6164  ERT(tensor->grad
-00075f30: 2d3e 7479 7065 203d 3d20 7372 6331 2d3e  ->type == src1->
-00075f40: 6772 6164 2d3e 7479 7065 293b 0a0a 2020  grad->type);..  
-00075f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075f60: 2020 7465 6e73 6f72 5f67 7261 645f 7669    tensor_grad_vi
-00075f70: 6577 203d 2067 676d 6c5f 7669 6577 5f34  ew = ggml_view_4
-00075f80: 6428 6374 782c 0a20 2020 2020 2020 2020  d(ctx,.         
-00075f90: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00075fa0: 656e 736f 722d 3e67 7261 642c 0a20 2020  ensor->grad,.   
+00075ed0: 2073 7263 312d 3e67 7261 642d 3e6e 655b   src1->grad->ne[
+00075ee0: 325d 2c0a 2020 2020 2020 2020 2020 2020  2],.            
+00075ef0: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+00075f00: 2d3e 6772 6164 2d3e 6e65 5b33 5d2c 0a20  ->grad->ne[3],. 
+00075f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075f20: 2020 2020 2020 206e 6231 2c20 6e62 322c         nb1, nb2,
+00075f30: 206e 6233 2c20 6f66 6673 6574 293b 0a20   nb3, offset);. 
+00075f40: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00075f50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00075f60: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+00075f70: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00075f80: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+00075f90: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
+00075fa0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
 00075fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075fc0: 2020 2020 2073 7263 312d 3e67 7261 642d       src1->grad-
-00075fd0: 3e6e 655b 305d 2c0a 2020 2020 2020 2020  >ne[0],.        
-00075fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075ff0: 7372 6331 2d3e 6772 6164 2d3e 6e65 5b31  src1->grad->ne[1
-00076000: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00076010: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-00076020: 3e67 7261 642d 3e6e 655b 325d 2c0a 2020  >grad->ne[2],.  
-00076030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076040: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
-00076050: 2d3e 6e65 5b33 5d2c 0a20 2020 2020 2020  ->ne[3],.       
+00075fc0: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
+00075fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075fe0: 2020 2020 6767 6d6c 5f61 6363 5f69 6d70      ggml_acc_imp
+00075ff0: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+00076000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076010: 2020 2074 656e 736f 722d 3e67 7261 642c     tensor->grad,
+00076020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00076030: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00076040: 6c5f 6e65 6728 6374 782c 2074 656e 736f  l_neg(ctx, tenso
+00076050: 725f 6772 6164 5f76 6965 7729 2c0a 2020  r_grad_view),.  
 00076060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076070: 206e 6231 2c20 6e62 322c 206e 6233 2c20   nb1, nb2, nb3, 
-00076080: 6f66 6673 6574 293b 0a20 2020 2020 2020  offset);.       
-00076090: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-000760a0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-000760b0: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
-000760c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000760d0: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
-000760e0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-000760f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00076100: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00076110: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-00076120: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00076130: 6d6c 5f61 6363 5f69 6d70 6c28 6374 782c  ml_acc_impl(ctx,
-00076140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076150: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-00076160: 736f 722d 3e67 7261 642c 0a20 2020 2020  sor->grad,.     
+00076070: 2020 2020 2020 2020 2020 6e62 312c 206e            nb1, n
+00076080: 6232 2c20 6e62 332c 206f 6666 7365 742c  b2, nb3, offset,
+00076090: 2066 616c 7365 292c 0a20 2020 2020 2020   false),.       
+000760a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000760b0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+000760c0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+000760d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000760e0: 2028 7372 6331 2d3e 6772 6164 2920 7b0a   (src1->grad) {.
+000760f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076100: 2020 2020 7372 6331 2d3e 6772 6164 203d      src1->grad =
+00076110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00076120: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
+00076130: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
+00076140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076150: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
+00076160: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
 00076170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076180: 2020 2020 2020 2067 676d 6c5f 6e65 6728         ggml_neg(
-00076190: 6374 782c 2074 656e 736f 725f 6772 6164  ctx, tensor_grad
-000761a0: 5f76 6965 7729 2c0a 2020 2020 2020 2020  _view),.        
-000761b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000761c0: 2020 2020 6e62 312c 206e 6232 2c20 6e62      nb1, nb2, nb
-000761d0: 332c 206f 6666 7365 742c 2066 616c 7365  3, offset, false
-000761e0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000761f0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-00076200: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-00076210: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00076220: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
-00076230: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-00076240: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00076250: 6331 2d3e 6772 6164 203d 0a20 2020 2020  c1->grad =.     
-00076260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076270: 2020 2067 676d 6c5f 6164 645f 696d 706c     ggml_add_impl
-00076280: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-00076290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000762a0: 2020 7372 6331 2d3e 6772 6164 2c0a 2020    src1->grad,.  
-000762b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000762c0: 2020 2020 2020 2020 2020 6767 6d6c 5f72            ggml_r
-000762d0: 6573 6861 7065 2863 7478 2c0a 2020 2020  eshape(ctx,.    
-000762e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000762f0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00076300: 5f63 6f6e 7428 6374 782c 2074 656e 736f  _cont(ctx, tenso
-00076310: 725f 6772 6164 5f76 6965 7729 2c0a 2020  r_grad_view),.  
-00076320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076330: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00076340: 6331 2d3e 6772 6164 292c 0a20 2020 2020  c1->grad),.     
-00076350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076360: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
-00076370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076380: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-00076390: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000763a0: 6361 7365 2047 474d 4c5f 4f50 5f43 5059  case GGML_OP_CPY
-000763b0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000763c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000763d0: 2f2f 206e 6563 6573 7361 7279 2066 6f72  // necessary for
-000763e0: 206c 6c61 6d61 0a20 2020 2020 2020 2020   llama.         
-000763f0: 2020 2020 2020 202f 2f20 6370 7920 6f76         // cpy ov
-00076400: 6572 7772 6974 6573 2076 616c 7565 206f  erwrites value o
-00076410: 6620 7372 6331 2062 7920 7372 6330 2061  f src1 by src0 a
-00076420: 6e64 2072 6574 7572 6e73 2076 6965 7728  nd returns view(
-00076430: 7372 6331 290a 2020 2020 2020 2020 2020  src1).          
-00076440: 2020 2020 2020 2f2f 2074 6865 206f 7665        // the ove
-00076450: 7277 7269 7469 6e67 2069 7320 6d61 7468  rwriting is math
-00076460: 656d 6174 6963 616c 6c79 2065 7175 6976  ematically equiv
-00076470: 616c 656e 7420 746f 3a0a 2020 2020 2020  alent to:.      
-00076480: 2020 2020 2020 2020 2020 2f2f 2074 656e            // ten
-00076490: 736f 7220 3d20 7372 6330 202a 2031 202b  sor = src0 * 1 +
-000764a0: 2073 7263 3120 2a20 300a 2020 2020 2020   src1 * 0.      
-000764b0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-000764c0: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-000764d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000764e0: 2f2f 2064 7372 6330 203d 2064 7465 6e73  // dsrc0 = dtens
-000764f0: 6f72 202a 2031 0a20 2020 2020 2020 2020  or * 1.         
-00076500: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-00076510: 3e67 7261 6420 3d20 6767 6d6c 5f61 6464  >grad = ggml_add
-00076520: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
-00076530: 3e67 7261 642c 2074 656e 736f 722d 3e67  >grad, tensor->g
-00076540: 7261 642c 2069 6e70 6c61 6365 293b 0a20  rad, inplace);. 
-00076550: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00076560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076570: 2069 6620 2873 7263 312d 3e67 7261 6429   if (src1->grad)
-00076580: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00076590: 2020 2020 2020 202f 2f20 6473 7263 3120         // dsrc1 
-000765a0: 3d20 6474 656e 736f 7220 2a20 3020 2d3e  = dtensor * 0 ->
-000765b0: 206e 6f6f 700a 2020 2020 2020 2020 2020   noop.          
-000765c0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000765d0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-000765e0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000765f0: 505f 434f 4e54 3a0a 2020 2020 2020 2020  P_CONT:.        
-00076600: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00076610: 2020 2020 2020 2f2f 2073 616d 6520 6173        // same as
-00076620: 2063 7079 0a20 2020 2020 2020 2020 2020   cpy.           
-00076630: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
-00076640: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
-00076650: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00076660: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
-00076670: 6f6e 7469 6775 6f75 7328 7372 6330 2d3e  ontiguous(src0->
-00076680: 6772 6164 2929 3b0a 2020 2020 2020 2020  grad));.        
-00076690: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-000766a0: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
-000766b0: 636f 6e74 6967 756f 7573 2874 656e 736f  contiguous(tenso
-000766c0: 722d 3e67 7261 6429 293b 0a20 2020 2020  r->grad));.     
-000766d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000766e0: 7263 302d 3e67 7261 6420 3d20 6767 6d6c  rc0->grad = ggml
-000766f0: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
-00076700: 7263 302d 3e67 7261 642c 2074 656e 736f  rc0->grad, tenso
-00076710: 722d 3e67 7261 642c 2069 6e70 6c61 6365  r->grad, inplace
-00076720: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00076730: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00076740: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00076750: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-00076760: 4553 4841 5045 3a0a 2020 2020 2020 2020  ESHAPE:.        
-00076770: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00076780: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
-00076790: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
-000767a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000767b0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-000767c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000767d0: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
-000767e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000767f0: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
-00076800: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
-00076810: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-00076820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076830: 2020 2067 676d 6c5f 7265 7368 6170 6528     ggml_reshape(
-00076840: 6374 782c 2074 656e 736f 722d 3e67 7261  ctx, tensor->gra
-00076850: 642c 2073 7263 302d 3e67 7261 6429 2c0a  d, src0->grad),.
-00076860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076870: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-00076880: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00076890: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-000768a0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-000768b0: 2063 6173 6520 4747 4d4c 5f4f 505f 5649   case GGML_OP_VI
-000768c0: 4557 3a0a 2020 2020 2020 2020 2020 2020  EW:.            
-000768d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000768e0: 2020 2f2f 206e 6563 6573 7361 7279 2066    // necessary f
-000768f0: 6f72 206c 6c61 6d61 0a20 2020 2020 2020  or llama.       
-00076900: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-00076910: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
-00076920: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00076930: 697a 655f 7420 6f66 6673 6574 3b0a 0a20  ize_t offset;.. 
-00076940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076950: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
-00076960: 697a 656f 6628 6f66 6673 6574 2920 3c3d  izeof(offset) <=
-00076970: 2067 676d 6c5f 6e62 7974 6573 2874 656e   ggml_nbytes(ten
-00076980: 736f 722d 3e6f 7074 5b30 5d29 293b 0a20  sor->opt[0]));. 
-00076990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000769a0: 2020 206d 656d 6370 7928 266f 6666 7365     memcpy(&offse
-000769b0: 742c 2074 656e 736f 722d 3e6f 7074 5b30  t, tensor->opt[0
-000769c0: 5d2d 3e64 6174 612c 2073 697a 656f 6628  ]->data, sizeof(
-000769d0: 6f66 6673 6574 2929 3b0a 0a20 2020 2020  offset));..     
-000769e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000769f0: 697a 655f 7420 6e62 3120 2020 2020 3d20  ize_t nb1     = 
-00076a00: 7465 6e73 6f72 2d3e 6e62 5b31 5d3b 0a20  tensor->nb[1];. 
-00076a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076a20: 2020 2073 697a 655f 7420 6e62 3220 2020     size_t nb2   
-00076a30: 2020 3d20 7465 6e73 6f72 2d3e 6e62 5b32    = tensor->nb[2
-00076a40: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-00076a50: 2020 2020 2020 2073 697a 655f 7420 6e62         size_t nb
-00076a60: 3320 2020 2020 3d20 7465 6e73 6f72 2d3e  3     = tensor->
-00076a70: 6e62 5b33 5d3b 0a0a 2020 2020 2020 2020  nb[3];..        
-00076a80: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00076a90: 7372 6330 2d3e 7479 7065 2021 3d20 7372  src0->type != sr
-00076aa0: 6330 2d3e 6772 6164 2d3e 7479 7065 2920  c0->grad->type) 
-00076ab0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00076ac0: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
-00076ad0: 6469 656e 7420 6973 2074 7970 6963 616c  dient is typical
-00076ae0: 6c79 2046 3332 2c20 6275 7420 7372 6330  ly F32, but src0
-00076af0: 2063 6f75 6c64 2062 6520 6f74 6865 7220   could be other 
-00076b00: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
-00076b10: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-00076b20: 655f 7420 6e67 203d 2067 676d 6c5f 656c  e_t ng = ggml_el
-00076b30: 656d 656e 745f 7369 7a65 2873 7263 302d  ement_size(src0-
-00076b40: 3e67 7261 6429 3b0a 2020 2020 2020 2020  >grad);.        
-00076b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076b60: 7369 7a65 5f74 206e 3020 3d20 6767 6d6c  size_t n0 = ggml
-00076b70: 5f65 6c65 6d65 6e74 5f73 697a 6528 7372  _element_size(sr
-00076b80: 6330 293b 0a20 2020 2020 2020 2020 2020  c0);.           
-00076b90: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00076ba0: 4c5f 4153 5345 5254 286f 6666 7365 7420  L_ASSERT(offset 
-00076bb0: 2520 6e30 203d 3d20 3029 3b0a 2020 2020  % n0 == 0);.    
-00076bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076bd0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00076be0: 6e62 3120 2520 6e30 203d 3d20 3029 3b0a  nb1 % n0 == 0);.
-00076bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076c00: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00076c10: 4552 5428 6e62 3220 2520 6e30 203d 3d20  ERT(nb2 % n0 == 
-00076c20: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
-00076c30: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00076c40: 5f41 5353 4552 5428 6e62 3320 2520 6e30  _ASSERT(nb3 % n0
-00076c50: 203d 3d20 3029 3b0a 2020 2020 2020 2020   == 0);.        
-00076c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076c70: 6f66 6673 6574 203d 2028 6f66 6673 6574  offset = (offset
-00076c80: 202f 206e 3029 202a 206e 673b 0a20 2020   / n0) * ng;.   
-00076c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076ca0: 2020 2020 206e 6231 203d 2028 6e62 3120       nb1 = (nb1 
-00076cb0: 2f20 6e30 2920 2a20 6e67 3b0a 2020 2020  / n0) * ng;.    
-00076cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076cd0: 2020 2020 6e62 3220 3d20 286e 6232 202f      nb2 = (nb2 /
-00076ce0: 206e 3029 202a 206e 673b 0a20 2020 2020   n0) * ng;.     
-00076cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076d00: 2020 206e 6233 203d 2028 6e62 3320 2f20     nb3 = (nb3 / 
-00076d10: 6e30 2920 2a20 6e67 3b0a 2020 2020 2020  n0) * ng;.      
-00076d20: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00076d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076d40: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-00076d50: 3d20 6767 6d6c 5f61 6363 5f69 6d70 6c28  = ggml_acc_impl(
-00076d60: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
-00076d70: 2074 656e 736f 722d 3e67 7261 642c 206e   tensor->grad, n
-00076d80: 6231 2c20 6e62 322c 206e 6233 2c20 6f66  b1, nb2, nb3, of
-00076d90: 6673 6574 2c20 696e 706c 6163 6529 3b0a  fset, inplace);.
-00076da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076db0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-00076dc0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00076dd0: 6173 6520 4747 4d4c 5f4f 505f 5045 524d  ase GGML_OP_PERM
-00076de0: 5554 453a 0a20 2020 2020 2020 2020 2020  UTE:.           
-00076df0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00076e00: 2020 202f 2f20 6e65 6365 7373 6172 7920     // necessary 
-00076e10: 666f 7220 6c6c 616d 610a 2020 2020 2020  for llama.      
-00076e20: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-00076e30: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-00076e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076e50: 696e 7433 325f 7420 2a20 6178 6573 203d  int32_t * axes =
-00076e60: 2028 696e 7433 325f 7420 2a29 2074 656e   (int32_t *) ten
-00076e70: 736f 722d 3e6f 7074 5b30 5d2d 3e64 6174  sor->opt[0]->dat
-00076e80: 613b 0a20 2020 2020 2020 2020 2020 2020  a;.             
-00076e90: 2020 2020 2020 2069 6e74 2061 7869 7330         int axis0
-00076ea0: 203d 2061 7865 735b 305d 2026 2030 7833   = axes[0] & 0x3
-00076eb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00076ec0: 2020 2020 2020 696e 7420 6178 6973 3120        int axis1 
-00076ed0: 3d20 6178 6573 5b31 5d20 2620 3078 333b  = axes[1] & 0x3;
-00076ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076ef0: 2020 2020 2069 6e74 2061 7869 7332 203d       int axis2 =
-00076f00: 2061 7865 735b 325d 2026 2030 7833 3b0a   axes[2] & 0x3;.
-00076f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076f20: 2020 2020 696e 7420 6178 6973 3320 3d20      int axis3 = 
-00076f30: 6178 6573 5b33 5d20 2620 3078 333b 0a20  axes[3] & 0x3;. 
+00076180: 6767 6d6c 5f72 6573 6861 7065 2863 7478  ggml_reshape(ctx
+00076190: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000761a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000761b0: 2020 6767 6d6c 5f63 6f6e 7428 6374 782c    ggml_cont(ctx,
+000761c0: 2074 656e 736f 725f 6772 6164 5f76 6965   tensor_grad_vie
+000761d0: 7729 2c0a 2020 2020 2020 2020 2020 2020  w),.            
+000761e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000761f0: 2020 2020 7372 6331 2d3e 6772 6164 292c      src1->grad),
+00076200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00076210: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00076220: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+00076230: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00076240: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00076250: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00076260: 4f50 5f43 5059 3a0a 2020 2020 2020 2020  OP_CPY:.        
+00076270: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00076280: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
+00076290: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
+000762a0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+000762b0: 6370 7920 6f76 6572 7772 6974 6573 2076  cpy overwrites v
+000762c0: 616c 7565 206f 6620 7372 6331 2062 7920  alue of src1 by 
+000762d0: 7372 6330 2061 6e64 2072 6574 7572 6e73  src0 and returns
+000762e0: 2076 6965 7728 7372 6331 290a 2020 2020   view(src1).    
+000762f0: 2020 2020 2020 2020 2020 2020 2f2f 2074              // t
+00076300: 6865 206f 7665 7277 7269 7469 6e67 2069  he overwriting i
+00076310: 7320 6d61 7468 656d 6174 6963 616c 6c79  s mathematically
+00076320: 2065 7175 6976 616c 656e 7420 746f 3a0a   equivalent to:.
+00076330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076340: 2f2f 2074 656e 736f 7220 3d20 7372 6330  // tensor = src0
+00076350: 202a 2031 202b 2073 7263 3120 2a20 300a   * 1 + src1 * 0.
+00076360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076370: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+00076380: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00076390: 2020 2020 2020 2f2f 2064 7372 6330 203d        // dsrc0 =
+000763a0: 2064 7465 6e73 6f72 202a 2031 0a20 2020   dtensor * 1.   
+000763b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000763c0: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
+000763d0: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+000763e0: 2073 7263 302d 3e67 7261 642c 2074 656e   src0->grad, ten
+000763f0: 736f 722d 3e67 7261 642c 2069 6e70 6c61  sor->grad, inpla
+00076400: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+00076410: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00076420: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
+00076430: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+00076440: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00076450: 6473 7263 3120 3d20 6474 656e 736f 7220  dsrc1 = dtensor 
+00076460: 2a20 3020 2d3e 206e 6f6f 700a 2020 2020  * 0 -> noop.    
+00076470: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00076480: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00076490: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+000764a0: 4747 4d4c 5f4f 505f 434f 4e54 3a0a 2020  GGML_OP_CONT:.  
+000764b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000764c0: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
+000764d0: 616d 6520 6173 2063 7079 0a20 2020 2020  ame as cpy.     
+000764e0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+000764f0: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
+00076500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076510: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00076520: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
+00076530: 7372 6330 2d3e 6772 6164 2929 3b0a 2020  src0->grad));.  
+00076540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076550: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+00076560: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
+00076570: 2874 656e 736f 722d 3e67 7261 6429 293b  (tensor->grad));
+00076580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00076590: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
+000765a0: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
+000765b0: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
+000765c0: 2074 656e 736f 722d 3e67 7261 642c 2069   tensor->grad, i
+000765d0: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+000765e0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000765f0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00076600: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00076610: 4c5f 4f50 5f52 4553 4841 5045 3a0a 2020  L_OP_RESHAPE:.  
+00076620: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00076630: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
+00076640: 6563 6573 7361 7279 2066 6f72 206c 6c61  ecessary for lla
+00076650: 6d61 0a20 2020 2020 2020 2020 2020 2020  ma.             
+00076660: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+00076670: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00076680: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+00076690: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
+000766a0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000766b0: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+000766c0: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
+000766d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000766e0: 2020 2020 2020 2020 2067 676d 6c5f 7265           ggml_re
+000766f0: 7368 6170 6528 6374 782c 2074 656e 736f  shape(ctx, tenso
+00076700: 722d 3e67 7261 642c 2073 7263 302d 3e67  r->grad, src0->g
+00076710: 7261 6429 2c0a 2020 2020 2020 2020 2020  rad),.          
+00076720: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00076730: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+00076740: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00076750: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00076760: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00076770: 5f4f 505f 5649 4557 3a0a 2020 2020 2020  _OP_VIEW:.      
+00076780: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00076790: 2020 2020 2020 2020 2f2f 206e 6563 6573          // neces
+000767a0: 7361 7279 2066 6f72 206c 6c61 6d61 0a20  sary for llama. 
+000767b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000767c0: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
+000767d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000767e0: 2020 2020 2073 697a 655f 7420 6f66 6673       size_t offs
+000767f0: 6574 3b0a 0a20 2020 2020 2020 2020 2020  et;..           
+00076800: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00076810: 5345 5254 2873 697a 656f 6628 6f66 6673  SERT(sizeof(offs
+00076820: 6574 2920 3c3d 2067 676d 6c5f 6e62 7974  et) <= ggml_nbyt
+00076830: 6573 2874 656e 736f 722d 3e6f 7074 5b30  es(tensor->opt[0
+00076840: 5d29 293b 0a20 2020 2020 2020 2020 2020  ]));.           
+00076850: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
+00076860: 266f 6666 7365 742c 2074 656e 736f 722d  &offset, tensor-
+00076870: 3e6f 7074 5b30 5d2d 3e64 6174 612c 2073  >opt[0]->data, s
+00076880: 697a 656f 6628 6f66 6673 6574 2929 3b0a  izeof(offset));.
+00076890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000768a0: 2020 2020 2073 697a 655f 7420 6e62 3120       size_t nb1 
+000768b0: 2020 2020 3d20 7465 6e73 6f72 2d3e 6e62      = tensor->nb
+000768c0: 5b31 5d3b 0a20 2020 2020 2020 2020 2020  [1];.           
+000768d0: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+000768e0: 6e62 3220 2020 2020 3d20 7465 6e73 6f72  nb2     = tensor
+000768f0: 2d3e 6e62 5b32 5d3b 0a20 2020 2020 2020  ->nb[2];.       
+00076900: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+00076910: 655f 7420 6e62 3320 2020 2020 3d20 7465  e_t nb3     = te
+00076920: 6e73 6f72 2d3e 6e62 5b33 5d3b 0a0a 2020  nsor->nb[3];..  
+00076930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076940: 2020 6966 2028 7372 6330 2d3e 7479 7065    if (src0->type
+00076950: 2021 3d20 7372 6330 2d3e 6772 6164 2d3e   != src0->grad->
+00076960: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+00076970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076980: 2f2f 2067 7261 6469 656e 7420 6973 2074  // gradient is t
+00076990: 7970 6963 616c 6c79 2046 3332 2c20 6275  ypically F32, bu
+000769a0: 7420 7372 6330 2063 6f75 6c64 2062 6520  t src0 could be 
+000769b0: 6f74 6865 7220 7479 7065 0a20 2020 2020  other type.     
+000769c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000769d0: 2020 2073 697a 655f 7420 6e67 203d 2067     size_t ng = g
+000769e0: 676d 6c5f 656c 656d 656e 745f 7369 7a65  gml_element_size
+000769f0: 2873 7263 302d 3e67 7261 6429 3b0a 2020  (src0->grad);.  
+00076a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076a10: 2020 2020 2020 7369 7a65 5f74 206e 3020        size_t n0 
+00076a20: 3d20 6767 6d6c 5f65 6c65 6d65 6e74 5f73  = ggml_element_s
+00076a30: 697a 6528 7372 6330 293b 0a20 2020 2020  ize(src0);.     
+00076a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076a50: 2020 2047 474d 4c5f 4153 5345 5254 286f     GGML_ASSERT(o
+00076a60: 6666 7365 7420 2520 6e30 203d 3d20 3029  ffset % n0 == 0)
+00076a70: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00076a80: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00076a90: 5353 4552 5428 6e62 3120 2520 6e30 203d  SSERT(nb1 % n0 =
+00076aa0: 3d20 3029 3b0a 2020 2020 2020 2020 2020  = 0);.          
+00076ab0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00076ac0: 4d4c 5f41 5353 4552 5428 6e62 3220 2520  ML_ASSERT(nb2 % 
+00076ad0: 6e30 203d 3d20 3029 3b0a 2020 2020 2020  n0 == 0);.      
+00076ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076af0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+00076b00: 3320 2520 6e30 203d 3d20 3029 3b0a 2020  3 % n0 == 0);.  
+00076b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076b20: 2020 2020 2020 6f66 6673 6574 203d 2028        offset = (
+00076b30: 6f66 6673 6574 202f 206e 3029 202a 206e  offset / n0) * n
+00076b40: 673b 0a20 2020 2020 2020 2020 2020 2020  g;.             
+00076b50: 2020 2020 2020 2020 2020 206e 6231 203d             nb1 =
+00076b60: 2028 6e62 3120 2f20 6e30 2920 2a20 6e67   (nb1 / n0) * ng
+00076b70: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00076b80: 2020 2020 2020 2020 2020 6e62 3220 3d20            nb2 = 
+00076b90: 286e 6232 202f 206e 3029 202a 206e 673b  (nb2 / n0) * ng;
+00076ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00076bb0: 2020 2020 2020 2020 206e 6233 203d 2028           nb3 = (
+00076bc0: 6e62 3320 2f20 6e30 2920 2a20 6e67 3b0a  nb3 / n0) * ng;.
+00076bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076be0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00076bf0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+00076c00: 3e67 7261 6420 3d20 6767 6d6c 5f61 6363  >grad = ggml_acc
+00076c10: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
+00076c20: 3e67 7261 642c 2074 656e 736f 722d 3e67  >grad, tensor->g
+00076c30: 7261 642c 206e 6231 2c20 6e62 322c 206e  rad, nb1, nb2, n
+00076c40: 6233 2c20 6f66 6673 6574 2c20 696e 706c  b3, offset, inpl
+00076c50: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+00076c60: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00076c70: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00076c80: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00076c90: 505f 5045 524d 5554 453a 0a20 2020 2020  P_PERMUTE:.     
+00076ca0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00076cb0: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
+00076cc0: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
+00076cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076ce0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+00076cf0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00076d00: 2020 2020 2020 696e 7433 325f 7420 2a20        int32_t * 
+00076d10: 6178 6573 203d 2028 696e 7433 325f 7420  axes = (int32_t 
+00076d20: 2a29 2074 656e 736f 722d 3e6f 7074 5b30  *) tensor->opt[0
+00076d30: 5d2d 3e64 6174 613b 0a20 2020 2020 2020  ]->data;.       
+00076d40: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+00076d50: 2061 7869 7330 203d 2061 7865 735b 305d   axis0 = axes[0]
+00076d60: 2026 2030 7833 3b0a 2020 2020 2020 2020   & 0x3;.        
+00076d70: 2020 2020 2020 2020 2020 2020 696e 7420              int 
+00076d80: 6178 6973 3120 3d20 6178 6573 5b31 5d20  axis1 = axes[1] 
+00076d90: 2620 3078 333b 0a20 2020 2020 2020 2020  & 0x3;.         
+00076da0: 2020 2020 2020 2020 2020 2069 6e74 2061             int a
+00076db0: 7869 7332 203d 2061 7865 735b 325d 2026  xis2 = axes[2] &
+00076dc0: 2030 7833 3b0a 2020 2020 2020 2020 2020   0x3;.          
+00076dd0: 2020 2020 2020 2020 2020 696e 7420 6178            int ax
+00076de0: 6973 3320 3d20 6178 6573 5b33 5d20 2620  is3 = axes[3] & 
+00076df0: 3078 333b 0a20 2020 2020 2020 2020 2020  0x3;.           
+00076e00: 2020 2020 2020 2020 2069 6e74 2061 7865           int axe
+00076e10: 735f 6261 636b 7761 7264 5b34 5d20 3d20  s_backward[4] = 
+00076e20: 7b30 2c30 2c30 2c30 7d3b 0a20 2020 2020  {0,0,0,0};.     
+00076e30: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00076e40: 7865 735f 6261 636b 7761 7264 5b61 7869  xes_backward[axi
+00076e50: 7330 5d20 3d20 303b 0a20 2020 2020 2020  s0] = 0;.       
+00076e60: 2020 2020 2020 2020 2020 2020 2061 7865               axe
+00076e70: 735f 6261 636b 7761 7264 5b61 7869 7331  s_backward[axis1
+00076e80: 5d20 3d20 313b 0a20 2020 2020 2020 2020  ] = 1;.         
+00076e90: 2020 2020 2020 2020 2020 2061 7865 735f             axes_
+00076ea0: 6261 636b 7761 7264 5b61 7869 7332 5d20  backward[axis2] 
+00076eb0: 3d20 323b 0a20 2020 2020 2020 2020 2020  = 2;.           
+00076ec0: 2020 2020 2020 2020 2061 7865 735f 6261           axes_ba
+00076ed0: 636b 7761 7264 5b61 7869 7333 5d20 3d20  ckward[axis3] = 
+00076ee0: 333b 0a20 2020 2020 2020 2020 2020 2020  3;.             
+00076ef0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+00076f00: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+00076f10: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00076f20: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
+00076f30: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
 00076f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076f50: 2020 2069 6e74 2061 7865 735f 6261 636b     int axes_back
-00076f60: 7761 7264 5b34 5d20 3d20 7b30 2c30 2c30  ward[4] = {0,0,0
-00076f70: 2c30 7d3b 0a20 2020 2020 2020 2020 2020  ,0};.           
-00076f80: 2020 2020 2020 2020 2061 7865 735f 6261           axes_ba
-00076f90: 636b 7761 7264 5b61 7869 7330 5d20 3d20  ckward[axis0] = 
-00076fa0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+00076f50: 2020 2020 2020 2067 676d 6c5f 7065 726d         ggml_perm
+00076f60: 7574 6528 6374 782c 0a20 2020 2020 2020  ute(ctx,.       
+00076f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076f80: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+00076f90: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+00076fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00076fb0: 2020 2020 2020 2061 7865 735f 6261 636b         axes_back
-00076fc0: 7761 7264 5b61 7869 7331 5d20 3d20 313b  ward[axis1] = 1;
-00076fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076fe0: 2020 2020 2061 7865 735f 6261 636b 7761       axes_backwa
-00076ff0: 7264 5b61 7869 7332 5d20 3d20 323b 0a20  rd[axis2] = 2;. 
+00076fc0: 7761 7264 5b30 5d2c 0a20 2020 2020 2020  ward[0],.       
+00076fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00076fe0: 2020 2020 2020 2020 2061 7865 735f 6261           axes_ba
+00076ff0: 636b 7761 7264 5b31 5d2c 0a20 2020 2020  ckward[1],.     
 00077000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077010: 2020 2061 7865 735f 6261 636b 7761 7264     axes_backward
-00077020: 5b61 7869 7333 5d20 3d20 333b 0a20 2020  [axis3] = 3;.   
+00077010: 2020 2020 2020 2020 2020 2061 7865 735f             axes_
+00077020: 6261 636b 7761 7264 5b32 5d2c 0a20 2020  backward[2],.   
 00077030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077040: 2073 7263 302d 3e67 7261 6420 3d0a 2020   src0->grad =.  
-00077050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077060: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
-00077070: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
-00077080: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-00077090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000770a0: 2067 676d 6c5f 7065 726d 7574 6528 6374   ggml_permute(ct
-000770b0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-000770c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000770d0: 2020 2074 656e 736f 722d 3e67 7261 642c     tensor->grad,
-000770e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000770f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077100: 2061 7865 735f 6261 636b 7761 7264 5b30   axes_backward[0
-00077110: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00077120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077130: 2020 2061 7865 735f 6261 636b 7761 7264     axes_backward
-00077140: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
-00077150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077160: 2020 2020 2061 7865 735f 6261 636b 7761       axes_backwa
-00077170: 7264 5b32 5d2c 0a20 2020 2020 2020 2020  rd[2],.         
+00077040: 2020 2020 2020 2020 2020 2020 2061 7865               axe
+00077050: 735f 6261 636b 7761 7264 5b33 5d29 2c0a  s_backward[3]),.
+00077060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077070: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+00077080: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+00077090: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000770a0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000770b0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000770c0: 505f 5452 414e 5350 4f53 453a 0a20 2020  P_TRANSPOSE:.   
+000770d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000770e0: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
+000770f0: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
+00077100: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+00077110: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+00077120: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00077130: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+00077140: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
+00077150: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00077160: 6c5f 6164 645f 696d 706c 2863 7478 2c20  l_add_impl(ctx, 
+00077170: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
 00077180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077190: 2020 2020 2020 2061 7865 735f 6261 636b         axes_back
-000771a0: 7761 7264 5b33 5d29 2c0a 2020 2020 2020  ward[3]),.      
-000771b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000771c0: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
-000771d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000771e0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-000771f0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00077200: 6173 6520 4747 4d4c 5f4f 505f 5452 414e  ase GGML_OP_TRAN
-00077210: 5350 4f53 453a 0a20 2020 2020 2020 2020  SPOSE:.         
-00077220: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00077230: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
-00077240: 7920 666f 7220 6c6c 616d 610a 2020 2020  y for llama.    
-00077250: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00077260: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
-00077270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077280: 2020 7372 6330 2d3e 6772 6164 203d 0a20    src0->grad =. 
+00077190: 2020 2020 2020 2020 6767 6d6c 5f74 7261          ggml_tra
+000771a0: 6e73 706f 7365 2863 7478 2c20 7465 6e73  nspose(ctx, tens
+000771b0: 6f72 2d3e 6772 6164 292c 0a20 2020 2020  or->grad),.     
+000771c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000771d0: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
+000771e0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000771f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00077200: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00077210: 2047 474d 4c5f 4f50 5f47 4554 5f52 4f57   GGML_OP_GET_ROW
+00077220: 533a 0a20 2020 2020 2020 2020 2020 207b  S:.            {
+00077230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077240: 202f 2f20 6e65 6365 7373 6172 7920 666f   // necessary fo
+00077250: 7220 6c6c 616d 6120 286f 6e6c 7920 666f  r llama (only fo
+00077260: 7220 746f 6b65 6e69 7a65 7229 0a20 2020  r tokenizer).   
+00077270: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00077280: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
 00077290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000772a0: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
-000772b0: 696d 706c 2863 7478 2c20 7372 6330 2d3e  impl(ctx, src0->
-000772c0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-000772d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000772e0: 2020 6767 6d6c 5f74 7261 6e73 706f 7365    ggml_transpose
-000772f0: 2863 7478 2c20 7465 6e73 6f72 2d3e 6772  (ctx, tensor->gr
-00077300: 6164 292c 0a20 2020 2020 2020 2020 2020  ad),.           
-00077310: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-00077320: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-00077330: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00077340: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00077350: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00077360: 4f50 5f47 4554 5f52 4f57 533a 0a20 2020  OP_GET_ROWS:.   
-00077370: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00077380: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
-00077390: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
-000773a0: 6120 286f 6e6c 7920 666f 7220 746f 6b65  a (only for toke
-000773b0: 6e69 7a65 7229 0a20 2020 2020 2020 2020  nizer).         
-000773c0: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
-000773d0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-000773e0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-000773f0: 302d 3e67 7261 6420 3d0a 2020 2020 2020  0->grad =.      
-00077400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077410: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
-00077420: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
-00077430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00077440: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00077450: 6c5f 6765 745f 726f 7773 5f62 6163 6b28  l_get_rows_back(
-00077460: 6374 782c 2074 656e 736f 722d 3e67 7261  ctx, tensor->gra
-00077470: 642c 2073 7263 312c 2073 7263 302d 3e67  d, src1, src0->g
-00077480: 7261 6429 2c0a 2020 2020 2020 2020 2020  rad),.          
-00077490: 2020 2020 2020 2020 2020 2020 2020 696e                in
-000774a0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-000774b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000774c0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-000774d0: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
-000774e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000774f0: 2f2f 206e 6f6f 700a 2020 2020 2020 2020  // noop.        
-00077500: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00077510: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00077520: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00077530: 5f4f 505f 4745 545f 524f 5753 5f42 4143  _OP_GET_ROWS_BAC
-00077540: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
-00077550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00077560: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00077570: 7365 293b 202f 2f20 544f 444f 3a20 6e6f  se); // TODO: no
-00077580: 7420 696d 706c 656d 656e 7465 640a 2020  t implemented.  
-00077590: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000775a0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-000775b0: 4747 4d4c 5f4f 505f 4449 4147 3a0a 2020  GGML_OP_DIAG:.  
-000775c0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000775d0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-000775e0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
-000775f0: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
-00077600: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
-00077610: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00077620: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00077630: 4f50 5f44 4941 475f 4d41 534b 5f49 4e46  OP_DIAG_MASK_INF
-00077640: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00077650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077660: 2f2f 206e 6563 6573 7361 7279 2066 6f72  // necessary for
-00077670: 206c 6c61 6d61 0a20 2020 2020 2020 2020   llama.         
-00077680: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
-00077690: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-000776a0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-000776b0: 6572 7428 7372 6331 2d3e 7479 7065 203d  ert(src1->type =
-000776c0: 3d20 4747 4d4c 5f54 5950 455f 4933 3229  = GGML_TYPE_I32)
-000776d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000776e0: 2020 2020 2020 6173 7365 7274 2867 676d        assert(ggm
-000776f0: 6c5f 6e65 6c65 6d65 6e74 7328 7372 6331  l_nelements(src1
-00077700: 2920 3d3d 2032 293b 0a20 2020 2020 2020  ) == 2);.       
-00077710: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00077720: 7374 2069 6e74 206e 5f70 6173 7420 3d20  st int n_past = 
-00077730: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
-00077740: 312d 3e64 6174 6129 5b30 5d3b 0a20 2020  1->data)[0];.   
-00077750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077760: 2073 7263 302d 3e67 7261 6420 3d0a 2020   src0->grad =.  
-00077770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077780: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
-00077790: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
-000777a0: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-000777b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000777c0: 2067 676d 6c5f 6469 6167 5f6d 6173 6b5f   ggml_diag_mask_
-000777d0: 7a65 726f 5f69 6d70 6c28 6374 782c 2074  zero_impl(ctx, t
-000777e0: 656e 736f 722d 3e67 7261 642c 206e 5f70  ensor->grad, n_p
-000777f0: 6173 742c 2066 616c 7365 292c 0a20 2020  ast, false),.   
-00077800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077810: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-00077820: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00077830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00077840: 2069 6620 2873 7263 312d 3e67 7261 6429   if (src1->grad)
-00077850: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00077860: 2020 2020 2020 202f 2f20 6e6f 6f70 0a20         // noop. 
-00077870: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00077880: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00077890: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-000778a0: 7365 2047 474d 4c5f 4f50 5f44 4941 475f  se GGML_OP_DIAG_
-000778b0: 4d41 534b 5f5a 4552 4f3a 0a20 2020 2020  MASK_ZERO:.     
-000778c0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000778d0: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
-000778e0: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
-000778f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077900: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-00077910: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00077920: 2020 2020 2020 6173 7365 7274 2873 7263        assert(src
-00077930: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
-00077940: 5459 5045 5f49 3332 293b 0a20 2020 2020  TYPE_I32);.     
-00077950: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00077960: 7373 6572 7428 6767 6d6c 5f6e 656c 656d  ssert(ggml_nelem
-00077970: 656e 7473 2873 7263 3129 203d 3d20 3229  ents(src1) == 2)
-00077980: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00077990: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-000779a0: 6e5f 7061 7374 203d 2028 2869 6e74 3332  n_past = ((int32
-000779b0: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
-000779c0: 295b 305d 3b0a 2020 2020 2020 2020 2020  )[0];.          
-000779d0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-000779e0: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
-000779f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00077a00: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-00077a10: 2c20 7372 6330 2d3e 6772 6164 2c0a 2020  , src0->grad,.  
-00077a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077a30: 2020 2020 2020 2020 2020 6767 6d6c 5f64            ggml_d
-00077a40: 6961 675f 6d61 736b 5f7a 6572 6f5f 696d  iag_mask_zero_im
-00077a50: 706c 2863 7478 2c20 7465 6e73 6f72 2d3e  pl(ctx, tensor->
-00077a60: 6772 6164 2c20 6e5f 7061 7374 2c20 6661  grad, n_past, fa
-00077a70: 6c73 6529 2c0a 2020 2020 2020 2020 2020  lse),.          
-00077a80: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00077a90: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-00077aa0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00077ab0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-00077ac0: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
-00077ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077ae0: 2f2f 206e 6f6f 700a 2020 2020 2020 2020  // noop.        
-00077af0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00077b00: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00077b10: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00077b20: 5f4f 505f 534f 4654 5f4d 4158 3a0a 2020  _OP_SOFT_MAX:.  
-00077b30: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00077b40: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
-00077b50: 6563 6573 7361 7279 2066 6f72 206c 6c61  ecessary for lla
-00077b60: 6d61 0a20 2020 2020 2020 2020 2020 2020  ma.             
-00077b70: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-00077b80: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-00077b90: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-00077ba0: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
-00077bb0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00077bc0: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-00077bd0: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
-00077be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077bf0: 2020 2020 2020 2020 2067 676d 6c5f 736f           ggml_so
-00077c00: 6674 5f6d 6178 5f62 6163 6b28 6374 782c  ft_max_back(ctx,
-00077c10: 2074 656e 736f 722d 3e67 7261 642c 2074   tensor->grad, t
-00077c20: 656e 736f 7229 2c0a 2020 2020 2020 2020  ensor),.        
-00077c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077c40: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-00077c50: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00077c60: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00077c70: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00077c80: 474d 4c5f 4f50 5f53 4f46 545f 4d41 585f  GML_OP_SOFT_MAX_
-00077c90: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
-00077ca0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00077cb0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00077cc0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-00077cd0: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
-00077ce0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00077cf0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00077d00: 7365 2047 474d 4c5f 4f50 5f52 4f50 453a  se GGML_OP_ROPE:
-00077d10: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00077d20: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-00077d30: 2f20 6e65 6365 7373 6172 7920 666f 7220  / necessary for 
-00077d40: 6c6c 616d 610a 2020 2020 2020 2020 2020  llama.          
-00077d50: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-00077d60: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-00077d70: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00077d80: 7274 2873 7263 312d 3e74 7970 6520 3d3d  rt(src1->type ==
-00077d90: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
-00077da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00077db0: 2020 2020 2061 7373 6572 7428 6767 6d6c       assert(ggml
-00077dc0: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
-00077dd0: 203d 3d20 3329 3b0a 2020 2020 2020 2020   == 3);.        
-00077de0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00077df0: 7420 696e 7420 6e5f 7061 7374 203d 2028  t int n_past = (
-00077e00: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-00077e10: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
+000772a0: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
+000772b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000772c0: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
+000772d0: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
+000772e0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+000772f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077300: 2020 2067 676d 6c5f 6765 745f 726f 7773     ggml_get_rows
+00077310: 5f62 6163 6b28 6374 782c 2074 656e 736f  _back(ctx, tenso
+00077320: 722d 3e67 7261 642c 2073 7263 312c 2073  r->grad, src1, s
+00077330: 7263 302d 3e67 7261 6429 2c0a 2020 2020  rc0->grad),.    
+00077340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077350: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+00077360: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00077370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077380: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
+00077390: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000773a0: 2020 2020 2020 2f2f 206e 6f6f 700a 2020        // noop.  
+000773b0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000773c0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000773d0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000773e0: 6520 4747 4d4c 5f4f 505f 4745 545f 524f  e GGML_OP_GET_RO
+000773f0: 5753 5f42 4143 4b3a 0a20 2020 2020 2020  WS_BACK:.       
+00077400: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00077410: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00077420: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
+00077430: 444f 3a20 6e6f 7420 696d 706c 656d 656e  DO: not implemen
+00077440: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+00077450: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00077460: 2063 6173 6520 4747 4d4c 5f4f 505f 4449   case GGML_OP_DI
+00077470: 4147 3a0a 2020 2020 2020 2020 2020 2020  AG:.            
+00077480: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00077490: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+000774a0: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
+000774b0: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
+000774c0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000774d0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+000774e0: 2047 474d 4c5f 4f50 5f44 4941 475f 4d41   GGML_OP_DIAG_MA
+000774f0: 534b 5f49 4e46 3a0a 2020 2020 2020 2020  SK_INF:.        
+00077500: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00077510: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
+00077520: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
+00077530: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00077540: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+00077550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077560: 2020 2061 7373 6572 7428 7372 6331 2d3e     assert(src1->
+00077570: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+00077580: 455f 4933 3229 3b0a 2020 2020 2020 2020  E_I32);.        
+00077590: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000775a0: 7274 2867 676d 6c5f 6e65 6c65 6d65 6e74  rt(ggml_nelement
+000775b0: 7328 7372 6331 2920 3d3d 2032 293b 0a20  s(src1) == 2);. 
+000775c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000775d0: 2020 2063 6f6e 7374 2069 6e74 206e 5f70     const int n_p
+000775e0: 6173 7420 3d20 2828 696e 7433 325f 7420  ast = ((int32_t 
+000775f0: 2a29 2073 7263 312d 3e64 6174 6129 5b30  *) src1->data)[0
+00077600: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+00077610: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+00077620: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+00077630: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00077640: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
+00077650: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+00077660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077670: 2020 2020 2020 2067 676d 6c5f 6469 6167         ggml_diag
+00077680: 5f6d 6173 6b5f 7a65 726f 5f69 6d70 6c28  _mask_zero_impl(
+00077690: 6374 782c 2074 656e 736f 722d 3e67 7261  ctx, tensor->gra
+000776a0: 642c 206e 5f70 6173 742c 2066 616c 7365  d, n_past, false
+000776b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000776c0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+000776d0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+000776e0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000776f0: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
+00077700: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+00077710: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00077720: 6e6f 6f70 0a20 2020 2020 2020 2020 2020  noop.           
+00077730: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00077740: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00077750: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00077760: 5f44 4941 475f 4d41 534b 5f5a 4552 4f3a  _DIAG_MASK_ZERO:
+00077770: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00077780: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00077790: 2f20 6e65 6365 7373 6172 7920 666f 7220  / necessary for 
+000777a0: 6c6c 616d 610a 2020 2020 2020 2020 2020  llama.          
+000777b0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+000777c0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+000777d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000777e0: 7274 2873 7263 312d 3e74 7970 6520 3d3d  rt(src1->type ==
+000777f0: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
+00077800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077810: 2020 2020 2061 7373 6572 7428 6767 6d6c       assert(ggml
+00077820: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
+00077830: 203d 3d20 3229 3b0a 2020 2020 2020 2020   == 2);.        
+00077840: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00077850: 7420 696e 7420 6e5f 7061 7374 203d 2028  t int n_past = (
+00077860: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
+00077870: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
+00077880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077890: 7372 6330 2d3e 6772 6164 203d 0a20 2020  src0->grad =.   
+000778a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000778b0: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
+000778c0: 706c 2863 7478 2c20 7372 6330 2d3e 6772  pl(ctx, src0->gr
+000778d0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+000778e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000778f0: 6767 6d6c 5f64 6961 675f 6d61 736b 5f7a  ggml_diag_mask_z
+00077900: 6572 6f5f 696d 706c 2863 7478 2c20 7465  ero_impl(ctx, te
+00077910: 6e73 6f72 2d3e 6772 6164 2c20 6e5f 7061  nsor->grad, n_pa
+00077920: 7374 2c20 6661 6c73 6529 2c0a 2020 2020  st, false),.    
+00077930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077940: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+00077950: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00077960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077970: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
+00077980: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00077990: 2020 2020 2020 2f2f 206e 6f6f 700a 2020        // noop.  
+000779a0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000779b0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000779c0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000779d0: 6520 4747 4d4c 5f4f 505f 534f 4654 5f4d  e GGML_OP_SOFT_M
+000779e0: 4158 3a0a 2020 2020 2020 2020 2020 2020  AX:.            
+000779f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00077a00: 2020 2f2f 206e 6563 6573 7361 7279 2066    // necessary f
+00077a10: 6f72 206c 6c61 6d61 0a20 2020 2020 2020  or llama.       
+00077a20: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+00077a30: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
+00077a40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00077a50: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
+00077a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077a70: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
+00077a80: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
+00077a90: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00077aa0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00077ab0: 676d 6c5f 736f 6674 5f6d 6178 5f62 6163  gml_soft_max_bac
+00077ac0: 6b28 6374 782c 2074 656e 736f 722d 3e67  k(ctx, tensor->g
+00077ad0: 7261 642c 2074 656e 736f 7229 2c0a 2020  rad, tensor),.  
+00077ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077af0: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
+00077b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077b10: 7d0a 0a20 2020 2020 2020 2020 2020 207d  }..            }
+00077b20: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00077b30: 6361 7365 2047 474d 4c5f 4f50 5f53 4f46  case GGML_OP_SOF
+00077b40: 545f 4d41 585f 4241 434b 3a0a 2020 2020  T_MAX_BACK:.    
+00077b50: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00077b60: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00077b70: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+00077b80: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
+00077b90: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
+00077ba0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00077bb0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00077bc0: 5f52 4f50 453a 0a20 2020 2020 2020 2020  _ROPE:.         
+00077bd0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00077be0: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
+00077bf0: 7920 666f 7220 6c6c 616d 610a 2020 2020  y for llama.    
+00077c00: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00077c10: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+00077c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077c30: 2020 6173 7365 7274 2873 7263 312d 3e74    assert(src1->t
+00077c40: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00077c50: 5f49 3332 293b 0a20 2020 2020 2020 2020  _I32);.         
+00077c60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00077c70: 7428 6767 6d6c 5f6e 656c 656d 656e 7473  t(ggml_nelements
+00077c80: 2873 7263 3129 203d 3d20 3329 3b0a 2020  (src1) == 3);.  
+00077c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077ca0: 2020 636f 6e73 7420 696e 7420 6e5f 7061    const int n_pa
+00077cb0: 7374 203d 2028 2869 6e74 3332 5f74 202a  st = ((int32_t *
+00077cc0: 2920 7372 6331 2d3e 6461 7461 295b 305d  ) src1->data)[0]
+00077cd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00077ce0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00077cf0: 6e5f 6469 6d73 203d 2028 2869 6e74 3332  n_dims = ((int32
+00077d00: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
+00077d10: 295b 315d 3b0a 2020 2020 2020 2020 2020  )[1];.          
+00077d20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00077d30: 696e 7420 6d6f 6465 2020 203d 2028 2869  int mode   = ((i
+00077d40: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
+00077d50: 6461 7461 295b 325d 3b0a 2020 2020 2020  data)[2];.      
+00077d60: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00077d70: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
+00077d80: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
+00077d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077da0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+00077db0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+00077dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077dd0: 2020 6767 6d6c 5f72 6f70 655f 6261 636b    ggml_rope_back
+00077de0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+00077df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077e00: 2020 2020 2020 7465 6e73 6f72 2d3e 6772        tensor->gr
+00077e10: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
 00077e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077e30: 636f 6e73 7420 696e 7420 6e5f 6469 6d73  const int n_dims
-00077e40: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
-00077e50: 7372 6331 2d3e 6461 7461 295b 315d 3b0a  src1->data)[1];.
-00077e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077e70: 2020 2020 636f 6e73 7420 696e 7420 6d6f      const int mo
-00077e80: 6465 2020 203d 2028 2869 6e74 3332 5f74  de   = ((int32_t
-00077e90: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-00077ea0: 325d 3b0a 2020 2020 2020 2020 2020 2020  2];.            
-00077eb0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00077ec0: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
-00077ed0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
-00077ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077ef0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-00077f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077f10: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00077f20: 5f72 6f70 655f 6261 636b 2863 7478 2c0a  _rope_back(ctx,.
-00077f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077f50: 7465 6e73 6f72 2d3e 6772 6164 2c0a 2020  tensor->grad,.  
-00077f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077f70: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-00077f80: 7061 7374 2c0a 2020 2020 2020 2020 2020  past,.          
-00077f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077fa0: 2020 2020 2020 6e5f 6469 6d73 2c0a 2020        n_dims,.  
-00077fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077fc0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-00077fd0: 6465 292c 0a20 2020 2020 2020 2020 2020  de),.           
-00077fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077ff0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-00078000: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00078010: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00078020: 2873 7263 312d 3e67 7261 6429 207b 0a20  (src1->grad) {. 
+00077e30: 2020 2020 6e5f 7061 7374 2c0a 2020 2020      n_past,.    
+00077e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077e50: 2020 2020 2020 2020 2020 2020 6e5f 6469              n_di
+00077e60: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+00077e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077e80: 2020 2020 6d6f 6465 292c 0a20 2020 2020      mode),.     
+00077e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077ea0: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+00077eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077ec0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00077ed0: 2020 2069 6620 2873 7263 312d 3e67 7261     if (src1->gra
+00077ee0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00077ef0: 2020 2020 2020 2020 202f 2f20 6e6f 6f70           // noop
+00077f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077f10: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00077f20: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00077f30: 6361 7365 2047 474d 4c5f 4f50 5f52 4f50  case GGML_OP_ROP
+00077f40: 455f 4241 434b 3a0a 2020 2020 2020 2020  E_BACK:.        
+00077f50: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00077f60: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+00077f70: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00077f80: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00077f90: 7274 2873 7263 312d 3e74 7970 6520 3d3d  rt(src1->type ==
+00077fa0: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
+00077fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077fc0: 2020 2020 2061 7373 6572 7428 6767 6d6c       assert(ggml
+00077fd0: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
+00077fe0: 203d 3d20 3329 3b0a 2020 2020 2020 2020   == 3);.        
+00077ff0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00078000: 7420 696e 7420 6e5f 7061 7374 203d 2028  t int n_past = (
+00078010: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
+00078020: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
 00078030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078040: 2020 202f 2f20 6e6f 6f70 0a20 2020 2020     // noop.     
-00078050: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00078060: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00078070: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00078080: 474d 4c5f 4f50 5f52 4f50 455f 4241 434b  GML_OP_ROPE_BACK
-00078090: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000780a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000780b0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-000780c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000780d0: 2020 2020 2020 6173 7365 7274 2873 7263        assert(src
-000780e0: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
-000780f0: 5459 5045 5f49 3332 293b 0a20 2020 2020  TYPE_I32);.     
-00078100: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00078110: 7373 6572 7428 6767 6d6c 5f6e 656c 656d  ssert(ggml_nelem
-00078120: 656e 7473 2873 7263 3129 203d 3d20 3329  ents(src1) == 3)
-00078130: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00078140: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00078150: 6e5f 7061 7374 203d 2028 2869 6e74 3332  n_past = ((int32
-00078160: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
-00078170: 295b 305d 3b0a 2020 2020 2020 2020 2020  )[0];.          
-00078180: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00078190: 696e 7420 6e5f 6469 6d73 203d 2028 2869  int n_dims = ((i
-000781a0: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-000781b0: 6461 7461 295b 315d 3b0a 2020 2020 2020  data)[1];.      
-000781c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000781d0: 6e73 7420 696e 7420 6d6f 6465 2020 203d  nst int mode   =
-000781e0: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-000781f0: 6331 2d3e 6461 7461 295b 325d 3b0a 2020  c1->data)[2];.  
-00078200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078210: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
-00078220: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-00078230: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00078240: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00078250: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
-00078260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078270: 2020 2020 2020 6767 6d6c 5f72 6f70 6528        ggml_rope(
-00078280: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00078290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000782a0: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
-000782b0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-000782c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000782d0: 2020 206e 5f70 6173 742c 0a20 2020 2020     n_past,.     
-000782e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000782f0: 2020 2020 2020 2020 2020 206e 5f64 696d             n_dim
-00078300: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00078310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078320: 2020 206d 6f64 6529 2c0a 2020 2020 2020     mode),.      
-00078330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078340: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
-00078350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078360: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00078370: 2020 6966 2028 7372 6331 2d3e 6772 6164    if (src1->grad
-00078380: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00078390: 2020 2020 2020 2020 2f2f 206e 6f6f 700a          // noop.
-000783a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000783b0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-000783c0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-000783d0: 6173 6520 4747 4d4c 5f4f 505f 434f 4e56  ase GGML_OP_CONV
-000783e0: 5f31 445f 3153 3a0a 2020 2020 2020 2020  _1D_1S:.        
-000783f0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00078400: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00078410: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
-00078420: 4f3a 206e 6f74 2069 6d70 6c65 6d65 6e74  O: not implement
-00078430: 6564 0a20 2020 2020 2020 2020 2020 207d  ed.            }
-00078440: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00078450: 6361 7365 2047 474d 4c5f 4f50 5f43 4f4e  case GGML_OP_CON
-00078460: 565f 3144 5f32 533a 0a20 2020 2020 2020  V_1D_2S:.       
-00078470: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00078480: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00078490: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-000784a0: 444f 3a20 6e6f 7420 696d 706c 656d 656e  DO: not implemen
-000784b0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-000784c0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-000784d0: 2063 6173 6520 4747 4d4c 5f4f 505f 464c   case GGML_OP_FL
-000784e0: 4153 485f 4154 544e 3a0a 2020 2020 2020  ASH_ATTN:.      
-000784f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00078500: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00078510: 676d 6c5f 7465 6e73 6f72 202a 2066 6c61  gml_tensor * fla
-00078520: 7368 5f67 7261 6420 3d20 4e55 4c4c 3b0a  sh_grad = NULL;.
-00078530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078540: 6966 2028 7372 6330 2d3e 6772 6164 207c  if (src0->grad |
-00078550: 7c20 7372 6331 2d3e 6772 6164 207c 7c20  | src1->grad || 
-00078560: 7465 6e73 6f72 2d3e 6f70 745b 305d 2d3e  tensor->opt[0]->
-00078570: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-00078580: 2020 2020 2020 2020 2020 2020 696e 7433              int3
-00078590: 325f 7420 7420 3d20 6767 6d6c 5f67 6574  2_t t = ggml_get
-000785a0: 5f69 3332 5f31 6428 7465 6e73 6f72 2d3e  _i32_1d(tensor->
-000785b0: 6f70 745b 315d 2c20 3029 3b0a 2020 2020  opt[1], 0);.    
+00078040: 636f 6e73 7420 696e 7420 6e5f 6469 6d73  const int n_dims
+00078050: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
+00078060: 7372 6331 2d3e 6461 7461 295b 315d 3b0a  src1->data)[1];.
+00078070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078080: 2020 2020 636f 6e73 7420 696e 7420 6d6f      const int mo
+00078090: 6465 2020 203d 2028 2869 6e74 3332 5f74  de   = ((int32_t
+000780a0: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
+000780b0: 325d 3b0a 2020 2020 2020 2020 2020 2020  2];.            
+000780c0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+000780d0: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
+000780e0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+000780f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078100: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
+00078110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078120: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00078130: 5f72 6f70 6528 6374 782c 0a20 2020 2020  _rope(ctx,.     
+00078140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078150: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+00078160: 722d 3e67 7261 642c 0a20 2020 2020 2020  r->grad,.       
+00078170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078180: 2020 2020 2020 2020 206e 5f70 6173 742c           n_past,
+00078190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000781a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000781b0: 206e 5f64 696d 732c 0a20 2020 2020 2020   n_dims,.       
+000781c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000781d0: 2020 2020 2020 2020 206d 6f64 6529 2c0a           mode),.
+000781e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000781f0: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+00078200: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+00078210: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00078220: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
+00078230: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00078240: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00078250: 206e 6f6f 700a 2020 2020 2020 2020 2020   noop.          
+00078260: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00078270: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00078280: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00078290: 505f 434f 4e56 5f31 445f 3153 3a0a 2020  P_CONV_1D_1S:.  
+000782a0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000782b0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+000782c0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+000782d0: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
+000782e0: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
+000782f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00078300: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00078310: 4f50 5f43 4f4e 565f 3144 5f32 533a 0a20  OP_CONV_1D_2S:. 
+00078320: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00078330: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00078340: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+00078350: 202f 2f20 544f 444f 3a20 6e6f 7420 696d   // TODO: not im
+00078360: 706c 656d 656e 7465 640a 2020 2020 2020  plemented.      
+00078370: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00078380: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00078390: 5f4f 505f 464c 4153 485f 4154 544e 3a0a  _OP_FLASH_ATTN:.
+000783a0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000783b0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000783c0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000783d0: 202a 2066 6c61 7368 5f67 7261 6420 3d20   * flash_grad = 
+000783e0: 4e55 4c4c 3b0a 2020 2020 2020 2020 2020  NULL;.          
+000783f0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+00078400: 6772 6164 207c 7c20 7372 6331 2d3e 6772  grad || src1->gr
+00078410: 6164 207c 7c20 7465 6e73 6f72 2d3e 6f70  ad || tensor->op
+00078420: 745b 305d 2d3e 6772 6164 2920 7b0a 2020  t[0]->grad) {.  
+00078430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078440: 2020 696e 7433 325f 7420 7420 3d20 6767    int32_t t = gg
+00078450: 6d6c 5f67 6574 5f69 3332 5f31 6428 7465  ml_get_i32_1d(te
+00078460: 6e73 6f72 2d3e 6f70 745b 315d 2c20 3029  nsor->opt[1], 0)
+00078470: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00078480: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00078490: 5428 7420 3d3d 2030 207c 7c20 7420 3d3d  T(t == 0 || t ==
+000784a0: 2031 293b 0a20 2020 2020 2020 2020 2020   1);.           
+000784b0: 2020 2020 2020 2020 2062 6f6f 6c20 6d61           bool ma
+000784c0: 736b 6564 203d 2074 2021 3d20 303b 0a20  sked = t != 0;. 
+000784d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000784e0: 2020 2066 6c61 7368 5f67 7261 6420 3d0a     flash_grad =.
+000784f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078500: 2020 2020 2020 2020 6767 6d6c 5f66 6c61          ggml_fla
+00078510: 7368 5f61 7474 6e5f 6261 636b 2863 7478  sh_attn_back(ctx
+00078520: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00078530: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00078540: 6330 2c0a 2020 2020 2020 2020 2020 2020  c0,.            
+00078550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078560: 7372 6331 2c0a 2020 2020 2020 2020 2020  src1,.          
+00078570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078580: 2020 7465 6e73 6f72 2d3e 6f70 745b 305d    tensor->opt[0]
+00078590: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000785a0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+000785b0: 6e73 6f72 2d3e 6772 6164 2c0a 2020 2020  nsor->grad,.    
 000785c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000785d0: 4747 4d4c 5f41 5353 4552 5428 7420 3d3d  GGML_ASSERT(t ==
-000785e0: 2030 207c 7c20 7420 3d3d 2031 293b 0a20   0 || t == 1);. 
-000785f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078600: 2020 2062 6f6f 6c20 6d61 736b 6564 203d     bool masked =
-00078610: 2074 2021 3d20 303b 0a20 2020 2020 2020   t != 0;.       
-00078620: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
-00078630: 7368 5f67 7261 6420 3d0a 2020 2020 2020  sh_grad =.      
-00078640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078650: 2020 6767 6d6c 5f66 6c61 7368 5f61 7474    ggml_flash_att
-00078660: 6e5f 6261 636b 2863 7478 2c0a 2020 2020  n_back(ctx,.    
-00078670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078680: 2020 2020 2020 2020 7372 6330 2c0a 2020          src0,.  
-00078690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000786a0: 2020 2020 2020 2020 2020 7372 6331 2c0a            src1,.
-000786b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000786c0: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-000786d0: 6f72 2d3e 6f70 745b 305d 2c0a 2020 2020  or->opt[0],.    
-000786e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000786f0: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
-00078700: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-00078710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078720: 2020 6d61 736b 6564 293b 0a20 2020 2020    masked);.     
-00078730: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00078740: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00078750: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
+000785d0: 2020 2020 2020 2020 6d61 736b 6564 293b          masked);
+000785e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000785f0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+00078600: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
+00078610: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+00078620: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+00078630: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+00078640: 7261 645f 7120 3d20 4e55 4c4c 3b0a 2020  rad_q = NULL;.  
+00078650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078660: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+00078670: 6230 2020 2020 3d20 666c 6173 685f 6772  b0    = flash_gr
+00078680: 6164 2d3e 6e62 5b30 5d3b 0a20 2020 2020  ad->nb[0];.     
+00078690: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000786a0: 6f6e 7374 2073 697a 655f 7420 6f66 6673  onst size_t offs
+000786b0: 6574 203d 2030 3b0a 2020 2020 2020 2020  et = 0;.        
+000786c0: 2020 2020 2020 2020 2020 2020 7377 6974              swit
+000786d0: 6368 2873 7263 302d 3e6e 5f64 696d 7329  ch(src0->n_dims)
+000786e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000786f0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00078700: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
+00078710: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00078720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00078730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078740: 2067 7261 645f 7120 3d20 6767 6d6c 5f76   grad_q = ggml_v
+00078750: 6965 775f 3264 2863 7478 2c0a 2020 2020  iew_2d(ctx,.    
 00078760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078770: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00078780: 7465 6e73 6f72 202a 2067 7261 645f 7120  tensor * grad_q 
-00078790: 3d20 4e55 4c4c 3b0a 2020 2020 2020 2020  = NULL;.        
-000787a0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000787b0: 7420 7369 7a65 5f74 206e 6230 2020 2020  t size_t nb0    
-000787c0: 3d20 666c 6173 685f 6772 6164 2d3e 6e62  = flash_grad->nb
-000787d0: 5b30 5d3b 0a20 2020 2020 2020 2020 2020  [0];.           
-000787e0: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-000787f0: 697a 655f 7420 6f66 6673 6574 203d 2030  ize_t offset = 0
-00078800: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00078810: 2020 2020 2020 7377 6974 6368 2873 7263        switch(src
-00078820: 302d 3e6e 5f64 696d 7329 207b 0a20 2020  0->n_dims) {.   
+00078770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078780: 666c 6173 685f 6772 6164 2c0a 2020 2020  flash_grad,.    
+00078790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000787a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000787b0: 7372 6330 2d3e 6e65 5b30 5d2c 0a20 2020  src0->ne[0],.   
+000787c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000787d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000787e0: 2073 7263 302d 3e6e 655b 315d 2c0a 2020   src0->ne[1],.  
+000787f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078810: 2020 6e62 302a 7372 6330 2d3e 6e65 5b30    nb0*src0->ne[0
+00078820: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
 00078830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078840: 2020 2020 2063 6173 6520 323a 0a20 2020       case 2:.   
+00078840: 2020 2020 2020 206f 6666 7365 7429 3b0a         offset);.
 00078850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078860: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00078870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078880: 2020 2020 2020 2020 2020 2067 7261 645f             grad_
-00078890: 7120 3d20 6767 6d6c 5f76 6965 775f 3264  q = ggml_view_2d
-000788a0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-000788b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000788c0: 2020 2020 2020 2020 2020 666c 6173 685f            flash_
-000788d0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-000788e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000788f0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00078900: 6e65 5b30 5d2c 0a20 2020 2020 2020 2020  ne[0],.         
-00078910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078920: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-00078930: 3e6e 655b 315d 2c0a 2020 2020 2020 2020  >ne[1],.        
-00078940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078950: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
-00078960: 7372 6330 2d3e 6e65 5b30 5d2c 0a20 2020  src0->ne[0],.   
-00078970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078860: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00078870: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
+00078880: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+00078890: 6520 333a 0a20 2020 2020 2020 2020 2020  e 3:.           
+000788a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000788b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000788c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000788d0: 2020 2067 7261 645f 7120 3d20 6767 6d6c     grad_q = ggml
+000788e0: 5f76 6965 775f 3364 2863 7478 2c0a 2020  _view_3d(ctx,.  
+000788f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078910: 2020 666c 6173 685f 6772 6164 2c0a 2020    flash_grad,.  
+00078920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078940: 2020 7372 6330 2d3e 6e65 5b30 5d2c 0a20    src0->ne[0],. 
+00078950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078970: 2020 2073 7263 302d 3e6e 655b 315d 2c0a     src0->ne[1],.
 00078980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078990: 206f 6666 7365 7429 3b0a 2020 2020 2020   offset);.      
-000789a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000789b0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00078990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000789a0: 2020 2020 7372 6330 2d3e 6e65 5b32 5d2c      src0->ne[2],
+000789b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000789c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000789d0: 2020 2020 2020 2063 6173 6520 333a 0a20         case 3:. 
-000789e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000789f0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00078a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078a10: 2020 2020 2020 2020 2020 2020 2067 7261               gra
-00078a20: 645f 7120 3d20 6767 6d6c 5f76 6965 775f  d_q = ggml_view_
-00078a30: 3364 2863 7478 2c0a 2020 2020 2020 2020  3d(ctx,.        
-00078a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078a50: 2020 2020 2020 2020 2020 2020 666c 6173              flas
-00078a60: 685f 6772 6164 2c0a 2020 2020 2020 2020  h_grad,.        
-00078a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078a80: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-00078a90: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
+000789d0: 2020 2020 206e 6230 2a73 7263 302d 3e6e       nb0*src0->n
+000789e0: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
+000789f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078a00: 2020 2020 2020 2020 2020 6e62 302a 7372            nb0*sr
+00078a10: 6330 2d3e 6e65 5b30 5d2a 7372 6330 2d3e  c0->ne[0]*src0->
+00078a20: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
+00078a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078a40: 2020 2020 2020 2020 2020 206f 6666 7365             offse
+00078a50: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+00078a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078a70: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00078a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078a90: 2063 6173 6520 343a 0a20 2020 2020 2020   case 4:.       
 00078aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078ab0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00078ac0: 302d 3e6e 655b 315d 2c0a 2020 2020 2020  0->ne[1],.      
-00078ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078ae0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00078af0: 6330 2d3e 6e65 5b32 5d2c 0a20 2020 2020  c0->ne[2],.     
+00078ab0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00078ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078ad0: 2020 2020 2020 2067 7261 645f 7120 3d20         grad_q = 
+00078ae0: 6767 6d6c 5f76 6965 775f 3464 2863 7478  ggml_view_4d(ctx
+00078af0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00078b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078b10: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00078b20: 6230 2a73 7263 302d 3e6e 655b 305d 2c0a  b0*src0->ne[0],.
+00078b10: 2020 2020 2020 666c 6173 685f 6772 6164        flash_grad
+00078b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00078b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078b50: 2020 2020 6e62 302a 7372 6330 2d3e 6e65      nb0*src0->ne
-00078b60: 5b30 5d2a 7372 6330 2d3e 6e65 5b31 5d2c  [0]*src0->ne[1],
-00078b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078b90: 2020 2020 206f 6666 7365 7429 3b0a 2020       offset);.  
-00078ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078bb0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00078bc0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-00078bd0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00078be0: 343a 0a20 2020 2020 2020 2020 2020 2020  4:.             
-00078bf0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00078c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c20: 2067 7261 645f 7120 3d20 6767 6d6c 5f76   grad_q = ggml_v
-00078c30: 6965 775f 3464 2863 7478 2c0a 2020 2020  iew_4d(ctx,.    
-00078c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c60: 666c 6173 685f 6772 6164 2c0a 2020 2020  flash_grad,.    
+00078b40: 2020 2020 2020 7372 6330 2d3e 6e65 5b30        src0->ne[0
+00078b50: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00078b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078b70: 2020 2020 2020 2073 7263 302d 3e6e 655b         src0->ne[
+00078b80: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+00078b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078ba0: 2020 2020 2020 2020 7372 6330 2d3e 6e65          src0->ne
+00078bb0: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
+00078bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078bd0: 2020 2020 2020 2020 2073 7263 302d 3e6e           src0->n
+00078be0: 655b 335d 2c0a 2020 2020 2020 2020 2020  e[3],.          
+00078bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078c00: 2020 2020 2020 2020 2020 6e62 302a 7372            nb0*sr
+00078c10: 6330 2d3e 6e65 5b30 5d2c 0a20 2020 2020  c0->ne[0],.     
+00078c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078c30: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00078c40: 6230 2a73 7263 302d 3e6e 655b 305d 2a73  b0*src0->ne[0]*s
+00078c50: 7263 302d 3e6e 655b 315d 2c0a 2020 2020  rc0->ne[1],.    
+00078c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00078c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c90: 7372 6330 2d3e 6e65 5b30 5d2c 0a20 2020  src0->ne[0],.   
-00078ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078c80: 6e62 302a 7372 6330 2d3e 6e65 5b30 5d2a  nb0*src0->ne[0]*
+00078c90: 7372 6330 2d3e 6e65 5b31 5d2a 7372 6330  src0->ne[1]*src0
+00078ca0: 2d3e 6e65 5b32 5d2c 0a20 2020 2020 2020  ->ne[2],.       
 00078cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078cc0: 2073 7263 302d 3e6e 655b 315d 2c0a 2020   src0->ne[1],.  
-00078cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078cc0: 2020 2020 2020 2020 2020 2020 206f 6666               off
+00078cd0: 7365 7429 3b0a 2020 2020 2020 2020 2020  set);.          
 00078ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078cf0: 2020 7372 6330 2d3e 6e65 5b32 5d2c 0a20    src0->ne[2],. 
-00078d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d20: 2020 2073 7263 302d 3e6e 655b 335d 2c0a     src0->ne[3],.
-00078d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d50: 2020 2020 6e62 302a 7372 6330 2d3e 6e65      nb0*src0->ne
-00078d60: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+00078cf0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00078d00: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00078d10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00078d20: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+00078d30: 203d 2067 676d 6c5f 6164 645f 696d 706c   = ggml_add_impl
+00078d40: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+00078d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078d60: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
 00078d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d80: 2020 2020 2020 2020 206e 6230 2a73 7263           nb0*src
-00078d90: 302d 3e6e 655b 305d 2a73 7263 302d 3e6e  0->ne[0]*src0->n
-00078da0: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
-00078db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078dc0: 2020 2020 2020 2020 2020 6e62 302a 7372            nb0*sr
-00078dd0: 6330 2d3e 6e65 5b30 5d2a 7372 6330 2d3e  c0->ne[0]*src0->
-00078de0: 6e65 5b31 5d2a 7372 6330 2d3e 6e65 5b32  ne[1]*src0->ne[2
-00078df0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00078e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078e10: 2020 2020 2020 206f 6666 7365 7429 3b0a         offset);.
-00078e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078e30: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00078e40: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
-00078e50: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00078e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078e70: 7372 6330 2d3e 6772 6164 203d 2067 676d  src0->grad = ggm
-00078e80: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
-00078e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078ea0: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-00078eb0: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
-00078ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078ed0: 2020 2020 6772 6164 5f71 2c0a 2020 2020      grad_q,.    
-00078ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078ef0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-00078f00: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00078f10: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-00078f20: 2020 2020 2069 6620 2873 7263 312d 3e67       if (src1->g
-00078f30: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
-00078f40: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00078f50: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00078f60: 6772 6164 5f6b 203d 204e 554c 4c3b 0a20  grad_k = NULL;. 
+00078d80: 2020 2020 2020 2020 2020 6772 6164 5f71            grad_q
+00078d90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00078da0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00078db0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+00078dc0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00078dd0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+00078de0: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
+00078df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078e00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00078e10: 736f 7220 2a20 6772 6164 5f6b 203d 204e  sor * grad_k = N
+00078e20: 554c 4c3b 0a20 2020 2020 2020 2020 2020  ULL;.           
+00078e30: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
+00078e40: 697a 655f 7420 6e62 3020 2020 203d 2066  ize_t nb0    = f
+00078e50: 6c61 7368 5f67 7261 642d 3e6e 625b 305d  lash_grad->nb[0]
+00078e60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00078e70: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
+00078e80: 5f74 206f 6666 7365 7420 3d20 6e62 302a  _t offset = nb0*
+00078e90: 7372 6330 2d3e 6e65 5b30 5d2a 7372 6330  src0->ne[0]*src0
+00078ea0: 2d3e 6e65 5b31 5d2a 7372 6330 2d3e 6e65  ->ne[1]*src0->ne
+00078eb0: 5b32 5d2a 7372 6330 2d3e 6e65 5b33 5d3b  [2]*src0->ne[3];
+00078ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00078ed0: 2020 2020 2073 7769 7463 6828 7372 6331       switch(src1
+00078ee0: 2d3e 6e5f 6469 6d73 2920 7b0a 2020 2020  ->n_dims) {.    
+00078ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078f00: 2020 2020 6361 7365 2032 3a0a 2020 2020      case 2:.    
+00078f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078f20: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00078f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078f40: 2020 2020 2020 2020 2020 6772 6164 5f6b            grad_k
+00078f50: 203d 2067 676d 6c5f 7669 6577 5f32 6428   = ggml_view_2d(
+00078f60: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
 00078f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078f80: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00078f90: 6e62 3020 2020 203d 2066 6c61 7368 5f67  nb0    = flash_g
-00078fa0: 7261 642d 3e6e 625b 305d 3b0a 2020 2020  rad->nb[0];.    
-00078fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078fc0: 636f 6e73 7420 7369 7a65 5f74 206f 6666  const size_t off
-00078fd0: 7365 7420 3d20 6e62 302a 7372 6330 2d3e  set = nb0*src0->
-00078fe0: 6e65 5b30 5d2a 7372 6330 2d3e 6e65 5b31  ne[0]*src0->ne[1
-00078ff0: 5d2a 7372 6330 2d3e 6e65 5b32 5d2a 7372  ]*src0->ne[2]*sr
-00079000: 6330 2d3e 6e65 5b33 5d3b 0a20 2020 2020  c0->ne[3];.     
-00079010: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00079020: 7769 7463 6828 7372 6331 2d3e 6e5f 6469  witch(src1->n_di
-00079030: 6d73 2920 7b0a 2020 2020 2020 2020 2020  ms) {.          
-00079040: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00079050: 7365 2032 3a0a 2020 2020 2020 2020 2020  se 2:.          
+00078f80: 2020 2020 2020 2020 2066 6c61 7368 5f67           flash_g
+00078f90: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+00078fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078fb0: 2020 2020 2020 2020 2073 7263 312d 3e6e           src1->n
+00078fc0: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
+00078fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078fe0: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+00078ff0: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
+00079000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079010: 2020 2020 2020 2020 2020 206e 6230 2a73             nb0*s
+00079020: 7263 312d 3e6e 655b 305d 2c0a 2020 2020  rc1->ne[0],.    
+00079030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079050: 6f66 6673 6574 293b 0a20 2020 2020 2020  offset);.       
 00079060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079070: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00079070: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
 00079080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079090: 2020 2020 6772 6164 5f6b 203d 2067 676d      grad_k = ggm
-000790a0: 6c5f 7669 6577 5f32 6428 6374 782c 0a20  l_view_2d(ctx,. 
-000790b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079090: 2020 2020 2020 6361 7365 2033 3a0a 2020        case 3:.  
+000790a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000790b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
 000790c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000790d0: 2020 2066 6c61 7368 5f67 7261 642c 0a20     flash_grad,. 
-000790e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000790f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079100: 2020 2073 7263 312d 3e6e 655b 305d 2c0a     src1->ne[0],.
-00079110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079130: 2020 2020 7372 6331 2d3e 6e65 5b31 5d2c      src1->ne[1],
-00079140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079160: 2020 2020 206e 6230 2a73 7263 312d 3e6e       nb0*src1->n
-00079170: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
-00079180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079190: 2020 2020 2020 2020 2020 6f66 6673 6574            offset
-000791a0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000791b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000791c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000791d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000791e0: 6361 7365 2033 3a0a 2020 2020 2020 2020  case 3:.        
+000790d0: 2020 2020 2020 2020 2020 2020 6772 6164              grad
+000790e0: 5f6b 203d 2067 676d 6c5f 7669 6577 5f33  _k = ggml_view_3
+000790f0: 6428 6374 782c 0a20 2020 2020 2020 2020  d(ctx,.         
+00079100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079110: 2020 2020 2020 2020 2020 2066 6c61 7368             flash
+00079120: 5f67 7261 642c 0a20 2020 2020 2020 2020  _grad,.         
+00079130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079140: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
+00079150: 3e6e 655b 305d 2c0a 2020 2020 2020 2020  >ne[0],.        
+00079160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079170: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+00079180: 2d3e 6e65 5b31 5d2c 0a20 2020 2020 2020  ->ne[1],.       
+00079190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000791a0: 2020 2020 2020 2020 2020 2020 2073 7263               src
+000791b0: 312d 3e6e 655b 325d 2c0a 2020 2020 2020  1->ne[2],.      
+000791c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000791d0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+000791e0: 302a 7372 6331 2d3e 6e65 5b30 5d2c 0a20  0*src1->ne[0],. 
 000791f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079200: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00079210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079220: 2020 2020 2020 6772 6164 5f6b 203d 2067        grad_k = g
-00079230: 676d 6c5f 7669 6577 5f33 6428 6374 782c  gml_view_3d(ctx,
-00079240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079260: 2020 2020 2066 6c61 7368 5f67 7261 642c       flash_grad,
-00079270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079290: 2020 2020 2073 7263 312d 3e6e 655b 305d       src1->ne[0]
-000792a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000792b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000792c0: 2020 2020 2020 7372 6331 2d3e 6e65 5b31        src1->ne[1
-000792d0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000792e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000792f0: 2020 2020 2020 2073 7263 312d 3e6e 655b         src1->ne[
-00079300: 325d 2c0a 2020 2020 2020 2020 2020 2020  2],.            
-00079310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079320: 2020 2020 2020 2020 6e62 302a 7372 6331          nb0*src1
-00079330: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
-00079340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079350: 2020 2020 2020 2020 2020 2020 206e 6230               nb0
-00079360: 2a73 7263 312d 3e6e 655b 305d 2a73 7263  *src1->ne[0]*src
-00079370: 312d 3e6e 655b 315d 2c0a 2020 2020 2020  1->ne[1],.      
-00079380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079390: 2020 2020 2020 2020 2020 2020 2020 6f66                of
-000793a0: 6673 6574 293b 0a20 2020 2020 2020 2020  fset);.         
-000793b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000793c0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00079200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079210: 2020 206e 6230 2a73 7263 312d 3e6e 655b     nb0*src1->ne[
+00079220: 305d 2a73 7263 312d 3e6e 655b 315d 2c0a  0]*src1->ne[1],.
+00079230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079250: 2020 2020 6f66 6673 6574 293b 0a20 2020      offset);.   
+00079260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079270: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00079280: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00079290: 2020 2020 2020 2020 2020 6361 7365 2034            case 4
+000792a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000792b0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+000792c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000792d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000792e0: 6772 6164 5f6b 203d 2067 676d 6c5f 7669  grad_k = ggml_vi
+000792f0: 6577 5f34 6428 6374 782c 0a20 2020 2020  ew_4d(ctx,.     
+00079300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079310: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00079320: 6c61 7368 5f67 7261 642c 0a20 2020 2020  lash_grad,.     
+00079330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079340: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00079350: 7263 312d 3e6e 655b 305d 2c0a 2020 2020  rc1->ne[0],.    
+00079360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079380: 7372 6331 2d3e 6e65 5b31 5d2c 0a20 2020  src1->ne[1],.   
+00079390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000793a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000793b0: 2073 7263 312d 3e6e 655b 325d 2c0a 2020   src1->ne[2],.  
+000793c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000793d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000793e0: 2020 2020 6361 7365 2034 3a0a 2020 2020      case 4:.    
+000793e0: 2020 7372 6331 2d3e 6e65 5b33 5d2c 0a20    src1->ne[3],. 
 000793f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079400: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00079410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079420: 2020 2020 2020 2020 2020 6772 6164 5f6b            grad_k
-00079430: 203d 2067 676d 6c5f 7669 6577 5f34 6428   = ggml_view_4d(
-00079440: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00079450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079460: 2020 2020 2020 2020 2066 6c61 7368 5f67           flash_g
-00079470: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-00079480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079490: 2020 2020 2020 2020 2073 7263 312d 3e6e           src1->n
-000794a0: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
-000794b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000794c0: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-000794d0: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
+00079400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079410: 2020 206e 6230 2a73 7263 312d 3e6e 655b     nb0*src1->ne[
+00079420: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00079430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079440: 2020 2020 2020 2020 6e62 302a 7372 6331          nb0*src1
+00079450: 2d3e 6e65 5b30 5d2a 7372 6331 2d3e 6e65  ->ne[0]*src1->ne
+00079460: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
+00079470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079480: 2020 2020 2020 2020 206e 6230 2a73 7263           nb0*src
+00079490: 312d 3e6e 655b 305d 2a73 7263 312d 3e6e  1->ne[0]*src1->n
+000794a0: 655b 315d 2a73 7263 312d 3e6e 655b 325d  e[1]*src1->ne[2]
+000794b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000794c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000794d0: 2020 2020 2020 6f66 6673 6574 293b 0a20        offset);. 
 000794e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000794f0: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-00079500: 3e6e 655b 325d 2c0a 2020 2020 2020 2020  >ne[2],.        
-00079510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079520: 2020 2020 2020 2020 2020 2020 7372 6331              src1
-00079530: 2d3e 6e65 5b33 5d2c 0a20 2020 2020 2020  ->ne[3],.       
-00079540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079550: 2020 2020 2020 2020 2020 2020 206e 6230               nb0
-00079560: 2a73 7263 312d 3e6e 655b 305d 2c0a 2020  *src1->ne[0],.  
-00079570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000794f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00079500: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
+00079510: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00079520: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00079530: 7263 312d 3e67 7261 6420 3d20 6767 6d6c  rc1->grad = ggml
+00079540: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
+00079550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079560: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
+00079570: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
 00079580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079590: 2020 6e62 302a 7372 6331 2d3e 6e65 5b30    nb0*src1->ne[0
-000795a0: 5d2a 7372 6331 2d3e 6e65 5b31 5d2c 0a20  ]*src1->ne[1],. 
-000795b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000795c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000795d0: 2020 206e 6230 2a73 7263 312d 3e6e 655b     nb0*src1->ne[
-000795e0: 305d 2a73 7263 312d 3e6e 655b 315d 2a73  0]*src1->ne[1]*s
-000795f0: 7263 312d 3e6e 655b 325d 2c0a 2020 2020  rc1->ne[2],.    
-00079600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079620: 6f66 6673 6574 293b 0a20 2020 2020 2020  offset);.       
-00079630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079640: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00079650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079660: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-00079670: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
-00079680: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
-00079690: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
-000796a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000796b0: 2020 2020 2073 7263 312d 3e67 7261 642c       src1->grad,
-000796c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000796d0: 2020 2020 2020 2020 2020 2020 2067 7261               gra
-000796e0: 645f 6b2c 0a20 2020 2020 2020 2020 2020  d_k,.           
-000796f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079700: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-00079710: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00079720: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00079730: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00079740: 202a 206f 7074 3020 3d20 7465 6e73 6f72   * opt0 = tensor
-00079750: 2d3e 6f70 745b 305d 3b0a 0a20 2020 2020  ->opt[0];..     
-00079760: 2020 2020 2020 2020 2020 2069 6620 286f             if (o
-00079770: 7074 302d 3e67 7261 6429 207b 0a20 2020  pt0->grad) {.   
-00079780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079790: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000797a0: 736f 7220 2a20 6772 6164 5f76 203d 204e  sor * grad_v = N
-000797b0: 554c 4c3b 0a20 2020 2020 2020 2020 2020  ULL;.           
-000797c0: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-000797d0: 697a 655f 7420 6e62 3020 2020 203d 2066  ize_t nb0    = f
-000797e0: 6c61 7368 5f67 7261 642d 3e6e 625b 305d  lash_grad->nb[0]
-000797f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00079800: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
-00079810: 5f74 206f 6666 7365 7420 3d20 6e62 302a  _t offset = nb0*
-00079820: 7372 6330 2d3e 6e65 5b30 5d2a 7372 6330  src0->ne[0]*src0
-00079830: 2d3e 6e65 5b31 5d2a 7372 6330 2d3e 6e65  ->ne[1]*src0->ne
-00079840: 5b32 5d2a 7372 6330 2d3e 6e65 5b33 5d0a  [2]*src0->ne[3].
-00079850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079870: 2020 2020 2020 2020 2b20 6e62 302a 7372          + nb0*sr
-00079880: 6331 2d3e 6e65 5b30 5d2a 7372 6331 2d3e  c1->ne[0]*src1->
-00079890: 6e65 5b31 5d2a 7372 6331 2d3e 6e65 5b32  ne[1]*src1->ne[2
-000798a0: 5d2a 7372 6331 2d3e 6e65 5b33 5d3b 0a20  ]*src1->ne[3];. 
-000798b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000798c0: 2020 2073 7769 7463 6828 6f70 7430 2d3e     switch(opt0->
-000798d0: 6e5f 6469 6d73 2920 7b0a 2020 2020 2020  n_dims) {.      
+00079590: 2020 2067 7261 645f 6b2c 0a20 2020 2020     grad_k,.     
+000795a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000795b0: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+000795c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000795d0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+000795e0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000795f0: 7465 6e73 6f72 202a 206f 7074 3020 3d20  tensor * opt0 = 
+00079600: 7465 6e73 6f72 2d3e 6f70 745b 305d 3b0a  tensor->opt[0];.
+00079610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00079620: 2069 6620 286f 7074 302d 3e67 7261 6429   if (opt0->grad)
+00079630: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00079640: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00079650: 6d6c 5f74 656e 736f 7220 2a20 6772 6164  ml_tensor * grad
+00079660: 5f76 203d 204e 554c 4c3b 0a20 2020 2020  _v = NULL;.     
+00079670: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00079680: 6f6e 7374 2073 697a 655f 7420 6e62 3020  onst size_t nb0 
+00079690: 2020 203d 2066 6c61 7368 5f67 7261 642d     = flash_grad-
+000796a0: 3e6e 625b 305d 3b0a 2020 2020 2020 2020  >nb[0];.        
+000796b0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000796c0: 7420 7369 7a65 5f74 206f 6666 7365 7420  t size_t offset 
+000796d0: 3d20 6e62 302a 7372 6330 2d3e 6e65 5b30  = nb0*src0->ne[0
+000796e0: 5d2a 7372 6330 2d3e 6e65 5b31 5d2a 7372  ]*src0->ne[1]*sr
+000796f0: 6330 2d3e 6e65 5b32 5d2a 7372 6330 2d3e  c0->ne[2]*src0->
+00079700: 6e65 5b33 5d0a 2020 2020 2020 2020 2020  ne[3].          
+00079710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079720: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+00079730: 6e62 302a 7372 6331 2d3e 6e65 5b30 5d2a  nb0*src1->ne[0]*
+00079740: 7372 6331 2d3e 6e65 5b31 5d2a 7372 6331  src1->ne[1]*src1
+00079750: 2d3e 6e65 5b32 5d2a 7372 6331 2d3e 6e65  ->ne[2]*src1->ne
+00079760: 5b33 5d3b 0a20 2020 2020 2020 2020 2020  [3];.           
+00079770: 2020 2020 2020 2020 2073 7769 7463 6828           switch(
+00079780: 6f70 7430 2d3e 6e5f 6469 6d73 2920 7b0a  opt0->n_dims) {.
+00079790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000797a0: 2020 2020 2020 2020 6361 7365 2032 3a0a          case 2:.
+000797b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000797c0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000797d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000797e0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+000797f0: 6164 5f76 203d 2067 676d 6c5f 7669 6577  ad_v = ggml_view
+00079800: 5f32 6428 6374 782c 0a20 2020 2020 2020  _2d(ctx,.       
+00079810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079820: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
+00079830: 7368 5f67 7261 642c 0a20 2020 2020 2020  sh_grad,.       
+00079840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079850: 2020 2020 2020 2020 2020 2020 206f 7074               opt
+00079860: 302d 3e6e 655b 305d 2c0a 2020 2020 2020  0->ne[0],.      
+00079870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079880: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+00079890: 7430 2d3e 6e65 5b31 5d2c 0a20 2020 2020  t0->ne[1],.     
+000798a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000798b0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000798c0: 6230 2a6f 7074 302d 3e6e 655b 305d 2c0a  b0*opt0->ne[0],.
+000798d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000798e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000798f0: 2020 6361 7365 2032 3a0a 2020 2020 2020    case 2:.      
+000798f0: 2020 2020 6f66 6673 6574 293b 0a20 2020      offset);.   
 00079900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079910: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00079920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079930: 2020 2020 2020 2020 6772 6164 5f76 203d          grad_v =
-00079940: 2067 676d 6c5f 7669 6577 5f32 6428 6374   ggml_view_2d(ct
-00079950: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00079910: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00079920: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00079930: 2020 2020 2020 2020 2020 6361 7365 2033            case 3
+00079940: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00079950: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
 00079960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079970: 2020 2020 2020 2066 6c61 7368 5f67 7261         flash_gra
-00079980: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00079990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000799a0: 2020 2020 2020 206f 7074 302d 3e6e 655b         opt0->ne[
-000799b0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-000799c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000799d0: 2020 2020 2020 2020 6f70 7430 2d3e 6e65          opt0->ne
-000799e0: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
-000799f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079a00: 2020 2020 2020 2020 206e 6230 2a6f 7074           nb0*opt
-00079a10: 302d 3e6e 655b 305d 2c0a 2020 2020 2020  0->ne[0],.      
-00079a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079a30: 2020 2020 2020 2020 2020 2020 2020 6f66                of
-00079a40: 6673 6574 293b 0a20 2020 2020 2020 2020  fset);.         
-00079a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079a60: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00079970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079980: 6772 6164 5f76 203d 2067 676d 6c5f 7669  grad_v = ggml_vi
+00079990: 6577 5f33 6428 6374 782c 0a20 2020 2020  ew_3d(ctx,.     
+000799a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000799b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000799c0: 6c61 7368 5f67 7261 642c 0a20 2020 2020  lash_grad,.     
+000799d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000799e0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000799f0: 7074 302d 3e6e 655b 305d 2c0a 2020 2020  pt0->ne[0],.    
+00079a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079a20: 6f70 7430 2d3e 6e65 5b31 5d2c 0a20 2020  opt0->ne[1],.   
+00079a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079a50: 206f 7074 302d 3e6e 655b 325d 2c0a 2020   opt0->ne[2],.  
+00079a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00079a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079a80: 2020 2020 6361 7365 2033 3a0a 2020 2020      case 3:.    
-00079a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079aa0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00079ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079ac0: 2020 2020 2020 2020 2020 6772 6164 5f76            grad_v
-00079ad0: 203d 2067 676d 6c5f 7669 6577 5f33 6428   = ggml_view_3d(
-00079ae0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00079af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079b00: 2020 2020 2020 2020 2066 6c61 7368 5f67           flash_g
-00079b10: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-00079b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079b30: 2020 2020 2020 2020 206f 7074 302d 3e6e           opt0->n
-00079b40: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
+00079a80: 2020 6e62 302a 6f70 7430 2d3e 6e65 5b30    nb0*opt0->ne[0
+00079a90: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00079aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079ab0: 2020 2020 2020 206e 6230 2a6f 7074 302d         nb0*opt0-
+00079ac0: 3e6e 655b 305d 2a6f 7074 302d 3e6e 655b  >ne[0]*opt0->ne[
+00079ad0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+00079ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079af0: 2020 2020 2020 2020 6f66 6673 6574 293b          offset);
+00079b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00079b10: 2020 2020 2020 2020 2020 2020 207d 2062               } b
+00079b20: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
+00079b30: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00079b40: 7365 2034 3a0a 2020 2020 2020 2020 2020  se 4:.          
 00079b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079b60: 2020 2020 2020 2020 2020 6f70 7430 2d3e            opt0->
-00079b70: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
-00079b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079b90: 2020 2020 2020 2020 2020 206f 7074 302d             opt0-
-00079ba0: 3e6e 655b 325d 2c0a 2020 2020 2020 2020  >ne[2],.        
+00079b60: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00079b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079b80: 2020 2020 6772 6164 5f76 203d 2067 676d      grad_v = ggm
+00079b90: 6c5f 7669 6577 5f34 6428 6374 782c 0a20  l_view_4d(ctx,. 
+00079ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00079bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079bc0: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
-00079bd0: 6f70 7430 2d3e 6e65 5b30 5d2c 0a20 2020  opt0->ne[0],.   
+00079bc0: 2020 2066 6c61 7368 5f67 7261 642c 0a20     flash_grad,. 
+00079bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00079be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079c00: 206e 6230 2a6f 7074 302d 3e6e 655b 305d   nb0*opt0->ne[0]
-00079c10: 2a6f 7074 302d 3e6e 655b 315d 2c0a 2020  *opt0->ne[1],.  
-00079c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079c40: 2020 6f66 6673 6574 293b 0a20 2020 2020    offset);.     
-00079c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079c60: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00079bf0: 2020 206f 7074 302d 3e6e 655b 305d 2c0a     opt0->ne[0],.
+00079c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079c20: 2020 2020 6f70 7430 2d3e 6e65 5b31 5d2c      opt0->ne[1],
+00079c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00079c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079c50: 2020 2020 206f 7074 302d 3e6e 655b 325d       opt0->ne[2]
+00079c60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00079c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079c80: 2020 2020 2020 2020 6361 7365 2034 3a0a          case 4:.
-00079c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079ca0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00079cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079cc0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00079cd0: 6164 5f76 203d 2067 676d 6c5f 7669 6577  ad_v = ggml_view
-00079ce0: 5f34 6428 6374 782c 0a20 2020 2020 2020  _4d(ctx,.       
-00079cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079d00: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
-00079d10: 7368 5f67 7261 642c 0a20 2020 2020 2020  sh_grad,.       
-00079d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079d30: 2020 2020 2020 2020 2020 2020 206f 7074               opt
-00079d40: 302d 3e6e 655b 305d 2c0a 2020 2020 2020  0->ne[0],.      
-00079d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079d60: 2020 2020 2020 2020 2020 2020 2020 6f70                op
-00079d70: 7430 2d3e 6e65 5b31 5d2c 0a20 2020 2020  t0->ne[1],.     
-00079d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079d90: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00079da0: 7074 302d 3e6e 655b 325d 2c0a 2020 2020  pt0->ne[2],.    
-00079db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079c80: 2020 2020 2020 6f70 7430 2d3e 6e65 5b33        opt0->ne[3
+00079c90: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00079ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079cb0: 2020 2020 2020 206e 6230 2a6f 7074 302d         nb0*opt0-
+00079cc0: 3e6e 655b 305d 2c0a 2020 2020 2020 2020  >ne[0],.        
+00079cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079ce0: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
+00079cf0: 6f70 7430 2d3e 6e65 5b30 5d2a 6f70 7430  opt0->ne[0]*opt0
+00079d00: 2d3e 6e65 5b31 5d2c 0a20 2020 2020 2020  ->ne[1],.       
+00079d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079d20: 2020 2020 2020 2020 2020 2020 206e 6230               nb0
+00079d30: 2a6f 7074 302d 3e6e 655b 305d 2a6f 7074  *opt0->ne[0]*opt
+00079d40: 302d 3e6e 655b 315d 2a6f 7074 302d 3e6e  0->ne[1]*opt0->n
+00079d50: 655b 325d 2c0a 2020 2020 2020 2020 2020  e[2],.          
+00079d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079d70: 2020 2020 2020 2020 2020 6f66 6673 6574            offset
+00079d80: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00079d90: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00079da0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00079db0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
 00079dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079dd0: 6f70 7430 2d3e 6e65 5b33 5d2c 0a20 2020  opt0->ne[3],.   
-00079de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079e00: 206e 6230 2a6f 7074 302d 3e6e 655b 305d   nb0*opt0->ne[0]
-00079e10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00079dd0: 2020 206f 7074 302d 3e67 7261 6420 3d20     opt0->grad = 
+00079de0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+00079df0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00079e00: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00079e10: 7074 302d 3e67 7261 642c 0a20 2020 2020  pt0->grad,.     
 00079e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079e30: 2020 2020 2020 6e62 302a 6f70 7430 2d3e        nb0*opt0->
-00079e40: 6e65 5b30 5d2a 6f70 7430 2d3e 6e65 5b31  ne[0]*opt0->ne[1
-00079e50: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00079e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079e70: 2020 2020 2020 206e 6230 2a6f 7074 302d         nb0*opt0-
-00079e80: 3e6e 655b 305d 2a6f 7074 302d 3e6e 655b  >ne[0]*opt0->ne[
-00079e90: 315d 2a6f 7074 302d 3e6e 655b 325d 2c0a  1]*opt0->ne[2],.
-00079ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079ec0: 2020 2020 6f66 6673 6574 293b 0a20 2020      offset);.   
-00079ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079ee0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00079ef0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00079f00: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00079f10: 2020 2020 2020 2020 2020 2020 206f 7074               opt
-00079f20: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
-00079f30: 6464 5f69 6d70 6c28 6374 782c 0a20 2020  dd_impl(ctx,.   
-00079f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079f50: 2020 2020 2020 2020 206f 7074 302d 3e67           opt0->g
-00079f60: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-00079f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079f80: 2067 7261 645f 762c 0a20 2020 2020 2020   grad_v,.       
-00079f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079fa0: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-00079fb0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00079fc0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00079fd0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00079fe0: 7365 2047 474d 4c5f 4f50 5f46 4c41 5348  se GGML_OP_FLASH
-00079ff0: 5f46 463a 0a20 2020 2020 2020 2020 2020  _FF:.           
-0007a000: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007a010: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-0007a020: 616c 7365 293b 202f 2f20 6e6f 7420 7375  alse); // not su
-0007a030: 7070 6f72 7465 640a 2020 2020 2020 2020  pported.        
-0007a040: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0007a050: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007a060: 505f 464c 4153 485f 4154 544e 5f42 4143  P_FLASH_ATTN_BAC
-0007a070: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
-0007a080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007a090: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-0007a0a0: 7365 293b 202f 2f20 6e6f 7420 7375 7070  se); // not supp
-0007a0b0: 6f72 7465 640a 2020 2020 2020 2020 2020  orted.          
-0007a0c0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0007a0d0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007a0e0: 4d41 505f 554e 4152 593a 0a20 2020 2020  MAP_UNARY:.     
-0007a0f0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007a100: 4d41 505f 4249 4e41 5259 3a0a 2020 2020  MAP_BINARY:.    
-0007a110: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007a120: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-0007a130: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
-0007a140: 206e 6f74 2073 7570 706f 7274 6564 0a20   not supported. 
-0007a150: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0007a160: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-0007a170: 2047 474d 4c5f 4f50 5f43 524f 5353 5f45   GGML_OP_CROSS_E
-0007a180: 4e54 524f 5059 5f4c 4f53 533a 0a20 2020  NTROPY_LOSS:.   
-0007a190: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0007a1a0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007a1b0: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-0007a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a1d0: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
-0007a1e0: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-0007a1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a210: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
-0007a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a230: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0007a240: 6c5f 6372 6f73 735f 656e 7472 6f70 795f  l_cross_entropy_
-0007a250: 6c6f 7373 5f62 6163 6b28 6374 782c 0a20  loss_back(ctx,. 
-0007a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a280: 2020 2073 7263 302c 0a20 2020 2020 2020     src0,.       
-0007a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a2a0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0007a2b0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-0007a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a2d0: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
-0007a2e0: 7261 6429 2c0a 2020 2020 2020 2020 2020  rad),.          
-0007a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a300: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
-0007a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a320: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-0007a330: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0007a340: 6173 6520 4747 4d4c 5f4f 505f 4352 4f53  ase GGML_OP_CROS
-0007a350: 535f 454e 5452 4f50 595f 4c4f 5353 5f42  S_ENTROPY_LOSS_B
-0007a360: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
-0007a370: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007a380: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-0007a390: 616c 7365 293b 202f 2f20 6e6f 7420 7375  alse); // not su
-0007a3a0: 7070 6f72 7465 640a 2020 2020 2020 2020  pported.        
-0007a3b0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0007a3c0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007a3d0: 505f 4e4f 4e45 3a0a 2020 2020 2020 2020  P_NONE:.        
-0007a3e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0007a3f0: 2020 2020 2020 2f2f 206e 6f70 0a20 2020        // nop.   
-0007a400: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0007a410: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0007a420: 474d 4c5f 4f50 5f43 4f55 4e54 3a0a 2020  GML_OP_COUNT:.  
-0007a430: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0007a440: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0007a450: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-0007a460: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0007a470: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 7374  eak;.    }.}..st
-0007a480: 6174 6963 2076 6f69 6420 6767 6d6c 5f76  atic void ggml_v
-0007a490: 6973 6974 5f70 6172 656e 7473 2873 7472  isit_parents(str
-0007a4a0: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
-0007a4b0: 2a20 6367 7261 7068 2c20 7374 7275 6374  * cgraph, struct
-0007a4c0: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
-0007a4d0: 6f64 6529 207b 0a20 2020 2069 6620 286e  ode) {.    if (n
-0007a4e0: 6f64 652d 3e67 7261 6420 3d3d 204e 554c  ode->grad == NUL
-0007a4f0: 4c29 207b 0a20 2020 2020 2020 202f 2f20  L) {.        // 
-0007a500: 7468 6973 2075 7375 616c 6c79 2068 6170  this usually hap
-0007a510: 7065 6e73 2077 6865 6e20 7765 2067 656e  pens when we gen
-0007a520: 6572 6174 6520 696e 7465 726d 6564 6961  erate intermedia
-0007a530: 7465 206e 6f64 6573 2066 726f 6d20 636f  te nodes from co
-0007a540: 6e73 7461 6e74 7320 696e 2074 6865 2062  nstants in the b
-0007a550: 6163 6b77 6172 6420 7061 7373 0a20 2020  ackward pass.   
-0007a560: 2020 2020 202f 2f20 6974 2063 616e 2061       // it can a
-0007a570: 6c73 6f20 6861 7070 656e 2064 7572 696e  lso happen durin
-0007a580: 6720 666f 7277 6172 6420 7061 7373 2c20  g forward pass, 
-0007a590: 6966 2074 6865 2075 7365 7220 7065 7266  if the user perf
-0007a5a0: 6f72 6d73 2063 6f6d 7075 7461 7469 6f6e  orms computation
-0007a5b0: 7320 7769 7468 2063 6f6e 7374 616e 7473  s with constants
-0007a5c0: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
-0007a5d0: 652d 3e6f 7020 213d 2047 474d 4c5f 4f50  e->op != GGML_OP
-0007a5e0: 5f4e 4f4e 4529 207b 0a20 2020 2020 2020  _NONE) {.       
-0007a5f0: 2020 2020 202f 2f47 474d 4c5f 5052 494e       //GGML_PRIN
-0007a600: 545f 4445 4255 4728 2225 733a 2077 6172  T_DEBUG("%s: war
-0007a610: 6e69 6e67 3a20 6e6f 6465 2025 7020 6861  ning: node %p ha
-0007a620: 7320 6e6f 2067 7261 642c 2062 7574 206f  s no grad, but o
-0007a630: 7020 2564 5c6e 222c 205f 5f66 756e 635f  p %d\n", __func_
-0007a640: 5f2c 2028 766f 6964 202a 2920 6e6f 6465  _, (void *) node
-0007a650: 2c20 6e6f 6465 2d3e 6f70 293b 0a20 2020  , node->op);.   
-0007a660: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-0007a670: 2020 2f2f 2063 6865 636b 2069 6620 616c    // check if al
-0007a680: 7265 6164 7920 7669 7369 7465 640a 2020  ready visited.  
-0007a690: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-0007a6a0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
-0007a6b0: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
-0007a6c0: 2020 2020 2020 6966 2028 6367 7261 7068        if (cgraph
-0007a6d0: 2d3e 6e6f 6465 735b 695d 203d 3d20 6e6f  ->nodes[i] == no
-0007a6e0: 6465 2920 7b0a 2020 2020 2020 2020 2020  de) {.          
-0007a6f0: 2020 7265 7475 726e 3b0a 2020 2020 2020    return;.      
-0007a700: 2020 7d0a 2020 2020 7d0a 0a20 2020 2066    }.    }..    f
-0007a710: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0007a720: 203c 2063 6772 6170 682d 3e6e 5f6c 6561   < cgraph->n_lea
-0007a730: 6673 3b20 692b 2b29 207b 0a20 2020 2020  fs; i++) {.     
-0007a740: 2020 2069 6620 2863 6772 6170 682d 3e6c     if (cgraph->l
-0007a750: 6561 6673 5b69 5d20 3d3d 206e 6f64 6529  eafs[i] == node)
-0007a760: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
-0007a770: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
-0007a780: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-0007a790: 6e6f 6465 2d3e 7372 6330 2920 7b0a 2020  node->src0) {.  
-0007a7a0: 2020 2020 2020 6767 6d6c 5f76 6973 6974        ggml_visit
-0007a7b0: 5f70 6172 656e 7473 2863 6772 6170 682c  _parents(cgraph,
-0007a7c0: 206e 6f64 652d 3e73 7263 3029 3b0a 2020   node->src0);.  
-0007a7d0: 2020 7d0a 0a20 2020 2069 6620 286e 6f64    }..    if (nod
-0007a7e0: 652d 3e73 7263 3129 207b 0a20 2020 2020  e->src1) {.     
-0007a7f0: 2020 2067 676d 6c5f 7669 7369 745f 7061     ggml_visit_pa
-0007a800: 7265 6e74 7328 6367 7261 7068 2c20 6e6f  rents(cgraph, no
-0007a810: 6465 2d3e 7372 6331 293b 0a20 2020 207d  de->src1);.    }
-0007a820: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
-0007a830: 203d 2030 3b20 6920 3c20 4747 4d4c 5f4d   = 0; i < GGML_M
-0007a840: 4158 5f4f 5054 3b20 2b2b 6929 207b 0a20  AX_OPT; ++i) {. 
-0007a850: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
-0007a860: 3e6f 7074 5b69 5d29 207b 0a20 2020 2020  >opt[i]) {.     
-0007a870: 2020 2020 2020 2067 676d 6c5f 7669 7369         ggml_visi
-0007a880: 745f 7061 7265 6e74 7328 6367 7261 7068  t_parents(cgraph
-0007a890: 2c20 6e6f 6465 2d3e 6f70 745b 695d 293b  , node->opt[i]);
-0007a8a0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0007a8b0: 0a0a 2020 2020 6966 2028 6e6f 6465 2d3e  ..    if (node->
-0007a8c0: 6f70 203d 3d20 4747 4d4c 5f4f 505f 4e4f  op == GGML_OP_NO
-0007a8d0: 4e45 2026 2620 6e6f 6465 2d3e 6772 6164  NE && node->grad
-0007a8e0: 203d 3d20 4e55 4c4c 2920 7b0a 2020 2020   == NULL) {.    
-0007a8f0: 2020 2020 2f2f 2072 6561 6368 6564 2061      // reached a
-0007a900: 206c 6561 6620 6e6f 6465 2c20 6e6f 7420   leaf node, not 
-0007a910: 7061 7274 206f 6620 7468 6520 6772 6164  part of the grad
-0007a920: 6965 6e74 2067 7261 7068 2028 652e 672e  ient graph (e.g.
-0007a930: 2061 2063 6f6e 7374 616e 7429 0a20 2020   a constant).   
-0007a940: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-0007a950: 2863 6772 6170 682d 3e6e 5f6c 6561 6673  (cgraph->n_leafs
-0007a960: 203c 2047 474d 4c5f 4d41 585f 4e4f 4445   < GGML_MAX_NODE
-0007a970: 5329 3b0a 0a20 2020 2020 2020 2069 6620  S);..        if 
-0007a980: 2873 7472 6c65 6e28 6e6f 6465 2d3e 6e61  (strlen(node->na
-0007a990: 6d65 2920 3d3d 2030 2920 7b0a 2020 2020  me) == 0) {.    
-0007a9a0: 2020 2020 2020 2020 736e 7072 696e 7466          snprintf
-0007a9b0: 286e 6f64 652d 3e6e 616d 652c 2073 697a  (node->name, siz
-0007a9c0: 656f 6628 6e6f 6465 2d3e 6e61 6d65 292c  eof(node->name),
-0007a9d0: 2022 6c65 6166 5f25 6422 2c20 6367 7261   "leaf_%d", cgra
-0007a9e0: 7068 2d3e 6e5f 6c65 6166 7329 3b0a 2020  ph->n_leafs);.  
-0007a9f0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0007aa00: 2063 6772 6170 682d 3e6c 6561 6673 5b63   cgraph->leafs[c
-0007aa10: 6772 6170 682d 3e6e 5f6c 6561 6673 5d20  graph->n_leafs] 
-0007aa20: 3d20 6e6f 6465 3b0a 2020 2020 2020 2020  = node;.        
-0007aa30: 6367 7261 7068 2d3e 6e5f 6c65 6166 732b  cgraph->n_leafs+
-0007aa40: 2b3b 0a20 2020 207d 2065 6c73 6520 7b0a  +;.    } else {.
-0007aa50: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-0007aa60: 4552 5428 6367 7261 7068 2d3e 6e5f 6e6f  ERT(cgraph->n_no
-0007aa70: 6465 7320 3c20 4747 4d4c 5f4d 4158 5f4e  des < GGML_MAX_N
-0007aa80: 4f44 4553 293b 0a0a 2020 2020 2020 2020  ODES);..        
-0007aa90: 6966 2028 7374 726c 656e 286e 6f64 652d  if (strlen(node-
-0007aaa0: 3e6e 616d 6529 203d 3d20 3029 207b 0a20  >name) == 0) {. 
-0007aab0: 2020 2020 2020 2020 2020 2073 6e70 7269             snpri
-0007aac0: 6e74 6628 6e6f 6465 2d3e 6e61 6d65 2c20  ntf(node->name, 
-0007aad0: 7369 7a65 6f66 286e 6f64 652d 3e6e 616d  sizeof(node->nam
-0007aae0: 6529 2c20 226e 6f64 655f 2564 222c 2063  e), "node_%d", c
-0007aaf0: 6772 6170 682d 3e6e 5f6e 6f64 6573 293b  graph->n_nodes);
-0007ab00: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0007ab10: 2020 2020 6367 7261 7068 2d3e 6e6f 6465      cgraph->node
-0007ab20: 735b 6367 7261 7068 2d3e 6e5f 6e6f 6465  s[cgraph->n_node
-0007ab30: 735d 203d 206e 6f64 653b 0a20 2020 2020  s] = node;.     
-0007ab40: 2020 2063 6772 6170 682d 3e67 7261 6473     cgraph->grads
-0007ab50: 5b63 6772 6170 682d 3e6e 5f6e 6f64 6573  [cgraph->n_nodes
-0007ab60: 5d20 3d20 6e6f 6465 2d3e 6772 6164 3b0a  ] = node->grad;.
-0007ab70: 2020 2020 2020 2020 6367 7261 7068 2d3e          cgraph->
-0007ab80: 6e5f 6e6f 6465 732b 2b3b 0a20 2020 207d  n_nodes++;.    }
-0007ab90: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-0007aba0: 6767 6d6c 5f62 7569 6c64 5f66 6f72 7761  ggml_build_forwa
-0007abb0: 7264 5f69 6d70 6c28 7374 7275 6374 2067  rd_impl(struct g
-0007abc0: 676d 6c5f 6367 7261 7068 202a 2063 6772  gml_cgraph * cgr
-0007abd0: 6170 682c 2073 7472 7563 7420 6767 6d6c  aph, struct ggml
-0007abe0: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
-0007abf0: 2c20 626f 6f6c 2065 7870 616e 6429 207b  , bool expand) {
-0007ac00: 0a20 2020 2069 6620 2821 6578 7061 6e64  .    if (!expand
-0007ac10: 2920 7b0a 2020 2020 2020 2020 6367 7261  ) {.        cgra
-0007ac20: 7068 2d3e 6e5f 6e6f 6465 7320 3d20 303b  ph->n_nodes = 0;
-0007ac30: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
-0007ac40: 3e6e 5f6c 6561 6673 203d 2030 3b0a 2020  >n_leafs = 0;.  
-0007ac50: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
-0007ac60: 6e74 206e 3020 3d20 6367 7261 7068 2d3e  nt n0 = cgraph->
-0007ac70: 6e5f 6e6f 6465 733b 0a20 2020 2055 4e55  n_nodes;.    UNU
-0007ac80: 5345 4428 6e30 293b 0a0a 2020 2020 6767  SED(n0);..    gg
-0007ac90: 6d6c 5f76 6973 6974 5f70 6172 656e 7473  ml_visit_parents
-0007aca0: 2863 6772 6170 682c 2074 656e 736f 7229  (cgraph, tensor)
-0007acb0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0007acc0: 206e 5f6e 6577 203d 2063 6772 6170 682d   n_new = cgraph-
-0007acd0: 3e6e 5f6e 6f64 6573 202d 206e 303b 0a20  >n_nodes - n0;. 
-0007ace0: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
-0007acf0: 4255 4728 2225 733a 2076 6973 6974 6564  BUG("%s: visited
-0007ad00: 2025 6420 6e65 7720 6e6f 6465 735c 6e22   %d new nodes\n"
-0007ad10: 2c20 5f5f 6675 6e63 5f5f 2c20 6e5f 6e65  , __func__, n_ne
-0007ad20: 7729 3b0a 0a20 2020 2069 6620 286e 5f6e  w);..    if (n_n
-0007ad30: 6577 203e 2030 2920 7b0a 2020 2020 2020  ew > 0) {.      
-0007ad40: 2020 2f2f 2074 6865 206c 6173 7420 6164    // the last ad
-0007ad50: 6465 6420 6e6f 6465 2073 686f 756c 6420  ded node should 
-0007ad60: 616c 7761 7973 2062 6520 7374 6172 7469  always be starti
-0007ad70: 6e67 2070 6f69 6e74 0a20 2020 2020 2020  ng point.       
-0007ad80: 2047 474d 4c5f 4153 5345 5254 2863 6772   GGML_ASSERT(cgr
-0007ad90: 6170 682d 3e6e 6f64 6573 5b63 6772 6170  aph->nodes[cgrap
-0007ada0: 682d 3e6e 5f6e 6f64 6573 202d 2031 5d20  h->n_nodes - 1] 
-0007adb0: 3d3d 2074 656e 736f 7229 3b0a 2020 2020  == tensor);.    
-0007adc0: 7d0a 7d0a 0a76 6f69 6420 6767 6d6c 5f62  }.}..void ggml_b
-0007add0: 7569 6c64 5f66 6f72 7761 7264 5f65 7870  uild_forward_exp
-0007ade0: 616e 6428 7374 7275 6374 2067 676d 6c5f  and(struct ggml_
-0007adf0: 6367 7261 7068 202a 2063 6772 6170 682c  cgraph * cgraph,
-0007ae00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0007ae10: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
-0007ae20: 2020 2020 6767 6d6c 5f62 7569 6c64 5f66      ggml_build_f
-0007ae30: 6f72 7761 7264 5f69 6d70 6c28 6367 7261  orward_impl(cgra
-0007ae40: 7068 2c20 7465 6e73 6f72 2c20 7472 7565  ph, tensor, true
-0007ae50: 293b 0a7d 0a0a 7374 7275 6374 2067 676d  );.}..struct ggm
-0007ae60: 6c5f 6367 7261 7068 2067 676d 6c5f 6275  l_cgraph ggml_bu
-0007ae70: 696c 645f 666f 7277 6172 6428 7374 7275  ild_forward(stru
-0007ae80: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0007ae90: 2074 656e 736f 7229 207b 0a20 2020 2073   tensor) {.    s
-0007aea0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-0007aeb0: 6820 7265 7375 6c74 203d 207b 0a20 2020  h result = {.   
-0007aec0: 2020 2020 202f 2a2e 6e5f 6e6f 6465 7320       /*.n_nodes 
-0007aed0: 2020 2020 203d 2a2f 2030 2c0a 2020 2020       =*/ 0,.    
-0007aee0: 2020 2020 2f2a 2e6e 5f6c 6561 6673 2020      /*.n_leafs  
-0007aef0: 2020 2020 3d2a 2f20 302c 0a20 2020 2020      =*/ 0,.     
-0007af00: 2020 202f 2a2e 6e5f 7468 7265 6164 7320     /*.n_threads 
-0007af10: 2020 203d 2a2f 2047 474d 4c5f 4445 4641     =*/ GGML_DEFA
-0007af20: 554c 545f 4e5f 5448 5245 4144 532c 0a20  ULT_N_THREADS,. 
-0007af30: 2020 2020 2020 202f 2a2e 776f 726b 5f73         /*.work_s
-0007af40: 697a 6520 2020 203d 2a2f 2030 2c0a 2020  ize    =*/ 0,.  
-0007af50: 2020 2020 2020 2f2a 2e77 6f72 6b20 2020        /*.work   
-0007af60: 2020 2020 2020 3d2a 2f20 4e55 4c4c 2c0a        =*/ NULL,.
-0007af70: 2020 2020 2020 2020 2f2a 2e6e 6f64 6573          /*.nodes
-0007af80: 2020 2020 2020 2020 3d2a 2f20 7b20 4e55          =*/ { NU
-0007af90: 4c4c 207d 2c0a 2020 2020 2020 2020 2f2a  LL },.        /*
-0007afa0: 2e67 7261 6473 2020 2020 2020 2020 3d2a  .grads        =*
-0007afb0: 2f20 7b20 4e55 4c4c 207d 2c0a 2020 2020  / { NULL },.    
-0007afc0: 2020 2020 2f2a 2e6c 6561 6673 2020 2020      /*.leafs    
-0007afd0: 2020 2020 3d2a 2f20 7b20 4e55 4c4c 207d      =*/ { NULL }
-0007afe0: 2c0a 2020 2020 2020 2020 2f2a 2e70 6572  ,.        /*.per
-0007aff0: 665f 7275 6e73 2020 2020 3d2a 2f20 302c  f_runs    =*/ 0,
-0007b000: 0a20 2020 2020 2020 202f 2a2e 7065 7266  .        /*.perf
-0007b010: 5f63 7963 6c65 7320 203d 2a2f 2030 2c0a  _cycles  =*/ 0,.
-0007b020: 2020 2020 2020 2020 2f2a 2e70 6572 665f          /*.perf_
-0007b030: 7469 6d65 5f75 7320 3d2a 2f20 302c 0a20  time_us =*/ 0,. 
-0007b040: 2020 207d 3b0a 0a20 2020 2067 676d 6c5f     };..    ggml_
-0007b050: 6275 696c 645f 666f 7277 6172 645f 696d  build_forward_im
-0007b060: 706c 2826 7265 7375 6c74 2c20 7465 6e73  pl(&result, tens
-0007b070: 6f72 2c20 6661 6c73 6529 3b0a 0a20 2020  or, false);..   
-0007b080: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-0007b090: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f63  }..struct ggml_c
-0007b0a0: 6772 6170 6820 6767 6d6c 5f62 7569 6c64  graph ggml_build
-0007b0b0: 5f62 6163 6b77 6172 6428 7374 7275 6374  _backward(struct
-0007b0c0: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0007b0d0: 6374 782c 2073 7472 7563 7420 6767 6d6c  ctx, struct ggml
-0007b0e0: 5f63 6772 6170 6820 2a20 6766 2c20 626f  _cgraph * gf, bo
-0007b0f0: 6f6c 206b 6565 7029 207b 0a20 2020 2073  ol keep) {.    s
-0007b100: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-0007b110: 6820 7265 7375 6c74 203d 202a 6766 3b0a  h result = *gf;.
-0007b120: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0007b130: 2867 662d 3e6e 5f6e 6f64 6573 203e 2030  (gf->n_nodes > 0
-0007b140: 293b 0a0a 2020 2020 2f2f 2069 6620 7765  );..    // if we
-0007b150: 2061 7265 206b 6565 7069 6e67 2074 6865   are keeping the
-0007b160: 2067 7261 6469 656e 7420 6772 6170 682c   gradient graph,
-0007b170: 2077 6520 6861 7665 2074 6f20 6465 7461   we have to deta
-0007b180: 6368 2074 6865 2067 7261 6469 656e 7420  ch the gradient 
-0007b190: 6e6f 6465 7320 6672 6f6d 2074 6865 206f  nodes from the o
-0007b1a0: 7269 6769 6e61 6c20 6772 6170 680a 2020  riginal graph.  
-0007b1b0: 2020 6966 2028 6b65 6570 2920 7b0a 2020    if (keep) {.  
-0007b1c0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0007b1d0: 203d 2030 3b20 6920 3c20 6766 2d3e 6e5f   = 0; i < gf->n_
-0007b1e0: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
-0007b1f0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-0007b200: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
-0007b210: 6f64 6520 3d20 6766 2d3e 6e6f 6465 735b  ode = gf->nodes[
-0007b220: 695d 3b0a 0a20 2020 2020 2020 2020 2020  i];..           
-0007b230: 2069 6620 286e 6f64 652d 3e67 7261 6429   if (node->grad)
-0007b240: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007b250: 2020 206e 6f64 652d 3e67 7261 6420 3d20     node->grad = 
-0007b260: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
-0007b270: 6374 782c 206e 6f64 6529 3b0a 2020 2020  ctx, node);.    
-0007b280: 2020 2020 2020 2020 2020 2020 6766 2d3e              gf->
-0007b290: 6772 6164 735b 695d 203d 206e 6f64 652d  grads[i] = node-
-0007b2a0: 3e67 7261 643b 0a20 2020 2020 2020 2020  >grad;.         
-0007b2b0: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-0007b2c0: 2020 207d 0a0a 2020 2020 666f 7220 2869     }..    for (i
-0007b2d0: 6e74 2069 203d 2067 662d 3e6e 5f6e 6f64  nt i = gf->n_nod
-0007b2e0: 6573 202d 2031 3b20 6920 3e3d 2030 3b20  es - 1; i >= 0; 
-0007b2f0: 692d 2d29 207b 0a20 2020 2020 2020 2073  i--) {.        s
-0007b300: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0007b310: 7220 2a20 6e6f 6465 203d 2067 662d 3e6e  r * node = gf->n
-0007b320: 6f64 6573 5b69 5d3b 0a0a 2020 2020 2020  odes[i];..      
-0007b330: 2020 2f2f 2062 6563 6175 7365 2077 6520    // because we 
-0007b340: 6465 7461 6368 6564 2074 6865 2067 7261  detached the gra
-0007b350: 6420 6e6f 6465 7320 6672 6f6d 2074 6865  d nodes from the
-0007b360: 206f 7269 6769 6e61 6c20 6772 6170 682c   original graph,
-0007b370: 2077 6520 6361 6e20 6166 666f 7264 2069   we can afford i
-0007b380: 6e70 6c61 6365 206f 7065 7261 7469 6f6e  nplace operation
-0007b390: 730a 2020 2020 2020 2020 6966 2028 6e6f  s.        if (no
-0007b3a0: 6465 2d3e 6772 6164 2920 7b0a 2020 2020  de->grad) {.    
-0007b3b0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-0007b3c0: 7075 7465 5f62 6163 6b77 6172 6428 6374  pute_backward(ct
-0007b3d0: 782c 206e 6f64 652c 206b 6565 7029 3b0a  x, node, keep);.
-0007b3e0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-0007b3f0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-0007b400: 3d20 6766 2d3e 6e5f 6e6f 6465 7320 2d20  = gf->n_nodes - 
-0007b410: 313b 2069 203e 3d20 303b 2069 2d2d 2920  1; i >= 0; i--) 
-0007b420: 7b0a 2020 2020 2020 2020 7374 7275 6374  {.        struct
-0007b430: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
-0007b440: 6f64 6520 3d20 6766 2d3e 6e6f 6465 735b  ode = gf->nodes[
-0007b450: 695d 3b0a 0a20 2020 2020 2020 2069 6620  i];..        if 
-0007b460: 286e 6f64 652d 3e69 735f 7061 7261 6d29  (node->is_param)
-0007b470: 207b 0a20 2020 2020 2020 2020 2020 2047   {.            G
-0007b480: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
-0007b490: 2225 733a 2066 6f75 6e64 2072 6f6f 7420  "%s: found root 
-0007b4a0: 6e6f 6465 2025 705c 6e22 2c20 5f5f 6675  node %p\n", __fu
-0007b4b0: 6e63 5f5f 2c20 2876 6f69 6420 2a29 206e  nc__, (void *) n
-0007b4c0: 6f64 6529 3b0a 2020 2020 2020 2020 2020  ode);.          
-0007b4d0: 2020 6767 6d6c 5f62 7569 6c64 5f66 6f72    ggml_build_for
-0007b4e0: 7761 7264 5f69 6d70 6c28 2672 6573 756c  ward_impl(&resul
-0007b4f0: 742c 206e 6f64 652d 3e67 7261 642c 2074  t, node->grad, t
-0007b500: 7275 6529 3b0a 2020 2020 2020 2020 7d0a  rue);.        }.
-0007b510: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
-0007b520: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f0a  n result;.}..//.
-0007b530: 2f2f 2074 6872 6561 6420 6461 7461 0a2f  // thread data./
-0007b540: 2f0a 2f2f 2073 796e 6368 726f 6e69 7a61  /.// synchroniza
-0007b550: 7469 6f6e 2069 7320 646f 6e65 2076 6961  tion is done via
-0007b560: 2062 7573 7920 6c6f 6f70 730a 2f2f 2049   busy loops.// I
-0007b570: 2074 7269 6564 2075 7369 6e67 2073 7069   tried using spi
-0007b580: 6e20 6c6f 636b 732c 2062 7574 206e 6f74  n locks, but not
-0007b590: 2073 7572 6520 686f 7720 746f 2075 7365   sure how to use
-0007b5a0: 2074 6865 6d20 636f 7272 6563 746c 7920   them correctly 
-0007b5b0: 2d20 7468 6520 7468 696e 6773 2049 2074  - the things I t
-0007b5c0: 7269 6564 2077 6572 6520 736c 6f77 6572  ried were slower
-0007b5d0: 2074 6861 6e20 6275 7379 206c 6f6f 7073   than busy loops
-0007b5e0: 0a2f 2f0a 0a23 6966 6465 6620 5f5f 4150  .//..#ifdef __AP
-0007b5f0: 504c 455f 5f0a 0a2f 2f23 696e 636c 7564  PLE__..//#includ
-0007b600: 6520 3c6f 732f 6c6f 636b 2e68 3e0a 2f2f  e <os/lock.h>.//
-0007b610: 0a2f 2f74 7970 6564 6566 206f 735f 756e  .//typedef os_un
-0007b620: 6661 6972 5f6c 6f63 6b20 6767 6d6c 5f6c  fair_lock ggml_l
-0007b630: 6f63 6b5f 743b 0a2f 2f0a 2f2f 2364 6566  ock_t;.//.//#def
-0007b640: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 696e  ine ggml_lock_in
-0007b650: 6974 2878 2920 2020 2055 4e55 5345 4428  it(x)    UNUSED(
-0007b660: 7829 0a2f 2f23 6465 6669 6e65 2067 676d  x).//#define ggm
-0007b670: 6c5f 6c6f 636b 5f64 6573 7472 6f79 2878  l_lock_destroy(x
-0007b680: 2920 554e 5553 4544 2878 290a 2f2f 2364  ) UNUSED(x).//#d
-0007b690: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-0007b6a0: 6c6f 636b 2020 2020 2020 206f 735f 756e  lock       os_un
-0007b6b0: 6661 6972 5f6c 6f63 6b5f 6c6f 636b 0a2f  fair_lock_lock./
-0007b6c0: 2f23 6465 6669 6e65 2067 676d 6c5f 6c6f  /#define ggml_lo
-0007b6d0: 636b 5f75 6e6c 6f63 6b20 2020 2020 6f73  ck_unlock     os
-0007b6e0: 5f75 6e66 6169 725f 6c6f 636b 5f75 6e6c  _unfair_lock_unl
-0007b6f0: 6f63 6b0a 2f2f 0a2f 2f23 6465 6669 6e65  ock.//.//#define
-0007b700: 2047 474d 4c5f 4c4f 434b 5f49 4e49 5449   GGML_LOCK_INITI
-0007b710: 414c 495a 4552 204f 535f 554e 4641 4952  ALIZER OS_UNFAIR
-0007b720: 5f4c 4f43 4b5f 494e 4954 0a0a 7479 7065  _LOCK_INIT..type
-0007b730: 6465 6620 696e 7420 6767 6d6c 5f6c 6f63  def int ggml_loc
-0007b740: 6b5f 743b 0a0a 2364 6566 696e 6520 6767  k_t;..#define gg
-0007b750: 6d6c 5f6c 6f63 6b5f 696e 6974 2878 2920  ml_lock_init(x) 
-0007b760: 2020 2055 4e55 5345 4428 7829 0a23 6465     UNUSED(x).#de
-0007b770: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f64  fine ggml_lock_d
-0007b780: 6573 7472 6f79 2878 2920 554e 5553 4544  estroy(x) UNUSED
-0007b790: 2878 290a 2364 6566 696e 6520 6767 6d6c  (x).#define ggml
-0007b7a0: 5f6c 6f63 6b5f 6c6f 636b 2878 2920 2020  _lock_lock(x)   
-0007b7b0: 2055 4e55 5345 4428 7829 0a23 6465 6669   UNUSED(x).#defi
-0007b7c0: 6e65 2067 676d 6c5f 6c6f 636b 5f75 6e6c  ne ggml_lock_unl
-0007b7d0: 6f63 6b28 7829 2020 554e 5553 4544 2878  ock(x)  UNUSED(x
-0007b7e0: 290a 0a23 6465 6669 6e65 2047 474d 4c5f  )..#define GGML_
-0007b7f0: 4c4f 434b 5f49 4e49 5449 414c 495a 4552  LOCK_INITIALIZER
-0007b800: 2030 0a0a 7479 7065 6465 6620 7074 6872   0..typedef pthr
-0007b810: 6561 645f 7420 6767 6d6c 5f74 6872 6561  ead_t ggml_threa
-0007b820: 645f 743b 0a0a 2364 6566 696e 6520 6767  d_t;..#define gg
-0007b830: 6d6c 5f74 6872 6561 645f 6372 6561 7465  ml_thread_create
-0007b840: 2070 7468 7265 6164 5f63 7265 6174 650a   pthread_create.
-0007b850: 2364 6566 696e 6520 6767 6d6c 5f74 6872  #define ggml_thr
-0007b860: 6561 645f 6a6f 696e 2020 2070 7468 7265  ead_join   pthre
-0007b870: 6164 5f6a 6f69 6e0a 0a23 656c 7365 0a0a  ad_join..#else..
-0007b880: 2f2f 7479 7065 6465 6620 7074 6872 6561  //typedef pthrea
-0007b890: 645f 7370 696e 6c6f 636b 5f74 2067 676d  d_spinlock_t ggm
-0007b8a0: 6c5f 6c6f 636b 5f74 3b0a 0a2f 2f23 6465  l_lock_t;..//#de
-0007b8b0: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f69  fine ggml_lock_i
-0007b8c0: 6e69 7428 7829 2070 7468 7265 6164 5f73  nit(x) pthread_s
-0007b8d0: 7069 6e5f 696e 6974 2878 2c20 5054 4852  pin_init(x, PTHR
-0007b8e0: 4541 445f 5052 4f43 4553 535f 5052 4956  EAD_PROCESS_PRIV
-0007b8f0: 4154 4529 0a2f 2f23 6465 6669 6e65 2067  ATE).//#define g
-0007b900: 676d 6c5f 6c6f 636b 5f64 6573 7472 6f79  gml_lock_destroy
-0007b910: 2070 7468 7265 6164 5f73 7069 6e5f 6465   pthread_spin_de
-0007b920: 7374 726f 790a 2f2f 2364 6566 696e 6520  stroy.//#define 
-0007b930: 6767 6d6c 5f6c 6f63 6b5f 6c6f 636b 2020  ggml_lock_lock  
-0007b940: 2020 7074 6872 6561 645f 7370 696e 5f6c    pthread_spin_l
-0007b950: 6f63 6b0a 2f2f 2364 6566 696e 6520 6767  ock.//#define gg
-0007b960: 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b 2020  ml_lock_unlock  
-0007b970: 7074 6872 6561 645f 7370 696e 5f75 6e6c  pthread_spin_unl
-0007b980: 6f63 6b0a 0a74 7970 6564 6566 2069 6e74  ock..typedef int
-0007b990: 2067 676d 6c5f 6c6f 636b 5f74 3b0a 0a23   ggml_lock_t;..#
-0007b9a0: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
-0007b9b0: 5f69 6e69 7428 7829 2020 2020 554e 5553  _init(x)    UNUS
-0007b9c0: 4544 2878 290a 2364 6566 696e 6520 6767  ED(x).#define gg
-0007b9d0: 6d6c 5f6c 6f63 6b5f 6465 7374 726f 7928  ml_lock_destroy(
-0007b9e0: 7829 2055 4e55 5345 4428 7829 0a23 6966  x) UNUSED(x).#if
-0007b9f0: 2064 6566 696e 6564 285f 5f78 3836 5f36   defined(__x86_6
-0007ba00: 345f 5f29 207c 7c20 2864 6566 696e 6564  4__) || (defined
-0007ba10: 285f 4d53 435f 5645 5229 2026 2620 6465  (_MSC_VER) && de
-0007ba20: 6669 6e65 6428 5f4d 5f41 4d44 3634 2929  fined(_M_AMD64))
-0007ba30: 0a23 6465 6669 6e65 2067 676d 6c5f 6c6f  .#define ggml_lo
-0007ba40: 636b 5f6c 6f63 6b28 7829 2020 2020 5f6d  ck_lock(x)    _m
-0007ba50: 6d5f 7061 7573 6528 290a 2365 6c73 650a  m_pause().#else.
-0007ba60: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
-0007ba70: 6b5f 6c6f 636b 2878 2920 2020 2055 4e55  k_lock(x)    UNU
-0007ba80: 5345 4428 7829 0a23 656e 6469 660a 2364  SED(x).#endif.#d
-0007ba90: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-0007baa0: 756e 6c6f 636b 2878 2920 2055 4e55 5345  unlock(x)  UNUSE
-0007bab0: 4428 7829 0a0a 2364 6566 696e 6520 4747  D(x)..#define GG
-0007bac0: 4d4c 5f4c 4f43 4b5f 494e 4954 4941 4c49  ML_LOCK_INITIALI
-0007bad0: 5a45 5220 300a 0a74 7970 6564 6566 2070  ZER 0..typedef p
-0007bae0: 7468 7265 6164 5f74 2067 676d 6c5f 7468  thread_t ggml_th
-0007baf0: 7265 6164 5f74 3b0a 0a23 6465 6669 6e65  read_t;..#define
-0007bb00: 2067 676d 6c5f 7468 7265 6164 5f63 7265   ggml_thread_cre
-0007bb10: 6174 6520 7074 6872 6561 645f 6372 6561  ate pthread_crea
-0007bb20: 7465 0a23 6465 6669 6e65 2067 676d 6c5f  te.#define ggml_
-0007bb30: 7468 7265 6164 5f6a 6f69 6e20 2020 7074  thread_join   pt
-0007bb40: 6872 6561 645f 6a6f 696e 0a0a 2365 6e64  hread_join..#end
-0007bb50: 6966 0a0a 7374 7275 6374 2067 676d 6c5f  if..struct ggml_
-0007bb60: 636f 6d70 7574 655f 7374 6174 655f 7368  compute_state_sh
-0007bb70: 6172 6564 207b 0a20 2020 2067 676d 6c5f  ared {.    ggml_
-0007bb80: 6c6f 636b 5f74 2073 7069 6e3b 0a0a 2020  lock_t spin;..  
-0007bb90: 2020 696e 7420 6e5f 7468 7265 6164 733b    int n_threads;
-0007bba0: 0a0a 2020 2020 2f2f 2073 796e 6368 726f  ..    // synchro
-0007bbb0: 6e69 7a61 7469 6f6e 2070 7269 6d69 7469  nization primiti
-0007bbc0: 7665 730a 2020 2020 6174 6f6d 6963 5f69  ves.    atomic_i
-0007bbd0: 6e74 2020 6e5f 7265 6164 793b 0a20 2020  nt  n_ready;.   
-0007bbe0: 2061 746f 6d69 635f 626f 6f6c 2068 6173   atomic_bool has
-0007bbf0: 5f77 6f72 6b3b 0a20 2020 2061 746f 6d69  _work;.    atomi
-0007bc00: 635f 626f 6f6c 2073 746f 703b 202f 2f20  c_bool stop; // 
-0007bc10: 7374 6f70 2061 6c6c 2074 6872 6561 6473  stop all threads
-0007bc20: 0a7d 3b0a 0a73 7472 7563 7420 6767 6d6c  .};..struct ggml
-0007bc30: 5f63 6f6d 7075 7465 5f73 7461 7465 207b  _compute_state {
-0007bc40: 0a20 2020 2067 676d 6c5f 7468 7265 6164  .    ggml_thread
-0007bc50: 5f74 2074 6872 643b 0a0a 2020 2020 7374  _t thrd;..    st
-0007bc60: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-0007bc70: 655f 7061 7261 6d73 2070 6172 616d 733b  e_params params;
-0007bc80: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-0007bc90: 5f74 656e 736f 7220 2a20 6e6f 6465 3b0a  _tensor * node;.
-0007bca0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-0007bcb0: 5f63 6f6d 7075 7465 5f73 7461 7465 5f73  _compute_state_s
-0007bcc0: 6861 7265 6420 2a20 7368 6172 6564 3b0a  hared * shared;.
-0007bcd0: 7d3b 0a0a 7374 6174 6963 2074 6872 6561  };..static threa
-0007bce0: 645f 7265 745f 7420 6767 6d6c 5f67 7261  d_ret_t ggml_gra
-0007bcf0: 7068 5f63 6f6d 7075 7465 5f74 6872 6561  ph_compute_threa
-0007bd00: 6428 766f 6964 202a 2064 6174 6129 207b  d(void * data) {
-0007bd10: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-0007bd20: 5f63 6f6d 7075 7465 5f73 7461 7465 202a  _compute_state *
-0007bd30: 2073 7461 7465 203d 2028 7374 7275 6374   state = (struct
-0007bd40: 2067 676d 6c5f 636f 6d70 7574 655f 7374   ggml_compute_st
-0007bd50: 6174 6520 2a29 2064 6174 613b 0a0a 2020  ate *) data;..  
-0007bd60: 2020 636f 6e73 7420 696e 7420 6e5f 7468    const int n_th
-0007bd70: 7265 6164 7320 3d20 7374 6174 652d 3e73  reads = state->s
-0007bd80: 6861 7265 642d 3e6e 5f74 6872 6561 6473  hared->n_threads
-0007bd90: 3b0a 0a20 2020 2077 6869 6c65 2028 7472  ;..    while (tr
-0007bda0: 7565 2920 7b0a 2020 2020 2020 2020 6966  ue) {.        if
-0007bdb0: 2028 6174 6f6d 6963 5f66 6574 6368 5f61   (atomic_fetch_a
-0007bdc0: 6464 2826 7374 6174 652d 3e73 6861 7265  dd(&state->share
-0007bdd0: 642d 3e6e 5f72 6561 6479 2c20 3129 203d  d->n_ready, 1) =
-0007bde0: 3d20 6e5f 7468 7265 6164 7320 2d20 3129  = n_threads - 1)
-0007bdf0: 207b 0a20 2020 2020 2020 2020 2020 2061   {.            a
-0007be00: 746f 6d69 635f 7374 6f72 6528 2673 7461  tomic_store(&sta
-0007be10: 7465 2d3e 7368 6172 6564 2d3e 6861 735f  te->shared->has_
-0007be20: 776f 726b 2c20 6661 6c73 6529 3b0a 2020  work, false);.  
-0007be30: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-0007be40: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-0007be50: 2028 6174 6f6d 6963 5f6c 6f61 6428 2673   (atomic_load(&s
-0007be60: 7461 7465 2d3e 7368 6172 6564 2d3e 6861  tate->shared->ha
-0007be70: 735f 776f 726b 2929 207b 0a20 2020 2020  s_work)) {.     
-0007be80: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
-0007be90: 746f 6d69 635f 6c6f 6164 2826 7374 6174  tomic_load(&stat
-0007bea0: 652d 3e73 6861 7265 642d 3e73 746f 7029  e->shared->stop)
-0007beb0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007bec0: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
-0007bed0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007bee0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007bef0: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 6c6f      ggml_lock_lo
-0007bf00: 636b 2020 2826 7374 6174 652d 3e73 6861  ck  (&state->sha
-0007bf10: 7265 642d 3e73 7069 6e29 3b0a 2020 2020  red->spin);.    
-0007bf20: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0007bf30: 5f6c 6f63 6b5f 756e 6c6f 636b 2826 7374  _lock_unlock(&st
-0007bf40: 6174 652d 3e73 6861 7265 642d 3e73 7069  ate->shared->spi
-0007bf50: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
-0007bf60: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-0007bf70: 2020 2020 2061 746f 6d69 635f 6665 7463       atomic_fetc
-0007bf80: 685f 7375 6228 2673 7461 7465 2d3e 7368  h_sub(&state->sh
-0007bf90: 6172 6564 2d3e 6e5f 7265 6164 792c 2031  ared->n_ready, 1
-0007bfa0: 293b 0a0a 2020 2020 2020 2020 2f2f 2077  );..        // w
-0007bfb0: 6169 7420 666f 7220 776f 726b 0a20 2020  ait for work.   
-0007bfc0: 2020 2020 2077 6869 6c65 2028 2161 746f       while (!ato
-0007bfd0: 6d69 635f 6c6f 6164 2826 7374 6174 652d  mic_load(&state-
-0007bfe0: 3e73 6861 7265 642d 3e68 6173 5f77 6f72  >shared->has_wor
-0007bff0: 6b29 2920 7b0a 2020 2020 2020 2020 2020  k)) {.          
-0007c000: 2020 6966 2028 6174 6f6d 6963 5f6c 6f61    if (atomic_loa
-0007c010: 6428 2673 7461 7465 2d3e 7368 6172 6564  d(&state->shared
-0007c020: 2d3e 7374 6f70 2929 207b 0a20 2020 2020  ->stop)) {.     
-0007c030: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0007c040: 6e20 303b 0a20 2020 2020 2020 2020 2020  n 0;.           
-0007c050: 207d 0a20 2020 2020 2020 2020 2020 2067   }.            g
-0007c060: 676d 6c5f 6c6f 636b 5f6c 6f63 6b20 2028  gml_lock_lock  (
-0007c070: 2673 7461 7465 2d3e 7368 6172 6564 2d3e  &state->shared->
-0007c080: 7370 696e 293b 0a20 2020 2020 2020 2020  spin);.         
-0007c090: 2020 2067 676d 6c5f 6c6f 636b 5f75 6e6c     ggml_lock_unl
-0007c0a0: 6f63 6b28 2673 7461 7465 2d3e 7368 6172  ock(&state->shar
-0007c0b0: 6564 2d3e 7370 696e 293b 0a20 2020 2020  ed->spin);.     
-0007c0c0: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
-0007c0d0: 2063 6865 636b 2069 6620 7765 2073 686f   check if we sho
-0007c0e0: 756c 6420 7374 6f70 0a20 2020 2020 2020  uld stop.       
-0007c0f0: 2069 6620 2861 746f 6d69 635f 6c6f 6164   if (atomic_load
-0007c100: 2826 7374 6174 652d 3e73 6861 7265 642d  (&state->shared-
-0007c110: 3e73 746f 7029 2920 7b0a 2020 2020 2020  >stop)) {.      
-0007c120: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
-0007c130: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0007c140: 6966 2028 7374 6174 652d 3e6e 6f64 6529  if (state->node)
-0007c150: 207b 0a20 2020 2020 2020 2020 2020 2069   {.            i
-0007c160: 6620 2873 7461 7465 2d3e 7061 7261 6d73  f (state->params
-0007c170: 2e69 7468 203c 2073 7461 7465 2d3e 7061  .ith < state->pa
-0007c180: 7261 6d73 2e6e 7468 2920 7b0a 2020 2020  rams.nth) {.    
-0007c190: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0007c1a0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0007c1b0: 2826 7374 6174 652d 3e70 6172 616d 732c  (&state->params,
-0007c1c0: 2073 7461 7465 2d3e 6e6f 6465 293b 0a20   state->node);. 
-0007c1d0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-0007c1e0: 2020 2020 2020 2020 2020 7374 6174 652d            state-
-0007c1f0: 3e6e 6f64 6520 3d20 4e55 4c4c 3b0a 2020  >node = NULL;.  
-0007c200: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-0007c210: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0007c220: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-0007c230: 7d0a 0a20 2020 2072 6574 7572 6e20 303b  }..    return 0;
-0007c240: 0a7d 0a0a 766f 6964 2067 676d 6c5f 6772  .}..void ggml_gr
-0007c250: 6170 685f 636f 6d70 7574 6528 7374 7275  aph_compute(stru
-0007c260: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0007c270: 2a20 6374 782c 2073 7472 7563 7420 6767  * ctx, struct gg
-0007c280: 6d6c 5f63 6772 6170 6820 2a20 6367 7261  ml_cgraph * cgra
-0007c290: 7068 2920 7b0a 2020 2020 636f 6e73 7420  ph) {.    const 
-0007c2a0: 696e 7420 6e5f 7468 7265 6164 7320 3d20  int n_threads = 
-0007c2b0: 6367 7261 7068 2d3e 6e5f 7468 7265 6164  cgraph->n_thread
-0007c2c0: 733b 0a0a 2020 2020 7374 7275 6374 2067  s;..    struct g
-0007c2d0: 676d 6c5f 636f 6d70 7574 655f 7374 6174  gml_compute_stat
-0007c2e0: 655f 7368 6172 6564 2073 7461 7465 5f73  e_shared state_s
-0007c2f0: 6861 7265 6420 3d20 7b0a 2020 2020 2020  hared = {.      
-0007c300: 2020 2f2a 2e73 7069 6e20 2020 2020 203d    /*.spin      =
-0007c310: 2a2f 2047 474d 4c5f 4c4f 434b 5f49 4e49  */ GGML_LOCK_INI
-0007c320: 5449 414c 495a 4552 2c0a 2020 2020 2020  TIALIZER,.      
-0007c330: 2020 2f2a 2e6e 5f74 6872 6561 6473 203d    /*.n_threads =
-0007c340: 2a2f 206e 5f74 6872 6561 6473 2c0a 2020  */ n_threads,.  
-0007c350: 2020 2020 2020 2f2a 2e6e 5f72 6561 6479        /*.n_ready
-0007c360: 2020 203d 2a2f 2030 2c0a 2020 2020 2020     =*/ 0,.      
-0007c370: 2020 2f2a 2e68 6173 5f77 6f72 6b20 203d    /*.has_work  =
-0007c380: 2a2f 2066 616c 7365 2c0a 2020 2020 2020  */ false,.      
-0007c390: 2020 2f2a 2e73 746f 7020 2020 2020 203d    /*.stop      =
-0007c3a0: 2a2f 2066 616c 7365 2c0a 2020 2020 7d3b  */ false,.    };
-0007c3b0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-0007c3c0: 5f63 6f6d 7075 7465 5f73 7461 7465 202a  _compute_state *
-0007c3d0: 2077 6f72 6b65 7273 203d 206e 5f74 6872   workers = n_thr
-0007c3e0: 6561 6473 203e 2031 203f 2061 6c6c 6f63  eads > 1 ? alloc
-0007c3f0: 6128 7369 7a65 6f66 2873 7472 7563 7420  a(sizeof(struct 
-0007c400: 6767 6d6c 5f63 6f6d 7075 7465 5f73 7461  ggml_compute_sta
-0007c410: 7465 292a 286e 5f74 6872 6561 6473 202d  te)*(n_threads -
-0007c420: 2031 2929 203a 204e 554c 4c3b 0a0a 2020   1)) : NULL;..  
-0007c430: 2020 2f2f 2063 7265 6174 6520 7468 7265    // create thre
-0007c440: 6164 2070 6f6f 6c0a 2020 2020 6966 2028  ad pool.    if (
-0007c450: 6e5f 7468 7265 6164 7320 3e20 3129 207b  n_threads > 1) {
-0007c460: 0a20 2020 2020 2020 2067 676d 6c5f 6c6f  .        ggml_lo
-0007c470: 636b 5f69 6e69 7428 2673 7461 7465 5f73  ck_init(&state_s
-0007c480: 6861 7265 642e 7370 696e 293b 0a0a 2020  hared.spin);..  
-0007c490: 2020 2020 2020 6174 6f6d 6963 5f73 746f        atomic_sto
-0007c4a0: 7265 2826 7374 6174 655f 7368 6172 6564  re(&state_shared
-0007c4b0: 2e68 6173 5f77 6f72 6b2c 2074 7275 6529  .has_work, true)
-0007c4c0: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
-0007c4d0: 696e 7420 6a20 3d20 303b 206a 203c 206e  int j = 0; j < n
-0007c4e0: 5f74 6872 6561 6473 202d 2031 3b20 6a2b  _threads - 1; j+
-0007c4f0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-0007c500: 2077 6f72 6b65 7273 5b6a 5d20 3d20 2873   workers[j] = (s
-0007c510: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0007c520: 7465 5f73 7461 7465 2920 7b0a 2020 2020  te_state) {.    
-0007c530: 2020 2020 2020 2020 2020 2020 2e74 6872              .thr
-0007c540: 6420 2020 3d20 302c 0a20 2020 2020 2020  d   = 0,.       
-0007c550: 2020 2020 2020 2020 202e 7061 7261 6d73           .params
-0007c560: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0007c570: 2020 2020 2020 2020 202e 7479 7065 2020           .type  
-0007c580: 3d20 4747 4d4c 5f54 4153 4b5f 434f 4d50  = GGML_TASK_COMP
-0007c590: 5554 452c 0a20 2020 2020 2020 2020 2020  UTE,.           
-0007c5a0: 2020 2020 2020 2020 202e 6974 6820 2020           .ith   
-0007c5b0: 3d20 6a20 2b20 312c 0a20 2020 2020 2020  = j + 1,.       
-0007c5c0: 2020 2020 2020 2020 2020 2020 202e 6e74               .nt
-0007c5d0: 6820 2020 3d20 6e5f 7468 7265 6164 732c  h   = n_threads,
-0007c5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c5f0: 2020 2020 202e 7773 697a 6520 3d20 6367       .wsize = cg
-0007c600: 7261 7068 2d3e 776f 726b 203f 2067 676d  raph->work ? ggm
-0007c610: 6c5f 6e62 7974 6573 2863 6772 6170 682d  l_nbytes(cgraph-
-0007c620: 3e77 6f72 6b29 203a 2030 2c0a 2020 2020  >work) : 0,.    
-0007c630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c640: 2e77 6461 7461 203d 2063 6772 6170 682d  .wdata = cgraph-
-0007c650: 3e77 6f72 6b20 3f20 6367 7261 7068 2d3e  >work ? cgraph->
-0007c660: 776f 726b 2d3e 6461 7461 203a 204e 554c  work->data : NUL
-0007c670: 4c2c 0a20 2020 2020 2020 2020 2020 2020  L,.             
-0007c680: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-0007c690: 2020 2020 2020 2e6e 6f64 6520 2020 3d20        .node   = 
-0007c6a0: 4e55 4c4c 2c0a 2020 2020 2020 2020 2020  NULL,.          
-0007c6b0: 2020 2020 2020 2e73 6861 7265 6420 3d20        .shared = 
-0007c6c0: 2673 7461 7465 5f73 6861 7265 642c 0a20  &state_shared,. 
-0007c6d0: 2020 2020 2020 2020 2020 207d 3b0a 0a20             };.. 
-0007c6e0: 2020 2020 2020 2020 2020 2069 6e74 2072             int r
-0007c6f0: 6320 3d20 6767 6d6c 5f74 6872 6561 645f  c = ggml_thread_
-0007c700: 6372 6561 7465 2826 776f 726b 6572 735b  create(&workers[
-0007c710: 6a5d 2e74 6872 642c 204e 554c 4c2c 2067  j].thrd, NULL, g
-0007c720: 676d 6c5f 6772 6170 685f 636f 6d70 7574  gml_graph_comput
-0007c730: 655f 7468 7265 6164 2c20 2677 6f72 6b65  e_thread, &worke
-0007c740: 7273 5b6a 5d29 3b0a 2020 2020 2020 2020  rs[j]);.        
-0007c750: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0007c760: 7263 203d 3d20 3029 3b0a 2020 2020 2020  rc == 0);.      
-0007c770: 2020 2020 2020 554e 5553 4544 2872 6329        UNUSED(rc)
-0007c780: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-0007c790: 7d0a 0a20 2020 202f 2f20 696e 6974 6961  }..    // initia
-0007c7a0: 6c69 7a65 2074 6173 6b73 202b 2077 6f72  lize tasks + wor
-0007c7b0: 6b20 6275 6666 6572 0a20 2020 207b 0a20  k buffer.    {. 
-0007c7c0: 2020 2020 2020 2073 697a 655f 7420 776f         size_t wo
-0007c7d0: 726b 5f73 697a 6520 3d20 303b 0a0a 2020  rk_size = 0;..  
-0007c7e0: 2020 2020 2020 2f2f 2074 6872 6561 6420        // thread 
-0007c7f0: 7363 6865 6475 6c69 6e67 2066 6f72 2074  scheduling for t
-0007c800: 6865 2064 6966 6665 7265 6e74 206f 7065  he different ope
-0007c810: 7261 7469 6f6e 730a 2020 2020 2020 2020  rations.        
-0007c820: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0007c830: 6920 3c20 6367 7261 7068 2d3e 6e5f 6e6f  i < cgraph->n_no
-0007c840: 6465 733b 2069 2b2b 2920 7b0a 2020 2020  des; i++) {.    
-0007c850: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0007c860: 676d 6c5f 7465 6e73 6f72 202a 206e 6f64  gml_tensor * nod
-0007c870: 6520 3d20 6367 7261 7068 2d3e 6e6f 6465  e = cgraph->node
-0007c880: 735b 695d 3b0a 0a20 2020 2020 2020 2020  s[i];..         
-0007c890: 2020 2073 7769 7463 6820 286e 6f64 652d     switch (node-
-0007c8a0: 3e6f 7029 207b 0a20 2020 2020 2020 2020  >op) {.         
-0007c8b0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0007c8c0: 5f4f 505f 4350 593a 0a20 2020 2020 2020  _OP_CPY:.       
-0007c8d0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-0007c8e0: 4d4c 5f4f 505f 4455 503a 0a20 2020 2020  ML_OP_DUP:.     
-0007c8f0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0007c900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c910: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
-0007c920: 5f74 6173 6b73 203d 206e 5f74 6872 6561  _tasks = n_threa
-0007c930: 6473 3b0a 0a20 2020 2020 2020 2020 2020  ds;..           
-0007c940: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-0007c950: 655f 7420 6375 7220 3d20 303b 0a20 2020  e_t cur = 0;.   
-0007c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c970: 2020 2020 2069 6620 2867 676d 6c5f 6973       if (ggml_is
-0007c980: 5f71 7561 6e74 697a 6564 286e 6f64 652d  _quantized(node-
-0007c990: 3e74 7970 6529 2920 7b0a 2020 2020 2020  >type)) {.      
-0007c9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c9b0: 2020 2020 2020 6375 7220 3d20 4747 4d4c        cur = GGML
-0007c9c0: 5f54 5950 455f 5349 5a45 5b47 474d 4c5f  _TYPE_SIZE[GGML_
-0007c9d0: 5459 5045 5f46 3332 5d20 2a20 6e6f 6465  TYPE_F32] * node
-0007c9e0: 2d3e 6e65 5b30 5d20 2a20 6e5f 7468 7265  ->ne[0] * n_thre
-0007c9f0: 6164 733b 0a20 2020 2020 2020 2020 2020  ads;.           
-0007ca00: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-0007ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ca20: 2020 2020 2020 2020 776f 726b 5f73 697a          work_siz
-0007ca30: 6520 3d20 4d41 5828 776f 726b 5f73 697a  e = MAX(work_siz
-0007ca40: 652c 2063 7572 293b 0a20 2020 2020 2020  e, cur);.       
-0007ca50: 2020 2020 2020 2020 2020 2020 207d 2062               } b
-0007ca60: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
-0007ca70: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0007ca80: 4f50 5f41 4444 3a0a 2020 2020 2020 2020  OP_ADD:.        
-0007ca90: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007caa0: 4c5f 4f50 5f41 4444 313a 0a20 2020 2020  L_OP_ADD1:.     
-0007cab0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0007cac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007cad0: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
-0007cae0: 5f74 6173 6b73 203d 206e 5f74 6872 6561  _tasks = n_threa
-0007caf0: 6473 3b0a 0a20 2020 2020 2020 2020 2020  ds;..           
-0007cb00: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-0007cb10: 655f 7420 6375 7220 3d20 303b 0a0a 2020  e_t cur = 0;..  
-0007cb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cb30: 2020 2020 2020 6966 2028 6767 6d6c 5f69        if (ggml_i
-0007cb40: 735f 7175 616e 7469 7a65 6428 6e6f 6465  s_quantized(node
-0007cb50: 2d3e 7372 6330 2d3e 7479 7065 2929 207b  ->src0->type)) {
-0007cb60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007cb70: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-0007cb80: 203d 2047 474d 4c5f 5459 5045 5f53 495a   = GGML_TYPE_SIZ
-0007cb90: 455b 4747 4d4c 5f54 5950 455f 4633 325d  E[GGML_TYPE_F32]
-0007cba0: 202a 206e 6f64 652d 3e73 7263 302d 3e6e   * node->src0->n
-0007cbb0: 655b 305d 202a 206e 5f74 6872 6561 6473  e[0] * n_threads
-0007cbc0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007cbd0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-0007cbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cbf0: 2020 2020 2077 6f72 6b5f 7369 7a65 203d       work_size =
-0007cc00: 204d 4158 2877 6f72 6b5f 7369 7a65 2c20   MAX(work_size, 
-0007cc10: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
-0007cc20: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0007cc30: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-0007cc40: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007cc50: 4143 433a 0a20 2020 2020 2020 2020 2020  ACC:.           
-0007cc60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0007cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cc80: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
-0007cc90: 203d 206e 5f74 6872 6561 6473 3b0a 0a20   = n_threads;.. 
-0007cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ccb0: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
-0007ccc0: 7220 3d20 303b 0a0a 2020 2020 2020 2020  r = 0;..        
-0007ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cce0: 6966 2028 6767 6d6c 5f69 735f 7175 616e  if (ggml_is_quan
-0007ccf0: 7469 7a65 6428 6e6f 6465 2d3e 7372 6330  tized(node->src0
-0007cd00: 2d3e 7479 7065 2929 207b 0a20 2020 2020  ->type)) {.     
-0007cd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cd20: 2020 2020 2020 2063 7572 203d 2047 474d         cur = GGM
-0007cd30: 4c5f 5459 5045 5f53 495a 455b 4747 4d4c  L_TYPE_SIZE[GGML
-0007cd40: 5f54 5950 455f 4633 325d 202a 206e 6f64  _TYPE_F32] * nod
-0007cd50: 652d 3e73 7263 312d 3e6e 655b 305d 202a  e->src1->ne[0] *
-0007cd60: 206e 5f74 6872 6561 6473 3b0a 2020 2020   n_threads;.    
-0007cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cd80: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-0007cd90: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0007cda0: 6f72 6b5f 7369 7a65 203d 204d 4158 2877  ork_size = MAX(w
-0007cdb0: 6f72 6b5f 7369 7a65 2c20 6375 7229 3b0a  ork_size, cur);.
-0007cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cdd0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0007cde0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-0007cdf0: 6520 4747 4d4c 5f4f 505f 5355 423a 0a20  e GGML_OP_SUB:. 
-0007ce00: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0007ce10: 6173 6520 4747 4d4c 5f4f 505f 4449 563a  ase GGML_OP_DIV:
-0007ce20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007ce30: 2063 6173 6520 4747 4d4c 5f4f 505f 5351   case GGML_OP_SQ
-0007ce40: 523a 0a20 2020 2020 2020 2020 2020 2020  R:.             
-0007ce50: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007ce60: 5351 5254 3a0a 2020 2020 2020 2020 2020  SQRT:.          
-0007ce70: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0007ce80: 4f50 5f4c 4f47 3a0a 2020 2020 2020 2020  OP_LOG:.        
-0007ce90: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007cea0: 4c5f 4f50 5f53 554d 3a0a 2020 2020 2020  L_OP_SUM:.      
-0007ceb0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-0007cec0: 474d 4c5f 4f50 5f53 554d 5f52 4f57 533a  GML_OP_SUM_ROWS:
-0007ced0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007cee0: 2063 6173 6520 4747 4d4c 5f4f 505f 4d45   case GGML_OP_ME
-0007cef0: 414e 3a0a 2020 2020 2020 2020 2020 2020  AN:.            
-0007cf00: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0007cf10: 5f52 4550 4541 543a 0a20 2020 2020 2020  _REPEAT:.       
-0007cf20: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-0007cf30: 4d4c 5f4f 505f 5245 5045 4154 5f42 4143  ML_OP_REPEAT_BAC
-0007cf40: 4b3a 0a20 2020 2020 2020 2020 2020 2020  K:.             
-0007cf50: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007cf60: 5245 5045 4154 323a 0a20 2020 2020 2020  REPEAT2:.       
-0007cf70: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-0007cf80: 4d4c 5f4f 505f 4142 533a 0a20 2020 2020  ML_OP_ABS:.     
-0007cf90: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-0007cfa0: 4747 4d4c 5f4f 505f 5347 4e3a 0a20 2020  GGML_OP_SGN:.   
-0007cfb0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-0007cfc0: 6520 4747 4d4c 5f4f 505f 4e45 473a 0a20  e GGML_OP_NEG:. 
-0007cfd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0007cfe0: 6173 6520 4747 4d4c 5f4f 505f 5354 4550  ase GGML_OP_STEP
-0007cff0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0007d000: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-0007d010: 454c 553a 0a20 2020 2020 2020 2020 2020  ELU:.           
-0007d020: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0007d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d040: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
-0007d050: 203d 2031 3b0a 2020 2020 2020 2020 2020   = 1;.          
-0007d060: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0007d070: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-0007d080: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007d090: 4d55 4c3a 0a20 2020 2020 2020 2020 2020  MUL:.           
+00079e30: 2020 2020 2020 2067 7261 645f 762c 0a20         grad_v,. 
+00079e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079e50: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+00079e60: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+00079e70: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00079e80: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00079e90: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00079ea0: 5f46 4c41 5348 5f46 463a 0a20 2020 2020  _FLASH_FF:.     
+00079eb0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00079ec0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00079ed0: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
+00079ee0: 6e6f 7420 7375 7070 6f72 7465 640a 2020  not supported.  
+00079ef0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00079f00: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00079f10: 4747 4d4c 5f4f 505f 464c 4153 485f 4154  GGML_OP_FLASH_AT
+00079f20: 544e 5f42 4143 4b3a 0a20 2020 2020 2020  TN_BACK:.       
+00079f30: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00079f40: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00079f50: 5254 2866 616c 7365 293b 202f 2f20 6e6f  RT(false); // no
+00079f60: 7420 7375 7070 6f72 7465 640a 2020 2020  t supported.    
+00079f70: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00079f80: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00079f90: 4d4c 5f4f 505f 4d41 505f 554e 4152 593a  ML_OP_MAP_UNARY:
+00079fa0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00079fb0: 4d4c 5f4f 505f 4d41 505f 4249 4e41 5259  ML_OP_MAP_BINARY
+00079fc0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00079fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079fe0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00079ff0: 6529 3b20 2f2f 206e 6f74 2073 7570 706f  e); // not suppo
+0007a000: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
+0007a010: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0007a020: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
+0007a030: 524f 5353 5f45 4e54 524f 5059 5f4c 4f53  ROSS_ENTROPY_LOS
+0007a040: 533a 0a20 2020 2020 2020 2020 2020 207b  S:.            {
+0007a050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007a060: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+0007a070: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007a080: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+0007a090: 6420 3d20 6767 6d6c 5f61 6464 5f69 6d70  d = ggml_add_imp
+0007a0a0: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+0007a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a0c0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+0007a0d0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0007a0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a0f0: 2020 2067 676d 6c5f 6372 6f73 735f 656e     ggml_cross_en
+0007a100: 7472 6f70 795f 6c6f 7373 5f62 6163 6b28  tropy_loss_back(
+0007a110: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0007a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a130: 2020 2020 2020 2020 2073 7263 302c 0a20           src0,. 
+0007a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a160: 2020 2073 7263 312c 0a20 2020 2020 2020     src1,.       
+0007a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a180: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+0007a190: 736f 722d 3e67 7261 6429 2c0a 2020 2020  sor->grad),.    
+0007a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a1b0: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+0007a1c0: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0007a1d0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007a1e0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0007a1f0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007a200: 505f 4352 4f53 535f 454e 5452 4f50 595f  P_CROSS_ENTROPY_
+0007a210: 4c4f 5353 5f42 4143 4b3a 0a20 2020 2020  LOSS_BACK:.     
+0007a220: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0007a230: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0007a240: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
+0007a250: 6e6f 7420 7375 7070 6f72 7465 640a 2020  not supported.  
+0007a260: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0007a270: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0007a280: 4747 4d4c 5f4f 505f 4e4f 4e45 3a0a 2020  GGML_OP_NONE:.  
+0007a290: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0007a2a0: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
+0007a2b0: 6f70 0a20 2020 2020 2020 2020 2020 207d  op.            }
+0007a2c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0007a2d0: 6361 7365 2047 474d 4c5f 4f50 5f43 4f55  case GGML_OP_COU
+0007a2e0: 4e54 3a0a 2020 2020 2020 2020 2020 2020  NT:.            
+0007a2f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007a300: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0007a310: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+0007a320: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
+0007a330: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+0007a340: 6767 6d6c 5f76 6973 6974 5f70 6172 656e  ggml_visit_paren
+0007a350: 7473 2873 7472 7563 7420 6767 6d6c 5f63  ts(struct ggml_c
+0007a360: 6772 6170 6820 2a20 6367 7261 7068 2c20  graph * cgraph, 
+0007a370: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0007a380: 6f72 202a 206e 6f64 6529 207b 0a20 2020  or * node) {.   
+0007a390: 2069 6620 286e 6f64 652d 3e67 7261 6420   if (node->grad 
+0007a3a0: 3d3d 204e 554c 4c29 207b 0a20 2020 2020  == NULL) {.     
+0007a3b0: 2020 202f 2f20 7468 6973 2075 7375 616c     // this usual
+0007a3c0: 6c79 2068 6170 7065 6e73 2077 6865 6e20  ly happens when 
+0007a3d0: 7765 2067 656e 6572 6174 6520 696e 7465  we generate inte
+0007a3e0: 726d 6564 6961 7465 206e 6f64 6573 2066  rmediate nodes f
+0007a3f0: 726f 6d20 636f 6e73 7461 6e74 7320 696e  rom constants in
+0007a400: 2074 6865 2062 6163 6b77 6172 6420 7061   the backward pa
+0007a410: 7373 0a20 2020 2020 2020 202f 2f20 6974  ss.        // it
+0007a420: 2063 616e 2061 6c73 6f20 6861 7070 656e   can also happen
+0007a430: 2064 7572 696e 6720 666f 7277 6172 6420   during forward 
+0007a440: 7061 7373 2c20 6966 2074 6865 2075 7365  pass, if the use
+0007a450: 7220 7065 7266 6f72 6d73 2063 6f6d 7075  r performs compu
+0007a460: 7461 7469 6f6e 7320 7769 7468 2063 6f6e  tations with con
+0007a470: 7374 616e 7473 0a20 2020 2020 2020 2069  stants.        i
+0007a480: 6620 286e 6f64 652d 3e6f 7020 213d 2047  f (node->op != G
+0007a490: 474d 4c5f 4f50 5f4e 4f4e 4529 207b 0a20  GML_OP_NONE) {. 
+0007a4a0: 2020 2020 2020 2020 2020 202f 2f47 474d             //GGM
+0007a4b0: 4c5f 5052 494e 545f 4445 4255 4728 2225  L_PRINT_DEBUG("%
+0007a4c0: 733a 2077 6172 6e69 6e67 3a20 6e6f 6465  s: warning: node
+0007a4d0: 2025 7020 6861 7320 6e6f 2067 7261 642c   %p has no grad,
+0007a4e0: 2062 7574 206f 7020 2564 5c6e 222c 205f   but op %d\n", _
+0007a4f0: 5f66 756e 635f 5f2c 2028 766f 6964 202a  _func__, (void *
+0007a500: 2920 6e6f 6465 2c20 6e6f 6465 2d3e 6f70  ) node, node->op
+0007a510: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
+0007a520: 207d 0a0a 2020 2020 2f2f 2063 6865 636b   }..    // check
+0007a530: 2069 6620 616c 7265 6164 7920 7669 7369   if already visi
+0007a540: 7465 640a 2020 2020 666f 7220 2869 6e74  ted.    for (int
+0007a550: 2069 203d 2030 3b20 6920 3c20 6367 7261   i = 0; i < cgra
+0007a560: 7068 2d3e 6e5f 6e6f 6465 733b 2069 2b2b  ph->n_nodes; i++
+0007a570: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
+0007a580: 6367 7261 7068 2d3e 6e6f 6465 735b 695d  cgraph->nodes[i]
+0007a590: 203d 3d20 6e6f 6465 2920 7b0a 2020 2020   == node) {.    
+0007a5a0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+0007a5b0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+0007a5c0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+0007a5d0: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
+0007a5e0: 3e6e 5f6c 6561 6673 3b20 692b 2b29 207b  >n_leafs; i++) {
+0007a5f0: 0a20 2020 2020 2020 2069 6620 2863 6772  .        if (cgr
+0007a600: 6170 682d 3e6c 6561 6673 5b69 5d20 3d3d  aph->leafs[i] ==
+0007a610: 206e 6f64 6529 207b 0a20 2020 2020 2020   node) {.       
+0007a620: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+0007a630: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
+0007a640: 2020 6966 2028 6e6f 6465 2d3e 7372 6330    if (node->src0
+0007a650: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
+0007a660: 5f76 6973 6974 5f70 6172 656e 7473 2863  _visit_parents(c
+0007a670: 6772 6170 682c 206e 6f64 652d 3e73 7263  graph, node->src
+0007a680: 3029 3b0a 2020 2020 7d0a 0a20 2020 2069  0);.    }..    i
+0007a690: 6620 286e 6f64 652d 3e73 7263 3129 207b  f (node->src1) {
+0007a6a0: 0a20 2020 2020 2020 2067 676d 6c5f 7669  .        ggml_vi
+0007a6b0: 7369 745f 7061 7265 6e74 7328 6367 7261  sit_parents(cgra
+0007a6c0: 7068 2c20 6e6f 6465 2d3e 7372 6331 293b  ph, node->src1);
+0007a6d0: 0a20 2020 207d 0a0a 2020 2020 666f 7220  .    }..    for 
+0007a6e0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+0007a6f0: 4747 4d4c 5f4d 4158 5f4f 5054 3b20 2b2b  GGML_MAX_OPT; ++
+0007a700: 6929 207b 0a20 2020 2020 2020 2069 6620  i) {.        if 
+0007a710: 286e 6f64 652d 3e6f 7074 5b69 5d29 207b  (node->opt[i]) {
+0007a720: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0007a730: 6c5f 7669 7369 745f 7061 7265 6e74 7328  l_visit_parents(
+0007a740: 6367 7261 7068 2c20 6e6f 6465 2d3e 6f70  cgraph, node->op
+0007a750: 745b 695d 293b 0a20 2020 2020 2020 207d  t[i]);.        }
+0007a760: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
+0007a770: 6e6f 6465 2d3e 6f70 203d 3d20 4747 4d4c  node->op == GGML
+0007a780: 5f4f 505f 4e4f 4e45 2026 2620 6e6f 6465  _OP_NONE && node
+0007a790: 2d3e 6772 6164 203d 3d20 4e55 4c4c 2920  ->grad == NULL) 
+0007a7a0: 7b0a 2020 2020 2020 2020 2f2f 2072 6561  {.        // rea
+0007a7b0: 6368 6564 2061 206c 6561 6620 6e6f 6465  ched a leaf node
+0007a7c0: 2c20 6e6f 7420 7061 7274 206f 6620 7468  , not part of th
+0007a7d0: 6520 6772 6164 6965 6e74 2067 7261 7068  e gradient graph
+0007a7e0: 2028 652e 672e 2061 2063 6f6e 7374 616e   (e.g. a constan
+0007a7f0: 7429 0a20 2020 2020 2020 2047 474d 4c5f  t).        GGML_
+0007a800: 4153 5345 5254 2863 6772 6170 682d 3e6e  ASSERT(cgraph->n
+0007a810: 5f6c 6561 6673 203c 2047 474d 4c5f 4d41  _leafs < GGML_MA
+0007a820: 585f 4e4f 4445 5329 3b0a 0a20 2020 2020  X_NODES);..     
+0007a830: 2020 2069 6620 2873 7472 6c65 6e28 6e6f     if (strlen(no
+0007a840: 6465 2d3e 6e61 6d65 2920 3d3d 2030 2920  de->name) == 0) 
+0007a850: 7b0a 2020 2020 2020 2020 2020 2020 736e  {.            sn
+0007a860: 7072 696e 7466 286e 6f64 652d 3e6e 616d  printf(node->nam
+0007a870: 652c 2073 697a 656f 6628 6e6f 6465 2d3e  e, sizeof(node->
+0007a880: 6e61 6d65 292c 2022 6c65 6166 5f25 6422  name), "leaf_%d"
+0007a890: 2c20 6367 7261 7068 2d3e 6e5f 6c65 6166  , cgraph->n_leaf
+0007a8a0: 7329 3b0a 2020 2020 2020 2020 7d0a 0a20  s);.        }.. 
+0007a8b0: 2020 2020 2020 2063 6772 6170 682d 3e6c         cgraph->l
+0007a8c0: 6561 6673 5b63 6772 6170 682d 3e6e 5f6c  eafs[cgraph->n_l
+0007a8d0: 6561 6673 5d20 3d20 6e6f 6465 3b0a 2020  eafs] = node;.  
+0007a8e0: 2020 2020 2020 6367 7261 7068 2d3e 6e5f        cgraph->n_
+0007a8f0: 6c65 6166 732b 2b3b 0a20 2020 207d 2065  leafs++;.    } e
+0007a900: 6c73 6520 7b0a 2020 2020 2020 2020 4747  lse {.        GG
+0007a910: 4d4c 5f41 5353 4552 5428 6367 7261 7068  ML_ASSERT(cgraph
+0007a920: 2d3e 6e5f 6e6f 6465 7320 3c20 4747 4d4c  ->n_nodes < GGML
+0007a930: 5f4d 4158 5f4e 4f44 4553 293b 0a0a 2020  _MAX_NODES);..  
+0007a940: 2020 2020 2020 6966 2028 7374 726c 656e        if (strlen
+0007a950: 286e 6f64 652d 3e6e 616d 6529 203d 3d20  (node->name) == 
+0007a960: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+0007a970: 2073 6e70 7269 6e74 6628 6e6f 6465 2d3e   snprintf(node->
+0007a980: 6e61 6d65 2c20 7369 7a65 6f66 286e 6f64  name, sizeof(nod
+0007a990: 652d 3e6e 616d 6529 2c20 226e 6f64 655f  e->name), "node_
+0007a9a0: 2564 222c 2063 6772 6170 682d 3e6e 5f6e  %d", cgraph->n_n
+0007a9b0: 6f64 6573 293b 0a20 2020 2020 2020 207d  odes);.        }
+0007a9c0: 0a0a 2020 2020 2020 2020 6367 7261 7068  ..        cgraph
+0007a9d0: 2d3e 6e6f 6465 735b 6367 7261 7068 2d3e  ->nodes[cgraph->
+0007a9e0: 6e5f 6e6f 6465 735d 203d 206e 6f64 653b  n_nodes] = node;
+0007a9f0: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
+0007aa00: 3e67 7261 6473 5b63 6772 6170 682d 3e6e  >grads[cgraph->n
+0007aa10: 5f6e 6f64 6573 5d20 3d20 6e6f 6465 2d3e  _nodes] = node->
+0007aa20: 6772 6164 3b0a 2020 2020 2020 2020 6367  grad;.        cg
+0007aa30: 7261 7068 2d3e 6e5f 6e6f 6465 732b 2b3b  raph->n_nodes++;
+0007aa40: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+0007aa50: 2076 6f69 6420 6767 6d6c 5f62 7569 6c64   void ggml_build
+0007aa60: 5f66 6f72 7761 7264 5f69 6d70 6c28 7374  _forward_impl(st
+0007aa70: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
+0007aa80: 202a 2063 6772 6170 682c 2073 7472 7563   * cgraph, struc
+0007aa90: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0007aaa0: 7465 6e73 6f72 2c20 626f 6f6c 2065 7870  tensor, bool exp
+0007aab0: 616e 6429 207b 0a20 2020 2069 6620 2821  and) {.    if (!
+0007aac0: 6578 7061 6e64 2920 7b0a 2020 2020 2020  expand) {.      
+0007aad0: 2020 6367 7261 7068 2d3e 6e5f 6e6f 6465    cgraph->n_node
+0007aae0: 7320 3d20 303b 0a20 2020 2020 2020 2063  s = 0;.        c
+0007aaf0: 6772 6170 682d 3e6e 5f6c 6561 6673 203d  graph->n_leafs =
+0007ab00: 2030 3b0a 2020 2020 7d0a 0a20 2020 2063   0;.    }..    c
+0007ab10: 6f6e 7374 2069 6e74 206e 3020 3d20 6367  onst int n0 = cg
+0007ab20: 7261 7068 2d3e 6e5f 6e6f 6465 733b 0a20  raph->n_nodes;. 
+0007ab30: 2020 2055 4e55 5345 4428 6e30 293b 0a0a     UNUSED(n0);..
+0007ab40: 2020 2020 6767 6d6c 5f76 6973 6974 5f70      ggml_visit_p
+0007ab50: 6172 656e 7473 2863 6772 6170 682c 2074  arents(cgraph, t
+0007ab60: 656e 736f 7229 3b0a 0a20 2020 2063 6f6e  ensor);..    con
+0007ab70: 7374 2069 6e74 206e 5f6e 6577 203d 2063  st int n_new = c
+0007ab80: 6772 6170 682d 3e6e 5f6e 6f64 6573 202d  graph->n_nodes -
+0007ab90: 206e 303b 0a20 2020 2047 474d 4c5f 5052   n0;.    GGML_PR
+0007aba0: 494e 545f 4445 4255 4728 2225 733a 2076  INT_DEBUG("%s: v
+0007abb0: 6973 6974 6564 2025 6420 6e65 7720 6e6f  isited %d new no
+0007abc0: 6465 735c 6e22 2c20 5f5f 6675 6e63 5f5f  des\n", __func__
+0007abd0: 2c20 6e5f 6e65 7729 3b0a 0a20 2020 2069  , n_new);..    i
+0007abe0: 6620 286e 5f6e 6577 203e 2030 2920 7b0a  f (n_new > 0) {.
+0007abf0: 2020 2020 2020 2020 2f2f 2074 6865 206c          // the l
+0007ac00: 6173 7420 6164 6465 6420 6e6f 6465 2073  ast added node s
+0007ac10: 686f 756c 6420 616c 7761 7973 2062 6520  hould always be 
+0007ac20: 7374 6172 7469 6e67 2070 6f69 6e74 0a20  starting point. 
+0007ac30: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+0007ac40: 5254 2863 6772 6170 682d 3e6e 6f64 6573  RT(cgraph->nodes
+0007ac50: 5b63 6772 6170 682d 3e6e 5f6e 6f64 6573  [cgraph->n_nodes
+0007ac60: 202d 2031 5d20 3d3d 2074 656e 736f 7229   - 1] == tensor)
+0007ac70: 3b0a 2020 2020 7d0a 7d0a 0a76 6f69 6420  ;.    }.}..void 
+0007ac80: 6767 6d6c 5f62 7569 6c64 5f66 6f72 7761  ggml_build_forwa
+0007ac90: 7264 5f65 7870 616e 6428 7374 7275 6374  rd_expand(struct
+0007aca0: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
+0007acb0: 6772 6170 682c 2073 7472 7563 7420 6767  graph, struct gg
+0007acc0: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+0007acd0: 6f72 2920 7b0a 2020 2020 6767 6d6c 5f62  or) {.    ggml_b
+0007ace0: 7569 6c64 5f66 6f72 7761 7264 5f69 6d70  uild_forward_imp
+0007acf0: 6c28 6367 7261 7068 2c20 7465 6e73 6f72  l(cgraph, tensor
+0007ad00: 2c20 7472 7565 293b 0a7d 0a0a 7374 7275  , true);.}..stru
+0007ad10: 6374 2067 676d 6c5f 6367 7261 7068 2067  ct ggml_cgraph g
+0007ad20: 676d 6c5f 6275 696c 645f 666f 7277 6172  gml_build_forwar
+0007ad30: 6428 7374 7275 6374 2067 676d 6c5f 7465  d(struct ggml_te
+0007ad40: 6e73 6f72 202a 2074 656e 736f 7229 207b  nsor * tensor) {
+0007ad50: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+0007ad60: 5f63 6772 6170 6820 7265 7375 6c74 203d  _cgraph result =
+0007ad70: 207b 0a20 2020 2020 2020 202f 2a2e 6e5f   {.        /*.n_
+0007ad80: 6e6f 6465 7320 2020 2020 203d 2a2f 2030  nodes      =*/ 0
+0007ad90: 2c0a 2020 2020 2020 2020 2f2a 2e6e 5f6c  ,.        /*.n_l
+0007ada0: 6561 6673 2020 2020 2020 3d2a 2f20 302c  eafs      =*/ 0,
+0007adb0: 0a20 2020 2020 2020 202f 2a2e 6e5f 7468  .        /*.n_th
+0007adc0: 7265 6164 7320 2020 203d 2a2f 2047 474d  reads    =*/ GGM
+0007add0: 4c5f 4445 4641 554c 545f 4e5f 5448 5245  L_DEFAULT_N_THRE
+0007ade0: 4144 532c 0a20 2020 2020 2020 202f 2a2e  ADS,.        /*.
+0007adf0: 776f 726b 5f73 697a 6520 2020 203d 2a2f  work_size    =*/
+0007ae00: 2030 2c0a 2020 2020 2020 2020 2f2a 2e77   0,.        /*.w
+0007ae10: 6f72 6b20 2020 2020 2020 2020 3d2a 2f20  ork         =*/ 
+0007ae20: 4e55 4c4c 2c0a 2020 2020 2020 2020 2f2a  NULL,.        /*
+0007ae30: 2e6e 6f64 6573 2020 2020 2020 2020 3d2a  .nodes        =*
+0007ae40: 2f20 7b20 4e55 4c4c 207d 2c0a 2020 2020  / { NULL },.    
+0007ae50: 2020 2020 2f2a 2e67 7261 6473 2020 2020      /*.grads    
+0007ae60: 2020 2020 3d2a 2f20 7b20 4e55 4c4c 207d      =*/ { NULL }
+0007ae70: 2c0a 2020 2020 2020 2020 2f2a 2e6c 6561  ,.        /*.lea
+0007ae80: 6673 2020 2020 2020 2020 3d2a 2f20 7b20  fs        =*/ { 
+0007ae90: 4e55 4c4c 207d 2c0a 2020 2020 2020 2020  NULL },.        
+0007aea0: 2f2a 2e70 6572 665f 7275 6e73 2020 2020  /*.perf_runs    
+0007aeb0: 3d2a 2f20 302c 0a20 2020 2020 2020 202f  =*/ 0,.        /
+0007aec0: 2a2e 7065 7266 5f63 7963 6c65 7320 203d  *.perf_cycles  =
+0007aed0: 2a2f 2030 2c0a 2020 2020 2020 2020 2f2a  */ 0,.        /*
+0007aee0: 2e70 6572 665f 7469 6d65 5f75 7320 3d2a  .perf_time_us =*
+0007aef0: 2f20 302c 0a20 2020 207d 3b0a 0a20 2020  / 0,.    };..   
+0007af00: 2067 676d 6c5f 6275 696c 645f 666f 7277   ggml_build_forw
+0007af10: 6172 645f 696d 706c 2826 7265 7375 6c74  ard_impl(&result
+0007af20: 2c20 7465 6e73 6f72 2c20 6661 6c73 6529  , tensor, false)
+0007af30: 3b0a 0a20 2020 2072 6574 7572 6e20 7265  ;..    return re
+0007af40: 7375 6c74 3b0a 7d0a 0a73 7472 7563 7420  sult;.}..struct 
+0007af50: 6767 6d6c 5f63 6772 6170 6820 6767 6d6c  ggml_cgraph ggml
+0007af60: 5f62 7569 6c64 5f62 6163 6b77 6172 6428  _build_backward(
+0007af70: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+0007af80: 6578 7420 2a20 6374 782c 2073 7472 7563  ext * ctx, struc
+0007af90: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+0007afa0: 6766 2c20 626f 6f6c 206b 6565 7029 207b  gf, bool keep) {
+0007afb0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+0007afc0: 5f63 6772 6170 6820 7265 7375 6c74 203d  _cgraph result =
+0007afd0: 202a 6766 3b0a 0a20 2020 2047 474d 4c5f   *gf;..    GGML_
+0007afe0: 4153 5345 5254 2867 662d 3e6e 5f6e 6f64  ASSERT(gf->n_nod
+0007aff0: 6573 203e 2030 293b 0a0a 2020 2020 2f2f  es > 0);..    //
+0007b000: 2069 6620 7765 2061 7265 206b 6565 7069   if we are keepi
+0007b010: 6e67 2074 6865 2067 7261 6469 656e 7420  ng the gradient 
+0007b020: 6772 6170 682c 2077 6520 6861 7665 2074  graph, we have t
+0007b030: 6f20 6465 7461 6368 2074 6865 2067 7261  o detach the gra
+0007b040: 6469 656e 7420 6e6f 6465 7320 6672 6f6d  dient nodes from
+0007b050: 2074 6865 206f 7269 6769 6e61 6c20 6772   the original gr
+0007b060: 6170 680a 2020 2020 6966 2028 6b65 6570  aph.    if (keep
+0007b070: 2920 7b0a 2020 2020 2020 2020 666f 7220  ) {.        for 
+0007b080: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+0007b090: 6766 2d3e 6e5f 6e6f 6465 733b 2069 2b2b  gf->n_nodes; i++
+0007b0a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007b0b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0007b0c0: 6f72 202a 206e 6f64 6520 3d20 6766 2d3e  or * node = gf->
+0007b0d0: 6e6f 6465 735b 695d 3b0a 0a20 2020 2020  nodes[i];..     
+0007b0e0: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
+0007b0f0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+0007b100: 2020 2020 2020 2020 206e 6f64 652d 3e67           node->g
+0007b110: 7261 6420 3d20 6767 6d6c 5f64 7570 5f74  rad = ggml_dup_t
+0007b120: 656e 736f 7228 6374 782c 206e 6f64 6529  ensor(ctx, node)
+0007b130: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007b140: 2020 6766 2d3e 6772 6164 735b 695d 203d    gf->grads[i] =
+0007b150: 206e 6f64 652d 3e67 7261 643b 0a20 2020   node->grad;.   
+0007b160: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0007b170: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
+0007b180: 666f 7220 2869 6e74 2069 203d 2067 662d  for (int i = gf-
+0007b190: 3e6e 5f6e 6f64 6573 202d 2031 3b20 6920  >n_nodes - 1; i 
+0007b1a0: 3e3d 2030 3b20 692d 2d29 207b 0a20 2020  >= 0; i--) {.   
+0007b1b0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0007b1c0: 5f74 656e 736f 7220 2a20 6e6f 6465 203d  _tensor * node =
+0007b1d0: 2067 662d 3e6e 6f64 6573 5b69 5d3b 0a0a   gf->nodes[i];..
+0007b1e0: 2020 2020 2020 2020 2f2f 2062 6563 6175          // becau
+0007b1f0: 7365 2077 6520 6465 7461 6368 6564 2074  se we detached t
+0007b200: 6865 2067 7261 6420 6e6f 6465 7320 6672  he grad nodes fr
+0007b210: 6f6d 2074 6865 206f 7269 6769 6e61 6c20  om the original 
+0007b220: 6772 6170 682c 2077 6520 6361 6e20 6166  graph, we can af
+0007b230: 666f 7264 2069 6e70 6c61 6365 206f 7065  ford inplace ope
+0007b240: 7261 7469 6f6e 730a 2020 2020 2020 2020  rations.        
+0007b250: 6966 2028 6e6f 6465 2d3e 6772 6164 2920  if (node->grad) 
+0007b260: 7b0a 2020 2020 2020 2020 2020 2020 6767  {.            gg
+0007b270: 6d6c 5f63 6f6d 7075 7465 5f62 6163 6b77  ml_compute_backw
+0007b280: 6172 6428 6374 782c 206e 6f64 652c 206b  ard(ctx, node, k
+0007b290: 6565 7029 3b0a 2020 2020 2020 2020 7d0a  eep);.        }.
+0007b2a0: 2020 2020 7d0a 0a20 2020 2066 6f72 2028      }..    for (
+0007b2b0: 696e 7420 6920 3d20 6766 2d3e 6e5f 6e6f  int i = gf->n_no
+0007b2c0: 6465 7320 2d20 313b 2069 203e 3d20 303b  des - 1; i >= 0;
+0007b2d0: 2069 2d2d 2920 7b0a 2020 2020 2020 2020   i--) {.        
+0007b2e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0007b2f0: 6f72 202a 206e 6f64 6520 3d20 6766 2d3e  or * node = gf->
+0007b300: 6e6f 6465 735b 695d 3b0a 0a20 2020 2020  nodes[i];..     
+0007b310: 2020 2069 6620 286e 6f64 652d 3e69 735f     if (node->is_
+0007b320: 7061 7261 6d29 207b 0a20 2020 2020 2020  param) {.       
+0007b330: 2020 2020 2047 474d 4c5f 5052 494e 545f       GGML_PRINT_
+0007b340: 4445 4255 4728 2225 733a 2066 6f75 6e64  DEBUG("%s: found
+0007b350: 2072 6f6f 7420 6e6f 6465 2025 705c 6e22   root node %p\n"
+0007b360: 2c20 5f5f 6675 6e63 5f5f 2c20 2876 6f69  , __func__, (voi
+0007b370: 6420 2a29 206e 6f64 6529 3b0a 2020 2020  d *) node);.    
+0007b380: 2020 2020 2020 2020 6767 6d6c 5f62 7569          ggml_bui
+0007b390: 6c64 5f66 6f72 7761 7264 5f69 6d70 6c28  ld_forward_impl(
+0007b3a0: 2672 6573 756c 742c 206e 6f64 652d 3e67  &result, node->g
+0007b3b0: 7261 642c 2074 7275 6529 3b0a 2020 2020  rad, true);.    
+0007b3c0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+0007b3d0: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+0007b3e0: 7d0a 0a2f 2f0a 2f2f 2074 6872 6561 6420  }..//.// thread 
+0007b3f0: 6461 7461 0a2f 2f0a 2f2f 2073 796e 6368  data.//.// synch
+0007b400: 726f 6e69 7a61 7469 6f6e 2069 7320 646f  ronization is do
+0007b410: 6e65 2076 6961 2062 7573 7920 6c6f 6f70  ne via busy loop
+0007b420: 730a 2f2f 2049 2074 7269 6564 2075 7369  s.// I tried usi
+0007b430: 6e67 2073 7069 6e20 6c6f 636b 732c 2062  ng spin locks, b
+0007b440: 7574 206e 6f74 2073 7572 6520 686f 7720  ut not sure how 
+0007b450: 746f 2075 7365 2074 6865 6d20 636f 7272  to use them corr
+0007b460: 6563 746c 7920 2d20 7468 6520 7468 696e  ectly - the thin
+0007b470: 6773 2049 2074 7269 6564 2077 6572 6520  gs I tried were 
+0007b480: 736c 6f77 6572 2074 6861 6e20 6275 7379  slower than busy
+0007b490: 206c 6f6f 7073 0a2f 2f0a 0a23 6966 6465   loops.//..#ifde
+0007b4a0: 6620 5f5f 4150 504c 455f 5f0a 0a2f 2f23  f __APPLE__..//#
+0007b4b0: 696e 636c 7564 6520 3c6f 732f 6c6f 636b  include <os/lock
+0007b4c0: 2e68 3e0a 2f2f 0a2f 2f74 7970 6564 6566  .h>.//.//typedef
+0007b4d0: 206f 735f 756e 6661 6972 5f6c 6f63 6b20   os_unfair_lock 
+0007b4e0: 6767 6d6c 5f6c 6f63 6b5f 743b 0a2f 2f0a  ggml_lock_t;.//.
+0007b4f0: 2f2f 2364 6566 696e 6520 6767 6d6c 5f6c  //#define ggml_l
+0007b500: 6f63 6b5f 696e 6974 2878 2920 2020 2055  ock_init(x)    U
+0007b510: 4e55 5345 4428 7829 0a2f 2f23 6465 6669  NUSED(x).//#defi
+0007b520: 6e65 2067 676d 6c5f 6c6f 636b 5f64 6573  ne ggml_lock_des
+0007b530: 7472 6f79 2878 2920 554e 5553 4544 2878  troy(x) UNUSED(x
+0007b540: 290a 2f2f 2364 6566 696e 6520 6767 6d6c  ).//#define ggml
+0007b550: 5f6c 6f63 6b5f 6c6f 636b 2020 2020 2020  _lock_lock      
+0007b560: 206f 735f 756e 6661 6972 5f6c 6f63 6b5f   os_unfair_lock_
+0007b570: 6c6f 636b 0a2f 2f23 6465 6669 6e65 2067  lock.//#define g
+0007b580: 676d 6c5f 6c6f 636b 5f75 6e6c 6f63 6b20  gml_lock_unlock 
+0007b590: 2020 2020 6f73 5f75 6e66 6169 725f 6c6f      os_unfair_lo
+0007b5a0: 636b 5f75 6e6c 6f63 6b0a 2f2f 0a2f 2f23  ck_unlock.//.//#
+0007b5b0: 6465 6669 6e65 2047 474d 4c5f 4c4f 434b  define GGML_LOCK
+0007b5c0: 5f49 4e49 5449 414c 495a 4552 204f 535f  _INITIALIZER OS_
+0007b5d0: 554e 4641 4952 5f4c 4f43 4b5f 494e 4954  UNFAIR_LOCK_INIT
+0007b5e0: 0a0a 7479 7065 6465 6620 696e 7420 6767  ..typedef int gg
+0007b5f0: 6d6c 5f6c 6f63 6b5f 743b 0a0a 2364 6566  ml_lock_t;..#def
+0007b600: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 696e  ine ggml_lock_in
+0007b610: 6974 2878 2920 2020 2055 4e55 5345 4428  it(x)    UNUSED(
+0007b620: 7829 0a23 6465 6669 6e65 2067 676d 6c5f  x).#define ggml_
+0007b630: 6c6f 636b 5f64 6573 7472 6f79 2878 2920  lock_destroy(x) 
+0007b640: 554e 5553 4544 2878 290a 2364 6566 696e  UNUSED(x).#defin
+0007b650: 6520 6767 6d6c 5f6c 6f63 6b5f 6c6f 636b  e ggml_lock_lock
+0007b660: 2878 2920 2020 2055 4e55 5345 4428 7829  (x)    UNUSED(x)
+0007b670: 0a23 6465 6669 6e65 2067 676d 6c5f 6c6f  .#define ggml_lo
+0007b680: 636b 5f75 6e6c 6f63 6b28 7829 2020 554e  ck_unlock(x)  UN
+0007b690: 5553 4544 2878 290a 0a23 6465 6669 6e65  USED(x)..#define
+0007b6a0: 2047 474d 4c5f 4c4f 434b 5f49 4e49 5449   GGML_LOCK_INITI
+0007b6b0: 414c 495a 4552 2030 0a0a 7479 7065 6465  ALIZER 0..typede
+0007b6c0: 6620 7074 6872 6561 645f 7420 6767 6d6c  f pthread_t ggml
+0007b6d0: 5f74 6872 6561 645f 743b 0a0a 2364 6566  _thread_t;..#def
+0007b6e0: 696e 6520 6767 6d6c 5f74 6872 6561 645f  ine ggml_thread_
+0007b6f0: 6372 6561 7465 2070 7468 7265 6164 5f63  create pthread_c
+0007b700: 7265 6174 650a 2364 6566 696e 6520 6767  reate.#define gg
+0007b710: 6d6c 5f74 6872 6561 645f 6a6f 696e 2020  ml_thread_join  
+0007b720: 2070 7468 7265 6164 5f6a 6f69 6e0a 0a23   pthread_join..#
+0007b730: 656c 7365 0a0a 2f2f 7479 7065 6465 6620  else..//typedef 
+0007b740: 7074 6872 6561 645f 7370 696e 6c6f 636b  pthread_spinlock
+0007b750: 5f74 2067 676d 6c5f 6c6f 636b 5f74 3b0a  _t ggml_lock_t;.
+0007b760: 0a2f 2f23 6465 6669 6e65 2067 676d 6c5f  .//#define ggml_
+0007b770: 6c6f 636b 5f69 6e69 7428 7829 2070 7468  lock_init(x) pth
+0007b780: 7265 6164 5f73 7069 6e5f 696e 6974 2878  read_spin_init(x
+0007b790: 2c20 5054 4852 4541 445f 5052 4f43 4553  , PTHREAD_PROCES
+0007b7a0: 535f 5052 4956 4154 4529 0a2f 2f23 6465  S_PRIVATE).//#de
+0007b7b0: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f64  fine ggml_lock_d
+0007b7c0: 6573 7472 6f79 2070 7468 7265 6164 5f73  estroy pthread_s
+0007b7d0: 7069 6e5f 6465 7374 726f 790a 2f2f 2364  pin_destroy.//#d
+0007b7e0: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
+0007b7f0: 6c6f 636b 2020 2020 7074 6872 6561 645f  lock    pthread_
+0007b800: 7370 696e 5f6c 6f63 6b0a 2f2f 2364 6566  spin_lock.//#def
+0007b810: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 756e  ine ggml_lock_un
+0007b820: 6c6f 636b 2020 7074 6872 6561 645f 7370  lock  pthread_sp
+0007b830: 696e 5f75 6e6c 6f63 6b0a 0a74 7970 6564  in_unlock..typed
+0007b840: 6566 2069 6e74 2067 676d 6c5f 6c6f 636b  ef int ggml_lock
+0007b850: 5f74 3b0a 0a23 6465 6669 6e65 2067 676d  _t;..#define ggm
+0007b860: 6c5f 6c6f 636b 5f69 6e69 7428 7829 2020  l_lock_init(x)  
+0007b870: 2020 554e 5553 4544 2878 290a 2364 6566    UNUSED(x).#def
+0007b880: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 6465  ine ggml_lock_de
+0007b890: 7374 726f 7928 7829 2055 4e55 5345 4428  stroy(x) UNUSED(
+0007b8a0: 7829 0a23 6966 2064 6566 696e 6564 285f  x).#if defined(_
+0007b8b0: 5f78 3836 5f36 345f 5f29 207c 7c20 2864  _x86_64__) || (d
+0007b8c0: 6566 696e 6564 285f 4d53 435f 5645 5229  efined(_MSC_VER)
+0007b8d0: 2026 2620 6465 6669 6e65 6428 5f4d 5f41   && defined(_M_A
+0007b8e0: 4d44 3634 2929 0a23 6465 6669 6e65 2067  MD64)).#define g
+0007b8f0: 676d 6c5f 6c6f 636b 5f6c 6f63 6b28 7829  gml_lock_lock(x)
+0007b900: 2020 2020 5f6d 6d5f 7061 7573 6528 290a      _mm_pause().
+0007b910: 2365 6c73 650a 2364 6566 696e 6520 6767  #else.#define gg
+0007b920: 6d6c 5f6c 6f63 6b5f 6c6f 636b 2878 2920  ml_lock_lock(x) 
+0007b930: 2020 2055 4e55 5345 4428 7829 0a23 656e     UNUSED(x).#en
+0007b940: 6469 660a 2364 6566 696e 6520 6767 6d6c  dif.#define ggml
+0007b950: 5f6c 6f63 6b5f 756e 6c6f 636b 2878 2920  _lock_unlock(x) 
+0007b960: 2055 4e55 5345 4428 7829 0a0a 2364 6566   UNUSED(x)..#def
+0007b970: 696e 6520 4747 4d4c 5f4c 4f43 4b5f 494e  ine GGML_LOCK_IN
+0007b980: 4954 4941 4c49 5a45 5220 300a 0a74 7970  ITIALIZER 0..typ
+0007b990: 6564 6566 2070 7468 7265 6164 5f74 2067  edef pthread_t g
+0007b9a0: 676d 6c5f 7468 7265 6164 5f74 3b0a 0a23  gml_thread_t;..#
+0007b9b0: 6465 6669 6e65 2067 676d 6c5f 7468 7265  define ggml_thre
+0007b9c0: 6164 5f63 7265 6174 6520 7074 6872 6561  ad_create pthrea
+0007b9d0: 645f 6372 6561 7465 0a23 6465 6669 6e65  d_create.#define
+0007b9e0: 2067 676d 6c5f 7468 7265 6164 5f6a 6f69   ggml_thread_joi
+0007b9f0: 6e20 2020 7074 6872 6561 645f 6a6f 696e  n   pthread_join
+0007ba00: 0a0a 2365 6e64 6966 0a0a 7374 7275 6374  ..#endif..struct
+0007ba10: 2067 676d 6c5f 636f 6d70 7574 655f 7374   ggml_compute_st
+0007ba20: 6174 655f 7368 6172 6564 207b 0a20 2020  ate_shared {.   
+0007ba30: 2067 676d 6c5f 6c6f 636b 5f74 2073 7069   ggml_lock_t spi
+0007ba40: 6e3b 0a0a 2020 2020 696e 7420 6e5f 7468  n;..    int n_th
+0007ba50: 7265 6164 733b 0a0a 2020 2020 2f2f 2073  reads;..    // s
+0007ba60: 796e 6368 726f 6e69 7a61 7469 6f6e 2070  ynchronization p
+0007ba70: 7269 6d69 7469 7665 730a 2020 2020 6174  rimitives.    at
+0007ba80: 6f6d 6963 5f69 6e74 2020 6e5f 7265 6164  omic_int  n_read
+0007ba90: 793b 0a20 2020 2061 746f 6d69 635f 626f  y;.    atomic_bo
+0007baa0: 6f6c 2068 6173 5f77 6f72 6b3b 0a20 2020  ol has_work;.   
+0007bab0: 2061 746f 6d69 635f 626f 6f6c 2073 746f   atomic_bool sto
+0007bac0: 703b 202f 2f20 7374 6f70 2061 6c6c 2074  p; // stop all t
+0007bad0: 6872 6561 6473 0a7d 3b0a 0a73 7472 7563  hreads.};..struc
+0007bae0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f73  t ggml_compute_s
+0007baf0: 7461 7465 207b 0a20 2020 2067 676d 6c5f  tate {.    ggml_
+0007bb00: 7468 7265 6164 5f74 2074 6872 643b 0a0a  thread_t thrd;..
+0007bb10: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0007bb20: 636f 6d70 7574 655f 7061 7261 6d73 2070  compute_params p
+0007bb30: 6172 616d 733b 0a20 2020 2073 7472 7563  arams;.    struc
+0007bb40: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0007bb50: 6e6f 6465 3b0a 0a20 2020 2073 7472 7563  node;..    struc
+0007bb60: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f73  t ggml_compute_s
+0007bb70: 7461 7465 5f73 6861 7265 6420 2a20 7368  tate_shared * sh
+0007bb80: 6172 6564 3b0a 7d3b 0a0a 7374 6174 6963  ared;.};..static
+0007bb90: 2074 6872 6561 645f 7265 745f 7420 6767   thread_ret_t gg
+0007bba0: 6d6c 5f67 7261 7068 5f63 6f6d 7075 7465  ml_graph_compute
+0007bbb0: 5f74 6872 6561 6428 766f 6964 202a 2064  _thread(void * d
+0007bbc0: 6174 6129 207b 0a20 2020 2073 7472 7563  ata) {.    struc
+0007bbd0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f73  t ggml_compute_s
+0007bbe0: 7461 7465 202a 2073 7461 7465 203d 2028  tate * state = (
+0007bbf0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0007bc00: 7574 655f 7374 6174 6520 2a29 2064 6174  ute_state *) dat
+0007bc10: 613b 0a0a 2020 2020 636f 6e73 7420 696e  a;..    const in
+0007bc20: 7420 6e5f 7468 7265 6164 7320 3d20 7374  t n_threads = st
+0007bc30: 6174 652d 3e73 6861 7265 642d 3e6e 5f74  ate->shared->n_t
+0007bc40: 6872 6561 6473 3b0a 0a20 2020 2077 6869  hreads;..    whi
+0007bc50: 6c65 2028 7472 7565 2920 7b0a 2020 2020  le (true) {.    
+0007bc60: 2020 2020 6966 2028 6174 6f6d 6963 5f66      if (atomic_f
+0007bc70: 6574 6368 5f61 6464 2826 7374 6174 652d  etch_add(&state-
+0007bc80: 3e73 6861 7265 642d 3e6e 5f72 6561 6479  >shared->n_ready
+0007bc90: 2c20 3129 203d 3d20 6e5f 7468 7265 6164  , 1) == n_thread
+0007bca0: 7320 2d20 3129 207b 0a20 2020 2020 2020  s - 1) {.       
+0007bcb0: 2020 2020 2061 746f 6d69 635f 7374 6f72       atomic_stor
+0007bcc0: 6528 2673 7461 7465 2d3e 7368 6172 6564  e(&state->shared
+0007bcd0: 2d3e 6861 735f 776f 726b 2c20 6661 6c73  ->has_work, fals
+0007bce0: 6529 3b0a 2020 2020 2020 2020 7d20 656c  e);.        } el
+0007bcf0: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+0007bd00: 2077 6869 6c65 2028 6174 6f6d 6963 5f6c   while (atomic_l
+0007bd10: 6f61 6428 2673 7461 7465 2d3e 7368 6172  oad(&state->shar
+0007bd20: 6564 2d3e 6861 735f 776f 726b 2929 207b  ed->has_work)) {
+0007bd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007bd40: 2069 6620 2861 746f 6d69 635f 6c6f 6164   if (atomic_load
+0007bd50: 2826 7374 6174 652d 3e73 6861 7265 642d  (&state->shared-
+0007bd60: 3e73 746f 7029 2920 7b0a 2020 2020 2020  >stop)) {.      
+0007bd70: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0007bd80: 7475 726e 2030 3b0a 2020 2020 2020 2020  turn 0;.        
+0007bd90: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0007bda0: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
+0007bdb0: 6f63 6b5f 6c6f 636b 2020 2826 7374 6174  ock_lock  (&stat
+0007bdc0: 652d 3e73 6861 7265 642d 3e73 7069 6e29  e->shared->spin)
+0007bdd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007bde0: 2020 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f    ggml_lock_unlo
+0007bdf0: 636b 2826 7374 6174 652d 3e73 6861 7265  ck(&state->share
+0007be00: 642d 3e73 7069 6e29 3b0a 2020 2020 2020  d->spin);.      
+0007be10: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007be20: 7d0a 0a20 2020 2020 2020 2061 746f 6d69  }..        atomi
+0007be30: 635f 6665 7463 685f 7375 6228 2673 7461  c_fetch_sub(&sta
+0007be40: 7465 2d3e 7368 6172 6564 2d3e 6e5f 7265  te->shared->n_re
+0007be50: 6164 792c 2031 293b 0a0a 2020 2020 2020  ady, 1);..      
+0007be60: 2020 2f2f 2077 6169 7420 666f 7220 776f    // wait for wo
+0007be70: 726b 0a20 2020 2020 2020 2077 6869 6c65  rk.        while
+0007be80: 2028 2161 746f 6d69 635f 6c6f 6164 2826   (!atomic_load(&
+0007be90: 7374 6174 652d 3e73 6861 7265 642d 3e68  state->shared->h
+0007bea0: 6173 5f77 6f72 6b29 2920 7b0a 2020 2020  as_work)) {.    
+0007beb0: 2020 2020 2020 2020 6966 2028 6174 6f6d          if (atom
+0007bec0: 6963 5f6c 6f61 6428 2673 7461 7465 2d3e  ic_load(&state->
+0007bed0: 7368 6172 6564 2d3e 7374 6f70 2929 207b  shared->stop)) {
+0007bee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007bef0: 2072 6574 7572 6e20 303b 0a20 2020 2020   return 0;.     
+0007bf00: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0007bf10: 2020 2020 2067 676d 6c5f 6c6f 636b 5f6c       ggml_lock_l
+0007bf20: 6f63 6b20 2028 2673 7461 7465 2d3e 7368  ock  (&state->sh
+0007bf30: 6172 6564 2d3e 7370 696e 293b 0a20 2020  ared->spin);.   
+0007bf40: 2020 2020 2020 2020 2067 676d 6c5f 6c6f           ggml_lo
+0007bf50: 636b 5f75 6e6c 6f63 6b28 2673 7461 7465  ck_unlock(&state
+0007bf60: 2d3e 7368 6172 6564 2d3e 7370 696e 293b  ->shared->spin);
+0007bf70: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0007bf80: 2020 2020 2f2f 2063 6865 636b 2069 6620      // check if 
+0007bf90: 7765 2073 686f 756c 6420 7374 6f70 0a20  we should stop. 
+0007bfa0: 2020 2020 2020 2069 6620 2861 746f 6d69         if (atomi
+0007bfb0: 635f 6c6f 6164 2826 7374 6174 652d 3e73  c_load(&state->s
+0007bfc0: 6861 7265 642d 3e73 746f 7029 2920 7b0a  hared->stop)) {.
+0007bfd0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+0007bfe0: 6b3b 0a20 2020 2020 2020 207d 0a0a 2020  k;.        }..  
+0007bff0: 2020 2020 2020 6966 2028 7374 6174 652d        if (state-
+0007c000: 3e6e 6f64 6529 207b 0a20 2020 2020 2020  >node) {.       
+0007c010: 2020 2020 2069 6620 2873 7461 7465 2d3e       if (state->
+0007c020: 7061 7261 6d73 2e69 7468 203c 2073 7461  params.ith < sta
+0007c030: 7465 2d3e 7061 7261 6d73 2e6e 7468 2920  te->params.nth) 
+0007c040: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007c050: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0007c060: 6f72 7761 7264 2826 7374 6174 652d 3e70  orward(&state->p
+0007c070: 6172 616d 732c 2073 7461 7465 2d3e 6e6f  arams, state->no
+0007c080: 6465 293b 0a20 2020 2020 2020 2020 2020  de);.           
+0007c090: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+0007c0a0: 7374 6174 652d 3e6e 6f64 6520 3d20 4e55  state->node = NU
+0007c0b0: 4c4c 3b0a 2020 2020 2020 2020 7d20 656c  LL;.        } el
+0007c0c0: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+0007c0d0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0007c0e0: 7d0a 2020 2020 7d0a 0a20 2020 2072 6574  }.    }..    ret
+0007c0f0: 7572 6e20 303b 0a7d 0a0a 766f 6964 2067  urn 0;.}..void g
+0007c100: 676d 6c5f 6772 6170 685f 636f 6d70 7574  gml_graph_comput
+0007c110: 6528 7374 7275 6374 2067 676d 6c5f 636f  e(struct ggml_co
+0007c120: 6e74 6578 7420 2a20 6374 782c 2073 7472  ntext * ctx, str
+0007c130: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+0007c140: 2a20 6367 7261 7068 2920 7b0a 2020 2020  * cgraph) {.    
+0007c150: 636f 6e73 7420 696e 7420 6e5f 7468 7265  const int n_thre
+0007c160: 6164 7320 3d20 6367 7261 7068 2d3e 6e5f  ads = cgraph->n_
+0007c170: 7468 7265 6164 733b 0a0a 2020 2020 7374  threads;..    st
+0007c180: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+0007c190: 655f 7374 6174 655f 7368 6172 6564 2073  e_state_shared s
+0007c1a0: 7461 7465 5f73 6861 7265 6420 3d20 7b0a  tate_shared = {.
+0007c1b0: 2020 2020 2020 2020 2f2a 2e73 7069 6e20          /*.spin 
+0007c1c0: 2020 2020 203d 2a2f 2047 474d 4c5f 4c4f       =*/ GGML_LO
+0007c1d0: 434b 5f49 4e49 5449 414c 495a 4552 2c0a  CK_INITIALIZER,.
+0007c1e0: 2020 2020 2020 2020 2f2a 2e6e 5f74 6872          /*.n_thr
+0007c1f0: 6561 6473 203d 2a2f 206e 5f74 6872 6561  eads =*/ n_threa
+0007c200: 6473 2c0a 2020 2020 2020 2020 2f2a 2e6e  ds,.        /*.n
+0007c210: 5f72 6561 6479 2020 203d 2a2f 2030 2c0a  _ready   =*/ 0,.
+0007c220: 2020 2020 2020 2020 2f2a 2e68 6173 5f77          /*.has_w
+0007c230: 6f72 6b20 203d 2a2f 2066 616c 7365 2c0a  ork  =*/ false,.
+0007c240: 2020 2020 2020 2020 2f2a 2e73 746f 7020          /*.stop 
+0007c250: 2020 2020 203d 2a2f 2066 616c 7365 2c0a       =*/ false,.
+0007c260: 2020 2020 7d3b 0a20 2020 2073 7472 7563      };.    struc
+0007c270: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f73  t ggml_compute_s
+0007c280: 7461 7465 202a 2077 6f72 6b65 7273 203d  tate * workers =
+0007c290: 206e 5f74 6872 6561 6473 203e 2031 203f   n_threads > 1 ?
+0007c2a0: 2061 6c6c 6f63 6128 7369 7a65 6f66 2873   alloca(sizeof(s
+0007c2b0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+0007c2c0: 7465 5f73 7461 7465 292a 286e 5f74 6872  te_state)*(n_thr
+0007c2d0: 6561 6473 202d 2031 2929 203a 204e 554c  eads - 1)) : NUL
+0007c2e0: 4c3b 0a0a 2020 2020 2f2f 2063 7265 6174  L;..    // creat
+0007c2f0: 6520 7468 7265 6164 2070 6f6f 6c0a 2020  e thread pool.  
+0007c300: 2020 6966 2028 6e5f 7468 7265 6164 7320    if (n_threads 
+0007c310: 3e20 3129 207b 0a20 2020 2020 2020 2067  > 1) {.        g
+0007c320: 676d 6c5f 6c6f 636b 5f69 6e69 7428 2673  gml_lock_init(&s
+0007c330: 7461 7465 5f73 6861 7265 642e 7370 696e  tate_shared.spin
+0007c340: 293b 0a0a 2020 2020 2020 2020 6174 6f6d  );..        atom
+0007c350: 6963 5f73 746f 7265 2826 7374 6174 655f  ic_store(&state_
+0007c360: 7368 6172 6564 2e68 6173 5f77 6f72 6b2c  shared.has_work,
+0007c370: 2074 7275 6529 3b0a 0a20 2020 2020 2020   true);..       
+0007c380: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+0007c390: 206a 203c 206e 5f74 6872 6561 6473 202d   j < n_threads -
+0007c3a0: 2031 3b20 6a2b 2b29 207b 0a20 2020 2020   1; j++) {.     
+0007c3b0: 2020 2020 2020 2077 6f72 6b65 7273 5b6a         workers[j
+0007c3c0: 5d20 3d20 2873 7472 7563 7420 6767 6d6c  ] = (struct ggml
+0007c3d0: 5f63 6f6d 7075 7465 5f73 7461 7465 2920  _compute_state) 
+0007c3e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007c3f0: 2020 2e74 6872 6420 2020 3d20 302c 0a20    .thrd   = 0,. 
+0007c400: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+0007c410: 7061 7261 6d73 203d 207b 0a20 2020 2020  params = {.     
+0007c420: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+0007c430: 7479 7065 2020 3d20 4747 4d4c 5f54 4153  type  = GGML_TAS
+0007c440: 4b5f 434f 4d50 5554 452c 0a20 2020 2020  K_COMPUTE,.     
+0007c450: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+0007c460: 6974 6820 2020 3d20 6a20 2b20 312c 0a20  ith   = j + 1,. 
+0007c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c480: 2020 202e 6e74 6820 2020 3d20 6e5f 7468     .nth   = n_th
+0007c490: 7265 6164 732c 0a20 2020 2020 2020 2020  reads,.         
+0007c4a0: 2020 2020 2020 2020 2020 202e 7773 697a             .wsiz
+0007c4b0: 6520 3d20 6367 7261 7068 2d3e 776f 726b  e = cgraph->work
+0007c4c0: 203f 2067 676d 6c5f 6e62 7974 6573 2863   ? ggml_nbytes(c
+0007c4d0: 6772 6170 682d 3e77 6f72 6b29 203a 2030  graph->work) : 0
+0007c4e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007c4f0: 2020 2020 2020 2e77 6461 7461 203d 2063        .wdata = c
+0007c500: 6772 6170 682d 3e77 6f72 6b20 3f20 6367  graph->work ? cg
+0007c510: 7261 7068 2d3e 776f 726b 2d3e 6461 7461  raph->work->data
+0007c520: 203a 204e 554c 4c2c 0a20 2020 2020 2020   : NULL,.       
+0007c530: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+0007c540: 2020 2020 2020 2020 2020 2020 2e6e 6f64              .nod
+0007c550: 6520 2020 3d20 4e55 4c4c 2c0a 2020 2020  e   = NULL,.    
+0007c560: 2020 2020 2020 2020 2020 2020 2e73 6861              .sha
+0007c570: 7265 6420 3d20 2673 7461 7465 5f73 6861  red = &state_sha
+0007c580: 7265 642c 0a20 2020 2020 2020 2020 2020  red,.           
+0007c590: 207d 3b0a 0a20 2020 2020 2020 2020 2020   };..           
+0007c5a0: 2069 6e74 2072 6320 3d20 6767 6d6c 5f74   int rc = ggml_t
+0007c5b0: 6872 6561 645f 6372 6561 7465 2826 776f  hread_create(&wo
+0007c5c0: 726b 6572 735b 6a5d 2e74 6872 642c 204e  rkers[j].thrd, N
+0007c5d0: 554c 4c2c 2067 676d 6c5f 6772 6170 685f  ULL, ggml_graph_
+0007c5e0: 636f 6d70 7574 655f 7468 7265 6164 2c20  compute_thread, 
+0007c5f0: 2677 6f72 6b65 7273 5b6a 5d29 3b0a 2020  &workers[j]);.  
+0007c600: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0007c610: 5353 4552 5428 7263 203d 3d20 3029 3b0a  SSERT(rc == 0);.
+0007c620: 2020 2020 2020 2020 2020 2020 554e 5553              UNUS
+0007c630: 4544 2872 6329 3b0a 2020 2020 2020 2020  ED(rc);.        
+0007c640: 7d0a 2020 2020 7d0a 0a20 2020 202f 2f20  }.    }..    // 
+0007c650: 696e 6974 6961 6c69 7a65 2074 6173 6b73  initialize tasks
+0007c660: 202b 2077 6f72 6b20 6275 6666 6572 0a20   + work buffer. 
+0007c670: 2020 207b 0a20 2020 2020 2020 2073 697a     {.        siz
+0007c680: 655f 7420 776f 726b 5f73 697a 6520 3d20  e_t work_size = 
+0007c690: 303b 0a0a 2020 2020 2020 2020 2f2f 2074  0;..        // t
+0007c6a0: 6872 6561 6420 7363 6865 6475 6c69 6e67  hread scheduling
+0007c6b0: 2066 6f72 2074 6865 2064 6966 6665 7265   for the differe
+0007c6c0: 6e74 206f 7065 7261 7469 6f6e 730a 2020  nt operations.  
+0007c6d0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0007c6e0: 203d 2030 3b20 6920 3c20 6367 7261 7068   = 0; i < cgraph
+0007c6f0: 2d3e 6e5f 6e6f 6465 733b 2069 2b2b 2920  ->n_nodes; i++) 
+0007c700: 7b0a 2020 2020 2020 2020 2020 2020 7374  {.            st
+0007c710: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0007c720: 202a 206e 6f64 6520 3d20 6367 7261 7068   * node = cgraph
+0007c730: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
+0007c740: 2020 2020 2020 2020 2073 7769 7463 6820           switch 
+0007c750: 286e 6f64 652d 3e6f 7029 207b 0a20 2020  (node->op) {.   
+0007c760: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+0007c770: 6520 4747 4d4c 5f4f 505f 4350 593a 0a20  e GGML_OP_CPY:. 
+0007c780: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007c790: 6173 6520 4747 4d4c 5f4f 505f 4455 503a  ase GGML_OP_DUP:
+0007c7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007c7b0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007c7c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0007c7d0: 6f64 652d 3e6e 5f74 6173 6b73 203d 206e  ode->n_tasks = n
+0007c7e0: 5f74 6872 6561 6473 3b0a 0a20 2020 2020  _threads;..     
+0007c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c800: 2020 2073 697a 655f 7420 6375 7220 3d20     size_t cur = 
+0007c810: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+0007c820: 2020 2020 2020 2020 2020 2069 6620 2867             if (g
+0007c830: 676d 6c5f 6973 5f71 7561 6e74 697a 6564  gml_is_quantized
+0007c840: 286e 6f64 652d 3e74 7970 6529 2920 7b0a  (node->type)) {.
+0007c850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c860: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
+0007c870: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
+0007c880: 5b47 474d 4c5f 5459 5045 5f46 3332 5d20  [GGML_TYPE_F32] 
+0007c890: 2a20 6e6f 6465 2d3e 6e65 5b30 5d20 2a20  * node->ne[0] * 
+0007c8a0: 6e5f 7468 7265 6164 733b 0a20 2020 2020  n_threads;.     
+0007c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c8c0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+0007c8d0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+0007c8e0: 726b 5f73 697a 6520 3d20 4d41 5828 776f  rk_size = MAX(wo
+0007c8f0: 726b 5f73 697a 652c 2063 7572 293b 0a20  rk_size, cur);. 
+0007c900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c910: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007c920: 2020 2020 2020 2020 2020 2020 6361 7365              case
+0007c930: 2047 474d 4c5f 4f50 5f41 4444 3a0a 2020   GGML_OP_ADD:.  
+0007c940: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0007c950: 7365 2047 474d 4c5f 4f50 5f41 4444 313a  se GGML_OP_ADD1:
+0007c960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007c970: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007c980: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0007c990: 6f64 652d 3e6e 5f74 6173 6b73 203d 206e  ode->n_tasks = n
+0007c9a0: 5f74 6872 6561 6473 3b0a 0a20 2020 2020  _threads;..     
+0007c9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c9c0: 2020 2073 697a 655f 7420 6375 7220 3d20     size_t cur = 
+0007c9d0: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
+0007c9e0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0007c9f0: 6767 6d6c 5f69 735f 7175 616e 7469 7a65  ggml_is_quantize
+0007ca00: 6428 6e6f 6465 2d3e 7372 6330 2d3e 7479  d(node->src0->ty
+0007ca10: 7065 2929 207b 0a20 2020 2020 2020 2020  pe)) {.         
+0007ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ca30: 2020 2063 7572 203d 2047 474d 4c5f 5459     cur = GGML_TY
+0007ca40: 5045 5f53 495a 455b 4747 4d4c 5f54 5950  PE_SIZE[GGML_TYP
+0007ca50: 455f 4633 325d 202a 206e 6f64 652d 3e73  E_F32] * node->s
+0007ca60: 7263 302d 3e6e 655b 305d 202a 206e 5f74  rc0->ne[0] * n_t
+0007ca70: 6872 6561 6473 3b0a 2020 2020 2020 2020  hreads;.        
+0007ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ca90: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+0007caa0: 2020 2020 2020 2020 2020 2077 6f72 6b5f             work_
+0007cab0: 7369 7a65 203d 204d 4158 2877 6f72 6b5f  size = MAX(work_
+0007cac0: 7369 7a65 2c20 6375 7229 3b0a 2020 2020  size, cur);.    
+0007cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cae0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007caf0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+0007cb00: 4d4c 5f4f 505f 4143 433a 0a20 2020 2020  ML_OP_ACC:.     
+0007cb10: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0007cb20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007cb30: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
+0007cb40: 5f74 6173 6b73 203d 206e 5f74 6872 6561  _tasks = n_threa
+0007cb50: 6473 3b0a 0a20 2020 2020 2020 2020 2020  ds;..           
+0007cb60: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+0007cb70: 655f 7420 6375 7220 3d20 303b 0a0a 2020  e_t cur = 0;..  
+0007cb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cb90: 2020 2020 2020 6966 2028 6767 6d6c 5f69        if (ggml_i
+0007cba0: 735f 7175 616e 7469 7a65 6428 6e6f 6465  s_quantized(node
+0007cbb0: 2d3e 7372 6330 2d3e 7479 7065 2929 207b  ->src0->type)) {
+0007cbc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007cbd0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+0007cbe0: 203d 2047 474d 4c5f 5459 5045 5f53 495a   = GGML_TYPE_SIZ
+0007cbf0: 455b 4747 4d4c 5f54 5950 455f 4633 325d  E[GGML_TYPE_F32]
+0007cc00: 202a 206e 6f64 652d 3e73 7263 312d 3e6e   * node->src1->n
+0007cc10: 655b 305d 202a 206e 5f74 6872 6561 6473  e[0] * n_threads
+0007cc20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007cc30: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+0007cc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cc50: 2020 2020 2077 6f72 6b5f 7369 7a65 203d       work_size =
+0007cc60: 204d 4158 2877 6f72 6b5f 7369 7a65 2c20   MAX(work_size, 
+0007cc70: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
+0007cc80: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0007cc90: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+0007cca0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007ccb0: 5355 423a 0a20 2020 2020 2020 2020 2020  SUB:.           
+0007ccc0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007ccd0: 505f 4449 563a 0a20 2020 2020 2020 2020  P_DIV:.         
+0007cce0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0007ccf0: 5f4f 505f 5351 523a 0a20 2020 2020 2020  _OP_SQR:.       
+0007cd00: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+0007cd10: 4d4c 5f4f 505f 5351 5254 3a0a 2020 2020  ML_OP_SQRT:.    
+0007cd20: 2020 2020 2020 2020 2020 2020 6361 7365              case
+0007cd30: 2047 474d 4c5f 4f50 5f4c 4f47 3a0a 2020   GGML_OP_LOG:.  
+0007cd40: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0007cd50: 7365 2047 474d 4c5f 4f50 5f53 554d 3a0a  se GGML_OP_SUM:.
+0007cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cd70: 6361 7365 2047 474d 4c5f 4f50 5f53 554d  case GGML_OP_SUM
+0007cd80: 5f52 4f57 533a 0a20 2020 2020 2020 2020  _ROWS:.         
+0007cd90: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0007cda0: 5f4f 505f 4d45 414e 3a0a 2020 2020 2020  _OP_MEAN:.      
+0007cdb0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+0007cdc0: 474d 4c5f 4f50 5f52 4550 4541 543a 0a20  GML_OP_REPEAT:. 
+0007cdd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007cde0: 6173 6520 4747 4d4c 5f4f 505f 5245 5045  ase GGML_OP_REPE
+0007cdf0: 4154 5f42 4143 4b3a 0a20 2020 2020 2020  AT_BACK:.       
+0007ce00: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+0007ce10: 4d4c 5f4f 505f 4142 533a 0a20 2020 2020  ML_OP_ABS:.     
+0007ce20: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+0007ce30: 4747 4d4c 5f4f 505f 5347 4e3a 0a20 2020  GGML_OP_SGN:.   
+0007ce40: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+0007ce50: 6520 4747 4d4c 5f4f 505f 4e45 473a 0a20  e GGML_OP_NEG:. 
+0007ce60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007ce70: 6173 6520 4747 4d4c 5f4f 505f 5354 4550  ase GGML_OP_STEP
+0007ce80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0007ce90: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
+0007cea0: 454c 553a 0a20 2020 2020 2020 2020 2020  ELU:.           
+0007ceb0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0007cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ced0: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
+0007cee0: 203d 2031 3b0a 2020 2020 2020 2020 2020   = 1;.          
+0007cef0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0007cf00: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+0007cf10: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007cf20: 4d55 4c3a 0a20 2020 2020 2020 2020 2020  MUL:.           
+0007cf30: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007cf40: 505f 4745 4c55 3a0a 2020 2020 2020 2020  P_GELU:.        
+0007cf50: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007cf60: 4c5f 4f50 5f53 494c 553a 0a20 2020 2020  L_OP_SILU:.     
+0007cf70: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+0007cf80: 4747 4d4c 5f4f 505f 5349 4c55 5f42 4143  GGML_OP_SILU_BAC
+0007cf90: 4b3a 0a20 2020 2020 2020 2020 2020 2020  K:.             
+0007cfa0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007cfb0: 4e4f 524d 3a0a 2020 2020 2020 2020 2020  NORM:.          
+0007cfc0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0007cfd0: 4f50 5f52 4d53 5f4e 4f52 4d3a 0a20 2020  OP_RMS_NORM:.   
+0007cfe0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+0007cff0: 6520 4747 4d4c 5f4f 505f 524d 535f 4e4f  e GGML_OP_RMS_NO
+0007d000: 524d 5f42 4143 4b3a 0a20 2020 2020 2020  RM_BACK:.       
+0007d010: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+0007d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d030: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
+0007d040: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
+0007d050: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007d060: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0007d070: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007d080: 6173 6520 4747 4d4c 5f4f 505f 4d55 4c5f  ase GGML_OP_MUL_
+0007d090: 4d41 543a 0a20 2020 2020 2020 2020 2020  MAT:.           
 0007d0a0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007d0b0: 505f 4745 4c55 3a0a 2020 2020 2020 2020  P_GELU:.        
-0007d0c0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007d0d0: 4c5f 4f50 5f53 494c 553a 0a20 2020 2020  L_OP_SILU:.     
-0007d0e0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-0007d0f0: 4747 4d4c 5f4f 505f 5349 4c55 5f42 4143  GGML_OP_SILU_BAC
-0007d100: 4b3a 0a20 2020 2020 2020 2020 2020 2020  K:.             
-0007d110: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007d120: 4e4f 524d 3a0a 2020 2020 2020 2020 2020  NORM:.          
-0007d130: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0007d140: 4f50 5f52 4d53 5f4e 4f52 4d3a 0a20 2020  OP_RMS_NORM:.   
-0007d150: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-0007d160: 6520 4747 4d4c 5f4f 505f 524d 535f 4e4f  e GGML_OP_RMS_NO
-0007d170: 524d 5f42 4143 4b3a 0a20 2020 2020 2020  RM_BACK:.       
-0007d180: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-0007d190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d1a0: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
-0007d1b0: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
-0007d1c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007d1d0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0007d1e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0007d1f0: 6173 6520 4747 4d4c 5f4f 505f 4d55 4c5f  ase GGML_OP_MUL_
-0007d200: 4d41 543a 0a20 2020 2020 2020 2020 2020  MAT:.           
-0007d210: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007d220: 505f 4f55 545f 5052 4f44 3a0a 2020 2020  P_OUT_PROD:.    
+0007d0b0: 505f 4f55 545f 5052 4f44 3a0a 2020 2020  P_OUT_PROD:.    
+0007d0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d0d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007d0e0: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
+0007d0f0: 6e5f 7461 736b 7320 3d20 6e5f 7468 7265  n_tasks = n_thre
+0007d100: 6164 733b 0a0a 2020 2020 2020 2020 2020  ads;..          
+0007d110: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007d120: 2054 4f44 4f3a 2075 7365 2064 6966 6665   TODO: use diffe
+0007d130: 7265 6e74 2073 6368 6564 756c 696e 6720  rent scheduling 
+0007d140: 666f 7220 6469 6666 6572 656e 7420 6d61  for different ma
+0007d150: 7472 6978 2073 697a 6573 0a20 2020 2020  trix sizes.     
+0007d160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d170: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+0007d180: 7230 203d 2067 676d 6c5f 6e72 6f77 7328  r0 = ggml_nrows(
+0007d190: 6e6f 6465 2d3e 7372 6330 293b 0a20 2020  node->src0);.   
+0007d1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d1b0: 2020 2020 202f 2f63 6f6e 7374 2069 6e74       //const int
+0007d1c0: 206e 7231 203d 2067 676d 6c5f 6e72 6f77   nr1 = ggml_nrow
+0007d1d0: 7328 6e6f 6465 2d3e 7372 6331 293b 0a0a  s(node->src1);..
+0007d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d1f0: 2020 2020 2020 2020 2f2f 6e6f 6465 2d3e          //node->
+0007d200: 6e5f 7461 736b 7320 3d20 4d49 4e28 6e5f  n_tasks = MIN(n_
+0007d210: 7468 7265 6164 732c 204d 4158 2831 2c20  threads, MAX(1, 
+0007d220: 6e72 302f 3132 3829 293b 0a20 2020 2020  nr0/128));.     
 0007d230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d240: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007d250: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
-0007d260: 6e5f 7461 736b 7320 3d20 6e5f 7468 7265  n_tasks = n_thre
-0007d270: 6164 733b 0a0a 2020 2020 2020 2020 2020  ads;..          
-0007d280: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0007d290: 2054 4f44 4f3a 2075 7365 2064 6966 6665   TODO: use diffe
-0007d2a0: 7265 6e74 2073 6368 6564 756c 696e 6720  rent scheduling 
-0007d2b0: 666f 7220 6469 6666 6572 656e 7420 6d61  for different ma
-0007d2c0: 7472 6978 2073 697a 6573 0a20 2020 2020  trix sizes.     
-0007d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d2e0: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-0007d2f0: 7230 203d 2067 676d 6c5f 6e72 6f77 7328  r0 = ggml_nrows(
-0007d300: 6e6f 6465 2d3e 7372 6330 293b 0a20 2020  node->src0);.   
-0007d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d320: 2020 2020 202f 2f63 6f6e 7374 2069 6e74       //const int
-0007d330: 206e 7231 203d 2067 676d 6c5f 6e72 6f77   nr1 = ggml_nrow
-0007d340: 7328 6e6f 6465 2d3e 7372 6331 293b 0a0a  s(node->src1);..
-0007d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d360: 2020 2020 2020 2020 2f2f 6e6f 6465 2d3e          //node->
-0007d370: 6e5f 7461 736b 7320 3d20 4d49 4e28 6e5f  n_tasks = MIN(n_
-0007d380: 7468 7265 6164 732c 204d 4158 2831 2c20  threads, MAX(1, 
-0007d390: 6e72 302f 3132 3829 293b 0a20 2020 2020  nr0/128));.     
+0007d240: 2020 202f 2f70 7269 6e74 6628 226e 7230     //printf("nr0
+0007d250: 203d 2025 3864 2c20 6e72 3120 3d20 2538   = %8d, nr1 = %8
+0007d260: 642c 206e 7230 2a6e 7231 203d 2025 3864  d, nr0*nr1 = %8d
+0007d270: 2c20 6e5f 7461 736b 7320 3d20 2564 5c6e  , n_tasks = %d\n
+0007d280: 222c 206e 7230 2c20 6e72 312c 206e 7230  ", nr0, nr1, nr0
+0007d290: 2a6e 7231 2c20 6e6f 6465 2d3e 6e5f 7461  *nr1, node->n_ta
+0007d2a0: 736b 7329 3b0a 0a20 2020 2020 2020 2020  sks);..         
+0007d2b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007d2c0: 697a 655f 7420 6375 7220 3d20 303b 0a0a  ize_t cur = 0;..
+0007d2d0: 2369 6620 6465 6669 6e65 6428 4747 4d4c  #if defined(GGML
+0007d2e0: 5f55 5345 5f43 5542 4c41 5329 0a20 2020  _USE_CUBLAS).   
+0007d2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d300: 2020 2020 2069 6620 2867 676d 6c5f 6375       if (ggml_cu
+0007d310: 6461 5f63 616e 5f6d 756c 5f6d 6174 286e  da_can_mul_mat(n
+0007d320: 6f64 652d 3e73 7263 302c 206e 6f64 652d  ode->src0, node-
+0007d330: 3e73 7263 312c 206e 6f64 6529 2920 7b0a  >src1, node)) {.
+0007d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d350: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+0007d360: 2d3e 6e5f 7461 736b 7320 3d20 313b 202f  ->n_tasks = 1; /
+0007d370: 2f20 544f 444f 3a20 7468 6973 2061 6374  / TODO: this act
+0007d380: 7561 6c6c 7920 6973 2064 6f69 6e67 206e  ually is doing n
+0007d390: 6f74 6869 6e67 0a20 2020 2020 2020 2020  othing.         
 0007d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d3b0: 2020 202f 2f70 7269 6e74 6628 226e 7230     //printf("nr0
-0007d3c0: 203d 2025 3864 2c20 6e72 3120 3d20 2538   = %8d, nr1 = %8
-0007d3d0: 642c 206e 7230 2a6e 7231 203d 2025 3864  d, nr0*nr1 = %8d
-0007d3e0: 2c20 6e5f 7461 736b 7320 3d20 2564 5c6e  , n_tasks = %d\n
-0007d3f0: 222c 206e 7230 2c20 6e72 312c 206e 7230  ", nr0, nr1, nr0
-0007d400: 2a6e 7231 2c20 6e6f 6465 2d3e 6e5f 7461  *nr1, node->n_ta
-0007d410: 736b 7329 3b0a 0a20 2020 2020 2020 2020  sks);..         
-0007d420: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007d430: 697a 655f 7420 6375 7220 3d20 303b 0a0a  ize_t cur = 0;..
-0007d440: 2369 6620 6465 6669 6e65 6428 4747 4d4c  #if defined(GGML
-0007d450: 5f55 5345 5f43 5542 4c41 5329 0a20 2020  _USE_CUBLAS).   
-0007d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d470: 2020 2020 2069 6620 2867 676d 6c5f 6375       if (ggml_cu
-0007d480: 6461 5f63 616e 5f6d 756c 5f6d 6174 286e  da_can_mul_mat(n
-0007d490: 6f64 652d 3e73 7263 302c 206e 6f64 652d  ode->src0, node-
-0007d4a0: 3e73 7263 312c 206e 6f64 6529 2920 7b0a  >src1, node)) {.
-0007d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d4c0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-0007d4d0: 2d3e 6e5f 7461 736b 7320 3d20 313b 202f  ->n_tasks = 1; /
-0007d4e0: 2f20 544f 444f 3a20 7468 6973 2061 6374  / TODO: this act
-0007d4f0: 7561 6c6c 7920 6973 2064 6f69 6e67 206e  ually is doing n
-0007d500: 6f74 6869 6e67 0a20 2020 2020 2020 2020  othing.         
-0007d510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d530: 2020 2020 2020 202f 2f20 2020 2020 2020         //       
-0007d540: 7468 6520 7468 7265 6164 7320 6172 6520  the threads are 
-0007d550: 7374 696c 6c20 7370 696e 6e69 6e67 0a20  still spinning. 
-0007d560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d570: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0007d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d590: 2065 6c73 650a 2365 6c69 6620 6465 6669   else.#elif defi
-0007d5a0: 6e65 6428 4747 4d4c 5f55 5345 5f43 4c42  ned(GGML_USE_CLB
-0007d5b0: 4c41 5354 290a 2020 2020 2020 2020 2020  LAST).          
-0007d5c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0007d5d0: 2028 6767 6d6c 5f63 6c5f 6361 6e5f 6d75   (ggml_cl_can_mu
-0007d5e0: 6c5f 6d61 7428 6e6f 6465 2d3e 7372 6330  l_mat(node->src0
-0007d5f0: 2c20 6e6f 6465 2d3e 7372 6331 2c20 6e6f  , node->src1, no
-0007d600: 6465 2929 207b 0a20 2020 2020 2020 2020  de)) {.         
-0007d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d620: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
-0007d630: 203d 2031 3b20 2f2f 2054 4f44 4f3a 2074   = 1; // TODO: t
-0007d640: 6869 7320 6163 7475 616c 6c79 2069 7320  his actually is 
-0007d650: 646f 696e 6720 6e6f 7468 696e 670a 2020  doing nothing.  
-0007d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d680: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0007d690: 2020 2020 2020 2074 6865 2074 6872 6561         the threa
-0007d6a0: 6473 2061 7265 2073 7469 6c6c 2073 7069  ds are still spi
-0007d6b0: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-0007d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d6d0: 2020 6375 7220 3d20 6767 6d6c 5f63 6c5f    cur = ggml_cl_
-0007d6e0: 6d75 6c5f 6d61 745f 6765 745f 7773 697a  mul_mat_get_wsiz
-0007d6f0: 6528 6e6f 6465 2d3e 7372 6330 2c20 6e6f  e(node->src0, no
-0007d700: 6465 2d3e 7372 6331 2c20 6e6f 6465 293b  de->src1, node);
-0007d710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007d720: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d740: 2020 2065 6c73 650a 2365 6e64 6966 0a20     else.#endif. 
+0007d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d3c0: 2020 2020 2020 202f 2f20 2020 2020 2020         //       
+0007d3d0: 7468 6520 7468 7265 6164 7320 6172 6520  the threads are 
+0007d3e0: 7374 696c 6c20 7370 696e 6e69 6e67 0a20  still spinning. 
+0007d3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d400: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0007d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d420: 2065 6c73 650a 2365 6c69 6620 6465 6669   else.#elif defi
+0007d430: 6e65 6428 4747 4d4c 5f55 5345 5f43 4c42  ned(GGML_USE_CLB
+0007d440: 4c41 5354 290a 2020 2020 2020 2020 2020  LAST).          
+0007d450: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0007d460: 2028 6767 6d6c 5f63 6c5f 6361 6e5f 6d75   (ggml_cl_can_mu
+0007d470: 6c5f 6d61 7428 6e6f 6465 2d3e 7372 6330  l_mat(node->src0
+0007d480: 2c20 6e6f 6465 2d3e 7372 6331 2c20 6e6f  , node->src1, no
+0007d490: 6465 2929 207b 0a20 2020 2020 2020 2020  de)) {.         
+0007d4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d4b0: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
+0007d4c0: 203d 2031 3b20 2f2f 2054 4f44 4f3a 2074   = 1; // TODO: t
+0007d4d0: 6869 7320 6163 7475 616c 6c79 2069 7320  his actually is 
+0007d4e0: 646f 696e 6720 6e6f 7468 696e 670a 2020  doing nothing.  
+0007d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d510: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007d520: 2020 2020 2020 2074 6865 2074 6872 6561         the threa
+0007d530: 6473 2061 7265 2073 7469 6c6c 2073 7069  ds are still spi
+0007d540: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
+0007d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d560: 2020 6375 7220 3d20 6767 6d6c 5f63 6c5f    cur = ggml_cl_
+0007d570: 6d75 6c5f 6d61 745f 6765 745f 7773 697a  mul_mat_get_wsiz
+0007d580: 6528 6e6f 6465 2d3e 7372 6330 2c20 6e6f  e(node->src0, no
+0007d590: 6465 2d3e 7372 6331 2c20 6e6f 6465 293b  de->src1, node);
+0007d5a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007d5b0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0007d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d5d0: 2020 2065 6c73 650a 2365 6e64 6966 0a20     else.#endif. 
+0007d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d5f0: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
+0007d600: 3e73 7263 302d 3e74 7970 6520 3d3d 2047  >src0->type == G
+0007d610: 474d 4c5f 5459 5045 5f46 3136 2026 2620  GML_TYPE_F16 && 
+0007d620: 6e6f 6465 2d3e 7372 6331 2d3e 7479 7065  node->src1->type
+0007d630: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
+0007d640: 3229 207b 0a23 6966 2064 6566 696e 6564  2) {.#if defined
+0007d650: 2847 474d 4c5f 5553 455f 4143 4345 4c45  (GGML_USE_ACCELE
+0007d660: 5241 5445 2920 7c7c 2064 6566 696e 6564  RATE) || defined
+0007d670: 2847 474d 4c5f 5553 455f 4f50 454e 424c  (GGML_USE_OPENBL
+0007d680: 4153 290a 2020 2020 2020 2020 2020 2020  AS).            
+0007d690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d6a0: 6966 2028 6767 6d6c 5f63 6f6d 7075 7465  if (ggml_compute
+0007d6b0: 5f66 6f72 7761 7264 5f6d 756c 5f6d 6174  _forward_mul_mat
+0007d6c0: 5f75 7365 5f62 6c61 7328 6e6f 6465 2d3e  _use_blas(node->
+0007d6d0: 7372 6330 2c20 6e6f 6465 2d3e 7372 6331  src0, node->src1
+0007d6e0: 2c20 6e6f 6465 2929 207b 0a20 2020 2020  , node)) {.     
+0007d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d700: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+0007d710: 3e6e 5f74 6173 6b73 203d 2031 3b20 2f2f  >n_tasks = 1; //
+0007d720: 2054 4f44 4f3a 2074 6869 7320 6163 7475   TODO: this actu
+0007d730: 616c 6c79 2069 7320 646f 696e 6720 6e6f  ally is doing no
+0007d740: 7468 696e 670a 2020 2020 2020 2020 2020  thing.          
 0007d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d760: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
-0007d770: 3e73 7263 302d 3e74 7970 6520 3d3d 2047  >src0->type == G
-0007d780: 474d 4c5f 5459 5045 5f46 3136 2026 2620  GML_TYPE_F16 && 
-0007d790: 6e6f 6465 2d3e 7372 6331 2d3e 7479 7065  node->src1->type
-0007d7a0: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
-0007d7b0: 3229 207b 0a23 6966 2064 6566 696e 6564  2) {.#if defined
-0007d7c0: 2847 474d 4c5f 5553 455f 4143 4345 4c45  (GGML_USE_ACCELE
-0007d7d0: 5241 5445 2920 7c7c 2064 6566 696e 6564  RATE) || defined
-0007d7e0: 2847 474d 4c5f 5553 455f 4f50 454e 424c  (GGML_USE_OPENBL
-0007d7f0: 4153 290a 2020 2020 2020 2020 2020 2020  AS).            
+0007d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d770: 2020 2020 2020 2020 202f 2f20 2020 2020           //     
+0007d780: 2020 7468 6520 7468 7265 6164 7320 6172    the threads ar
+0007d790: 6520 7374 696c 6c20 7370 696e 6e69 6e67  e still spinning
+0007d7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007d7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d7c0: 202f 2f20 6865 7265 2077 6520 6e65 6564   // here we need
+0007d7d0: 206d 656d 6f72 7920 6a75 7374 2066 6f72   memory just for
+0007d7e0: 2073 696e 676c 6520 3244 206d 6174 7269   single 2D matri
+0007d7f0: 7820 6672 6f6d 2073 7263 300a 2020 2020  x from src0.    
 0007d800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d810: 6966 2028 6767 6d6c 5f63 6f6d 7075 7465  if (ggml_compute
-0007d820: 5f66 6f72 7761 7264 5f6d 756c 5f6d 6174  _forward_mul_mat
-0007d830: 5f75 7365 5f62 6c61 7328 6e6f 6465 2d3e  _use_blas(node->
-0007d840: 7372 6330 2c20 6e6f 6465 2d3e 7372 6331  src0, node->src1
-0007d850: 2c20 6e6f 6465 2929 207b 0a20 2020 2020  , node)) {.     
-0007d860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d870: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-0007d880: 3e6e 5f74 6173 6b73 203d 2031 3b20 2f2f  >n_tasks = 1; //
-0007d890: 2054 4f44 4f3a 2074 6869 7320 6163 7475   TODO: this actu
-0007d8a0: 616c 6c79 2069 7320 646f 696e 6720 6e6f  ally is doing no
-0007d8b0: 7468 696e 670a 2020 2020 2020 2020 2020  thing.          
-0007d8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d8e0: 2020 2020 2020 2020 202f 2f20 2020 2020           //     
-0007d8f0: 2020 7468 6520 7468 7265 6164 7320 6172    the threads ar
-0007d900: 6520 7374 696c 6c20 7370 696e 6e69 6e67  e still spinning
-0007d910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d930: 202f 2f20 6865 7265 2077 6520 6e65 6564   // here we need
-0007d940: 206d 656d 6f72 7920 6a75 7374 2066 6f72   memory just for
-0007d950: 2073 696e 676c 6520 3244 206d 6174 7269   single 2D matri
-0007d960: 7820 6672 6f6d 2073 7263 300a 2020 2020  x from src0.    
-0007d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d980: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
-0007d990: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
-0007d9a0: 5b47 474d 4c5f 5459 5045 5f46 3332 5d2a  [GGML_TYPE_F32]*
-0007d9b0: 286e 6f64 652d 3e73 7263 302d 3e6e 655b  (node->src0->ne[
-0007d9c0: 305d 2a6e 6f64 652d 3e73 7263 302d 3e6e  0]*node->src0->n
-0007d9d0: 655b 315d 293b 0a20 2020 2020 2020 2020  e[1]);.         
+0007d810: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
+0007d820: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
+0007d830: 5b47 474d 4c5f 5459 5045 5f46 3332 5d2a  [GGML_TYPE_F32]*
+0007d840: 286e 6f64 652d 3e73 7263 302d 3e6e 655b  (node->src0->ne[
+0007d850: 305d 2a6e 6f64 652d 3e73 7263 302d 3e6e  0]*node->src0->n
+0007d860: 655b 315d 293b 0a20 2020 2020 2020 2020  e[1]);.         
+0007d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d880: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0007d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d8a0: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
+0007d8b0: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
+0007d8c0: 5b47 474d 4c5f 5459 5045 5f46 3136 5d2a  [GGML_TYPE_F16]*
+0007d8d0: 6767 6d6c 5f6e 656c 656d 656e 7473 286e  ggml_nelements(n
+0007d8e0: 6f64 652d 3e73 7263 3129 3b0a 2020 2020  ode->src1);.    
+0007d8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d900: 2020 2020 2020 2020 7d0a 2365 6c73 650a          }.#else.
+0007d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d920: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
+0007d930: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
+0007d940: 5b47 474d 4c5f 5459 5045 5f46 3136 5d2a  [GGML_TYPE_F16]*
+0007d950: 6767 6d6c 5f6e 656c 656d 656e 7473 286e  ggml_nelements(n
+0007d960: 6f64 652d 3e73 7263 3129 3b0a 2365 6e64  ode->src1);.#end
+0007d970: 6966 0a20 2020 2020 2020 2020 2020 2020  if.             
+0007d980: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
+0007d990: 6520 6966 2028 6e6f 6465 2d3e 7372 6330  e if (node->src0
+0007d9a0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0007d9b0: 5950 455f 4633 3220 2626 206e 6f64 652d  YPE_F32 && node-
+0007d9c0: 3e73 7263 312d 3e74 7970 6520 3d3d 2047  >src1->type == G
+0007d9d0: 474d 4c5f 5459 5045 5f46 3332 2920 7b0a  GML_TYPE_F32) {.
 0007d9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d9f0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-0007da00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da10: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
-0007da20: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
-0007da30: 5b47 474d 4c5f 5459 5045 5f46 3136 5d2a  [GGML_TYPE_F16]*
-0007da40: 6767 6d6c 5f6e 656c 656d 656e 7473 286e  ggml_nelements(n
-0007da50: 6f64 652d 3e73 7263 3129 3b0a 2020 2020  ode->src1);.    
-0007da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da70: 2020 2020 2020 2020 7d0a 2365 6c73 650a          }.#else.
-0007da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da90: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
-0007daa0: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
-0007dab0: 5b47 474d 4c5f 5459 5045 5f46 3136 5d2a  [GGML_TYPE_F16]*
-0007dac0: 6767 6d6c 5f6e 656c 656d 656e 7473 286e  ggml_nelements(n
-0007dad0: 6f64 652d 3e73 7263 3129 3b0a 2365 6e64  ode->src1);.#end
-0007dae0: 6966 0a20 2020 2020 2020 2020 2020 2020  if.             
-0007daf0: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-0007db00: 6520 6966 2028 6e6f 6465 2d3e 7372 6330  e if (node->src0
-0007db10: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0007db20: 5950 455f 4633 3220 2626 206e 6f64 652d  YPE_F32 && node-
-0007db30: 3e73 7263 312d 3e74 7970 6520 3d3d 2047  >src1->type == G
-0007db40: 474d 4c5f 5459 5045 5f46 3332 2920 7b0a  GML_TYPE_F32) {.
-0007db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007db60: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
-0007db70: 3d20 303b 0a23 6966 2064 6566 696e 6564  = 0;.#if defined
-0007db80: 2847 474d 4c5f 5553 455f 4143 4345 4c45  (GGML_USE_ACCELE
-0007db90: 5241 5445 2920 7c7c 2064 6566 696e 6564  RATE) || defined
-0007dba0: 2847 474d 4c5f 5553 455f 4f50 454e 424c  (GGML_USE_OPENBL
-0007dbb0: 4153 290a 2020 2020 2020 2020 2020 2020  AS).            
-0007dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dbd0: 6966 2028 6767 6d6c 5f63 6f6d 7075 7465  if (ggml_compute
-0007dbe0: 5f66 6f72 7761 7264 5f6d 756c 5f6d 6174  _forward_mul_mat
-0007dbf0: 5f75 7365 5f62 6c61 7328 6e6f 6465 2d3e  _use_blas(node->
-0007dc00: 7372 6330 2c20 6e6f 6465 2d3e 7372 6331  src0, node->src1
-0007dc10: 2c20 6e6f 6465 2929 207b 0a20 2020 2020  , node)) {.     
+0007d9f0: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
+0007da00: 3d20 303b 0a23 6966 2064 6566 696e 6564  = 0;.#if defined
+0007da10: 2847 474d 4c5f 5553 455f 4143 4345 4c45  (GGML_USE_ACCELE
+0007da20: 5241 5445 2920 7c7c 2064 6566 696e 6564  RATE) || defined
+0007da30: 2847 474d 4c5f 5553 455f 4f50 454e 424c  (GGML_USE_OPENBL
+0007da40: 4153 290a 2020 2020 2020 2020 2020 2020  AS).            
+0007da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007da60: 6966 2028 6767 6d6c 5f63 6f6d 7075 7465  if (ggml_compute
+0007da70: 5f66 6f72 7761 7264 5f6d 756c 5f6d 6174  _forward_mul_mat
+0007da80: 5f75 7365 5f62 6c61 7328 6e6f 6465 2d3e  _use_blas(node->
+0007da90: 7372 6330 2c20 6e6f 6465 2d3e 7372 6331  src0, node->src1
+0007daa0: 2c20 6e6f 6465 2929 207b 0a20 2020 2020  , node)) {.     
+0007dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dac0: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+0007dad0: 3e6e 5f74 6173 6b73 203d 2031 3b0a 2020  >n_tasks = 1;.  
+0007dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007daf0: 2020 2020 2020 2020 2020 7d0a 2365 6e64            }.#end
+0007db00: 6966 0a20 2020 2020 2020 2020 2020 2020  if.             
+0007db10: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
+0007db20: 6520 6966 2028 6767 6d6c 5f69 735f 7175  e if (ggml_is_qu
+0007db30: 616e 7469 7a65 6428 6e6f 6465 2d3e 7372  antized(node->sr
+0007db40: 6330 2d3e 7479 7065 2920 2626 206e 6f64  c0->type) && nod
+0007db50: 652d 3e73 7263 312d 3e74 7970 6520 3d3d  e->src1->type ==
+0007db60: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
+0007db70: 7b0a 2369 6620 6465 6669 6e65 6428 4747  {.#if defined(GG
+0007db80: 4d4c 5f55 5345 5f41 4343 454c 4552 4154  ML_USE_ACCELERAT
+0007db90: 4529 207c 7c20 6465 6669 6e65 6428 4747  E) || defined(GG
+0007dba0: 4d4c 5f55 5345 5f4f 5045 4e42 4c41 5329  ML_USE_OPENBLAS)
+0007dbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007dbc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0007dbd0: 2867 676d 6c5f 636f 6d70 7574 655f 666f  (ggml_compute_fo
+0007dbe0: 7277 6172 645f 6d75 6c5f 6d61 745f 7573  rward_mul_mat_us
+0007dbf0: 655f 626c 6173 286e 6f64 652d 3e73 7263  e_blas(node->src
+0007dc00: 302c 206e 6f64 652d 3e73 7263 312c 206e  0, node->src1, n
+0007dc10: 6f64 6529 2920 7b0a 2020 2020 2020 2020  ode)) {.        
 0007dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dc30: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-0007dc40: 3e6e 5f74 6173 6b73 203d 2031 3b0a 2020  >n_tasks = 1;.  
+0007dc30: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
+0007dc40: 7461 736b 7320 3d20 313b 0a20 2020 2020  tasks = 1;.     
 0007dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dc60: 2020 2020 2020 2020 2020 7d0a 2365 6e64            }.#end
-0007dc70: 6966 0a20 2020 2020 2020 2020 2020 2020  if.             
-0007dc80: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-0007dc90: 6520 6966 2028 6767 6d6c 5f69 735f 7175  e if (ggml_is_qu
-0007dca0: 616e 7469 7a65 6428 6e6f 6465 2d3e 7372  antized(node->sr
-0007dcb0: 6330 2d3e 7479 7065 2920 2626 206e 6f64  c0->type) && nod
-0007dcc0: 652d 3e73 7263 312d 3e74 7970 6520 3d3d  e->src1->type ==
-0007dcd0: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
-0007dce0: 7b0a 2369 6620 6465 6669 6e65 6428 4747  {.#if defined(GG
-0007dcf0: 4d4c 5f55 5345 5f41 4343 454c 4552 4154  ML_USE_ACCELERAT
-0007dd00: 4529 207c 7c20 6465 6669 6e65 6428 4747  E) || defined(GG
-0007dd10: 4d4c 5f55 5345 5f4f 5045 4e42 4c41 5329  ML_USE_OPENBLAS)
-0007dd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007dd30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0007dd40: 2867 676d 6c5f 636f 6d70 7574 655f 666f  (ggml_compute_fo
-0007dd50: 7277 6172 645f 6d75 6c5f 6d61 745f 7573  rward_mul_mat_us
-0007dd60: 655f 626c 6173 286e 6f64 652d 3e73 7263  e_blas(node->src
-0007dd70: 302c 206e 6f64 652d 3e73 7263 312c 206e  0, node->src1, n
-0007dd80: 6f64 6529 2920 7b0a 2020 2020 2020 2020  ode)) {.        
-0007dd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dda0: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
-0007ddb0: 7461 736b 7320 3d20 313b 0a20 2020 2020  tasks = 1;.     
-0007ddc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ddd0: 2020 2020 2020 2020 2020 2063 7572 203d             cur =
-0007dde0: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
-0007ddf0: 4747 4d4c 5f54 5950 455f 4633 325d 2a28  GGML_TYPE_F32]*(
-0007de00: 6e6f 6465 2d3e 7372 6330 2d3e 6e65 5b30  node->src0->ne[0
-0007de10: 5d2a 6e6f 6465 2d3e 7372 6330 2d3e 6e65  ]*node->src0->ne
-0007de20: 5b31 5d29 3b0a 2020 2020 2020 2020 2020  [1]);.          
-0007de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007de40: 2020 7d20 656c 7365 0a23 656e 6469 660a    } else.#endif.
+0007dc60: 2020 2020 2020 2020 2020 2063 7572 203d             cur =
+0007dc70: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
+0007dc80: 4747 4d4c 5f54 5950 455f 4633 325d 2a28  GGML_TYPE_F32]*(
+0007dc90: 6e6f 6465 2d3e 7372 6330 2d3e 6e65 5b30  node->src0->ne[0
+0007dca0: 5d2a 6e6f 6465 2d3e 7372 6330 2d3e 6e65  ]*node->src0->ne
+0007dcb0: 5b31 5d29 3b0a 2020 2020 2020 2020 2020  [1]);.          
+0007dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dcd0: 2020 7d20 656c 7365 0a23 656e 6469 660a    } else.#endif.
+0007dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dcf0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0007dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dd10: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0007dd20: 6e73 7420 656e 756d 2067 676d 6c5f 7479  nst enum ggml_ty
+0007dd30: 7065 2074 7970 655f 7120 3d20 7175 616e  pe type_q = quan
+0007dd40: 7469 7a65 5f66 6e73 5b6e 6f64 652d 3e73  tize_fns[node->s
+0007dd50: 7263 302d 3e74 7970 655d 2e76 6563 5f64  rc0->type].vec_d
+0007dd60: 6f74 5f74 7970 653b 0a20 2020 2020 2020  ot_type;.       
+0007dd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dd80: 2020 2020 2020 2020 2063 7572 203d 2047           cur = G
+0007dd90: 474d 4c5f 5459 5045 5f53 495a 455b 7479  GML_TYPE_SIZE[ty
+0007dda0: 7065 5f71 5d2a 6767 6d6c 5f6e 656c 656d  pe_q]*ggml_nelem
+0007ddb0: 656e 7473 286e 6f64 652d 3e73 7263 3129  ents(node->src1)
+0007ddc0: 2f47 474d 4c5f 424c 434b 5f53 495a 455b  /GGML_BLCK_SIZE[
+0007ddd0: 7479 7065 5f71 5d3b 0a20 2020 2020 2020  type_q];.       
+0007dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ddf0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0007de00: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0007de10: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+0007de20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007de30: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0007de40: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
 0007de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007de60: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0007de70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007de80: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0007de90: 6e73 7420 656e 756d 2067 676d 6c5f 7479  nst enum ggml_ty
-0007dea0: 7065 2074 7970 655f 7120 3d20 7175 616e  pe type_q = quan
-0007deb0: 7469 7a65 5f66 6e73 5b6e 6f64 652d 3e73  tize_fns[node->s
-0007dec0: 7263 302d 3e74 7970 655d 2e76 6563 5f64  rc0->type].vec_d
-0007ded0: 6f74 5f74 7970 653b 0a20 2020 2020 2020  ot_type;.       
+0007de60: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+0007de70: 2020 2020 2020 2020 2020 2077 6f72 6b5f             work_
+0007de80: 7369 7a65 203d 204d 4158 2877 6f72 6b5f  size = MAX(work_
+0007de90: 7369 7a65 2c20 6375 7229 3b0a 2020 2020  size, cur);.    
+0007dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007deb0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007dec0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+0007ded0: 4d4c 5f4f 505f 5343 414c 453a 0a20 2020  ML_OP_SCALE:.   
 0007dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007def0: 2020 2020 2020 2020 2063 7572 203d 2047           cur = G
-0007df00: 474d 4c5f 5459 5045 5f53 495a 455b 7479  GML_TYPE_SIZE[ty
-0007df10: 7065 5f71 5d2a 6767 6d6c 5f6e 656c 656d  pe_q]*ggml_nelem
-0007df20: 656e 7473 286e 6f64 652d 3e73 7263 3129  ents(node->src1)
-0007df30: 2f47 474d 4c5f 424c 434b 5f53 495a 455b  /GGML_BLCK_SIZE[
-0007df40: 7479 7065 5f71 5d3b 0a20 2020 2020 2020  type_q];.       
-0007df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007df60: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0007df70: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007df80: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-0007df90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dfa0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0007dfb0: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-0007dfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dfd0: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
-0007dfe0: 2020 2020 2020 2020 2020 2077 6f72 6b5f             work_
-0007dff0: 7369 7a65 203d 204d 4158 2877 6f72 6b5f  size = MAX(work_
-0007e000: 7369 7a65 2c20 6375 7229 3b0a 2020 2020  size, cur);.    
-0007e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e020: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007e030: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-0007e040: 4d4c 5f4f 505f 5343 414c 453a 0a20 2020  ML_OP_SCALE:.   
-0007e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e060: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007e070: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-0007e080: 3e6e 5f74 6173 6b73 203d 206e 5f74 6872  >n_tasks = n_thr
-0007e090: 6561 6473 3b0a 2020 2020 2020 2020 2020  eads;.          
-0007e0a0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0007e0b0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-0007e0c0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007e0d0: 5345 543a 0a20 2020 2020 2020 2020 2020  SET:.           
-0007e0e0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007e0f0: 505f 434f 4e54 3a0a 2020 2020 2020 2020  P_CONT:.        
-0007e100: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007e110: 4c5f 4f50 5f52 4553 4841 5045 3a0a 2020  L_OP_RESHAPE:.  
-0007e120: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-0007e130: 7365 2047 474d 4c5f 4f50 5f56 4945 573a  se GGML_OP_VIEW:
-0007e140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007e150: 2063 6173 6520 4747 4d4c 5f4f 505f 5045   case GGML_OP_PE
-0007e160: 524d 5554 453a 0a20 2020 2020 2020 2020  RMUTE:.         
-0007e170: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0007e180: 5f4f 505f 5452 414e 5350 4f53 453a 0a20  _OP_TRANSPOSE:. 
-0007e190: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0007e1a0: 6173 6520 4747 4d4c 5f4f 505f 4745 545f  ase GGML_OP_GET_
-0007e1b0: 524f 5753 3a0a 2020 2020 2020 2020 2020  ROWS:.          
-0007e1c0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0007e1d0: 4f50 5f47 4554 5f52 4f57 535f 4241 434b  OP_GET_ROWS_BACK
-0007e1e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0007e1f0: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
-0007e200: 4941 473a 0a20 2020 2020 2020 2020 2020  IAG:.           
-0007e210: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007e220: 505f 4449 4147 5f4d 4153 4b5f 5a45 524f  P_DIAG_MASK_ZERO
-0007e230: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0007e240: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0007def0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007df00: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+0007df10: 3e6e 5f74 6173 6b73 203d 206e 5f74 6872  >n_tasks = n_thr
+0007df20: 6561 6473 3b0a 2020 2020 2020 2020 2020  eads;.          
+0007df30: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0007df40: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+0007df50: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007df60: 5345 543a 0a20 2020 2020 2020 2020 2020  SET:.           
+0007df70: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007df80: 505f 434f 4e54 3a0a 2020 2020 2020 2020  P_CONT:.        
+0007df90: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007dfa0: 4c5f 4f50 5f52 4553 4841 5045 3a0a 2020  L_OP_RESHAPE:.  
+0007dfb0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0007dfc0: 7365 2047 474d 4c5f 4f50 5f56 4945 573a  se GGML_OP_VIEW:
+0007dfd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007dfe0: 2063 6173 6520 4747 4d4c 5f4f 505f 5045   case GGML_OP_PE
+0007dff0: 524d 5554 453a 0a20 2020 2020 2020 2020  RMUTE:.         
+0007e000: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0007e010: 5f4f 505f 5452 414e 5350 4f53 453a 0a20  _OP_TRANSPOSE:. 
+0007e020: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007e030: 6173 6520 4747 4d4c 5f4f 505f 4745 545f  ase GGML_OP_GET_
+0007e040: 524f 5753 3a0a 2020 2020 2020 2020 2020  ROWS:.          
+0007e050: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0007e060: 4f50 5f47 4554 5f52 4f57 535f 4241 434b  OP_GET_ROWS_BACK
+0007e070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0007e080: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
+0007e090: 4941 473a 0a20 2020 2020 2020 2020 2020  IAG:.           
+0007e0a0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007e0b0: 505f 4449 4147 5f4d 4153 4b5f 5a45 524f  P_DIAG_MASK_ZERO
+0007e0c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0007e0d0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0007e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e0f0: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
+0007e100: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
+0007e110: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0007e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e130: 6361 7365 2047 474d 4c5f 4f50 5f44 4941  case GGML_OP_DIA
+0007e140: 475f 4d41 534b 5f49 4e46 3a0a 2020 2020  G_MASK_INF:.    
+0007e150: 2020 2020 2020 2020 2020 2020 6361 7365              case
+0007e160: 2047 474d 4c5f 4f50 5f53 4f46 545f 4d41   GGML_OP_SOFT_MA
+0007e170: 583a 0a20 2020 2020 2020 2020 2020 2020  X:.             
+0007e180: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007e190: 534f 4654 5f4d 4158 5f42 4143 4b3a 0a20  SOFT_MAX_BACK:. 
+0007e1a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007e1b0: 6173 6520 4747 4d4c 5f4f 505f 524f 5045  ase GGML_OP_ROPE
+0007e1c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0007e1d0: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
+0007e1e0: 4f50 455f 4241 434b 3a0a 2020 2020 2020  OPE_BACK:.      
+0007e1f0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+0007e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e210: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
+0007e220: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
+0007e230: 733b 0a20 2020 2020 2020 2020 2020 2020  s;.             
+0007e240: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
 0007e250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e260: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-0007e270: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
-0007e280: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0007e260: 6361 7365 2047 474d 4c5f 4f50 5f41 4c49  case GGML_OP_ALI
+0007e270: 4249 3a0a 2020 2020 2020 2020 2020 2020  BI:.            
+0007e280: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
 0007e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e2a0: 6361 7365 2047 474d 4c5f 4f50 5f44 4941  case GGML_OP_DIA
-0007e2b0: 475f 4d41 534b 5f49 4e46 3a0a 2020 2020  G_MASK_INF:.    
-0007e2c0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-0007e2d0: 2047 474d 4c5f 4f50 5f53 4f46 545f 4d41   GGML_OP_SOFT_MA
-0007e2e0: 583a 0a20 2020 2020 2020 2020 2020 2020  X:.             
-0007e2f0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007e300: 534f 4654 5f4d 4158 5f42 4143 4b3a 0a20  SOFT_MAX_BACK:. 
-0007e310: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0007e320: 6173 6520 4747 4d4c 5f4f 505f 524f 5045  ase GGML_OP_ROPE
-0007e330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0007e340: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-0007e350: 4f50 455f 4241 434b 3a0a 2020 2020 2020  OPE_BACK:.      
-0007e360: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-0007e370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e380: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
-0007e390: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
-0007e3a0: 733b 0a20 2020 2020 2020 2020 2020 2020  s;.             
-0007e3b0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0007e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e3d0: 6361 7365 2047 474d 4c5f 4f50 5f41 4c49  case GGML_OP_ALI
-0007e3e0: 4249 3a0a 2020 2020 2020 2020 2020 2020  BI:.            
-0007e3f0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007e2a0: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
+0007e2b0: 3d20 313b 202f 2f54 4f44 4f0a 2020 2020  = 1; //TODO.    
+0007e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e2d0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007e2e0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+0007e2f0: 4d4c 5f4f 505f 434c 414d 503a 0a20 2020  ML_OP_CLAMP:.   
+0007e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e310: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007e320: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+0007e330: 3e6e 5f74 6173 6b73 203d 2031 3b20 2f2f  >n_tasks = 1; //
+0007e340: 544f 444f 0a20 2020 2020 2020 2020 2020  TODO.           
+0007e350: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0007e360: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007e370: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
+0007e380: 4f4e 565f 3144 5f31 533a 0a20 2020 2020  ONV_1D_1S:.     
+0007e390: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+0007e3a0: 4747 4d4c 5f4f 505f 434f 4e56 5f31 445f  GGML_OP_CONV_1D_
+0007e3b0: 3253 3a0a 2020 2020 2020 2020 2020 2020  2S:.            
+0007e3c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e3e0: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
+0007e3f0: 3d20 6e5f 7468 7265 6164 733b 0a0a 2020  = n_threads;..  
 0007e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e410: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
-0007e420: 3d20 313b 202f 2f54 4f44 4f0a 2020 2020  = 1; //TODO.    
-0007e430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e440: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007e450: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-0007e460: 4d4c 5f4f 505f 434c 414d 503a 0a20 2020  ML_OP_CLAMP:.   
-0007e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e480: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007e490: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-0007e4a0: 3e6e 5f74 6173 6b73 203d 2031 3b20 2f2f  >n_tasks = 1; //
-0007e4b0: 544f 444f 0a20 2020 2020 2020 2020 2020  TODO.           
-0007e4c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0007e4d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007e4e0: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
-0007e4f0: 4f4e 565f 3144 5f31 533a 0a20 2020 2020  ONV_1D_1S:.     
-0007e500: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-0007e510: 4747 4d4c 5f4f 505f 434f 4e56 5f31 445f  GGML_OP_CONV_1D_
-0007e520: 3253 3a0a 2020 2020 2020 2020 2020 2020  2S:.            
-0007e530: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007e540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e550: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
-0007e560: 3d20 6e5f 7468 7265 6164 733b 0a0a 2020  = n_threads;..  
-0007e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e580: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0007e590: 5428 6e6f 6465 2d3e 7372 6330 2d3e 6e65  T(node->src0->ne
-0007e5a0: 5b33 5d20 3d3d 2031 293b 0a20 2020 2020  [3] == 1);.     
-0007e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e5c0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0007e5d0: 6f64 652d 3e73 7263 312d 3e6e 655b 325d  ode->src1->ne[2]
-0007e5e0: 203d 3d20 3129 3b0a 2020 2020 2020 2020   == 1);.        
-0007e5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e600: 4747 4d4c 5f41 5353 4552 5428 6e6f 6465  GGML_ASSERT(node
-0007e610: 2d3e 7372 6331 2d3e 6e65 5b33 5d20 3d3d  ->src1->ne[3] ==
-0007e620: 2031 293b 0a0a 2020 2020 2020 2020 2020   1);..          
-0007e630: 2020 2020 2020 2020 2020 2020 2020 7369                si
-0007e640: 7a65 5f74 2063 7572 203d 2030 3b0a 2020  ze_t cur = 0;.  
-0007e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e660: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0007e670: 6e6b 203d 206e 6f64 652d 3e73 7263 302d  nk = node->src0-
-0007e680: 3e6e 655b 305d 3b0a 0a20 2020 2020 2020  >ne[0];..       
+0007e410: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0007e420: 5428 6e6f 6465 2d3e 7372 6330 2d3e 6e65  T(node->src0->ne
+0007e430: 5b33 5d20 3d3d 2031 293b 0a20 2020 2020  [3] == 1);.     
+0007e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e450: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0007e460: 6f64 652d 3e73 7263 312d 3e6e 655b 325d  ode->src1->ne[2]
+0007e470: 203d 3d20 3129 3b0a 2020 2020 2020 2020   == 1);.        
+0007e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e490: 4747 4d4c 5f41 5353 4552 5428 6e6f 6465  GGML_ASSERT(node
+0007e4a0: 2d3e 7372 6331 2d3e 6e65 5b33 5d20 3d3d  ->src1->ne[3] ==
+0007e4b0: 2031 293b 0a0a 2020 2020 2020 2020 2020   1);..          
+0007e4c0: 2020 2020 2020 2020 2020 2020 2020 7369                si
+0007e4d0: 7a65 5f74 2063 7572 203d 2030 3b0a 2020  ze_t cur = 0;.  
+0007e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e4f0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0007e500: 6e6b 203d 206e 6f64 652d 3e73 7263 302d  nk = node->src0-
+0007e510: 3e6e 655b 305d 3b0a 0a20 2020 2020 2020  >ne[0];..       
+0007e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e530: 2069 6620 286e 6f64 652d 3e73 7263 302d   if (node->src0-
+0007e540: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+0007e550: 5045 5f46 3136 2026 260a 2020 2020 2020  PE_F16 &&.      
+0007e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e570: 2020 2020 2020 6e6f 6465 2d3e 7372 6331        node->src1
+0007e580: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0007e590: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
+0007e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e5b0: 2020 2020 2020 2063 7572 203d 2073 697a         cur = siz
+0007e5c0: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
+0007e5d0: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
+0007e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e5f0: 2020 2020 2020 206e 6b2a 6767 6d6c 5f75         nk*ggml_u
+0007e600: 7033 3228 6e6f 6465 2d3e 7372 6330 2d3e  p32(node->src0->
+0007e610: 6e65 5b31 5d29 2a6e 6f64 652d 3e73 7263  ne[1])*node->src
+0007e620: 302d 3e6e 655b 325d 202b 0a20 2020 2020  0->ne[2] +.     
+0007e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e640: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0007e650: 2032 2a28 6e6b 2f32 2920 2b20 6e6f 6465   2*(nk/2) + node
+0007e660: 2d3e 7372 6331 2d3e 6e65 5b30 5d29 2a6e  ->src1->ne[0])*n
+0007e670: 6f64 652d 3e73 7263 312d 3e6e 655b 315d  ode->src1->ne[1]
+0007e680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0007e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e6a0: 2069 6620 286e 6f64 652d 3e73 7263 302d   if (node->src0-
-0007e6b0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-0007e6c0: 5045 5f46 3136 2026 260a 2020 2020 2020  PE_F16 &&.      
-0007e6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e6e0: 2020 2020 2020 6e6f 6465 2d3e 7372 6331        node->src1
-0007e6f0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0007e700: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
-0007e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e720: 2020 2020 2020 2063 7572 203d 2073 697a         cur = siz
-0007e730: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
-0007e740: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
-0007e750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e760: 2020 2020 2020 206e 6b2a 6767 6d6c 5f75         nk*ggml_u
-0007e770: 7033 3228 6e6f 6465 2d3e 7372 6330 2d3e  p32(node->src0->
-0007e780: 6e65 5b31 5d29 2a6e 6f64 652d 3e73 7263  ne[1])*node->src
-0007e790: 302d 3e6e 655b 325d 202b 0a20 2020 2020  0->ne[2] +.     
-0007e7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e7b0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0007e7c0: 2032 2a28 6e6b 2f32 2920 2b20 6e6f 6465   2*(nk/2) + node
-0007e7d0: 2d3e 7372 6331 2d3e 6e65 5b30 5d29 2a6e  ->src1->ne[0])*n
-0007e7e0: 6f64 652d 3e73 7263 312d 3e6e 655b 315d  ode->src1->ne[1]
-0007e7f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e810: 2020 2020 2029 3b0a 2020 2020 2020 2020       );.        
+0007e6a0: 2020 2020 2029 3b0a 2020 2020 2020 2020       );.        
+0007e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e6c0: 7d20 656c 7365 2069 6620 286e 6f64 652d  } else if (node-
+0007e6d0: 3e73 7263 302d 3e74 7970 6520 3d3d 2047  >src0->type == G
+0007e6e0: 474d 4c5f 5459 5045 5f46 3332 2026 260a  GML_TYPE_F32 &&.
+0007e6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e710: 2020 206e 6f64 652d 3e73 7263 312d 3e74     node->src1->t
+0007e720: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+0007e730: 5f46 3332 2920 7b0a 2020 2020 2020 2020  _F32) {.        
+0007e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e750: 2020 2020 6375 7220 3d20 7369 7a65 6f66      cur = sizeof
+0007e760: 2866 6c6f 6174 292a 280a 2020 2020 2020  (float)*(.      
+0007e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e780: 2020 2020 2020 2020 2020 2020 2020 6e6b                nk
+0007e790: 2a67 676d 6c5f 7570 3332 286e 6f64 652d  *ggml_up32(node-
+0007e7a0: 3e73 7263 302d 3e6e 655b 315d 292a 6e6f  >src0->ne[1])*no
+0007e7b0: 6465 2d3e 7372 6330 2d3e 6e65 5b32 5d20  de->src0->ne[2] 
+0007e7c0: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
+0007e7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e7e0: 2020 2020 2020 2820 322a 286e 6b2f 3229        ( 2*(nk/2)
+0007e7f0: 202b 206e 6f64 652d 3e73 7263 312d 3e6e   + node->src1->n
+0007e800: 655b 305d 292a 6e6f 6465 2d3e 7372 6331  e[0])*node->src1
+0007e810: 2d3e 6e65 5b31 5d0a 2020 2020 2020 2020  ->ne[1].        
 0007e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e830: 7d20 656c 7365 2069 6620 286e 6f64 652d  } else if (node-
-0007e840: 3e73 7263 302d 3e74 7970 6520 3d3d 2047  >src0->type == G
-0007e850: 474d 4c5f 5459 5045 5f46 3332 2026 260a  GML_TYPE_F32 &&.
+0007e830: 2020 2020 2020 2020 2020 2020 293b 0a20              );. 
+0007e840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e850: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
 0007e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e880: 2020 206e 6f64 652d 3e73 7263 312d 3e74     node->src1->t
-0007e890: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-0007e8a0: 5f46 3332 2920 7b0a 2020 2020 2020 2020  _F32) {.        
+0007e870: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+0007e880: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+0007e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e8a0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
 0007e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e8c0: 2020 2020 6375 7220 3d20 7369 7a65 6f66      cur = sizeof
-0007e8d0: 2866 6c6f 6174 292a 280a 2020 2020 2020  (float)*(.      
-0007e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e8f0: 2020 2020 2020 2020 2020 2020 2020 6e6b                nk
-0007e900: 2a67 676d 6c5f 7570 3332 286e 6f64 652d  *ggml_up32(node-
-0007e910: 3e73 7263 302d 3e6e 655b 315d 292a 6e6f  >src0->ne[1])*no
-0007e920: 6465 2d3e 7372 6330 2d3e 6e65 5b32 5d20  de->src0->ne[2] 
-0007e930: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
+0007e8c0: 2020 2077 6f72 6b5f 7369 7a65 203d 204d     work_size = M
+0007e8d0: 4158 2877 6f72 6b5f 7369 7a65 2c20 6375  AX(work_size, cu
+0007e8e0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+0007e8f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0007e900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007e910: 2063 6173 6520 4747 4d4c 5f4f 505f 464c   case GGML_OP_FL
+0007e920: 4153 485f 4154 544e 3a0a 2020 2020 2020  ASH_ATTN:.      
+0007e930: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
 0007e940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e950: 2020 2020 2020 2820 322a 286e 6b2f 3229        ( 2*(nk/2)
-0007e960: 202b 206e 6f64 652d 3e73 7263 312d 3e6e   + node->src1->n
-0007e970: 655b 305d 292a 6e6f 6465 2d3e 7372 6331  e[0])*node->src1
-0007e980: 2d3e 6e65 5b31 5d0a 2020 2020 2020 2020  ->ne[1].        
-0007e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e9a0: 2020 2020 2020 2020 2020 2020 293b 0a20              );. 
-0007e9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e9c0: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-0007e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e9e0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0007e9f0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+0007e950: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
+0007e960: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
+0007e970: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
+0007e980: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+0007e990: 5f74 2063 7572 203d 2030 3b0a 0a20 2020  _t cur = 0;..   
+0007e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e9b0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
+0007e9c0: 5f74 206e 6531 3120 3d20 6767 6d6c 5f75  _t ne11 = ggml_u
+0007e9d0: 7028 6e6f 6465 2d3e 7372 6331 2d3e 6e65  p(node->src1->ne
+0007e9e0: 5b31 5d2c 2047 474d 4c5f 534f 4654 5f4d  [1], GGML_SOFT_M
+0007e9f0: 4158 5f55 4e52 4f4c 4c29 3b0a 0a20 2020  AX_UNROLL);..   
 0007ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ea10: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0007ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ea30: 2020 2077 6f72 6b5f 7369 7a65 203d 204d     work_size = M
-0007ea40: 4158 2877 6f72 6b5f 7369 7a65 2c20 6375  AX(work_size, cu
-0007ea50: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-0007ea60: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0007ea70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007ea80: 2063 6173 6520 4747 4d4c 5f4f 505f 464c   case GGML_OP_FL
-0007ea90: 4153 485f 4154 544e 3a0a 2020 2020 2020  ASH_ATTN:.      
-0007eaa0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+0007ea10: 2020 2020 2069 6620 286e 6f64 652d 3e73       if (node->s
+0007ea20: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
+0007ea30: 4c5f 5459 5045 5f46 3332 2920 7b0a 2020  L_TYPE_F32) {.  
+0007ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ea50: 2020 2020 2020 2020 2020 6375 7220 203d            cur  =
+0007ea60: 2073 697a 656f 6628 666c 6f61 7429 2a6e   sizeof(float)*n
+0007ea70: 6531 312a 6e6f 6465 2d3e 6e5f 7461 736b  e11*node->n_task
+0007ea80: 733b 202f 2f20 544f 444f 3a20 7468 6973  s; // TODO: this
+0007ea90: 2063 616e 2062 6563 6f6d 6520 286e 5f74   can become (n_t
+0007eaa0: 6173 6b73 2d31 290a 2020 2020 2020 2020  asks-1).        
 0007eab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eac0: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
-0007ead0: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
-0007eae0: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
-0007eaf0: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-0007eb00: 5f74 2063 7572 203d 2030 3b0a 0a20 2020  _t cur = 0;..   
+0007eac0: 2020 2020 6375 7220 2b3d 2073 697a 656f      cur += sizeo
+0007ead0: 6628 666c 6f61 7429 2a6e 6531 312a 6e6f  f(float)*ne11*no
+0007eae0: 6465 2d3e 6e5f 7461 736b 733b 202f 2f20  de->n_tasks; // 
+0007eaf0: 7468 6973 2069 7320 6f76 6572 6573 7469  this is overesti
+0007eb00: 6d61 7465 6420 6279 2078 320a 2020 2020  mated by x2.    
 0007eb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eb20: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-0007eb30: 5f74 206e 6531 3120 3d20 6767 6d6c 5f75  _t ne11 = ggml_u
-0007eb40: 7028 6e6f 6465 2d3e 7372 6331 2d3e 6e65  p(node->src1->ne
-0007eb50: 5b31 5d2c 2047 474d 4c5f 534f 4654 5f4d  [1], GGML_SOFT_M
-0007eb60: 4158 5f55 4e52 4f4c 4c29 3b0a 0a20 2020  AX_UNROLL);..   
+0007eb20: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0007eb30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007eb40: 6620 286e 6f64 652d 3e73 7263 312d 3e74  f (node->src1->t
+0007eb50: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+0007eb60: 5f46 3136 2920 7b0a 2020 2020 2020 2020  _F16) {.        
 0007eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eb80: 2020 2020 2069 6620 286e 6f64 652d 3e73       if (node->s
-0007eb90: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
-0007eba0: 4c5f 5459 5045 5f46 3332 2920 7b0a 2020  L_TYPE_F32) {.  
-0007ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ebc0: 2020 2020 2020 2020 2020 6375 7220 203d            cur  =
-0007ebd0: 2073 697a 656f 6628 666c 6f61 7429 2a6e   sizeof(float)*n
-0007ebe0: 6531 312a 6e6f 6465 2d3e 6e5f 7461 736b  e11*node->n_task
-0007ebf0: 733b 202f 2f20 544f 444f 3a20 7468 6973  s; // TODO: this
-0007ec00: 2063 616e 2062 6563 6f6d 6520 286e 5f74   can become (n_t
-0007ec10: 6173 6b73 2d31 290a 2020 2020 2020 2020  asks-1).        
-0007ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ec30: 2020 2020 6375 7220 2b3d 2073 697a 656f      cur += sizeo
-0007ec40: 6628 666c 6f61 7429 2a6e 6531 312a 6e6f  f(float)*ne11*no
-0007ec50: 6465 2d3e 6e5f 7461 736b 733b 202f 2f20  de->n_tasks; // 
-0007ec60: 7468 6973 2069 7320 6f76 6572 6573 7469  this is overesti
-0007ec70: 6d61 7465 6420 6279 2078 320a 2020 2020  mated by x2.    
-0007ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ec90: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-0007eca0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007ecb0: 6620 286e 6f64 652d 3e73 7263 312d 3e74  f (node->src1->t
-0007ecc0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-0007ecd0: 5f46 3136 2920 7b0a 2020 2020 2020 2020  _F16) {.        
-0007ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ecf0: 2020 2020 6375 7220 203d 2073 697a 656f      cur  = sizeo
-0007ed00: 6628 666c 6f61 7429 2a6e 6531 312a 6e6f  f(float)*ne11*no
-0007ed10: 6465 2d3e 6e5f 7461 736b 733b 202f 2f20  de->n_tasks; // 
-0007ed20: 544f 444f 3a20 7468 6973 2063 616e 2062  TODO: this can b
-0007ed30: 6563 6f6d 6520 286e 5f74 6173 6b73 2d31  ecome (n_tasks-1
-0007ed40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0007ed50: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-0007ed60: 7220 2b3d 2073 697a 656f 6628 666c 6f61  r += sizeof(floa
-0007ed70: 7429 2a6e 6531 312a 6e6f 6465 2d3e 6e5f  t)*ne11*node->n_
-0007ed80: 7461 736b 733b 202f 2f20 7468 6973 2069  tasks; // this i
-0007ed90: 7320 6f76 6572 6573 7469 6d61 7465 6420  s overestimated 
-0007eda0: 6279 2078 320a 2020 2020 2020 2020 2020  by x2.          
-0007edb0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0007edc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007edd0: 2020 2020 2020 2020 2077 6f72 6b5f 7369           work_si
-0007ede0: 7a65 203d 204d 4158 2877 6f72 6b5f 7369  ze = MAX(work_si
-0007edf0: 7a65 2c20 6375 7229 3b0a 2020 2020 2020  ze, cur);.      
-0007ee00: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-0007ee10: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-0007ee20: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0007ee30: 5f4f 505f 464c 4153 485f 4646 3a0a 2020  _OP_FLASH_FF:.  
-0007ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ee50: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0007ee60: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-0007ee70: 2d3e 6e5f 7461 736b 7320 3d20 6e5f 7468  ->n_tasks = n_th
-0007ee80: 7265 6164 733b 0a0a 2020 2020 2020 2020  reads;..        
-0007ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eea0: 7369 7a65 5f74 2063 7572 203d 2030 3b0a  size_t cur = 0;.
-0007eeb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007eec0: 2020 2020 2020 2020 2069 6620 286e 6f64           if (nod
-0007eed0: 652d 3e73 7263 312d 3e74 7970 6520 3d3d  e->src1->type ==
-0007eee0: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
-0007eef0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007ef00: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-0007ef10: 7220 203d 2073 697a 656f 6628 666c 6f61  r  = sizeof(floa
-0007ef20: 7429 2a6e 6f64 652d 3e73 7263 312d 3e6e  t)*node->src1->n
-0007ef30: 655b 315d 2a6e 6f64 652d 3e6e 5f74 6173  e[1]*node->n_tas
-0007ef40: 6b73 3b20 2f2f 2054 4f44 4f3a 2074 6869  ks; // TODO: thi
-0007ef50: 7320 6361 6e20 6265 636f 6d65 2028 6e5f  s can become (n_
-0007ef60: 7461 736b 732d 3129 0a20 2020 2020 2020  tasks-1).       
-0007ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ef80: 2020 2020 2063 7572 202b 3d20 7369 7a65       cur += size
-0007ef90: 6f66 2866 6c6f 6174 292a 6e6f 6465 2d3e  of(float)*node->
-0007efa0: 7372 6331 2d3e 6e65 5b31 5d2a 6e6f 6465  src1->ne[1]*node
-0007efb0: 2d3e 6e5f 7461 736b 733b 202f 2f20 7468  ->n_tasks; // th
-0007efc0: 6973 2069 7320 6f76 6572 6573 7469 6d61  is is overestima
-0007efd0: 7465 6420 6279 2078 320a 2020 2020 2020  ted by x2.      
-0007efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eff0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-0007f000: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0007f010: 286e 6f64 652d 3e73 7263 312d 3e74 7970  (node->src1->typ
-0007f020: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-0007f030: 3136 2920 7b0a 2020 2020 2020 2020 2020  16) {.          
-0007f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f050: 2020 6375 7220 203d 2073 697a 656f 6628    cur  = sizeof(
-0007f060: 666c 6f61 7429 2a6e 6f64 652d 3e73 7263  float)*node->src
-0007f070: 312d 3e6e 655b 315d 2a6e 6f64 652d 3e6e  1->ne[1]*node->n
-0007f080: 5f74 6173 6b73 3b20 2f2f 2054 4f44 4f3a  _tasks; // TODO:
-0007f090: 2074 6869 7320 6361 6e20 6265 636f 6d65   this can become
-0007f0a0: 2028 6e5f 7461 736b 732d 3129 0a20 2020   (n_tasks-1).   
-0007f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f0c0: 2020 2020 2020 2020 2063 7572 202b 3d20           cur += 
-0007f0d0: 7369 7a65 6f66 2866 6c6f 6174 292a 6e6f  sizeof(float)*no
-0007f0e0: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d2a  de->src1->ne[1]*
-0007f0f0: 6e6f 6465 2d3e 6e5f 7461 736b 733b 202f  node->n_tasks; /
-0007f100: 2f20 7468 6973 2069 7320 6f76 6572 6573  / this is overes
-0007f110: 7469 6d61 7465 6420 6279 2078 320a 2020  timated by x2.  
-0007f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f130: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0007f140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f150: 2077 6f72 6b5f 7369 7a65 203d 204d 4158   work_size = MAX
-0007f160: 2877 6f72 6b5f 7369 7a65 2c20 6375 7229  (work_size, cur)
-0007f170: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007f180: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0007f190: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0007f1a0: 6173 6520 4747 4d4c 5f4f 505f 464c 4153  ase GGML_OP_FLAS
-0007f1b0: 485f 4154 544e 5f42 4143 4b3a 0a20 2020  H_ATTN_BACK:.   
-0007f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f1d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007f1e0: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-0007f1f0: 3e6e 5f74 6173 6b73 203d 206e 5f74 6872  >n_tasks = n_thr
-0007f200: 6561 6473 3b0a 0a20 2020 2020 2020 2020  eads;..         
-0007f210: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007f220: 697a 655f 7420 6375 7220 3d20 303b 0a0a  ize_t cur = 0;..
-0007f230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f240: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0007f250: 7436 345f 7420 2020 2044 203d 206e 6f64  t64_t    D = nod
-0007f260: 652d 3e73 7263 302d 3e6e 655b 305d 3b0a  e->src0->ne[0];.
-0007f270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f280: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0007f290: 7436 345f 7420 6e65 3131 203d 2067 676d  t64_t ne11 = ggm
-0007f2a0: 6c5f 7570 286e 6f64 652d 3e73 7263 312d  l_up(node->src1-
-0007f2b0: 3e6e 655b 315d 2c20 4747 4d4c 5f53 4f46  >ne[1], GGML_SOF
-0007f2c0: 545f 4d41 585f 554e 524f 4c4c 293b 0a20  T_MAX_UNROLL);. 
-0007f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f2e0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0007f2f0: 3634 5f74 206d 7844 6e20 3d20 4d41 5828  64_t mxDn = MAX(
-0007f300: 442c 206e 6531 3129 202a 2032 3b20 2f2f  D, ne11) * 2; //
-0007f310: 202a 3220 6265 6361 7573 6520 6f66 2053   *2 because of S
-0007f320: 2061 6e64 2053 4d20 696e 2067 676d 6c5f   and SM in ggml_
-0007f330: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0007f340: 666c 6173 685f 6174 746e 5f62 6163 6b0a  flash_attn_back.
+0007eb80: 2020 2020 6375 7220 203d 2073 697a 656f      cur  = sizeo
+0007eb90: 6628 666c 6f61 7429 2a6e 6531 312a 6e6f  f(float)*ne11*no
+0007eba0: 6465 2d3e 6e5f 7461 736b 733b 202f 2f20  de->n_tasks; // 
+0007ebb0: 544f 444f 3a20 7468 6973 2063 616e 2062  TODO: this can b
+0007ebc0: 6563 6f6d 6520 286e 5f74 6173 6b73 2d31  ecome (n_tasks-1
+0007ebd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0007ebe0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+0007ebf0: 7220 2b3d 2073 697a 656f 6628 666c 6f61  r += sizeof(floa
+0007ec00: 7429 2a6e 6531 312a 6e6f 6465 2d3e 6e5f  t)*ne11*node->n_
+0007ec10: 7461 736b 733b 202f 2f20 7468 6973 2069  tasks; // this i
+0007ec20: 7320 6f76 6572 6573 7469 6d61 7465 6420  s overestimated 
+0007ec30: 6279 2078 320a 2020 2020 2020 2020 2020  by x2.          
+0007ec40: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007ec50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ec60: 2020 2020 2020 2020 2077 6f72 6b5f 7369           work_si
+0007ec70: 7a65 203d 204d 4158 2877 6f72 6b5f 7369  ze = MAX(work_si
+0007ec80: 7a65 2c20 6375 7229 3b0a 2020 2020 2020  ze, cur);.      
+0007ec90: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+0007eca0: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+0007ecb0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0007ecc0: 5f4f 505f 464c 4153 485f 4646 3a0a 2020  _OP_FLASH_FF:.  
+0007ecd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ece0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0007ecf0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+0007ed00: 2d3e 6e5f 7461 736b 7320 3d20 6e5f 7468  ->n_tasks = n_th
+0007ed10: 7265 6164 733b 0a0a 2020 2020 2020 2020  reads;..        
+0007ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ed30: 7369 7a65 5f74 2063 7572 203d 2030 3b0a  size_t cur = 0;.
+0007ed40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ed50: 2020 2020 2020 2020 2069 6620 286e 6f64           if (nod
+0007ed60: 652d 3e73 7263 312d 3e74 7970 6520 3d3d  e->src1->type ==
+0007ed70: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
+0007ed80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007ed90: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+0007eda0: 7220 203d 2073 697a 656f 6628 666c 6f61  r  = sizeof(floa
+0007edb0: 7429 2a6e 6f64 652d 3e73 7263 312d 3e6e  t)*node->src1->n
+0007edc0: 655b 315d 2a6e 6f64 652d 3e6e 5f74 6173  e[1]*node->n_tas
+0007edd0: 6b73 3b20 2f2f 2054 4f44 4f3a 2074 6869  ks; // TODO: thi
+0007ede0: 7320 6361 6e20 6265 636f 6d65 2028 6e5f  s can become (n_
+0007edf0: 7461 736b 732d 3129 0a20 2020 2020 2020  tasks-1).       
+0007ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ee10: 2020 2020 2063 7572 202b 3d20 7369 7a65       cur += size
+0007ee20: 6f66 2866 6c6f 6174 292a 6e6f 6465 2d3e  of(float)*node->
+0007ee30: 7372 6331 2d3e 6e65 5b31 5d2a 6e6f 6465  src1->ne[1]*node
+0007ee40: 2d3e 6e5f 7461 736b 733b 202f 2f20 7468  ->n_tasks; // th
+0007ee50: 6973 2069 7320 6f76 6572 6573 7469 6d61  is is overestima
+0007ee60: 7465 6420 6279 2078 320a 2020 2020 2020  ted by x2.      
+0007ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ee80: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+0007ee90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0007eea0: 286e 6f64 652d 3e73 7263 312d 3e74 7970  (node->src1->typ
+0007eeb0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+0007eec0: 3136 2920 7b0a 2020 2020 2020 2020 2020  16) {.          
+0007eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007eee0: 2020 6375 7220 203d 2073 697a 656f 6628    cur  = sizeof(
+0007eef0: 666c 6f61 7429 2a6e 6f64 652d 3e73 7263  float)*node->src
+0007ef00: 312d 3e6e 655b 315d 2a6e 6f64 652d 3e6e  1->ne[1]*node->n
+0007ef10: 5f74 6173 6b73 3b20 2f2f 2054 4f44 4f3a  _tasks; // TODO:
+0007ef20: 2074 6869 7320 6361 6e20 6265 636f 6d65   this can become
+0007ef30: 2028 6e5f 7461 736b 732d 3129 0a20 2020   (n_tasks-1).   
+0007ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ef50: 2020 2020 2020 2020 2063 7572 202b 3d20           cur += 
+0007ef60: 7369 7a65 6f66 2866 6c6f 6174 292a 6e6f  sizeof(float)*no
+0007ef70: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d2a  de->src1->ne[1]*
+0007ef80: 6e6f 6465 2d3e 6e5f 7461 736b 733b 202f  node->n_tasks; /
+0007ef90: 2f20 7468 6973 2069 7320 6f76 6572 6573  / this is overes
+0007efa0: 7469 6d61 7465 6420 6279 2078 320a 2020  timated by x2.  
+0007efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007efc0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0007efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007efe0: 2077 6f72 6b5f 7369 7a65 203d 204d 4158   work_size = MAX
+0007eff0: 2877 6f72 6b5f 7369 7a65 2c20 6375 7229  (work_size, cur)
+0007f000: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007f010: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0007f020: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007f030: 6173 6520 4747 4d4c 5f4f 505f 464c 4153  ase GGML_OP_FLAS
+0007f040: 485f 4154 544e 5f42 4143 4b3a 0a20 2020  H_ATTN_BACK:.   
+0007f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f060: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007f070: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+0007f080: 3e6e 5f74 6173 6b73 203d 206e 5f74 6872  >n_tasks = n_thr
+0007f090: 6561 6473 3b0a 0a20 2020 2020 2020 2020  eads;..         
+0007f0a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007f0b0: 697a 655f 7420 6375 7220 3d20 303b 0a0a  ize_t cur = 0;..
+0007f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f0d0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0007f0e0: 7436 345f 7420 2020 2044 203d 206e 6f64  t64_t    D = nod
+0007f0f0: 652d 3e73 7263 302d 3e6e 655b 305d 3b0a  e->src0->ne[0];.
+0007f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f110: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0007f120: 7436 345f 7420 6e65 3131 203d 2067 676d  t64_t ne11 = ggm
+0007f130: 6c5f 7570 286e 6f64 652d 3e73 7263 312d  l_up(node->src1-
+0007f140: 3e6e 655b 315d 2c20 4747 4d4c 5f53 4f46  >ne[1], GGML_SOF
+0007f150: 545f 4d41 585f 554e 524f 4c4c 293b 0a20  T_MAX_UNROLL);. 
+0007f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f170: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0007f180: 3634 5f74 206d 7844 6e20 3d20 4d41 5828  64_t mxDn = MAX(
+0007f190: 442c 206e 6531 3129 202a 2032 3b20 2f2f  D, ne11) * 2; //
+0007f1a0: 202a 3220 6265 6361 7573 6520 6f66 2053   *2 because of S
+0007f1b0: 2061 6e64 2053 4d20 696e 2067 676d 6c5f   and SM in ggml_
+0007f1c0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0007f1d0: 666c 6173 685f 6174 746e 5f62 6163 6b0a  flash_attn_back.
+0007f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f1f0: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
+0007f200: 2d3e 7372 6331 2d3e 7479 7065 203d 3d20  ->src1->type == 
+0007f210: 4747 4d4c 5f54 5950 455f 4633 3229 207b  GGML_TYPE_F32) {
+0007f220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f230: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+0007f240: 2020 3d20 7369 7a65 6f66 2866 6c6f 6174    = sizeof(float
+0007f250: 292a 6d78 446e 2a6e 6f64 652d 3e6e 5f74  )*mxDn*node->n_t
+0007f260: 6173 6b73 3b20 2f2f 2054 4f44 4f3a 2074  asks; // TODO: t
+0007f270: 6869 7320 6361 6e20 6265 636f 6d65 2028  his can become (
+0007f280: 6e5f 7461 736b 732d 3129 0a20 2020 2020  n_tasks-1).     
+0007f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f2a0: 2020 2020 2020 2063 7572 202b 3d20 7369         cur += si
+0007f2b0: 7a65 6f66 2866 6c6f 6174 292a 6d78 446e  zeof(float)*mxDn
+0007f2c0: 2a6e 6f64 652d 3e6e 5f74 6173 6b73 3b20  *node->n_tasks; 
+0007f2d0: 2f2f 2074 6869 7320 6973 206f 7665 7265  // this is overe
+0007f2e0: 7374 696d 6174 6564 2062 7920 7832 0a20  stimated by x2. 
+0007f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f300: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0007f310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f320: 2020 6966 2028 6e6f 6465 2d3e 7372 6331    if (node->src1
+0007f330: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0007f340: 5950 455f 4631 3629 207b 0a20 2020 2020  YPE_F16) {.     
 0007f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f360: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-0007f370: 2d3e 7372 6331 2d3e 7479 7065 203d 3d20  ->src1->type == 
-0007f380: 4747 4d4c 5f54 5950 455f 4633 3229 207b  GGML_TYPE_F32) {
-0007f390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007f3a0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-0007f3b0: 2020 3d20 7369 7a65 6f66 2866 6c6f 6174    = sizeof(float
-0007f3c0: 292a 6d78 446e 2a6e 6f64 652d 3e6e 5f74  )*mxDn*node->n_t
-0007f3d0: 6173 6b73 3b20 2f2f 2054 4f44 4f3a 2074  asks; // TODO: t
-0007f3e0: 6869 7320 6361 6e20 6265 636f 6d65 2028  his can become (
-0007f3f0: 6e5f 7461 736b 732d 3129 0a20 2020 2020  n_tasks-1).     
-0007f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f410: 2020 2020 2020 2063 7572 202b 3d20 7369         cur += si
-0007f420: 7a65 6f66 2866 6c6f 6174 292a 6d78 446e  zeof(float)*mxDn
-0007f430: 2a6e 6f64 652d 3e6e 5f74 6173 6b73 3b20  *node->n_tasks; 
-0007f440: 2f2f 2074 6869 7320 6973 206f 7665 7265  // this is overe
-0007f450: 7374 696d 6174 6564 2062 7920 7832 0a20  stimated by x2. 
-0007f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f470: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0007f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f490: 2020 6966 2028 6e6f 6465 2d3e 7372 6331    if (node->src1
-0007f4a0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0007f4b0: 5950 455f 4631 3629 207b 0a20 2020 2020  YPE_F16) {.     
-0007f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f4d0: 2020 2020 2020 2063 7572 2020 3d20 7369         cur  = si
-0007f4e0: 7a65 6f66 2866 6c6f 6174 292a 6d78 446e  zeof(float)*mxDn
-0007f4f0: 2a6e 6f64 652d 3e6e 5f74 6173 6b73 3b20  *node->n_tasks; 
-0007f500: 2f2f 2054 4f44 4f3a 2074 6869 7320 6361  // TODO: this ca
-0007f510: 6e20 6265 636f 6d65 2028 6e5f 7461 736b  n become (n_task
-0007f520: 732d 3129 0a20 2020 2020 2020 2020 2020  s-1).           
-0007f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f540: 2063 7572 202b 3d20 7369 7a65 6f66 2866   cur += sizeof(f
-0007f550: 6c6f 6174 292a 6d78 446e 2a6e 6f64 652d  loat)*mxDn*node-
-0007f560: 3e6e 5f74 6173 6b73 3b20 2f2f 2074 6869  >n_tasks; // thi
-0007f570: 7320 6973 206f 7665 7265 7374 696d 6174  s is overestimat
-0007f580: 6564 2062 7920 7832 0a20 2020 2020 2020  ed by x2.       
-0007f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f5a0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-0007f5b0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0007f5c0: 5f73 697a 6520 3d20 4d41 5828 776f 726b  _size = MAX(work
-0007f5d0: 5f73 697a 652c 2063 7572 293b 0a20 2020  _size, cur);.   
-0007f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f5f0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0007f600: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-0007f610: 474d 4c5f 4f50 5f4d 4150 5f55 4e41 5259  GML_OP_MAP_UNARY
-0007f620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0007f630: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
-0007f640: 4150 5f42 494e 4152 593a 0a20 2020 2020  AP_BINARY:.     
-0007f650: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0007f360: 2020 2020 2020 2063 7572 2020 3d20 7369         cur  = si
+0007f370: 7a65 6f66 2866 6c6f 6174 292a 6d78 446e  zeof(float)*mxDn
+0007f380: 2a6e 6f64 652d 3e6e 5f74 6173 6b73 3b20  *node->n_tasks; 
+0007f390: 2f2f 2054 4f44 4f3a 2074 6869 7320 6361  // TODO: this ca
+0007f3a0: 6e20 6265 636f 6d65 2028 6e5f 7461 736b  n become (n_task
+0007f3b0: 732d 3129 0a20 2020 2020 2020 2020 2020  s-1).           
+0007f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f3d0: 2063 7572 202b 3d20 7369 7a65 6f66 2866   cur += sizeof(f
+0007f3e0: 6c6f 6174 292a 6d78 446e 2a6e 6f64 652d  loat)*mxDn*node-
+0007f3f0: 3e6e 5f74 6173 6b73 3b20 2f2f 2074 6869  >n_tasks; // thi
+0007f400: 7320 6973 206f 7665 7265 7374 696d 6174  s is overestimat
+0007f410: 6564 2062 7920 7832 0a20 2020 2020 2020  ed by x2.       
+0007f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f430: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+0007f440: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0007f450: 5f73 697a 6520 3d20 4d41 5828 776f 726b  _size = MAX(work
+0007f460: 5f73 697a 652c 2063 7572 293b 0a20 2020  _size, cur);.   
+0007f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f480: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0007f490: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+0007f4a0: 474d 4c5f 4f50 5f4d 4150 5f55 4e41 5259  GML_OP_MAP_UNARY
+0007f4b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0007f4c0: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
+0007f4d0: 4150 5f42 494e 4152 593a 0a20 2020 2020  AP_BINARY:.     
+0007f4e0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0007f4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f500: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
+0007f510: 5f74 6173 6b73 203d 2031 3b0a 2020 2020  _tasks = 1;.    
+0007f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f530: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007f540: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+0007f550: 4d4c 5f4f 505f 4352 4f53 535f 454e 5452  ML_OP_CROSS_ENTR
+0007f560: 4f50 595f 4c4f 5353 3a0a 2020 2020 2020  OPY_LOSS:.      
+0007f570: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+0007f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f590: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
+0007f5a0: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
+0007f5b0: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
+0007f5c0: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+0007f5d0: 5f74 2063 7572 203d 2067 676d 6c5f 7479  _t cur = ggml_ty
+0007f5e0: 7065 5f73 697a 6528 6e6f 6465 2d3e 7479  pe_size(node->ty
+0007f5f0: 7065 292a 286e 6f64 652d 3e6e 5f74 6173  pe)*(node->n_tas
+0007f600: 6b73 202b 206e 6f64 652d 3e73 7263 302d  ks + node->src0-
+0007f610: 3e6e 655b 305d 2a6e 6f64 652d 3e6e 5f74  >ne[0]*node->n_t
+0007f620: 6173 6b73 293b 0a0a 2020 2020 2020 2020  asks);..        
+0007f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f640: 776f 726b 5f73 697a 6520 3d20 4d41 5828  work_size = MAX(
+0007f650: 776f 726b 5f73 697a 652c 2063 7572 293b  work_size, cur);
 0007f660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007f670: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
-0007f680: 5f74 6173 6b73 203d 2031 3b0a 2020 2020  _tasks = 1;.    
-0007f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f6a0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007f6b0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-0007f6c0: 4d4c 5f4f 505f 4352 4f53 535f 454e 5452  ML_OP_CROSS_ENTR
-0007f6d0: 4f50 595f 4c4f 5353 3a0a 2020 2020 2020  OPY_LOSS:.      
-0007f6e0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-0007f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f700: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
-0007f710: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
-0007f720: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
-0007f730: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-0007f740: 5f74 2063 7572 203d 2067 676d 6c5f 7479  _t cur = ggml_ty
-0007f750: 7065 5f73 697a 6528 6e6f 6465 2d3e 7479  pe_size(node->ty
-0007f760: 7065 292a 286e 6f64 652d 3e6e 5f74 6173  pe)*(node->n_tas
-0007f770: 6b73 202b 206e 6f64 652d 3e73 7263 302d  ks + node->src0-
-0007f780: 3e6e 655b 305d 2a6e 6f64 652d 3e6e 5f74  >ne[0]*node->n_t
-0007f790: 6173 6b73 293b 0a0a 2020 2020 2020 2020  asks);..        
-0007f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f7b0: 776f 726b 5f73 697a 6520 3d20 4d41 5828  work_size = MAX(
-0007f7c0: 776f 726b 5f73 697a 652c 2063 7572 293b  work_size, cur);
-0007f7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007f7e0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0007f7f0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-0007f800: 7365 2047 474d 4c5f 4f50 5f43 524f 5353  se GGML_OP_CROSS
-0007f810: 5f45 4e54 524f 5059 5f4c 4f53 535f 4241  _ENTROPY_LOSS_BA
-0007f820: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
-0007f830: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f850: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
-0007f860: 3d20 6e5f 7468 7265 6164 733b 0a0a 2020  = n_threads;..  
-0007f870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f880: 2020 2020 2020 7369 7a65 5f74 2063 7572        size_t cur
-0007f890: 203d 2067 676d 6c5f 7479 7065 5f73 697a   = ggml_type_siz
-0007f8a0: 6528 6e6f 6465 2d3e 7479 7065 292a 6e6f  e(node->type)*no
-0007f8b0: 6465 2d3e 7372 6330 2d3e 6e65 5b30 5d2a  de->src0->ne[0]*
-0007f8c0: 6e6f 6465 2d3e 6e5f 7461 736b 733b 0a0a  node->n_tasks;..
-0007f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f8e0: 2020 2020 2020 2020 776f 726b 5f73 697a          work_siz
-0007f8f0: 6520 3d20 4d41 5828 776f 726b 5f73 697a  e = MAX(work_siz
-0007f900: 652c 2063 7572 293b 0a20 2020 2020 2020  e, cur);.       
-0007f910: 2020 2020 2020 2020 2020 2020 207d 2062               } b
-0007f920: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
-0007f930: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0007f940: 4f50 5f4e 4f4e 453a 0a20 2020 2020 2020  OP_NONE:.       
-0007f950: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-0007f960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f970: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
-0007f980: 6173 6b73 203d 2031 3b0a 2020 2020 2020  asks = 1;.      
-0007f990: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-0007f9a0: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-0007f9b0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0007f9c0: 5f4f 505f 434f 554e 543a 0a20 2020 2020  _OP_COUNT:.     
-0007f9d0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0007f9e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007f9f0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-0007fa00: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-0007fa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007fa20: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0007fa30: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0007fa40: 7d0a 0a20 2020 2020 2020 2069 6620 2863  }..        if (c
-0007fa50: 6772 6170 682d 3e77 6f72 6b20 213d 204e  graph->work != N
-0007fa60: 554c 4c20 2626 2077 6f72 6b5f 7369 7a65  ULL && work_size
-0007fa70: 203e 2063 6772 6170 682d 3e77 6f72 6b5f   > cgraph->work_
-0007fa80: 7369 7a65 2920 7b0a 2020 2020 2020 2020  size) {.        
-0007fa90: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0007faa0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-0007fab0: 2062 6574 7465 7220 6861 6e64 6c69 6e67   better handling
-0007fac0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0007fad0: 2020 2020 6966 2028 776f 726b 5f73 697a      if (work_siz
-0007fae0: 6520 3e20 3020 2626 2063 6772 6170 682d  e > 0 && cgraph-
-0007faf0: 3e77 6f72 6b20 3d3d 204e 554c 4c29 207b  >work == NULL) {
-0007fb00: 0a20 2020 2020 2020 2020 2020 2063 6772  .            cgr
-0007fb10: 6170 682d 3e77 6f72 6b5f 7369 7a65 203d  aph->work_size =
-0007fb20: 2077 6f72 6b5f 7369 7a65 202b 2043 4143   work_size + CAC
-0007fb30: 4845 5f4c 494e 455f 5349 5a45 2a28 6e5f  HE_LINE_SIZE*(n_
-0007fb40: 7468 7265 6164 7320 2d20 3129 3b0a 0a20  threads - 1);.. 
-0007fb50: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0007fb60: 5052 494e 545f 4445 4255 4728 2225 733a  PRINT_DEBUG("%s:
-0007fb70: 2061 6c6c 6f63 6174 696e 6720 776f 726b   allocating work
-0007fb80: 2062 7566 6665 7220 666f 7220 6772 6170   buffer for grap
-0007fb90: 6820 2825 7a75 2062 7974 6573 295c 6e22  h (%zu bytes)\n"
-0007fba0: 2c20 5f5f 6675 6e63 5f5f 2c20 6367 7261  , __func__, cgra
-0007fbb0: 7068 2d3e 776f 726b 5f73 697a 6529 3b0a  ph->work_size);.
-0007fbc0: 2020 2020 2020 2020 2020 2020 6367 7261              cgra
-0007fbd0: 7068 2d3e 776f 726b 203d 2067 676d 6c5f  ph->work = ggml_
-0007fbe0: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-0007fbf0: 782c 2047 474d 4c5f 5459 5045 5f49 382c  x, GGML_TYPE_I8,
-0007fc00: 2063 6772 6170 682d 3e77 6f72 6b5f 7369   cgraph->work_si
-0007fc10: 7a65 293b 0a20 2020 2020 2020 207d 0a20  ze);.        }. 
-0007fc20: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
-0007fc30: 696e 7436 345f 7420 7065 7266 5f73 7461  int64_t perf_sta
-0007fc40: 7274 5f63 7963 6c65 7320 203d 2067 676d  rt_cycles  = ggm
-0007fc50: 6c5f 7065 7266 5f63 7963 6c65 7328 293b  l_perf_cycles();
-0007fc60: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-0007fc70: 5f74 2070 6572 665f 7374 6172 745f 7469  _t perf_start_ti
-0007fc80: 6d65 5f75 7320 3d20 6767 6d6c 5f70 6572  me_us = ggml_per
-0007fc90: 665f 7469 6d65 5f75 7328 293b 0a0a 2020  f_time_us();..  
-0007fca0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-0007fcb0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
-0007fcc0: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
-0007fcd0: 2020 2020 2020 4747 4d4c 5f50 5249 4e54        GGML_PRINT
-0007fce0: 5f44 4542 5547 5f35 2822 2573 3a20 2564  _DEBUG_5("%s: %d
-0007fcf0: 2f25 645c 6e22 2c20 5f5f 6675 6e63 5f5f  /%d\n", __func__
-0007fd00: 2c20 692c 2063 6772 6170 682d 3e6e 5f6e  , i, cgraph->n_n
-0007fd10: 6f64 6573 293b 0a0a 2020 2020 2020 2020  odes);..        
-0007fd20: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0007fd30: 6f72 202a 206e 6f64 6520 3d20 6367 7261  or * node = cgra
-0007fd40: 7068 2d3e 6e6f 6465 735b 695d 3b0a 0a20  ph->nodes[i];.. 
-0007fd50: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
-0007fd60: 7468 6973 2063 6f75 6c64 2062 6520 7573  this could be us
-0007fd70: 6564 2074 6f20 6176 6f69 6420 756e 6e65  ed to avoid unne
-0007fd80: 6365 7373 6172 7920 636f 6d70 7574 6174  cessary computat
-0007fd90: 696f 6e73 2c20 6275 7420 6974 206e 6565  ions, but it nee
-0007fda0: 6473 2074 6f20 6265 2069 6d70 726f 7665  ds to be improve
-0007fdb0: 640a 2020 2020 2020 2020 2f2f 6966 2028  d.        //if (
-0007fdc0: 6e6f 6465 2d3e 6772 6164 203d 3d20 4e55  node->grad == NU
-0007fdd0: 4c4c 2026 2620 6e6f 6465 2d3e 7065 7266  LL && node->perf
-0007fde0: 5f72 756e 7320 3e20 3029 207b 0a20 2020  _runs > 0) {.   
-0007fdf0: 2020 2020 202f 2f20 2020 2063 6f6e 7469       //    conti
-0007fe00: 6e75 653b 0a20 2020 2020 2020 202f 2f7d  nue;.        //}
-0007fe10: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
-0007fe20: 696e 7436 345f 7420 7065 7266 5f6e 6f64  int64_t perf_nod
-0007fe30: 655f 7374 6172 745f 6379 636c 6573 2020  e_start_cycles  
-0007fe40: 3d20 6767 6d6c 5f70 6572 665f 6379 636c  = ggml_perf_cycl
-0007fe50: 6573 2829 3b0a 2020 2020 2020 2020 636f  es();.        co
-0007fe60: 6e73 7420 696e 7436 345f 7420 7065 7266  nst int64_t perf
-0007fe70: 5f6e 6f64 655f 7374 6172 745f 7469 6d65  _node_start_time
-0007fe80: 5f75 7320 3d20 6767 6d6c 5f70 6572 665f  _us = ggml_perf_
-0007fe90: 7469 6d65 5f75 7328 293b 0a0a 2020 2020  time_us();..    
-0007fea0: 2020 2020 2f2f 2049 4e49 540a 2020 2020      // INIT.    
-0007feb0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0007fec0: 636f 6d70 7574 655f 7061 7261 6d73 2070  compute_params p
-0007fed0: 6172 616d 7320 3d20 7b0a 2020 2020 2020  arams = {.      
-0007fee0: 2020 2020 2020 2f2a 2e74 7970 6520 203d        /*.type  =
-0007fef0: 2a2f 2047 474d 4c5f 5441 534b 5f49 4e49  */ GGML_TASK_INI
-0007ff00: 542c 0a20 2020 2020 2020 2020 2020 202f  T,.            /
-0007ff10: 2a2e 6974 6820 2020 3d2a 2f20 302c 0a20  *.ith   =*/ 0,. 
-0007ff20: 2020 2020 2020 2020 2020 202f 2a2e 6e74             /*.nt
-0007ff30: 6820 2020 3d2a 2f20 6e6f 6465 2d3e 6e5f  h   =*/ node->n_
-0007ff40: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
-0007ff50: 2020 202f 2a2e 7773 697a 6520 3d2a 2f20     /*.wsize =*/ 
-0007ff60: 6367 7261 7068 2d3e 776f 726b 203f 2067  cgraph->work ? g
-0007ff70: 676d 6c5f 6e62 7974 6573 2863 6772 6170  gml_nbytes(cgrap
-0007ff80: 682d 3e77 6f72 6b29 203a 2030 2c0a 2020  h->work) : 0,.  
-0007ff90: 2020 2020 2020 2020 2020 2f2a 2e77 6461            /*.wda
-0007ffa0: 7461 203d 2a2f 2063 6772 6170 682d 3e77  ta =*/ cgraph->w
-0007ffb0: 6f72 6b20 3f20 6367 7261 7068 2d3e 776f  ork ? cgraph->wo
-0007ffc0: 726b 2d3e 6461 7461 203a 204e 554c 4c2c  rk->data : NULL,
-0007ffd0: 0a20 2020 2020 2020 207d 3b0a 0a20 2020  .        };..   
-0007ffe0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-0007fff0: 655f 666f 7277 6172 6428 2670 6172 616d  e_forward(&param
-00080000: 732c 206e 6f64 6529 3b0a 0a20 2020 2020  s, node);..     
-00080010: 2020 202f 2f20 434f 4d50 5554 450a 2020     // COMPUTE.  
-00080020: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
-00080030: 6e5f 7461 736b 7320 3e20 3129 207b 0a20  n_tasks > 1) {. 
-00080040: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
-00080050: 746f 6d69 635f 6665 7463 685f 6164 6428  tomic_fetch_add(
-00080060: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
-00080070: 7265 6164 792c 2031 2920 3d3d 206e 5f74  ready, 1) == n_t
-00080080: 6872 6561 6473 202d 2031 2920 7b0a 2020  hreads - 1) {.  
-00080090: 2020 2020 2020 2020 2020 2020 2020 6174                at
-000800a0: 6f6d 6963 5f73 746f 7265 2826 7374 6174  omic_store(&stat
-000800b0: 655f 7368 6172 6564 2e68 6173 5f77 6f72  e_shared.has_wor
-000800c0: 6b2c 2066 616c 7365 293b 0a20 2020 2020  k, false);.     
-000800d0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-000800e0: 2020 2020 2020 7768 696c 6520 2861 746f        while (ato
-000800f0: 6d69 635f 6c6f 6164 2826 7374 6174 655f  mic_load(&state_
-00080100: 7368 6172 6564 2e68 6173 5f77 6f72 6b29  shared.has_work)
-00080110: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00080120: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 6c6f      ggml_lock_lo
-00080130: 636b 2020 2826 7374 6174 655f 7368 6172  ck  (&state_shar
-00080140: 6564 2e73 7069 6e29 3b0a 2020 2020 2020  ed.spin);.      
-00080150: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
-00080160: 6f63 6b5f 756e 6c6f 636b 2826 7374 6174  ock_unlock(&stat
-00080170: 655f 7368 6172 6564 2e73 7069 6e29 3b0a  e_shared.spin);.
-00080180: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-00080190: 2020 2020 2020 2020 2020 202f 2f20 6c61             // la
-000801a0: 756e 6368 2074 6872 6561 6420 706f 6f6c  unch thread pool
-000801b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000801c0: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
-000801d0: 206e 5f74 6872 6561 6473 202d 2031 3b20   n_threads - 1; 
-000801e0: 6a2b 2b29 207b 0a20 2020 2020 2020 2020  j++) {.         
-000801f0: 2020 2020 2020 2077 6f72 6b65 7273 5b6a         workers[j
-00080200: 5d2e 7061 7261 6d73 203d 2028 7374 7275  ].params = (stru
-00080210: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00080220: 7061 7261 6d73 2920 7b0a 2020 2020 2020  params) {.      
-00080230: 2020 2020 2020 2020 2020 2020 2020 2e74                .t
-00080240: 7970 6520 203d 2047 474d 4c5f 5441 534b  ype  = GGML_TASK
-00080250: 5f43 4f4d 5055 5445 2c0a 2020 2020 2020  _COMPUTE,.      
-00080260: 2020 2020 2020 2020 2020 2020 2020 2e69                .i
-00080270: 7468 2020 203d 206a 202b 2031 2c0a 2020  th   = j + 1,.  
-00080280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080290: 2020 2e6e 7468 2020 203d 206e 6f64 652d    .nth   = node-
-000802a0: 3e6e 5f74 6173 6b73 2c0a 2020 2020 2020  >n_tasks,.      
-000802b0: 2020 2020 2020 2020 2020 2020 2020 2e77                .w
-000802c0: 7369 7a65 203d 2063 6772 6170 682d 3e77  size = cgraph->w
-000802d0: 6f72 6b20 3f20 6767 6d6c 5f6e 6279 7465  ork ? ggml_nbyte
-000802e0: 7328 6367 7261 7068 2d3e 776f 726b 2920  s(cgraph->work) 
-000802f0: 3a20 302c 0a20 2020 2020 2020 2020 2020  : 0,.           
-00080300: 2020 2020 2020 2020 202e 7764 6174 6120           .wdata 
-00080310: 3d20 6367 7261 7068 2d3e 776f 726b 203f  = cgraph->work ?
-00080320: 2063 6772 6170 682d 3e77 6f72 6b2d 3e64   cgraph->work->d
-00080330: 6174 6120 3a20 4e55 4c4c 2c0a 2020 2020  ata : NULL,.    
-00080340: 2020 2020 2020 2020 2020 2020 7d3b 0a20              };. 
-00080350: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00080360: 6f72 6b65 7273 5b6a 5d2e 6e6f 6465 203d  orkers[j].node =
-00080370: 206e 6f64 653b 0a20 2020 2020 2020 2020   node;.         
-00080380: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00080390: 2020 6174 6f6d 6963 5f66 6574 6368 5f73    atomic_fetch_s
-000803a0: 7562 2826 7374 6174 655f 7368 6172 6564  ub(&state_shared
-000803b0: 2e6e 5f72 6561 6479 2c20 3129 3b0a 0a20  .n_ready, 1);.. 
-000803c0: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-000803d0: 2028 6174 6f6d 6963 5f6c 6f61 6428 2673   (atomic_load(&s
-000803e0: 7461 7465 5f73 6861 7265 642e 6e5f 7265  tate_shared.n_re
-000803f0: 6164 7929 203e 2030 2920 7b0a 2020 2020  ady) > 0) {.    
-00080400: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00080410: 5f6c 6f63 6b5f 6c6f 636b 2020 2826 7374  _lock_lock  (&st
-00080420: 6174 655f 7368 6172 6564 2e73 7069 6e29  ate_shared.spin)
-00080430: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00080440: 2020 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f    ggml_lock_unlo
-00080450: 636b 2826 7374 6174 655f 7368 6172 6564  ck(&state_shared
-00080460: 2e73 7069 6e29 3b0a 2020 2020 2020 2020  .spin);.        
-00080470: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-00080480: 2020 2061 746f 6d69 635f 7374 6f72 6528     atomic_store(
-00080490: 2673 7461 7465 5f73 6861 7265 642e 6861  &state_shared.ha
-000804a0: 735f 776f 726b 2c20 7472 7565 293b 0a20  s_work, true);. 
-000804b0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-000804c0: 2020 7061 7261 6d73 2e74 7970 6520 3d20    params.type = 
-000804d0: 4747 4d4c 5f54 4153 4b5f 434f 4d50 5554  GGML_TASK_COMPUT
-000804e0: 453b 0a20 2020 2020 2020 2067 676d 6c5f  E;.        ggml_
-000804f0: 636f 6d70 7574 655f 666f 7277 6172 6428  compute_forward(
-00080500: 2670 6172 616d 732c 206e 6f64 6529 3b0a  &params, node);.
-00080510: 0a20 2020 2020 2020 202f 2f20 7761 6974  .        // wait
-00080520: 2066 6f72 2074 6872 6561 6420 706f 6f6c   for thread pool
-00080530: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
-00080540: 652d 3e6e 5f74 6173 6b73 203e 2031 2920  e->n_tasks > 1) 
-00080550: 7b0a 2020 2020 2020 2020 2020 2020 6966  {.            if
-00080560: 2028 6174 6f6d 6963 5f66 6574 6368 5f61   (atomic_fetch_a
-00080570: 6464 2826 7374 6174 655f 7368 6172 6564  dd(&state_shared
-00080580: 2e6e 5f72 6561 6479 2c20 3129 203d 3d20  .n_ready, 1) == 
-00080590: 6e5f 7468 7265 6164 7320 2d20 3129 207b  n_threads - 1) {
-000805a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000805b0: 2061 746f 6d69 635f 7374 6f72 6528 2673   atomic_store(&s
-000805c0: 7461 7465 5f73 6861 7265 642e 6861 735f  tate_shared.has_
-000805d0: 776f 726b 2c20 6661 6c73 6529 3b0a 2020  work, false);.  
-000805e0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-000805f0: 2020 2020 2020 2020 2077 6869 6c65 2028           while (
-00080600: 6174 6f6d 6963 5f6c 6f61 6428 2673 7461  atomic_load(&sta
-00080610: 7465 5f73 6861 7265 642e 6861 735f 776f  te_shared.has_wo
-00080620: 726b 2929 207b 0a20 2020 2020 2020 2020  rk)) {.         
-00080630: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
-00080640: 5f6c 6f63 6b20 2028 2673 7461 7465 5f73  _lock  (&state_s
-00080650: 6861 7265 642e 7370 696e 293b 0a20 2020  hared.spin);.   
-00080660: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00080670: 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28 2673  l_lock_unlock(&s
-00080680: 7461 7465 5f73 6861 7265 642e 7370 696e  tate_shared.spin
-00080690: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000806a0: 0a0a 2020 2020 2020 2020 2020 2020 6174  ..            at
-000806b0: 6f6d 6963 5f66 6574 6368 5f73 7562 2826  omic_fetch_sub(&
-000806c0: 7374 6174 655f 7368 6172 6564 2e6e 5f72  state_shared.n_r
-000806d0: 6561 6479 2c20 3129 3b0a 0a20 2020 2020  eady, 1);..     
-000806e0: 2020 2020 2020 2077 6869 6c65 2028 6174         while (at
-000806f0: 6f6d 6963 5f6c 6f61 6428 2673 7461 7465  omic_load(&state
-00080700: 5f73 6861 7265 642e 6e5f 7265 6164 7929  _shared.n_ready)
-00080710: 2021 3d20 3029 207b 0a20 2020 2020 2020   != 0) {.       
-00080720: 2020 2020 2020 2020 2067 676d 6c5f 6c6f           ggml_lo
-00080730: 636b 5f6c 6f63 6b20 2028 2673 7461 7465  ck_lock  (&state
-00080740: 5f73 6861 7265 642e 7370 696e 293b 0a20  _shared.spin);. 
-00080750: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00080760: 676d 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28  gml_lock_unlock(
-00080770: 2673 7461 7465 5f73 6861 7265 642e 7370  &state_shared.sp
-00080780: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
-00080790: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-000807a0: 2020 2020 2020 2f2f 2046 494e 414c 495a        // FINALIZ
-000807b0: 450a 2020 2020 2020 2020 6966 2028 6e6f  E.        if (no
-000807c0: 6465 2d3e 6e5f 7461 736b 7320 3e20 3129  de->n_tasks > 1)
-000807d0: 207b 0a20 2020 2020 2020 2020 2020 2069   {.            i
-000807e0: 6620 2861 746f 6d69 635f 6665 7463 685f  f (atomic_fetch_
-000807f0: 6164 6428 2673 7461 7465 5f73 6861 7265  add(&state_share
-00080800: 642e 6e5f 7265 6164 792c 2031 2920 3d3d  d.n_ready, 1) ==
-00080810: 206e 5f74 6872 6561 6473 202d 2031 2920   n_threads - 1) 
-00080820: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00080830: 2020 6174 6f6d 6963 5f73 746f 7265 2826    atomic_store(&
-00080840: 7374 6174 655f 7368 6172 6564 2e68 6173  state_shared.has
-00080850: 5f77 6f72 6b2c 2066 616c 7365 293b 0a20  _work, false);. 
-00080860: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00080870: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-00080880: 2861 746f 6d69 635f 6c6f 6164 2826 7374  (atomic_load(&st
-00080890: 6174 655f 7368 6172 6564 2e68 6173 5f77  ate_shared.has_w
-000808a0: 6f72 6b29 2920 7b0a 2020 2020 2020 2020  ork)) {.        
-000808b0: 2020 2020 2020 2020 6767 6d6c 5f6c 6f63          ggml_loc
-000808c0: 6b5f 6c6f 636b 2020 2826 7374 6174 655f  k_lock  (&state_
-000808d0: 7368 6172 6564 2e73 7069 6e29 3b0a 2020  shared.spin);.  
-000808e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-000808f0: 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b 2826  ml_lock_unlock(&
-00080900: 7374 6174 655f 7368 6172 6564 2e73 7069  state_shared.spi
-00080910: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
-00080920: 7d0a 0a20 2020 2020 2020 2020 2020 202f  }..            /
-00080930: 2f20 6c61 756e 6368 2074 6872 6561 6420  / launch thread 
-00080940: 706f 6f6c 0a20 2020 2020 2020 2020 2020  pool.           
-00080950: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-00080960: 206a 203c 206e 5f74 6872 6561 6473 202d   j < n_threads -
-00080970: 2031 3b20 6a2b 2b29 207b 0a20 2020 2020   1; j++) {.     
-00080980: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00080990: 7273 5b6a 5d2e 7061 7261 6d73 203d 2028  rs[j].params = (
-000809a0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-000809b0: 7574 655f 7061 7261 6d73 2920 7b0a 2020  ute_params) {.  
-000809c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000809d0: 2020 2e74 7970 6520 203d 2047 474d 4c5f    .type  = GGML_
-000809e0: 5441 534b 5f46 494e 414c 495a 452c 0a20  TASK_FINALIZE,. 
-000809f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080a00: 2020 202e 6974 6820 2020 3d20 6a20 2b20     .ith   = j + 
-00080a10: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-00080a20: 2020 2020 2020 202e 6e74 6820 2020 3d20         .nth   = 
-00080a30: 6e6f 6465 2d3e 6e5f 7461 736b 732c 0a20  node->n_tasks,. 
-00080a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080a50: 2020 202e 7773 697a 6520 3d20 6367 7261     .wsize = cgra
-00080a60: 7068 2d3e 776f 726b 203f 2067 676d 6c5f  ph->work ? ggml_
-00080a70: 6e62 7974 6573 2863 6772 6170 682d 3e77  nbytes(cgraph->w
-00080a80: 6f72 6b29 203a 2030 2c0a 2020 2020 2020  ork) : 0,.      
-00080a90: 2020 2020 2020 2020 2020 2020 2020 2e77                .w
-00080aa0: 6461 7461 203d 2063 6772 6170 682d 3e77  data = cgraph->w
-00080ab0: 6f72 6b20 3f20 6367 7261 7068 2d3e 776f  ork ? cgraph->wo
-00080ac0: 726b 2d3e 6461 7461 203a 204e 554c 4c2c  rk->data : NULL,
-00080ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00080ae0: 207d 3b0a 2020 2020 2020 2020 2020 2020   };.            
-00080af0: 2020 2020 776f 726b 6572 735b 6a5d 2e6e      workers[j].n
-00080b00: 6f64 6520 3d20 6e6f 6465 3b0a 2020 2020  ode = node;.    
-00080b10: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00080b20: 2020 2020 2020 2061 746f 6d69 635f 6665         atomic_fe
-00080b30: 7463 685f 7375 6228 2673 7461 7465 5f73  tch_sub(&state_s
-00080b40: 6861 7265 642e 6e5f 7265 6164 792c 2031  hared.n_ready, 1
-00080b50: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00080b60: 7768 696c 6520 2861 746f 6d69 635f 6c6f  while (atomic_lo
-00080b70: 6164 2826 7374 6174 655f 7368 6172 6564  ad(&state_shared
-00080b80: 2e6e 5f72 6561 6479 2920 3e20 3029 207b  .n_ready) > 0) {
-00080b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00080ba0: 2067 676d 6c5f 6c6f 636b 5f6c 6f63 6b20   ggml_lock_lock 
-00080bb0: 2028 2673 7461 7465 5f73 6861 7265 642e   (&state_shared.
-00080bc0: 7370 696e 293b 0a20 2020 2020 2020 2020  spin);.         
-00080bd0: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
-00080be0: 5f75 6e6c 6f63 6b28 2673 7461 7465 5f73  _unlock(&state_s
-00080bf0: 6861 7265 642e 7370 696e 293b 0a20 2020  hared.spin);.   
-00080c00: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00080c10: 2020 2020 2020 2020 6174 6f6d 6963 5f73          atomic_s
-00080c20: 746f 7265 2826 7374 6174 655f 7368 6172  tore(&state_shar
-00080c30: 6564 2e68 6173 5f77 6f72 6b2c 2074 7275  ed.has_work, tru
-00080c40: 6529 3b0a 2020 2020 2020 2020 7d0a 0a20  e);.        }.. 
-00080c50: 2020 2020 2020 2070 6172 616d 732e 7479         params.ty
-00080c60: 7065 203d 2047 474d 4c5f 5441 534b 5f46  pe = GGML_TASK_F
-00080c70: 494e 414c 495a 453b 0a20 2020 2020 2020  INALIZE;.       
-00080c80: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00080c90: 7277 6172 6428 2670 6172 616d 732c 206e  rward(&params, n
-00080ca0: 6f64 6529 3b0a 0a20 2020 2020 2020 202f  ode);..        /
-00080cb0: 2f20 7761 6974 2066 6f72 2074 6872 6561  / wait for threa
-00080cc0: 6420 706f 6f6c 0a20 2020 2020 2020 2069  d pool.        i
-00080cd0: 6620 286e 6f64 652d 3e6e 5f74 6173 6b73  f (node->n_tasks
-00080ce0: 203e 2031 2920 7b0a 2020 2020 2020 2020   > 1) {.        
-00080cf0: 2020 2020 6966 2028 6174 6f6d 6963 5f66      if (atomic_f
-00080d00: 6574 6368 5f61 6464 2826 7374 6174 655f  etch_add(&state_
-00080d10: 7368 6172 6564 2e6e 5f72 6561 6479 2c20  shared.n_ready, 
-00080d20: 3129 203d 3d20 6e5f 7468 7265 6164 7320  1) == n_threads 
-00080d30: 2d20 3129 207b 0a20 2020 2020 2020 2020  - 1) {.         
-00080d40: 2020 2020 2020 2061 746f 6d69 635f 7374         atomic_st
-00080d50: 6f72 6528 2673 7461 7465 5f73 6861 7265  ore(&state_share
-00080d60: 642e 6861 735f 776f 726b 2c20 6661 6c73  d.has_work, fals
-00080d70: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00080d80: 7d0a 0a20 2020 2020 2020 2020 2020 2077  }..            w
-00080d90: 6869 6c65 2028 6174 6f6d 6963 5f6c 6f61  hile (atomic_loa
-00080da0: 6428 2673 7461 7465 5f73 6861 7265 642e  d(&state_shared.
-00080db0: 6861 735f 776f 726b 2929 207b 0a20 2020  has_work)) {.   
-00080dc0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00080dd0: 6c5f 6c6f 636b 5f6c 6f63 6b20 2028 2673  l_lock_lock  (&s
-00080de0: 7461 7465 5f73 6861 7265 642e 7370 696e  tate_shared.spin
-00080df0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00080e00: 2020 2067 676d 6c5f 6c6f 636b 5f75 6e6c     ggml_lock_unl
-00080e10: 6f63 6b28 2673 7461 7465 5f73 6861 7265  ock(&state_share
-00080e20: 642e 7370 696e 293b 0a20 2020 2020 2020  d.spin);.       
-00080e30: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00080e40: 2020 2020 6174 6f6d 6963 5f66 6574 6368      atomic_fetch
-00080e50: 5f73 7562 2826 7374 6174 655f 7368 6172  _sub(&state_shar
-00080e60: 6564 2e6e 5f72 6561 6479 2c20 3129 3b0a  ed.n_ready, 1);.
-00080e70: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
-00080e80: 6c65 2028 6174 6f6d 6963 5f6c 6f61 6428  le (atomic_load(
-00080e90: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
-00080ea0: 7265 6164 7929 2021 3d20 3029 207b 0a20  ready) != 0) {. 
-00080eb0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00080ec0: 676d 6c5f 6c6f 636b 5f6c 6f63 6b20 2028  gml_lock_lock  (
-00080ed0: 2673 7461 7465 5f73 6861 7265 642e 7370  &state_shared.sp
-00080ee0: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
-00080ef0: 2020 2020 2067 676d 6c5f 6c6f 636b 5f75       ggml_lock_u
-00080f00: 6e6c 6f63 6b28 2673 7461 7465 5f73 6861  nlock(&state_sha
-00080f10: 7265 642e 7370 696e 293b 0a20 2020 2020  red.spin);.     
-00080f20: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00080f30: 207d 0a0a 2020 2020 2020 2020 2f2f 2070   }..        // p
-00080f40: 6572 666f 726d 616e 6365 2073 7461 7473  erformance stats
-00080f50: 2028 6e6f 6465 290a 2020 2020 2020 2020   (node).        
-00080f60: 7b0a 2020 2020 2020 2020 2020 2020 696e  {.            in
-00080f70: 7436 345f 7420 7065 7266 5f63 7963 6c65  t64_t perf_cycle
-00080f80: 735f 6375 7220 203d 2067 676d 6c5f 7065  s_cur  = ggml_pe
-00080f90: 7266 5f63 7963 6c65 7328 2920 202d 2070  rf_cycles()  - p
-00080fa0: 6572 665f 6e6f 6465 5f73 7461 7274 5f63  erf_node_start_c
-00080fb0: 7963 6c65 733b 0a20 2020 2020 2020 2020  ycles;.         
-00080fc0: 2020 2069 6e74 3634 5f74 2070 6572 665f     int64_t perf_
-00080fd0: 7469 6d65 5f75 735f 6375 7220 3d20 6767  time_us_cur = gg
-00080fe0: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
-00080ff0: 2920 2d20 7065 7266 5f6e 6f64 655f 7374  ) - perf_node_st
-00081000: 6172 745f 7469 6d65 5f75 733b 0a0a 2020  art_time_us;..  
-00081010: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
-00081020: 7065 7266 5f72 756e 732b 2b3b 0a20 2020  perf_runs++;.   
-00081030: 2020 2020 2020 2020 206e 6f64 652d 3e70           node->p
-00081040: 6572 665f 6379 636c 6573 2020 2b3d 2070  erf_cycles  += p
-00081050: 6572 665f 6379 636c 6573 5f63 7572 3b0a  erf_cycles_cur;.
-00081060: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00081070: 2d3e 7065 7266 5f74 696d 655f 7573 202b  ->perf_time_us +
-00081080: 3d20 7065 7266 5f74 696d 655f 7573 5f63  = perf_time_us_c
-00081090: 7572 3b0a 2020 2020 2020 2020 7d0a 2020  ur;.        }.  
-000810a0: 2020 7d0a 0a20 2020 202f 2f20 6a6f 696e    }..    // join
-000810b0: 2074 6872 6561 6420 706f 6f6c 0a20 2020   thread pool.   
-000810c0: 2069 6620 286e 5f74 6872 6561 6473 203e   if (n_threads >
-000810d0: 2031 2920 7b0a 2020 2020 2020 2020 6174   1) {.        at
-000810e0: 6f6d 6963 5f73 746f 7265 2826 7374 6174  omic_store(&stat
-000810f0: 655f 7368 6172 6564 2e73 746f 702c 2074  e_shared.stop, t
-00081100: 7275 6529 3b0a 2020 2020 2020 2020 6174  rue);.        at
-00081110: 6f6d 6963 5f73 746f 7265 2826 7374 6174  omic_store(&stat
-00081120: 655f 7368 6172 6564 2e68 6173 5f77 6f72  e_shared.has_wor
-00081130: 6b2c 2074 7275 6529 3b0a 0a20 2020 2020  k, true);..     
-00081140: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-00081150: 303b 206a 203c 206e 5f74 6872 6561 6473  0; j < n_threads
-00081160: 202d 2031 3b20 6a2b 2b29 207b 0a20 2020   - 1; j++) {.   
-00081170: 2020 2020 2020 2020 2069 6e74 2072 6320           int rc 
-00081180: 3d20 6767 6d6c 5f74 6872 6561 645f 6a6f  = ggml_thread_jo
-00081190: 696e 2877 6f72 6b65 7273 5b6a 5d2e 7468  in(workers[j].th
-000811a0: 7264 2c20 4e55 4c4c 293b 0a20 2020 2020  rd, NULL);.     
-000811b0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-000811c0: 5254 2872 6320 3d3d 2030 293b 0a20 2020  RT(rc == 0);.   
-000811d0: 2020 2020 2020 2020 2055 4e55 5345 4428           UNUSED(
-000811e0: 7263 293b 0a20 2020 2020 2020 207d 0a0a  rc);.        }..
-000811f0: 2020 2020 2020 2020 6767 6d6c 5f6c 6f63          ggml_loc
-00081200: 6b5f 6465 7374 726f 7928 2673 7461 7465  k_destroy(&state
-00081210: 5f73 6861 7265 642e 7370 696e 293b 0a20  _shared.spin);. 
-00081220: 2020 207d 0a0a 2020 2020 2f2f 2070 6572     }..    // per
-00081230: 666f 726d 616e 6365 2073 7461 7473 2028  formance stats (
-00081240: 6772 6170 6829 0a20 2020 207b 0a20 2020  graph).    {.   
-00081250: 2020 2020 2069 6e74 3634 5f74 2070 6572       int64_t per
-00081260: 665f 6379 636c 6573 5f63 7572 2020 3d20  f_cycles_cur  = 
-00081270: 6767 6d6c 5f70 6572 665f 6379 636c 6573  ggml_perf_cycles
-00081280: 2829 2020 2d20 7065 7266 5f73 7461 7274  ()  - perf_start
-00081290: 5f63 7963 6c65 733b 0a20 2020 2020 2020  _cycles;.       
-000812a0: 2069 6e74 3634 5f74 2070 6572 665f 7469   int64_t perf_ti
-000812b0: 6d65 5f75 735f 6375 7220 3d20 6767 6d6c  me_us_cur = ggml
-000812c0: 5f70 6572 665f 7469 6d65 5f75 7328 2920  _perf_time_us() 
-000812d0: 2d20 7065 7266 5f73 7461 7274 5f74 696d  - perf_start_tim
-000812e0: 655f 7573 3b0a 0a20 2020 2020 2020 2063  e_us;..        c
-000812f0: 6772 6170 682d 3e70 6572 665f 7275 6e73  graph->perf_runs
-00081300: 2b2b 3b0a 2020 2020 2020 2020 6367 7261  ++;.        cgra
-00081310: 7068 2d3e 7065 7266 5f63 7963 6c65 7320  ph->perf_cycles 
-00081320: 202b 3d20 7065 7266 5f63 7963 6c65 735f   += perf_cycles_
-00081330: 6375 723b 0a20 2020 2020 2020 2063 6772  cur;.        cgr
-00081340: 6170 682d 3e70 6572 665f 7469 6d65 5f75  aph->perf_time_u
-00081350: 7320 2b3d 2070 6572 665f 7469 6d65 5f75  s += perf_time_u
-00081360: 735f 6375 723b 0a0a 2020 2020 2020 2020  s_cur;..        
-00081370: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
-00081380: 2822 2573 3a20 7065 7266 2028 2564 2920  ("%s: perf (%d) 
-00081390: 2d20 6370 7520 3d20 252e 3366 202f 2025  - cpu = %.3f / %
-000813a0: 2e33 6620 6d73 2c20 7761 6c6c 203d 2025  .3f ms, wall = %
-000813b0: 2e33 6620 2f20 252e 3366 206d 735c 6e22  .3f / %.3f ms\n"
-000813c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000813d0: 2020 5f5f 6675 6e63 5f5f 2c20 6367 7261    __func__, cgra
-000813e0: 7068 2d3e 7065 7266 5f72 756e 732c 0a20  ph->perf_runs,. 
-000813f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00081400: 646f 7562 6c65 2920 7065 7266 5f63 7963  double) perf_cyc
-00081410: 6c65 735f 6375 7220 2020 2020 202f 2028  les_cur      / (
-00081420: 646f 7562 6c65 2920 6767 6d6c 5f63 7963  double) ggml_cyc
-00081430: 6c65 735f 7065 725f 6d73 2829 2c0a 2020  les_per_ms(),.  
-00081440: 2020 2020 2020 2020 2020 2020 2020 2864                (d
-00081450: 6f75 626c 6529 2063 6772 6170 682d 3e70  ouble) cgraph->p
-00081460: 6572 665f 6379 636c 6573 2020 2f20 2864  erf_cycles  / (d
-00081470: 6f75 626c 6529 2067 676d 6c5f 6379 636c  ouble) ggml_cycl
-00081480: 6573 5f70 6572 5f6d 7328 2920 2f20 2864  es_per_ms() / (d
-00081490: 6f75 626c 6529 2063 6772 6170 682d 3e70  ouble) cgraph->p
-000814a0: 6572 665f 7275 6e73 2c0a 2020 2020 2020  erf_runs,.      
-000814b0: 2020 2020 2020 2020 2020 2864 6f75 626c            (doubl
-000814c0: 6529 2070 6572 665f 7469 6d65 5f75 735f  e) perf_time_us_
-000814d0: 6375 7220 2020 2020 2f20 3130 3030 2e30  cur     / 1000.0
-000814e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000814f0: 2020 2864 6f75 626c 6529 2063 6772 6170    (double) cgrap
-00081500: 682d 3e70 6572 665f 7469 6d65 5f75 7320  h->perf_time_us 
-00081510: 2f20 3130 3030 2e30 202f 2063 6772 6170  / 1000.0 / cgrap
-00081520: 682d 3e70 6572 665f 7275 6e73 293b 0a20  h->perf_runs);. 
-00081530: 2020 207d 0a7d 0a0a 766f 6964 2067 676d     }.}..void ggm
-00081540: 6c5f 6772 6170 685f 7265 7365 7428 7374  l_graph_reset(st
-00081550: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
-00081560: 202a 2063 6772 6170 6829 207b 0a20 2020   * cgraph) {.   
-00081570: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00081580: 2069 203c 2063 6772 6170 682d 3e6e 5f6e   i < cgraph->n_n
-00081590: 6f64 6573 3b20 692b 2b29 207b 0a20 2020  odes; i++) {.   
-000815a0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000815b0: 5f74 656e 736f 7220 2a20 6772 6164 203d  _tensor * grad =
-000815c0: 2063 6772 6170 682d 3e67 7261 6473 5b69   cgraph->grads[i
-000815d0: 5d3b 0a0a 2020 2020 2020 2020 6966 2028  ];..        if (
-000815e0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-000815f0: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
-00081600: 6f28 6772 6164 293b 0a20 2020 2020 2020  o(grad);.       
-00081610: 207d 0a20 2020 207d 0a7d 0a0a 7374 7275   }.    }.}..stru
-00081620: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00081630: 2067 676d 6c5f 6772 6170 685f 6765 745f   ggml_graph_get_
-00081640: 7465 6e73 6f72 2873 7472 7563 7420 6767  tensor(struct gg
-00081650: 6d6c 5f63 6772 6170 6820 2a20 6367 7261  ml_cgraph * cgra
-00081660: 7068 2c20 636f 6e73 7420 6368 6172 202a  ph, const char *
-00081670: 206e 616d 6529 207b 0a20 2020 2066 6f72   name) {.    for
-00081680: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-00081690: 2063 6772 6170 682d 3e6e 5f6c 6561 6673   cgraph->n_leafs
-000816a0: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-000816b0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000816c0: 736f 7220 2a20 6c65 6166 203d 2063 6772  sor * leaf = cgr
-000816d0: 6170 682d 3e6c 6561 6673 5b69 5d3b 0a0a  aph->leafs[i];..
-000816e0: 2020 2020 2020 2020 6966 2028 7374 7263          if (strc
-000816f0: 6d70 286c 6561 662d 3e6e 616d 652c 206e  mp(leaf->name, n
-00081700: 616d 6529 203d 3d20 3029 207b 0a20 2020  ame) == 0) {.   
-00081710: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00081720: 6c65 6166 3b0a 2020 2020 2020 2020 7d0a  leaf;.        }.
-00081730: 2020 2020 7d0a 0a20 2020 2066 6f72 2028      }..    for (
-00081740: 696e 7420 6920 3d20 303b 2069 203c 2063  int i = 0; i < c
-00081750: 6772 6170 682d 3e6e 5f6e 6f64 6573 3b20  graph->n_nodes; 
-00081760: 692b 2b29 207b 0a20 2020 2020 2020 2073  i++) {.        s
-00081770: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00081780: 7220 2a20 6e6f 6465 203d 2063 6772 6170  r * node = cgrap
-00081790: 682d 3e6e 6f64 6573 5b69 5d3b 0a0a 2020  h->nodes[i];..  
-000817a0: 2020 2020 2020 6966 2028 7374 7263 6d70        if (strcmp
-000817b0: 286e 6f64 652d 3e6e 616d 652c 206e 616d  (node->name, nam
-000817c0: 6529 203d 3d20 3029 207b 0a20 2020 2020  e) == 0) {.     
-000817d0: 2020 2020 2020 2072 6574 7572 6e20 6e6f         return no
-000817e0: 6465 3b0a 2020 2020 2020 2020 7d0a 2020  de;.        }.  
-000817f0: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
-00081800: 4e55 4c4c 3b0a 7d0a 0a73 7461 7469 6320  NULL;.}..static 
-00081810: 766f 6964 2067 676d 6c5f 6772 6170 685f  void ggml_graph_
-00081820: 6578 706f 7274 5f6c 6561 6628 636f 6e73  export_leaf(cons
-00081830: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00081840: 6e73 6f72 202a 2074 656e 736f 722c 2046  nsor * tensor, F
-00081850: 494c 4520 2a20 666f 7574 2920 7b0a 2020  ILE * fout) {.  
-00081860: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00081870: 2a20 6e65 203d 2074 656e 736f 722d 3e6e  * ne = tensor->n
-00081880: 653b 0a20 2020 2063 6f6e 7374 2073 697a  e;.    const siz
-00081890: 655f 7420 202a 206e 6220 3d20 7465 6e73  e_t  * nb = tens
-000818a0: 6f72 2d3e 6e62 3b0a 0a20 2020 2066 7072  or->nb;..    fpr
-000818b0: 696e 7466 2866 6f75 742c 2022 252d 3673  intf(fout, "%-6s
-000818c0: 2025 2d31 3273 2025 3864 2025 2220 5052   %-12s %8d %" PR
-000818d0: 4964 3634 2022 2025 2220 5052 4964 3634  Id64 " %" PRId64
-000818e0: 2022 2025 2220 5052 4964 3634 2022 2025   " %" PRId64 " %
-000818f0: 2220 5052 4964 3634 2022 2025 3136 7a75  " PRId64 " %16zu
-00081900: 2025 3136 7a75 2025 3136 7a75 2025 3136   %16zu %16zu %16
-00081910: 7a75 2025 3136 7020 2533 3273 5c6e 222c  zu %16p %32s\n",
-00081920: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00081930: 6c5f 7479 7065 5f6e 616d 6528 7465 6e73  l_type_name(tens
-00081940: 6f72 2d3e 7479 7065 292c 0a20 2020 2020  or->type),.     
-00081950: 2020 2020 2020 2067 676d 6c5f 6f70 5f6e         ggml_op_n
-00081960: 616d 6520 2028 7465 6e73 6f72 2d3e 6f70  ame  (tensor->op
-00081970: 292c 0a20 2020 2020 2020 2020 2020 2074  ),.            t
-00081980: 656e 736f 722d 3e6e 5f64 696d 732c 0a20  ensor->n_dims,. 
-00081990: 2020 2020 2020 2020 2020 206e 655b 305d             ne[0]
-000819a0: 2c20 6e65 5b31 5d2c 206e 655b 325d 2c20  , ne[1], ne[2], 
-000819b0: 6e65 5b33 5d2c 0a20 2020 2020 2020 2020  ne[3],.         
-000819c0: 2020 206e 625b 305d 2c20 6e62 5b31 5d2c     nb[0], nb[1],
-000819d0: 206e 625b 325d 2c20 6e62 5b33 5d2c 0a20   nb[2], nb[3],. 
-000819e0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-000819f0: 722d 3e64 6174 612c 0a20 2020 2020 2020  r->data,.       
-00081a00: 2020 2020 2074 656e 736f 722d 3e6e 616d       tensor->nam
-00081a10: 6529 3b0a 7d0a 0a73 7461 7469 6320 766f  e);.}..static vo
-00081a20: 6964 2067 676d 6c5f 6772 6170 685f 6578  id ggml_graph_ex
-00081a30: 706f 7274 5f6e 6f64 6528 636f 6e73 7420  port_node(const 
-00081a40: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00081a50: 6f72 202a 2074 656e 736f 722c 2063 6f6e  or * tensor, con
-00081a60: 7374 2063 6861 7220 2a20 6172 672c 2046  st char * arg, F
-00081a70: 494c 4520 2a20 666f 7574 2920 7b0a 2020  ILE * fout) {.  
-00081a80: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00081a90: 2a20 6e65 203d 2074 656e 736f 722d 3e6e  * ne = tensor->n
-00081aa0: 653b 0a20 2020 2063 6f6e 7374 2073 697a  e;.    const siz
-00081ab0: 655f 7420 202a 206e 6220 3d20 7465 6e73  e_t  * nb = tens
-00081ac0: 6f72 2d3e 6e62 3b0a 0a20 2020 2066 7072  or->nb;..    fpr
-00081ad0: 696e 7466 2866 6f75 742c 2022 252d 3673  intf(fout, "%-6s
-00081ae0: 2025 2d36 7320 252d 3132 7320 2538 6420   %-6s %-12s %8d 
-00081af0: 2522 2050 5249 6436 3420 2220 2522 2050  %" PRId64 " %" P
-00081b00: 5249 6436 3420 2220 2522 2050 5249 6436  RId64 " %" PRId6
-00081b10: 3420 2220 2522 2050 5249 6436 3420 2220  4 " %" PRId64 " 
-00081b20: 2531 367a 7520 2531 367a 7520 2531 367a  %16zu %16zu %16z
-00081b30: 7520 2531 367a 7520 2538 6420 2531 3670  u %16zu %8d %16p
-00081b40: 2025 3332 735c 6e22 2c0a 2020 2020 2020   %32s\n",.      
-00081b50: 2020 2020 2020 6172 672c 0a20 2020 2020        arg,.     
-00081b60: 2020 2020 2020 2067 676d 6c5f 7479 7065         ggml_type
-00081b70: 5f6e 616d 6528 7465 6e73 6f72 2d3e 7479  _name(tensor->ty
-00081b80: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
-00081b90: 2067 676d 6c5f 6f70 5f6e 616d 6520 2028   ggml_op_name  (
-00081ba0: 7465 6e73 6f72 2d3e 6f70 292c 0a20 2020  tensor->op),.   
-00081bb0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
-00081bc0: 3e6e 5f64 696d 732c 0a20 2020 2020 2020  >n_dims,.       
-00081bd0: 2020 2020 206e 655b 305d 2c20 6e65 5b31       ne[0], ne[1
-00081be0: 5d2c 206e 655b 325d 2c20 6e65 5b33 5d2c  ], ne[2], ne[3],
-00081bf0: 0a20 2020 2020 2020 2020 2020 206e 625b  .            nb[
-00081c00: 305d 2c20 6e62 5b31 5d2c 206e 625b 325d  0], nb[1], nb[2]
-00081c10: 2c20 6e62 5b33 5d2c 0a20 2020 2020 2020  , nb[3],.       
-00081c20: 2020 2020 2074 656e 736f 722d 3e6e 5f74       tensor->n_t
-00081c30: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-00081c40: 2020 7465 6e73 6f72 2d3e 6461 7461 2c0a    tensor->data,.
-00081c50: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-00081c60: 6f72 2d3e 6e61 6d65 293b 0a7d 0a0a 766f  or->name);.}..vo
-00081c70: 6964 2067 676d 6c5f 6772 6170 685f 6578  id ggml_graph_ex
-00081c80: 706f 7274 2863 6f6e 7374 2073 7472 7563  port(const struc
-00081c90: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-00081ca0: 6367 7261 7068 2c20 636f 6e73 7420 6368  cgraph, const ch
-00081cb0: 6172 202a 2066 6e61 6d65 2920 7b0a 2020  ar * fname) {.  
-00081cc0: 2020 2f2f 6173 7365 7274 2863 6772 6170    //assert(cgrap
-00081cd0: 682d 3e77 6f72 6b20 2020 2020 203d 3d20  h->work      == 
-00081ce0: 4e55 4c4c 293b 0a20 2020 202f 2f61 7373  NULL);.    //ass
-00081cf0: 6572 7428 6367 7261 7068 2d3e 776f 726b  ert(cgraph->work
-00081d00: 5f73 697a 6520 3d3d 2030 293b 0a0a 2020  _size == 0);..  
-00081d10: 2020 7569 6e74 3634 5f74 2073 697a 655f    uint64_t size_
-00081d20: 6576 616c 203d 2030 3b0a 0a20 2020 202f  eval = 0;..    /
-00081d30: 2f20 636f 6d70 7574 6520 7369 7a65 206f  / compute size o
-00081d40: 6620 696e 7465 726d 6564 6961 7465 2072  f intermediate r
-00081d50: 6573 756c 7473 0a20 2020 202f 2f20 544f  esults.    // TO
-00081d60: 444f 3a20 646f 6573 206e 6f74 2074 616b  DO: does not tak
-00081d70: 6520 696e 746f 2061 6363 6f75 6e74 2073  e into account s
-00081d80: 6372 6174 6368 2062 7566 6665 7273 2021  cratch buffers !
-00081d90: 2121 210a 2020 2020 666f 7220 2869 6e74  !!!.    for (int
-00081da0: 2069 203d 2030 3b20 6920 3c20 6367 7261   i = 0; i < cgra
-00081db0: 7068 2d3e 6e5f 6e6f 6465 733b 202b 2b69  ph->n_nodes; ++i
-00081dc0: 2920 7b0a 2020 2020 2020 2020 7369 7a65  ) {.        size
-00081dd0: 5f65 7661 6c20 2b3d 2067 676d 6c5f 6e62  _eval += ggml_nb
-00081de0: 7974 6573 2863 6772 6170 682d 3e6e 6f64  ytes(cgraph->nod
-00081df0: 6573 5b69 5d29 3b0a 2020 2020 7d0a 0a20  es[i]);.    }.. 
-00081e00: 2020 202f 2f20 7072 696e 740a 2020 2020     // print.    
-00081e10: 7b0a 2020 2020 2020 2020 4649 4c45 202a  {.        FILE *
-00081e20: 2066 6f75 7420 3d20 7374 646f 7574 3b0a   fout = stdout;.
-00081e30: 0a20 2020 2020 2020 2066 7072 696e 7466  .        fprintf
-00081e40: 2866 6f75 742c 2022 5c6e 2229 3b0a 2020  (fout, "\n");.  
-00081e50: 2020 2020 2020 6670 7269 6e74 6628 666f        fprintf(fo
-00081e60: 7574 2c20 2225 2d31 3673 2025 3878 5c6e  ut, "%-16s %8x\n
-00081e70: 222c 2022 6d61 6769 6322 2c20 2020 2020  ", "magic",     
-00081e80: 2020 2047 474d 4c5f 4649 4c45 5f4d 4147     GGML_FILE_MAG
-00081e90: 4943 293b 0a20 2020 2020 2020 2066 7072  IC);.        fpr
-00081ea0: 696e 7466 2866 6f75 742c 2022 252d 3136  intf(fout, "%-16
-00081eb0: 7320 2538 645c 6e22 2c20 2276 6572 7369  s %8d\n", "versi
-00081ec0: 6f6e 222c 2020 2020 2020 4747 4d4c 5f46  on",      GGML_F
-00081ed0: 494c 455f 5645 5253 494f 4e29 3b0a 2020  ILE_VERSION);.  
-00081ee0: 2020 2020 2020 6670 7269 6e74 6628 666f        fprintf(fo
-00081ef0: 7574 2c20 2225 2d31 3673 2025 3864 5c6e  ut, "%-16s %8d\n
-00081f00: 222c 2022 6c65 6166 7322 2c20 2020 2020  ", "leafs",     
-00081f10: 2020 2063 6772 6170 682d 3e6e 5f6c 6561     cgraph->n_lea
-00081f20: 6673 293b 0a20 2020 2020 2020 2066 7072  fs);.        fpr
-00081f30: 696e 7466 2866 6f75 742c 2022 252d 3136  intf(fout, "%-16
-00081f40: 7320 2538 645c 6e22 2c20 226e 6f64 6573  s %8d\n", "nodes
-00081f50: 222c 2020 2020 2020 2020 6367 7261 7068  ",        cgraph
-00081f60: 2d3e 6e5f 6e6f 6465 7329 3b0a 2020 2020  ->n_nodes);.    
-00081f70: 2020 2020 6670 7269 6e74 6628 666f 7574      fprintf(fout
-00081f80: 2c20 2225 2d31 3673 2025 2220 5052 4975  , "%-16s %" PRIu
-00081f90: 3634 2022 5c6e 222c 2022 6576 616c 222c  64 "\n", "eval",
-00081fa0: 2073 697a 655f 6576 616c 293b 0a0a 2020   size_eval);..  
-00081fb0: 2020 2020 2020 2f2f 2068 6561 6465 720a        // header.
-00081fc0: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
-00081fd0: 666f 7574 2c20 225c 6e22 293b 0a20 2020  fout, "\n");.   
-00081fe0: 2020 2020 2066 7072 696e 7466 2866 6f75       fprintf(fou
-00081ff0: 742c 2022 252d 3673 2025 2d31 3273 2025  t, "%-6s %-12s %
-00082000: 3873 2025 3873 2025 3873 2025 3873 2025  8s %8s %8s %8s %
-00082010: 3873 2025 3136 7320 2531 3673 2025 3136  8s %16s %16s %16
-00082020: 7320 2531 3673 2025 3136 7320 2531 3673  s %16s %16s %16s
-00082030: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
-00082040: 2020 2020 2022 5459 5045 222c 2022 4f50       "TYPE", "OP
-00082050: 222c 2022 4e44 494d 5322 2c20 224e 4530  ", "NDIMS", "NE0
-00082060: 222c 2022 4e45 3122 2c20 224e 4532 222c  ", "NE1", "NE2",
-00082070: 2022 4e45 3322 2c20 224e 4230 222c 2022   "NE3", "NB0", "
-00082080: 4e42 3122 2c20 224e 4232 222c 2022 4e42  NB1", "NB2", "NB
-00082090: 3322 2c20 2244 4154 4122 2c20 224e 414d  3", "DATA", "NAM
-000820a0: 4522 293b 0a0a 2020 2020 2020 2020 666f  E");..        fo
-000820b0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-000820c0: 3c20 6367 7261 7068 2d3e 6e5f 6c65 6166  < cgraph->n_leaf
-000820d0: 733b 202b 2b69 2920 7b0a 2020 2020 2020  s; ++i) {.      
-000820e0: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-000820f0: 5f65 7870 6f72 745f 6c65 6166 2863 6772  _export_leaf(cgr
-00082100: 6170 682d 3e6c 6561 6673 5b69 5d2c 2066  aph->leafs[i], f
-00082110: 6f75 7429 3b0a 0a20 2020 2020 2020 2020  out);..         
-00082120: 2020 2047 474d 4c5f 4153 5345 5254 2863     GGML_ASSERT(c
-00082130: 6772 6170 682d 3e6c 6561 6673 5b69 5d2d  graph->leafs[i]-
-00082140: 3e6f 7020 2020 3d3d 2047 474d 4c5f 4f50  >op   == GGML_OP
-00082150: 5f4e 4f4e 4529 3b0a 2020 2020 2020 2020  _NONE);.        
-00082160: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00082170: 6367 7261 7068 2d3e 6c65 6166 735b 695d  cgraph->leafs[i]
-00082180: 2d3e 7372 6330 203d 3d20 4e55 4c4c 293b  ->src0 == NULL);
-00082190: 0a20 2020 2020 2020 2020 2020 2047 474d  .            GGM
-000821a0: 4c5f 4153 5345 5254 2863 6772 6170 682d  L_ASSERT(cgraph-
-000821b0: 3e6c 6561 6673 5b69 5d2d 3e73 7263 3120  >leafs[i]->src1 
-000821c0: 3d3d 204e 554c 4c29 3b0a 2020 2020 2020  == NULL);.      
-000821d0: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
-000821e0: 6865 6164 6572 0a20 2020 2020 2020 2066  header.        f
-000821f0: 7072 696e 7466 2866 6f75 742c 2022 5c6e  printf(fout, "\n
-00082200: 2229 3b0a 2020 2020 2020 2020 6670 7269  ");.        fpri
-00082210: 6e74 6628 666f 7574 2c20 2225 2d36 7320  ntf(fout, "%-6s 
-00082220: 252d 3673 2025 2d31 3273 2025 3873 2025  %-6s %-12s %8s %
-00082230: 3873 2025 3873 2025 3873 2025 3873 2025  8s %8s %8s %8s %
-00082240: 3136 7320 2531 3673 2025 3136 7320 2531  16s %16s %16s %1
-00082250: 3673 2025 3873 2025 3136 7320 2531 3673  6s %8s %16s %16s
-00082260: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
-00082270: 2020 2020 2022 4152 4722 2c20 2254 5950       "ARG", "TYP
-00082280: 4522 2c20 224f 5022 2c20 224e 4449 4d53  E", "OP", "NDIMS
-00082290: 222c 2022 4e45 3022 2c20 224e 4531 222c  ", "NE0", "NE1",
-000822a0: 2022 4e45 3222 2c20 224e 4533 222c 2022   "NE2", "NE3", "
-000822b0: 4e42 3022 2c20 224e 4231 222c 2022 4e42  NB0", "NB1", "NB
-000822c0: 3222 2c20 224e 4233 222c 2022 4e54 4153  2", "NB3", "NTAS
-000822d0: 4b53 222c 2022 4441 5441 222c 2022 4e41  KS", "DATA", "NA
-000822e0: 4d45 2229 3b0a 0a20 2020 2020 2020 2066  ME");..        f
-000822f0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00082300: 203c 2063 6772 6170 682d 3e6e 5f6e 6f64   < cgraph->n_nod
-00082310: 6573 3b20 2b2b 6929 207b 0a20 2020 2020  es; ++i) {.     
-00082320: 2020 2020 2020 2067 676d 6c5f 6772 6170         ggml_grap
-00082330: 685f 6578 706f 7274 5f6e 6f64 6528 6367  h_export_node(cg
-00082340: 7261 7068 2d3e 6e6f 6465 735b 695d 2c20  raph->nodes[i], 
-00082350: 2244 5354 222c 2066 6f75 7429 3b0a 0a20  "DST", fout);.. 
-00082360: 2020 2020 2020 2020 2020 2069 6620 2863             if (c
-00082370: 6772 6170 682d 3e6e 6f64 6573 5b69 5d2d  graph->nodes[i]-
-00082380: 3e73 7263 3029 207b 0a20 2020 2020 2020  >src0) {.       
-00082390: 2020 2020 2020 2020 2067 676d 6c5f 6772           ggml_gr
-000823a0: 6170 685f 6578 706f 7274 5f6e 6f64 6528  aph_export_node(
-000823b0: 6367 7261 7068 2d3e 6e6f 6465 735b 695d  cgraph->nodes[i]
-000823c0: 2d3e 7372 6330 2c20 2253 5243 3022 2c20  ->src0, "SRC0", 
-000823d0: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
-000823e0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-000823f0: 2020 6966 2028 6367 7261 7068 2d3e 6e6f    if (cgraph->no
-00082400: 6465 735b 695d 2d3e 7372 6331 2920 7b0a  des[i]->src1) {.
-00082410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082420: 6767 6d6c 5f67 7261 7068 5f65 7870 6f72  ggml_graph_expor
-00082430: 745f 6e6f 6465 2863 6772 6170 682d 3e6e  t_node(cgraph->n
-00082440: 6f64 6573 5b69 5d2d 3e73 7263 312c 2022  odes[i]->src1, "
-00082450: 5352 4331 222c 2066 6f75 7429 3b0a 2020  SRC1", fout);.  
-00082460: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00082470: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00082480: 7420 6a20 3d20 303b 206a 203c 2047 474d  t j = 0; j < GGM
-00082490: 4c5f 4d41 585f 4f50 543b 202b 2b6a 2920  L_MAX_OPT; ++j) 
-000824a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000824b0: 2020 6966 2028 6367 7261 7068 2d3e 6e6f    if (cgraph->no
-000824c0: 6465 735b 695d 2d3e 6f70 745b 6a5d 2920  des[i]->opt[j]) 
-000824d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000824e0: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-000824f0: 5f65 7870 6f72 745f 6e6f 6465 2863 6772  _export_node(cgr
-00082500: 6170 682d 3e6e 6f64 6573 5b69 5d2d 3e6f  aph->nodes[i]->o
-00082510: 7074 5b6a 5d2c 2022 4f50 5422 2c20 666f  pt[j], "OPT", fo
-00082520: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-00082530: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00082540: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00082550: 2020 6670 7269 6e74 6628 666f 7574 2c20    fprintf(fout, 
-00082560: 225c 6e22 293b 0a20 2020 2020 2020 207d  "\n");.        }
-00082570: 0a0a 2020 2020 2020 2020 6670 7269 6e74  ..        fprint
-00082580: 6628 666f 7574 2c20 225c 6e22 293b 0a20  f(fout, "\n");. 
-00082590: 2020 207d 0a0a 2020 2020 2f2f 2077 7269     }..    // wri
-000825a0: 7465 2062 696e 6172 7920 6461 7461 0a20  te binary data. 
-000825b0: 2020 207b 0a20 2020 2020 2020 2046 494c     {.        FIL
-000825c0: 4520 2a20 666f 7574 203d 2066 6f70 656e  E * fout = fopen
-000825d0: 2866 6e61 6d65 2c20 2277 6222 293b 0a0a  (fname, "wb");..
-000825e0: 2020 2020 2020 2020 6966 2028 2166 6f75          if (!fou
-000825f0: 7429 207b 0a20 2020 2020 2020 2020 2020  t) {.           
-00082600: 2066 7072 696e 7466 2873 7464 6572 722c   fprintf(stderr,
-00082610: 2022 2573 3a20 6661 696c 6564 2074 6f20   "%s: failed to 
-00082620: 6f70 656e 2025 735c 6e22 2c20 5f5f 6675  open %s\n", __fu
-00082630: 6e63 5f5f 2c20 666e 616d 6529 3b0a 2020  nc__, fname);.  
-00082640: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00082650: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-00082660: 2020 2020 202f 2f20 6865 6164 6572 0a20       // header. 
-00082670: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00082680: 2020 2020 2063 6f6e 7374 2075 696e 7433       const uint3
-00082690: 325f 7420 6d61 6769 6320 2020 3d20 4747  2_t magic   = GG
-000826a0: 4d4c 5f46 494c 455f 4d41 4749 433b 0a20  ML_FILE_MAGIC;. 
-000826b0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-000826c0: 2075 696e 7433 325f 7420 7665 7273 696f   uint32_t versio
-000826d0: 6e20 3d20 4747 4d4c 5f46 494c 455f 5645  n = GGML_FILE_VE
-000826e0: 5253 494f 4e3b 0a20 2020 2020 2020 2020  RSION;.         
-000826f0: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
-00082700: 7420 6e5f 6c65 6166 7320 3d20 6367 7261  t n_leafs = cgra
-00082710: 7068 2d3e 6e5f 6c65 6166 733b 0a20 2020  ph->n_leafs;.   
-00082720: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
-00082730: 696e 7433 325f 7420 6e6f 6465 7320 2020  int32_t nodes   
-00082740: 3d20 6367 7261 7068 2d3e 6e5f 6e6f 6465  = cgraph->n_node
-00082750: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
-00082760: 6677 7269 7465 2826 6d61 6769 632c 2020  fwrite(&magic,  
-00082770: 2020 2073 697a 656f 6628 7569 6e74 3332     sizeof(uint32
-00082780: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
-00082790: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-000827a0: 6528 2676 6572 7369 6f6e 2c20 2020 7369  e(&version,   si
-000827b0: 7a65 6f66 2875 696e 7433 325f 7429 2c20  zeof(uint32_t), 
-000827c0: 312c 2066 6f75 7429 3b0a 2020 2020 2020  1, fout);.      
-000827d0: 2020 2020 2020 6677 7269 7465 2826 6e5f        fwrite(&n_
-000827e0: 6c65 6166 732c 2020 2073 697a 656f 6628  leafs,   sizeof(
-000827f0: 7569 6e74 3332 5f74 292c 2031 2c20 666f  uint32_t), 1, fo
-00082800: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-00082810: 2066 7772 6974 6528 266e 6f64 6573 2c20   fwrite(&nodes, 
-00082820: 2020 2020 7369 7a65 6f66 2875 696e 7433      sizeof(uint3
-00082830: 325f 7429 2c20 312c 2066 6f75 7429 3b0a  2_t), 1, fout);.
-00082840: 2020 2020 2020 2020 2020 2020 6677 7269              fwri
-00082850: 7465 2826 7369 7a65 5f65 7661 6c2c 2073  te(&size_eval, s
-00082860: 697a 656f 6628 7569 6e74 3634 5f74 292c  izeof(uint64_t),
-00082870: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
-00082880: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
-00082890: 206c 6561 6673 0a20 2020 2020 2020 207b   leafs.        {
-000828a0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000828b0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-000828c0: 2063 6772 6170 682d 3e6e 5f6c 6561 6673   cgraph->n_leafs
-000828d0: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-000828e0: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-000828f0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00082900: 7220 2a20 7465 6e73 6f72 203d 2063 6772  r * tensor = cgr
-00082910: 6170 682d 3e6c 6561 6673 5b69 5d3b 0a0a  aph->leafs[i];..
-00082920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082930: 636f 6e73 7420 7569 6e74 3332 5f74 2074  const uint32_t t
-00082940: 7970 6520 2020 3d20 7465 6e73 6f72 2d3e  ype   = tensor->
-00082950: 7479 7065 3b0a 2020 2020 2020 2020 2020  type;.          
-00082960: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-00082970: 3332 5f74 206f 7020 2020 2020 3d20 7465  32_t op     = te
-00082980: 6e73 6f72 2d3e 6f70 3b0a 2020 2020 2020  nsor->op;.      
-00082990: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-000829a0: 7569 6e74 3332 5f74 206e 5f64 696d 7320  uint32_t n_dims 
-000829b0: 3d20 7465 6e73 6f72 2d3e 6e5f 6469 6d73  = tensor->n_dims
-000829c0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000829d0: 2020 2066 7772 6974 6528 2674 7970 652c     fwrite(&type,
-000829e0: 2020 2073 697a 656f 6628 7569 6e74 3332     sizeof(uint32
-000829f0: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
-00082a00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00082a10: 7772 6974 6528 266f 702c 2020 2020 2073  write(&op,     s
-00082a20: 697a 656f 6628 7569 6e74 3332 5f74 292c  izeof(uint32_t),
-00082a30: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
-00082a40: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-00082a50: 6528 266e 5f64 696d 732c 2073 697a 656f  e(&n_dims, sizeo
-00082a60: 6628 7569 6e74 3332 5f74 292c 2031 2c20  f(uint32_t), 1, 
-00082a70: 666f 7574 293b 0a0a 2020 2020 2020 2020  fout);..        
-00082a80: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00082a90: 206a 203d 2030 3b20 6a20 3c20 4747 4d4c   j = 0; j < GGML
-00082aa0: 5f4d 4158 5f44 494d 533b 202b 2b6a 2920  _MAX_DIMS; ++j) 
-00082ab0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00082ac0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-00082ad0: 3634 5f74 206e 6520 3d20 7465 6e73 6f72  64_t ne = tensor
-00082ae0: 2d3e 6e65 5b6a 5d3b 0a20 2020 2020 2020  ->ne[j];.       
-00082af0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00082b00: 7374 2075 696e 7436 345f 7420 6e62 203d  st uint64_t nb =
-00082b10: 2074 656e 736f 722d 3e6e 625b 6a5d 3b0a   tensor->nb[j];.
-00082b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082b30: 2020 2020 2066 7772 6974 6528 266e 652c       fwrite(&ne,
-00082b40: 2073 697a 656f 6628 7569 6e74 3634 5f74   sizeof(uint64_t
-00082b50: 292c 2031 2c20 666f 7574 293b 0a20 2020  ), 1, fout);.   
-00082b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082b70: 2066 7772 6974 6528 266e 622c 2073 697a   fwrite(&nb, siz
-00082b80: 656f 6628 7569 6e74 3634 5f74 292c 2031  eof(uint64_t), 1
-00082b90: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
-00082ba0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00082bb0: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
-00082bc0: 746f 7265 2074 6865 2070 6f69 6e74 6572  tore the pointer
-00082bd0: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
-00082be0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00082bf0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00082c00: 6f6e 7374 2075 696e 7436 345f 7420 7074  onst uint64_t pt
-00082c10: 7220 3d20 2875 696e 7436 345f 7429 2074  r = (uint64_t) t
-00082c20: 656e 736f 722d 3e64 6174 613b 0a0a 2020  ensor->data;..  
-00082c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082c40: 2020 6677 7269 7465 2826 7074 722c 2073    fwrite(&ptr, s
-00082c50: 697a 656f 6628 7569 6e74 3634 5f74 292c  izeof(uint64_t),
-00082c60: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
-00082c70: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00082c80: 2020 2020 2020 2020 2020 2020 2020 6677                fw
-00082c90: 7269 7465 2874 656e 736f 722d 3e6e 616d  rite(tensor->nam
-00082ca0: 652c 2073 697a 656f 6628 6368 6172 292c  e, sizeof(char),
-00082cb0: 2047 474d 4c5f 4d41 585f 4e41 4d45 2c20   GGML_MAX_NAME, 
-00082cc0: 666f 7574 293b 0a0a 2020 2020 2020 2020  fout);..        
-00082cd0: 2020 2020 2020 2020 2f2f 2064 756d 7020          // dump 
-00082ce0: 7468 6520 6461 7461 0a20 2020 2020 2020  the data.       
-00082cf0: 2020 2020 2020 2020 202f 2f20 544f 444f           // TODO
-00082d00: 3a20 7061 6420 7468 6973 2074 6f20 3332  : pad this to 32
-00082d10: 2062 7974 6520 626f 756e 6461 7279 0a20   byte boundary. 
-00082d20: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00082d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082d40: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
-00082d50: 7420 7369 7a65 203d 2067 676d 6c5f 6e62  t size = ggml_nb
-00082d60: 7974 6573 2874 656e 736f 7229 3b0a 0a20  ytes(tensor);.. 
-00082d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082d80: 2020 2066 7772 6974 6528 7465 6e73 6f72     fwrite(tensor
-00082d90: 2d3e 6461 7461 2c20 7369 7a65 6f66 2863  ->data, sizeof(c
-00082da0: 6861 7229 2c20 7369 7a65 2c20 666f 7574  har), size, fout
-00082db0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00082dc0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00082dd0: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-00082de0: 2020 2020 2020 2f2f 206e 6f64 6573 0a20        // nodes. 
-00082df0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00082e00: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-00082e10: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
-00082e20: 3e6e 5f6e 6f64 6573 3b20 2b2b 6929 207b  >n_nodes; ++i) {
-00082e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082e40: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00082e50: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
-00082e60: 6f72 203d 2063 6772 6170 682d 3e6e 6f64  or = cgraph->nod
-00082e70: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
-00082e80: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-00082e90: 6e74 3332 5f74 2074 7970 6520 2020 3d20  nt32_t type   = 
-00082ea0: 7465 6e73 6f72 2d3e 7479 7065 3b0a 2020  tensor->type;.  
-00082eb0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00082ec0: 6e73 7420 7569 6e74 3332 5f74 206f 7020  nst uint32_t op 
-00082ed0: 2020 2020 3d20 7465 6e73 6f72 2d3e 6f70      = tensor->op
-00082ee0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00082ef0: 2020 636f 6e73 7420 7569 6e74 3332 5f74    const uint32_t
-00082f00: 206e 5f64 696d 7320 3d20 7465 6e73 6f72   n_dims = tensor
-00082f10: 2d3e 6e5f 6469 6d73 3b0a 0a20 2020 2020  ->n_dims;..     
-00082f20: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-00082f30: 6528 2674 7970 652c 2020 2073 697a 656f  e(&type,   sizeo
-00082f40: 6628 7569 6e74 3332 5f74 292c 2031 2c20  f(uint32_t), 1, 
-00082f50: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
-00082f60: 2020 2020 2020 2066 7772 6974 6528 266f         fwrite(&o
-00082f70: 702c 2020 2020 2073 697a 656f 6628 7569  p,     sizeof(ui
-00082f80: 6e74 3332 5f74 292c 2031 2c20 666f 7574  nt32_t), 1, fout
-00082f90: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00082fa0: 2020 2066 7772 6974 6528 266e 5f64 696d     fwrite(&n_dim
-00082fb0: 732c 2073 697a 656f 6628 7569 6e74 3332  s, sizeof(uint32
-00082fc0: 5f74 292c 2031 2c20 666f 7574 293b 0a0a  _t), 1, fout);..
-00082fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082fe0: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
-00082ff0: 6a20 3c20 4747 4d4c 5f4d 4158 5f44 494d  j < GGML_MAX_DIM
-00083000: 533b 202b 2b6a 2920 7b0a 2020 2020 2020  S; ++j) {.      
-00083010: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00083020: 6e73 7420 7569 6e74 3634 5f74 206e 6520  nst uint64_t ne 
-00083030: 3d20 7465 6e73 6f72 2d3e 6e65 5b6a 5d3b  = tensor->ne[j];
-00083040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00083050: 2020 2020 2063 6f6e 7374 2075 696e 7436       const uint6
-00083060: 345f 7420 6e62 203d 2074 656e 736f 722d  4_t nb = tensor-
-00083070: 3e6e 625b 6a5d 3b0a 0a20 2020 2020 2020  >nb[j];..       
-00083080: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
-00083090: 6974 6528 266e 652c 2073 697a 656f 6628  ite(&ne, sizeof(
-000830a0: 7569 6e74 3634 5f74 292c 2031 2c20 666f  uint64_t), 1, fo
-000830b0: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-000830c0: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
-000830d0: 266e 622c 2073 697a 656f 6628 7569 6e74  &nb, sizeof(uint
-000830e0: 3634 5f74 292c 2031 2c20 666f 7574 293b  64_t), 1, fout);
-000830f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00083100: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-00083110: 2020 2020 2f2f 2073 746f 7265 2074 6865      // store the
-00083120: 2070 6f69 6e74 6572 2061 6464 7265 7373   pointer address
-00083130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00083140: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00083150: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-00083160: 7436 345f 7420 7074 7220 3d20 2875 696e  t64_t ptr = (uin
-00083170: 7436 345f 7429 2074 656e 736f 722d 3e64  t64_t) tensor->d
-00083180: 6174 613b 0a0a 2020 2020 2020 2020 2020  ata;..          
-00083190: 2020 2020 2020 2020 2020 6677 7269 7465            fwrite
-000831a0: 2826 7074 722c 2073 697a 656f 6628 7569  (&ptr, sizeof(ui
-000831b0: 6e74 3634 5f74 292c 2031 2c20 666f 7574  nt64_t), 1, fout
-000831c0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000831d0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-000831e0: 2020 2020 2020 6677 7269 7465 2874 656e        fwrite(ten
-000831f0: 736f 722d 3e6e 616d 652c 2073 697a 656f  sor->name, sizeo
-00083200: 6628 6368 6172 292c 2047 474d 4c5f 4d41  f(char), GGML_MA
-00083210: 585f 4e41 4d45 2c20 666f 7574 293b 0a0a  X_NAME, fout);..
+0007f670: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0007f680: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0007f690: 7365 2047 474d 4c5f 4f50 5f43 524f 5353  se GGML_OP_CROSS
+0007f6a0: 5f45 4e54 524f 5059 5f4c 4f53 535f 4241  _ENTROPY_LOSS_BA
+0007f6b0: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+0007f6c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f6e0: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
+0007f6f0: 3d20 6e5f 7468 7265 6164 733b 0a0a 2020  = n_threads;..  
+0007f700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f710: 2020 2020 2020 7369 7a65 5f74 2063 7572        size_t cur
+0007f720: 203d 2067 676d 6c5f 7479 7065 5f73 697a   = ggml_type_siz
+0007f730: 6528 6e6f 6465 2d3e 7479 7065 292a 6e6f  e(node->type)*no
+0007f740: 6465 2d3e 7372 6330 2d3e 6e65 5b30 5d2a  de->src0->ne[0]*
+0007f750: 6e6f 6465 2d3e 6e5f 7461 736b 733b 0a0a  node->n_tasks;..
+0007f760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f770: 2020 2020 2020 2020 776f 726b 5f73 697a          work_siz
+0007f780: 6520 3d20 4d41 5828 776f 726b 5f73 697a  e = MAX(work_siz
+0007f790: 652c 2063 7572 293b 0a20 2020 2020 2020  e, cur);.       
+0007f7a0: 2020 2020 2020 2020 2020 2020 207d 2062               } b
+0007f7b0: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
+0007f7c0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0007f7d0: 4f50 5f4e 4f4e 453a 0a20 2020 2020 2020  OP_NONE:.       
+0007f7e0: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+0007f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f800: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
+0007f810: 6173 6b73 203d 2031 3b0a 2020 2020 2020  asks = 1;.      
+0007f820: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+0007f830: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+0007f840: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0007f850: 5f4f 505f 434f 554e 543a 0a20 2020 2020  _OP_COUNT:.     
+0007f860: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0007f870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f880: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0007f890: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
+0007f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f8b0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0007f8c0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007f8d0: 7d0a 0a20 2020 2020 2020 2069 6620 2863  }..        if (c
+0007f8e0: 6772 6170 682d 3e77 6f72 6b20 213d 204e  graph->work != N
+0007f8f0: 554c 4c20 2626 2077 6f72 6b5f 7369 7a65  ULL && work_size
+0007f900: 203e 2063 6772 6170 682d 3e77 6f72 6b5f   > cgraph->work_
+0007f910: 7369 7a65 2920 7b0a 2020 2020 2020 2020  size) {.        
+0007f920: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0007f930: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
+0007f940: 2062 6574 7465 7220 6861 6e64 6c69 6e67   better handling
+0007f950: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0007f960: 2020 2020 6966 2028 776f 726b 5f73 697a      if (work_siz
+0007f970: 6520 3e20 3020 2626 2063 6772 6170 682d  e > 0 && cgraph-
+0007f980: 3e77 6f72 6b20 3d3d 204e 554c 4c29 207b  >work == NULL) {
+0007f990: 0a20 2020 2020 2020 2020 2020 2063 6772  .            cgr
+0007f9a0: 6170 682d 3e77 6f72 6b5f 7369 7a65 203d  aph->work_size =
+0007f9b0: 2077 6f72 6b5f 7369 7a65 202b 2043 4143   work_size + CAC
+0007f9c0: 4845 5f4c 494e 455f 5349 5a45 2a28 6e5f  HE_LINE_SIZE*(n_
+0007f9d0: 7468 7265 6164 7320 2d20 3129 3b0a 0a20  threads - 1);.. 
+0007f9e0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0007f9f0: 5052 494e 545f 4445 4255 4728 2225 733a  PRINT_DEBUG("%s:
+0007fa00: 2061 6c6c 6f63 6174 696e 6720 776f 726b   allocating work
+0007fa10: 2062 7566 6665 7220 666f 7220 6772 6170   buffer for grap
+0007fa20: 6820 2825 7a75 2062 7974 6573 295c 6e22  h (%zu bytes)\n"
+0007fa30: 2c20 5f5f 6675 6e63 5f5f 2c20 6367 7261  , __func__, cgra
+0007fa40: 7068 2d3e 776f 726b 5f73 697a 6529 3b0a  ph->work_size);.
+0007fa50: 2020 2020 2020 2020 2020 2020 6367 7261              cgra
+0007fa60: 7068 2d3e 776f 726b 203d 2067 676d 6c5f  ph->work = ggml_
+0007fa70: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
+0007fa80: 782c 2047 474d 4c5f 5459 5045 5f49 382c  x, GGML_TYPE_I8,
+0007fa90: 2063 6772 6170 682d 3e77 6f72 6b5f 7369   cgraph->work_si
+0007faa0: 7a65 293b 0a20 2020 2020 2020 207d 0a20  ze);.        }. 
+0007fab0: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
+0007fac0: 696e 7436 345f 7420 7065 7266 5f73 7461  int64_t perf_sta
+0007fad0: 7274 5f63 7963 6c65 7320 203d 2067 676d  rt_cycles  = ggm
+0007fae0: 6c5f 7065 7266 5f63 7963 6c65 7328 293b  l_perf_cycles();
+0007faf0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0007fb00: 5f74 2070 6572 665f 7374 6172 745f 7469  _t perf_start_ti
+0007fb10: 6d65 5f75 7320 3d20 6767 6d6c 5f70 6572  me_us = ggml_per
+0007fb20: 665f 7469 6d65 5f75 7328 293b 0a0a 2020  f_time_us();..  
+0007fb30: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0007fb40: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
+0007fb50: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
+0007fb60: 2020 2020 2020 4747 4d4c 5f50 5249 4e54        GGML_PRINT
+0007fb70: 5f44 4542 5547 5f35 2822 2573 3a20 2564  _DEBUG_5("%s: %d
+0007fb80: 2f25 645c 6e22 2c20 5f5f 6675 6e63 5f5f  /%d\n", __func__
+0007fb90: 2c20 692c 2063 6772 6170 682d 3e6e 5f6e  , i, cgraph->n_n
+0007fba0: 6f64 6573 293b 0a0a 2020 2020 2020 2020  odes);..        
+0007fbb0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0007fbc0: 6f72 202a 206e 6f64 6520 3d20 6367 7261  or * node = cgra
+0007fbd0: 7068 2d3e 6e6f 6465 735b 695d 3b0a 0a20  ph->nodes[i];.. 
+0007fbe0: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
+0007fbf0: 7468 6973 2063 6f75 6c64 2062 6520 7573  this could be us
+0007fc00: 6564 2074 6f20 6176 6f69 6420 756e 6e65  ed to avoid unne
+0007fc10: 6365 7373 6172 7920 636f 6d70 7574 6174  cessary computat
+0007fc20: 696f 6e73 2c20 6275 7420 6974 206e 6565  ions, but it nee
+0007fc30: 6473 2074 6f20 6265 2069 6d70 726f 7665  ds to be improve
+0007fc40: 640a 2020 2020 2020 2020 2f2f 6966 2028  d.        //if (
+0007fc50: 6e6f 6465 2d3e 6772 6164 203d 3d20 4e55  node->grad == NU
+0007fc60: 4c4c 2026 2620 6e6f 6465 2d3e 7065 7266  LL && node->perf
+0007fc70: 5f72 756e 7320 3e20 3029 207b 0a20 2020  _runs > 0) {.   
+0007fc80: 2020 2020 202f 2f20 2020 2063 6f6e 7469       //    conti
+0007fc90: 6e75 653b 0a20 2020 2020 2020 202f 2f7d  nue;.        //}
+0007fca0: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
+0007fcb0: 696e 7436 345f 7420 7065 7266 5f6e 6f64  int64_t perf_nod
+0007fcc0: 655f 7374 6172 745f 6379 636c 6573 2020  e_start_cycles  
+0007fcd0: 3d20 6767 6d6c 5f70 6572 665f 6379 636c  = ggml_perf_cycl
+0007fce0: 6573 2829 3b0a 2020 2020 2020 2020 636f  es();.        co
+0007fcf0: 6e73 7420 696e 7436 345f 7420 7065 7266  nst int64_t perf
+0007fd00: 5f6e 6f64 655f 7374 6172 745f 7469 6d65  _node_start_time
+0007fd10: 5f75 7320 3d20 6767 6d6c 5f70 6572 665f  _us = ggml_perf_
+0007fd20: 7469 6d65 5f75 7328 293b 0a0a 2020 2020  time_us();..    
+0007fd30: 2020 2020 2f2f 2049 4e49 540a 2020 2020      // INIT.    
+0007fd40: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0007fd50: 636f 6d70 7574 655f 7061 7261 6d73 2070  compute_params p
+0007fd60: 6172 616d 7320 3d20 7b0a 2020 2020 2020  arams = {.      
+0007fd70: 2020 2020 2020 2f2a 2e74 7970 6520 203d        /*.type  =
+0007fd80: 2a2f 2047 474d 4c5f 5441 534b 5f49 4e49  */ GGML_TASK_INI
+0007fd90: 542c 0a20 2020 2020 2020 2020 2020 202f  T,.            /
+0007fda0: 2a2e 6974 6820 2020 3d2a 2f20 302c 0a20  *.ith   =*/ 0,. 
+0007fdb0: 2020 2020 2020 2020 2020 202f 2a2e 6e74             /*.nt
+0007fdc0: 6820 2020 3d2a 2f20 6e6f 6465 2d3e 6e5f  h   =*/ node->n_
+0007fdd0: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
+0007fde0: 2020 202f 2a2e 7773 697a 6520 3d2a 2f20     /*.wsize =*/ 
+0007fdf0: 6367 7261 7068 2d3e 776f 726b 203f 2067  cgraph->work ? g
+0007fe00: 676d 6c5f 6e62 7974 6573 2863 6772 6170  gml_nbytes(cgrap
+0007fe10: 682d 3e77 6f72 6b29 203a 2030 2c0a 2020  h->work) : 0,.  
+0007fe20: 2020 2020 2020 2020 2020 2f2a 2e77 6461            /*.wda
+0007fe30: 7461 203d 2a2f 2063 6772 6170 682d 3e77  ta =*/ cgraph->w
+0007fe40: 6f72 6b20 3f20 6367 7261 7068 2d3e 776f  ork ? cgraph->wo
+0007fe50: 726b 2d3e 6461 7461 203a 204e 554c 4c2c  rk->data : NULL,
+0007fe60: 0a20 2020 2020 2020 207d 3b0a 0a20 2020  .        };..   
+0007fe70: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+0007fe80: 655f 666f 7277 6172 6428 2670 6172 616d  e_forward(&param
+0007fe90: 732c 206e 6f64 6529 3b0a 0a20 2020 2020  s, node);..     
+0007fea0: 2020 202f 2f20 434f 4d50 5554 450a 2020     // COMPUTE.  
+0007feb0: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
+0007fec0: 6e5f 7461 736b 7320 3e20 3129 207b 0a20  n_tasks > 1) {. 
+0007fed0: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
+0007fee0: 746f 6d69 635f 6665 7463 685f 6164 6428  tomic_fetch_add(
+0007fef0: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
+0007ff00: 7265 6164 792c 2031 2920 3d3d 206e 5f74  ready, 1) == n_t
+0007ff10: 6872 6561 6473 202d 2031 2920 7b0a 2020  hreads - 1) {.  
+0007ff20: 2020 2020 2020 2020 2020 2020 2020 6174                at
+0007ff30: 6f6d 6963 5f73 746f 7265 2826 7374 6174  omic_store(&stat
+0007ff40: 655f 7368 6172 6564 2e68 6173 5f77 6f72  e_shared.has_wor
+0007ff50: 6b2c 2066 616c 7365 293b 0a20 2020 2020  k, false);.     
+0007ff60: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0007ff70: 2020 2020 2020 7768 696c 6520 2861 746f        while (ato
+0007ff80: 6d69 635f 6c6f 6164 2826 7374 6174 655f  mic_load(&state_
+0007ff90: 7368 6172 6564 2e68 6173 5f77 6f72 6b29  shared.has_work)
+0007ffa0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007ffb0: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 6c6f      ggml_lock_lo
+0007ffc0: 636b 2020 2826 7374 6174 655f 7368 6172  ck  (&state_shar
+0007ffd0: 6564 2e73 7069 6e29 3b0a 2020 2020 2020  ed.spin);.      
+0007ffe0: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
+0007fff0: 6f63 6b5f 756e 6c6f 636b 2826 7374 6174  ock_unlock(&stat
+00080000: 655f 7368 6172 6564 2e73 7069 6e29 3b0a  e_shared.spin);.
+00080010: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00080020: 2020 2020 2020 2020 2020 202f 2f20 6c61             // la
+00080030: 756e 6368 2074 6872 6561 6420 706f 6f6c  unch thread pool
+00080040: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00080050: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
+00080060: 206e 5f74 6872 6561 6473 202d 2031 3b20   n_threads - 1; 
+00080070: 6a2b 2b29 207b 0a20 2020 2020 2020 2020  j++) {.         
+00080080: 2020 2020 2020 2077 6f72 6b65 7273 5b6a         workers[j
+00080090: 5d2e 7061 7261 6d73 203d 2028 7374 7275  ].params = (stru
+000800a0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+000800b0: 7061 7261 6d73 2920 7b0a 2020 2020 2020  params) {.      
+000800c0: 2020 2020 2020 2020 2020 2020 2020 2e74                .t
+000800d0: 7970 6520 203d 2047 474d 4c5f 5441 534b  ype  = GGML_TASK
+000800e0: 5f43 4f4d 5055 5445 2c0a 2020 2020 2020  _COMPUTE,.      
+000800f0: 2020 2020 2020 2020 2020 2020 2020 2e69                .i
+00080100: 7468 2020 203d 206a 202b 2031 2c0a 2020  th   = j + 1,.  
+00080110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080120: 2020 2e6e 7468 2020 203d 206e 6f64 652d    .nth   = node-
+00080130: 3e6e 5f74 6173 6b73 2c0a 2020 2020 2020  >n_tasks,.      
+00080140: 2020 2020 2020 2020 2020 2020 2020 2e77                .w
+00080150: 7369 7a65 203d 2063 6772 6170 682d 3e77  size = cgraph->w
+00080160: 6f72 6b20 3f20 6767 6d6c 5f6e 6279 7465  ork ? ggml_nbyte
+00080170: 7328 6367 7261 7068 2d3e 776f 726b 2920  s(cgraph->work) 
+00080180: 3a20 302c 0a20 2020 2020 2020 2020 2020  : 0,.           
+00080190: 2020 2020 2020 2020 202e 7764 6174 6120           .wdata 
+000801a0: 3d20 6367 7261 7068 2d3e 776f 726b 203f  = cgraph->work ?
+000801b0: 2063 6772 6170 682d 3e77 6f72 6b2d 3e64   cgraph->work->d
+000801c0: 6174 6120 3a20 4e55 4c4c 2c0a 2020 2020  ata : NULL,.    
+000801d0: 2020 2020 2020 2020 2020 2020 7d3b 0a20              };. 
+000801e0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000801f0: 6f72 6b65 7273 5b6a 5d2e 6e6f 6465 203d  orkers[j].node =
+00080200: 206e 6f64 653b 0a20 2020 2020 2020 2020   node;.         
+00080210: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+00080220: 2020 6174 6f6d 6963 5f66 6574 6368 5f73    atomic_fetch_s
+00080230: 7562 2826 7374 6174 655f 7368 6172 6564  ub(&state_shared
+00080240: 2e6e 5f72 6561 6479 2c20 3129 3b0a 0a20  .n_ready, 1);.. 
+00080250: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+00080260: 2028 6174 6f6d 6963 5f6c 6f61 6428 2673   (atomic_load(&s
+00080270: 7461 7465 5f73 6861 7265 642e 6e5f 7265  tate_shared.n_re
+00080280: 6164 7929 203e 2030 2920 7b0a 2020 2020  ady) > 0) {.    
+00080290: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000802a0: 5f6c 6f63 6b5f 6c6f 636b 2020 2826 7374  _lock_lock  (&st
+000802b0: 6174 655f 7368 6172 6564 2e73 7069 6e29  ate_shared.spin)
+000802c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000802d0: 2020 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f    ggml_lock_unlo
+000802e0: 636b 2826 7374 6174 655f 7368 6172 6564  ck(&state_shared
+000802f0: 2e73 7069 6e29 3b0a 2020 2020 2020 2020  .spin);.        
+00080300: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00080310: 2020 2061 746f 6d69 635f 7374 6f72 6528     atomic_store(
+00080320: 2673 7461 7465 5f73 6861 7265 642e 6861  &state_shared.ha
+00080330: 735f 776f 726b 2c20 7472 7565 293b 0a20  s_work, true);. 
+00080340: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00080350: 2020 7061 7261 6d73 2e74 7970 6520 3d20    params.type = 
+00080360: 4747 4d4c 5f54 4153 4b5f 434f 4d50 5554  GGML_TASK_COMPUT
+00080370: 453b 0a20 2020 2020 2020 2067 676d 6c5f  E;.        ggml_
+00080380: 636f 6d70 7574 655f 666f 7277 6172 6428  compute_forward(
+00080390: 2670 6172 616d 732c 206e 6f64 6529 3b0a  &params, node);.
+000803a0: 0a20 2020 2020 2020 202f 2f20 7761 6974  .        // wait
+000803b0: 2066 6f72 2074 6872 6561 6420 706f 6f6c   for thread pool
+000803c0: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
+000803d0: 652d 3e6e 5f74 6173 6b73 203e 2031 2920  e->n_tasks > 1) 
+000803e0: 7b0a 2020 2020 2020 2020 2020 2020 6966  {.            if
+000803f0: 2028 6174 6f6d 6963 5f66 6574 6368 5f61   (atomic_fetch_a
+00080400: 6464 2826 7374 6174 655f 7368 6172 6564  dd(&state_shared
+00080410: 2e6e 5f72 6561 6479 2c20 3129 203d 3d20  .n_ready, 1) == 
+00080420: 6e5f 7468 7265 6164 7320 2d20 3129 207b  n_threads - 1) {
+00080430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00080440: 2061 746f 6d69 635f 7374 6f72 6528 2673   atomic_store(&s
+00080450: 7461 7465 5f73 6861 7265 642e 6861 735f  tate_shared.has_
+00080460: 776f 726b 2c20 6661 6c73 6529 3b0a 2020  work, false);.  
+00080470: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00080480: 2020 2020 2020 2020 2077 6869 6c65 2028           while (
+00080490: 6174 6f6d 6963 5f6c 6f61 6428 2673 7461  atomic_load(&sta
+000804a0: 7465 5f73 6861 7265 642e 6861 735f 776f  te_shared.has_wo
+000804b0: 726b 2929 207b 0a20 2020 2020 2020 2020  rk)) {.         
+000804c0: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
+000804d0: 5f6c 6f63 6b20 2028 2673 7461 7465 5f73  _lock  (&state_s
+000804e0: 6861 7265 642e 7370 696e 293b 0a20 2020  hared.spin);.   
+000804f0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00080500: 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28 2673  l_lock_unlock(&s
+00080510: 7461 7465 5f73 6861 7265 642e 7370 696e  tate_shared.spin
+00080520: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00080530: 0a0a 2020 2020 2020 2020 2020 2020 6174  ..            at
+00080540: 6f6d 6963 5f66 6574 6368 5f73 7562 2826  omic_fetch_sub(&
+00080550: 7374 6174 655f 7368 6172 6564 2e6e 5f72  state_shared.n_r
+00080560: 6561 6479 2c20 3129 3b0a 0a20 2020 2020  eady, 1);..     
+00080570: 2020 2020 2020 2077 6869 6c65 2028 6174         while (at
+00080580: 6f6d 6963 5f6c 6f61 6428 2673 7461 7465  omic_load(&state
+00080590: 5f73 6861 7265 642e 6e5f 7265 6164 7929  _shared.n_ready)
+000805a0: 2021 3d20 3029 207b 0a20 2020 2020 2020   != 0) {.       
+000805b0: 2020 2020 2020 2020 2067 676d 6c5f 6c6f           ggml_lo
+000805c0: 636b 5f6c 6f63 6b20 2028 2673 7461 7465  ck_lock  (&state
+000805d0: 5f73 6861 7265 642e 7370 696e 293b 0a20  _shared.spin);. 
+000805e0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000805f0: 676d 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28  gml_lock_unlock(
+00080600: 2673 7461 7465 5f73 6861 7265 642e 7370  &state_shared.sp
+00080610: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
+00080620: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
+00080630: 2020 2020 2020 2f2f 2046 494e 414c 495a        // FINALIZ
+00080640: 450a 2020 2020 2020 2020 6966 2028 6e6f  E.        if (no
+00080650: 6465 2d3e 6e5f 7461 736b 7320 3e20 3129  de->n_tasks > 1)
+00080660: 207b 0a20 2020 2020 2020 2020 2020 2069   {.            i
+00080670: 6620 2861 746f 6d69 635f 6665 7463 685f  f (atomic_fetch_
+00080680: 6164 6428 2673 7461 7465 5f73 6861 7265  add(&state_share
+00080690: 642e 6e5f 7265 6164 792c 2031 2920 3d3d  d.n_ready, 1) ==
+000806a0: 206e 5f74 6872 6561 6473 202d 2031 2920   n_threads - 1) 
+000806b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000806c0: 2020 6174 6f6d 6963 5f73 746f 7265 2826    atomic_store(&
+000806d0: 7374 6174 655f 7368 6172 6564 2e68 6173  state_shared.has
+000806e0: 5f77 6f72 6b2c 2066 616c 7365 293b 0a20  _work, false);. 
+000806f0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+00080700: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+00080710: 2861 746f 6d69 635f 6c6f 6164 2826 7374  (atomic_load(&st
+00080720: 6174 655f 7368 6172 6564 2e68 6173 5f77  ate_shared.has_w
+00080730: 6f72 6b29 2920 7b0a 2020 2020 2020 2020  ork)) {.        
+00080740: 2020 2020 2020 2020 6767 6d6c 5f6c 6f63          ggml_loc
+00080750: 6b5f 6c6f 636b 2020 2826 7374 6174 655f  k_lock  (&state_
+00080760: 7368 6172 6564 2e73 7069 6e29 3b0a 2020  shared.spin);.  
+00080770: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00080780: 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b 2826  ml_lock_unlock(&
+00080790: 7374 6174 655f 7368 6172 6564 2e73 7069  state_shared.spi
+000807a0: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
+000807b0: 7d0a 0a20 2020 2020 2020 2020 2020 202f  }..            /
+000807c0: 2f20 6c61 756e 6368 2074 6872 6561 6420  / launch thread 
+000807d0: 706f 6f6c 0a20 2020 2020 2020 2020 2020  pool.           
+000807e0: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+000807f0: 206a 203c 206e 5f74 6872 6561 6473 202d   j < n_threads -
+00080800: 2031 3b20 6a2b 2b29 207b 0a20 2020 2020   1; j++) {.     
+00080810: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00080820: 7273 5b6a 5d2e 7061 7261 6d73 203d 2028  rs[j].params = (
+00080830: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00080840: 7574 655f 7061 7261 6d73 2920 7b0a 2020  ute_params) {.  
+00080850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080860: 2020 2e74 7970 6520 203d 2047 474d 4c5f    .type  = GGML_
+00080870: 5441 534b 5f46 494e 414c 495a 452c 0a20  TASK_FINALIZE,. 
+00080880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080890: 2020 202e 6974 6820 2020 3d20 6a20 2b20     .ith   = j + 
+000808a0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+000808b0: 2020 2020 2020 202e 6e74 6820 2020 3d20         .nth   = 
+000808c0: 6e6f 6465 2d3e 6e5f 7461 736b 732c 0a20  node->n_tasks,. 
+000808d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000808e0: 2020 202e 7773 697a 6520 3d20 6367 7261     .wsize = cgra
+000808f0: 7068 2d3e 776f 726b 203f 2067 676d 6c5f  ph->work ? ggml_
+00080900: 6e62 7974 6573 2863 6772 6170 682d 3e77  nbytes(cgraph->w
+00080910: 6f72 6b29 203a 2030 2c0a 2020 2020 2020  ork) : 0,.      
+00080920: 2020 2020 2020 2020 2020 2020 2020 2e77                .w
+00080930: 6461 7461 203d 2063 6772 6170 682d 3e77  data = cgraph->w
+00080940: 6f72 6b20 3f20 6367 7261 7068 2d3e 776f  ork ? cgraph->wo
+00080950: 726b 2d3e 6461 7461 203a 204e 554c 4c2c  rk->data : NULL,
+00080960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00080970: 207d 3b0a 2020 2020 2020 2020 2020 2020   };.            
+00080980: 2020 2020 776f 726b 6572 735b 6a5d 2e6e      workers[j].n
+00080990: 6f64 6520 3d20 6e6f 6465 3b0a 2020 2020  ode = node;.    
+000809a0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000809b0: 2020 2020 2020 2061 746f 6d69 635f 6665         atomic_fe
+000809c0: 7463 685f 7375 6228 2673 7461 7465 5f73  tch_sub(&state_s
+000809d0: 6861 7265 642e 6e5f 7265 6164 792c 2031  hared.n_ready, 1
+000809e0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+000809f0: 7768 696c 6520 2861 746f 6d69 635f 6c6f  while (atomic_lo
+00080a00: 6164 2826 7374 6174 655f 7368 6172 6564  ad(&state_shared
+00080a10: 2e6e 5f72 6561 6479 2920 3e20 3029 207b  .n_ready) > 0) {
+00080a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00080a30: 2067 676d 6c5f 6c6f 636b 5f6c 6f63 6b20   ggml_lock_lock 
+00080a40: 2028 2673 7461 7465 5f73 6861 7265 642e   (&state_shared.
+00080a50: 7370 696e 293b 0a20 2020 2020 2020 2020  spin);.         
+00080a60: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
+00080a70: 5f75 6e6c 6f63 6b28 2673 7461 7465 5f73  _unlock(&state_s
+00080a80: 6861 7265 642e 7370 696e 293b 0a20 2020  hared.spin);.   
+00080a90: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+00080aa0: 2020 2020 2020 2020 6174 6f6d 6963 5f73          atomic_s
+00080ab0: 746f 7265 2826 7374 6174 655f 7368 6172  tore(&state_shar
+00080ac0: 6564 2e68 6173 5f77 6f72 6b2c 2074 7275  ed.has_work, tru
+00080ad0: 6529 3b0a 2020 2020 2020 2020 7d0a 0a20  e);.        }.. 
+00080ae0: 2020 2020 2020 2070 6172 616d 732e 7479         params.ty
+00080af0: 7065 203d 2047 474d 4c5f 5441 534b 5f46  pe = GGML_TASK_F
+00080b00: 494e 414c 495a 453b 0a20 2020 2020 2020  INALIZE;.       
+00080b10: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00080b20: 7277 6172 6428 2670 6172 616d 732c 206e  rward(&params, n
+00080b30: 6f64 6529 3b0a 0a20 2020 2020 2020 202f  ode);..        /
+00080b40: 2f20 7761 6974 2066 6f72 2074 6872 6561  / wait for threa
+00080b50: 6420 706f 6f6c 0a20 2020 2020 2020 2069  d pool.        i
+00080b60: 6620 286e 6f64 652d 3e6e 5f74 6173 6b73  f (node->n_tasks
+00080b70: 203e 2031 2920 7b0a 2020 2020 2020 2020   > 1) {.        
+00080b80: 2020 2020 6966 2028 6174 6f6d 6963 5f66      if (atomic_f
+00080b90: 6574 6368 5f61 6464 2826 7374 6174 655f  etch_add(&state_
+00080ba0: 7368 6172 6564 2e6e 5f72 6561 6479 2c20  shared.n_ready, 
+00080bb0: 3129 203d 3d20 6e5f 7468 7265 6164 7320  1) == n_threads 
+00080bc0: 2d20 3129 207b 0a20 2020 2020 2020 2020  - 1) {.         
+00080bd0: 2020 2020 2020 2061 746f 6d69 635f 7374         atomic_st
+00080be0: 6f72 6528 2673 7461 7465 5f73 6861 7265  ore(&state_share
+00080bf0: 642e 6861 735f 776f 726b 2c20 6661 6c73  d.has_work, fals
+00080c00: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00080c10: 7d0a 0a20 2020 2020 2020 2020 2020 2077  }..            w
+00080c20: 6869 6c65 2028 6174 6f6d 6963 5f6c 6f61  hile (atomic_loa
+00080c30: 6428 2673 7461 7465 5f73 6861 7265 642e  d(&state_shared.
+00080c40: 6861 735f 776f 726b 2929 207b 0a20 2020  has_work)) {.   
+00080c50: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00080c60: 6c5f 6c6f 636b 5f6c 6f63 6b20 2028 2673  l_lock_lock  (&s
+00080c70: 7461 7465 5f73 6861 7265 642e 7370 696e  tate_shared.spin
+00080c80: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00080c90: 2020 2067 676d 6c5f 6c6f 636b 5f75 6e6c     ggml_lock_unl
+00080ca0: 6f63 6b28 2673 7461 7465 5f73 6861 7265  ock(&state_share
+00080cb0: 642e 7370 696e 293b 0a20 2020 2020 2020  d.spin);.       
+00080cc0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00080cd0: 2020 2020 6174 6f6d 6963 5f66 6574 6368      atomic_fetch
+00080ce0: 5f73 7562 2826 7374 6174 655f 7368 6172  _sub(&state_shar
+00080cf0: 6564 2e6e 5f72 6561 6479 2c20 3129 3b0a  ed.n_ready, 1);.
+00080d00: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
+00080d10: 6c65 2028 6174 6f6d 6963 5f6c 6f61 6428  le (atomic_load(
+00080d20: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
+00080d30: 7265 6164 7929 2021 3d20 3029 207b 0a20  ready) != 0) {. 
+00080d40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00080d50: 676d 6c5f 6c6f 636b 5f6c 6f63 6b20 2028  gml_lock_lock  (
+00080d60: 2673 7461 7465 5f73 6861 7265 642e 7370  &state_shared.sp
+00080d70: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
+00080d80: 2020 2020 2067 676d 6c5f 6c6f 636b 5f75       ggml_lock_u
+00080d90: 6e6c 6f63 6b28 2673 7461 7465 5f73 6861  nlock(&state_sha
+00080da0: 7265 642e 7370 696e 293b 0a20 2020 2020  red.spin);.     
+00080db0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00080dc0: 207d 0a0a 2020 2020 2020 2020 2f2f 2070   }..        // p
+00080dd0: 6572 666f 726d 616e 6365 2073 7461 7473  erformance stats
+00080de0: 2028 6e6f 6465 290a 2020 2020 2020 2020   (node).        
+00080df0: 7b0a 2020 2020 2020 2020 2020 2020 696e  {.            in
+00080e00: 7436 345f 7420 7065 7266 5f63 7963 6c65  t64_t perf_cycle
+00080e10: 735f 6375 7220 203d 2067 676d 6c5f 7065  s_cur  = ggml_pe
+00080e20: 7266 5f63 7963 6c65 7328 2920 202d 2070  rf_cycles()  - p
+00080e30: 6572 665f 6e6f 6465 5f73 7461 7274 5f63  erf_node_start_c
+00080e40: 7963 6c65 733b 0a20 2020 2020 2020 2020  ycles;.         
+00080e50: 2020 2069 6e74 3634 5f74 2070 6572 665f     int64_t perf_
+00080e60: 7469 6d65 5f75 735f 6375 7220 3d20 6767  time_us_cur = gg
+00080e70: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
+00080e80: 2920 2d20 7065 7266 5f6e 6f64 655f 7374  ) - perf_node_st
+00080e90: 6172 745f 7469 6d65 5f75 733b 0a0a 2020  art_time_us;..  
+00080ea0: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
+00080eb0: 7065 7266 5f72 756e 732b 2b3b 0a20 2020  perf_runs++;.   
+00080ec0: 2020 2020 2020 2020 206e 6f64 652d 3e70           node->p
+00080ed0: 6572 665f 6379 636c 6573 2020 2b3d 2070  erf_cycles  += p
+00080ee0: 6572 665f 6379 636c 6573 5f63 7572 3b0a  erf_cycles_cur;.
+00080ef0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00080f00: 2d3e 7065 7266 5f74 696d 655f 7573 202b  ->perf_time_us +
+00080f10: 3d20 7065 7266 5f74 696d 655f 7573 5f63  = perf_time_us_c
+00080f20: 7572 3b0a 2020 2020 2020 2020 7d0a 2020  ur;.        }.  
+00080f30: 2020 7d0a 0a20 2020 202f 2f20 6a6f 696e    }..    // join
+00080f40: 2074 6872 6561 6420 706f 6f6c 0a20 2020   thread pool.   
+00080f50: 2069 6620 286e 5f74 6872 6561 6473 203e   if (n_threads >
+00080f60: 2031 2920 7b0a 2020 2020 2020 2020 6174   1) {.        at
+00080f70: 6f6d 6963 5f73 746f 7265 2826 7374 6174  omic_store(&stat
+00080f80: 655f 7368 6172 6564 2e73 746f 702c 2074  e_shared.stop, t
+00080f90: 7275 6529 3b0a 2020 2020 2020 2020 6174  rue);.        at
+00080fa0: 6f6d 6963 5f73 746f 7265 2826 7374 6174  omic_store(&stat
+00080fb0: 655f 7368 6172 6564 2e68 6173 5f77 6f72  e_shared.has_wor
+00080fc0: 6b2c 2074 7275 6529 3b0a 0a20 2020 2020  k, true);..     
+00080fd0: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
+00080fe0: 303b 206a 203c 206e 5f74 6872 6561 6473  0; j < n_threads
+00080ff0: 202d 2031 3b20 6a2b 2b29 207b 0a20 2020   - 1; j++) {.   
+00081000: 2020 2020 2020 2020 2069 6e74 2072 6320           int rc 
+00081010: 3d20 6767 6d6c 5f74 6872 6561 645f 6a6f  = ggml_thread_jo
+00081020: 696e 2877 6f72 6b65 7273 5b6a 5d2e 7468  in(workers[j].th
+00081030: 7264 2c20 4e55 4c4c 293b 0a20 2020 2020  rd, NULL);.     
+00081040: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00081050: 5254 2872 6320 3d3d 2030 293b 0a20 2020  RT(rc == 0);.   
+00081060: 2020 2020 2020 2020 2055 4e55 5345 4428           UNUSED(
+00081070: 7263 293b 0a20 2020 2020 2020 207d 0a0a  rc);.        }..
+00081080: 2020 2020 2020 2020 6767 6d6c 5f6c 6f63          ggml_loc
+00081090: 6b5f 6465 7374 726f 7928 2673 7461 7465  k_destroy(&state
+000810a0: 5f73 6861 7265 642e 7370 696e 293b 0a20  _shared.spin);. 
+000810b0: 2020 207d 0a0a 2020 2020 2f2f 2070 6572     }..    // per
+000810c0: 666f 726d 616e 6365 2073 7461 7473 2028  formance stats (
+000810d0: 6772 6170 6829 0a20 2020 207b 0a20 2020  graph).    {.   
+000810e0: 2020 2020 2069 6e74 3634 5f74 2070 6572       int64_t per
+000810f0: 665f 6379 636c 6573 5f63 7572 2020 3d20  f_cycles_cur  = 
+00081100: 6767 6d6c 5f70 6572 665f 6379 636c 6573  ggml_perf_cycles
+00081110: 2829 2020 2d20 7065 7266 5f73 7461 7274  ()  - perf_start
+00081120: 5f63 7963 6c65 733b 0a20 2020 2020 2020  _cycles;.       
+00081130: 2069 6e74 3634 5f74 2070 6572 665f 7469   int64_t perf_ti
+00081140: 6d65 5f75 735f 6375 7220 3d20 6767 6d6c  me_us_cur = ggml
+00081150: 5f70 6572 665f 7469 6d65 5f75 7328 2920  _perf_time_us() 
+00081160: 2d20 7065 7266 5f73 7461 7274 5f74 696d  - perf_start_tim
+00081170: 655f 7573 3b0a 0a20 2020 2020 2020 2063  e_us;..        c
+00081180: 6772 6170 682d 3e70 6572 665f 7275 6e73  graph->perf_runs
+00081190: 2b2b 3b0a 2020 2020 2020 2020 6367 7261  ++;.        cgra
+000811a0: 7068 2d3e 7065 7266 5f63 7963 6c65 7320  ph->perf_cycles 
+000811b0: 202b 3d20 7065 7266 5f63 7963 6c65 735f   += perf_cycles_
+000811c0: 6375 723b 0a20 2020 2020 2020 2063 6772  cur;.        cgr
+000811d0: 6170 682d 3e70 6572 665f 7469 6d65 5f75  aph->perf_time_u
+000811e0: 7320 2b3d 2070 6572 665f 7469 6d65 5f75  s += perf_time_u
+000811f0: 735f 6375 723b 0a0a 2020 2020 2020 2020  s_cur;..        
+00081200: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+00081210: 2822 2573 3a20 7065 7266 2028 2564 2920  ("%s: perf (%d) 
+00081220: 2d20 6370 7520 3d20 252e 3366 202f 2025  - cpu = %.3f / %
+00081230: 2e33 6620 6d73 2c20 7761 6c6c 203d 2025  .3f ms, wall = %
+00081240: 2e33 6620 2f20 252e 3366 206d 735c 6e22  .3f / %.3f ms\n"
+00081250: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00081260: 2020 5f5f 6675 6e63 5f5f 2c20 6367 7261    __func__, cgra
+00081270: 7068 2d3e 7065 7266 5f72 756e 732c 0a20  ph->perf_runs,. 
+00081280: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00081290: 646f 7562 6c65 2920 7065 7266 5f63 7963  double) perf_cyc
+000812a0: 6c65 735f 6375 7220 2020 2020 202f 2028  les_cur      / (
+000812b0: 646f 7562 6c65 2920 6767 6d6c 5f63 7963  double) ggml_cyc
+000812c0: 6c65 735f 7065 725f 6d73 2829 2c0a 2020  les_per_ms(),.  
+000812d0: 2020 2020 2020 2020 2020 2020 2020 2864                (d
+000812e0: 6f75 626c 6529 2063 6772 6170 682d 3e70  ouble) cgraph->p
+000812f0: 6572 665f 6379 636c 6573 2020 2f20 2864  erf_cycles  / (d
+00081300: 6f75 626c 6529 2067 676d 6c5f 6379 636c  ouble) ggml_cycl
+00081310: 6573 5f70 6572 5f6d 7328 2920 2f20 2864  es_per_ms() / (d
+00081320: 6f75 626c 6529 2063 6772 6170 682d 3e70  ouble) cgraph->p
+00081330: 6572 665f 7275 6e73 2c0a 2020 2020 2020  erf_runs,.      
+00081340: 2020 2020 2020 2020 2020 2864 6f75 626c            (doubl
+00081350: 6529 2070 6572 665f 7469 6d65 5f75 735f  e) perf_time_us_
+00081360: 6375 7220 2020 2020 2f20 3130 3030 2e30  cur     / 1000.0
+00081370: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00081380: 2020 2864 6f75 626c 6529 2063 6772 6170    (double) cgrap
+00081390: 682d 3e70 6572 665f 7469 6d65 5f75 7320  h->perf_time_us 
+000813a0: 2f20 3130 3030 2e30 202f 2063 6772 6170  / 1000.0 / cgrap
+000813b0: 682d 3e70 6572 665f 7275 6e73 293b 0a20  h->perf_runs);. 
+000813c0: 2020 207d 0a7d 0a0a 766f 6964 2067 676d     }.}..void ggm
+000813d0: 6c5f 6772 6170 685f 7265 7365 7428 7374  l_graph_reset(st
+000813e0: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
+000813f0: 202a 2063 6772 6170 6829 207b 0a20 2020   * cgraph) {.   
+00081400: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00081410: 2069 203c 2063 6772 6170 682d 3e6e 5f6e   i < cgraph->n_n
+00081420: 6f64 6573 3b20 692b 2b29 207b 0a20 2020  odes; i++) {.   
+00081430: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00081440: 5f74 656e 736f 7220 2a20 6772 6164 203d  _tensor * grad =
+00081450: 2063 6772 6170 682d 3e67 7261 6473 5b69   cgraph->grads[i
+00081460: 5d3b 0a0a 2020 2020 2020 2020 6966 2028  ];..        if (
+00081470: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00081480: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
+00081490: 6f28 6772 6164 293b 0a20 2020 2020 2020  o(grad);.       
+000814a0: 207d 0a20 2020 207d 0a7d 0a0a 7374 7275   }.    }.}..stru
+000814b0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000814c0: 2067 676d 6c5f 6772 6170 685f 6765 745f   ggml_graph_get_
+000814d0: 7465 6e73 6f72 2873 7472 7563 7420 6767  tensor(struct gg
+000814e0: 6d6c 5f63 6772 6170 6820 2a20 6367 7261  ml_cgraph * cgra
+000814f0: 7068 2c20 636f 6e73 7420 6368 6172 202a  ph, const char *
+00081500: 206e 616d 6529 207b 0a20 2020 2066 6f72   name) {.    for
+00081510: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00081520: 2063 6772 6170 682d 3e6e 5f6c 6561 6673   cgraph->n_leafs
+00081530: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+00081540: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00081550: 736f 7220 2a20 6c65 6166 203d 2063 6772  sor * leaf = cgr
+00081560: 6170 682d 3e6c 6561 6673 5b69 5d3b 0a0a  aph->leafs[i];..
+00081570: 2020 2020 2020 2020 6966 2028 7374 7263          if (strc
+00081580: 6d70 286c 6561 662d 3e6e 616d 652c 206e  mp(leaf->name, n
+00081590: 616d 6529 203d 3d20 3029 207b 0a20 2020  ame) == 0) {.   
+000815a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000815b0: 6c65 6166 3b0a 2020 2020 2020 2020 7d0a  leaf;.        }.
+000815c0: 2020 2020 7d0a 0a20 2020 2066 6f72 2028      }..    for (
+000815d0: 696e 7420 6920 3d20 303b 2069 203c 2063  int i = 0; i < c
+000815e0: 6772 6170 682d 3e6e 5f6e 6f64 6573 3b20  graph->n_nodes; 
+000815f0: 692b 2b29 207b 0a20 2020 2020 2020 2073  i++) {.        s
+00081600: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00081610: 7220 2a20 6e6f 6465 203d 2063 6772 6170  r * node = cgrap
+00081620: 682d 3e6e 6f64 6573 5b69 5d3b 0a0a 2020  h->nodes[i];..  
+00081630: 2020 2020 2020 6966 2028 7374 7263 6d70        if (strcmp
+00081640: 286e 6f64 652d 3e6e 616d 652c 206e 616d  (node->name, nam
+00081650: 6529 203d 3d20 3029 207b 0a20 2020 2020  e) == 0) {.     
+00081660: 2020 2020 2020 2072 6574 7572 6e20 6e6f         return no
+00081670: 6465 3b0a 2020 2020 2020 2020 7d0a 2020  de;.        }.  
+00081680: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
+00081690: 4e55 4c4c 3b0a 7d0a 0a73 7461 7469 6320  NULL;.}..static 
+000816a0: 766f 6964 2067 676d 6c5f 6772 6170 685f  void ggml_graph_
+000816b0: 6578 706f 7274 5f6c 6561 6628 636f 6e73  export_leaf(cons
+000816c0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+000816d0: 6e73 6f72 202a 2074 656e 736f 722c 2046  nsor * tensor, F
+000816e0: 494c 4520 2a20 666f 7574 2920 7b0a 2020  ILE * fout) {.  
+000816f0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00081700: 2a20 6e65 203d 2074 656e 736f 722d 3e6e  * ne = tensor->n
+00081710: 653b 0a20 2020 2063 6f6e 7374 2073 697a  e;.    const siz
+00081720: 655f 7420 202a 206e 6220 3d20 7465 6e73  e_t  * nb = tens
+00081730: 6f72 2d3e 6e62 3b0a 0a20 2020 2066 7072  or->nb;..    fpr
+00081740: 696e 7466 2866 6f75 742c 2022 252d 3673  intf(fout, "%-6s
+00081750: 2025 2d31 3273 2025 3864 2025 2220 5052   %-12s %8d %" PR
+00081760: 4964 3634 2022 2025 2220 5052 4964 3634  Id64 " %" PRId64
+00081770: 2022 2025 2220 5052 4964 3634 2022 2025   " %" PRId64 " %
+00081780: 2220 5052 4964 3634 2022 2025 3136 7a75  " PRId64 " %16zu
+00081790: 2025 3136 7a75 2025 3136 7a75 2025 3136   %16zu %16zu %16
+000817a0: 7a75 2025 3136 7020 2533 3273 5c6e 222c  zu %16p %32s\n",
+000817b0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+000817c0: 6c5f 7479 7065 5f6e 616d 6528 7465 6e73  l_type_name(tens
+000817d0: 6f72 2d3e 7479 7065 292c 0a20 2020 2020  or->type),.     
+000817e0: 2020 2020 2020 2067 676d 6c5f 6f70 5f6e         ggml_op_n
+000817f0: 616d 6520 2028 7465 6e73 6f72 2d3e 6f70  ame  (tensor->op
+00081800: 292c 0a20 2020 2020 2020 2020 2020 2074  ),.            t
+00081810: 656e 736f 722d 3e6e 5f64 696d 732c 0a20  ensor->n_dims,. 
+00081820: 2020 2020 2020 2020 2020 206e 655b 305d             ne[0]
+00081830: 2c20 6e65 5b31 5d2c 206e 655b 325d 2c20  , ne[1], ne[2], 
+00081840: 6e65 5b33 5d2c 0a20 2020 2020 2020 2020  ne[3],.         
+00081850: 2020 206e 625b 305d 2c20 6e62 5b31 5d2c     nb[0], nb[1],
+00081860: 206e 625b 325d 2c20 6e62 5b33 5d2c 0a20   nb[2], nb[3],. 
+00081870: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+00081880: 722d 3e64 6174 612c 0a20 2020 2020 2020  r->data,.       
+00081890: 2020 2020 2074 656e 736f 722d 3e6e 616d       tensor->nam
+000818a0: 6529 3b0a 7d0a 0a73 7461 7469 6320 766f  e);.}..static vo
+000818b0: 6964 2067 676d 6c5f 6772 6170 685f 6578  id ggml_graph_ex
+000818c0: 706f 7274 5f6e 6f64 6528 636f 6e73 7420  port_node(const 
+000818d0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000818e0: 6f72 202a 2074 656e 736f 722c 2063 6f6e  or * tensor, con
+000818f0: 7374 2063 6861 7220 2a20 6172 672c 2046  st char * arg, F
+00081900: 494c 4520 2a20 666f 7574 2920 7b0a 2020  ILE * fout) {.  
+00081910: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00081920: 2a20 6e65 203d 2074 656e 736f 722d 3e6e  * ne = tensor->n
+00081930: 653b 0a20 2020 2063 6f6e 7374 2073 697a  e;.    const siz
+00081940: 655f 7420 202a 206e 6220 3d20 7465 6e73  e_t  * nb = tens
+00081950: 6f72 2d3e 6e62 3b0a 0a20 2020 2066 7072  or->nb;..    fpr
+00081960: 696e 7466 2866 6f75 742c 2022 252d 3673  intf(fout, "%-6s
+00081970: 2025 2d36 7320 252d 3132 7320 2538 6420   %-6s %-12s %8d 
+00081980: 2522 2050 5249 6436 3420 2220 2522 2050  %" PRId64 " %" P
+00081990: 5249 6436 3420 2220 2522 2050 5249 6436  RId64 " %" PRId6
+000819a0: 3420 2220 2522 2050 5249 6436 3420 2220  4 " %" PRId64 " 
+000819b0: 2531 367a 7520 2531 367a 7520 2531 367a  %16zu %16zu %16z
+000819c0: 7520 2531 367a 7520 2538 6420 2531 3670  u %16zu %8d %16p
+000819d0: 2025 3332 735c 6e22 2c0a 2020 2020 2020   %32s\n",.      
+000819e0: 2020 2020 2020 6172 672c 0a20 2020 2020        arg,.     
+000819f0: 2020 2020 2020 2067 676d 6c5f 7479 7065         ggml_type
+00081a00: 5f6e 616d 6528 7465 6e73 6f72 2d3e 7479  _name(tensor->ty
+00081a10: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
+00081a20: 2067 676d 6c5f 6f70 5f6e 616d 6520 2028   ggml_op_name  (
+00081a30: 7465 6e73 6f72 2d3e 6f70 292c 0a20 2020  tensor->op),.   
+00081a40: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+00081a50: 3e6e 5f64 696d 732c 0a20 2020 2020 2020  >n_dims,.       
+00081a60: 2020 2020 206e 655b 305d 2c20 6e65 5b31       ne[0], ne[1
+00081a70: 5d2c 206e 655b 325d 2c20 6e65 5b33 5d2c  ], ne[2], ne[3],
+00081a80: 0a20 2020 2020 2020 2020 2020 206e 625b  .            nb[
+00081a90: 305d 2c20 6e62 5b31 5d2c 206e 625b 325d  0], nb[1], nb[2]
+00081aa0: 2c20 6e62 5b33 5d2c 0a20 2020 2020 2020  , nb[3],.       
+00081ab0: 2020 2020 2074 656e 736f 722d 3e6e 5f74       tensor->n_t
+00081ac0: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+00081ad0: 2020 7465 6e73 6f72 2d3e 6461 7461 2c0a    tensor->data,.
+00081ae0: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+00081af0: 6f72 2d3e 6e61 6d65 293b 0a7d 0a0a 766f  or->name);.}..vo
+00081b00: 6964 2067 676d 6c5f 6772 6170 685f 6578  id ggml_graph_ex
+00081b10: 706f 7274 2863 6f6e 7374 2073 7472 7563  port(const struc
+00081b20: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+00081b30: 6367 7261 7068 2c20 636f 6e73 7420 6368  cgraph, const ch
+00081b40: 6172 202a 2066 6e61 6d65 2920 7b0a 2020  ar * fname) {.  
+00081b50: 2020 2f2f 6173 7365 7274 2863 6772 6170    //assert(cgrap
+00081b60: 682d 3e77 6f72 6b20 2020 2020 203d 3d20  h->work      == 
+00081b70: 4e55 4c4c 293b 0a20 2020 202f 2f61 7373  NULL);.    //ass
+00081b80: 6572 7428 6367 7261 7068 2d3e 776f 726b  ert(cgraph->work
+00081b90: 5f73 697a 6520 3d3d 2030 293b 0a0a 2020  _size == 0);..  
+00081ba0: 2020 7569 6e74 3634 5f74 2073 697a 655f    uint64_t size_
+00081bb0: 6576 616c 203d 2030 3b0a 0a20 2020 202f  eval = 0;..    /
+00081bc0: 2f20 636f 6d70 7574 6520 7369 7a65 206f  / compute size o
+00081bd0: 6620 696e 7465 726d 6564 6961 7465 2072  f intermediate r
+00081be0: 6573 756c 7473 0a20 2020 202f 2f20 544f  esults.    // TO
+00081bf0: 444f 3a20 646f 6573 206e 6f74 2074 616b  DO: does not tak
+00081c00: 6520 696e 746f 2061 6363 6f75 6e74 2073  e into account s
+00081c10: 6372 6174 6368 2062 7566 6665 7273 2021  cratch buffers !
+00081c20: 2121 210a 2020 2020 666f 7220 2869 6e74  !!!.    for (int
+00081c30: 2069 203d 2030 3b20 6920 3c20 6367 7261   i = 0; i < cgra
+00081c40: 7068 2d3e 6e5f 6e6f 6465 733b 202b 2b69  ph->n_nodes; ++i
+00081c50: 2920 7b0a 2020 2020 2020 2020 7369 7a65  ) {.        size
+00081c60: 5f65 7661 6c20 2b3d 2067 676d 6c5f 6e62  _eval += ggml_nb
+00081c70: 7974 6573 2863 6772 6170 682d 3e6e 6f64  ytes(cgraph->nod
+00081c80: 6573 5b69 5d29 3b0a 2020 2020 7d0a 0a20  es[i]);.    }.. 
+00081c90: 2020 202f 2f20 7072 696e 740a 2020 2020     // print.    
+00081ca0: 7b0a 2020 2020 2020 2020 4649 4c45 202a  {.        FILE *
+00081cb0: 2066 6f75 7420 3d20 7374 646f 7574 3b0a   fout = stdout;.
+00081cc0: 0a20 2020 2020 2020 2066 7072 696e 7466  .        fprintf
+00081cd0: 2866 6f75 742c 2022 5c6e 2229 3b0a 2020  (fout, "\n");.  
+00081ce0: 2020 2020 2020 6670 7269 6e74 6628 666f        fprintf(fo
+00081cf0: 7574 2c20 2225 2d31 3673 2025 3878 5c6e  ut, "%-16s %8x\n
+00081d00: 222c 2022 6d61 6769 6322 2c20 2020 2020  ", "magic",     
+00081d10: 2020 2047 474d 4c5f 4649 4c45 5f4d 4147     GGML_FILE_MAG
+00081d20: 4943 293b 0a20 2020 2020 2020 2066 7072  IC);.        fpr
+00081d30: 696e 7466 2866 6f75 742c 2022 252d 3136  intf(fout, "%-16
+00081d40: 7320 2538 645c 6e22 2c20 2276 6572 7369  s %8d\n", "versi
+00081d50: 6f6e 222c 2020 2020 2020 4747 4d4c 5f46  on",      GGML_F
+00081d60: 494c 455f 5645 5253 494f 4e29 3b0a 2020  ILE_VERSION);.  
+00081d70: 2020 2020 2020 6670 7269 6e74 6628 666f        fprintf(fo
+00081d80: 7574 2c20 2225 2d31 3673 2025 3864 5c6e  ut, "%-16s %8d\n
+00081d90: 222c 2022 6c65 6166 7322 2c20 2020 2020  ", "leafs",     
+00081da0: 2020 2063 6772 6170 682d 3e6e 5f6c 6561     cgraph->n_lea
+00081db0: 6673 293b 0a20 2020 2020 2020 2066 7072  fs);.        fpr
+00081dc0: 696e 7466 2866 6f75 742c 2022 252d 3136  intf(fout, "%-16
+00081dd0: 7320 2538 645c 6e22 2c20 226e 6f64 6573  s %8d\n", "nodes
+00081de0: 222c 2020 2020 2020 2020 6367 7261 7068  ",        cgraph
+00081df0: 2d3e 6e5f 6e6f 6465 7329 3b0a 2020 2020  ->n_nodes);.    
+00081e00: 2020 2020 6670 7269 6e74 6628 666f 7574      fprintf(fout
+00081e10: 2c20 2225 2d31 3673 2025 2220 5052 4975  , "%-16s %" PRIu
+00081e20: 3634 2022 5c6e 222c 2022 6576 616c 222c  64 "\n", "eval",
+00081e30: 2073 697a 655f 6576 616c 293b 0a0a 2020   size_eval);..  
+00081e40: 2020 2020 2020 2f2f 2068 6561 6465 720a        // header.
+00081e50: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
+00081e60: 666f 7574 2c20 225c 6e22 293b 0a20 2020  fout, "\n");.   
+00081e70: 2020 2020 2066 7072 696e 7466 2866 6f75       fprintf(fou
+00081e80: 742c 2022 252d 3673 2025 2d31 3273 2025  t, "%-6s %-12s %
+00081e90: 3873 2025 3873 2025 3873 2025 3873 2025  8s %8s %8s %8s %
+00081ea0: 3873 2025 3136 7320 2531 3673 2025 3136  8s %16s %16s %16
+00081eb0: 7320 2531 3673 2025 3136 7320 2531 3673  s %16s %16s %16s
+00081ec0: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
+00081ed0: 2020 2020 2022 5459 5045 222c 2022 4f50       "TYPE", "OP
+00081ee0: 222c 2022 4e44 494d 5322 2c20 224e 4530  ", "NDIMS", "NE0
+00081ef0: 222c 2022 4e45 3122 2c20 224e 4532 222c  ", "NE1", "NE2",
+00081f00: 2022 4e45 3322 2c20 224e 4230 222c 2022   "NE3", "NB0", "
+00081f10: 4e42 3122 2c20 224e 4232 222c 2022 4e42  NB1", "NB2", "NB
+00081f20: 3322 2c20 2244 4154 4122 2c20 224e 414d  3", "DATA", "NAM
+00081f30: 4522 293b 0a0a 2020 2020 2020 2020 666f  E");..        fo
+00081f40: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00081f50: 3c20 6367 7261 7068 2d3e 6e5f 6c65 6166  < cgraph->n_leaf
+00081f60: 733b 202b 2b69 2920 7b0a 2020 2020 2020  s; ++i) {.      
+00081f70: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
+00081f80: 5f65 7870 6f72 745f 6c65 6166 2863 6772  _export_leaf(cgr
+00081f90: 6170 682d 3e6c 6561 6673 5b69 5d2c 2066  aph->leafs[i], f
+00081fa0: 6f75 7429 3b0a 0a20 2020 2020 2020 2020  out);..         
+00081fb0: 2020 2047 474d 4c5f 4153 5345 5254 2863     GGML_ASSERT(c
+00081fc0: 6772 6170 682d 3e6c 6561 6673 5b69 5d2d  graph->leafs[i]-
+00081fd0: 3e6f 7020 2020 3d3d 2047 474d 4c5f 4f50  >op   == GGML_OP
+00081fe0: 5f4e 4f4e 4529 3b0a 2020 2020 2020 2020  _NONE);.        
+00081ff0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00082000: 6367 7261 7068 2d3e 6c65 6166 735b 695d  cgraph->leafs[i]
+00082010: 2d3e 7372 6330 203d 3d20 4e55 4c4c 293b  ->src0 == NULL);
+00082020: 0a20 2020 2020 2020 2020 2020 2047 474d  .            GGM
+00082030: 4c5f 4153 5345 5254 2863 6772 6170 682d  L_ASSERT(cgraph-
+00082040: 3e6c 6561 6673 5b69 5d2d 3e73 7263 3120  >leafs[i]->src1 
+00082050: 3d3d 204e 554c 4c29 3b0a 2020 2020 2020  == NULL);.      
+00082060: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+00082070: 6865 6164 6572 0a20 2020 2020 2020 2066  header.        f
+00082080: 7072 696e 7466 2866 6f75 742c 2022 5c6e  printf(fout, "\n
+00082090: 2229 3b0a 2020 2020 2020 2020 6670 7269  ");.        fpri
+000820a0: 6e74 6628 666f 7574 2c20 2225 2d36 7320  ntf(fout, "%-6s 
+000820b0: 252d 3673 2025 2d31 3273 2025 3873 2025  %-6s %-12s %8s %
+000820c0: 3873 2025 3873 2025 3873 2025 3873 2025  8s %8s %8s %8s %
+000820d0: 3136 7320 2531 3673 2025 3136 7320 2531  16s %16s %16s %1
+000820e0: 3673 2025 3873 2025 3136 7320 2531 3673  6s %8s %16s %16s
+000820f0: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
+00082100: 2020 2020 2022 4152 4722 2c20 2254 5950       "ARG", "TYP
+00082110: 4522 2c20 224f 5022 2c20 224e 4449 4d53  E", "OP", "NDIMS
+00082120: 222c 2022 4e45 3022 2c20 224e 4531 222c  ", "NE0", "NE1",
+00082130: 2022 4e45 3222 2c20 224e 4533 222c 2022   "NE2", "NE3", "
+00082140: 4e42 3022 2c20 224e 4231 222c 2022 4e42  NB0", "NB1", "NB
+00082150: 3222 2c20 224e 4233 222c 2022 4e54 4153  2", "NB3", "NTAS
+00082160: 4b53 222c 2022 4441 5441 222c 2022 4e41  KS", "DATA", "NA
+00082170: 4d45 2229 3b0a 0a20 2020 2020 2020 2066  ME");..        f
+00082180: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00082190: 203c 2063 6772 6170 682d 3e6e 5f6e 6f64   < cgraph->n_nod
+000821a0: 6573 3b20 2b2b 6929 207b 0a20 2020 2020  es; ++i) {.     
+000821b0: 2020 2020 2020 2067 676d 6c5f 6772 6170         ggml_grap
+000821c0: 685f 6578 706f 7274 5f6e 6f64 6528 6367  h_export_node(cg
+000821d0: 7261 7068 2d3e 6e6f 6465 735b 695d 2c20  raph->nodes[i], 
+000821e0: 2244 5354 222c 2066 6f75 7429 3b0a 0a20  "DST", fout);.. 
+000821f0: 2020 2020 2020 2020 2020 2069 6620 2863             if (c
+00082200: 6772 6170 682d 3e6e 6f64 6573 5b69 5d2d  graph->nodes[i]-
+00082210: 3e73 7263 3029 207b 0a20 2020 2020 2020  >src0) {.       
+00082220: 2020 2020 2020 2020 2067 676d 6c5f 6772           ggml_gr
+00082230: 6170 685f 6578 706f 7274 5f6e 6f64 6528  aph_export_node(
+00082240: 6367 7261 7068 2d3e 6e6f 6465 735b 695d  cgraph->nodes[i]
+00082250: 2d3e 7372 6330 2c20 2253 5243 3022 2c20  ->src0, "SRC0", 
+00082260: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
+00082270: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+00082280: 2020 6966 2028 6367 7261 7068 2d3e 6e6f    if (cgraph->no
+00082290: 6465 735b 695d 2d3e 7372 6331 2920 7b0a  des[i]->src1) {.
+000822a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000822b0: 6767 6d6c 5f67 7261 7068 5f65 7870 6f72  ggml_graph_expor
+000822c0: 745f 6e6f 6465 2863 6772 6170 682d 3e6e  t_node(cgraph->n
+000822d0: 6f64 6573 5b69 5d2d 3e73 7263 312c 2022  odes[i]->src1, "
+000822e0: 5352 4331 222c 2066 6f75 7429 3b0a 2020  SRC1", fout);.  
+000822f0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00082300: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00082310: 7420 6a20 3d20 303b 206a 203c 2047 474d  t j = 0; j < GGM
+00082320: 4c5f 4d41 585f 4f50 543b 202b 2b6a 2920  L_MAX_OPT; ++j) 
+00082330: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00082340: 2020 6966 2028 6367 7261 7068 2d3e 6e6f    if (cgraph->no
+00082350: 6465 735b 695d 2d3e 6f70 745b 6a5d 2920  des[i]->opt[j]) 
+00082360: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00082370: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
+00082380: 5f65 7870 6f72 745f 6e6f 6465 2863 6772  _export_node(cgr
+00082390: 6170 682d 3e6e 6f64 6573 5b69 5d2d 3e6f  aph->nodes[i]->o
+000823a0: 7074 5b6a 5d2c 2022 4f50 5422 2c20 666f  pt[j], "OPT", fo
+000823b0: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
+000823c0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000823d0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+000823e0: 2020 6670 7269 6e74 6628 666f 7574 2c20    fprintf(fout, 
+000823f0: 225c 6e22 293b 0a20 2020 2020 2020 207d  "\n");.        }
+00082400: 0a0a 2020 2020 2020 2020 6670 7269 6e74  ..        fprint
+00082410: 6628 666f 7574 2c20 225c 6e22 293b 0a20  f(fout, "\n");. 
+00082420: 2020 207d 0a0a 2020 2020 2f2f 2077 7269     }..    // wri
+00082430: 7465 2062 696e 6172 7920 6461 7461 0a20  te binary data. 
+00082440: 2020 207b 0a20 2020 2020 2020 2046 494c     {.        FIL
+00082450: 4520 2a20 666f 7574 203d 2066 6f70 656e  E * fout = fopen
+00082460: 2866 6e61 6d65 2c20 2277 6222 293b 0a0a  (fname, "wb");..
+00082470: 2020 2020 2020 2020 6966 2028 2166 6f75          if (!fou
+00082480: 7429 207b 0a20 2020 2020 2020 2020 2020  t) {.           
+00082490: 2066 7072 696e 7466 2873 7464 6572 722c   fprintf(stderr,
+000824a0: 2022 2573 3a20 6661 696c 6564 2074 6f20   "%s: failed to 
+000824b0: 6f70 656e 2025 735c 6e22 2c20 5f5f 6675  open %s\n", __fu
+000824c0: 6e63 5f5f 2c20 666e 616d 6529 3b0a 2020  nc__, fname);.  
+000824d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000824e0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
+000824f0: 2020 2020 202f 2f20 6865 6164 6572 0a20       // header. 
+00082500: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00082510: 2020 2020 2063 6f6e 7374 2075 696e 7433       const uint3
+00082520: 325f 7420 6d61 6769 6320 2020 3d20 4747  2_t magic   = GG
+00082530: 4d4c 5f46 494c 455f 4d41 4749 433b 0a20  ML_FILE_MAGIC;. 
+00082540: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00082550: 2075 696e 7433 325f 7420 7665 7273 696f   uint32_t versio
+00082560: 6e20 3d20 4747 4d4c 5f46 494c 455f 5645  n = GGML_FILE_VE
+00082570: 5253 494f 4e3b 0a20 2020 2020 2020 2020  RSION;.         
+00082580: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
+00082590: 7420 6e5f 6c65 6166 7320 3d20 6367 7261  t n_leafs = cgra
+000825a0: 7068 2d3e 6e5f 6c65 6166 733b 0a20 2020  ph->n_leafs;.   
+000825b0: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+000825c0: 696e 7433 325f 7420 6e6f 6465 7320 2020  int32_t nodes   
+000825d0: 3d20 6367 7261 7068 2d3e 6e5f 6e6f 6465  = cgraph->n_node
+000825e0: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
+000825f0: 6677 7269 7465 2826 6d61 6769 632c 2020  fwrite(&magic,  
+00082600: 2020 2073 697a 656f 6628 7569 6e74 3332     sizeof(uint32
+00082610: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
+00082620: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
+00082630: 6528 2676 6572 7369 6f6e 2c20 2020 7369  e(&version,   si
+00082640: 7a65 6f66 2875 696e 7433 325f 7429 2c20  zeof(uint32_t), 
+00082650: 312c 2066 6f75 7429 3b0a 2020 2020 2020  1, fout);.      
+00082660: 2020 2020 2020 6677 7269 7465 2826 6e5f        fwrite(&n_
+00082670: 6c65 6166 732c 2020 2073 697a 656f 6628  leafs,   sizeof(
+00082680: 7569 6e74 3332 5f74 292c 2031 2c20 666f  uint32_t), 1, fo
+00082690: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
+000826a0: 2066 7772 6974 6528 266e 6f64 6573 2c20   fwrite(&nodes, 
+000826b0: 2020 2020 7369 7a65 6f66 2875 696e 7433      sizeof(uint3
+000826c0: 325f 7429 2c20 312c 2066 6f75 7429 3b0a  2_t), 1, fout);.
+000826d0: 2020 2020 2020 2020 2020 2020 6677 7269              fwri
+000826e0: 7465 2826 7369 7a65 5f65 7661 6c2c 2073  te(&size_eval, s
+000826f0: 697a 656f 6628 7569 6e74 3634 5f74 292c  izeof(uint64_t),
+00082700: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
+00082710: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
+00082720: 206c 6561 6673 0a20 2020 2020 2020 207b   leafs.        {
+00082730: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00082740: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00082750: 2063 6772 6170 682d 3e6e 5f6c 6561 6673   cgraph->n_leafs
+00082760: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
+00082770: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
+00082780: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00082790: 7220 2a20 7465 6e73 6f72 203d 2063 6772  r * tensor = cgr
+000827a0: 6170 682d 3e6c 6561 6673 5b69 5d3b 0a0a  aph->leafs[i];..
+000827b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000827c0: 636f 6e73 7420 7569 6e74 3332 5f74 2074  const uint32_t t
+000827d0: 7970 6520 2020 3d20 7465 6e73 6f72 2d3e  ype   = tensor->
+000827e0: 7479 7065 3b0a 2020 2020 2020 2020 2020  type;.          
+000827f0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
+00082800: 3332 5f74 206f 7020 2020 2020 3d20 7465  32_t op     = te
+00082810: 6e73 6f72 2d3e 6f70 3b0a 2020 2020 2020  nsor->op;.      
+00082820: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00082830: 7569 6e74 3332 5f74 206e 5f64 696d 7320  uint32_t n_dims 
+00082840: 3d20 7465 6e73 6f72 2d3e 6e5f 6469 6d73  = tensor->n_dims
+00082850: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00082860: 2020 2066 7772 6974 6528 2674 7970 652c     fwrite(&type,
+00082870: 2020 2073 697a 656f 6628 7569 6e74 3332     sizeof(uint32
+00082880: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
+00082890: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000828a0: 7772 6974 6528 266f 702c 2020 2020 2073  write(&op,     s
+000828b0: 697a 656f 6628 7569 6e74 3332 5f74 292c  izeof(uint32_t),
+000828c0: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
+000828d0: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
+000828e0: 6528 266e 5f64 696d 732c 2073 697a 656f  e(&n_dims, sizeo
+000828f0: 6628 7569 6e74 3332 5f74 292c 2031 2c20  f(uint32_t), 1, 
+00082900: 666f 7574 293b 0a0a 2020 2020 2020 2020  fout);..        
+00082910: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00082920: 206a 203d 2030 3b20 6a20 3c20 4747 4d4c   j = 0; j < GGML
+00082930: 5f4d 4158 5f44 494d 533b 202b 2b6a 2920  _MAX_DIMS; ++j) 
+00082940: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00082950: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
+00082960: 3634 5f74 206e 6520 3d20 7465 6e73 6f72  64_t ne = tensor
+00082970: 2d3e 6e65 5b6a 5d3b 0a20 2020 2020 2020  ->ne[j];.       
+00082980: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00082990: 7374 2075 696e 7436 345f 7420 6e62 203d  st uint64_t nb =
+000829a0: 2074 656e 736f 722d 3e6e 625b 6a5d 3b0a   tensor->nb[j];.
+000829b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000829c0: 2020 2020 2066 7772 6974 6528 266e 652c       fwrite(&ne,
+000829d0: 2073 697a 656f 6628 7569 6e74 3634 5f74   sizeof(uint64_t
+000829e0: 292c 2031 2c20 666f 7574 293b 0a20 2020  ), 1, fout);.   
+000829f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082a00: 2066 7772 6974 6528 266e 622c 2073 697a   fwrite(&nb, siz
+00082a10: 656f 6628 7569 6e74 3634 5f74 292c 2031  eof(uint64_t), 1
+00082a20: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
+00082a30: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+00082a40: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
+00082a50: 746f 7265 2074 6865 2070 6f69 6e74 6572  tore the pointer
+00082a60: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
+00082a70: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00082a80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00082a90: 6f6e 7374 2075 696e 7436 345f 7420 7074  onst uint64_t pt
+00082aa0: 7220 3d20 2875 696e 7436 345f 7429 2074  r = (uint64_t) t
+00082ab0: 656e 736f 722d 3e64 6174 613b 0a0a 2020  ensor->data;..  
+00082ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082ad0: 2020 6677 7269 7465 2826 7074 722c 2073    fwrite(&ptr, s
+00082ae0: 697a 656f 6628 7569 6e74 3634 5f74 292c  izeof(uint64_t),
+00082af0: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
+00082b00: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+00082b10: 2020 2020 2020 2020 2020 2020 2020 6677                fw
+00082b20: 7269 7465 2874 656e 736f 722d 3e6e 616d  rite(tensor->nam
+00082b30: 652c 2073 697a 656f 6628 6368 6172 292c  e, sizeof(char),
+00082b40: 2047 474d 4c5f 4d41 585f 4e41 4d45 2c20   GGML_MAX_NAME, 
+00082b50: 666f 7574 293b 0a0a 2020 2020 2020 2020  fout);..        
+00082b60: 2020 2020 2020 2020 2f2f 2064 756d 7020          // dump 
+00082b70: 7468 6520 6461 7461 0a20 2020 2020 2020  the data.       
+00082b80: 2020 2020 2020 2020 202f 2f20 544f 444f           // TODO
+00082b90: 3a20 7061 6420 7468 6973 2074 6f20 3332  : pad this to 32
+00082ba0: 2062 7974 6520 626f 756e 6461 7279 0a20   byte boundary. 
+00082bb0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00082bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082bd0: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+00082be0: 7420 7369 7a65 203d 2067 676d 6c5f 6e62  t size = ggml_nb
+00082bf0: 7974 6573 2874 656e 736f 7229 3b0a 0a20  ytes(tensor);.. 
+00082c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082c10: 2020 2066 7772 6974 6528 7465 6e73 6f72     fwrite(tensor
+00082c20: 2d3e 6461 7461 2c20 7369 7a65 6f66 2863  ->data, sizeof(c
+00082c30: 6861 7229 2c20 7369 7a65 2c20 666f 7574  har), size, fout
+00082c40: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00082c50: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00082c60: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
+00082c70: 2020 2020 2020 2f2f 206e 6f64 6573 0a20        // nodes. 
+00082c80: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00082c90: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00082ca0: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
+00082cb0: 3e6e 5f6e 6f64 6573 3b20 2b2b 6929 207b  >n_nodes; ++i) {
+00082cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082cd0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00082ce0: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+00082cf0: 6f72 203d 2063 6772 6170 682d 3e6e 6f64  or = cgraph->nod
+00082d00: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
+00082d10: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+00082d20: 6e74 3332 5f74 2074 7970 6520 2020 3d20  nt32_t type   = 
+00082d30: 7465 6e73 6f72 2d3e 7479 7065 3b0a 2020  tensor->type;.  
+00082d40: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00082d50: 6e73 7420 7569 6e74 3332 5f74 206f 7020  nst uint32_t op 
+00082d60: 2020 2020 3d20 7465 6e73 6f72 2d3e 6f70      = tensor->op
+00082d70: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00082d80: 2020 636f 6e73 7420 7569 6e74 3332 5f74    const uint32_t
+00082d90: 206e 5f64 696d 7320 3d20 7465 6e73 6f72   n_dims = tensor
+00082da0: 2d3e 6e5f 6469 6d73 3b0a 0a20 2020 2020  ->n_dims;..     
+00082db0: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
+00082dc0: 6528 2674 7970 652c 2020 2073 697a 656f  e(&type,   sizeo
+00082dd0: 6628 7569 6e74 3332 5f74 292c 2031 2c20  f(uint32_t), 1, 
+00082de0: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
+00082df0: 2020 2020 2020 2066 7772 6974 6528 266f         fwrite(&o
+00082e00: 702c 2020 2020 2073 697a 656f 6628 7569  p,     sizeof(ui
+00082e10: 6e74 3332 5f74 292c 2031 2c20 666f 7574  nt32_t), 1, fout
+00082e20: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00082e30: 2020 2066 7772 6974 6528 266e 5f64 696d     fwrite(&n_dim
+00082e40: 732c 2073 697a 656f 6628 7569 6e74 3332  s, sizeof(uint32
+00082e50: 5f74 292c 2031 2c20 666f 7574 293b 0a0a  _t), 1, fout);..
+00082e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082e70: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
+00082e80: 6a20 3c20 4747 4d4c 5f4d 4158 5f44 494d  j < GGML_MAX_DIM
+00082e90: 533b 202b 2b6a 2920 7b0a 2020 2020 2020  S; ++j) {.      
+00082ea0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00082eb0: 6e73 7420 7569 6e74 3634 5f74 206e 6520  nst uint64_t ne 
+00082ec0: 3d20 7465 6e73 6f72 2d3e 6e65 5b6a 5d3b  = tensor->ne[j];
+00082ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082ee0: 2020 2020 2063 6f6e 7374 2075 696e 7436       const uint6
+00082ef0: 345f 7420 6e62 203d 2074 656e 736f 722d  4_t nb = tensor-
+00082f00: 3e6e 625b 6a5d 3b0a 0a20 2020 2020 2020  >nb[j];..       
+00082f10: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
+00082f20: 6974 6528 266e 652c 2073 697a 656f 6628  ite(&ne, sizeof(
+00082f30: 7569 6e74 3634 5f74 292c 2031 2c20 666f  uint64_t), 1, fo
+00082f40: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
+00082f50: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
+00082f60: 266e 622c 2073 697a 656f 6628 7569 6e74  &nb, sizeof(uint
+00082f70: 3634 5f74 292c 2031 2c20 666f 7574 293b  64_t), 1, fout);
+00082f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082f90: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+00082fa0: 2020 2020 2f2f 2073 746f 7265 2074 6865      // store the
+00082fb0: 2070 6f69 6e74 6572 2061 6464 7265 7373   pointer address
+00082fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082fd0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00082fe0: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+00082ff0: 7436 345f 7420 7074 7220 3d20 2875 696e  t64_t ptr = (uin
+00083000: 7436 345f 7429 2074 656e 736f 722d 3e64  t64_t) tensor->d
+00083010: 6174 613b 0a0a 2020 2020 2020 2020 2020  ata;..          
+00083020: 2020 2020 2020 2020 2020 6677 7269 7465            fwrite
+00083030: 2826 7074 722c 2073 697a 656f 6628 7569  (&ptr, sizeof(ui
+00083040: 6e74 3634 5f74 292c 2031 2c20 666f 7574  nt64_t), 1, fout
+00083050: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00083060: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+00083070: 2020 2020 2020 6677 7269 7465 2874 656e        fwrite(ten
+00083080: 736f 722d 3e6e 616d 652c 2073 697a 656f  sor->name, sizeo
+00083090: 6628 6368 6172 292c 2047 474d 4c5f 4d41  f(char), GGML_MA
+000830a0: 585f 4e41 4d45 2c20 666f 7574 293b 0a0a  X_NAME, fout);..
+000830b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000830c0: 2f2f 206f 7574 7075 7420 7468 6520 6f70  // output the op
+000830d0: 2061 7267 756d 656e 7473 0a20 2020 2020   arguments.     
+000830e0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000830f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083100: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00083110: 736f 7220 2a20 6172 6773 5b32 202b 2047  sor * args[2 + G
+00083120: 474d 4c5f 4d41 585f 4f50 545d 203d 207b  GML_MAX_OPT] = {
+00083130: 204e 554c 4c20 7d3b 0a0a 2020 2020 2020   NULL };..      
+00083140: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+00083150: 6773 5b30 5d20 3d20 7465 6e73 6f72 2d3e  gs[0] = tensor->
+00083160: 7372 6330 3b0a 2020 2020 2020 2020 2020  src0;.          
+00083170: 2020 2020 2020 2020 2020 6172 6773 5b31            args[1
+00083180: 5d20 3d20 7465 6e73 6f72 2d3e 7372 6331  ] = tensor->src1
+00083190: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+000831a0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+000831b0: 6a20 3d20 303b 206a 203c 2047 474d 4c5f  j = 0; j < GGML_
+000831c0: 4d41 585f 4f50 543b 202b 2b6a 2920 7b0a  MAX_OPT; ++j) {.
+000831d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000831e0: 2020 2020 2020 2020 6172 6773 5b32 202b          args[2 +
+000831f0: 206a 5d20 3d20 7465 6e73 6f72 2d3e 6f70   j] = tensor->op
+00083200: 745b 6a5d 3b0a 2020 2020 2020 2020 2020  t[j];.          
+00083210: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
 00083220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083230: 2f2f 206f 7574 7075 7420 7468 6520 6f70  // output the op
-00083240: 2061 7267 756d 656e 7473 0a20 2020 2020   arguments.     
-00083250: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00083230: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+00083240: 206a 203c 2032 202b 2047 474d 4c5f 4d41   j < 2 + GGML_MA
+00083250: 585f 4f50 543b 202b 2b6a 2920 7b0a 2020  X_OPT; ++j) {.  
 00083260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083270: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00083280: 736f 7220 2a20 6172 6773 5b32 202b 2047  sor * args[2 + G
-00083290: 474d 4c5f 4d41 585f 4f50 545d 203d 207b  GML_MAX_OPT] = {
-000832a0: 204e 554c 4c20 7d3b 0a0a 2020 2020 2020   NULL };..      
-000832b0: 2020 2020 2020 2020 2020 2020 2020 6172                ar
-000832c0: 6773 5b30 5d20 3d20 7465 6e73 6f72 2d3e  gs[0] = tensor->
-000832d0: 7372 6330 3b0a 2020 2020 2020 2020 2020  src0;.          
-000832e0: 2020 2020 2020 2020 2020 6172 6773 5b31            args[1
-000832f0: 5d20 3d20 7465 6e73 6f72 2d3e 7372 6331  ] = tensor->src1
-00083300: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00083310: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00083320: 6a20 3d20 303b 206a 203c 2047 474d 4c5f  j = 0; j < GGML_
-00083330: 4d41 585f 4f50 543b 202b 2b6a 2920 7b0a  MAX_OPT; ++j) {.
-00083340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083350: 2020 2020 2020 2020 6172 6773 5b32 202b          args[2 +
-00083360: 206a 5d20 3d20 7465 6e73 6f72 2d3e 6f70   j] = tensor->op
-00083370: 745b 6a5d 3b0a 2020 2020 2020 2020 2020  t[j];.          
-00083380: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00083390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000833a0: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-000833b0: 206a 203c 2032 202b 2047 474d 4c5f 4d41   j < 2 + GGML_MA
-000833c0: 585f 4f50 543b 202b 2b6a 2920 7b0a 2020  X_OPT; ++j) {.  
+00083270: 2020 2020 2020 6966 2028 6172 6773 5b6a        if (args[j
+00083280: 5d29 207b 0a20 2020 2020 2020 2020 2020  ]) {.           
+00083290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000832a0: 2069 6e74 3332 5f74 2069 6478 203d 202d   int32_t idx = -
+000832b0: 313b 0a0a 2020 2020 2020 2020 2020 2020  1;..            
+000832c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000832d0: 2f2f 2063 6865 636b 2069 6620 6c65 6166  // check if leaf
+000832e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000832f0: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00083300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083310: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00083320: 6f72 2028 696e 7420 6b20 3d20 303b 206b  or (int k = 0; k
+00083330: 203c 2063 6772 6170 682d 3e6e 5f6c 6561   < cgraph->n_lea
+00083340: 6673 3b20 2b2b 6b29 207b 0a20 2020 2020  fs; ++k) {.     
+00083350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083360: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00083370: 6620 2861 7267 735b 6a5d 203d 3d20 6367  f (args[j] == cg
+00083380: 7261 7068 2d3e 6c65 6166 735b 6b5d 2920  raph->leafs[k]) 
+00083390: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000833a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000833b0: 2020 2020 2020 2020 2020 6964 7820 3d20            idx = 
+000833c0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
 000833d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000833e0: 2020 2020 2020 6966 2028 6172 6773 5b6a        if (args[j
-000833f0: 5d29 207b 0a20 2020 2020 2020 2020 2020  ]) {.           
+000833e0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+000833f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
 00083400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083410: 2069 6e74 3332 5f74 2069 6478 203d 202d   int32_t idx = -
-00083420: 313b 0a0a 2020 2020 2020 2020 2020 2020  1;..            
-00083430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083440: 2f2f 2063 6865 636b 2069 6620 6c65 6166  // check if leaf
-00083450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00083460: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00083470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083480: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00083490: 6f72 2028 696e 7420 6b20 3d20 303b 206b  or (int k = 0; k
-000834a0: 203c 2063 6772 6170 682d 3e6e 5f6c 6561   < cgraph->n_lea
-000834b0: 6673 3b20 2b2b 6b29 207b 0a20 2020 2020  fs; ++k) {.     
+00083410: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00083420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083430: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00083440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083450: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00083460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083470: 2020 2020 202f 2f20 6368 6563 6b20 6966       // check if
+00083480: 206e 6f64 650a 2020 2020 2020 2020 2020   node.          
+00083490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000834a0: 2020 6966 2028 6964 7820 3d3d 202d 3129    if (idx == -1)
+000834b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
 000834c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000834d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000834e0: 6620 2861 7267 735b 6a5d 203d 3d20 6367  f (args[j] == cg
-000834f0: 7261 7068 2d3e 6c65 6166 735b 6b5d 2920  raph->leafs[k]) 
-00083500: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000834d0: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
+000834e0: 303b 206b 203c 2063 6772 6170 682d 3e6e  0; k < cgraph->n
+000834f0: 5f6e 6f64 6573 3b20 2b2b 6b29 207b 0a20  _nodes; ++k) {. 
+00083500: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00083510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083520: 2020 2020 2020 2020 2020 6964 7820 3d20            idx = 
-00083530: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-00083540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083550: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00083560: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00083570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083580: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00083520: 2020 2069 6620 2861 7267 735b 6a5d 203d     if (args[j] =
+00083530: 3d20 6367 7261 7068 2d3e 6e6f 6465 735b  = cgraph->nodes[
+00083540: 6b5d 2920 7b0a 2020 2020 2020 2020 2020  k]) {.          
+00083550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083560: 2020 2020 2020 2020 2020 2020 2020 6964                id
+00083570: 7820 3d20 4747 4d4c 5f4d 4158 5f4e 4f44  x = GGML_MAX_NOD
+00083580: 4553 202b 206b 3b0a 2020 2020 2020 2020  ES + k;.        
 00083590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000835a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000835b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000835c0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000835d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000835e0: 2020 2020 202f 2f20 6368 6563 6b20 6966       // check if
-000835f0: 206e 6f64 650a 2020 2020 2020 2020 2020   node.          
+000835a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000835b0: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+000835c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000835d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000835e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000835f0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
 00083600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083610: 2020 6966 2028 6964 7820 3d3d 202d 3129    if (idx == -1)
-00083620: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00083630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083640: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
-00083650: 303b 206b 203c 2063 6772 6170 682d 3e6e  0; k < cgraph->n
-00083660: 5f6e 6f64 6573 3b20 2b2b 6b29 207b 0a20  _nodes; ++k) {. 
-00083670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083690: 2020 2069 6620 2861 7267 735b 6a5d 203d     if (args[j] =
-000836a0: 3d20 6367 7261 7068 2d3e 6e6f 6465 735b  = cgraph->nodes[
-000836b0: 6b5d 2920 7b0a 2020 2020 2020 2020 2020  k]) {.          
+00083610: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+00083620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083630: 2020 2020 2020 2020 2020 6966 2028 6964            if (id
+00083640: 7820 3d3d 202d 3129 207b 0a20 2020 2020  x == -1) {.     
+00083650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083660: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+00083670: 7466 2873 7464 6572 722c 2022 2573 3a20  tf(stderr, "%s: 
+00083680: 6661 696c 6564 2074 6f20 6669 6e64 2074  failed to find t
+00083690: 656e 736f 722c 2061 7267 203d 2025 642c  ensor, arg = %d,
+000836a0: 206e 6f64 6520 3d20 2564 5c6e 222c 205f   node = %d\n", _
+000836b0: 5f66 756e 635f 5f2c 206a 2c20 6929 3b0a  _func__, j, i);.
 000836c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000836d0: 2020 2020 2020 2020 2020 2020 2020 6964                id
-000836e0: 7820 3d20 4747 4d4c 5f4d 4158 5f4e 4f44  x = GGML_MAX_NOD
-000836f0: 4553 202b 206b 3b0a 2020 2020 2020 2020  ES + k;.        
-00083700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000836d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000836e0: 7265 7475 726e 3b0a 2020 2020 2020 2020  return;.        
+000836f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083700: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
 00083710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083720: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-00083730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083740: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00083720: 2020 2066 7772 6974 6528 2669 6478 2c20     fwrite(&idx, 
+00083730: 7369 7a65 6f66 2869 6e74 3332 5f74 292c  sizeof(int32_t),
+00083740: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
 00083750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083760: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00083760: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
 00083770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083780: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00083790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000837a0: 2020 2020 2020 2020 2020 6966 2028 6964            if (id
-000837b0: 7820 3d3d 202d 3129 207b 0a20 2020 2020  x == -1) {.     
-000837c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000837d0: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-000837e0: 7466 2873 7464 6572 722c 2022 2573 3a20  tf(stderr, "%s: 
-000837f0: 6661 696c 6564 2074 6f20 6669 6e64 2074  failed to find t
-00083800: 656e 736f 722c 2061 7267 203d 2025 642c  ensor, arg = %d,
-00083810: 206e 6f64 6520 3d20 2564 5c6e 222c 205f   node = %d\n", _
-00083820: 5f66 756e 635f 5f2c 206a 2c20 6929 3b0a  _func__, j, i);.
-00083830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083850: 7265 7475 726e 3b0a 2020 2020 2020 2020  return;.        
-00083860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083870: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-00083880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083890: 2020 2066 7772 6974 6528 2669 6478 2c20     fwrite(&idx, 
-000838a0: 7369 7a65 6f66 2869 6e74 3332 5f74 292c  sizeof(int32_t),
-000838b0: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
-000838c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000838d0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-000838e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000838f0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-00083900: 7433 325f 7420 6e75 6c20 3d20 2d31 3b0a  t32_t nul = -1;.
-00083910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00083920: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
-00083930: 6974 6528 266e 756c 2c20 7369 7a65 6f66  ite(&nul, sizeof
-00083940: 2869 6e74 3332 5f74 292c 2031 2c20 666f  (int32_t), 1, fo
-00083950: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-00083960: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00083970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083980: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00083990: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000839a0: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
-000839b0: 2020 2020 2020 2020 6663 6c6f 7365 2866          fclose(f
-000839c0: 6f75 7429 3b0a 2020 2020 7d0a 7d0a 0a73  out);.    }.}..s
-000839d0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-000839e0: 6820 6767 6d6c 5f67 7261 7068 5f69 6d70  h ggml_graph_imp
-000839f0: 6f72 7428 636f 6e73 7420 6368 6172 202a  ort(const char *
-00083a00: 2066 6e61 6d65 2c20 7374 7275 6374 2067   fname, struct g
-00083a10: 676d 6c5f 636f 6e74 6578 7420 2a2a 2063  gml_context ** c
-00083a20: 7478 5f64 6174 612c 2073 7472 7563 7420  tx_data, struct 
-00083a30: 6767 6d6c 5f63 6f6e 7465 7874 202a 2a20  ggml_context ** 
-00083a40: 6374 785f 6576 616c 2920 7b0a 2020 2020  ctx_eval) {.    
-00083a50: 6173 7365 7274 282a 6374 785f 6461 7461  assert(*ctx_data
-00083a60: 203d 3d20 4e55 4c4c 293b 0a20 2020 2061   == NULL);.    a
-00083a70: 7373 6572 7428 2a63 7478 5f65 7661 6c20  ssert(*ctx_eval 
-00083a80: 3d3d 204e 554c 4c29 3b0a 0a20 2020 2073  == NULL);..    s
-00083a90: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-00083aa0: 6820 7265 7375 6c74 203d 207b 2030 207d  h result = { 0 }
-00083ab0: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
-00083ac0: 6d6c 5f74 656e 736f 7220 2a20 6461 7461  ml_tensor * data
-00083ad0: 203d 204e 554c 4c3b 0a0a 2020 2020 2f2f   = NULL;..    //
-00083ae0: 2072 6561 6420 6669 6c65 2069 6e74 6f20   read file into 
-00083af0: 6461 7461 0a20 2020 207b 0a20 2020 2020  data.    {.     
-00083b00: 2020 2046 494c 4520 2a20 6669 6e20 3d20     FILE * fin = 
-00083b10: 666f 7065 6e28 666e 616d 652c 2022 7262  fopen(fname, "rb
-00083b20: 2229 3b0a 2020 2020 2020 2020 6966 2028  ");.        if (
-00083b30: 2166 696e 2920 7b0a 2020 2020 2020 2020  !fin) {.        
-00083b40: 2020 2020 6670 7269 6e74 6628 7374 6465      fprintf(stde
-00083b50: 7272 2c20 2225 733a 2066 6169 6c65 6420  rr, "%s: failed 
-00083b60: 746f 206f 7065 6e20 2573 5c6e 222c 205f  to open %s\n", _
-00083b70: 5f66 756e 635f 5f2c 2066 6e61 6d65 293b  _func__, fname);
-00083b80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00083b90: 7572 6e20 7265 7375 6c74 3b0a 2020 2020  urn result;.    
-00083ba0: 2020 2020 7d0a 0a20 2020 2020 2020 2073      }..        s
-00083bb0: 697a 655f 7420 6673 697a 6520 3d20 303b  ize_t fsize = 0;
-00083bc0: 0a0a 2020 2020 2020 2020 6673 6565 6b28  ..        fseek(
-00083bd0: 6669 6e2c 2030 2c20 5345 454b 5f45 4e44  fin, 0, SEEK_END
-00083be0: 293b 0a20 2020 2020 2020 2066 7369 7a65  );.        fsize
-00083bf0: 203d 2066 7465 6c6c 2866 696e 293b 0a20   = ftell(fin);. 
-00083c00: 2020 2020 2020 2066 7365 656b 2866 696e         fseek(fin
-00083c10: 2c20 302c 2053 4545 4b5f 5345 5429 3b0a  , 0, SEEK_SET);.
-00083c20: 0a20 2020 2020 2020 202f 2f20 6372 6561  .        // crea
-00083c30: 7465 2074 6865 2064 6174 6120 636f 6e74  te the data cont
-00083c40: 6578 740a 2020 2020 2020 2020 7b0a 2020  ext.        {.  
-00083c50: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00083c60: 7369 7a65 5f74 206f 7665 7268 6561 6420  size_t overhead 
-00083c70: 3d20 312a 6767 6d6c 5f74 656e 736f 725f  = 1*ggml_tensor_
-00083c80: 6f76 6572 6865 6164 2829 3b0a 0a20 2020  overhead();..   
-00083c90: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
-00083ca0: 6767 6d6c 5f69 6e69 745f 7061 7261 6d73  ggml_init_params
-00083cb0: 2070 6172 616d 7320 3d20 7b0a 2020 2020   params = {.    
-00083cc0: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
-00083cd0: 5f73 697a 6520 2020 3d20 6673 697a 6520  _size   = fsize 
-00083ce0: 2b20 6f76 6572 6865 6164 2c0a 2020 2020  + overhead,.    
-00083cf0: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
-00083d00: 5f62 7566 6665 7220 3d20 4e55 4c4c 2c0a  _buffer = NULL,.
-00083d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083d20: 2e6e 6f5f 616c 6c6f 6320 2020 3d20 6661  .no_alloc   = fa
-00083d30: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00083d40: 207d 3b0a 0a20 2020 2020 2020 2020 2020   };..           
-00083d50: 202a 6374 785f 6461 7461 203d 2067 676d   *ctx_data = ggm
-00083d60: 6c5f 696e 6974 2870 6172 616d 7329 3b0a  l_init(params);.
-00083d70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00083d80: 2821 2a63 7478 5f64 6174 6129 207b 0a20  (!*ctx_data) {. 
-00083d90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00083da0: 7072 696e 7466 2873 7464 6572 722c 2022  printf(stderr, "
-00083db0: 2573 3a20 6661 696c 6564 2074 6f20 6372  %s: failed to cr
-00083dc0: 6561 7465 2067 676d 6c20 636f 6e74 6578  eate ggml contex
-00083dd0: 745c 6e22 2c20 5f5f 6675 6e63 5f5f 293b  t\n", __func__);
-00083de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00083df0: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-00083e00: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00083e10: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00083e20: 2064 6174 6120 3d20 6767 6d6c 5f6e 6577   data = ggml_new
-00083e30: 5f74 656e 736f 725f 3164 282a 6374 785f  _tensor_1d(*ctx_
-00083e40: 6461 7461 2c20 4747 4d4c 5f54 5950 455f  data, GGML_TYPE_
-00083e50: 4938 2c20 6673 697a 6529 3b0a 0a20 2020  I8, fsize);..   
-00083e60: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
-00083e70: 7420 7265 7420 3d20 6672 6561 6428 6461  t ret = fread(da
-00083e80: 7461 2d3e 6461 7461 2c20 7369 7a65 6f66  ta->data, sizeof
-00083e90: 2863 6861 7229 2c20 6673 697a 652c 2066  (char), fsize, f
-00083ea0: 696e 293b 0a20 2020 2020 2020 2069 6620  in);.        if 
-00083eb0: 2872 6574 2021 3d20 6673 697a 6529 207b  (ret != fsize) {
-00083ec0: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
-00083ed0: 696e 7466 2873 7464 6572 722c 2022 2573  intf(stderr, "%s
-00083ee0: 3a20 6661 696c 6564 2074 6f20 7265 6164  : failed to read
-00083ef0: 2025 735c 6e22 2c20 5f5f 6675 6e63 5f5f   %s\n", __func__
-00083f00: 2c20 666e 616d 6529 3b0a 2020 2020 2020  , fname);.      
-00083f10: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-00083f20: 756c 743b 0a20 2020 2020 2020 207d 0a0a  ult;.        }..
-00083f30: 2020 2020 2020 2020 6663 6c6f 7365 2866          fclose(f
-00083f40: 696e 293b 0a20 2020 207d 0a0a 2020 2020  in);.    }..    
-00083f50: 2f2f 2070 6f70 756c 6174 6520 7265 7375  // populate resu
-00083f60: 6c74 0a20 2020 207b 0a20 2020 2020 2020  lt.    {.       
-00083f70: 2063 6861 7220 2a20 7074 7220 3d20 2863   char * ptr = (c
-00083f80: 6861 7220 2a29 2064 6174 612d 3e64 6174  har *) data->dat
-00083f90: 613b 0a0a 2020 2020 2020 2020 636f 6e73  a;..        cons
-00083fa0: 7420 7569 6e74 3332 5f74 206d 6167 6963  t uint32_t magic
-00083fb0: 203d 202a 2863 6f6e 7374 2075 696e 7433   = *(const uint3
-00083fc0: 325f 7420 2a29 2070 7472 3b20 7074 7220  2_t *) ptr; ptr 
-00083fd0: 2b3d 2073 697a 656f 6628 6d61 6769 6329  += sizeof(magic)
-00083fe0: 3b0a 0a20 2020 2020 2020 2069 6620 286d  ;..        if (m
-00083ff0: 6167 6963 2021 3d20 4747 4d4c 5f46 494c  agic != GGML_FIL
-00084000: 455f 4d41 4749 4329 207b 0a20 2020 2020  E_MAGIC) {.     
-00084010: 2020 2020 2020 2066 7072 696e 7466 2873         fprintf(s
-00084020: 7464 6572 722c 2022 2573 3a20 696e 7661  tderr, "%s: inva
-00084030: 6c69 6420 6d61 6769 6320 6e75 6d62 6572  lid magic number
-00084040: 2c20 676f 7420 2530 3878 5c6e 222c 205f  , got %08x\n", _
-00084050: 5f66 756e 635f 5f2c 206d 6167 6963 293b  _func__, magic);
-00084060: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00084070: 7572 6e20 7265 7375 6c74 3b0a 2020 2020  urn result;.    
-00084080: 2020 2020 7d0a 0a20 2020 2020 2020 2063      }..        c
-00084090: 6f6e 7374 2075 696e 7433 325f 7420 7665  onst uint32_t ve
-000840a0: 7273 696f 6e20 3d20 2a28 636f 6e73 7420  rsion = *(const 
-000840b0: 7569 6e74 3332 5f74 202a 2920 7074 723b  uint32_t *) ptr;
-000840c0: 2070 7472 202b 3d20 7369 7a65 6f66 2876   ptr += sizeof(v
-000840d0: 6572 7369 6f6e 293b 0a0a 2020 2020 2020  ersion);..      
-000840e0: 2020 6966 2028 7665 7273 696f 6e20 213d    if (version !=
-000840f0: 2047 474d 4c5f 4649 4c45 5f56 4552 5349   GGML_FILE_VERSI
-00084100: 4f4e 2920 7b0a 2020 2020 2020 2020 2020  ON) {.          
-00084110: 2020 6670 7269 6e74 6628 7374 6465 7272    fprintf(stderr
-00084120: 2c20 2225 733a 2069 6e76 616c 6964 2076  , "%s: invalid v
-00084130: 6572 7369 6f6e 206e 756d 6265 725c 6e22  ersion number\n"
-00084140: 2c20 5f5f 6675 6e63 5f5f 293b 0a20 2020  , __func__);.   
-00084150: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00084160: 7265 7375 6c74 3b0a 2020 2020 2020 2020  result;.        
-00084170: 7d0a 0a20 2020 2020 2020 2063 6f6e 7374  }..        const
-00084180: 2075 696e 7433 325f 7420 6e5f 6c65 6166   uint32_t n_leaf
-00084190: 7320 2020 3d20 2a28 636f 6e73 7420 7569  s   = *(const ui
-000841a0: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
-000841b0: 7472 202b 3d20 7369 7a65 6f66 286e 5f6c  tr += sizeof(n_l
-000841c0: 6561 6673 293b 0a20 2020 2020 2020 2063  eafs);.        c
-000841d0: 6f6e 7374 2075 696e 7433 325f 7420 6e5f  onst uint32_t n_
-000841e0: 6e6f 6465 7320 2020 3d20 2a28 636f 6e73  nodes   = *(cons
-000841f0: 7420 7569 6e74 3332 5f74 202a 2920 7074  t uint32_t *) pt
-00084200: 723b 2070 7472 202b 3d20 7369 7a65 6f66  r; ptr += sizeof
-00084210: 286e 5f6e 6f64 6573 293b 0a20 2020 2020  (n_nodes);.     
-00084220: 2020 2063 6f6e 7374 2075 696e 7436 345f     const uint64_
-00084230: 7420 7369 7a65 5f65 7661 6c20 3d20 2a28  t size_eval = *(
-00084240: 636f 6e73 7420 7569 6e74 3634 5f74 202a  const uint64_t *
-00084250: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
-00084260: 7a65 6f66 2873 697a 655f 6576 616c 293b  zeof(size_eval);
-00084270: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
-00084280: 2e6e 5f6c 6561 6673 203d 206e 5f6c 6561  .n_leafs = n_lea
-00084290: 6673 3b0a 2020 2020 2020 2020 7265 7375  fs;.        resu
-000842a0: 6c74 2e6e 5f6e 6f64 6573 203d 206e 5f6e  lt.n_nodes = n_n
-000842b0: 6f64 6573 3b0a 0a20 2020 2020 2020 202f  odes;..        /
-000842c0: 2f20 6372 6561 7465 2074 6865 2064 6174  / create the dat
-000842d0: 6120 636f 6e74 6578 740a 2020 2020 2020  a context.      
-000842e0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000842f0: 636f 6e73 7420 7369 7a65 5f74 206f 7665  const size_t ove
-00084300: 7268 6561 6420 3d20 286e 5f6c 6561 6673  rhead = (n_leafs
-00084310: 202b 206e 5f6e 6f64 6573 292a 6767 6d6c   + n_nodes)*ggml
-00084320: 5f74 656e 736f 725f 6f76 6572 6865 6164  _tensor_overhead
-00084330: 2829 3b0a 0a20 2020 2020 2020 2020 2020  ();..           
-00084340: 2073 7472 7563 7420 6767 6d6c 5f69 6e69   struct ggml_ini
-00084350: 745f 7061 7261 6d73 2070 6172 616d 7320  t_params params 
-00084360: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00084370: 2020 2020 2e6d 656d 5f73 697a 6520 2020      .mem_size   
-00084380: 3d20 7369 7a65 5f65 7661 6c20 2b20 6f76  = size_eval + ov
-00084390: 6572 6865 6164 2c0a 2020 2020 2020 2020  erhead,.        
-000843a0: 2020 2020 2020 2020 2e6d 656d 5f62 7566          .mem_buf
-000843b0: 6665 7220 3d20 4e55 4c4c 2c0a 2020 2020  fer = NULL,.    
-000843c0: 2020 2020 2020 2020 2020 2020 2e6e 6f5f              .no_
-000843d0: 616c 6c6f 6320 2020 3d20 7472 7565 2c0a  alloc   = true,.
-000843e0: 2020 2020 2020 2020 2020 2020 7d3b 0a0a              };..
-000843f0: 2020 2020 2020 2020 2020 2020 2a63 7478              *ctx
-00084400: 5f65 7661 6c20 3d20 6767 6d6c 5f69 6e69  _eval = ggml_ini
-00084410: 7428 7061 7261 6d73 293b 0a0a 2020 2020  t(params);..    
-00084420: 2020 2020 2020 2020 6966 2028 212a 6374          if (!*ct
-00084430: 785f 6576 616c 2920 7b0a 2020 2020 2020  x_eval) {.      
-00084440: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
-00084450: 6628 7374 6465 7272 2c20 2225 733a 2066  f(stderr, "%s: f
-00084460: 6169 6c65 6420 746f 2063 7265 6174 6520  ailed to create 
-00084470: 6767 6d6c 2063 6f6e 7465 7874 5c6e 222c  ggml context\n",
-00084480: 205f 5f66 756e 635f 5f29 3b0a 2020 2020   __func__);.    
-00084490: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000844a0: 726e 2072 6573 756c 743b 0a20 2020 2020  rn result;.     
-000844b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000844c0: 207d 0a0a 2020 2020 2020 2020 2f2f 206c   }..        // l
-000844d0: 6561 6673 0a20 2020 2020 2020 207b 0a20  eafs.        {. 
-000844e0: 2020 2020 2020 2020 2020 2075 696e 7433             uint3
-000844f0: 325f 7420 7479 7065 3b0a 2020 2020 2020  2_t type;.      
-00084500: 2020 2020 2020 7569 6e74 3332 5f74 206f        uint32_t o
-00084510: 703b 0a20 2020 2020 2020 2020 2020 2075  p;.            u
-00084520: 696e 7433 325f 7420 6e5f 6469 6d73 3b0a  int32_t n_dims;.
-00084530: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00084540: 2028 7569 6e74 3332 5f74 2069 203d 2030   (uint32_t i = 0
-00084550: 3b20 6920 3c20 6e5f 6c65 6166 733b 202b  ; i < n_leafs; +
-00084560: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
-00084570: 2020 2020 2020 7479 7065 2020 203d 202a        type   = *
-00084580: 2863 6f6e 7374 2075 696e 7433 325f 7420  (const uint32_t 
-00084590: 2a29 2070 7472 3b20 7074 7220 2b3d 2073  *) ptr; ptr += s
-000845a0: 697a 656f 6628 7479 7065 293b 0a20 2020  izeof(type);.   
-000845b0: 2020 2020 2020 2020 2020 2020 206f 7020               op 
-000845c0: 2020 2020 3d20 2a28 636f 6e73 7420 7569      = *(const ui
-000845d0: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
-000845e0: 7472 202b 3d20 7369 7a65 6f66 286f 7029  tr += sizeof(op)
-000845f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00084600: 2020 6e5f 6469 6d73 203d 202a 2863 6f6e    n_dims = *(con
-00084610: 7374 2075 696e 7433 325f 7420 2a29 2070  st uint32_t *) p
-00084620: 7472 3b20 7074 7220 2b3d 2073 697a 656f  tr; ptr += sizeo
-00084630: 6628 6e5f 6469 6d73 293b 0a0a 2020 2020  f(n_dims);..    
-00084640: 2020 2020 2020 2020 2020 2020 696e 7436              int6
-00084650: 345f 7420 6e65 5b47 474d 4c5f 4d41 585f  4_t ne[GGML_MAX_
-00084660: 4449 4d53 5d3b 0a20 2020 2020 2020 2020  DIMS];.         
-00084670: 2020 2020 2020 2073 697a 655f 7420 206e         size_t  n
-00084680: 625b 4747 4d4c 5f4d 4158 5f44 494d 535d  b[GGML_MAX_DIMS]
-00084690: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000846a0: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-000846b0: 303b 206a 203c 2047 474d 4c5f 4d41 585f  0; j < GGML_MAX_
-000846c0: 4449 4d53 3b20 2b2b 6a29 207b 0a20 2020  DIMS; ++j) {.   
-000846d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000846e0: 2075 696e 7436 345f 7420 6e65 5f63 7572   uint64_t ne_cur
-000846f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00084700: 2020 2020 2020 7569 6e74 3634 5f74 206e        uint64_t n
-00084710: 625f 6375 723b 0a0a 2020 2020 2020 2020  b_cur;..        
-00084720: 2020 2020 2020 2020 2020 2020 6e65 5f63              ne_c
-00084730: 7572 203d 202a 2863 6f6e 7374 2075 696e  ur = *(const uin
-00084740: 7436 345f 7420 2a29 2070 7472 3b20 7074  t64_t *) ptr; pt
-00084750: 7220 2b3d 2073 697a 656f 6628 6e65 5f63  r += sizeof(ne_c
-00084760: 7572 293b 0a20 2020 2020 2020 2020 2020  ur);.           
-00084770: 2020 2020 2020 2020 206e 625f 6375 7220           nb_cur 
-00084780: 3d20 2a28 636f 6e73 7420 7569 6e74 3634  = *(const uint64
-00084790: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
-000847a0: 3d20 7369 7a65 6f66 286e 625f 6375 7229  = sizeof(nb_cur)
-000847b0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000847c0: 2020 2020 2020 206e 655b 6a5d 203d 206e         ne[j] = n
-000847d0: 655f 6375 723b 0a20 2020 2020 2020 2020  e_cur;.         
-000847e0: 2020 2020 2020 2020 2020 206e 625b 6a5d             nb[j]
-000847f0: 203d 206e 625f 6375 723b 0a20 2020 2020   = nb_cur;.     
-00084800: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00084810: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00084820: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00084830: 202a 2074 656e 736f 7220 3d20 6767 6d6c   * tensor = ggml
-00084840: 5f6e 6577 5f74 656e 736f 7228 2a63 7478  _new_tensor(*ctx
-00084850: 5f65 7661 6c2c 2028 656e 756d 2067 676d  _eval, (enum ggm
-00084860: 6c5f 7479 7065 2920 7479 7065 2c20 6e5f  l_type) type, n_
-00084870: 6469 6d73 2c20 6e65 293b 0a0a 2020 2020  dims, ne);..    
-00084880: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-00084890: 6f72 2d3e 6f70 203d 2028 656e 756d 2067  or->op = (enum g
-000848a0: 676d 6c5f 6f70 2920 6f70 3b0a 0a20 2020  gml_op) op;..   
-000848b0: 2020 2020 2020 2020 2020 2020 2075 696e               uin
-000848c0: 7436 345f 7420 7074 725f 6375 7220 3d20  t64_t ptr_cur = 
-000848d0: 2a28 636f 6e73 7420 7569 6e74 3634 5f74  *(const uint64_t
-000848e0: 202a 2920 7074 723b 2070 7472 202b 3d20   *) ptr; ptr += 
-000848f0: 7369 7a65 6f66 2870 7472 5f63 7572 293b  sizeof(ptr_cur);
-00084900: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00084910: 2020 6d65 6d63 7079 2874 656e 736f 722d    memcpy(tensor-
-00084920: 3e6e 616d 652c 2070 7472 2c20 4747 4d4c  >name, ptr, GGML
-00084930: 5f4d 4158 5f4e 414d 4529 3b20 7074 7220  _MAX_NAME); ptr 
-00084940: 2b3d 2047 474d 4c5f 4d41 585f 4e41 4d45  += GGML_MAX_NAME
-00084950: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00084960: 2020 2074 656e 736f 722d 3e64 6174 6120     tensor->data 
-00084970: 3d20 2876 6f69 6420 2a29 2070 7472 3b0a  = (void *) ptr;.
-00084980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00084990: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-000849a0: 206a 203c 2047 474d 4c5f 4d41 585f 4449   j < GGML_MAX_DI
-000849b0: 4d53 3b20 2b2b 6a29 207b 0a20 2020 2020  MS; ++j) {.     
-000849c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000849d0: 656e 736f 722d 3e6e 625b 6a5d 203d 206e  ensor->nb[j] = n
-000849e0: 625b 6a5d 3b0a 2020 2020 2020 2020 2020  b[j];.          
-000849f0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00084a00: 2020 2020 2020 2020 2072 6573 756c 742e           result.
-00084a10: 6c65 6166 735b 695d 203d 2074 656e 736f  leafs[i] = tenso
-00084a20: 723b 0a0a 2020 2020 2020 2020 2020 2020  r;..            
-00084a30: 2020 2020 7074 7220 2b3d 2067 676d 6c5f      ptr += ggml_
-00084a40: 6e62 7974 6573 2874 656e 736f 7229 3b0a  nbytes(tensor);.
-00084a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00084a60: 2066 7072 696e 7466 2873 7464 6572 722c   fprintf(stderr,
-00084a70: 2022 2573 3a20 6c6f 6164 6564 206c 6561   "%s: loaded lea
-00084a80: 6620 2564 3a20 2725 3136 7327 2c20 2533  f %d: '%16s', %3
-00084a90: 6420 6469 6d73 2c20 2539 7a75 2062 7974  d dims, %9zu byt
-00084aa0: 6573 5c6e 222c 205f 5f66 756e 635f 5f2c  es\n", __func__,
-00084ab0: 2069 2c20 7465 6e73 6f72 2d3e 6e61 6d65   i, tensor->name
-00084ac0: 2c20 6e5f 6469 6d73 2c20 6767 6d6c 5f6e  , n_dims, ggml_n
-00084ad0: 6279 7465 7328 7465 6e73 6f72 2929 3b0a  bytes(tensor));.
-00084ae0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00084af0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00084b00: 2067 676d 6c5f 7365 745f 6e6f 5f61 6c6c   ggml_set_no_all
-00084b10: 6f63 282a 6374 785f 6576 616c 2c20 6661  oc(*ctx_eval, fa
-00084b20: 6c73 6529 3b0a 0a20 2020 2020 2020 202f  lse);..        /
-00084b30: 2f20 6e6f 6465 730a 2020 2020 2020 2020  / nodes.        
-00084b40: 7b0a 2020 2020 2020 2020 2020 2020 7569  {.            ui
-00084b50: 6e74 3332 5f74 2074 7970 653b 0a20 2020  nt32_t type;.   
-00084b60: 2020 2020 2020 2020 2075 696e 7433 325f           uint32_
-00084b70: 7420 6f70 3b0a 2020 2020 2020 2020 2020  t op;.          
-00084b80: 2020 7569 6e74 3332 5f74 206e 5f64 696d    uint32_t n_dim
-00084b90: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
-00084ba0: 666f 7220 2875 696e 7433 325f 7420 6920  for (uint32_t i 
-00084bb0: 3d20 303b 2069 203c 206e 5f6e 6f64 6573  = 0; i < n_nodes
-00084bc0: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00084bd0: 2020 2020 2020 2020 2074 7970 6520 2020           type   
-00084be0: 3d20 2a28 636f 6e73 7420 7569 6e74 3332  = *(const uint32
-00084bf0: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
-00084c00: 3d20 7369 7a65 6f66 2874 7970 6529 3b0a  = sizeof(type);.
-00084c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084c20: 6f70 2020 2020 203d 202a 2863 6f6e 7374  op     = *(const
-00084c30: 2075 696e 7433 325f 7420 2a29 2070 7472   uint32_t *) ptr
-00084c40: 3b20 7074 7220 2b3d 2073 697a 656f 6628  ; ptr += sizeof(
-00084c50: 6f70 293b 0a20 2020 2020 2020 2020 2020  op);.           
-00084c60: 2020 2020 206e 5f64 696d 7320 3d20 2a28       n_dims = *(
-00084c70: 636f 6e73 7420 7569 6e74 3332 5f74 202a  const uint32_t *
-00084c80: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
-00084c90: 7a65 6f66 286e 5f64 696d 7329 3b0a 0a20  zeof(n_dims);.. 
-00084ca0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00084cb0: 6e75 6d20 6767 6d6c 5f6f 7020 656f 7020  num ggml_op eop 
-00084cc0: 3d20 2865 6e75 6d20 6767 6d6c 5f6f 7029  = (enum ggml_op)
-00084cd0: 206f 703b 0a0a 2020 2020 2020 2020 2020   op;..          
-00084ce0: 2020 2020 2020 696e 7436 345f 7420 6e65        int64_t ne
-00084cf0: 5b47 474d 4c5f 4d41 585f 4449 4d53 5d3b  [GGML_MAX_DIMS];
+00083780: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00083790: 7433 325f 7420 6e75 6c20 3d20 2d31 3b0a  t32_t nul = -1;.
+000837a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000837b0: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
+000837c0: 6974 6528 266e 756c 2c20 7369 7a65 6f66  ite(&nul, sizeof
+000837d0: 2869 6e74 3332 5f74 292c 2031 2c20 666f  (int32_t), 1, fo
+000837e0: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
+000837f0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00083800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083810: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00083820: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00083830: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
+00083840: 2020 2020 2020 2020 6663 6c6f 7365 2866          fclose(f
+00083850: 6f75 7429 3b0a 2020 2020 7d0a 7d0a 0a73  out);.    }.}..s
+00083860: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+00083870: 6820 6767 6d6c 5f67 7261 7068 5f69 6d70  h ggml_graph_imp
+00083880: 6f72 7428 636f 6e73 7420 6368 6172 202a  ort(const char *
+00083890: 2066 6e61 6d65 2c20 7374 7275 6374 2067   fname, struct g
+000838a0: 676d 6c5f 636f 6e74 6578 7420 2a2a 2063  gml_context ** c
+000838b0: 7478 5f64 6174 612c 2073 7472 7563 7420  tx_data, struct 
+000838c0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2a20  ggml_context ** 
+000838d0: 6374 785f 6576 616c 2920 7b0a 2020 2020  ctx_eval) {.    
+000838e0: 6173 7365 7274 282a 6374 785f 6461 7461  assert(*ctx_data
+000838f0: 203d 3d20 4e55 4c4c 293b 0a20 2020 2061   == NULL);.    a
+00083900: 7373 6572 7428 2a63 7478 5f65 7661 6c20  ssert(*ctx_eval 
+00083910: 3d3d 204e 554c 4c29 3b0a 0a20 2020 2073  == NULL);..    s
+00083920: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+00083930: 6820 7265 7375 6c74 203d 207b 2030 207d  h result = { 0 }
+00083940: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
+00083950: 6d6c 5f74 656e 736f 7220 2a20 6461 7461  ml_tensor * data
+00083960: 203d 204e 554c 4c3b 0a0a 2020 2020 2f2f   = NULL;..    //
+00083970: 2072 6561 6420 6669 6c65 2069 6e74 6f20   read file into 
+00083980: 6461 7461 0a20 2020 207b 0a20 2020 2020  data.    {.     
+00083990: 2020 2046 494c 4520 2a20 6669 6e20 3d20     FILE * fin = 
+000839a0: 666f 7065 6e28 666e 616d 652c 2022 7262  fopen(fname, "rb
+000839b0: 2229 3b0a 2020 2020 2020 2020 6966 2028  ");.        if (
+000839c0: 2166 696e 2920 7b0a 2020 2020 2020 2020  !fin) {.        
+000839d0: 2020 2020 6670 7269 6e74 6628 7374 6465      fprintf(stde
+000839e0: 7272 2c20 2225 733a 2066 6169 6c65 6420  rr, "%s: failed 
+000839f0: 746f 206f 7065 6e20 2573 5c6e 222c 205f  to open %s\n", _
+00083a00: 5f66 756e 635f 5f2c 2066 6e61 6d65 293b  _func__, fname);
+00083a10: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00083a20: 7572 6e20 7265 7375 6c74 3b0a 2020 2020  urn result;.    
+00083a30: 2020 2020 7d0a 0a20 2020 2020 2020 2073      }..        s
+00083a40: 697a 655f 7420 6673 697a 6520 3d20 303b  ize_t fsize = 0;
+00083a50: 0a0a 2020 2020 2020 2020 6673 6565 6b28  ..        fseek(
+00083a60: 6669 6e2c 2030 2c20 5345 454b 5f45 4e44  fin, 0, SEEK_END
+00083a70: 293b 0a20 2020 2020 2020 2066 7369 7a65  );.        fsize
+00083a80: 203d 2066 7465 6c6c 2866 696e 293b 0a20   = ftell(fin);. 
+00083a90: 2020 2020 2020 2066 7365 656b 2866 696e         fseek(fin
+00083aa0: 2c20 302c 2053 4545 4b5f 5345 5429 3b0a  , 0, SEEK_SET);.
+00083ab0: 0a20 2020 2020 2020 202f 2f20 6372 6561  .        // crea
+00083ac0: 7465 2074 6865 2064 6174 6120 636f 6e74  te the data cont
+00083ad0: 6578 740a 2020 2020 2020 2020 7b0a 2020  ext.        {.  
+00083ae0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00083af0: 7369 7a65 5f74 206f 7665 7268 6561 6420  size_t overhead 
+00083b00: 3d20 312a 6767 6d6c 5f74 656e 736f 725f  = 1*ggml_tensor_
+00083b10: 6f76 6572 6865 6164 2829 3b0a 0a20 2020  overhead();..   
+00083b20: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+00083b30: 6767 6d6c 5f69 6e69 745f 7061 7261 6d73  ggml_init_params
+00083b40: 2070 6172 616d 7320 3d20 7b0a 2020 2020   params = {.    
+00083b50: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
+00083b60: 5f73 697a 6520 2020 3d20 6673 697a 6520  _size   = fsize 
+00083b70: 2b20 6f76 6572 6865 6164 2c0a 2020 2020  + overhead,.    
+00083b80: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
+00083b90: 5f62 7566 6665 7220 3d20 4e55 4c4c 2c0a  _buffer = NULL,.
+00083ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083bb0: 2e6e 6f5f 616c 6c6f 6320 2020 3d20 6661  .no_alloc   = fa
+00083bc0: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+00083bd0: 207d 3b0a 0a20 2020 2020 2020 2020 2020   };..           
+00083be0: 202a 6374 785f 6461 7461 203d 2067 676d   *ctx_data = ggm
+00083bf0: 6c5f 696e 6974 2870 6172 616d 7329 3b0a  l_init(params);.
+00083c00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00083c10: 2821 2a63 7478 5f64 6174 6129 207b 0a20  (!*ctx_data) {. 
+00083c20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00083c30: 7072 696e 7466 2873 7464 6572 722c 2022  printf(stderr, "
+00083c40: 2573 3a20 6661 696c 6564 2074 6f20 6372  %s: failed to cr
+00083c50: 6561 7465 2067 676d 6c20 636f 6e74 6578  eate ggml contex
+00083c60: 745c 6e22 2c20 5f5f 6675 6e63 5f5f 293b  t\n", __func__);
+00083c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00083c80: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+00083c90: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00083ca0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00083cb0: 2064 6174 6120 3d20 6767 6d6c 5f6e 6577   data = ggml_new
+00083cc0: 5f74 656e 736f 725f 3164 282a 6374 785f  _tensor_1d(*ctx_
+00083cd0: 6461 7461 2c20 4747 4d4c 5f54 5950 455f  data, GGML_TYPE_
+00083ce0: 4938 2c20 6673 697a 6529 3b0a 0a20 2020  I8, fsize);..   
+00083cf0: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+00083d00: 7420 7265 7420 3d20 6672 6561 6428 6461  t ret = fread(da
+00083d10: 7461 2d3e 6461 7461 2c20 7369 7a65 6f66  ta->data, sizeof
+00083d20: 2863 6861 7229 2c20 6673 697a 652c 2066  (char), fsize, f
+00083d30: 696e 293b 0a20 2020 2020 2020 2069 6620  in);.        if 
+00083d40: 2872 6574 2021 3d20 6673 697a 6529 207b  (ret != fsize) {
+00083d50: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
+00083d60: 696e 7466 2873 7464 6572 722c 2022 2573  intf(stderr, "%s
+00083d70: 3a20 6661 696c 6564 2074 6f20 7265 6164  : failed to read
+00083d80: 2025 735c 6e22 2c20 5f5f 6675 6e63 5f5f   %s\n", __func__
+00083d90: 2c20 666e 616d 6529 3b0a 2020 2020 2020  , fname);.      
+00083da0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00083db0: 756c 743b 0a20 2020 2020 2020 207d 0a0a  ult;.        }..
+00083dc0: 2020 2020 2020 2020 6663 6c6f 7365 2866          fclose(f
+00083dd0: 696e 293b 0a20 2020 207d 0a0a 2020 2020  in);.    }..    
+00083de0: 2f2f 2070 6f70 756c 6174 6520 7265 7375  // populate resu
+00083df0: 6c74 0a20 2020 207b 0a20 2020 2020 2020  lt.    {.       
+00083e00: 2063 6861 7220 2a20 7074 7220 3d20 2863   char * ptr = (c
+00083e10: 6861 7220 2a29 2064 6174 612d 3e64 6174  har *) data->dat
+00083e20: 613b 0a0a 2020 2020 2020 2020 636f 6e73  a;..        cons
+00083e30: 7420 7569 6e74 3332 5f74 206d 6167 6963  t uint32_t magic
+00083e40: 203d 202a 2863 6f6e 7374 2075 696e 7433   = *(const uint3
+00083e50: 325f 7420 2a29 2070 7472 3b20 7074 7220  2_t *) ptr; ptr 
+00083e60: 2b3d 2073 697a 656f 6628 6d61 6769 6329  += sizeof(magic)
+00083e70: 3b0a 0a20 2020 2020 2020 2069 6620 286d  ;..        if (m
+00083e80: 6167 6963 2021 3d20 4747 4d4c 5f46 494c  agic != GGML_FIL
+00083e90: 455f 4d41 4749 4329 207b 0a20 2020 2020  E_MAGIC) {.     
+00083ea0: 2020 2020 2020 2066 7072 696e 7466 2873         fprintf(s
+00083eb0: 7464 6572 722c 2022 2573 3a20 696e 7661  tderr, "%s: inva
+00083ec0: 6c69 6420 6d61 6769 6320 6e75 6d62 6572  lid magic number
+00083ed0: 2c20 676f 7420 2530 3878 5c6e 222c 205f  , got %08x\n", _
+00083ee0: 5f66 756e 635f 5f2c 206d 6167 6963 293b  _func__, magic);
+00083ef0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00083f00: 7572 6e20 7265 7375 6c74 3b0a 2020 2020  urn result;.    
+00083f10: 2020 2020 7d0a 0a20 2020 2020 2020 2063      }..        c
+00083f20: 6f6e 7374 2075 696e 7433 325f 7420 7665  onst uint32_t ve
+00083f30: 7273 696f 6e20 3d20 2a28 636f 6e73 7420  rsion = *(const 
+00083f40: 7569 6e74 3332 5f74 202a 2920 7074 723b  uint32_t *) ptr;
+00083f50: 2070 7472 202b 3d20 7369 7a65 6f66 2876   ptr += sizeof(v
+00083f60: 6572 7369 6f6e 293b 0a0a 2020 2020 2020  ersion);..      
+00083f70: 2020 6966 2028 7665 7273 696f 6e20 213d    if (version !=
+00083f80: 2047 474d 4c5f 4649 4c45 5f56 4552 5349   GGML_FILE_VERSI
+00083f90: 4f4e 2920 7b0a 2020 2020 2020 2020 2020  ON) {.          
+00083fa0: 2020 6670 7269 6e74 6628 7374 6465 7272    fprintf(stderr
+00083fb0: 2c20 2225 733a 2069 6e76 616c 6964 2076  , "%s: invalid v
+00083fc0: 6572 7369 6f6e 206e 756d 6265 725c 6e22  ersion number\n"
+00083fd0: 2c20 5f5f 6675 6e63 5f5f 293b 0a20 2020  , __func__);.   
+00083fe0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00083ff0: 7265 7375 6c74 3b0a 2020 2020 2020 2020  result;.        
+00084000: 7d0a 0a20 2020 2020 2020 2063 6f6e 7374  }..        const
+00084010: 2075 696e 7433 325f 7420 6e5f 6c65 6166   uint32_t n_leaf
+00084020: 7320 2020 3d20 2a28 636f 6e73 7420 7569  s   = *(const ui
+00084030: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
+00084040: 7472 202b 3d20 7369 7a65 6f66 286e 5f6c  tr += sizeof(n_l
+00084050: 6561 6673 293b 0a20 2020 2020 2020 2063  eafs);.        c
+00084060: 6f6e 7374 2075 696e 7433 325f 7420 6e5f  onst uint32_t n_
+00084070: 6e6f 6465 7320 2020 3d20 2a28 636f 6e73  nodes   = *(cons
+00084080: 7420 7569 6e74 3332 5f74 202a 2920 7074  t uint32_t *) pt
+00084090: 723b 2070 7472 202b 3d20 7369 7a65 6f66  r; ptr += sizeof
+000840a0: 286e 5f6e 6f64 6573 293b 0a20 2020 2020  (n_nodes);.     
+000840b0: 2020 2063 6f6e 7374 2075 696e 7436 345f     const uint64_
+000840c0: 7420 7369 7a65 5f65 7661 6c20 3d20 2a28  t size_eval = *(
+000840d0: 636f 6e73 7420 7569 6e74 3634 5f74 202a  const uint64_t *
+000840e0: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
+000840f0: 7a65 6f66 2873 697a 655f 6576 616c 293b  zeof(size_eval);
+00084100: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
+00084110: 2e6e 5f6c 6561 6673 203d 206e 5f6c 6561  .n_leafs = n_lea
+00084120: 6673 3b0a 2020 2020 2020 2020 7265 7375  fs;.        resu
+00084130: 6c74 2e6e 5f6e 6f64 6573 203d 206e 5f6e  lt.n_nodes = n_n
+00084140: 6f64 6573 3b0a 0a20 2020 2020 2020 202f  odes;..        /
+00084150: 2f20 6372 6561 7465 2074 6865 2064 6174  / create the dat
+00084160: 6120 636f 6e74 6578 740a 2020 2020 2020  a context.      
+00084170: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00084180: 636f 6e73 7420 7369 7a65 5f74 206f 7665  const size_t ove
+00084190: 7268 6561 6420 3d20 286e 5f6c 6561 6673  rhead = (n_leafs
+000841a0: 202b 206e 5f6e 6f64 6573 292a 6767 6d6c   + n_nodes)*ggml
+000841b0: 5f74 656e 736f 725f 6f76 6572 6865 6164  _tensor_overhead
+000841c0: 2829 3b0a 0a20 2020 2020 2020 2020 2020  ();..           
+000841d0: 2073 7472 7563 7420 6767 6d6c 5f69 6e69   struct ggml_ini
+000841e0: 745f 7061 7261 6d73 2070 6172 616d 7320  t_params params 
+000841f0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00084200: 2020 2020 2e6d 656d 5f73 697a 6520 2020      .mem_size   
+00084210: 3d20 7369 7a65 5f65 7661 6c20 2b20 6f76  = size_eval + ov
+00084220: 6572 6865 6164 2c0a 2020 2020 2020 2020  erhead,.        
+00084230: 2020 2020 2020 2020 2e6d 656d 5f62 7566          .mem_buf
+00084240: 6665 7220 3d20 4e55 4c4c 2c0a 2020 2020  fer = NULL,.    
+00084250: 2020 2020 2020 2020 2020 2020 2e6e 6f5f              .no_
+00084260: 616c 6c6f 6320 2020 3d20 7472 7565 2c0a  alloc   = true,.
+00084270: 2020 2020 2020 2020 2020 2020 7d3b 0a0a              };..
+00084280: 2020 2020 2020 2020 2020 2020 2a63 7478              *ctx
+00084290: 5f65 7661 6c20 3d20 6767 6d6c 5f69 6e69  _eval = ggml_ini
+000842a0: 7428 7061 7261 6d73 293b 0a0a 2020 2020  t(params);..    
+000842b0: 2020 2020 2020 2020 6966 2028 212a 6374          if (!*ct
+000842c0: 785f 6576 616c 2920 7b0a 2020 2020 2020  x_eval) {.      
+000842d0: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
+000842e0: 6628 7374 6465 7272 2c20 2225 733a 2066  f(stderr, "%s: f
+000842f0: 6169 6c65 6420 746f 2063 7265 6174 6520  ailed to create 
+00084300: 6767 6d6c 2063 6f6e 7465 7874 5c6e 222c  ggml context\n",
+00084310: 205f 5f66 756e 635f 5f29 3b0a 2020 2020   __func__);.    
+00084320: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00084330: 726e 2072 6573 756c 743b 0a20 2020 2020  rn result;.     
+00084340: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00084350: 207d 0a0a 2020 2020 2020 2020 2f2f 206c   }..        // l
+00084360: 6561 6673 0a20 2020 2020 2020 207b 0a20  eafs.        {. 
+00084370: 2020 2020 2020 2020 2020 2075 696e 7433             uint3
+00084380: 325f 7420 7479 7065 3b0a 2020 2020 2020  2_t type;.      
+00084390: 2020 2020 2020 7569 6e74 3332 5f74 206f        uint32_t o
+000843a0: 703b 0a20 2020 2020 2020 2020 2020 2075  p;.            u
+000843b0: 696e 7433 325f 7420 6e5f 6469 6d73 3b0a  int32_t n_dims;.
+000843c0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000843d0: 2028 7569 6e74 3332 5f74 2069 203d 2030   (uint32_t i = 0
+000843e0: 3b20 6920 3c20 6e5f 6c65 6166 733b 202b  ; i < n_leafs; +
+000843f0: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
+00084400: 2020 2020 2020 7479 7065 2020 203d 202a        type   = *
+00084410: 2863 6f6e 7374 2075 696e 7433 325f 7420  (const uint32_t 
+00084420: 2a29 2070 7472 3b20 7074 7220 2b3d 2073  *) ptr; ptr += s
+00084430: 697a 656f 6628 7479 7065 293b 0a20 2020  izeof(type);.   
+00084440: 2020 2020 2020 2020 2020 2020 206f 7020               op 
+00084450: 2020 2020 3d20 2a28 636f 6e73 7420 7569      = *(const ui
+00084460: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
+00084470: 7472 202b 3d20 7369 7a65 6f66 286f 7029  tr += sizeof(op)
+00084480: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00084490: 2020 6e5f 6469 6d73 203d 202a 2863 6f6e    n_dims = *(con
+000844a0: 7374 2075 696e 7433 325f 7420 2a29 2070  st uint32_t *) p
+000844b0: 7472 3b20 7074 7220 2b3d 2073 697a 656f  tr; ptr += sizeo
+000844c0: 6628 6e5f 6469 6d73 293b 0a0a 2020 2020  f(n_dims);..    
+000844d0: 2020 2020 2020 2020 2020 2020 696e 7436              int6
+000844e0: 345f 7420 6e65 5b47 474d 4c5f 4d41 585f  4_t ne[GGML_MAX_
+000844f0: 4449 4d53 5d3b 0a20 2020 2020 2020 2020  DIMS];.         
+00084500: 2020 2020 2020 2073 697a 655f 7420 206e         size_t  n
+00084510: 625b 4747 4d4c 5f4d 4158 5f44 494d 535d  b[GGML_MAX_DIMS]
+00084520: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00084530: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
+00084540: 303b 206a 203c 2047 474d 4c5f 4d41 585f  0; j < GGML_MAX_
+00084550: 4449 4d53 3b20 2b2b 6a29 207b 0a20 2020  DIMS; ++j) {.   
+00084560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084570: 2075 696e 7436 345f 7420 6e65 5f63 7572   uint64_t ne_cur
+00084580: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00084590: 2020 2020 2020 7569 6e74 3634 5f74 206e        uint64_t n
+000845a0: 625f 6375 723b 0a0a 2020 2020 2020 2020  b_cur;..        
+000845b0: 2020 2020 2020 2020 2020 2020 6e65 5f63              ne_c
+000845c0: 7572 203d 202a 2863 6f6e 7374 2075 696e  ur = *(const uin
+000845d0: 7436 345f 7420 2a29 2070 7472 3b20 7074  t64_t *) ptr; pt
+000845e0: 7220 2b3d 2073 697a 656f 6628 6e65 5f63  r += sizeof(ne_c
+000845f0: 7572 293b 0a20 2020 2020 2020 2020 2020  ur);.           
+00084600: 2020 2020 2020 2020 206e 625f 6375 7220           nb_cur 
+00084610: 3d20 2a28 636f 6e73 7420 7569 6e74 3634  = *(const uint64
+00084620: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
+00084630: 3d20 7369 7a65 6f66 286e 625f 6375 7229  = sizeof(nb_cur)
+00084640: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00084650: 2020 2020 2020 206e 655b 6a5d 203d 206e         ne[j] = n
+00084660: 655f 6375 723b 0a20 2020 2020 2020 2020  e_cur;.         
+00084670: 2020 2020 2020 2020 2020 206e 625b 6a5d             nb[j]
+00084680: 203d 206e 625f 6375 723b 0a20 2020 2020   = nb_cur;.     
+00084690: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+000846a0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000846b0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000846c0: 202a 2074 656e 736f 7220 3d20 6767 6d6c   * tensor = ggml
+000846d0: 5f6e 6577 5f74 656e 736f 7228 2a63 7478  _new_tensor(*ctx
+000846e0: 5f65 7661 6c2c 2028 656e 756d 2067 676d  _eval, (enum ggm
+000846f0: 6c5f 7479 7065 2920 7479 7065 2c20 6e5f  l_type) type, n_
+00084700: 6469 6d73 2c20 6e65 293b 0a0a 2020 2020  dims, ne);..    
+00084710: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+00084720: 6f72 2d3e 6f70 203d 2028 656e 756d 2067  or->op = (enum g
+00084730: 676d 6c5f 6f70 2920 6f70 3b0a 0a20 2020  gml_op) op;..   
+00084740: 2020 2020 2020 2020 2020 2020 2075 696e               uin
+00084750: 7436 345f 7420 7074 725f 6375 7220 3d20  t64_t ptr_cur = 
+00084760: 2a28 636f 6e73 7420 7569 6e74 3634 5f74  *(const uint64_t
+00084770: 202a 2920 7074 723b 2070 7472 202b 3d20   *) ptr; ptr += 
+00084780: 7369 7a65 6f66 2870 7472 5f63 7572 293b  sizeof(ptr_cur);
+00084790: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000847a0: 2020 6d65 6d63 7079 2874 656e 736f 722d    memcpy(tensor-
+000847b0: 3e6e 616d 652c 2070 7472 2c20 4747 4d4c  >name, ptr, GGML
+000847c0: 5f4d 4158 5f4e 414d 4529 3b20 7074 7220  _MAX_NAME); ptr 
+000847d0: 2b3d 2047 474d 4c5f 4d41 585f 4e41 4d45  += GGML_MAX_NAME
+000847e0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+000847f0: 2020 2074 656e 736f 722d 3e64 6174 6120     tensor->data 
+00084800: 3d20 2876 6f69 6420 2a29 2070 7472 3b0a  = (void *) ptr;.
+00084810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00084820: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+00084830: 206a 203c 2047 474d 4c5f 4d41 585f 4449   j < GGML_MAX_DI
+00084840: 4d53 3b20 2b2b 6a29 207b 0a20 2020 2020  MS; ++j) {.     
+00084850: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00084860: 656e 736f 722d 3e6e 625b 6a5d 203d 206e  ensor->nb[j] = n
+00084870: 625b 6a5d 3b0a 2020 2020 2020 2020 2020  b[j];.          
+00084880: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00084890: 2020 2020 2020 2020 2072 6573 756c 742e           result.
+000848a0: 6c65 6166 735b 695d 203d 2074 656e 736f  leafs[i] = tenso
+000848b0: 723b 0a0a 2020 2020 2020 2020 2020 2020  r;..            
+000848c0: 2020 2020 7074 7220 2b3d 2067 676d 6c5f      ptr += ggml_
+000848d0: 6e62 7974 6573 2874 656e 736f 7229 3b0a  nbytes(tensor);.
+000848e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000848f0: 2066 7072 696e 7466 2873 7464 6572 722c   fprintf(stderr,
+00084900: 2022 2573 3a20 6c6f 6164 6564 206c 6561   "%s: loaded lea
+00084910: 6620 2564 3a20 2725 3136 7327 2c20 2533  f %d: '%16s', %3
+00084920: 6420 6469 6d73 2c20 2539 7a75 2062 7974  d dims, %9zu byt
+00084930: 6573 5c6e 222c 205f 5f66 756e 635f 5f2c  es\n", __func__,
+00084940: 2069 2c20 7465 6e73 6f72 2d3e 6e61 6d65   i, tensor->name
+00084950: 2c20 6e5f 6469 6d73 2c20 6767 6d6c 5f6e  , n_dims, ggml_n
+00084960: 6279 7465 7328 7465 6e73 6f72 2929 3b0a  bytes(tensor));.
+00084970: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00084980: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00084990: 2067 676d 6c5f 7365 745f 6e6f 5f61 6c6c   ggml_set_no_all
+000849a0: 6f63 282a 6374 785f 6576 616c 2c20 6661  oc(*ctx_eval, fa
+000849b0: 6c73 6529 3b0a 0a20 2020 2020 2020 202f  lse);..        /
+000849c0: 2f20 6e6f 6465 730a 2020 2020 2020 2020  / nodes.        
+000849d0: 7b0a 2020 2020 2020 2020 2020 2020 7569  {.            ui
+000849e0: 6e74 3332 5f74 2074 7970 653b 0a20 2020  nt32_t type;.   
+000849f0: 2020 2020 2020 2020 2075 696e 7433 325f           uint32_
+00084a00: 7420 6f70 3b0a 2020 2020 2020 2020 2020  t op;.          
+00084a10: 2020 7569 6e74 3332 5f74 206e 5f64 696d    uint32_t n_dim
+00084a20: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
+00084a30: 666f 7220 2875 696e 7433 325f 7420 6920  for (uint32_t i 
+00084a40: 3d20 303b 2069 203c 206e 5f6e 6f64 6573  = 0; i < n_nodes
+00084a50: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
+00084a60: 2020 2020 2020 2020 2074 7970 6520 2020           type   
+00084a70: 3d20 2a28 636f 6e73 7420 7569 6e74 3332  = *(const uint32
+00084a80: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
+00084a90: 3d20 7369 7a65 6f66 2874 7970 6529 3b0a  = sizeof(type);.
+00084aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084ab0: 6f70 2020 2020 203d 202a 2863 6f6e 7374  op     = *(const
+00084ac0: 2075 696e 7433 325f 7420 2a29 2070 7472   uint32_t *) ptr
+00084ad0: 3b20 7074 7220 2b3d 2073 697a 656f 6628  ; ptr += sizeof(
+00084ae0: 6f70 293b 0a20 2020 2020 2020 2020 2020  op);.           
+00084af0: 2020 2020 206e 5f64 696d 7320 3d20 2a28       n_dims = *(
+00084b00: 636f 6e73 7420 7569 6e74 3332 5f74 202a  const uint32_t *
+00084b10: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
+00084b20: 7a65 6f66 286e 5f64 696d 7329 3b0a 0a20  zeof(n_dims);.. 
+00084b30: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00084b40: 6e75 6d20 6767 6d6c 5f6f 7020 656f 7020  num ggml_op eop 
+00084b50: 3d20 2865 6e75 6d20 6767 6d6c 5f6f 7029  = (enum ggml_op)
+00084b60: 206f 703b 0a0a 2020 2020 2020 2020 2020   op;..          
+00084b70: 2020 2020 2020 696e 7436 345f 7420 6e65        int64_t ne
+00084b80: 5b47 474d 4c5f 4d41 585f 4449 4d53 5d3b  [GGML_MAX_DIMS];
+00084b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00084ba0: 2073 697a 655f 7420 206e 625b 4747 4d4c   size_t  nb[GGML
+00084bb0: 5f4d 4158 5f44 494d 535d 3b0a 0a20 2020  _MAX_DIMS];..   
+00084bc0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00084bd0: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
+00084be0: 2047 474d 4c5f 4d41 585f 4449 4d53 3b20   GGML_MAX_DIMS; 
+00084bf0: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
+00084c00: 2020 2020 2020 2020 2020 2075 696e 7436             uint6
+00084c10: 345f 7420 6e65 5f63 7572 3b0a 2020 2020  4_t ne_cur;.    
+00084c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084c30: 7569 6e74 3634 5f74 206e 625f 6375 723b  uint64_t nb_cur;
+00084c40: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00084c50: 2020 2020 2020 6e65 5f63 7572 203d 202a        ne_cur = *
+00084c60: 2863 6f6e 7374 2075 696e 7436 345f 7420  (const uint64_t 
+00084c70: 2a29 2070 7472 3b20 7074 7220 2b3d 2073  *) ptr; ptr += s
+00084c80: 697a 656f 6628 6e65 5f63 7572 293b 0a20  izeof(ne_cur);. 
+00084c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084ca0: 2020 206e 625f 6375 7220 3d20 2a28 636f     nb_cur = *(co
+00084cb0: 6e73 7420 7569 6e74 3634 5f74 202a 2920  nst uint64_t *) 
+00084cc0: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
+00084cd0: 6f66 286e 625f 6375 7229 3b0a 0a20 2020  of(nb_cur);..   
+00084ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084cf0: 206e 655b 6a5d 203d 206e 655f 6375 723b   ne[j] = ne_cur;
 00084d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00084d10: 2073 697a 655f 7420 206e 625b 4747 4d4c   size_t  nb[GGML
-00084d20: 5f4d 4158 5f44 494d 535d 3b0a 0a20 2020  _MAX_DIMS];..   
-00084d30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00084d40: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
-00084d50: 2047 474d 4c5f 4d41 585f 4449 4d53 3b20   GGML_MAX_DIMS; 
-00084d60: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
-00084d70: 2020 2020 2020 2020 2020 2075 696e 7436             uint6
-00084d80: 345f 7420 6e65 5f63 7572 3b0a 2020 2020  4_t ne_cur;.    
-00084d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084da0: 7569 6e74 3634 5f74 206e 625f 6375 723b  uint64_t nb_cur;
-00084db0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00084dc0: 2020 2020 2020 6e65 5f63 7572 203d 202a        ne_cur = *
-00084dd0: 2863 6f6e 7374 2075 696e 7436 345f 7420  (const uint64_t 
-00084de0: 2a29 2070 7472 3b20 7074 7220 2b3d 2073  *) ptr; ptr += s
-00084df0: 697a 656f 6628 6e65 5f63 7572 293b 0a20  izeof(ne_cur);. 
-00084e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084e10: 2020 206e 625f 6375 7220 3d20 2a28 636f     nb_cur = *(co
-00084e20: 6e73 7420 7569 6e74 3634 5f74 202a 2920  nst uint64_t *) 
-00084e30: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
-00084e40: 6f66 286e 625f 6375 7229 3b0a 0a20 2020  of(nb_cur);..   
-00084e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084e60: 206e 655b 6a5d 203d 206e 655f 6375 723b   ne[j] = ne_cur;
-00084e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00084e80: 2020 2020 206e 625b 6a5d 203d 206e 625f       nb[j] = nb_
-00084e90: 6375 723b 0a20 2020 2020 2020 2020 2020  cur;.           
-00084ea0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00084eb0: 2020 2020 2020 2020 7569 6e74 3634 5f74          uint64_t
-00084ec0: 2070 7472 5f63 7572 203d 202a 2863 6f6e   ptr_cur = *(con
-00084ed0: 7374 2075 696e 7436 345f 7420 2a29 2070  st uint64_t *) p
-00084ee0: 7472 3b20 7074 7220 2b3d 2073 697a 656f  tr; ptr += sizeo
-00084ef0: 6628 7074 725f 6375 7229 3b20 2f2f 2054  f(ptr_cur); // T
-00084f00: 4f44 4f3a 206e 6f74 2079 6574 2075 7365  ODO: not yet use
-00084f10: 640a 0a20 2020 2020 2020 2020 2020 2020  d..             
-00084f20: 2020 2063 6f6e 7374 2063 6861 7220 2a20     const char * 
-00084f30: 7074 725f 6e61 6d65 203d 2070 7472 3b20  ptr_name = ptr; 
-00084f40: 7074 7220 2b3d 2047 474d 4c5f 4d41 585f  ptr += GGML_MAX_
-00084f50: 4e41 4d45 3b0a 0a20 2020 2020 2020 2020  NAME;..         
-00084f60: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00084f70: 3332 5f74 202a 2070 7472 5f61 7267 5f69  32_t * ptr_arg_i
-00084f80: 6478 203d 2028 636f 6e73 7420 696e 7433  dx = (const int3
-00084f90: 325f 7420 2a29 2070 7472 3b20 7074 7220  2_t *) ptr; ptr 
-00084fa0: 2b3d 2028 3220 2b20 4747 4d4c 5f4d 4158  += (2 + GGML_MAX
-00084fb0: 5f4f 5054 292a 7369 7a65 6f66 2869 6e74  _OPT)*sizeof(int
-00084fc0: 3332 5f74 293b 0a0a 2020 2020 2020 2020  32_t);..        
-00084fd0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00084fe0: 676d 6c5f 7465 6e73 6f72 202a 2061 7267  gml_tensor * arg
-00084ff0: 735b 3220 2b20 4747 4d4c 5f4d 4158 5f4f  s[2 + GGML_MAX_O
-00085000: 5054 5d20 3d20 7b20 4e55 4c4c 207d 3b0a  PT] = { NULL };.
-00085010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00085020: 202f 2f20 7061 7273 6520 6172 6773 0a20   // parse args. 
-00085030: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00085040: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-00085050: 203c 2032 202b 2047 474d 4c5f 4d41 585f   < 2 + GGML_MAX_
-00085060: 4f50 543b 202b 2b6a 2920 7b0a 2020 2020  OPT; ++j) {.    
+00084d10: 2020 2020 206e 625b 6a5d 203d 206e 625f       nb[j] = nb_
+00084d20: 6375 723b 0a20 2020 2020 2020 2020 2020  cur;.           
+00084d30: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00084d40: 2020 2020 2020 2020 7569 6e74 3634 5f74          uint64_t
+00084d50: 2070 7472 5f63 7572 203d 202a 2863 6f6e   ptr_cur = *(con
+00084d60: 7374 2075 696e 7436 345f 7420 2a29 2070  st uint64_t *) p
+00084d70: 7472 3b20 7074 7220 2b3d 2073 697a 656f  tr; ptr += sizeo
+00084d80: 6628 7074 725f 6375 7229 3b20 2f2f 2054  f(ptr_cur); // T
+00084d90: 4f44 4f3a 206e 6f74 2079 6574 2075 7365  ODO: not yet use
+00084da0: 640a 0a20 2020 2020 2020 2020 2020 2020  d..             
+00084db0: 2020 2063 6f6e 7374 2063 6861 7220 2a20     const char * 
+00084dc0: 7074 725f 6e61 6d65 203d 2070 7472 3b20  ptr_name = ptr; 
+00084dd0: 7074 7220 2b3d 2047 474d 4c5f 4d41 585f  ptr += GGML_MAX_
+00084de0: 4e41 4d45 3b0a 0a20 2020 2020 2020 2020  NAME;..         
+00084df0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00084e00: 3332 5f74 202a 2070 7472 5f61 7267 5f69  32_t * ptr_arg_i
+00084e10: 6478 203d 2028 636f 6e73 7420 696e 7433  dx = (const int3
+00084e20: 325f 7420 2a29 2070 7472 3b20 7074 7220  2_t *) ptr; ptr 
+00084e30: 2b3d 2028 3220 2b20 4747 4d4c 5f4d 4158  += (2 + GGML_MAX
+00084e40: 5f4f 5054 292a 7369 7a65 6f66 2869 6e74  _OPT)*sizeof(int
+00084e50: 3332 5f74 293b 0a0a 2020 2020 2020 2020  32_t);..        
+00084e60: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00084e70: 676d 6c5f 7465 6e73 6f72 202a 2061 7267  gml_tensor * arg
+00084e80: 735b 3220 2b20 4747 4d4c 5f4d 4158 5f4f  s[2 + GGML_MAX_O
+00084e90: 5054 5d20 3d20 7b20 4e55 4c4c 207d 3b0a  PT] = { NULL };.
+00084ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00084eb0: 202f 2f20 7061 7273 6520 6172 6773 0a20   // parse args. 
+00084ec0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00084ed0: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
+00084ee0: 203c 2032 202b 2047 474d 4c5f 4d41 585f   < 2 + GGML_MAX_
+00084ef0: 4f50 543b 202b 2b6a 2920 7b0a 2020 2020  OPT; ++j) {.    
+00084f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084f10: 636f 6e73 7420 696e 7433 325f 7420 6172  const int32_t ar
+00084f20: 675f 6964 7820 3d20 7074 725f 6172 675f  g_idx = ptr_arg_
+00084f30: 6964 785b 6a5d 3b0a 0a20 2020 2020 2020  idx[j];..       
+00084f40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00084f50: 2861 7267 5f69 6478 203d 3d20 2d31 2920  (arg_idx == -1) 
+00084f60: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00084f70: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00084f80: 7565 3b0a 2020 2020 2020 2020 2020 2020  ue;.            
+00084f90: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00084fa0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00084fb0: 6620 2861 7267 5f69 6478 203c 2047 474d  f (arg_idx < GGM
+00084fc0: 4c5f 4d41 585f 4e4f 4445 5329 207b 0a20  L_MAX_NODES) {. 
+00084fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084fe0: 2020 2020 2020 2061 7267 735b 6a5d 203d         args[j] =
+00084ff0: 2072 6573 756c 742e 6c65 6166 735b 6172   result.leafs[ar
+00085000: 675f 6964 785d 3b0a 2020 2020 2020 2020  g_idx];.        
+00085010: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00085020: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+00085030: 2020 2020 2020 2020 2020 2020 2061 7267               arg
+00085040: 735b 6a5d 203d 2072 6573 756c 742e 6e6f  s[j] = result.no
+00085050: 6465 735b 6172 675f 6964 7820 2d20 4747  des[arg_idx - GG
+00085060: 4d4c 5f4d 4158 5f4e 4f44 4553 5d3b 0a20  ML_MAX_NODES];. 
 00085070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085080: 636f 6e73 7420 696e 7433 325f 7420 6172  const int32_t ar
-00085090: 675f 6964 7820 3d20 7074 725f 6172 675f  g_idx = ptr_arg_
-000850a0: 6964 785b 6a5d 3b0a 0a20 2020 2020 2020  idx[j];..       
-000850b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000850c0: 2861 7267 5f69 6478 203d 3d20 2d31 2920  (arg_idx == -1) 
-000850d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000850e0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-000850f0: 7565 3b0a 2020 2020 2020 2020 2020 2020  ue;.            
-00085100: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00085110: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00085120: 6620 2861 7267 5f69 6478 203c 2047 474d  f (arg_idx < GGM
-00085130: 4c5f 4d41 585f 4e4f 4445 5329 207b 0a20  L_MAX_NODES) {. 
-00085140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085150: 2020 2020 2020 2061 7267 735b 6a5d 203d         args[j] =
-00085160: 2072 6573 756c 742e 6c65 6166 735b 6172   result.leafs[ar
-00085170: 675f 6964 785d 3b0a 2020 2020 2020 2020  g_idx];.        
-00085180: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-00085190: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
-000851a0: 2020 2020 2020 2020 2020 2020 2061 7267               arg
-000851b0: 735b 6a5d 203d 2072 6573 756c 742e 6e6f  s[j] = result.no
-000851c0: 6465 735b 6172 675f 6964 7820 2d20 4747  des[arg_idx - GG
-000851d0: 4d4c 5f4d 4158 5f4e 4f44 4553 5d3b 0a20  ML_MAX_NODES];. 
-000851e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000851f0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00085200: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00085210: 2020 2020 2020 2020 2f2f 2063 7265 6174          // creat
-00085220: 6520 7468 6520 7465 6e73 6f72 0a20 2020  e the tensor.   
-00085230: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00085240: 2276 6965 7722 206f 7065 7261 7469 6f6e  "view" operation
-00085250: 7320 6172 6520 6861 6e64 6c65 6420 6469  s are handled di
-00085260: 6666 6572 656e 746c 790a 2020 2020 2020  fferently.      
-00085270: 2020 2020 2020 2020 2020 2f2f 2054 4f44            // TOD
-00085280: 4f3a 2068 616e 646c 6520 696e 706c 6163  O: handle inplac
-00085290: 6520 6f70 7320 2d20 6375 7272 656e 746c  e ops - currentl
-000852a0: 7920 6120 636f 7079 2069 7320 616c 7761  y a copy is alwa
-000852b0: 7973 206d 6164 650a 0a20 2020 2020 2020  ys made..       
-000852c0: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
-000852d0: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
-000852e0: 6e73 6f72 203d 204e 554c 4c3b 0a0a 2020  nsor = NULL;..  
-000852f0: 2020 2020 2020 2020 2020 2020 2020 7377                sw
-00085300: 6974 6368 2028 656f 7029 207b 0a20 2020  itch (eop) {.   
-00085310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085320: 202f 2f20 544f 444f 3a20 696d 706c 656d   // TODO: implem
-00085330: 656e 7420 6f74 6865 7220 7669 6577 206f  ent other view o
-00085340: 7073 0a20 2020 2020 2020 2020 2020 2020  ps.             
-00085350: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00085360: 5f4f 505f 5245 5348 4150 453a 0a20 2020  _OP_RESHAPE:.   
-00085370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085380: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00085390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000853a0: 2020 2074 656e 736f 7220 3d20 6767 6d6c     tensor = ggml
-000853b0: 5f72 6573 6861 7065 5f34 6428 2a63 7478  _reshape_4d(*ctx
-000853c0: 5f65 7661 6c2c 2061 7267 735b 305d 2c20  _eval, args[0], 
-000853d0: 6e65 5b30 5d2c 206e 655b 315d 2c20 6e65  ne[0], ne[1], ne
-000853e0: 5b32 5d2c 206e 655b 335d 293b 0a20 2020  [2], ne[3]);.   
-000853f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085400: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00085080: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00085090: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000850a0: 2020 2020 2020 2020 2f2f 2063 7265 6174          // creat
+000850b0: 6520 7468 6520 7465 6e73 6f72 0a20 2020  e the tensor.   
+000850c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+000850d0: 2276 6965 7722 206f 7065 7261 7469 6f6e  "view" operation
+000850e0: 7320 6172 6520 6861 6e64 6c65 6420 6469  s are handled di
+000850f0: 6666 6572 656e 746c 790a 2020 2020 2020  fferently.      
+00085100: 2020 2020 2020 2020 2020 2f2f 2054 4f44            // TOD
+00085110: 4f3a 2068 616e 646c 6520 696e 706c 6163  O: handle inplac
+00085120: 6520 6f70 7320 2d20 6375 7272 656e 746c  e ops - currentl
+00085130: 7920 6120 636f 7079 2069 7320 616c 7761  y a copy is alwa
+00085140: 7973 206d 6164 650a 0a20 2020 2020 2020  ys made..       
+00085150: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+00085160: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
+00085170: 6e73 6f72 203d 204e 554c 4c3b 0a0a 2020  nsor = NULL;..  
+00085180: 2020 2020 2020 2020 2020 2020 2020 7377                sw
+00085190: 6974 6368 2028 656f 7029 207b 0a20 2020  itch (eop) {.   
+000851a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000851b0: 202f 2f20 544f 444f 3a20 696d 706c 656d   // TODO: implem
+000851c0: 656e 7420 6f74 6865 7220 7669 6577 206f  ent other view o
+000851d0: 7073 0a20 2020 2020 2020 2020 2020 2020  ps.             
+000851e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000851f0: 5f4f 505f 5245 5348 4150 453a 0a20 2020  _OP_RESHAPE:.   
+00085200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085210: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00085220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085230: 2020 2074 656e 736f 7220 3d20 6767 6d6c     tensor = ggml
+00085240: 5f72 6573 6861 7065 5f34 6428 2a63 7478  _reshape_4d(*ctx
+00085250: 5f65 7661 6c2c 2061 7267 735b 305d 2c20  _eval, args[0], 
+00085260: 6e65 5b30 5d2c 206e 655b 315d 2c20 6e65  ne[0], ne[1], ne
+00085270: 5b32 5d2c 206e 655b 335d 293b 0a20 2020  [2], ne[3]);.   
+00085280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085290: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000852a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000852b0: 2020 6361 7365 2047 474d 4c5f 4f50 5f56    case GGML_OP_V
+000852c0: 4945 573a 0a20 2020 2020 2020 2020 2020  IEW:.           
+000852d0: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+000852e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000852f0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+00085300: 7220 3d20 6767 6d6c 5f76 6965 775f 3464  r = ggml_view_4d
+00085310: 282a 6374 785f 6576 616c 2c20 6172 6773  (*ctx_eval, args
+00085320: 5b30 5d2c 206e 655b 305d 2c20 6e65 5b31  [0], ne[0], ne[1
+00085330: 5d2c 206e 655b 325d 2c20 6e65 5b33 5d2c  ], ne[2], ne[3],
+00085340: 2030 2c20 302c 2030 2c20 3029 3b0a 0a20   0, 0, 0, 0);.. 
+00085350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085360: 2020 2020 2020 2020 2020 2075 696e 7436             uint6
+00085370: 345f 7420 6f66 6673 3b0a 2020 2020 2020  4_t offs;.      
+00085380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085390: 2020 2020 2020 6d65 6d63 7079 2826 6f66        memcpy(&of
+000853a0: 6673 2c20 6172 6773 5b32 5d2d 3e64 6174  fs, args[2]->dat
+000853b0: 612c 2073 697a 656f 6628 6f66 6673 2929  a, sizeof(offs))
+000853c0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+000853d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000853e0: 656e 736f 722d 3e64 6174 6120 3d20 2828  ensor->data = ((
+000853f0: 6368 6172 202a 2920 7465 6e73 6f72 2d3e  char *) tensor->
+00085400: 6461 7461 2920 2b20 6f66 6673 3b0a 2020  data) + offs;.  
 00085410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085420: 2020 6361 7365 2047 474d 4c5f 4f50 5f56    case GGML_OP_V
-00085430: 4945 573a 0a20 2020 2020 2020 2020 2020  IEW:.           
-00085440: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00085450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085460: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-00085470: 7220 3d20 6767 6d6c 5f76 6965 775f 3464  r = ggml_view_4d
-00085480: 282a 6374 785f 6576 616c 2c20 6172 6773  (*ctx_eval, args
-00085490: 5b30 5d2c 206e 655b 305d 2c20 6e65 5b31  [0], ne[0], ne[1
-000854a0: 5d2c 206e 655b 325d 2c20 6e65 5b33 5d2c  ], ne[2], ne[3],
-000854b0: 2030 2c20 302c 2030 2c20 3029 3b0a 0a20   0, 0, 0, 0);.. 
+00085420: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00085430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085440: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00085450: 5452 414e 5350 4f53 453a 0a20 2020 2020  TRANSPOSE:.     
+00085460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085470: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00085480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085490: 2074 656e 736f 7220 3d20 6767 6d6c 5f74   tensor = ggml_t
+000854a0: 7261 6e73 706f 7365 282a 6374 785f 6576  ranspose(*ctx_ev
+000854b0: 616c 2c20 6172 6773 5b30 5d29 3b0a 2020  al, args[0]);.  
 000854c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000854d0: 2020 2020 2020 2020 2020 2075 696e 7436             uint6
-000854e0: 345f 7420 6f66 6673 3b0a 2020 2020 2020  4_t offs;.      
-000854f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085500: 2020 2020 2020 6d65 6d63 7079 2826 6f66        memcpy(&of
-00085510: 6673 2c20 6172 6773 5b32 5d2d 3e64 6174  fs, args[2]->dat
-00085520: 612c 2073 697a 656f 6628 6f66 6673 2929  a, sizeof(offs))
-00085530: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00085540: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00085550: 656e 736f 722d 3e64 6174 6120 3d20 2828  ensor->data = ((
-00085560: 6368 6172 202a 2920 7465 6e73 6f72 2d3e  char *) tensor->
-00085570: 6461 7461 2920 2b20 6f66 6673 3b0a 2020  data) + offs;.  
-00085580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085590: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000855a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000855b0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-000855c0: 5452 414e 5350 4f53 453a 0a20 2020 2020  TRANSPOSE:.     
+000854d0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+000854e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000854f0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00085500: 5045 524d 5554 453a 0a20 2020 2020 2020  PERMUTE:.       
+00085510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085520: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00085530: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00085540: 656e 736f 7220 3d20 6767 6d6c 5f76 6965  ensor = ggml_vie
+00085550: 775f 3464 282a 6374 785f 6576 616c 2c20  w_4d(*ctx_eval, 
+00085560: 6172 6773 5b30 5d2c 206e 655b 305d 2c20  args[0], ne[0], 
+00085570: 6e65 5b31 5d2c 206e 655b 325d 2c20 6e65  ne[1], ne[2], ne
+00085580: 5b33 5d2c 2030 2c20 302c 2030 2c20 3029  [3], 0, 0, 0, 0)
+00085590: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000855a0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+000855b0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+000855c0: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
 000855d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000855e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000855e0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
 000855f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085600: 2074 656e 736f 7220 3d20 6767 6d6c 5f74   tensor = ggml_t
-00085610: 7261 6e73 706f 7365 282a 6374 785f 6576  ranspose(*ctx_ev
-00085620: 616c 2c20 6172 6773 5b30 5d29 3b0a 2020  al, args[0]);.  
-00085630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085640: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00085600: 2020 2020 2020 7465 6e73 6f72 203d 2067        tensor = g
+00085610: 676d 6c5f 6e65 775f 7465 6e73 6f72 282a  gml_new_tensor(*
+00085620: 6374 785f 6576 616c 2c20 2865 6e75 6d20  ctx_eval, (enum 
+00085630: 6767 6d6c 5f74 7970 6529 2074 7970 652c  ggml_type) type,
+00085640: 206e 5f64 696d 732c 206e 6529 3b0a 0a20   n_dims, ne);.. 
 00085650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085660: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00085670: 5045 524d 5554 453a 0a20 2020 2020 2020  PERMUTE:.       
+00085660: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+00085670: 722d 3e6f 7020 3d20 656f 703b 0a20 2020  r->op = eop;.   
 00085680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085690: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000856a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000856b0: 656e 736f 7220 3d20 6767 6d6c 5f76 6965  ensor = ggml_vie
-000856c0: 775f 3464 282a 6374 785f 6576 616c 2c20  w_4d(*ctx_eval, 
-000856d0: 6172 6773 5b30 5d2c 206e 655b 305d 2c20  args[0], ne[0], 
-000856e0: 6e65 5b31 5d2c 206e 655b 325d 2c20 6e65  ne[1], ne[2], ne
-000856f0: 5b33 5d2c 2030 2c20 302c 2030 2c20 3029  [3], 0, 0, 0, 0)
-00085700: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00085710: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00085720: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-00085730: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
-00085740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085750: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00085760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085770: 2020 2020 2020 7465 6e73 6f72 203d 2067        tensor = g
-00085780: 676d 6c5f 6e65 775f 7465 6e73 6f72 282a  gml_new_tensor(*
-00085790: 6374 785f 6576 616c 2c20 2865 6e75 6d20  ctx_eval, (enum 
-000857a0: 6767 6d6c 5f74 7970 6529 2074 7970 652c  ggml_type) type,
-000857b0: 206e 5f64 696d 732c 206e 6529 3b0a 0a20   n_dims, ne);.. 
-000857c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000857d0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-000857e0: 722d 3e6f 7020 3d20 656f 703b 0a20 2020  r->op = eop;.   
-000857f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085800: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00085810: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00085820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00085830: 206d 656d 6370 7928 7465 6e73 6f72 2d3e   memcpy(tensor->
-00085840: 6e61 6d65 2c20 7074 725f 6e61 6d65 2c20  name, ptr_name, 
-00085850: 4747 4d4c 5f4d 4158 5f4e 414d 4529 3b0a  GGML_MAX_NAME);.
-00085860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00085870: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-00085880: 206a 203c 2047 474d 4c5f 4d41 585f 4449   j < GGML_MAX_DI
-00085890: 4d53 3b20 2b2b 6a29 207b 0a20 2020 2020  MS; ++j) {.     
-000858a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000858b0: 656e 736f 722d 3e6e 625b 6a5d 203d 206e  ensor->nb[j] = n
-000858c0: 625b 6a5d 3b0a 2020 2020 2020 2020 2020  b[j];.          
-000858d0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000858e0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
-000858f0: 3e73 7263 3020 3d20 6172 6773 5b30 5d3b  >src0 = args[0];
-00085900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00085910: 2074 656e 736f 722d 3e73 7263 3120 3d20   tensor->src1 = 
-00085920: 6172 6773 5b31 5d3b 0a0a 2020 2020 2020  args[1];..      
-00085930: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00085940: 6e74 206a 203d 2030 3b20 6a20 3c20 4747  nt j = 0; j < GG
-00085950: 4d4c 5f4d 4158 5f4f 5054 3b20 2b2b 6a29  ML_MAX_OPT; ++j)
-00085960: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00085970: 2020 2020 2020 2074 656e 736f 722d 3e6f         tensor->o
-00085980: 7074 5b6a 5d20 3d20 6172 6773 5b32 202b  pt[j] = args[2 +
-00085990: 206a 5d3b 0a20 2020 2020 2020 2020 2020   j];.           
-000859a0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-000859b0: 2020 2020 2020 2020 7265 7375 6c74 2e6e          result.n
-000859c0: 6f64 6573 5b69 5d20 3d20 7465 6e73 6f72  odes[i] = tensor
-000859d0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000859e0: 2020 2066 7072 696e 7466 2873 7464 6572     fprintf(stder
-000859f0: 722c 2022 2573 3a20 6c6f 6164 6564 206e  r, "%s: loaded n
-00085a00: 6f64 6520 2564 3a20 2725 3136 7327 2c20  ode %d: '%16s', 
-00085a10: 2533 6420 6469 6d73 2c20 2539 7a75 2062  %3d dims, %9zu b
-00085a20: 7974 6573 5c6e 222c 205f 5f66 756e 635f  ytes\n", __func_
-00085a30: 5f2c 2069 2c20 7465 6e73 6f72 2d3e 6e61  _, i, tensor->na
-00085a40: 6d65 2c20 6e5f 6469 6d73 2c20 6767 6d6c  me, n_dims, ggml
-00085a50: 5f6e 6279 7465 7328 7465 6e73 6f72 2929  _nbytes(tensor))
-00085a60: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00085a70: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00085a80: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-00085a90: 6c74 3b0a 7d0a 0a76 6f69 6420 6767 6d6c  lt;.}..void ggml
-00085aa0: 5f67 7261 7068 5f70 7269 6e74 2863 6f6e  _graph_print(con
-00085ab0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00085ac0: 6772 6170 6820 2a20 6367 7261 7068 2920  graph * cgraph) 
-00085ad0: 7b0a 2020 2020 696e 7436 345f 7420 7065  {.    int64_t pe
-00085ae0: 7266 5f74 6f74 616c 5f70 6572 5f6f 705f  rf_total_per_op_
-00085af0: 7573 5b47 474d 4c5f 4f50 5f43 4f55 4e54  us[GGML_OP_COUNT
-00085b00: 5d20 3d20 7b30 7d3b 0a0a 2020 2020 4747  ] = {0};..    GG
-00085b10: 4d4c 5f50 5249 4e54 2822 3d3d 3d20 4752  ML_PRINT("=== GR
-00085b20: 4150 4820 3d3d 3d5c 6e22 293b 0a0a 2020  APH ===\n");..  
-00085b30: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
-00085b40: 5547 2822 6e5f 7468 7265 6164 7320 2020  UG("n_threads   
-00085b50: 2020 2020 3d20 2564 5c6e 222c 2020 2020      = %d\n",    
-00085b60: 2020 2020 6367 7261 7068 2d3e 6e5f 7468      cgraph->n_th
-00085b70: 7265 6164 7329 3b0a 2020 2020 4747 4d4c  reads);.    GGML
-00085b80: 5f50 5249 4e54 5f44 4542 5547 2822 746f  _PRINT_DEBUG("to
-00085b90: 7461 6c20 776f 726b 2073 697a 6520 3d20  tal work size = 
-00085ba0: 257a 7520 6279 7465 735c 6e22 2c20 6367  %zu bytes\n", cg
-00085bb0: 7261 7068 2d3e 776f 726b 5f73 697a 6529  raph->work_size)
-00085bc0: 3b0a 0a20 2020 2047 474d 4c5f 5052 494e  ;..    GGML_PRIN
-00085bd0: 5428 226e 5f6e 6f64 6573 203d 2025 645c  T("n_nodes = %d\
-00085be0: 6e22 2c20 6367 7261 7068 2d3e 6e5f 6e6f  n", cgraph->n_no
-00085bf0: 6465 7329 3b0a 2020 2020 666f 7220 2869  des);.    for (i
-00085c00: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
-00085c10: 7261 7068 2d3e 6e5f 6e6f 6465 733b 2069  raph->n_nodes; i
-00085c20: 2b2b 2920 7b0a 2020 2020 2020 2020 7374  ++) {.        st
-00085c30: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00085c40: 202a 206e 6f64 6520 3d20 6367 7261 7068   * node = cgraph
-00085c50: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
-00085c60: 2020 2020 2070 6572 665f 746f 7461 6c5f       perf_total_
-00085c70: 7065 725f 6f70 5f75 735b 6e6f 6465 2d3e  per_op_us[node->
-00085c80: 6f70 5d20 2b3d 204d 4158 2831 2c20 6e6f  op] += MAX(1, no
-00085c90: 6465 2d3e 7065 7266 5f74 696d 655f 7573  de->perf_time_us
-00085ca0: 293b 0a0a 2020 2020 2020 2020 4747 4d4c  );..        GGML
-00085cb0: 5f50 5249 4e54 2822 202d 2025 3364 3a20  _PRINT(" - %3d: 
-00085cc0: 5b20 2535 2220 5052 4964 3634 2022 2c20  [ %5" PRId64 ", 
-00085cd0: 2535 2220 5052 4964 3634 2022 2c20 2535  %5" PRId64 ", %5
-00085ce0: 2220 5052 4964 3634 2022 5d20 2531 3673  " PRId64 "] %16s
-00085cf0: 2025 7320 2825 3364 2920 6370 7520 3d20   %s (%3d) cpu = 
-00085d00: 2537 2e33 6620 2f20 2537 2e33 6620 6d73  %7.3f / %7.3f ms
-00085d10: 2c20 7761 6c6c 203d 2025 372e 3366 202f  , wall = %7.3f /
-00085d20: 2025 372e 3366 206d 735c 6e22 2c0a 2020   %7.3f ms\n",.  
-00085d30: 2020 2020 2020 2020 2020 2020 2020 692c                i,
-00085d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00085d50: 206e 6f64 652d 3e6e 655b 305d 2c20 6e6f   node->ne[0], no
-00085d60: 6465 2d3e 6e65 5b31 5d2c 206e 6f64 652d  de->ne[1], node-
-00085d70: 3e6e 655b 325d 2c0a 2020 2020 2020 2020  >ne[2],.        
-00085d80: 2020 2020 2020 2020 4747 4d4c 5f4f 505f          GGML_OP_
-00085d90: 4e41 4d45 5b6e 6f64 652d 3e6f 705d 2c20  NAME[node->op], 
-00085da0: 6e6f 6465 2d3e 6973 5f70 6172 616d 203f  node->is_param ?
-00085db0: 2022 7822 203a 206e 6f64 652d 3e67 7261   "x" : node->gra
-00085dc0: 6420 3f20 2267 2220 3a20 2220 222c 206e  d ? "g" : " ", n
-00085dd0: 6f64 652d 3e70 6572 665f 7275 6e73 2c0a  ode->perf_runs,.
-00085de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085df0: 2864 6f75 626c 6529 206e 6f64 652d 3e70  (double) node->p
-00085e00: 6572 665f 6379 636c 6573 2020 2f20 2864  erf_cycles  / (d
-00085e10: 6f75 626c 6529 2067 676d 6c5f 6379 636c  ouble) ggml_cycl
-00085e20: 6573 5f70 6572 5f6d 7328 292c 0a20 2020  es_per_ms(),.   
-00085e30: 2020 2020 2020 2020 2020 2020 2028 646f               (do
-00085e40: 7562 6c65 2920 6e6f 6465 2d3e 7065 7266  uble) node->perf
-00085e50: 5f63 7963 6c65 7320 202f 2028 646f 7562  _cycles  / (doub
-00085e60: 6c65 2920 6767 6d6c 5f63 7963 6c65 735f  le) ggml_cycles_
-00085e70: 7065 725f 6d73 2829 202f 2028 646f 7562  per_ms() / (doub
-00085e80: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f72  le) node->perf_r
-00085e90: 756e 732c 0a20 2020 2020 2020 2020 2020  uns,.           
-00085ea0: 2020 2020 2028 646f 7562 6c65 2920 6e6f       (double) no
-00085eb0: 6465 2d3e 7065 7266 5f74 696d 655f 7573  de->perf_time_us
-00085ec0: 202f 2031 3030 302e 302c 0a20 2020 2020   / 1000.0,.     
-00085ed0: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
-00085ee0: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f74  le) node->perf_t
-00085ef0: 696d 655f 7573 202f 2031 3030 302e 3020  ime_us / 1000.0 
-00085f00: 2f20 6e6f 6465 2d3e 7065 7266 5f72 756e  / node->perf_run
-00085f10: 7329 3b0a 2020 2020 7d0a 0a20 2020 2047  s);.    }..    G
-00085f20: 474d 4c5f 5052 494e 5428 226e 5f6c 6561  GML_PRINT("n_lea
-00085f30: 6673 203d 2025 645c 6e22 2c20 6367 7261  fs = %d\n", cgra
-00085f40: 7068 2d3e 6e5f 6c65 6166 7329 3b0a 2020  ph->n_leafs);.  
-00085f50: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00085f60: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
-00085f70: 6c65 6166 733b 2069 2b2b 2920 7b0a 2020  leafs; i++) {.  
-00085f80: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00085f90: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
-00085fa0: 3d20 6367 7261 7068 2d3e 6c65 6166 735b  = cgraph->leafs[
-00085fb0: 695d 3b0a 0a20 2020 2020 2020 2047 474d  i];..        GGM
-00085fc0: 4c5f 5052 494e 5428 2220 2d20 2533 643a  L_PRINT(" - %3d:
-00085fd0: 205b 2025 3522 2050 5249 6436 3420 222c   [ %5" PRId64 ",
-00085fe0: 2025 3522 2050 5249 6436 3420 225d 2025   %5" PRId64 "] %
-00085ff0: 3873 5c6e 222c 0a20 2020 2020 2020 2020  8s\n",.         
-00086000: 2020 2020 2020 2069 2c0a 2020 2020 2020         i,.      
-00086010: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
-00086020: 6e65 5b30 5d2c 206e 6f64 652d 3e6e 655b  ne[0], node->ne[
-00086030: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-00086040: 2020 2020 4747 4d4c 5f4f 505f 4e41 4d45      GGML_OP_NAME
-00086050: 5b6e 6f64 652d 3e6f 705d 293b 0a20 2020  [node->op]);.   
-00086060: 207d 0a0a 2020 2020 666f 7220 2869 6e74   }..    for (int
-00086070: 2069 203d 2030 3b20 6920 3c20 4747 4d4c   i = 0; i < GGML
-00086080: 5f4f 505f 434f 554e 543b 2069 2b2b 2920  _OP_COUNT; i++) 
-00086090: 7b0a 2020 2020 2020 2020 6966 2028 7065  {.        if (pe
-000860a0: 7266 5f74 6f74 616c 5f70 6572 5f6f 705f  rf_total_per_op_
-000860b0: 7573 5b69 5d20 3d3d 2030 2920 7b0a 2020  us[i] == 0) {.  
-000860c0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-000860d0: 7565 3b0a 2020 2020 2020 2020 7d0a 0a20  ue;.        }.. 
-000860e0: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
-000860f0: 5428 2270 6572 665f 746f 7461 6c5f 7065  T("perf_total_pe
-00086100: 725f 6f70 5f75 735b 2531 3673 5d20 3d20  r_op_us[%16s] = 
-00086110: 2537 2e33 6620 6d73 5c6e 222c 2047 474d  %7.3f ms\n", GGM
-00086120: 4c5f 4f50 5f4e 414d 455b 695d 2c20 2864  L_OP_NAME[i], (d
-00086130: 6f75 626c 6529 2070 6572 665f 746f 7461  ouble) perf_tota
-00086140: 6c5f 7065 725f 6f70 5f75 735b 695d 202f  l_per_op_us[i] /
-00086150: 2031 3030 302e 3029 3b0a 2020 2020 7d0a   1000.0);.    }.
-00086160: 0a20 2020 2047 474d 4c5f 5052 494e 5428  .    GGML_PRINT(
-00086170: 223d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  "===============
-00086180: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00086190: 3d3d 3d3d 3d3d 3d3d 3d5c 6e22 293b 0a7d  =========\n");.}
-000861a0: 0a0a 2f2f 2063 6865 636b 2069 6620 6e6f  ..// check if no
-000861b0: 6465 2069 7320 7061 7274 206f 6620 7468  de is part of th
-000861c0: 6520 6772 6170 680a 7374 6174 6963 2062  e graph.static b
-000861d0: 6f6f 6c20 6767 6d6c 5f67 7261 7068 5f66  ool ggml_graph_f
-000861e0: 696e 6428 636f 6e73 7420 7374 7275 6374  ind(const struct
-000861f0: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
-00086200: 6772 6170 682c 2063 6f6e 7374 2073 7472  graph, const str
-00086210: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00086220: 2a20 6e6f 6465 2920 7b0a 2020 2020 6966  * node) {.    if
-00086230: 2028 6367 7261 7068 203d 3d20 4e55 4c4c   (cgraph == NULL
-00086240: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-00086250: 726e 2074 7275 653b 0a20 2020 207d 0a0a  rn true;.    }..
-00086260: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00086270: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
-00086280: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
-00086290: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
-000862a0: 7068 2d3e 6e6f 6465 735b 695d 203d 3d20  ph->nodes[i] == 
-000862b0: 6e6f 6465 2920 7b0a 2020 2020 2020 2020  node) {.        
-000862c0: 2020 2020 7265 7475 726e 2074 7275 653b      return true;
-000862d0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-000862e0: 0a0a 2020 2020 7265 7475 726e 2066 616c  ..    return fal
-000862f0: 7365 3b0a 7d0a 0a73 7461 7469 6320 7374  se;.}..static st
-00086300: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00086310: 202a 2067 676d 6c5f 6772 6170 685f 6765   * ggml_graph_ge
-00086320: 745f 7061 7265 6e74 2863 6f6e 7374 2073  t_parent(const s
-00086330: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-00086340: 6820 2a20 6367 7261 7068 2c20 636f 6e73  h * cgraph, cons
-00086350: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00086360: 6e73 6f72 202a 206e 6f64 6529 207b 0a20  nsor * node) {. 
-00086370: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00086380: 303b 2069 203c 2063 6772 6170 682d 3e6e  0; i < cgraph->n
-00086390: 5f6e 6f64 6573 3b20 692b 2b29 207b 0a20  _nodes; i++) {. 
-000863a0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000863b0: 6d6c 5f74 656e 736f 7220 2a20 7061 7265  ml_tensor * pare
-000863c0: 6e74 203d 2063 6772 6170 682d 3e6e 6f64  nt = cgraph->nod
-000863d0: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
-000863e0: 6966 2028 7061 7265 6e74 2d3e 6772 6164  if (parent->grad
-000863f0: 203d 3d20 6e6f 6465 2920 7b0a 2020 2020   == node) {.    
-00086400: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-00086410: 6172 656e 743b 0a20 2020 2020 2020 207d  arent;.        }
-00086420: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
-00086430: 726e 204e 554c 4c3b 0a7d 0a0a 766f 6964  rn NULL;.}..void
-00086440: 2067 676d 6c5f 6772 6170 685f 6475 6d70   ggml_graph_dump
-00086450: 5f64 6f74 2863 6f6e 7374 2073 7472 7563  _dot(const struc
-00086460: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-00086470: 6762 2c20 636f 6e73 7420 7374 7275 6374  gb, const struct
-00086480: 2067 676d 6c5f 6367 7261 7068 202a 2067   ggml_cgraph * g
-00086490: 662c 2063 6f6e 7374 2063 6861 7220 2a20  f, const char * 
-000864a0: 6669 6c65 6e61 6d65 2920 7b0a 2020 2020  filename) {.    
-000864b0: 6368 6172 2063 6f6c 6f72 5b31 365d 3b0a  char color[16];.
-000864c0: 0a20 2020 2046 494c 4520 2a20 6670 203d  .    FILE * fp =
-000864d0: 2066 6f70 656e 2866 696c 656e 616d 652c   fopen(filename,
-000864e0: 2022 7722 293b 0a20 2020 2047 474d 4c5f   "w");.    GGML_
-000864f0: 4153 5345 5254 2866 7029 3b0a 0a20 2020  ASSERT(fp);..   
-00086500: 2066 7072 696e 7466 2866 702c 2022 6469   fprintf(fp, "di
-00086510: 6772 6170 6820 4720 7b5c 6e22 293b 0a20  graph G {\n");. 
-00086520: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
-00086530: 2020 6e65 7772 616e 6b20 3d20 7472 7565    newrank = true
-00086540: 3b5c 6e22 293b 0a20 2020 2066 7072 696e  ;\n");.    fprin
-00086550: 7466 2866 702c 2022 2020 7261 6e6b 6469  tf(fp, "  rankdi
-00086560: 7220 3d20 4c52 3b5c 6e22 293b 0a0a 2020  r = LR;\n");..  
-00086570: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00086580: 3b20 6920 3c20 6762 2d3e 6e5f 6e6f 6465  ; i < gb->n_node
-00086590: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-000865a0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000865b0: 6e73 6f72 202a 206e 6f64 6520 3d20 6762  nsor * node = gb
-000865c0: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
-000865d0: 2020 2020 2069 6620 2867 676d 6c5f 6772       if (ggml_gr
-000865e0: 6170 685f 6765 745f 7061 7265 6e74 2867  aph_get_parent(g
-000865f0: 622c 206e 6f64 6529 2021 3d20 4e55 4c4c  b, node) != NULL
-00086600: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00086610: 636f 6e74 696e 7565 3b0a 2020 2020 2020  continue;.      
-00086620: 2020 7d0a 0a20 2020 2020 2020 2069 6620    }..        if 
-00086630: 286e 6f64 652d 3e69 735f 7061 7261 6d29  (node->is_param)
-00086640: 207b 0a20 2020 2020 2020 2020 2020 2073   {.            s
-00086650: 6e70 7269 6e74 6628 636f 6c6f 722c 2073  nprintf(color, s
-00086660: 697a 656f 6628 636f 6c6f 7229 2c20 2279  izeof(color), "y
-00086670: 656c 6c6f 7722 293b 0a20 2020 2020 2020  ellow");.       
-00086680: 207d 2065 6c73 6520 6966 2028 6e6f 6465   } else if (node
-00086690: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-000866a0: 2020 2020 2020 6966 2028 6767 6d6c 5f67        if (ggml_g
-000866b0: 7261 7068 5f66 696e 6428 6766 2c20 6e6f  raph_find(gf, no
-000866c0: 6465 2929 207b 0a20 2020 2020 2020 2020  de)) {.         
-000866d0: 2020 2020 2020 2073 6e70 7269 6e74 6628         snprintf(
-000866e0: 636f 6c6f 722c 2073 697a 656f 6628 636f  color, sizeof(co
-000866f0: 6c6f 7229 2c20 2267 7265 656e 2229 3b0a  lor), "green");.
-00086700: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-00086710: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
-00086720: 2020 2020 2073 6e70 7269 6e74 6628 636f       snprintf(co
-00086730: 6c6f 722c 2073 697a 656f 6628 636f 6c6f  lor, sizeof(colo
-00086740: 7229 2c20 226c 6967 6874 626c 7565 2229  r), "lightblue")
-00086750: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00086760: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
-00086770: 0a20 2020 2020 2020 2020 2020 2073 6e70  .            snp
-00086780: 7269 6e74 6628 636f 6c6f 722c 2073 697a  rintf(color, siz
-00086790: 656f 6628 636f 6c6f 7229 2c20 2277 6869  eof(color), "whi
-000867a0: 7465 2229 3b0a 2020 2020 2020 2020 7d0a  te");.        }.
-000867b0: 0a20 2020 2020 2020 2066 7072 696e 7466  .        fprintf
-000867c0: 2866 702c 2022 2020 5c22 2570 5c22 205b  (fp, "  \"%p\" [
-000867d0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-000867e0: 2020 2020 2020 2022 7374 796c 6520 3d20         "style = 
-000867f0: 6669 6c6c 6564 3b20 6669 6c6c 636f 6c6f  filled; fillcolo
-00086800: 7220 3d20 2573 3b20 7368 6170 6520 3d20  r = %s; shape = 
-00086810: 7265 636f 7264 3b20 220a 2020 2020 2020  record; ".      
-00086820: 2020 2020 2020 2020 2020 2020 2020 226c                "l
-00086830: 6162 656c 3d5c 2222 2c0a 2020 2020 2020  abel=\"",.      
-00086840: 2020 2020 2020 2020 2020 2876 6f69 6420            (void 
-00086850: 2a29 206e 6f64 652c 2063 6f6c 6f72 293b  *) node, color);
-00086860: 0a0a 2020 2020 2020 2020 6966 2028 7374  ..        if (st
-00086870: 726c 656e 286e 6f64 652d 3e6e 616d 6529  rlen(node->name)
-00086880: 203e 2030 2920 7b0a 2020 2020 2020 2020   > 0) {.        
-00086890: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
-000868a0: 2225 7320 7c22 2c20 6e6f 6465 2d3e 6e61  "%s |", node->na
-000868b0: 6d65 293b 0a20 2020 2020 2020 207d 0a0a  me);.        }..
-000868c0: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-000868d0: 2d3e 6e5f 6469 6d73 203d 3d20 3229 207b  ->n_dims == 2) {
-000868e0: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
-000868f0: 696e 7466 2866 702c 2022 2564 205b 2522  intf(fp, "%d [%"
-00086900: 2050 5249 6436 3420 222c 2025 2220 5052   PRId64 ", %" PR
-00086910: 4964 3634 2022 5d20 7c20 3c78 3e25 7322  Id64 "] | <x>%s"
-00086920: 2c20 692c 206e 6f64 652d 3e6e 655b 305d  , i, node->ne[0]
-00086930: 2c20 6e6f 6465 2d3e 6e65 5b31 5d2c 2047  , node->ne[1], G
-00086940: 474d 4c5f 4f50 5f53 594d 424f 4c5b 6e6f  GML_OP_SYMBOL[no
-00086950: 6465 2d3e 6f70 5d29 3b0a 2020 2020 2020  de->op]);.      
-00086960: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-00086970: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
-00086980: 702c 2022 2564 205b 2522 2050 5249 6436  p, "%d [%" PRId6
-00086990: 3420 222c 2025 2220 5052 4964 3634 2022  4 ", %" PRId64 "
-000869a0: 2c20 2522 2050 5249 6436 3420 225d 207c  , %" PRId64 "] |
-000869b0: 203c 783e 2573 222c 2069 2c20 6e6f 6465   <x>%s", i, node
-000869c0: 2d3e 6e65 5b30 5d2c 206e 6f64 652d 3e6e  ->ne[0], node->n
-000869d0: 655b 315d 2c20 6e6f 6465 2d3e 6e65 5b32  e[1], node->ne[2
-000869e0: 5d2c 2047 474d 4c5f 4f50 5f53 594d 424f  ], GGML_OP_SYMBO
-000869f0: 4c5b 6e6f 6465 2d3e 6f70 5d29 3b0a 2020  L[node->op]);.  
-00086a00: 2020 2020 2020 7d0a 0a0a 2020 2020 2020        }...      
-00086a10: 2020 6966 2028 6e6f 6465 2d3e 6772 6164    if (node->grad
-00086a20: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00086a30: 6670 7269 6e74 6628 6670 2c20 2220 7c20  fprintf(fp, " | 
-00086a40: 3c67 3e25 735c 223b 205d 5c6e 222c 2047  <g>%s\"; ]\n", G
-00086a50: 474d 4c5f 4f50 5f53 594d 424f 4c5b 6e6f  GML_OP_SYMBOL[no
-00086a60: 6465 2d3e 6772 6164 2d3e 6f70 5d29 3b0a  de->grad->op]);.
-00086a70: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
-00086a80: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
-00086a90: 696e 7466 2866 702c 2022 5c22 3b20 5d5c  intf(fp, "\"; ]\
-00086aa0: 6e22 293b 0a20 2020 2020 2020 207d 0a20  n");.        }. 
-00086ab0: 2020 207d 0a0a 2020 2020 666f 7220 2869     }..    for (i
-00086ac0: 6e74 2069 203d 2030 3b20 6920 3c20 6762  nt i = 0; i < gb
-00086ad0: 2d3e 6e5f 6c65 6166 733b 2069 2b2b 2920  ->n_leafs; i++) 
-00086ae0: 7b0a 2020 2020 2020 2020 7374 7275 6374  {.        struct
-00086af0: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
-00086b00: 6f64 6520 3d20 6762 2d3e 6c65 6166 735b  ode = gb->leafs[
-00086b10: 695d 3b0a 0a20 2020 2020 2020 2073 6e70  i];..        snp
-00086b20: 7269 6e74 6628 636f 6c6f 722c 2073 697a  rintf(color, siz
-00086b30: 656f 6628 636f 6c6f 7229 2c20 2270 696e  eof(color), "pin
-00086b40: 6b22 293b 0a0a 2020 2020 2020 2020 6670  k");..        fp
-00086b50: 7269 6e74 6628 6670 2c20 2220 205c 2225  rintf(fp, "  \"%
-00086b60: 705c 2220 5b20 220a 2020 2020 2020 2020  p\" [ ".        
-00086b70: 2020 2020 2020 2020 2020 2020 2273 7479              "sty
-00086b80: 6c65 203d 2066 696c 6c65 643b 2066 696c  le = filled; fil
-00086b90: 6c63 6f6c 6f72 203d 2025 733b 2073 6861  lcolor = %s; sha
-00086ba0: 7065 203d 2072 6563 6f72 643b 2022 0a20  pe = record; ". 
-00086bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086bc0: 2020 2022 6c61 6265 6c3d 5c22 3c78 3e22     "label=\"<x>"
-00086bd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00086be0: 2020 2876 6f69 6420 2a29 206e 6f64 652c    (void *) node,
-00086bf0: 2063 6f6c 6f72 293b 0a0a 2020 2020 2020   color);..      
-00086c00: 2020 6966 2028 7374 726c 656e 286e 6f64    if (strlen(nod
-00086c10: 652d 3e6e 616d 6529 203e 2030 2920 7b0a  e->name) > 0) {.
-00086c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00086c30: 6670 7269 6e74 6628 6670 2c20 2225 7320  fprintf(fp, "%s 
-00086c40: 7c20 222c 206e 6f64 652d 3e6e 616d 6529  | ", node->name)
-00086c50: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-00086c60: 2020 2020 6966 2028 6767 6d6c 5f6e 656c      if (ggml_nel
-00086c70: 656d 656e 7473 286e 6f64 6529 203d 3d20  ements(node) == 
-00086c80: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-00086c90: 2069 6620 286e 6f64 652d 3e74 7970 6520   if (node->type 
-00086ca0: 3d3d 2047 474d 4c5f 5459 5045 5f49 3820  == GGML_TYPE_I8 
-00086cb0: 7c7c 206e 6f64 652d 3e74 7970 6520 3d3d  || node->type ==
-00086cc0: 2047 474d 4c5f 5459 5045 5f49 3136 207c   GGML_TYPE_I16 |
-00086cd0: 7c20 6e6f 6465 2d3e 7479 7065 203d 3d20  | node->type == 
-00086ce0: 4747 4d4c 5f54 5950 455f 4933 3229 207b  GGML_TYPE_I32) {
-00086cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00086d00: 2066 7072 696e 7466 2866 702c 2022 2564   fprintf(fp, "%d
-00086d10: 222c 2067 676d 6c5f 6765 745f 6933 325f  ", ggml_get_i32_
-00086d20: 3164 286e 6f64 652c 2030 2929 3b0a 2020  1d(node, 0));.  
-00086d30: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00086d40: 2020 2020 2020 2020 656c 7365 207b 0a20          else {. 
-00086d50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00086d60: 7072 696e 7466 2866 702c 2022 252e 3165  printf(fp, "%.1e
-00086d70: 222c 2028 646f 7562 6c65 2967 676d 6c5f  ", (double)ggml_
-00086d80: 6765 745f 6633 325f 3164 286e 6f64 652c  get_f32_1d(node,
-00086d90: 2030 2929 3b0a 2020 2020 2020 2020 2020   0));.          
-00086da0: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
-00086db0: 2020 2020 2020 656c 7365 207b 0a20 2020        else {.   
-00086dc0: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
-00086dd0: 2866 702c 2022 434f 4e53 5420 2564 205b  (fp, "CONST %d [
-00086de0: 2522 2050 5249 6436 3420 222c 2025 2220  %" PRId64 ", %" 
-00086df0: 5052 4964 3634 2022 5d22 2c20 692c 206e  PRId64 "]", i, n
-00086e00: 6f64 652d 3e6e 655b 305d 2c20 6e6f 6465  ode->ne[0], node
-00086e10: 2d3e 6e65 5b31 5d29 3b0a 2020 2020 2020  ->ne[1]);.      
-00086e20: 2020 7d0a 2020 2020 2020 2020 6670 7269    }.        fpri
-00086e30: 6e74 6628 6670 2c20 225c 223b 205d 5c6e  ntf(fp, "\"; ]\n
-00086e40: 2229 3b0a 2020 2020 7d0a 0a20 2020 2066  ");.    }..    f
-00086e50: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00086e60: 203c 2067 622d 3e6e 5f6e 6f64 6573 3b20   < gb->n_nodes; 
-00086e70: 692b 2b29 207b 0a20 2020 2020 2020 2073  i++) {.        s
-00086e80: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00086e90: 7220 2a20 6e6f 6465 203d 2067 622d 3e6e  r * node = gb->n
-00086ea0: 6f64 6573 5b69 5d3b 0a0a 2020 2020 2020  odes[i];..      
-00086eb0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00086ec0: 6e73 6f72 202a 2070 6172 656e 7420 3d20  nsor * parent = 
-00086ed0: 6767 6d6c 5f67 7261 7068 5f67 6574 5f70  ggml_graph_get_p
-00086ee0: 6172 656e 7428 6762 2c20 6e6f 6465 293b  arent(gb, node);
-00086ef0: 0a0a 2020 2020 2020 2020 6966 2028 6e6f  ..        if (no
-00086f00: 6465 2d3e 7372 6330 2920 7b0a 2020 2020  de->src0) {.    
-00086f10: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00086f20: 676d 6c5f 7465 6e73 6f72 202a 2070 6172  gml_tensor * par
-00086f30: 656e 7430 203d 2067 676d 6c5f 6772 6170  ent0 = ggml_grap
-00086f40: 685f 6765 745f 7061 7265 6e74 2867 622c  h_get_parent(gb,
-00086f50: 206e 6f64 652d 3e73 7263 3029 3b0a 0a20   node->src0);.. 
-00086f60: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-00086f70: 7466 2866 702c 2022 2020 5c22 2570 5c22  tf(fp, "  \"%p\"
-00086f80: 3a25 7320 2d3e 205c 2225 705c 223a 2573  :%s -> \"%p\":%s
-00086f90: 205b 2061 7272 6f77 6865 6164 203d 2025   [ arrowhead = %
-00086fa0: 733b 2073 7479 6c65 203d 2025 733b 206c  s; style = %s; l
-00086fb0: 6162 656c 203d 205c 2278 5c22 3b20 5d5c  abel = \"x\"; ]\
-00086fc0: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-00086fd0: 2020 2020 2020 2020 7061 7265 6e74 3020          parent0 
-00086fe0: 3f20 2876 6f69 6420 2a29 2070 6172 656e  ? (void *) paren
-00086ff0: 7430 203a 2028 766f 6964 202a 2920 6e6f  t0 : (void *) no
-00087000: 6465 2d3e 7372 6330 2c0a 2020 2020 2020  de->src0,.      
-00087010: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00087020: 7265 6e74 3020 3f20 2267 2220 3a20 2278  rent0 ? "g" : "x
-00087030: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00087040: 2020 2020 2020 2070 6172 656e 7420 3f20         parent ? 
-00087050: 2876 6f69 6420 2a29 2070 6172 656e 7420  (void *) parent 
-00087060: 3a20 2876 6f69 6420 2a29 206e 6f64 652c  : (void *) node,
-00087070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00087080: 2020 2020 2070 6172 656e 7420 3f20 2267       parent ? "g
-00087090: 2220 3a20 2278 222c 0a20 2020 2020 2020  " : "x",.       
-000870a0: 2020 2020 2020 2020 2020 2020 2070 6172               par
-000870b0: 656e 7420 3f20 2265 6d70 7479 2220 3a20  ent ? "empty" : 
-000870c0: 2276 6565 222c 0a20 2020 2020 2020 2020  "vee",.         
-000870d0: 2020 2020 2020 2020 2020 2070 6172 656e             paren
-000870e0: 7420 3f20 2264 6173 6865 6422 203a 2022  t ? "dashed" : "
-000870f0: 736f 6c69 6422 293b 0a20 2020 2020 2020  solid");.       
-00087100: 207d 0a0a 2020 2020 2020 2020 6966 2028   }..        if (
-00087110: 6e6f 6465 2d3e 7372 6331 2920 7b0a 2020  node->src1) {.  
-00087120: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-00087130: 2067 676d 6c5f 7465 6e73 6f72 202a 2070   ggml_tensor * p
-00087140: 6172 656e 7431 203d 2067 676d 6c5f 6772  arent1 = ggml_gr
-00087150: 6170 685f 6765 745f 7061 7265 6e74 2867  aph_get_parent(g
-00087160: 622c 206e 6f64 652d 3e73 7263 3129 3b0a  b, node->src1);.
-00087170: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
-00087180: 696e 7466 2866 702c 2022 2020 5c22 2570  intf(fp, "  \"%p
-00087190: 5c22 3a25 7320 2d3e 205c 2225 705c 223a  \":%s -> \"%p\":
-000871a0: 2573 205b 2061 7272 6f77 6865 6164 203d  %s [ arrowhead =
-000871b0: 2025 733b 2073 7479 6c65 203d 2025 733b   %s; style = %s;
-000871c0: 206c 6162 656c 203d 205c 2279 5c22 3b20   label = \"y\"; 
-000871d0: 5d5c 6e22 2c0a 2020 2020 2020 2020 2020  ]\n",.          
-000871e0: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
-000871f0: 3120 3f20 2876 6f69 6420 2a29 2070 6172  1 ? (void *) par
-00087200: 656e 7431 203a 2028 766f 6964 202a 2920  ent1 : (void *) 
-00087210: 6e6f 6465 2d3e 7372 6331 2c0a 2020 2020  node->src1,.    
-00087220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087230: 7061 7265 6e74 3120 3f20 2267 2220 3a20  parent1 ? "g" : 
-00087240: 2278 222c 0a20 2020 2020 2020 2020 2020  "x",.           
-00087250: 2020 2020 2020 2020 2070 6172 656e 7420           parent 
-00087260: 3f20 2876 6f69 6420 2a29 2070 6172 656e  ? (void *) paren
-00087270: 7420 3a20 2876 6f69 6420 2a29 206e 6f64  t : (void *) nod
-00087280: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00087290: 2020 2020 2020 2070 6172 656e 7420 3f20         parent ? 
-000872a0: 2267 2220 3a20 2278 222c 0a20 2020 2020  "g" : "x",.     
-000872b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000872c0: 6172 656e 7420 3f20 2265 6d70 7479 2220  arent ? "empty" 
-000872d0: 3a20 2276 6565 222c 0a20 2020 2020 2020  : "vee",.       
-000872e0: 2020 2020 2020 2020 2020 2020 2070 6172               par
-000872f0: 656e 7420 3f20 2264 6173 6865 6422 203a  ent ? "dashed" :
-00087300: 2022 736f 6c69 6422 293b 0a20 2020 2020   "solid");.     
-00087310: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
-00087320: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00087330: 6920 3c20 6762 2d3e 6e5f 6c65 6166 733b  i < gb->n_leafs;
-00087340: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-00087350: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00087360: 6f72 202a 206e 6f64 6520 3d20 6762 2d3e  or * node = gb->
-00087370: 6c65 6166 735b 695d 3b0a 0a20 2020 2020  leafs[i];..     
-00087380: 2020 2069 6620 286e 6f64 652d 3e73 7263     if (node->src
-00087390: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
-000873a0: 2066 7072 696e 7466 2866 702c 2022 2020   fprintf(fp, "  
-000873b0: 5c22 2570 5c22 3a25 7320 2d3e 205c 2225  \"%p\":%s -> \"%
-000873c0: 705c 223a 2573 205b 206c 6162 656c 203d  p\":%s [ label =
-000873d0: 205c 2278 5c22 3b20 5d5c 6e22 2c0a 2020   \"x\"; ]\n",.  
-000873e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000873f0: 2020 2876 6f69 6420 2a29 206e 6f64 652d    (void *) node-
-00087400: 3e73 7263 302c 2022 7822 2c0a 2020 2020  >src0, "x",.    
-00087410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087420: 2876 6f69 6420 2a29 206e 6f64 652c 2022  (void *) node, "
-00087430: 7822 293b 0a20 2020 2020 2020 207d 0a0a  x");.        }..
-00087440: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-00087450: 2d3e 7372 6331 2920 7b0a 2020 2020 2020  ->src1) {.      
-00087460: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
-00087470: 2c20 2220 205c 2225 705c 223a 2573 202d  , "  \"%p\":%s -
-00087480: 3e20 5c22 2570 5c22 3a25 7320 5b20 6c61  > \"%p\":%s [ la
-00087490: 6265 6c20 3d20 5c22 795c 223b 205d 5c6e  bel = \"y\"; ]\n
-000874a0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-000874b0: 2020 2020 2020 2028 766f 6964 202a 2920         (void *) 
-000874c0: 6e6f 6465 2d3e 7372 6331 2c20 2278 222c  node->src1, "x",
-000874d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000874e0: 2020 2020 2028 766f 6964 202a 2920 6e6f       (void *) no
-000874f0: 6465 2c20 2278 2229 3b0a 2020 2020 2020  de, "x");.      
-00087500: 2020 7d0a 2020 2020 7d0a 0a20 2020 2066    }.    }..    f
-00087510: 7072 696e 7466 2866 702c 2022 7d5c 6e22  printf(fp, "}\n"
-00087520: 293b 0a0a 2020 2020 6663 6c6f 7365 2866  );..    fclose(f
-00087530: 7029 3b0a 0a20 2020 2047 474d 4c5f 5052  p);..    GGML_PR
-00087540: 494e 5428 2225 733a 2064 6f74 202d 5470  INT("%s: dot -Tp
-00087550: 6e67 2025 7320 2d6f 2025 732e 706e 6720  ng %s -o %s.png 
-00087560: 2626 206f 7065 6e20 2573 2e70 6e67 5c6e  && open %s.png\n
-00087570: 222c 205f 5f66 756e 635f 5f2c 2066 696c  ", __func__, fil
-00087580: 656e 616d 652c 2066 696c 656e 616d 652c  ename, filename,
-00087590: 2066 696c 656e 616d 6529 3b0a 7d0a 0a2f   filename);.}../
-000875a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000875b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000875c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000875d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000875e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
-000875f0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00087600: 6c5f 6f70 745f 7365 745f 7061 7261 6d73  l_opt_set_params
-00087610: 2869 6e74 206e 702c 2073 7472 7563 7420  (int np, struct 
-00087620: 6767 6d6c 5f74 656e 736f 7220 2a20 636f  ggml_tensor * co
-00087630: 6e73 7420 7073 5b5d 2c20 636f 6e73 7420  nst ps[], const 
-00087640: 666c 6f61 7420 2a20 7829 207b 0a20 2020  float * x) {.   
-00087650: 2069 6e74 2069 203d 2030 3b0a 2020 2020   int i = 0;.    
-00087660: 666f 7220 2869 6e74 2070 203d 2030 3b20  for (int p = 0; 
-00087670: 7020 3c20 6e70 3b20 2b2b 7029 207b 0a20  p < np; ++p) {. 
-00087680: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00087690: 3634 5f74 206e 6520 3d20 6767 6d6c 5f6e  64_t ne = ggml_n
-000876a0: 656c 656d 656e 7473 2870 735b 705d 2920  elements(ps[p]) 
-000876b0: 3b0a 2020 2020 2020 2020 2f2f 2054 4f44  ;.        // TOD
-000876c0: 4f3a 2061 6464 2066 756e 6374 696f 6e20  O: add function 
-000876d0: 746f 2073 6574 2074 656e 736f 7220 6672  to set tensor fr
-000876e0: 6f6d 2061 7272 6179 0a20 2020 2020 2020  om array.       
-000876f0: 2066 6f72 2028 696e 7436 345f 7420 6a20   for (int64_t j 
-00087700: 3d20 303b 206a 203c 206e 653b 202b 2b6a  = 0; j < ne; ++j
-00087710: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00087720: 6767 6d6c 5f73 6574 5f66 3332 5f31 6428  ggml_set_f32_1d(
-00087730: 7073 5b70 5d2c 206a 2c20 785b 692b 2b5d  ps[p], j, x[i++]
-00087740: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
-00087750: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
-00087760: 6420 6767 6d6c 5f6f 7074 5f67 6574 5f70  d ggml_opt_get_p
-00087770: 6172 616d 7328 696e 7420 6e70 2c20 7374  arams(int np, st
-00087780: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00087790: 202a 2063 6f6e 7374 2070 735b 5d2c 2066   * const ps[], f
-000877a0: 6c6f 6174 202a 2078 2920 7b0a 2020 2020  loat * x) {.    
-000877b0: 696e 7420 6920 3d20 303b 0a20 2020 2066  int i = 0;.    f
-000877c0: 6f72 2028 696e 7420 7020 3d20 303b 2070  or (int p = 0; p
-000877d0: 203c 206e 703b 202b 2b70 2920 7b0a 2020   < np; ++p) {.  
-000877e0: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
-000877f0: 345f 7420 6e65 203d 2067 676d 6c5f 6e65  4_t ne = ggml_ne
-00087800: 6c65 6d65 6e74 7328 7073 5b70 5d29 203b  lements(ps[p]) ;
-00087810: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
-00087820: 3a20 6164 6420 6675 6e63 7469 6f6e 2074  : add function t
-00087830: 6f20 6765 7420 616c 6c20 656c 656d 656e  o get all elemen
-00087840: 7473 2061 7420 6f6e 6365 0a20 2020 2020  ts at once.     
-00087850: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-00087860: 6a20 3d20 303b 206a 203c 206e 653b 202b  j = 0; j < ne; +
-00087870: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
-00087880: 2020 785b 692b 2b5d 203d 2067 676d 6c5f    x[i++] = ggml_
-00087890: 6765 745f 6633 325f 3164 2870 735b 705d  get_f32_1d(ps[p]
-000878a0: 2c20 6a29 3b0a 2020 2020 2020 2020 7d0a  , j);.        }.
-000878b0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-000878c0: 766f 6964 2067 676d 6c5f 6f70 745f 6765  void ggml_opt_ge
-000878d0: 745f 6772 6164 2869 6e74 206e 702c 2073  t_grad(int np, s
-000878e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000878f0: 7220 2a20 636f 6e73 7420 7073 5b5d 2c20  r * const ps[], 
-00087900: 666c 6f61 7420 2a20 6729 207b 0a20 2020  float * g) {.   
-00087910: 2069 6e74 2069 203d 2030 3b0a 2020 2020   int i = 0;.    
-00087920: 666f 7220 2869 6e74 2070 203d 2030 3b20  for (int p = 0; 
-00087930: 7020 3c20 6e70 3b20 2b2b 7029 207b 0a20  p < np; ++p) {. 
-00087940: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00087950: 3634 5f74 206e 6520 3d20 6767 6d6c 5f6e  64_t ne = ggml_n
-00087960: 656c 656d 656e 7473 2870 735b 705d 2920  elements(ps[p]) 
-00087970: 3b0a 2020 2020 2020 2020 2f2f 2054 4f44  ;.        // TOD
-00087980: 4f3a 2061 6464 2066 756e 6374 696f 6e20  O: add function 
-00087990: 746f 2067 6574 2061 6c6c 2065 6c65 6d65  to get all eleme
-000879a0: 6e74 7320 6174 206f 6e63 650a 2020 2020  nts at once.    
-000879b0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-000879c0: 206a 203d 2030 3b20 6a20 3c20 6e65 3b20   j = 0; j < ne; 
-000879d0: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
-000879e0: 2020 2067 5b69 2b2b 5d20 3d20 6767 6d6c     g[i++] = ggml
-000879f0: 5f67 6574 5f66 3332 5f31 6428 7073 5b70  _get_f32_1d(ps[p
-00087a00: 5d2d 3e67 7261 642c 206a 293b 0a20 2020  ]->grad, j);.   
-00087a10: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
-00087a20: 2f2f 0a2f 2f20 4144 414d 0a2f 2f0a 2f2f  //.// ADAM.//.//
-00087a30: 2020 2072 6566 3a20 6874 7470 733a 2f2f     ref: https://
-00087a40: 6172 7869 762e 6f72 672f 7064 662f 3134  arxiv.org/pdf/14
-00087a50: 3132 2e36 3938 302e 7064 660a 2f2f 0a0a  12.6980.pdf.//..
-00087a60: 7374 6174 6963 2065 6e75 6d20 6767 6d6c  static enum ggml
-00087a70: 5f6f 7074 5f72 6573 756c 7420 6767 6d6c  _opt_result ggml
-00087a80: 5f6f 7074 5f61 6461 6d28 0a20 2020 2020  _opt_adam(.     
-00087a90: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-00087aa0: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-00087ab0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00087ac0: 6c5f 6f70 745f 636f 6e74 6578 7420 2a20  l_opt_context * 
-00087ad0: 6f70 742c 0a20 2020 2020 2020 2073 7472  opt,.        str
-00087ae0: 7563 7420 6767 6d6c 5f6f 7074 5f70 6172  uct ggml_opt_par
-00087af0: 616d 7320 7061 7261 6d73 2c0a 2020 2020  ams params,.    
-00087b00: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00087b10: 7465 6e73 6f72 202a 2066 2c0a 2020 2020  tensor * f,.    
-00087b20: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00087b30: 6367 7261 7068 202a 2067 662c 0a20 2020  cgraph * gf,.   
-00087b40: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00087b50: 5f63 6772 6170 6820 2a20 6762 2920 7b0a  _cgraph * gb) {.
-00087b60: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00087b70: 6767 6d6c 5f69 735f 7363 616c 6172 2866  ggml_is_scalar(f
-00087b80: 2929 3b0a 0a20 2020 2067 662d 3e6e 5f74  ));..    gf->n_t
-00087b90: 6872 6561 6473 203d 2070 6172 616d 732e  hreads = params.
-00087ba0: 6e5f 7468 7265 6164 733b 0a20 2020 2067  n_threads;.    g
-00087bb0: 622d 3e6e 5f74 6872 6561 6473 203d 2070  b->n_threads = p
-00087bc0: 6172 616d 732e 6e5f 7468 7265 6164 733b  arams.n_threads;
-00087bd0: 0a0a 2020 2020 2f2f 2074 6865 7365 2077  ..    // these w
-00087be0: 696c 6c20 7374 6f72 6520 7468 6520 7061  ill store the pa
-00087bf0: 7261 6d65 7465 7273 2077 6520 7761 6e74  rameters we want
-00087c00: 2074 6f20 6f70 7469 6d69 7a65 0a20 2020   to optimize.   
-00087c10: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00087c20: 736f 7220 2a20 7073 5b47 474d 4c5f 4d41  sor * ps[GGML_MA
-00087c30: 585f 5041 5241 4d53 5d3b 0a0a 2020 2020  X_PARAMS];..    
-00087c40: 696e 7420 6e70 203d 2030 3b0a 2020 2020  int np = 0;.    
-00087c50: 696e 7420 6e78 203d 2030 3b0a 2020 2020  int nx = 0;.    
-00087c60: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00087c70: 6920 3c20 6766 2d3e 6e5f 6e6f 6465 733b  i < gf->n_nodes;
-00087c80: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-00087c90: 6966 2028 6766 2d3e 6e6f 6465 735b 695d  if (gf->nodes[i]
-00087ca0: 2d3e 6973 5f70 6172 616d 2920 7b0a 2020  ->is_param) {.  
-00087cb0: 2020 2020 2020 2020 2020 4747 4d4c 5f50            GGML_P
-00087cc0: 5249 4e54 5f44 4542 5547 2822 666f 756e  RINT_DEBUG("foun
-00087cd0: 6420 7061 7261 6d20 2564 3a20 6772 6164  d param %d: grad
-00087ce0: 2d3e 6f70 203d 2025 645c 6e22 2c20 6e70  ->op = %d\n", np
-00087cf0: 2c20 6766 2d3e 6e6f 6465 735b 695d 2d3e  , gf->nodes[i]->
-00087d00: 6772 6164 2d3e 6f70 293b 0a0a 2020 2020  grad->op);..    
-00087d10: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00087d20: 4552 5428 6e70 203c 2047 474d 4c5f 4d41  ERT(np < GGML_MA
-00087d30: 585f 5041 5241 4d53 293b 0a0a 2020 2020  X_PARAMS);..    
-00087d40: 2020 2020 2020 2020 7073 5b6e 702b 2b5d          ps[np++]
-00087d50: 203d 2067 662d 3e6e 6f64 6573 5b69 5d3b   = gf->nodes[i];
-00087d60: 0a20 2020 2020 2020 2020 2020 206e 7820  .            nx 
-00087d70: 2b3d 2067 676d 6c5f 6e65 6c65 6d65 6e74  += ggml_nelement
-00087d80: 7328 6766 2d3e 6e6f 6465 735b 695d 293b  s(gf->nodes[i]);
-00087d90: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-00087da0: 0a0a 2020 2020 6966 2028 286f 7074 2d3e  ..    if ((opt->
-00087db0: 7061 7261 6d73 2e74 7970 6520 213d 2070  params.type != p
-00087dc0: 6172 616d 732e 7479 7065 2920 7c7c 2028  arams.type) || (
-00087dd0: 6f70 742d 3e6e 7820 213d 206e 7829 207c  opt->nx != nx) |
-00087de0: 7c20 286f 7074 2d3e 7061 7261 6d73 2e70  | (opt->params.p
-00087df0: 6173 7420 213d 2070 6172 616d 732e 7061  ast != params.pa
-00087e00: 7374 2929 207b 0a20 2020 2020 2020 2069  st)) {.        i
-00087e10: 6e74 2069 7465 7220 3d20 6f70 742d 3e69  nt iter = opt->i
-00087e20: 7465 723b 0a20 2020 2020 2020 2067 676d  ter;.        ggm
-00087e30: 6c5f 6f70 745f 696e 6974 286f 7074 2d3e  l_opt_init(opt->
-00087e40: 6374 782c 206f 7074 2c20 7061 7261 6d73  ctx, opt, params
-00087e50: 2c20 6e78 293b 0a20 2020 2020 2020 206f  , nx);.        o
-00087e60: 7074 2d3e 6974 6572 203d 2069 7465 723b  pt->iter = iter;
-00087e70: 0a20 2020 207d 0a0a 2020 2020 2f2f 2063  .    }..    // c
-00087e80: 6f6e 7374 616e 7473 0a20 2020 2063 6f6e  onstants.    con
-00087e90: 7374 2066 6c6f 6174 2073 6368 6564 203d  st float sched =
-00087ea0: 2070 6172 616d 732e 6164 616d 2e73 6368   params.adam.sch
-00087eb0: 6564 3b0a 2020 2020 636f 6e73 7420 666c  ed;.    const fl
-00087ec0: 6f61 7420 6465 6361 7920 3d20 7061 7261  oat decay = para
-00087ed0: 6d73 2e61 6461 6d2e 6465 6361 7920 2a20  ms.adam.decay * 
-00087ee0: 7363 6865 643b 0a20 2020 2063 6f6e 7374  sched;.    const
-00087ef0: 2066 6c6f 6174 2061 6c70 6861 203d 2070   float alpha = p
-00087f00: 6172 616d 732e 6164 616d 2e61 6c70 6861  arams.adam.alpha
-00087f10: 202a 2073 6368 6564 3b0a 2020 2020 636f   * sched;.    co
-00087f20: 6e73 7420 666c 6f61 7420 6265 7461 3120  nst float beta1 
-00087f30: 3d20 7061 7261 6d73 2e61 6461 6d2e 6265  = params.adam.be
-00087f40: 7461 313b 0a20 2020 2063 6f6e 7374 2066  ta1;.    const f
-00087f50: 6c6f 6174 2062 6574 6132 203d 2070 6172  loat beta2 = par
-00087f60: 616d 732e 6164 616d 2e62 6574 6132 3b0a  ams.adam.beta2;.
-00087f70: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00087f80: 6570 7320 2020 3d20 7061 7261 6d73 2e61  eps   = params.a
-00087f90: 6461 6d2e 6570 733b 0a0a 2020 2020 666c  dam.eps;..    fl
-00087fa0: 6f61 7420 2a20 7820 203d 206f 7074 2d3e  oat * x  = opt->
-00087fb0: 6164 616d 2e78 2d3e 6461 7461 3b20 202f  adam.x->data;  /
-00087fc0: 2f20 7669 6577 206f 6620 7468 6520 7061  / view of the pa
-00087fd0: 7261 6d65 7465 7273 0a20 2020 2066 6c6f  rameters.    flo
-00087fe0: 6174 202a 2067 3120 3d20 6f70 742d 3e61  at * g1 = opt->a
-00087ff0: 6461 6d2e 6731 2d3e 6461 7461 3b20 2f2f  dam.g1->data; //
-00088000: 2067 7261 6469 656e 740a 2020 2020 666c   gradient.    fl
-00088010: 6f61 7420 2a20 6732 203d 206f 7074 2d3e  oat * g2 = opt->
-00088020: 6164 616d 2e67 322d 3e64 6174 613b 202f  adam.g2->data; /
-00088030: 2f20 6772 6164 6965 6e74 2073 7175 6172  / gradient squar
-00088040: 6564 0a20 2020 2066 6c6f 6174 202a 206d  ed.    float * m
-00088050: 2020 3d20 6f70 742d 3e61 6461 6d2e 6d2d    = opt->adam.m-
-00088060: 3e64 6174 613b 2020 2f2f 2066 6972 7374  >data;  // first
-00088070: 206d 6f6d 656e 740a 2020 2020 666c 6f61   moment.    floa
-00088080: 7420 2a20 7620 203d 206f 7074 2d3e 6164  t * v  = opt->ad
-00088090: 616d 2e76 2d3e 6461 7461 3b20 202f 2f20  am.v->data;  // 
-000880a0: 7365 636f 6e64 206d 6f6d 656e 740a 2020  second moment.  
-000880b0: 2020 666c 6f61 7420 2a20 6d68 203d 206f    float * mh = o
-000880c0: 7074 2d3e 6164 616d 2e6d 682d 3e64 6174  pt->adam.mh->dat
-000880d0: 613b 202f 2f20 6669 7273 7420 6d6f 6d65  a; // first mome
-000880e0: 6e74 2068 6174 0a20 2020 2066 6c6f 6174  nt hat.    float
-000880f0: 202a 2076 6820 3d20 6f70 742d 3e61 6461   * vh = opt->ada
-00088100: 6d2e 7668 2d3e 6461 7461 3b20 2f2f 2073  m.vh->data; // s
-00088110: 6563 6f6e 6420 6d6f 6d65 6e74 2068 6174  econd moment hat
-00088120: 0a0a 2020 2020 666c 6f61 7420 2a20 7066  ..    float * pf
-00088130: 203d 2070 6172 616d 732e 7061 7374 203e   = params.past >
-00088140: 2030 203f 206f 7074 2d3e 6164 616d 2e70   0 ? opt->adam.p
-00088150: 662d 3e64 6174 6120 3a20 4e55 4c4c 3b20  f->data : NULL; 
-00088160: 2f2f 2070 6173 7420 6675 6e63 7469 6f6e  // past function
-00088170: 2076 616c 7565 730a 0a20 2020 202f 2f20   values..    // 
-00088180: 7570 6461 7465 2076 6965 770a 2020 2020  update view.    
-00088190: 6767 6d6c 5f6f 7074 5f67 6574 5f70 6172  ggml_opt_get_par
-000881a0: 616d 7328 6e70 2c20 7073 2c20 7829 3b0a  ams(np, ps, x);.
-000881b0: 0a20 2020 202f 2f20 636f 6d70 7574 6520  .    // compute 
-000881c0: 7468 6520 6675 6e63 7469 6f6e 2076 616c  the function val
-000881d0: 7565 0a20 2020 2067 676d 6c5f 6772 6170  ue.    ggml_grap
-000881e0: 685f 7265 7365 7420 2028 6766 293b 0a20  h_reset  (gf);. 
-000881f0: 2020 2067 676d 6c5f 7365 745f 6633 3220     ggml_set_f32 
-00088200: 2020 2020 2028 662d 3e67 7261 642c 2031       (f->grad, 1
-00088210: 2e30 6629 3b0a 2020 2020 6767 6d6c 5f67  .0f);.    ggml_g
-00088220: 7261 7068 5f63 6f6d 7075 7465 2863 7478  raph_compute(ctx
-00088230: 2c20 6762 293b 0a0a 2020 2020 6f70 742d  , gb);..    opt-
-00088240: 3e61 6461 6d2e 6678 5f70 7265 7620 3d20  >adam.fx_prev = 
-00088250: 6767 6d6c 5f67 6574 5f66 3332 5f31 6428  ggml_get_f32_1d(
-00088260: 662c 2030 293b 0a20 2020 206f 7074 2d3e  f, 0);.    opt->
-00088270: 6164 616d 2e66 785f 6265 7374 203d 206f  adam.fx_best = o
-00088280: 7074 2d3e 6164 616d 2e66 785f 7072 6576  pt->adam.fx_prev
-00088290: 3b0a 2020 2020 6966 2028 7066 2920 7b0a  ;.    if (pf) {.
-000882a0: 2020 2020 2020 2020 7066 5b6f 7074 2d3e          pf[opt->
-000882b0: 6974 6572 2025 2070 6172 616d 732e 7061  iter % params.pa
-000882c0: 7374 5d20 3d20 6f70 742d 3e61 6461 6d2e  st] = opt->adam.
-000882d0: 6678 5f70 7265 763b 0a20 2020 207d 0a0a  fx_prev;.    }..
-000882e0: 2020 2020 2f2f 2069 6e69 7469 616c 697a      // initializ
-000882f0: 650a 2020 2020 6966 2028 6f70 742d 3e6a  e.    if (opt->j
-00088300: 7573 745f 696e 6974 6961 6c69 7a65 6429  ust_initialized)
-00088310: 207b 0a20 2020 2020 2020 206f 7074 2d3e   {.        opt->
-00088320: 6164 616d 2e6e 5f6e 6f5f 696d 7072 6f76  adam.n_no_improv
-00088330: 656d 656e 7420 3d20 303b 0a20 2020 2020  ement = 0;.     
-00088340: 2020 206f 7074 2d3e 6a75 7374 5f69 6e69     opt->just_ini
-00088350: 7469 616c 697a 6564 203d 2066 616c 7365  tialized = false
-00088360: 3b0a 2020 2020 7d0a 0a20 2020 2066 6c6f  ;.    }..    flo
-00088370: 6174 202a 2066 785f 6265 7374 203d 2026  at * fx_best = &
-00088380: 6f70 742d 3e61 6461 6d2e 6678 5f62 6573  opt->adam.fx_bes
-00088390: 743b 0a20 2020 2066 6c6f 6174 202a 2066  t;.    float * f
-000883a0: 785f 7072 6576 203d 2026 6f70 742d 3e61  x_prev = &opt->a
-000883b0: 6461 6d2e 6678 5f70 7265 763b 0a20 2020  dam.fx_prev;.   
-000883c0: 2069 6e74 202a 206e 5f6e 6f5f 696d 7072   int * n_no_impr
-000883d0: 6f76 656d 656e 7420 3d20 266f 7074 2d3e  ovement = &opt->
-000883e0: 6164 616d 2e6e 5f6e 6f5f 696d 7072 6f76  adam.n_no_improv
-000883f0: 656d 656e 743b 0a0a 2020 2020 696e 7420  ement;..    int 
-00088400: 6974 6572 3020 3d20 6f70 742d 3e69 7465  iter0 = opt->ite
-00088410: 723b 0a0a 2020 2020 2f2f 2072 756e 2074  r;..    // run t
-00088420: 6865 206f 7074 696d 697a 6572 0a20 2020  he optimizer.   
-00088430: 2066 6f72 2028 696e 7420 7420 3d20 303b   for (int t = 0;
-00088440: 2074 203c 2070 6172 616d 732e 6164 616d   t < params.adam
-00088450: 2e6e 5f69 7465 723b 202b 2b74 2920 7b0a  .n_iter; ++t) {.
-00088460: 2020 2020 2020 2020 6f70 742d 3e69 7465          opt->ite
-00088470: 7220 3d20 6974 6572 3020 2b20 7420 2b20  r = iter0 + t + 
-00088480: 313b 0a20 2020 2020 2020 2047 474d 4c5f  1;.        GGML_
-00088490: 5052 494e 545f 4445 4255 4720 2028 223d  PRINT_DEBUG  ("=
-000884a0: 3d3d 2069 7465 7220 2564 203d 3d3d 5c6e  == iter %d ===\n
-000884b0: 222c 2074 293b 0a0a 2020 2020 2020 2020  ", t);..        
-000884c0: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
-000884d0: 2020 2822 6620 2020 2020 203d 2025 3130    ("f      = %10
-000884e0: 2e36 665c 6e22 2c20 6767 6d6c 5f67 6574  .6f\n", ggml_get
-000884f0: 5f66 3332 5f31 6428 662c 2030 2929 3b0a  _f32_1d(f, 0));.
-00088500: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
-00088510: 4e54 5f44 4542 5547 5f35 2822 6466 2f64  NT_DEBUG_5("df/d
-00088520: 7830 203d 2025 3130 2e36 665c 6e22 2c20  x0 = %10.6f\n", 
-00088530: 6767 6d6c 5f67 6574 5f66 3332 5f31 6428  ggml_get_f32_1d(
-00088540: 7073 5b30 5d2d 3e67 7261 642c 2030 2929  ps[0]->grad, 0))
-00088550: 3b0a 2020 2020 2020 2020 4747 4d4c 5f50  ;.        GGML_P
-00088560: 5249 4e54 5f44 4542 5547 5f35 2822 6466  RINT_DEBUG_5("df
-00088570: 2f64 7831 203d 2025 3130 2e36 665c 6e22  /dx1 = %10.6f\n"
-00088580: 2c20 6767 6d6c 5f67 6574 5f66 3332 5f31  , ggml_get_f32_1
-00088590: 6428 7073 5b31 5d2d 3e67 7261 642c 2030  d(ps[1]->grad, 0
-000885a0: 2929 3b0a 0a20 2020 2020 2020 2066 6f72  ));..        for
-000885b0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-000885c0: 206e 703b 202b 2b69 2920 7b0a 2020 2020   np; ++i) {.    
-000885d0: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
-000885e0: 4e54 5f44 4542 5547 2822 7061 7261 6d20  NT_DEBUG("param 
-000885f0: 2564 3a20 2531 302e 3666 2c20 6720 3d20  %d: %10.6f, g = 
-00088600: 2531 302e 3666 5c6e 222c 2069 2c0a 2020  %10.6f\n", i,.  
-00088610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088620: 2020 6767 6d6c 5f67 6574 5f66 3332 5f31    ggml_get_f32_1
-00088630: 6428 7073 5b69 5d2c 2030 292c 2067 676d  d(ps[i], 0), ggm
-00088640: 6c5f 6765 745f 6633 325f 3164 2870 735b  l_get_f32_1d(ps[
-00088650: 695d 2d3e 6772 6164 2c20 3029 293b 0a20  i]->grad, 0));. 
-00088660: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00088670: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00088680: 745f 7374 6172 745f 7761 6c6c 203d 2067  t_start_wall = g
-00088690: 676d 6c5f 7469 6d65 5f75 7328 293b 0a20  gml_time_us();. 
-000886a0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-000886b0: 3634 5f74 2074 5f73 7461 7274 5f63 7075  64_t t_start_cpu
-000886c0: 203d 2067 676d 6c5f 6379 636c 6573 2829   = ggml_cycles()
-000886d0: 3b0a 2020 2020 2020 2020 554e 5553 4544  ;.        UNUSED
-000886e0: 2874 5f73 7461 7274 5f77 616c 6c29 3b0a  (t_start_wall);.
-000886f0: 2020 2020 2020 2020 554e 5553 4544 2874          UNUSED(t
-00088700: 5f73 7461 7274 5f63 7075 293b 0a0a 2020  _start_cpu);..  
-00088710: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00088720: 2020 2020 2f2f 2075 7064 6174 6520 7468      // update th
-00088730: 6520 6772 6164 6965 6e74 0a20 2020 2020  e gradient.     
-00088740: 2020 2020 2020 2067 676d 6c5f 6f70 745f         ggml_opt_
-00088750: 6765 745f 6772 6164 286e 702c 2070 732c  get_grad(np, ps,
-00088760: 2067 3129 3b0a 0a20 2020 2020 2020 2020   g1);..         
-00088770: 2020 202f 2f20 6d5f 7420 3d20 6265 7461     // m_t = beta
-00088780: 312a 6d5f 742d 3120 2b20 2831 202d 2062  1*m_t-1 + (1 - b
-00088790: 6574 6131 292a 675f 740a 2020 2020 2020  eta1)*g_t.      
-000887a0: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-000887b0: 6361 6c65 5f66 3332 286e 782c 206d 2c20  cale_f32(nx, m, 
-000887c0: 6265 7461 3129 3b0a 2020 2020 2020 2020  beta1);.        
-000887d0: 2020 2020 6767 6d6c 5f76 6563 5f6d 6164      ggml_vec_mad
-000887e0: 5f66 3332 2020 286e 782c 206d 2c20 6731  _f32  (nx, m, g1
-000887f0: 2c20 312e 3066 202d 2062 6574 6131 293b  , 1.0f - beta1);
-00088800: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
-00088810: 2067 3220 3d20 6731 5e32 0a20 2020 2020   g2 = g1^2.     
-00088820: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00088830: 7371 725f 6633 3220 2028 6e78 2c20 6732  sqr_f32  (nx, g2
-00088840: 2c20 6731 293b 0a0a 2020 2020 2020 2020  , g1);..        
-00088850: 2020 2020 2f2f 2076 5f74 203d 2062 6574      // v_t = bet
-00088860: 6132 2a76 5f74 2d31 202b 2028 3120 2d20  a2*v_t-1 + (1 - 
-00088870: 6265 7461 3229 2a67 5f74 5e32 0a20 2020  beta2)*g_t^2.   
-00088880: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00088890: 635f 7363 616c 655f 6633 3228 6e78 2c20  c_scale_f32(nx, 
-000888a0: 762c 2062 6574 6132 293b 0a20 2020 2020  v, beta2);.     
-000888b0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-000888c0: 6d61 645f 6633 3220 2028 6e78 2c20 762c  mad_f32  (nx, v,
-000888d0: 2067 322c 2031 2e30 6620 2d20 6265 7461   g2, 1.0f - beta
-000888e0: 3229 3b0a 0a20 2020 2020 2020 2020 2020  2);..           
-000888f0: 202f 2f20 6d5e 6861 7420 3d20 6d5f 7420   // m^hat = m_t 
-00088900: 2f20 2831 202d 2062 6574 6131 5e74 290a  / (1 - beta1^t).
-00088910: 2020 2020 2020 2020 2020 2020 2f2f 2076              // v
-00088920: 5e68 6174 203d 2076 5f74 202f 2028 3120  ^hat = v_t / (1 
-00088930: 2d20 6265 7461 325e 7429 0a20 2020 2020  - beta2^t).     
-00088940: 2020 2020 2020 202f 2f20 785f 7420 3d20         // x_t = 
-00088950: 785f 742d 3120 2d20 7363 6865 642a 2861  x_t-1 - sched*(a
-00088960: 6c70 6861 2a6d 5e68 6174 2f28 7371 7274  lpha*m^hat/(sqrt
-00088970: 2876 5e68 6174 2920 2b20 6570 7329 202b  (v^hat) + eps) +
-00088980: 2064 6563 6179 2a78 5f74 2d31 290a 2020   decay*x_t-1).  
-00088990: 2020 2020 2020 2020 2020 2f2f 2078 5f74            // x_t
-000889a0: 203d 2078 5f74 2d31 202d 2073 6368 6564   = x_t-1 - sched
-000889b0: 2a61 6c70 6861 2a6d 5e68 6174 2f28 7371  *alpha*m^hat/(sq
-000889c0: 7274 2876 5e68 6174 2920 2b20 6570 7329  rt(v^hat) + eps)
-000889d0: 202d 2073 6368 6564 2a64 6563 6179 2a78   - sched*decay*x
-000889e0: 5f74 2d31 0a20 2020 2020 2020 2020 2020  _t-1.           
-000889f0: 202f 2f20 785f 7420 3d20 785f 742d 312a   // x_t = x_t-1*
-00088a00: 2831 2d73 6368 6564 2a64 6563 6179 2920  (1-sched*decay) 
-00088a10: 2d20 7363 6865 642a 616c 7068 612a 6d5e  - sched*alpha*m^
-00088a20: 6861 742f 2873 7172 7428 765e 6861 7429  hat/(sqrt(v^hat)
-00088a30: 202b 2065 7073 290a 2020 2020 2020 2020   + eps).        
-00088a40: 2020 2020 2f2f 2078 5f74 203d 2078 5f74      // x_t = x_t
-00088a50: 2d31 2a28 312d 7363 6865 642a 6465 6361  -1*(1-sched*deca
-00088a60: 7929 202b 2073 6368 6564 2a64 6563 6179  y) + sched*decay
-00088a70: 2a28 2d61 6c70 6861 2f64 6563 6179 292a  *(-alpha/decay)*
-00088a80: 6d5e 6861 742f 2873 7172 7428 765e 6861  m^hat/(sqrt(v^ha
-00088a90: 7429 202b 2065 7073 290a 2020 2020 2020  t) + eps).      
-00088aa0: 2020 2020 2020 2f2f 2078 5f74 203d 206d        // x_t = m
-00088ab0: 6978 2878 5f74 2d31 2c20 282d 616c 7068  ix(x_t-1, (-alph
-00088ac0: 612f 6465 6361 7929 2a6d 5e68 6174 2f28  a/decay)*m^hat/(
-00088ad0: 7371 7274 2876 5e68 6174 2920 2b20 6570  sqrt(v^hat) + ep
-00088ae0: 7329 2c20 7363 6865 642a 6465 6361 7929  s), sched*decay)
-00088af0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00088b00: 6c5f 7665 635f 6370 795f 6633 3220 2028  l_vec_cpy_f32  (
-00088b10: 6e78 2c20 6d68 2c20 6d29 3b0a 2020 2020  nx, mh, m);.    
-00088b20: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-00088b30: 5f63 7079 5f66 3332 2020 286e 782c 2076  _cpy_f32  (nx, v
-00088b40: 682c 2076 293b 0a0a 2020 2020 2020 2020  h, v);..        
-00088b50: 2020 2020 6767 6d6c 5f76 6563 5f73 6361      ggml_vec_sca
-00088b60: 6c65 5f66 3332 286e 782c 206d 682c 2061  le_f32(nx, mh, a
-00088b70: 6c70 6861 2f28 312e 3066 202d 2070 6f77  lpha/(1.0f - pow
-00088b80: 6628 6265 7461 312c 206f 7074 2d3e 6974  f(beta1, opt->it
-00088b90: 6572 2929 293b 0a20 2020 2020 2020 2020  er)));.         
-00088ba0: 2020 2067 676d 6c5f 7665 635f 7363 616c     ggml_vec_scal
-00088bb0: 655f 6633 3228 6e78 2c20 7668 2c20 2031  e_f32(nx, vh,  1
-00088bc0: 2e30 662f 2831 2e30 6620 2d20 706f 7766  .0f/(1.0f - powf
-00088bd0: 2862 6574 6132 2c20 6f70 742d 3e69 7465  (beta2, opt->ite
-00088be0: 7229 2929 3b0a 0a20 2020 2020 2020 2020  r)));..         
-00088bf0: 2020 2067 676d 6c5f 7665 635f 7371 7274     ggml_vec_sqrt
-00088c00: 5f66 3332 2028 6e78 2c20 7668 2c20 7668  _f32 (nx, vh, vh
-00088c10: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
-00088c20: 676d 6c5f 7665 635f 6163 6331 5f66 3332  gml_vec_acc1_f32
-00088c30: 2028 6e78 2c20 7668 2c20 6570 7329 3b0a   (nx, vh, eps);.
-00088c40: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00088c50: 6c5f 7665 635f 6469 765f 6633 3220 2028  l_vec_div_f32  (
-00088c60: 6e78 2c20 6d68 2c20 6d68 2c20 7668 293b  nx, mh, mh, vh);
-00088c70: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00088c80: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
-00088c90: 6e78 2c20 782c 2020 312e 3066 202d 2064  nx, x,  1.0f - d
-00088ca0: 6563 6179 293b 0a20 2020 2020 2020 2020  ecay);.         
-00088cb0: 2020 2067 676d 6c5f 7665 635f 7375 625f     ggml_vec_sub_
-00088cc0: 6633 3220 2028 6e78 2c20 782c 2020 782c  f32  (nx, x,  x,
-00088cd0: 2020 6d68 293b 0a0a 2020 2020 2020 2020    mh);..        
-00088ce0: 2020 2020 2f2f 2075 7064 6174 6520 7468      // update th
-00088cf0: 6520 7061 7261 6d65 7465 7273 0a20 2020  e parameters.   
-00088d00: 2020 2020 2020 2020 2067 676d 6c5f 6f70           ggml_op
-00088d10: 745f 7365 745f 7061 7261 6d73 286e 702c  t_set_params(np,
-00088d20: 2070 732c 2078 293b 0a20 2020 2020 2020   ps, x);.       
-00088d30: 207d 0a0a 2020 2020 2020 2020 6767 6d6c   }..        ggml
-00088d40: 5f67 7261 7068 5f72 6573 6574 2020 2867  _graph_reset  (g
-00088d50: 6629 3b0a 2020 2020 2020 2020 6767 6d6c  f);.        ggml
-00088d60: 5f73 6574 5f66 3332 2020 2020 2020 2866  _set_f32      (f
-00088d70: 2d3e 6772 6164 2c20 312e 3066 293b 0a20  ->grad, 1.0f);. 
-00088d80: 2020 2020 2020 2067 676d 6c5f 6772 6170         ggml_grap
-00088d90: 685f 636f 6d70 7574 6528 6374 782c 2067  h_compute(ctx, g
-00088da0: 6229 3b0a 0a20 2020 2020 2020 2063 6f6e  b);..        con
-00088db0: 7374 2066 6c6f 6174 2066 7820 3d20 6767  st float fx = gg
-00088dc0: 6d6c 5f67 6574 5f66 3332 5f31 6428 662c  ml_get_f32_1d(f,
-00088dd0: 2030 293b 0a0a 2020 2020 2020 2020 2f2f   0);..        //
-00088de0: 2063 6865 636b 2063 6f6e 7665 7267 656e   check convergen
-00088df0: 6365 0a20 2020 2020 2020 2069 6620 2866  ce.        if (f
-00088e00: 6162 7366 2866 7820 2d20 6678 5f70 7265  absf(fx - fx_pre
-00088e10: 765b 305d 292f 6678 203c 2070 6172 616d  v[0])/fx < param
-00088e20: 732e 6164 616d 2e65 7073 5f66 2920 7b0a  s.adam.eps_f) {.
-00088e30: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00088e40: 5f50 5249 4e54 5f44 4542 5547 2822 636f  _PRINT_DEBUG("co
-00088e50: 6e76 6572 6765 645c 6e22 293b 0a0a 2020  nverged\n");..  
-00088e60: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00088e70: 2047 474d 4c5f 4f50 545f 4f4b 3b0a 2020   GGML_OPT_OK;.  
-00088e80: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00088e90: 202f 2f20 6465 6c74 612d 6261 7365 6420   // delta-based 
-00088ea0: 636f 6e76 6572 6765 6e63 6520 7465 7374  convergence test
-00088eb0: 0a20 2020 2020 2020 2069 6620 2870 6620  .        if (pf 
-00088ec0: 213d 204e 554c 4c29 207b 0a20 2020 2020  != NULL) {.     
-00088ed0: 2020 2020 2020 202f 2f20 6e65 6564 2061         // need a
-00088ee0: 7420 6c65 6173 7420 7061 7261 6d73 2e70  t least params.p
-00088ef0: 6173 7420 6974 6572 6174 696f 6e73 2074  ast iterations t
-00088f00: 6f20 7374 6172 7420 6368 6563 6b69 6e67  o start checking
-00088f10: 2066 6f72 2063 6f6e 7665 7267 656e 6365   for convergence
-00088f20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00088f30: 2870 6172 616d 732e 7061 7374 203c 3d20  (params.past <= 
-00088f40: 6974 6572 3020 2b20 7429 207b 0a20 2020  iter0 + t) {.   
-00088f50: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00088f60: 7374 2066 6c6f 6174 2072 6174 6520 3d20  st float rate = 
-00088f70: 2870 665b 2869 7465 7230 202b 2074 2925  (pf[(iter0 + t)%
-00088f80: 7061 7261 6d73 2e70 6173 745d 202d 2066  params.past] - f
-00088f90: 7829 2f66 783b 0a0a 2020 2020 2020 2020  x)/fx;..        
-00088fa0: 2020 2020 2020 2020 6966 2028 6661 6273          if (fabs
-00088fb0: 6628 7261 7465 2920 3c20 7061 7261 6d73  f(rate) < params
-00088fc0: 2e64 656c 7461 2920 7b0a 2020 2020 2020  .delta) {.      
-00088fd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00088fe0: 7475 726e 2047 474d 4c5f 4f50 545f 4f4b  turn GGML_OPT_OK
-00088ff0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00089000: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00089010: 7d0a 0a20 2020 2020 2020 2020 2020 2070  }..            p
-00089020: 665b 2869 7465 7230 202b 2074 2925 7061  f[(iter0 + t)%pa
-00089030: 7261 6d73 2e70 6173 745d 203d 2066 783b  rams.past] = fx;
-00089040: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00089050: 2020 2020 2f2f 2063 6865 636b 2066 6f72      // check for
-00089060: 2069 6d70 726f 7665 6d65 6e74 0a20 2020   improvement.   
-00089070: 2020 2020 2069 6620 2870 6172 616d 732e       if (params.
-00089080: 6d61 785f 6e6f 5f69 6d70 726f 7665 6d65  max_no_improveme
-00089090: 6e74 203e 2030 2920 7b0a 2020 2020 2020  nt > 0) {.      
-000890a0: 2020 2020 2020 6966 2028 6678 5f62 6573        if (fx_bes
-000890b0: 745b 305d 203e 2066 7829 207b 0a20 2020  t[0] > fx) {.   
-000890c0: 2020 2020 2020 2020 2020 2020 2066 785f               fx_
-000890d0: 6265 7374 5b30 5d20 3d20 6678 3b0a 2020  best[0] = fx;.  
-000890e0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-000890f0: 6e6f 5f69 6d70 726f 7665 6d65 6e74 5b30  no_improvement[0
-00089100: 5d20 3d20 303b 0a20 2020 2020 2020 2020  ] = 0;.         
-00089110: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-00089120: 2020 2020 2020 2020 2020 2020 2b2b 6e5f              ++n_
-00089130: 6e6f 5f69 6d70 726f 7665 6d65 6e74 5b30  no_improvement[0
-00089140: 5d3b 0a0a 2020 2020 2020 2020 2020 2020  ];..            
-00089150: 2020 2020 6966 2028 6e5f 6e6f 5f69 6d70      if (n_no_imp
-00089160: 726f 7665 6d65 6e74 5b30 5d20 3e3d 2070  rovement[0] >= p
-00089170: 6172 616d 732e 6d61 785f 6e6f 5f69 6d70  arams.max_no_imp
-00089180: 726f 7665 6d65 6e74 2920 7b0a 2020 2020  rovement) {.    
-00089190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000891a0: 7265 7475 726e 2047 474d 4c5f 4f50 545f  return GGML_OPT_
-000891b0: 4f4b 3b0a 2020 2020 2020 2020 2020 2020  OK;.            
-000891c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000891d0: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
-000891e0: 2020 2020 2020 2066 785f 7072 6576 5b30         fx_prev[0
-000891f0: 5d20 3d20 6678 3b0a 0a20 2020 2020 2020  ] = fx;..       
-00089200: 207b 0a20 2020 2020 2020 2020 2020 2063   {.            c
-00089210: 6f6e 7374 2069 6e74 3634 5f74 2074 5f65  onst int64_t t_e
-00089220: 6e64 5f63 7075 203d 2067 676d 6c5f 6379  nd_cpu = ggml_cy
-00089230: 636c 6573 2829 3b0a 2020 2020 2020 2020  cles();.        
-00089240: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
-00089250: 4542 5547 2822 7469 6d65 2069 7465 723a  EBUG("time iter:
-00089260: 2020 2020 2020 2535 2e33 6620 735c 6e22        %5.3f s\n"
-00089270: 2c20 2828 666c 6f61 7429 2874 5f65 6e64  , ((float)(t_end
-00089280: 5f63 7075 202d 2074 5f73 7461 7274 5f63  _cpu - t_start_c
-00089290: 7075 2929 2f43 4c4f 434b 535f 5045 525f  pu))/CLOCKS_PER_
-000892a0: 5345 4329 3b0a 2020 2020 2020 2020 2020  SEC);.          
-000892b0: 2020 554e 5553 4544 2874 5f65 6e64 5f63    UNUSED(t_end_c
-000892c0: 7075 293b 0a0a 2020 2020 2020 2020 2020  pu);..          
-000892d0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000892e0: 745f 656e 645f 7761 6c6c 203d 2067 676d  t_end_wall = ggm
-000892f0: 6c5f 7469 6d65 5f75 7328 293b 0a20 2020  l_time_us();.   
-00089300: 2020 2020 2020 2020 2047 474d 4c5f 5052           GGML_PR
-00089310: 494e 545f 4445 4255 4728 2277 616c 6c20  INT_DEBUG("wall 
-00089320: 7469 6d65 2069 7465 723a 2025 352e 3366  time iter: %5.3f
-00089330: 2073 5c6e 222c 2028 745f 656e 645f 7761   s\n", (t_end_wa
-00089340: 6c6c 202d 2074 5f73 7461 7274 5f77 616c  ll - t_start_wal
-00089350: 6c29 2f31 6536 293b 0a20 2020 2020 2020  l)/1e6);.       
-00089360: 2020 2020 2055 4e55 5345 4428 745f 656e       UNUSED(t_en
-00089370: 645f 7761 6c6c 293b 0a20 2020 2020 2020  d_wall);.       
-00089380: 207d 0a20 2020 207d 0a0a 2020 2020 7265   }.    }..    re
-00089390: 7475 726e 2047 474d 4c5f 4f50 545f 4449  turn GGML_OPT_DI
-000893a0: 445f 4e4f 545f 434f 4e56 4552 4745 3b0a  D_NOT_CONVERGE;.
-000893b0: 7d0a 0a2f 2f0a 2f2f 204c 2d42 4647 530a  }..//.// L-BFGS.
-000893c0: 2f2f 0a2f 2f20 7468 6520 4c2d 4246 4753  //.// the L-BFGS
-000893d0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e20   implementation 
-000893e0: 6265 6c6f 7720 6973 2062 6173 6564 206f  below is based o
-000893f0: 6e20 7468 6520 666f 6c6c 6f77 696e 6720  n the following 
-00089400: 696d 706c 656d 656e 7461 7469 6f6e 3a0a  implementation:.
-00089410: 2f2f 0a2f 2f20 2020 6874 7470 733a 2f2f  //.//   https://
-00089420: 6769 7468 7562 2e63 6f6d 2f63 686f 6b6b  github.com/chokk
-00089430: 616e 2f6c 6962 6c62 6667 730a 2f2f 0a0a  an/liblbfgs.//..
-00089440: 7374 7275 6374 2067 676d 6c5f 6c62 6667  struct ggml_lbfg
-00089450: 735f 6974 6572 6174 696f 6e5f 6461 7461  s_iteration_data
-00089460: 207b 0a20 2020 2066 6c6f 6174 2061 6c70   {.    float alp
-00089470: 6861 3b0a 2020 2020 666c 6f61 7420 7973  ha;.    float ys
-00089480: 3b0a 2020 2020 666c 6f61 7420 2a20 733b  ;.    float * s;
-00089490: 0a20 2020 2066 6c6f 6174 202a 2079 3b0a  .    float * y;.
-000894a0: 7d3b 0a0a 7374 6174 6963 2065 6e75 6d20  };..static enum 
-000894b0: 6767 6d6c 5f6f 7074 5f72 6573 756c 7420  ggml_opt_result 
-000894c0: 6c69 6e65 7365 6172 6368 5f62 6163 6b74  linesearch_backt
-000894d0: 7261 636b 696e 6728 0a20 2020 2020 2020  racking(.       
-000894e0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-000894f0: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-00089500: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00089510: 2067 676d 6c5f 6f70 745f 7061 7261 6d73   ggml_opt_params
-00089520: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00089530: 2020 2069 6e74 206e 782c 0a20 2020 2020     int nx,.     
-00089540: 2020 2066 6c6f 6174 202a 2078 2c0a 2020     float * x,.  
-00089550: 2020 2020 2020 666c 6f61 7420 2a20 6678        float * fx
-00089560: 2c0a 2020 2020 2020 2020 666c 6f61 7420  ,.        float 
-00089570: 2a20 672c 0a20 2020 2020 2020 2066 6c6f  * g,.        flo
-00089580: 6174 202a 2064 2c0a 2020 2020 2020 2020  at * d,.        
-00089590: 666c 6f61 7420 2a20 7374 6570 2c0a 2020  float * step,.  
-000895a0: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-000895b0: 7420 2a20 7870 2c0a 2020 2020 2020 2020  t * xp,.        
-000895c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000895d0: 6f72 202a 2066 2c0a 2020 2020 2020 2020  or * f,.        
-000895e0: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-000895f0: 7068 202a 2067 662c 0a20 2020 2020 2020  ph * gf,.       
-00089600: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
-00089610: 6170 6820 2a20 6762 2c0a 2020 2020 2020  aph * gb,.      
-00089620: 2020 636f 6e73 7420 696e 7420 6e70 2c0a    const int np,.
-00089630: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00089640: 676d 6c5f 7465 6e73 6f72 202a 2070 735b  gml_tensor * ps[
-00089650: 5d29 207b 0a20 2020 2069 6e74 2063 6f75  ]) {.    int cou
-00089660: 6e74 203d 2030 3b0a 0a20 2020 2066 6c6f  nt = 0;..    flo
-00089670: 6174 2077 6964 7468 2020 3d20 302e 3066  at width  = 0.0f
-00089680: 3b0a 2020 2020 666c 6f61 7420 6467 2020  ;.    float dg  
-00089690: 2020 203d 2030 2e30 663b 0a20 2020 2066     = 0.0f;.    f
-000896a0: 6c6f 6174 2066 696e 6974 2020 3d20 302e  loat finit  = 0.
-000896b0: 3066 3b0a 2020 2020 666c 6f61 7420 6467  0f;.    float dg
-000896c0: 696e 6974 203d 2030 2e30 663b 0a20 2020  init = 0.0f;.   
-000896d0: 2066 6c6f 6174 2064 6774 6573 7420 3d20   float dgtest = 
-000896e0: 302e 3066 3b0a 0a20 2020 2063 6f6e 7374  0.0f;..    const
-000896f0: 2066 6c6f 6174 2064 6563 203d 2030 2e35   float dec = 0.5
-00089700: 663b 0a20 2020 2063 6f6e 7374 2066 6c6f  f;.    const flo
-00089710: 6174 2069 6e63 203d 2032 2e31 663b 0a0a  at inc = 2.1f;..
-00089720: 2020 2020 6966 2028 2a73 7465 7020 3c3d      if (*step <=
-00089730: 2030 2e66 2920 7b0a 2020 2020 2020 2020   0.f) {.        
-00089740: 7265 7475 726e 2047 474d 4c5f 4c49 4e45  return GGML_LINE
-00089750: 5345 4152 4348 5f49 4e56 414c 4944 5f50  SEARCH_INVALID_P
-00089760: 4152 414d 4554 4552 533b 0a20 2020 207d  ARAMETERS;.    }
-00089770: 0a0a 2020 2020 2f2f 2063 6f6d 7075 7465  ..    // compute
-00089780: 2074 6865 2069 6e69 7469 616c 2067 7261   the initial gra
-00089790: 6469 656e 7420 696e 2074 6865 2073 6561  dient in the sea
-000897a0: 7263 6820 6469 7265 6374 696f 6e0a 2020  rch direction.  
-000897b0: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
-000897c0: 3332 286e 782c 2026 6467 696e 6974 2c20  32(nx, &dginit, 
-000897d0: 672c 2064 293b 0a0a 2020 2020 2f2f 206d  g, d);..    // m
-000897e0: 616b 6520 7375 7265 2074 6861 7420 6420  ake sure that d 
-000897f0: 706f 696e 7473 2074 6f20 6120 6465 7363  points to a desc
-00089800: 656e 7420 6469 7265 6374 696f 6e0a 2020  ent direction.  
-00089810: 2020 6966 2028 3020 3c20 6467 696e 6974    if (0 < dginit
-00089820: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-00089830: 726e 2047 474d 4c5f 4c49 4e45 5345 4152  rn GGML_LINESEAR
-00089840: 4348 5f46 4149 4c3b 0a20 2020 207d 0a0a  CH_FAIL;.    }..
-00089850: 2020 2020 2f2f 2069 6e69 7469 616c 697a      // initializ
-00089860: 6520 6c6f 6361 6c20 7661 7269 6162 6c65  e local variable
-00089870: 730a 2020 2020 6669 6e69 7420 3d20 2a66  s.    finit = *f
-00089880: 783b 0a20 2020 2064 6774 6573 7420 3d20  x;.    dgtest = 
-00089890: 7061 7261 6d73 2d3e 6c62 6667 732e 6674  params->lbfgs.ft
-000898a0: 6f6c 2a64 6769 6e69 743b 0a0a 2020 2020  ol*dginit;..    
-000898b0: 7768 696c 6520 2874 7275 6529 207b 0a20  while (true) {. 
-000898c0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-000898d0: 6370 795f 6633 3228 6e78 2c20 782c 2078  cpy_f32(nx, x, x
-000898e0: 7029 3b0a 2020 2020 2020 2020 6767 6d6c  p);.        ggml
-000898f0: 5f76 6563 5f6d 6164 5f66 3332 286e 782c  _vec_mad_f32(nx,
-00089900: 2078 2c20 642c 202a 7374 6570 293b 0a0a   x, d, *step);..
-00089910: 2020 2020 2020 2020 2f2f 2065 7661 6c75          // evalu
-00089920: 6174 6520 7468 6520 6675 6e63 7469 6f6e  ate the function
-00089930: 2061 6e64 2067 7261 6469 656e 7420 7661   and gradient va
-00089940: 6c75 6573 0a20 2020 2020 2020 207b 0a20  lues.        {. 
-00089950: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00089960: 6f70 745f 7365 745f 7061 7261 6d73 286e  opt_set_params(n
-00089970: 702c 2070 732c 2078 293b 0a0a 2020 2020  p, ps, x);..    
-00089980: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
-00089990: 7068 5f72 6573 6574 2020 2867 6629 3b0a  ph_reset  (gf);.
-000899a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000899b0: 5f73 6574 5f66 3332 2020 2020 2020 2866  _set_f32      (f
-000899c0: 2d3e 6772 6164 2c20 312e 3066 293b 0a20  ->grad, 1.0f);. 
-000899d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000899e0: 6772 6170 685f 636f 6d70 7574 6528 6374  graph_compute(ct
-000899f0: 782c 2067 6229 3b0a 0a20 2020 2020 2020  x, gb);..       
-00089a00: 2020 2020 2067 676d 6c5f 6f70 745f 6765       ggml_opt_ge
-00089a10: 745f 6772 6164 286e 702c 2070 732c 2067  t_grad(np, ps, g
-00089a20: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00089a30: 2a66 7820 3d20 6767 6d6c 5f67 6574 5f66  *fx = ggml_get_f
-00089a40: 3332 5f31 6428 662c 2030 293b 0a20 2020  32_1d(f, 0);.   
-00089a50: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00089a60: 2b2b 636f 756e 743b 0a0a 2020 2020 2020  ++count;..      
-00089a70: 2020 6966 2028 2a66 7820 3e20 6669 6e69    if (*fx > fini
-00089a80: 7420 2b20 282a 7374 6570 292a 6467 7465  t + (*step)*dgte
-00089a90: 7374 2920 7b0a 2020 2020 2020 2020 2020  st) {.          
-00089aa0: 2020 7769 6474 6820 3d20 6465 633b 0a20    width = dec;. 
-00089ab0: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-00089ac0: 2020 2020 2020 2020 2020 2020 2f2f 2041              // A
-00089ad0: 726d 696a 6f20 636f 6e64 6974 696f 6e20  rmijo condition 
-00089ae0: 6973 2073 6174 6973 6669 6564 0a20 2020  is satisfied.   
-00089af0: 2020 2020 2020 2020 2069 6620 2870 6172           if (par
-00089b00: 616d 732d 3e6c 6266 6773 2e6c 696e 6573  ams->lbfgs.lines
-00089b10: 6561 7263 6820 3d3d 2047 474d 4c5f 4c49  earch == GGML_LI
-00089b20: 4e45 5345 4152 4348 5f42 4143 4b54 5241  NESEARCH_BACKTRA
-00089b30: 434b 494e 475f 4152 4d49 4a4f 2920 7b0a  CKING_ARMIJO) {.
+00085690: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000856a0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000856b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000856c0: 206d 656d 6370 7928 7465 6e73 6f72 2d3e   memcpy(tensor->
+000856d0: 6e61 6d65 2c20 7074 725f 6e61 6d65 2c20  name, ptr_name, 
+000856e0: 4747 4d4c 5f4d 4158 5f4e 414d 4529 3b0a  GGML_MAX_NAME);.
+000856f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00085700: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+00085710: 206a 203c 2047 474d 4c5f 4d41 585f 4449   j < GGML_MAX_DI
+00085720: 4d53 3b20 2b2b 6a29 207b 0a20 2020 2020  MS; ++j) {.     
+00085730: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00085740: 656e 736f 722d 3e6e 625b 6a5d 203d 206e  ensor->nb[j] = n
+00085750: 625b 6a5d 3b0a 2020 2020 2020 2020 2020  b[j];.          
+00085760: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00085770: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+00085780: 3e73 7263 3020 3d20 6172 6773 5b30 5d3b  >src0 = args[0];
+00085790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000857a0: 2074 656e 736f 722d 3e73 7263 3120 3d20   tensor->src1 = 
+000857b0: 6172 6773 5b31 5d3b 0a0a 2020 2020 2020  args[1];..      
+000857c0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+000857d0: 6e74 206a 203d 2030 3b20 6a20 3c20 4747  nt j = 0; j < GG
+000857e0: 4d4c 5f4d 4158 5f4f 5054 3b20 2b2b 6a29  ML_MAX_OPT; ++j)
+000857f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00085800: 2020 2020 2020 2074 656e 736f 722d 3e6f         tensor->o
+00085810: 7074 5b6a 5d20 3d20 6172 6773 5b32 202b  pt[j] = args[2 +
+00085820: 206a 5d3b 0a20 2020 2020 2020 2020 2020   j];.           
+00085830: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00085840: 2020 2020 2020 2020 7265 7375 6c74 2e6e          result.n
+00085850: 6f64 6573 5b69 5d20 3d20 7465 6e73 6f72  odes[i] = tensor
+00085860: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00085870: 2020 2066 7072 696e 7466 2873 7464 6572     fprintf(stder
+00085880: 722c 2022 2573 3a20 6c6f 6164 6564 206e  r, "%s: loaded n
+00085890: 6f64 6520 2564 3a20 2725 3136 7327 2c20  ode %d: '%16s', 
+000858a0: 2533 6420 6469 6d73 2c20 2539 7a75 2062  %3d dims, %9zu b
+000858b0: 7974 6573 5c6e 222c 205f 5f66 756e 635f  ytes\n", __func_
+000858c0: 5f2c 2069 2c20 7465 6e73 6f72 2d3e 6e61  _, i, tensor->na
+000858d0: 6d65 2c20 6e5f 6469 6d73 2c20 6767 6d6c  me, n_dims, ggml
+000858e0: 5f6e 6279 7465 7328 7465 6e73 6f72 2929  _nbytes(tensor))
+000858f0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+00085900: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+00085910: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+00085920: 6c74 3b0a 7d0a 0a76 6f69 6420 6767 6d6c  lt;.}..void ggml
+00085930: 5f67 7261 7068 5f70 7269 6e74 2863 6f6e  _graph_print(con
+00085940: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00085950: 6772 6170 6820 2a20 6367 7261 7068 2920  graph * cgraph) 
+00085960: 7b0a 2020 2020 696e 7436 345f 7420 7065  {.    int64_t pe
+00085970: 7266 5f74 6f74 616c 5f70 6572 5f6f 705f  rf_total_per_op_
+00085980: 7573 5b47 474d 4c5f 4f50 5f43 4f55 4e54  us[GGML_OP_COUNT
+00085990: 5d20 3d20 7b30 7d3b 0a0a 2020 2020 4747  ] = {0};..    GG
+000859a0: 4d4c 5f50 5249 4e54 2822 3d3d 3d20 4752  ML_PRINT("=== GR
+000859b0: 4150 4820 3d3d 3d5c 6e22 293b 0a0a 2020  APH ===\n");..  
+000859c0: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
+000859d0: 5547 2822 6e5f 7468 7265 6164 7320 2020  UG("n_threads   
+000859e0: 2020 2020 3d20 2564 5c6e 222c 2020 2020      = %d\n",    
+000859f0: 2020 2020 6367 7261 7068 2d3e 6e5f 7468      cgraph->n_th
+00085a00: 7265 6164 7329 3b0a 2020 2020 4747 4d4c  reads);.    GGML
+00085a10: 5f50 5249 4e54 5f44 4542 5547 2822 746f  _PRINT_DEBUG("to
+00085a20: 7461 6c20 776f 726b 2073 697a 6520 3d20  tal work size = 
+00085a30: 257a 7520 6279 7465 735c 6e22 2c20 6367  %zu bytes\n", cg
+00085a40: 7261 7068 2d3e 776f 726b 5f73 697a 6529  raph->work_size)
+00085a50: 3b0a 0a20 2020 2047 474d 4c5f 5052 494e  ;..    GGML_PRIN
+00085a60: 5428 226e 5f6e 6f64 6573 203d 2025 645c  T("n_nodes = %d\
+00085a70: 6e22 2c20 6367 7261 7068 2d3e 6e5f 6e6f  n", cgraph->n_no
+00085a80: 6465 7329 3b0a 2020 2020 666f 7220 2869  des);.    for (i
+00085a90: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
+00085aa0: 7261 7068 2d3e 6e5f 6e6f 6465 733b 2069  raph->n_nodes; i
+00085ab0: 2b2b 2920 7b0a 2020 2020 2020 2020 7374  ++) {.        st
+00085ac0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00085ad0: 202a 206e 6f64 6520 3d20 6367 7261 7068   * node = cgraph
+00085ae0: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
+00085af0: 2020 2020 2070 6572 665f 746f 7461 6c5f       perf_total_
+00085b00: 7065 725f 6f70 5f75 735b 6e6f 6465 2d3e  per_op_us[node->
+00085b10: 6f70 5d20 2b3d 204d 4158 2831 2c20 6e6f  op] += MAX(1, no
+00085b20: 6465 2d3e 7065 7266 5f74 696d 655f 7573  de->perf_time_us
+00085b30: 293b 0a0a 2020 2020 2020 2020 4747 4d4c  );..        GGML
+00085b40: 5f50 5249 4e54 2822 202d 2025 3364 3a20  _PRINT(" - %3d: 
+00085b50: 5b20 2535 2220 5052 4964 3634 2022 2c20  [ %5" PRId64 ", 
+00085b60: 2535 2220 5052 4964 3634 2022 2c20 2535  %5" PRId64 ", %5
+00085b70: 2220 5052 4964 3634 2022 5d20 2531 3673  " PRId64 "] %16s
+00085b80: 2025 7320 2825 3364 2920 6370 7520 3d20   %s (%3d) cpu = 
+00085b90: 2537 2e33 6620 2f20 2537 2e33 6620 6d73  %7.3f / %7.3f ms
+00085ba0: 2c20 7761 6c6c 203d 2025 372e 3366 202f  , wall = %7.3f /
+00085bb0: 2025 372e 3366 206d 735c 6e22 2c0a 2020   %7.3f ms\n",.  
+00085bc0: 2020 2020 2020 2020 2020 2020 2020 692c                i,
+00085bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00085be0: 206e 6f64 652d 3e6e 655b 305d 2c20 6e6f   node->ne[0], no
+00085bf0: 6465 2d3e 6e65 5b31 5d2c 206e 6f64 652d  de->ne[1], node-
+00085c00: 3e6e 655b 325d 2c0a 2020 2020 2020 2020  >ne[2],.        
+00085c10: 2020 2020 2020 2020 4747 4d4c 5f4f 505f          GGML_OP_
+00085c20: 4e41 4d45 5b6e 6f64 652d 3e6f 705d 2c20  NAME[node->op], 
+00085c30: 6e6f 6465 2d3e 6973 5f70 6172 616d 203f  node->is_param ?
+00085c40: 2022 7822 203a 206e 6f64 652d 3e67 7261   "x" : node->gra
+00085c50: 6420 3f20 2267 2220 3a20 2220 222c 206e  d ? "g" : " ", n
+00085c60: 6f64 652d 3e70 6572 665f 7275 6e73 2c0a  ode->perf_runs,.
+00085c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085c80: 2864 6f75 626c 6529 206e 6f64 652d 3e70  (double) node->p
+00085c90: 6572 665f 6379 636c 6573 2020 2f20 2864  erf_cycles  / (d
+00085ca0: 6f75 626c 6529 2067 676d 6c5f 6379 636c  ouble) ggml_cycl
+00085cb0: 6573 5f70 6572 5f6d 7328 292c 0a20 2020  es_per_ms(),.   
+00085cc0: 2020 2020 2020 2020 2020 2020 2028 646f               (do
+00085cd0: 7562 6c65 2920 6e6f 6465 2d3e 7065 7266  uble) node->perf
+00085ce0: 5f63 7963 6c65 7320 202f 2028 646f 7562  _cycles  / (doub
+00085cf0: 6c65 2920 6767 6d6c 5f63 7963 6c65 735f  le) ggml_cycles_
+00085d00: 7065 725f 6d73 2829 202f 2028 646f 7562  per_ms() / (doub
+00085d10: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f72  le) node->perf_r
+00085d20: 756e 732c 0a20 2020 2020 2020 2020 2020  uns,.           
+00085d30: 2020 2020 2028 646f 7562 6c65 2920 6e6f       (double) no
+00085d40: 6465 2d3e 7065 7266 5f74 696d 655f 7573  de->perf_time_us
+00085d50: 202f 2031 3030 302e 302c 0a20 2020 2020   / 1000.0,.     
+00085d60: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
+00085d70: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f74  le) node->perf_t
+00085d80: 696d 655f 7573 202f 2031 3030 302e 3020  ime_us / 1000.0 
+00085d90: 2f20 6e6f 6465 2d3e 7065 7266 5f72 756e  / node->perf_run
+00085da0: 7329 3b0a 2020 2020 7d0a 0a20 2020 2047  s);.    }..    G
+00085db0: 474d 4c5f 5052 494e 5428 226e 5f6c 6561  GML_PRINT("n_lea
+00085dc0: 6673 203d 2025 645c 6e22 2c20 6367 7261  fs = %d\n", cgra
+00085dd0: 7068 2d3e 6e5f 6c65 6166 7329 3b0a 2020  ph->n_leafs);.  
+00085de0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00085df0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
+00085e00: 6c65 6166 733b 2069 2b2b 2920 7b0a 2020  leafs; i++) {.  
+00085e10: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00085e20: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
+00085e30: 3d20 6367 7261 7068 2d3e 6c65 6166 735b  = cgraph->leafs[
+00085e40: 695d 3b0a 0a20 2020 2020 2020 2047 474d  i];..        GGM
+00085e50: 4c5f 5052 494e 5428 2220 2d20 2533 643a  L_PRINT(" - %3d:
+00085e60: 205b 2025 3522 2050 5249 6436 3420 222c   [ %5" PRId64 ",
+00085e70: 2025 3522 2050 5249 6436 3420 225d 2025   %5" PRId64 "] %
+00085e80: 3873 5c6e 222c 0a20 2020 2020 2020 2020  8s\n",.         
+00085e90: 2020 2020 2020 2069 2c0a 2020 2020 2020         i,.      
+00085ea0: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
+00085eb0: 6e65 5b30 5d2c 206e 6f64 652d 3e6e 655b  ne[0], node->ne[
+00085ec0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+00085ed0: 2020 2020 4747 4d4c 5f4f 505f 4e41 4d45      GGML_OP_NAME
+00085ee0: 5b6e 6f64 652d 3e6f 705d 293b 0a20 2020  [node->op]);.   
+00085ef0: 207d 0a0a 2020 2020 666f 7220 2869 6e74   }..    for (int
+00085f00: 2069 203d 2030 3b20 6920 3c20 4747 4d4c   i = 0; i < GGML
+00085f10: 5f4f 505f 434f 554e 543b 2069 2b2b 2920  _OP_COUNT; i++) 
+00085f20: 7b0a 2020 2020 2020 2020 6966 2028 7065  {.        if (pe
+00085f30: 7266 5f74 6f74 616c 5f70 6572 5f6f 705f  rf_total_per_op_
+00085f40: 7573 5b69 5d20 3d3d 2030 2920 7b0a 2020  us[i] == 0) {.  
+00085f50: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00085f60: 7565 3b0a 2020 2020 2020 2020 7d0a 0a20  ue;.        }.. 
+00085f70: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
+00085f80: 5428 2270 6572 665f 746f 7461 6c5f 7065  T("perf_total_pe
+00085f90: 725f 6f70 5f75 735b 2531 3673 5d20 3d20  r_op_us[%16s] = 
+00085fa0: 2537 2e33 6620 6d73 5c6e 222c 2047 474d  %7.3f ms\n", GGM
+00085fb0: 4c5f 4f50 5f4e 414d 455b 695d 2c20 2864  L_OP_NAME[i], (d
+00085fc0: 6f75 626c 6529 2070 6572 665f 746f 7461  ouble) perf_tota
+00085fd0: 6c5f 7065 725f 6f70 5f75 735b 695d 202f  l_per_op_us[i] /
+00085fe0: 2031 3030 302e 3029 3b0a 2020 2020 7d0a   1000.0);.    }.
+00085ff0: 0a20 2020 2047 474d 4c5f 5052 494e 5428  .    GGML_PRINT(
+00086000: 223d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  "===============
+00086010: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00086020: 3d3d 3d3d 3d3d 3d3d 3d5c 6e22 293b 0a7d  =========\n");.}
+00086030: 0a0a 2f2f 2063 6865 636b 2069 6620 6e6f  ..// check if no
+00086040: 6465 2069 7320 7061 7274 206f 6620 7468  de is part of th
+00086050: 6520 6772 6170 680a 7374 6174 6963 2062  e graph.static b
+00086060: 6f6f 6c20 6767 6d6c 5f67 7261 7068 5f66  ool ggml_graph_f
+00086070: 696e 6428 636f 6e73 7420 7374 7275 6374  ind(const struct
+00086080: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
+00086090: 6772 6170 682c 2063 6f6e 7374 2073 7472  graph, const str
+000860a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000860b0: 2a20 6e6f 6465 2920 7b0a 2020 2020 6966  * node) {.    if
+000860c0: 2028 6367 7261 7068 203d 3d20 4e55 4c4c   (cgraph == NULL
+000860d0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+000860e0: 726e 2074 7275 653b 0a20 2020 207d 0a0a  rn true;.    }..
+000860f0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00086100: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
+00086110: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
+00086120: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
+00086130: 7068 2d3e 6e6f 6465 735b 695d 203d 3d20  ph->nodes[i] == 
+00086140: 6e6f 6465 2920 7b0a 2020 2020 2020 2020  node) {.        
+00086150: 2020 2020 7265 7475 726e 2074 7275 653b      return true;
+00086160: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00086170: 0a0a 2020 2020 7265 7475 726e 2066 616c  ..    return fal
+00086180: 7365 3b0a 7d0a 0a73 7461 7469 6320 7374  se;.}..static st
+00086190: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000861a0: 202a 2067 676d 6c5f 6772 6170 685f 6765   * ggml_graph_ge
+000861b0: 745f 7061 7265 6e74 2863 6f6e 7374 2073  t_parent(const s
+000861c0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+000861d0: 6820 2a20 6367 7261 7068 2c20 636f 6e73  h * cgraph, cons
+000861e0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+000861f0: 6e73 6f72 202a 206e 6f64 6529 207b 0a20  nsor * node) {. 
+00086200: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00086210: 303b 2069 203c 2063 6772 6170 682d 3e6e  0; i < cgraph->n
+00086220: 5f6e 6f64 6573 3b20 692b 2b29 207b 0a20  _nodes; i++) {. 
+00086230: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00086240: 6d6c 5f74 656e 736f 7220 2a20 7061 7265  ml_tensor * pare
+00086250: 6e74 203d 2063 6772 6170 682d 3e6e 6f64  nt = cgraph->nod
+00086260: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
+00086270: 6966 2028 7061 7265 6e74 2d3e 6772 6164  if (parent->grad
+00086280: 203d 3d20 6e6f 6465 2920 7b0a 2020 2020   == node) {.    
+00086290: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+000862a0: 6172 656e 743b 0a20 2020 2020 2020 207d  arent;.        }
+000862b0: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
+000862c0: 726e 204e 554c 4c3b 0a7d 0a0a 766f 6964  rn NULL;.}..void
+000862d0: 2067 676d 6c5f 6772 6170 685f 6475 6d70   ggml_graph_dump
+000862e0: 5f64 6f74 2863 6f6e 7374 2073 7472 7563  _dot(const struc
+000862f0: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+00086300: 6762 2c20 636f 6e73 7420 7374 7275 6374  gb, const struct
+00086310: 2067 676d 6c5f 6367 7261 7068 202a 2067   ggml_cgraph * g
+00086320: 662c 2063 6f6e 7374 2063 6861 7220 2a20  f, const char * 
+00086330: 6669 6c65 6e61 6d65 2920 7b0a 2020 2020  filename) {.    
+00086340: 6368 6172 2063 6f6c 6f72 5b31 365d 3b0a  char color[16];.
+00086350: 0a20 2020 2046 494c 4520 2a20 6670 203d  .    FILE * fp =
+00086360: 2066 6f70 656e 2866 696c 656e 616d 652c   fopen(filename,
+00086370: 2022 7722 293b 0a20 2020 2047 474d 4c5f   "w");.    GGML_
+00086380: 4153 5345 5254 2866 7029 3b0a 0a20 2020  ASSERT(fp);..   
+00086390: 2066 7072 696e 7466 2866 702c 2022 6469   fprintf(fp, "di
+000863a0: 6772 6170 6820 4720 7b5c 6e22 293b 0a20  graph G {\n");. 
+000863b0: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
+000863c0: 2020 6e65 7772 616e 6b20 3d20 7472 7565    newrank = true
+000863d0: 3b5c 6e22 293b 0a20 2020 2066 7072 696e  ;\n");.    fprin
+000863e0: 7466 2866 702c 2022 2020 7261 6e6b 6469  tf(fp, "  rankdi
+000863f0: 7220 3d20 4c52 3b5c 6e22 293b 0a0a 2020  r = LR;\n");..  
+00086400: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00086410: 3b20 6920 3c20 6762 2d3e 6e5f 6e6f 6465  ; i < gb->n_node
+00086420: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
+00086430: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00086440: 6e73 6f72 202a 206e 6f64 6520 3d20 6762  nsor * node = gb
+00086450: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
+00086460: 2020 2020 2069 6620 2867 676d 6c5f 6772       if (ggml_gr
+00086470: 6170 685f 6765 745f 7061 7265 6e74 2867  aph_get_parent(g
+00086480: 622c 206e 6f64 6529 2021 3d20 4e55 4c4c  b, node) != NULL
+00086490: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000864a0: 636f 6e74 696e 7565 3b0a 2020 2020 2020  continue;.      
+000864b0: 2020 7d0a 0a20 2020 2020 2020 2069 6620    }..        if 
+000864c0: 286e 6f64 652d 3e69 735f 7061 7261 6d29  (node->is_param)
+000864d0: 207b 0a20 2020 2020 2020 2020 2020 2073   {.            s
+000864e0: 6e70 7269 6e74 6628 636f 6c6f 722c 2073  nprintf(color, s
+000864f0: 697a 656f 6628 636f 6c6f 7229 2c20 2279  izeof(color), "y
+00086500: 656c 6c6f 7722 293b 0a20 2020 2020 2020  ellow");.       
+00086510: 207d 2065 6c73 6520 6966 2028 6e6f 6465   } else if (node
+00086520: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00086530: 2020 2020 2020 6966 2028 6767 6d6c 5f67        if (ggml_g
+00086540: 7261 7068 5f66 696e 6428 6766 2c20 6e6f  raph_find(gf, no
+00086550: 6465 2929 207b 0a20 2020 2020 2020 2020  de)) {.         
+00086560: 2020 2020 2020 2073 6e70 7269 6e74 6628         snprintf(
+00086570: 636f 6c6f 722c 2073 697a 656f 6628 636f  color, sizeof(co
+00086580: 6c6f 7229 2c20 2267 7265 656e 2229 3b0a  lor), "green");.
+00086590: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+000865a0: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+000865b0: 2020 2020 2073 6e70 7269 6e74 6628 636f       snprintf(co
+000865c0: 6c6f 722c 2073 697a 656f 6628 636f 6c6f  lor, sizeof(colo
+000865d0: 7229 2c20 226c 6967 6874 626c 7565 2229  r), "lightblue")
+000865e0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+000865f0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+00086600: 0a20 2020 2020 2020 2020 2020 2073 6e70  .            snp
+00086610: 7269 6e74 6628 636f 6c6f 722c 2073 697a  rintf(color, siz
+00086620: 656f 6628 636f 6c6f 7229 2c20 2277 6869  eof(color), "whi
+00086630: 7465 2229 3b0a 2020 2020 2020 2020 7d0a  te");.        }.
+00086640: 0a20 2020 2020 2020 2066 7072 696e 7466  .        fprintf
+00086650: 2866 702c 2022 2020 5c22 2570 5c22 205b  (fp, "  \"%p\" [
+00086660: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00086670: 2020 2020 2020 2022 7374 796c 6520 3d20         "style = 
+00086680: 6669 6c6c 6564 3b20 6669 6c6c 636f 6c6f  filled; fillcolo
+00086690: 7220 3d20 2573 3b20 7368 6170 6520 3d20  r = %s; shape = 
+000866a0: 7265 636f 7264 3b20 220a 2020 2020 2020  record; ".      
+000866b0: 2020 2020 2020 2020 2020 2020 2020 226c                "l
+000866c0: 6162 656c 3d5c 2222 2c0a 2020 2020 2020  abel=\"",.      
+000866d0: 2020 2020 2020 2020 2020 2876 6f69 6420            (void 
+000866e0: 2a29 206e 6f64 652c 2063 6f6c 6f72 293b  *) node, color);
+000866f0: 0a0a 2020 2020 2020 2020 6966 2028 7374  ..        if (st
+00086700: 726c 656e 286e 6f64 652d 3e6e 616d 6529  rlen(node->name)
+00086710: 203e 2030 2920 7b0a 2020 2020 2020 2020   > 0) {.        
+00086720: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+00086730: 2225 7320 7c22 2c20 6e6f 6465 2d3e 6e61  "%s |", node->na
+00086740: 6d65 293b 0a20 2020 2020 2020 207d 0a0a  me);.        }..
+00086750: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
+00086760: 2d3e 6e5f 6469 6d73 203d 3d20 3229 207b  ->n_dims == 2) {
+00086770: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
+00086780: 696e 7466 2866 702c 2022 2564 205b 2522  intf(fp, "%d [%"
+00086790: 2050 5249 6436 3420 222c 2025 2220 5052   PRId64 ", %" PR
+000867a0: 4964 3634 2022 5d20 7c20 3c78 3e25 7322  Id64 "] | <x>%s"
+000867b0: 2c20 692c 206e 6f64 652d 3e6e 655b 305d  , i, node->ne[0]
+000867c0: 2c20 6e6f 6465 2d3e 6e65 5b31 5d2c 2047  , node->ne[1], G
+000867d0: 474d 4c5f 4f50 5f53 594d 424f 4c5b 6e6f  GML_OP_SYMBOL[no
+000867e0: 6465 2d3e 6f70 5d29 3b0a 2020 2020 2020  de->op]);.      
+000867f0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00086800: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
+00086810: 702c 2022 2564 205b 2522 2050 5249 6436  p, "%d [%" PRId6
+00086820: 3420 222c 2025 2220 5052 4964 3634 2022  4 ", %" PRId64 "
+00086830: 2c20 2522 2050 5249 6436 3420 225d 207c  , %" PRId64 "] |
+00086840: 203c 783e 2573 222c 2069 2c20 6e6f 6465   <x>%s", i, node
+00086850: 2d3e 6e65 5b30 5d2c 206e 6f64 652d 3e6e  ->ne[0], node->n
+00086860: 655b 315d 2c20 6e6f 6465 2d3e 6e65 5b32  e[1], node->ne[2
+00086870: 5d2c 2047 474d 4c5f 4f50 5f53 594d 424f  ], GGML_OP_SYMBO
+00086880: 4c5b 6e6f 6465 2d3e 6f70 5d29 3b0a 2020  L[node->op]);.  
+00086890: 2020 2020 2020 7d0a 0a0a 2020 2020 2020        }...      
+000868a0: 2020 6966 2028 6e6f 6465 2d3e 6772 6164    if (node->grad
+000868b0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000868c0: 6670 7269 6e74 6628 6670 2c20 2220 7c20  fprintf(fp, " | 
+000868d0: 3c67 3e25 735c 223b 205d 5c6e 222c 2047  <g>%s\"; ]\n", G
+000868e0: 474d 4c5f 4f50 5f53 594d 424f 4c5b 6e6f  GML_OP_SYMBOL[no
+000868f0: 6465 2d3e 6772 6164 2d3e 6f70 5d29 3b0a  de->grad->op]);.
+00086900: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+00086910: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
+00086920: 696e 7466 2866 702c 2022 5c22 3b20 5d5c  intf(fp, "\"; ]\
+00086930: 6e22 293b 0a20 2020 2020 2020 207d 0a20  n");.        }. 
+00086940: 2020 207d 0a0a 2020 2020 666f 7220 2869     }..    for (i
+00086950: 6e74 2069 203d 2030 3b20 6920 3c20 6762  nt i = 0; i < gb
+00086960: 2d3e 6e5f 6c65 6166 733b 2069 2b2b 2920  ->n_leafs; i++) 
+00086970: 7b0a 2020 2020 2020 2020 7374 7275 6374  {.        struct
+00086980: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
+00086990: 6f64 6520 3d20 6762 2d3e 6c65 6166 735b  ode = gb->leafs[
+000869a0: 695d 3b0a 0a20 2020 2020 2020 2073 6e70  i];..        snp
+000869b0: 7269 6e74 6628 636f 6c6f 722c 2073 697a  rintf(color, siz
+000869c0: 656f 6628 636f 6c6f 7229 2c20 2270 696e  eof(color), "pin
+000869d0: 6b22 293b 0a0a 2020 2020 2020 2020 6670  k");..        fp
+000869e0: 7269 6e74 6628 6670 2c20 2220 205c 2225  rintf(fp, "  \"%
+000869f0: 705c 2220 5b20 220a 2020 2020 2020 2020  p\" [ ".        
+00086a00: 2020 2020 2020 2020 2020 2020 2273 7479              "sty
+00086a10: 6c65 203d 2066 696c 6c65 643b 2066 696c  le = filled; fil
+00086a20: 6c63 6f6c 6f72 203d 2025 733b 2073 6861  lcolor = %s; sha
+00086a30: 7065 203d 2072 6563 6f72 643b 2022 0a20  pe = record; ". 
+00086a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086a50: 2020 2022 6c61 6265 6c3d 5c22 3c78 3e22     "label=\"<x>"
+00086a60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00086a70: 2020 2876 6f69 6420 2a29 206e 6f64 652c    (void *) node,
+00086a80: 2063 6f6c 6f72 293b 0a0a 2020 2020 2020   color);..      
+00086a90: 2020 6966 2028 7374 726c 656e 286e 6f64    if (strlen(nod
+00086aa0: 652d 3e6e 616d 6529 203e 2030 2920 7b0a  e->name) > 0) {.
+00086ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00086ac0: 6670 7269 6e74 6628 6670 2c20 2225 7320  fprintf(fp, "%s 
+00086ad0: 7c20 222c 206e 6f64 652d 3e6e 616d 6529  | ", node->name)
+00086ae0: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+00086af0: 2020 2020 6966 2028 6767 6d6c 5f6e 656c      if (ggml_nel
+00086b00: 656d 656e 7473 286e 6f64 6529 203d 3d20  ements(node) == 
+00086b10: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
+00086b20: 2069 6620 286e 6f64 652d 3e74 7970 6520   if (node->type 
+00086b30: 3d3d 2047 474d 4c5f 5459 5045 5f49 3820  == GGML_TYPE_I8 
+00086b40: 7c7c 206e 6f64 652d 3e74 7970 6520 3d3d  || node->type ==
+00086b50: 2047 474d 4c5f 5459 5045 5f49 3136 207c   GGML_TYPE_I16 |
+00086b60: 7c20 6e6f 6465 2d3e 7479 7065 203d 3d20  | node->type == 
+00086b70: 4747 4d4c 5f54 5950 455f 4933 3229 207b  GGML_TYPE_I32) {
+00086b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00086b90: 2066 7072 696e 7466 2866 702c 2022 2564   fprintf(fp, "%d
+00086ba0: 222c 2067 676d 6c5f 6765 745f 6933 325f  ", ggml_get_i32_
+00086bb0: 3164 286e 6f64 652c 2030 2929 3b0a 2020  1d(node, 0));.  
+00086bc0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00086bd0: 2020 2020 2020 2020 656c 7365 207b 0a20          else {. 
+00086be0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00086bf0: 7072 696e 7466 2866 702c 2022 252e 3165  printf(fp, "%.1e
+00086c00: 222c 2028 646f 7562 6c65 2967 676d 6c5f  ", (double)ggml_
+00086c10: 6765 745f 6633 325f 3164 286e 6f64 652c  get_f32_1d(node,
+00086c20: 2030 2929 3b0a 2020 2020 2020 2020 2020   0));.          
+00086c30: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
+00086c40: 2020 2020 2020 656c 7365 207b 0a20 2020        else {.   
+00086c50: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
+00086c60: 2866 702c 2022 434f 4e53 5420 2564 205b  (fp, "CONST %d [
+00086c70: 2522 2050 5249 6436 3420 222c 2025 2220  %" PRId64 ", %" 
+00086c80: 5052 4964 3634 2022 5d22 2c20 692c 206e  PRId64 "]", i, n
+00086c90: 6f64 652d 3e6e 655b 305d 2c20 6e6f 6465  ode->ne[0], node
+00086ca0: 2d3e 6e65 5b31 5d29 3b0a 2020 2020 2020  ->ne[1]);.      
+00086cb0: 2020 7d0a 2020 2020 2020 2020 6670 7269    }.        fpri
+00086cc0: 6e74 6628 6670 2c20 225c 223b 205d 5c6e  ntf(fp, "\"; ]\n
+00086cd0: 2229 3b0a 2020 2020 7d0a 0a20 2020 2066  ");.    }..    f
+00086ce0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00086cf0: 203c 2067 622d 3e6e 5f6e 6f64 6573 3b20   < gb->n_nodes; 
+00086d00: 692b 2b29 207b 0a20 2020 2020 2020 2073  i++) {.        s
+00086d10: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00086d20: 7220 2a20 6e6f 6465 203d 2067 622d 3e6e  r * node = gb->n
+00086d30: 6f64 6573 5b69 5d3b 0a0a 2020 2020 2020  odes[i];..      
+00086d40: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00086d50: 6e73 6f72 202a 2070 6172 656e 7420 3d20  nsor * parent = 
+00086d60: 6767 6d6c 5f67 7261 7068 5f67 6574 5f70  ggml_graph_get_p
+00086d70: 6172 656e 7428 6762 2c20 6e6f 6465 293b  arent(gb, node);
+00086d80: 0a0a 2020 2020 2020 2020 6966 2028 6e6f  ..        if (no
+00086d90: 6465 2d3e 7372 6330 2920 7b0a 2020 2020  de->src0) {.    
+00086da0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00086db0: 676d 6c5f 7465 6e73 6f72 202a 2070 6172  gml_tensor * par
+00086dc0: 656e 7430 203d 2067 676d 6c5f 6772 6170  ent0 = ggml_grap
+00086dd0: 685f 6765 745f 7061 7265 6e74 2867 622c  h_get_parent(gb,
+00086de0: 206e 6f64 652d 3e73 7263 3029 3b0a 0a20   node->src0);.. 
+00086df0: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+00086e00: 7466 2866 702c 2022 2020 5c22 2570 5c22  tf(fp, "  \"%p\"
+00086e10: 3a25 7320 2d3e 205c 2225 705c 223a 2573  :%s -> \"%p\":%s
+00086e20: 205b 2061 7272 6f77 6865 6164 203d 2025   [ arrowhead = %
+00086e30: 733b 2073 7479 6c65 203d 2025 733b 206c  s; style = %s; l
+00086e40: 6162 656c 203d 205c 2278 5c22 3b20 5d5c  abel = \"x\"; ]\
+00086e50: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
+00086e60: 2020 2020 2020 2020 7061 7265 6e74 3020          parent0 
+00086e70: 3f20 2876 6f69 6420 2a29 2070 6172 656e  ? (void *) paren
+00086e80: 7430 203a 2028 766f 6964 202a 2920 6e6f  t0 : (void *) no
+00086e90: 6465 2d3e 7372 6330 2c0a 2020 2020 2020  de->src0,.      
+00086ea0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00086eb0: 7265 6e74 3020 3f20 2267 2220 3a20 2278  rent0 ? "g" : "x
+00086ec0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00086ed0: 2020 2020 2020 2070 6172 656e 7420 3f20         parent ? 
+00086ee0: 2876 6f69 6420 2a29 2070 6172 656e 7420  (void *) parent 
+00086ef0: 3a20 2876 6f69 6420 2a29 206e 6f64 652c  : (void *) node,
+00086f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00086f10: 2020 2020 2070 6172 656e 7420 3f20 2267       parent ? "g
+00086f20: 2220 3a20 2278 222c 0a20 2020 2020 2020  " : "x",.       
+00086f30: 2020 2020 2020 2020 2020 2020 2070 6172               par
+00086f40: 656e 7420 3f20 2265 6d70 7479 2220 3a20  ent ? "empty" : 
+00086f50: 2276 6565 222c 0a20 2020 2020 2020 2020  "vee",.         
+00086f60: 2020 2020 2020 2020 2020 2070 6172 656e             paren
+00086f70: 7420 3f20 2264 6173 6865 6422 203a 2022  t ? "dashed" : "
+00086f80: 736f 6c69 6422 293b 0a20 2020 2020 2020  solid");.       
+00086f90: 207d 0a0a 2020 2020 2020 2020 6966 2028   }..        if (
+00086fa0: 6e6f 6465 2d3e 7372 6331 2920 7b0a 2020  node->src1) {.  
+00086fb0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+00086fc0: 2067 676d 6c5f 7465 6e73 6f72 202a 2070   ggml_tensor * p
+00086fd0: 6172 656e 7431 203d 2067 676d 6c5f 6772  arent1 = ggml_gr
+00086fe0: 6170 685f 6765 745f 7061 7265 6e74 2867  aph_get_parent(g
+00086ff0: 622c 206e 6f64 652d 3e73 7263 3129 3b0a  b, node->src1);.
+00087000: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
+00087010: 696e 7466 2866 702c 2022 2020 5c22 2570  intf(fp, "  \"%p
+00087020: 5c22 3a25 7320 2d3e 205c 2225 705c 223a  \":%s -> \"%p\":
+00087030: 2573 205b 2061 7272 6f77 6865 6164 203d  %s [ arrowhead =
+00087040: 2025 733b 2073 7479 6c65 203d 2025 733b   %s; style = %s;
+00087050: 206c 6162 656c 203d 205c 2279 5c22 3b20   label = \"y\"; 
+00087060: 5d5c 6e22 2c0a 2020 2020 2020 2020 2020  ]\n",.          
+00087070: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
+00087080: 3120 3f20 2876 6f69 6420 2a29 2070 6172  1 ? (void *) par
+00087090: 656e 7431 203a 2028 766f 6964 202a 2920  ent1 : (void *) 
+000870a0: 6e6f 6465 2d3e 7372 6331 2c0a 2020 2020  node->src1,.    
+000870b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000870c0: 7061 7265 6e74 3120 3f20 2267 2220 3a20  parent1 ? "g" : 
+000870d0: 2278 222c 0a20 2020 2020 2020 2020 2020  "x",.           
+000870e0: 2020 2020 2020 2020 2070 6172 656e 7420           parent 
+000870f0: 3f20 2876 6f69 6420 2a29 2070 6172 656e  ? (void *) paren
+00087100: 7420 3a20 2876 6f69 6420 2a29 206e 6f64  t : (void *) nod
+00087110: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00087120: 2020 2020 2020 2070 6172 656e 7420 3f20         parent ? 
+00087130: 2267 2220 3a20 2278 222c 0a20 2020 2020  "g" : "x",.     
+00087140: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00087150: 6172 656e 7420 3f20 2265 6d70 7479 2220  arent ? "empty" 
+00087160: 3a20 2276 6565 222c 0a20 2020 2020 2020  : "vee",.       
+00087170: 2020 2020 2020 2020 2020 2020 2070 6172               par
+00087180: 656e 7420 3f20 2264 6173 6865 6422 203a  ent ? "dashed" :
+00087190: 2022 736f 6c69 6422 293b 0a20 2020 2020   "solid");.     
+000871a0: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
+000871b0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+000871c0: 6920 3c20 6762 2d3e 6e5f 6c65 6166 733b  i < gb->n_leafs;
+000871d0: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+000871e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000871f0: 6f72 202a 206e 6f64 6520 3d20 6762 2d3e  or * node = gb->
+00087200: 6c65 6166 735b 695d 3b0a 0a20 2020 2020  leafs[i];..     
+00087210: 2020 2069 6620 286e 6f64 652d 3e73 7263     if (node->src
+00087220: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+00087230: 2066 7072 696e 7466 2866 702c 2022 2020   fprintf(fp, "  
+00087240: 5c22 2570 5c22 3a25 7320 2d3e 205c 2225  \"%p\":%s -> \"%
+00087250: 705c 223a 2573 205b 206c 6162 656c 203d  p\":%s [ label =
+00087260: 205c 2278 5c22 3b20 5d5c 6e22 2c0a 2020   \"x\"; ]\n",.  
+00087270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087280: 2020 2876 6f69 6420 2a29 206e 6f64 652d    (void *) node-
+00087290: 3e73 7263 302c 2022 7822 2c0a 2020 2020  >src0, "x",.    
+000872a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000872b0: 2876 6f69 6420 2a29 206e 6f64 652c 2022  (void *) node, "
+000872c0: 7822 293b 0a20 2020 2020 2020 207d 0a0a  x");.        }..
+000872d0: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
+000872e0: 2d3e 7372 6331 2920 7b0a 2020 2020 2020  ->src1) {.      
+000872f0: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
+00087300: 2c20 2220 205c 2225 705c 223a 2573 202d  , "  \"%p\":%s -
+00087310: 3e20 5c22 2570 5c22 3a25 7320 5b20 6c61  > \"%p\":%s [ la
+00087320: 6265 6c20 3d20 5c22 795c 223b 205d 5c6e  bel = \"y\"; ]\n
+00087330: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00087340: 2020 2020 2020 2028 766f 6964 202a 2920         (void *) 
+00087350: 6e6f 6465 2d3e 7372 6331 2c20 2278 222c  node->src1, "x",
+00087360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00087370: 2020 2020 2028 766f 6964 202a 2920 6e6f       (void *) no
+00087380: 6465 2c20 2278 2229 3b0a 2020 2020 2020  de, "x");.      
+00087390: 2020 7d0a 2020 2020 7d0a 0a20 2020 2066    }.    }..    f
+000873a0: 7072 696e 7466 2866 702c 2022 7d5c 6e22  printf(fp, "}\n"
+000873b0: 293b 0a0a 2020 2020 6663 6c6f 7365 2866  );..    fclose(f
+000873c0: 7029 3b0a 0a20 2020 2047 474d 4c5f 5052  p);..    GGML_PR
+000873d0: 494e 5428 2225 733a 2064 6f74 202d 5470  INT("%s: dot -Tp
+000873e0: 6e67 2025 7320 2d6f 2025 732e 706e 6720  ng %s -o %s.png 
+000873f0: 2626 206f 7065 6e20 2573 2e70 6e67 5c6e  && open %s.png\n
+00087400: 222c 205f 5f66 756e 635f 5f2c 2066 696c  ", __func__, fil
+00087410: 656e 616d 652c 2066 696c 656e 616d 652c  ename, filename,
+00087420: 2066 696c 656e 616d 6529 3b0a 7d0a 0a2f   filename);.}../
+00087430: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00087440: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00087450: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00087460: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00087470: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
+00087480: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00087490: 6c5f 6f70 745f 7365 745f 7061 7261 6d73  l_opt_set_params
+000874a0: 2869 6e74 206e 702c 2073 7472 7563 7420  (int np, struct 
+000874b0: 6767 6d6c 5f74 656e 736f 7220 2a20 636f  ggml_tensor * co
+000874c0: 6e73 7420 7073 5b5d 2c20 636f 6e73 7420  nst ps[], const 
+000874d0: 666c 6f61 7420 2a20 7829 207b 0a20 2020  float * x) {.   
+000874e0: 2069 6e74 2069 203d 2030 3b0a 2020 2020   int i = 0;.    
+000874f0: 666f 7220 2869 6e74 2070 203d 2030 3b20  for (int p = 0; 
+00087500: 7020 3c20 6e70 3b20 2b2b 7029 207b 0a20  p < np; ++p) {. 
+00087510: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00087520: 3634 5f74 206e 6520 3d20 6767 6d6c 5f6e  64_t ne = ggml_n
+00087530: 656c 656d 656e 7473 2870 735b 705d 2920  elements(ps[p]) 
+00087540: 3b0a 2020 2020 2020 2020 2f2f 2054 4f44  ;.        // TOD
+00087550: 4f3a 2061 6464 2066 756e 6374 696f 6e20  O: add function 
+00087560: 746f 2073 6574 2074 656e 736f 7220 6672  to set tensor fr
+00087570: 6f6d 2061 7272 6179 0a20 2020 2020 2020  om array.       
+00087580: 2066 6f72 2028 696e 7436 345f 7420 6a20   for (int64_t j 
+00087590: 3d20 303b 206a 203c 206e 653b 202b 2b6a  = 0; j < ne; ++j
+000875a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000875b0: 6767 6d6c 5f73 6574 5f66 3332 5f31 6428  ggml_set_f32_1d(
+000875c0: 7073 5b70 5d2c 206a 2c20 785b 692b 2b5d  ps[p], j, x[i++]
+000875d0: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
+000875e0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
+000875f0: 6420 6767 6d6c 5f6f 7074 5f67 6574 5f70  d ggml_opt_get_p
+00087600: 6172 616d 7328 696e 7420 6e70 2c20 7374  arams(int np, st
+00087610: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00087620: 202a 2063 6f6e 7374 2070 735b 5d2c 2066   * const ps[], f
+00087630: 6c6f 6174 202a 2078 2920 7b0a 2020 2020  loat * x) {.    
+00087640: 696e 7420 6920 3d20 303b 0a20 2020 2066  int i = 0;.    f
+00087650: 6f72 2028 696e 7420 7020 3d20 303b 2070  or (int p = 0; p
+00087660: 203c 206e 703b 202b 2b70 2920 7b0a 2020   < np; ++p) {.  
+00087670: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00087680: 345f 7420 6e65 203d 2067 676d 6c5f 6e65  4_t ne = ggml_ne
+00087690: 6c65 6d65 6e74 7328 7073 5b70 5d29 203b  lements(ps[p]) ;
+000876a0: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
+000876b0: 3a20 6164 6420 6675 6e63 7469 6f6e 2074  : add function t
+000876c0: 6f20 6765 7420 616c 6c20 656c 656d 656e  o get all elemen
+000876d0: 7473 2061 7420 6f6e 6365 0a20 2020 2020  ts at once.     
+000876e0: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+000876f0: 6a20 3d20 303b 206a 203c 206e 653b 202b  j = 0; j < ne; +
+00087700: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
+00087710: 2020 785b 692b 2b5d 203d 2067 676d 6c5f    x[i++] = ggml_
+00087720: 6765 745f 6633 325f 3164 2870 735b 705d  get_f32_1d(ps[p]
+00087730: 2c20 6a29 3b0a 2020 2020 2020 2020 7d0a  , j);.        }.
+00087740: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+00087750: 766f 6964 2067 676d 6c5f 6f70 745f 6765  void ggml_opt_ge
+00087760: 745f 6772 6164 2869 6e74 206e 702c 2073  t_grad(int np, s
+00087770: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00087780: 7220 2a20 636f 6e73 7420 7073 5b5d 2c20  r * const ps[], 
+00087790: 666c 6f61 7420 2a20 6729 207b 0a20 2020  float * g) {.   
+000877a0: 2069 6e74 2069 203d 2030 3b0a 2020 2020   int i = 0;.    
+000877b0: 666f 7220 2869 6e74 2070 203d 2030 3b20  for (int p = 0; 
+000877c0: 7020 3c20 6e70 3b20 2b2b 7029 207b 0a20  p < np; ++p) {. 
+000877d0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+000877e0: 3634 5f74 206e 6520 3d20 6767 6d6c 5f6e  64_t ne = ggml_n
+000877f0: 656c 656d 656e 7473 2870 735b 705d 2920  elements(ps[p]) 
+00087800: 3b0a 2020 2020 2020 2020 2f2f 2054 4f44  ;.        // TOD
+00087810: 4f3a 2061 6464 2066 756e 6374 696f 6e20  O: add function 
+00087820: 746f 2067 6574 2061 6c6c 2065 6c65 6d65  to get all eleme
+00087830: 6e74 7320 6174 206f 6e63 650a 2020 2020  nts at once.    
+00087840: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00087850: 206a 203d 2030 3b20 6a20 3c20 6e65 3b20   j = 0; j < ne; 
+00087860: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
+00087870: 2020 2067 5b69 2b2b 5d20 3d20 6767 6d6c     g[i++] = ggml
+00087880: 5f67 6574 5f66 3332 5f31 6428 7073 5b70  _get_f32_1d(ps[p
+00087890: 5d2d 3e67 7261 642c 206a 293b 0a20 2020  ]->grad, j);.   
+000878a0: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
+000878b0: 2f2f 0a2f 2f20 4144 414d 0a2f 2f0a 2f2f  //.// ADAM.//.//
+000878c0: 2020 2072 6566 3a20 6874 7470 733a 2f2f     ref: https://
+000878d0: 6172 7869 762e 6f72 672f 7064 662f 3134  arxiv.org/pdf/14
+000878e0: 3132 2e36 3938 302e 7064 660a 2f2f 0a0a  12.6980.pdf.//..
+000878f0: 7374 6174 6963 2065 6e75 6d20 6767 6d6c  static enum ggml
+00087900: 5f6f 7074 5f72 6573 756c 7420 6767 6d6c  _opt_result ggml
+00087910: 5f6f 7074 5f61 6461 6d28 0a20 2020 2020  _opt_adam(.     
+00087920: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+00087930: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+00087940: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00087950: 6c5f 6f70 745f 636f 6e74 6578 7420 2a20  l_opt_context * 
+00087960: 6f70 742c 0a20 2020 2020 2020 2073 7472  opt,.        str
+00087970: 7563 7420 6767 6d6c 5f6f 7074 5f70 6172  uct ggml_opt_par
+00087980: 616d 7320 7061 7261 6d73 2c0a 2020 2020  ams params,.    
+00087990: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000879a0: 7465 6e73 6f72 202a 2066 2c0a 2020 2020  tensor * f,.    
+000879b0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000879c0: 6367 7261 7068 202a 2067 662c 0a20 2020  cgraph * gf,.   
+000879d0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+000879e0: 5f63 6772 6170 6820 2a20 6762 2920 7b0a  _cgraph * gb) {.
+000879f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00087a00: 6767 6d6c 5f69 735f 7363 616c 6172 2866  ggml_is_scalar(f
+00087a10: 2929 3b0a 0a20 2020 2067 662d 3e6e 5f74  ));..    gf->n_t
+00087a20: 6872 6561 6473 203d 2070 6172 616d 732e  hreads = params.
+00087a30: 6e5f 7468 7265 6164 733b 0a20 2020 2067  n_threads;.    g
+00087a40: 622d 3e6e 5f74 6872 6561 6473 203d 2070  b->n_threads = p
+00087a50: 6172 616d 732e 6e5f 7468 7265 6164 733b  arams.n_threads;
+00087a60: 0a0a 2020 2020 2f2f 2074 6865 7365 2077  ..    // these w
+00087a70: 696c 6c20 7374 6f72 6520 7468 6520 7061  ill store the pa
+00087a80: 7261 6d65 7465 7273 2077 6520 7761 6e74  rameters we want
+00087a90: 2074 6f20 6f70 7469 6d69 7a65 0a20 2020   to optimize.   
+00087aa0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00087ab0: 736f 7220 2a20 7073 5b47 474d 4c5f 4d41  sor * ps[GGML_MA
+00087ac0: 585f 5041 5241 4d53 5d3b 0a0a 2020 2020  X_PARAMS];..    
+00087ad0: 696e 7420 6e70 203d 2030 3b0a 2020 2020  int np = 0;.    
+00087ae0: 696e 7420 6e78 203d 2030 3b0a 2020 2020  int nx = 0;.    
+00087af0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+00087b00: 6920 3c20 6766 2d3e 6e5f 6e6f 6465 733b  i < gf->n_nodes;
+00087b10: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+00087b20: 6966 2028 6766 2d3e 6e6f 6465 735b 695d  if (gf->nodes[i]
+00087b30: 2d3e 6973 5f70 6172 616d 2920 7b0a 2020  ->is_param) {.  
+00087b40: 2020 2020 2020 2020 2020 4747 4d4c 5f50            GGML_P
+00087b50: 5249 4e54 5f44 4542 5547 2822 666f 756e  RINT_DEBUG("foun
+00087b60: 6420 7061 7261 6d20 2564 3a20 6772 6164  d param %d: grad
+00087b70: 2d3e 6f70 203d 2025 645c 6e22 2c20 6e70  ->op = %d\n", np
+00087b80: 2c20 6766 2d3e 6e6f 6465 735b 695d 2d3e  , gf->nodes[i]->
+00087b90: 6772 6164 2d3e 6f70 293b 0a0a 2020 2020  grad->op);..    
+00087ba0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00087bb0: 4552 5428 6e70 203c 2047 474d 4c5f 4d41  ERT(np < GGML_MA
+00087bc0: 585f 5041 5241 4d53 293b 0a0a 2020 2020  X_PARAMS);..    
+00087bd0: 2020 2020 2020 2020 7073 5b6e 702b 2b5d          ps[np++]
+00087be0: 203d 2067 662d 3e6e 6f64 6573 5b69 5d3b   = gf->nodes[i];
+00087bf0: 0a20 2020 2020 2020 2020 2020 206e 7820  .            nx 
+00087c00: 2b3d 2067 676d 6c5f 6e65 6c65 6d65 6e74  += ggml_nelement
+00087c10: 7328 6766 2d3e 6e6f 6465 735b 695d 293b  s(gf->nodes[i]);
+00087c20: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00087c30: 0a0a 2020 2020 6966 2028 286f 7074 2d3e  ..    if ((opt->
+00087c40: 7061 7261 6d73 2e74 7970 6520 213d 2070  params.type != p
+00087c50: 6172 616d 732e 7479 7065 2920 7c7c 2028  arams.type) || (
+00087c60: 6f70 742d 3e6e 7820 213d 206e 7829 207c  opt->nx != nx) |
+00087c70: 7c20 286f 7074 2d3e 7061 7261 6d73 2e70  | (opt->params.p
+00087c80: 6173 7420 213d 2070 6172 616d 732e 7061  ast != params.pa
+00087c90: 7374 2929 207b 0a20 2020 2020 2020 2069  st)) {.        i
+00087ca0: 6e74 2069 7465 7220 3d20 6f70 742d 3e69  nt iter = opt->i
+00087cb0: 7465 723b 0a20 2020 2020 2020 2067 676d  ter;.        ggm
+00087cc0: 6c5f 6f70 745f 696e 6974 286f 7074 2d3e  l_opt_init(opt->
+00087cd0: 6374 782c 206f 7074 2c20 7061 7261 6d73  ctx, opt, params
+00087ce0: 2c20 6e78 293b 0a20 2020 2020 2020 206f  , nx);.        o
+00087cf0: 7074 2d3e 6974 6572 203d 2069 7465 723b  pt->iter = iter;
+00087d00: 0a20 2020 207d 0a0a 2020 2020 2f2f 2063  .    }..    // c
+00087d10: 6f6e 7374 616e 7473 0a20 2020 2063 6f6e  onstants.    con
+00087d20: 7374 2066 6c6f 6174 2073 6368 6564 203d  st float sched =
+00087d30: 2070 6172 616d 732e 6164 616d 2e73 6368   params.adam.sch
+00087d40: 6564 3b0a 2020 2020 636f 6e73 7420 666c  ed;.    const fl
+00087d50: 6f61 7420 6465 6361 7920 3d20 7061 7261  oat decay = para
+00087d60: 6d73 2e61 6461 6d2e 6465 6361 7920 2a20  ms.adam.decay * 
+00087d70: 7363 6865 643b 0a20 2020 2063 6f6e 7374  sched;.    const
+00087d80: 2066 6c6f 6174 2061 6c70 6861 203d 2070   float alpha = p
+00087d90: 6172 616d 732e 6164 616d 2e61 6c70 6861  arams.adam.alpha
+00087da0: 202a 2073 6368 6564 3b0a 2020 2020 636f   * sched;.    co
+00087db0: 6e73 7420 666c 6f61 7420 6265 7461 3120  nst float beta1 
+00087dc0: 3d20 7061 7261 6d73 2e61 6461 6d2e 6265  = params.adam.be
+00087dd0: 7461 313b 0a20 2020 2063 6f6e 7374 2066  ta1;.    const f
+00087de0: 6c6f 6174 2062 6574 6132 203d 2070 6172  loat beta2 = par
+00087df0: 616d 732e 6164 616d 2e62 6574 6132 3b0a  ams.adam.beta2;.
+00087e00: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00087e10: 6570 7320 2020 3d20 7061 7261 6d73 2e61  eps   = params.a
+00087e20: 6461 6d2e 6570 733b 0a0a 2020 2020 666c  dam.eps;..    fl
+00087e30: 6f61 7420 2a20 7820 203d 206f 7074 2d3e  oat * x  = opt->
+00087e40: 6164 616d 2e78 2d3e 6461 7461 3b20 202f  adam.x->data;  /
+00087e50: 2f20 7669 6577 206f 6620 7468 6520 7061  / view of the pa
+00087e60: 7261 6d65 7465 7273 0a20 2020 2066 6c6f  rameters.    flo
+00087e70: 6174 202a 2067 3120 3d20 6f70 742d 3e61  at * g1 = opt->a
+00087e80: 6461 6d2e 6731 2d3e 6461 7461 3b20 2f2f  dam.g1->data; //
+00087e90: 2067 7261 6469 656e 740a 2020 2020 666c   gradient.    fl
+00087ea0: 6f61 7420 2a20 6732 203d 206f 7074 2d3e  oat * g2 = opt->
+00087eb0: 6164 616d 2e67 322d 3e64 6174 613b 202f  adam.g2->data; /
+00087ec0: 2f20 6772 6164 6965 6e74 2073 7175 6172  / gradient squar
+00087ed0: 6564 0a20 2020 2066 6c6f 6174 202a 206d  ed.    float * m
+00087ee0: 2020 3d20 6f70 742d 3e61 6461 6d2e 6d2d    = opt->adam.m-
+00087ef0: 3e64 6174 613b 2020 2f2f 2066 6972 7374  >data;  // first
+00087f00: 206d 6f6d 656e 740a 2020 2020 666c 6f61   moment.    floa
+00087f10: 7420 2a20 7620 203d 206f 7074 2d3e 6164  t * v  = opt->ad
+00087f20: 616d 2e76 2d3e 6461 7461 3b20 202f 2f20  am.v->data;  // 
+00087f30: 7365 636f 6e64 206d 6f6d 656e 740a 2020  second moment.  
+00087f40: 2020 666c 6f61 7420 2a20 6d68 203d 206f    float * mh = o
+00087f50: 7074 2d3e 6164 616d 2e6d 682d 3e64 6174  pt->adam.mh->dat
+00087f60: 613b 202f 2f20 6669 7273 7420 6d6f 6d65  a; // first mome
+00087f70: 6e74 2068 6174 0a20 2020 2066 6c6f 6174  nt hat.    float
+00087f80: 202a 2076 6820 3d20 6f70 742d 3e61 6461   * vh = opt->ada
+00087f90: 6d2e 7668 2d3e 6461 7461 3b20 2f2f 2073  m.vh->data; // s
+00087fa0: 6563 6f6e 6420 6d6f 6d65 6e74 2068 6174  econd moment hat
+00087fb0: 0a0a 2020 2020 666c 6f61 7420 2a20 7066  ..    float * pf
+00087fc0: 203d 2070 6172 616d 732e 7061 7374 203e   = params.past >
+00087fd0: 2030 203f 206f 7074 2d3e 6164 616d 2e70   0 ? opt->adam.p
+00087fe0: 662d 3e64 6174 6120 3a20 4e55 4c4c 3b20  f->data : NULL; 
+00087ff0: 2f2f 2070 6173 7420 6675 6e63 7469 6f6e  // past function
+00088000: 2076 616c 7565 730a 0a20 2020 202f 2f20   values..    // 
+00088010: 7570 6461 7465 2076 6965 770a 2020 2020  update view.    
+00088020: 6767 6d6c 5f6f 7074 5f67 6574 5f70 6172  ggml_opt_get_par
+00088030: 616d 7328 6e70 2c20 7073 2c20 7829 3b0a  ams(np, ps, x);.
+00088040: 0a20 2020 202f 2f20 636f 6d70 7574 6520  .    // compute 
+00088050: 7468 6520 6675 6e63 7469 6f6e 2076 616c  the function val
+00088060: 7565 0a20 2020 2067 676d 6c5f 6772 6170  ue.    ggml_grap
+00088070: 685f 7265 7365 7420 2028 6766 293b 0a20  h_reset  (gf);. 
+00088080: 2020 2067 676d 6c5f 7365 745f 6633 3220     ggml_set_f32 
+00088090: 2020 2020 2028 662d 3e67 7261 642c 2031       (f->grad, 1
+000880a0: 2e30 6629 3b0a 2020 2020 6767 6d6c 5f67  .0f);.    ggml_g
+000880b0: 7261 7068 5f63 6f6d 7075 7465 2863 7478  raph_compute(ctx
+000880c0: 2c20 6762 293b 0a0a 2020 2020 6f70 742d  , gb);..    opt-
+000880d0: 3e61 6461 6d2e 6678 5f70 7265 7620 3d20  >adam.fx_prev = 
+000880e0: 6767 6d6c 5f67 6574 5f66 3332 5f31 6428  ggml_get_f32_1d(
+000880f0: 662c 2030 293b 0a20 2020 206f 7074 2d3e  f, 0);.    opt->
+00088100: 6164 616d 2e66 785f 6265 7374 203d 206f  adam.fx_best = o
+00088110: 7074 2d3e 6164 616d 2e66 785f 7072 6576  pt->adam.fx_prev
+00088120: 3b0a 2020 2020 6966 2028 7066 2920 7b0a  ;.    if (pf) {.
+00088130: 2020 2020 2020 2020 7066 5b6f 7074 2d3e          pf[opt->
+00088140: 6974 6572 2025 2070 6172 616d 732e 7061  iter % params.pa
+00088150: 7374 5d20 3d20 6f70 742d 3e61 6461 6d2e  st] = opt->adam.
+00088160: 6678 5f70 7265 763b 0a20 2020 207d 0a0a  fx_prev;.    }..
+00088170: 2020 2020 2f2f 2069 6e69 7469 616c 697a      // initializ
+00088180: 650a 2020 2020 6966 2028 6f70 742d 3e6a  e.    if (opt->j
+00088190: 7573 745f 696e 6974 6961 6c69 7a65 6429  ust_initialized)
+000881a0: 207b 0a20 2020 2020 2020 206f 7074 2d3e   {.        opt->
+000881b0: 6164 616d 2e6e 5f6e 6f5f 696d 7072 6f76  adam.n_no_improv
+000881c0: 656d 656e 7420 3d20 303b 0a20 2020 2020  ement = 0;.     
+000881d0: 2020 206f 7074 2d3e 6a75 7374 5f69 6e69     opt->just_ini
+000881e0: 7469 616c 697a 6564 203d 2066 616c 7365  tialized = false
+000881f0: 3b0a 2020 2020 7d0a 0a20 2020 2066 6c6f  ;.    }..    flo
+00088200: 6174 202a 2066 785f 6265 7374 203d 2026  at * fx_best = &
+00088210: 6f70 742d 3e61 6461 6d2e 6678 5f62 6573  opt->adam.fx_bes
+00088220: 743b 0a20 2020 2066 6c6f 6174 202a 2066  t;.    float * f
+00088230: 785f 7072 6576 203d 2026 6f70 742d 3e61  x_prev = &opt->a
+00088240: 6461 6d2e 6678 5f70 7265 763b 0a20 2020  dam.fx_prev;.   
+00088250: 2069 6e74 202a 206e 5f6e 6f5f 696d 7072   int * n_no_impr
+00088260: 6f76 656d 656e 7420 3d20 266f 7074 2d3e  ovement = &opt->
+00088270: 6164 616d 2e6e 5f6e 6f5f 696d 7072 6f76  adam.n_no_improv
+00088280: 656d 656e 743b 0a0a 2020 2020 696e 7420  ement;..    int 
+00088290: 6974 6572 3020 3d20 6f70 742d 3e69 7465  iter0 = opt->ite
+000882a0: 723b 0a0a 2020 2020 2f2f 2072 756e 2074  r;..    // run t
+000882b0: 6865 206f 7074 696d 697a 6572 0a20 2020  he optimizer.   
+000882c0: 2066 6f72 2028 696e 7420 7420 3d20 303b   for (int t = 0;
+000882d0: 2074 203c 2070 6172 616d 732e 6164 616d   t < params.adam
+000882e0: 2e6e 5f69 7465 723b 202b 2b74 2920 7b0a  .n_iter; ++t) {.
+000882f0: 2020 2020 2020 2020 6f70 742d 3e69 7465          opt->ite
+00088300: 7220 3d20 6974 6572 3020 2b20 7420 2b20  r = iter0 + t + 
+00088310: 313b 0a20 2020 2020 2020 2047 474d 4c5f  1;.        GGML_
+00088320: 5052 494e 545f 4445 4255 4720 2028 223d  PRINT_DEBUG  ("=
+00088330: 3d3d 2069 7465 7220 2564 203d 3d3d 5c6e  == iter %d ===\n
+00088340: 222c 2074 293b 0a0a 2020 2020 2020 2020  ", t);..        
+00088350: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+00088360: 2020 2822 6620 2020 2020 203d 2025 3130    ("f      = %10
+00088370: 2e36 665c 6e22 2c20 6767 6d6c 5f67 6574  .6f\n", ggml_get
+00088380: 5f66 3332 5f31 6428 662c 2030 2929 3b0a  _f32_1d(f, 0));.
+00088390: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
+000883a0: 4e54 5f44 4542 5547 5f35 2822 6466 2f64  NT_DEBUG_5("df/d
+000883b0: 7830 203d 2025 3130 2e36 665c 6e22 2c20  x0 = %10.6f\n", 
+000883c0: 6767 6d6c 5f67 6574 5f66 3332 5f31 6428  ggml_get_f32_1d(
+000883d0: 7073 5b30 5d2d 3e67 7261 642c 2030 2929  ps[0]->grad, 0))
+000883e0: 3b0a 2020 2020 2020 2020 4747 4d4c 5f50  ;.        GGML_P
+000883f0: 5249 4e54 5f44 4542 5547 5f35 2822 6466  RINT_DEBUG_5("df
+00088400: 2f64 7831 203d 2025 3130 2e36 665c 6e22  /dx1 = %10.6f\n"
+00088410: 2c20 6767 6d6c 5f67 6574 5f66 3332 5f31  , ggml_get_f32_1
+00088420: 6428 7073 5b31 5d2d 3e67 7261 642c 2030  d(ps[1]->grad, 0
+00088430: 2929 3b0a 0a20 2020 2020 2020 2066 6f72  ));..        for
+00088440: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00088450: 206e 703b 202b 2b69 2920 7b0a 2020 2020   np; ++i) {.    
+00088460: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
+00088470: 4e54 5f44 4542 5547 2822 7061 7261 6d20  NT_DEBUG("param 
+00088480: 2564 3a20 2531 302e 3666 2c20 6720 3d20  %d: %10.6f, g = 
+00088490: 2531 302e 3666 5c6e 222c 2069 2c0a 2020  %10.6f\n", i,.  
+000884a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000884b0: 2020 6767 6d6c 5f67 6574 5f66 3332 5f31    ggml_get_f32_1
+000884c0: 6428 7073 5b69 5d2c 2030 292c 2067 676d  d(ps[i], 0), ggm
+000884d0: 6c5f 6765 745f 6633 325f 3164 2870 735b  l_get_f32_1d(ps[
+000884e0: 695d 2d3e 6772 6164 2c20 3029 293b 0a20  i]->grad, 0));. 
+000884f0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00088500: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00088510: 745f 7374 6172 745f 7761 6c6c 203d 2067  t_start_wall = g
+00088520: 676d 6c5f 7469 6d65 5f75 7328 293b 0a20  gml_time_us();. 
+00088530: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00088540: 3634 5f74 2074 5f73 7461 7274 5f63 7075  64_t t_start_cpu
+00088550: 203d 2067 676d 6c5f 6379 636c 6573 2829   = ggml_cycles()
+00088560: 3b0a 2020 2020 2020 2020 554e 5553 4544  ;.        UNUSED
+00088570: 2874 5f73 7461 7274 5f77 616c 6c29 3b0a  (t_start_wall);.
+00088580: 2020 2020 2020 2020 554e 5553 4544 2874          UNUSED(t
+00088590: 5f73 7461 7274 5f63 7075 293b 0a0a 2020  _start_cpu);..  
+000885a0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000885b0: 2020 2020 2f2f 2075 7064 6174 6520 7468      // update th
+000885c0: 6520 6772 6164 6965 6e74 0a20 2020 2020  e gradient.     
+000885d0: 2020 2020 2020 2067 676d 6c5f 6f70 745f         ggml_opt_
+000885e0: 6765 745f 6772 6164 286e 702c 2070 732c  get_grad(np, ps,
+000885f0: 2067 3129 3b0a 0a20 2020 2020 2020 2020   g1);..         
+00088600: 2020 202f 2f20 6d5f 7420 3d20 6265 7461     // m_t = beta
+00088610: 312a 6d5f 742d 3120 2b20 2831 202d 2062  1*m_t-1 + (1 - b
+00088620: 6574 6131 292a 675f 740a 2020 2020 2020  eta1)*g_t.      
+00088630: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+00088640: 6361 6c65 5f66 3332 286e 782c 206d 2c20  cale_f32(nx, m, 
+00088650: 6265 7461 3129 3b0a 2020 2020 2020 2020  beta1);.        
+00088660: 2020 2020 6767 6d6c 5f76 6563 5f6d 6164      ggml_vec_mad
+00088670: 5f66 3332 2020 286e 782c 206d 2c20 6731  _f32  (nx, m, g1
+00088680: 2c20 312e 3066 202d 2062 6574 6131 293b  , 1.0f - beta1);
+00088690: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
+000886a0: 2067 3220 3d20 6731 5e32 0a20 2020 2020   g2 = g1^2.     
+000886b0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+000886c0: 7371 725f 6633 3220 2028 6e78 2c20 6732  sqr_f32  (nx, g2
+000886d0: 2c20 6731 293b 0a0a 2020 2020 2020 2020  , g1);..        
+000886e0: 2020 2020 2f2f 2076 5f74 203d 2062 6574      // v_t = bet
+000886f0: 6132 2a76 5f74 2d31 202b 2028 3120 2d20  a2*v_t-1 + (1 - 
+00088700: 6265 7461 3229 2a67 5f74 5e32 0a20 2020  beta2)*g_t^2.   
+00088710: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+00088720: 635f 7363 616c 655f 6633 3228 6e78 2c20  c_scale_f32(nx, 
+00088730: 762c 2062 6574 6132 293b 0a20 2020 2020  v, beta2);.     
+00088740: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00088750: 6d61 645f 6633 3220 2028 6e78 2c20 762c  mad_f32  (nx, v,
+00088760: 2067 322c 2031 2e30 6620 2d20 6265 7461   g2, 1.0f - beta
+00088770: 3229 3b0a 0a20 2020 2020 2020 2020 2020  2);..           
+00088780: 202f 2f20 6d5e 6861 7420 3d20 6d5f 7420   // m^hat = m_t 
+00088790: 2f20 2831 202d 2062 6574 6131 5e74 290a  / (1 - beta1^t).
+000887a0: 2020 2020 2020 2020 2020 2020 2f2f 2076              // v
+000887b0: 5e68 6174 203d 2076 5f74 202f 2028 3120  ^hat = v_t / (1 
+000887c0: 2d20 6265 7461 325e 7429 0a20 2020 2020  - beta2^t).     
+000887d0: 2020 2020 2020 202f 2f20 785f 7420 3d20         // x_t = 
+000887e0: 785f 742d 3120 2d20 7363 6865 642a 2861  x_t-1 - sched*(a
+000887f0: 6c70 6861 2a6d 5e68 6174 2f28 7371 7274  lpha*m^hat/(sqrt
+00088800: 2876 5e68 6174 2920 2b20 6570 7329 202b  (v^hat) + eps) +
+00088810: 2064 6563 6179 2a78 5f74 2d31 290a 2020   decay*x_t-1).  
+00088820: 2020 2020 2020 2020 2020 2f2f 2078 5f74            // x_t
+00088830: 203d 2078 5f74 2d31 202d 2073 6368 6564   = x_t-1 - sched
+00088840: 2a61 6c70 6861 2a6d 5e68 6174 2f28 7371  *alpha*m^hat/(sq
+00088850: 7274 2876 5e68 6174 2920 2b20 6570 7329  rt(v^hat) + eps)
+00088860: 202d 2073 6368 6564 2a64 6563 6179 2a78   - sched*decay*x
+00088870: 5f74 2d31 0a20 2020 2020 2020 2020 2020  _t-1.           
+00088880: 202f 2f20 785f 7420 3d20 785f 742d 312a   // x_t = x_t-1*
+00088890: 2831 2d73 6368 6564 2a64 6563 6179 2920  (1-sched*decay) 
+000888a0: 2d20 7363 6865 642a 616c 7068 612a 6d5e  - sched*alpha*m^
+000888b0: 6861 742f 2873 7172 7428 765e 6861 7429  hat/(sqrt(v^hat)
+000888c0: 202b 2065 7073 290a 2020 2020 2020 2020   + eps).        
+000888d0: 2020 2020 2f2f 2078 5f74 203d 2078 5f74      // x_t = x_t
+000888e0: 2d31 2a28 312d 7363 6865 642a 6465 6361  -1*(1-sched*deca
+000888f0: 7929 202b 2073 6368 6564 2a64 6563 6179  y) + sched*decay
+00088900: 2a28 2d61 6c70 6861 2f64 6563 6179 292a  *(-alpha/decay)*
+00088910: 6d5e 6861 742f 2873 7172 7428 765e 6861  m^hat/(sqrt(v^ha
+00088920: 7429 202b 2065 7073 290a 2020 2020 2020  t) + eps).      
+00088930: 2020 2020 2020 2f2f 2078 5f74 203d 206d        // x_t = m
+00088940: 6978 2878 5f74 2d31 2c20 282d 616c 7068  ix(x_t-1, (-alph
+00088950: 612f 6465 6361 7929 2a6d 5e68 6174 2f28  a/decay)*m^hat/(
+00088960: 7371 7274 2876 5e68 6174 2920 2b20 6570  sqrt(v^hat) + ep
+00088970: 7329 2c20 7363 6865 642a 6465 6361 7929  s), sched*decay)
+00088980: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+00088990: 6c5f 7665 635f 6370 795f 6633 3220 2028  l_vec_cpy_f32  (
+000889a0: 6e78 2c20 6d68 2c20 6d29 3b0a 2020 2020  nx, mh, m);.    
+000889b0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+000889c0: 5f63 7079 5f66 3332 2020 286e 782c 2076  _cpy_f32  (nx, v
+000889d0: 682c 2076 293b 0a0a 2020 2020 2020 2020  h, v);..        
+000889e0: 2020 2020 6767 6d6c 5f76 6563 5f73 6361      ggml_vec_sca
+000889f0: 6c65 5f66 3332 286e 782c 206d 682c 2061  le_f32(nx, mh, a
+00088a00: 6c70 6861 2f28 312e 3066 202d 2070 6f77  lpha/(1.0f - pow
+00088a10: 6628 6265 7461 312c 206f 7074 2d3e 6974  f(beta1, opt->it
+00088a20: 6572 2929 293b 0a20 2020 2020 2020 2020  er)));.         
+00088a30: 2020 2067 676d 6c5f 7665 635f 7363 616c     ggml_vec_scal
+00088a40: 655f 6633 3228 6e78 2c20 7668 2c20 2031  e_f32(nx, vh,  1
+00088a50: 2e30 662f 2831 2e30 6620 2d20 706f 7766  .0f/(1.0f - powf
+00088a60: 2862 6574 6132 2c20 6f70 742d 3e69 7465  (beta2, opt->ite
+00088a70: 7229 2929 3b0a 0a20 2020 2020 2020 2020  r)));..         
+00088a80: 2020 2067 676d 6c5f 7665 635f 7371 7274     ggml_vec_sqrt
+00088a90: 5f66 3332 2028 6e78 2c20 7668 2c20 7668  _f32 (nx, vh, vh
+00088aa0: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
+00088ab0: 676d 6c5f 7665 635f 6163 6331 5f66 3332  gml_vec_acc1_f32
+00088ac0: 2028 6e78 2c20 7668 2c20 6570 7329 3b0a   (nx, vh, eps);.
+00088ad0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+00088ae0: 6c5f 7665 635f 6469 765f 6633 3220 2028  l_vec_div_f32  (
+00088af0: 6e78 2c20 6d68 2c20 6d68 2c20 7668 293b  nx, mh, mh, vh);
+00088b00: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+00088b10: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
+00088b20: 6e78 2c20 782c 2020 312e 3066 202d 2064  nx, x,  1.0f - d
+00088b30: 6563 6179 293b 0a20 2020 2020 2020 2020  ecay);.         
+00088b40: 2020 2067 676d 6c5f 7665 635f 7375 625f     ggml_vec_sub_
+00088b50: 6633 3220 2028 6e78 2c20 782c 2020 782c  f32  (nx, x,  x,
+00088b60: 2020 6d68 293b 0a0a 2020 2020 2020 2020    mh);..        
+00088b70: 2020 2020 2f2f 2075 7064 6174 6520 7468      // update th
+00088b80: 6520 7061 7261 6d65 7465 7273 0a20 2020  e parameters.   
+00088b90: 2020 2020 2020 2020 2067 676d 6c5f 6f70           ggml_op
+00088ba0: 745f 7365 745f 7061 7261 6d73 286e 702c  t_set_params(np,
+00088bb0: 2070 732c 2078 293b 0a20 2020 2020 2020   ps, x);.       
+00088bc0: 207d 0a0a 2020 2020 2020 2020 6767 6d6c   }..        ggml
+00088bd0: 5f67 7261 7068 5f72 6573 6574 2020 2867  _graph_reset  (g
+00088be0: 6629 3b0a 2020 2020 2020 2020 6767 6d6c  f);.        ggml
+00088bf0: 5f73 6574 5f66 3332 2020 2020 2020 2866  _set_f32      (f
+00088c00: 2d3e 6772 6164 2c20 312e 3066 293b 0a20  ->grad, 1.0f);. 
+00088c10: 2020 2020 2020 2067 676d 6c5f 6772 6170         ggml_grap
+00088c20: 685f 636f 6d70 7574 6528 6374 782c 2067  h_compute(ctx, g
+00088c30: 6229 3b0a 0a20 2020 2020 2020 2063 6f6e  b);..        con
+00088c40: 7374 2066 6c6f 6174 2066 7820 3d20 6767  st float fx = gg
+00088c50: 6d6c 5f67 6574 5f66 3332 5f31 6428 662c  ml_get_f32_1d(f,
+00088c60: 2030 293b 0a0a 2020 2020 2020 2020 2f2f   0);..        //
+00088c70: 2063 6865 636b 2063 6f6e 7665 7267 656e   check convergen
+00088c80: 6365 0a20 2020 2020 2020 2069 6620 2866  ce.        if (f
+00088c90: 6162 7366 2866 7820 2d20 6678 5f70 7265  absf(fx - fx_pre
+00088ca0: 765b 305d 292f 6678 203c 2070 6172 616d  v[0])/fx < param
+00088cb0: 732e 6164 616d 2e65 7073 5f66 2920 7b0a  s.adam.eps_f) {.
+00088cc0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00088cd0: 5f50 5249 4e54 5f44 4542 5547 2822 636f  _PRINT_DEBUG("co
+00088ce0: 6e76 6572 6765 645c 6e22 293b 0a0a 2020  nverged\n");..  
+00088cf0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00088d00: 2047 474d 4c5f 4f50 545f 4f4b 3b0a 2020   GGML_OPT_OK;.  
+00088d10: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00088d20: 202f 2f20 6465 6c74 612d 6261 7365 6420   // delta-based 
+00088d30: 636f 6e76 6572 6765 6e63 6520 7465 7374  convergence test
+00088d40: 0a20 2020 2020 2020 2069 6620 2870 6620  .        if (pf 
+00088d50: 213d 204e 554c 4c29 207b 0a20 2020 2020  != NULL) {.     
+00088d60: 2020 2020 2020 202f 2f20 6e65 6564 2061         // need a
+00088d70: 7420 6c65 6173 7420 7061 7261 6d73 2e70  t least params.p
+00088d80: 6173 7420 6974 6572 6174 696f 6e73 2074  ast iterations t
+00088d90: 6f20 7374 6172 7420 6368 6563 6b69 6e67  o start checking
+00088da0: 2066 6f72 2063 6f6e 7665 7267 656e 6365   for convergence
+00088db0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00088dc0: 2870 6172 616d 732e 7061 7374 203c 3d20  (params.past <= 
+00088dd0: 6974 6572 3020 2b20 7429 207b 0a20 2020  iter0 + t) {.   
+00088de0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00088df0: 7374 2066 6c6f 6174 2072 6174 6520 3d20  st float rate = 
+00088e00: 2870 665b 2869 7465 7230 202b 2074 2925  (pf[(iter0 + t)%
+00088e10: 7061 7261 6d73 2e70 6173 745d 202d 2066  params.past] - f
+00088e20: 7829 2f66 783b 0a0a 2020 2020 2020 2020  x)/fx;..        
+00088e30: 2020 2020 2020 2020 6966 2028 6661 6273          if (fabs
+00088e40: 6628 7261 7465 2920 3c20 7061 7261 6d73  f(rate) < params
+00088e50: 2e64 656c 7461 2920 7b0a 2020 2020 2020  .delta) {.      
+00088e60: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00088e70: 7475 726e 2047 474d 4c5f 4f50 545f 4f4b  turn GGML_OPT_OK
+00088e80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00088e90: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00088ea0: 7d0a 0a20 2020 2020 2020 2020 2020 2070  }..            p
+00088eb0: 665b 2869 7465 7230 202b 2074 2925 7061  f[(iter0 + t)%pa
+00088ec0: 7261 6d73 2e70 6173 745d 203d 2066 783b  rams.past] = fx;
+00088ed0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00088ee0: 2020 2020 2f2f 2063 6865 636b 2066 6f72      // check for
+00088ef0: 2069 6d70 726f 7665 6d65 6e74 0a20 2020   improvement.   
+00088f00: 2020 2020 2069 6620 2870 6172 616d 732e       if (params.
+00088f10: 6d61 785f 6e6f 5f69 6d70 726f 7665 6d65  max_no_improveme
+00088f20: 6e74 203e 2030 2920 7b0a 2020 2020 2020  nt > 0) {.      
+00088f30: 2020 2020 2020 6966 2028 6678 5f62 6573        if (fx_bes
+00088f40: 745b 305d 203e 2066 7829 207b 0a20 2020  t[0] > fx) {.   
+00088f50: 2020 2020 2020 2020 2020 2020 2066 785f               fx_
+00088f60: 6265 7374 5b30 5d20 3d20 6678 3b0a 2020  best[0] = fx;.  
+00088f70: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
+00088f80: 6e6f 5f69 6d70 726f 7665 6d65 6e74 5b30  no_improvement[0
+00088f90: 5d20 3d20 303b 0a20 2020 2020 2020 2020  ] = 0;.         
+00088fa0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+00088fb0: 2020 2020 2020 2020 2020 2020 2b2b 6e5f              ++n_
+00088fc0: 6e6f 5f69 6d70 726f 7665 6d65 6e74 5b30  no_improvement[0
+00088fd0: 5d3b 0a0a 2020 2020 2020 2020 2020 2020  ];..            
+00088fe0: 2020 2020 6966 2028 6e5f 6e6f 5f69 6d70      if (n_no_imp
+00088ff0: 726f 7665 6d65 6e74 5b30 5d20 3e3d 2070  rovement[0] >= p
+00089000: 6172 616d 732e 6d61 785f 6e6f 5f69 6d70  arams.max_no_imp
+00089010: 726f 7665 6d65 6e74 2920 7b0a 2020 2020  rovement) {.    
+00089020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089030: 7265 7475 726e 2047 474d 4c5f 4f50 545f  return GGML_OPT_
+00089040: 4f4b 3b0a 2020 2020 2020 2020 2020 2020  OK;.            
+00089050: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00089060: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
+00089070: 2020 2020 2020 2066 785f 7072 6576 5b30         fx_prev[0
+00089080: 5d20 3d20 6678 3b0a 0a20 2020 2020 2020  ] = fx;..       
+00089090: 207b 0a20 2020 2020 2020 2020 2020 2063   {.            c
+000890a0: 6f6e 7374 2069 6e74 3634 5f74 2074 5f65  onst int64_t t_e
+000890b0: 6e64 5f63 7075 203d 2067 676d 6c5f 6379  nd_cpu = ggml_cy
+000890c0: 636c 6573 2829 3b0a 2020 2020 2020 2020  cles();.        
+000890d0: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
+000890e0: 4542 5547 2822 7469 6d65 2069 7465 723a  EBUG("time iter:
+000890f0: 2020 2020 2020 2535 2e33 6620 735c 6e22        %5.3f s\n"
+00089100: 2c20 2828 666c 6f61 7429 2874 5f65 6e64  , ((float)(t_end
+00089110: 5f63 7075 202d 2074 5f73 7461 7274 5f63  _cpu - t_start_c
+00089120: 7075 2929 2f43 4c4f 434b 535f 5045 525f  pu))/CLOCKS_PER_
+00089130: 5345 4329 3b0a 2020 2020 2020 2020 2020  SEC);.          
+00089140: 2020 554e 5553 4544 2874 5f65 6e64 5f63    UNUSED(t_end_c
+00089150: 7075 293b 0a0a 2020 2020 2020 2020 2020  pu);..          
+00089160: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00089170: 745f 656e 645f 7761 6c6c 203d 2067 676d  t_end_wall = ggm
+00089180: 6c5f 7469 6d65 5f75 7328 293b 0a20 2020  l_time_us();.   
+00089190: 2020 2020 2020 2020 2047 474d 4c5f 5052           GGML_PR
+000891a0: 494e 545f 4445 4255 4728 2277 616c 6c20  INT_DEBUG("wall 
+000891b0: 7469 6d65 2069 7465 723a 2025 352e 3366  time iter: %5.3f
+000891c0: 2073 5c6e 222c 2028 745f 656e 645f 7761   s\n", (t_end_wa
+000891d0: 6c6c 202d 2074 5f73 7461 7274 5f77 616c  ll - t_start_wal
+000891e0: 6c29 2f31 6536 293b 0a20 2020 2020 2020  l)/1e6);.       
+000891f0: 2020 2020 2055 4e55 5345 4428 745f 656e       UNUSED(t_en
+00089200: 645f 7761 6c6c 293b 0a20 2020 2020 2020  d_wall);.       
+00089210: 207d 0a20 2020 207d 0a0a 2020 2020 7265   }.    }..    re
+00089220: 7475 726e 2047 474d 4c5f 4f50 545f 4449  turn GGML_OPT_DI
+00089230: 445f 4e4f 545f 434f 4e56 4552 4745 3b0a  D_NOT_CONVERGE;.
+00089240: 7d0a 0a2f 2f0a 2f2f 204c 2d42 4647 530a  }..//.// L-BFGS.
+00089250: 2f2f 0a2f 2f20 7468 6520 4c2d 4246 4753  //.// the L-BFGS
+00089260: 2069 6d70 6c65 6d65 6e74 6174 696f 6e20   implementation 
+00089270: 6265 6c6f 7720 6973 2062 6173 6564 206f  below is based o
+00089280: 6e20 7468 6520 666f 6c6c 6f77 696e 6720  n the following 
+00089290: 696d 706c 656d 656e 7461 7469 6f6e 3a0a  implementation:.
+000892a0: 2f2f 0a2f 2f20 2020 6874 7470 733a 2f2f  //.//   https://
+000892b0: 6769 7468 7562 2e63 6f6d 2f63 686f 6b6b  github.com/chokk
+000892c0: 616e 2f6c 6962 6c62 6667 730a 2f2f 0a0a  an/liblbfgs.//..
+000892d0: 7374 7275 6374 2067 676d 6c5f 6c62 6667  struct ggml_lbfg
+000892e0: 735f 6974 6572 6174 696f 6e5f 6461 7461  s_iteration_data
+000892f0: 207b 0a20 2020 2066 6c6f 6174 2061 6c70   {.    float alp
+00089300: 6861 3b0a 2020 2020 666c 6f61 7420 7973  ha;.    float ys
+00089310: 3b0a 2020 2020 666c 6f61 7420 2a20 733b  ;.    float * s;
+00089320: 0a20 2020 2066 6c6f 6174 202a 2079 3b0a  .    float * y;.
+00089330: 7d3b 0a0a 7374 6174 6963 2065 6e75 6d20  };..static enum 
+00089340: 6767 6d6c 5f6f 7074 5f72 6573 756c 7420  ggml_opt_result 
+00089350: 6c69 6e65 7365 6172 6368 5f62 6163 6b74  linesearch_backt
+00089360: 7261 636b 696e 6728 0a20 2020 2020 2020  racking(.       
+00089370: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+00089380: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+00089390: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000893a0: 2067 676d 6c5f 6f70 745f 7061 7261 6d73   ggml_opt_params
+000893b0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+000893c0: 2020 2069 6e74 206e 782c 0a20 2020 2020     int nx,.     
+000893d0: 2020 2066 6c6f 6174 202a 2078 2c0a 2020     float * x,.  
+000893e0: 2020 2020 2020 666c 6f61 7420 2a20 6678        float * fx
+000893f0: 2c0a 2020 2020 2020 2020 666c 6f61 7420  ,.        float 
+00089400: 2a20 672c 0a20 2020 2020 2020 2066 6c6f  * g,.        flo
+00089410: 6174 202a 2064 2c0a 2020 2020 2020 2020  at * d,.        
+00089420: 666c 6f61 7420 2a20 7374 6570 2c0a 2020  float * step,.  
+00089430: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+00089440: 7420 2a20 7870 2c0a 2020 2020 2020 2020  t * xp,.        
+00089450: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00089460: 6f72 202a 2066 2c0a 2020 2020 2020 2020  or * f,.        
+00089470: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+00089480: 7068 202a 2067 662c 0a20 2020 2020 2020  ph * gf,.       
+00089490: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
+000894a0: 6170 6820 2a20 6762 2c0a 2020 2020 2020  aph * gb,.      
+000894b0: 2020 636f 6e73 7420 696e 7420 6e70 2c0a    const int np,.
+000894c0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+000894d0: 676d 6c5f 7465 6e73 6f72 202a 2070 735b  gml_tensor * ps[
+000894e0: 5d29 207b 0a20 2020 2069 6e74 2063 6f75  ]) {.    int cou
+000894f0: 6e74 203d 2030 3b0a 0a20 2020 2066 6c6f  nt = 0;..    flo
+00089500: 6174 2077 6964 7468 2020 3d20 302e 3066  at width  = 0.0f
+00089510: 3b0a 2020 2020 666c 6f61 7420 6467 2020  ;.    float dg  
+00089520: 2020 203d 2030 2e30 663b 0a20 2020 2066     = 0.0f;.    f
+00089530: 6c6f 6174 2066 696e 6974 2020 3d20 302e  loat finit  = 0.
+00089540: 3066 3b0a 2020 2020 666c 6f61 7420 6467  0f;.    float dg
+00089550: 696e 6974 203d 2030 2e30 663b 0a20 2020  init = 0.0f;.   
+00089560: 2066 6c6f 6174 2064 6774 6573 7420 3d20   float dgtest = 
+00089570: 302e 3066 3b0a 0a20 2020 2063 6f6e 7374  0.0f;..    const
+00089580: 2066 6c6f 6174 2064 6563 203d 2030 2e35   float dec = 0.5
+00089590: 663b 0a20 2020 2063 6f6e 7374 2066 6c6f  f;.    const flo
+000895a0: 6174 2069 6e63 203d 2032 2e31 663b 0a0a  at inc = 2.1f;..
+000895b0: 2020 2020 6966 2028 2a73 7465 7020 3c3d      if (*step <=
+000895c0: 2030 2e66 2920 7b0a 2020 2020 2020 2020   0.f) {.        
+000895d0: 7265 7475 726e 2047 474d 4c5f 4c49 4e45  return GGML_LINE
+000895e0: 5345 4152 4348 5f49 4e56 414c 4944 5f50  SEARCH_INVALID_P
+000895f0: 4152 414d 4554 4552 533b 0a20 2020 207d  ARAMETERS;.    }
+00089600: 0a0a 2020 2020 2f2f 2063 6f6d 7075 7465  ..    // compute
+00089610: 2074 6865 2069 6e69 7469 616c 2067 7261   the initial gra
+00089620: 6469 656e 7420 696e 2074 6865 2073 6561  dient in the sea
+00089630: 7263 6820 6469 7265 6374 696f 6e0a 2020  rch direction.  
+00089640: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
+00089650: 3332 286e 782c 2026 6467 696e 6974 2c20  32(nx, &dginit, 
+00089660: 672c 2064 293b 0a0a 2020 2020 2f2f 206d  g, d);..    // m
+00089670: 616b 6520 7375 7265 2074 6861 7420 6420  ake sure that d 
+00089680: 706f 696e 7473 2074 6f20 6120 6465 7363  points to a desc
+00089690: 656e 7420 6469 7265 6374 696f 6e0a 2020  ent direction.  
+000896a0: 2020 6966 2028 3020 3c20 6467 696e 6974    if (0 < dginit
+000896b0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+000896c0: 726e 2047 474d 4c5f 4c49 4e45 5345 4152  rn GGML_LINESEAR
+000896d0: 4348 5f46 4149 4c3b 0a20 2020 207d 0a0a  CH_FAIL;.    }..
+000896e0: 2020 2020 2f2f 2069 6e69 7469 616c 697a      // initializ
+000896f0: 6520 6c6f 6361 6c20 7661 7269 6162 6c65  e local variable
+00089700: 730a 2020 2020 6669 6e69 7420 3d20 2a66  s.    finit = *f
+00089710: 783b 0a20 2020 2064 6774 6573 7420 3d20  x;.    dgtest = 
+00089720: 7061 7261 6d73 2d3e 6c62 6667 732e 6674  params->lbfgs.ft
+00089730: 6f6c 2a64 6769 6e69 743b 0a0a 2020 2020  ol*dginit;..    
+00089740: 7768 696c 6520 2874 7275 6529 207b 0a20  while (true) {. 
+00089750: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00089760: 6370 795f 6633 3228 6e78 2c20 782c 2078  cpy_f32(nx, x, x
+00089770: 7029 3b0a 2020 2020 2020 2020 6767 6d6c  p);.        ggml
+00089780: 5f76 6563 5f6d 6164 5f66 3332 286e 782c  _vec_mad_f32(nx,
+00089790: 2078 2c20 642c 202a 7374 6570 293b 0a0a   x, d, *step);..
+000897a0: 2020 2020 2020 2020 2f2f 2065 7661 6c75          // evalu
+000897b0: 6174 6520 7468 6520 6675 6e63 7469 6f6e  ate the function
+000897c0: 2061 6e64 2067 7261 6469 656e 7420 7661   and gradient va
+000897d0: 6c75 6573 0a20 2020 2020 2020 207b 0a20  lues.        {. 
+000897e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000897f0: 6f70 745f 7365 745f 7061 7261 6d73 286e  opt_set_params(n
+00089800: 702c 2070 732c 2078 293b 0a0a 2020 2020  p, ps, x);..    
+00089810: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
+00089820: 7068 5f72 6573 6574 2020 2867 6629 3b0a  ph_reset  (gf);.
+00089830: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00089840: 5f73 6574 5f66 3332 2020 2020 2020 2866  _set_f32      (f
+00089850: 2d3e 6772 6164 2c20 312e 3066 293b 0a20  ->grad, 1.0f);. 
+00089860: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00089870: 6772 6170 685f 636f 6d70 7574 6528 6374  graph_compute(ct
+00089880: 782c 2067 6229 3b0a 0a20 2020 2020 2020  x, gb);..       
+00089890: 2020 2020 2067 676d 6c5f 6f70 745f 6765       ggml_opt_ge
+000898a0: 745f 6772 6164 286e 702c 2070 732c 2067  t_grad(np, ps, g
+000898b0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+000898c0: 2a66 7820 3d20 6767 6d6c 5f67 6574 5f66  *fx = ggml_get_f
+000898d0: 3332 5f31 6428 662c 2030 293b 0a20 2020  32_1d(f, 0);.   
+000898e0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000898f0: 2b2b 636f 756e 743b 0a0a 2020 2020 2020  ++count;..      
+00089900: 2020 6966 2028 2a66 7820 3e20 6669 6e69    if (*fx > fini
+00089910: 7420 2b20 282a 7374 6570 292a 6467 7465  t + (*step)*dgte
+00089920: 7374 2920 7b0a 2020 2020 2020 2020 2020  st) {.          
+00089930: 2020 7769 6474 6820 3d20 6465 633b 0a20    width = dec;. 
+00089940: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+00089950: 2020 2020 2020 2020 2020 2020 2f2f 2041              // A
+00089960: 726d 696a 6f20 636f 6e64 6974 696f 6e20  rmijo condition 
+00089970: 6973 2073 6174 6973 6669 6564 0a20 2020  is satisfied.   
+00089980: 2020 2020 2020 2020 2069 6620 2870 6172           if (par
+00089990: 616d 732d 3e6c 6266 6773 2e6c 696e 6573  ams->lbfgs.lines
+000899a0: 6561 7263 6820 3d3d 2047 474d 4c5f 4c49  earch == GGML_LI
+000899b0: 4e45 5345 4152 4348 5f42 4143 4b54 5241  NESEARCH_BACKTRA
+000899c0: 434b 494e 475f 4152 4d49 4a4f 2920 7b0a  CKING_ARMIJO) {.
+000899d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000899e0: 7265 7475 726e 2063 6f75 6e74 3b0a 2020  return count;.  
+000899f0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00089a00: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+00089a10: 635f 646f 745f 6633 3228 6e78 2c20 2664  c_dot_f32(nx, &d
+00089a20: 672c 2067 2c20 6429 3b0a 0a20 2020 2020  g, g, d);..     
+00089a30: 2020 2020 2020 202f 2f20 6368 6563 6b20         // check 
+00089a40: 7468 6520 576f 6c66 6520 636f 6e64 6974  the Wolfe condit
+00089a50: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+00089a60: 6966 2028 6467 203c 2070 6172 616d 732d  if (dg < params-
+00089a70: 3e6c 6266 6773 2e77 6f6c 6665 202a 2064  >lbfgs.wolfe * d
+00089a80: 6769 6e69 7429 207b 0a20 2020 2020 2020  ginit) {.       
+00089a90: 2020 2020 2020 2020 2077 6964 7468 203d           width =
+00089aa0: 2069 6e63 3b0a 2020 2020 2020 2020 2020   inc;.          
+00089ab0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00089ac0: 2020 2020 2020 2020 2020 2069 6628 7061             if(pa
+00089ad0: 7261 6d73 2d3e 6c62 6667 732e 6c69 6e65  rams->lbfgs.line
+00089ae0: 7365 6172 6368 203d 3d20 4747 4d4c 5f4c  search == GGML_L
+00089af0: 494e 4553 4541 5243 485f 4241 434b 5452  INESEARCH_BACKTR
+00089b00: 4143 4b49 4e47 5f57 4f4c 4645 2920 7b0a  ACKING_WOLFE) {.
+00089b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089b20: 2020 2020 2f2f 2072 6567 756c 6172 2057      // regular W
+00089b30: 6f6c 6665 2063 6f6e 6469 7469 6f6e 730a  olfe conditions.
 00089b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089b50: 7265 7475 726e 2063 6f75 6e74 3b0a 2020  return count;.  
-00089b60: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00089b70: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00089b80: 635f 646f 745f 6633 3228 6e78 2c20 2664  c_dot_f32(nx, &d
-00089b90: 672c 2067 2c20 6429 3b0a 0a20 2020 2020  g, g, d);..     
-00089ba0: 2020 2020 2020 202f 2f20 6368 6563 6b20         // check 
-00089bb0: 7468 6520 576f 6c66 6520 636f 6e64 6974  the Wolfe condit
-00089bc0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-00089bd0: 6966 2028 6467 203c 2070 6172 616d 732d  if (dg < params-
-00089be0: 3e6c 6266 6773 2e77 6f6c 6665 202a 2064  >lbfgs.wolfe * d
-00089bf0: 6769 6e69 7429 207b 0a20 2020 2020 2020  ginit) {.       
-00089c00: 2020 2020 2020 2020 2077 6964 7468 203d           width =
-00089c10: 2069 6e63 3b0a 2020 2020 2020 2020 2020   inc;.          
-00089c20: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-00089c30: 2020 2020 2020 2020 2020 2069 6628 7061             if(pa
-00089c40: 7261 6d73 2d3e 6c62 6667 732e 6c69 6e65  rams->lbfgs.line
-00089c50: 7365 6172 6368 203d 3d20 4747 4d4c 5f4c  search == GGML_L
-00089c60: 494e 4553 4541 5243 485f 4241 434b 5452  INESEARCH_BACKTR
-00089c70: 4143 4b49 4e47 5f57 4f4c 4645 2920 7b0a  ACKING_WOLFE) {.
-00089c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089c90: 2020 2020 2f2f 2072 6567 756c 6172 2057      // regular W
-00089ca0: 6f6c 6665 2063 6f6e 6469 7469 6f6e 730a  olfe conditions.
-00089cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089cc0: 2020 2020 7265 7475 726e 2063 6f75 6e74      return count
-00089cd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00089ce0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-00089cf0: 2020 2020 2069 6628 6467 203e 202d 7061       if(dg > -pa
-00089d00: 7261 6d73 2d3e 6c62 6667 732e 776f 6c66  rams->lbfgs.wolf
-00089d10: 652a 6467 696e 6974 2920 7b0a 2020 2020  e*dginit) {.    
-00089d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089d30: 7769 6474 6820 3d20 6465 633b 0a20 2020  width = dec;.   
-00089d40: 2020 2020 2020 2020 2020 2020 207d 2065               } e
-00089d50: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
-00089d60: 2020 2020 2020 2020 2020 2f2f 2073 7472            // str
-00089d70: 6f6e 6720 576f 6c66 6520 636f 6e64 6974  ong Wolfe condit
-00089d80: 696f 6e20 2847 474d 4c5f 4c49 4e45 5345  ion (GGML_LINESE
-00089d90: 4152 4348 5f42 4143 4b54 5241 434b 494e  ARCH_BACKTRACKIN
-00089da0: 475f 5354 524f 4e47 5f57 4f4c 4645 290a  G_STRONG_WOLFE).
-00089db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089dc0: 2020 2020 7265 7475 726e 2063 6f75 6e74      return count
-00089dd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00089de0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00089df0: 2020 2020 7265 7475 726e 2063 6f75 6e74      return count
-00089e00: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00089e10: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00089e20: 2020 2069 6620 282a 7374 6570 203c 2070     if (*step < p
-00089e30: 6172 616d 732d 3e6c 6266 6773 2e6d 696e  arams->lbfgs.min
-00089e40: 5f73 7465 7029 207b 0a20 2020 2020 2020  _step) {.       
-00089e50: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
-00089e60: 5f4c 494e 4553 4541 5243 485f 4d49 4e49  _LINESEARCH_MINI
-00089e70: 4d55 4d5f 5354 4550 3b0a 2020 2020 2020  MUM_STEP;.      
-00089e80: 2020 7d0a 2020 2020 2020 2020 6966 2028    }.        if (
-00089e90: 2a73 7465 7020 3e20 7061 7261 6d73 2d3e  *step > params->
-00089ea0: 6c62 6667 732e 6d61 785f 7374 6570 2920  lbfgs.max_step) 
-00089eb0: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
-00089ec0: 7475 726e 2047 474d 4c5f 4c49 4e45 5345  turn GGML_LINESE
-00089ed0: 4152 4348 5f4d 4158 494d 554d 5f53 5445  ARCH_MAXIMUM_STE
-00089ee0: 503b 0a20 2020 2020 2020 207d 0a20 2020  P;.        }.   
-00089ef0: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
-00089f00: 3e6c 6266 6773 2e6d 6178 5f6c 696e 6573  >lbfgs.max_lines
-00089f10: 6561 7263 6820 3c3d 2063 6f75 6e74 2920  earch <= count) 
-00089f20: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
-00089f30: 7475 726e 2047 474d 4c5f 4c49 4e45 5345  turn GGML_LINESE
-00089f40: 4152 4348 5f4d 4158 494d 554d 5f49 5445  ARCH_MAXIMUM_ITE
-00089f50: 5241 5449 4f4e 533b 0a20 2020 2020 2020  RATIONS;.       
-00089f60: 207d 0a0a 2020 2020 2020 2020 282a 7374   }..        (*st
-00089f70: 6570 2920 2a3d 2077 6964 7468 3b0a 2020  ep) *= width;.  
-00089f80: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
-00089f90: 4747 4d4c 5f4c 494e 4553 4541 5243 485f  GGML_LINESEARCH_
-00089fa0: 4641 494c 3b0a 7d0a 0a73 7461 7469 6320  FAIL;.}..static 
-00089fb0: 656e 756d 2067 676d 6c5f 6f70 745f 7265  enum ggml_opt_re
-00089fc0: 7375 6c74 2067 676d 6c5f 6f70 745f 6c62  sult ggml_opt_lb
-00089fd0: 6667 7328 0a20 2020 2020 2020 2073 7472  fgs(.        str
-00089fe0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
-00089ff0: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
-0008a000: 7374 7275 6374 2067 676d 6c5f 6f70 745f  struct ggml_opt_
-0008a010: 636f 6e74 6578 7420 2a20 6f70 742c 0a20  context * opt,. 
-0008a020: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0008a030: 6d6c 5f6f 7074 5f70 6172 616d 7320 7061  ml_opt_params pa
-0008a040: 7261 6d73 2c0a 2020 2020 2020 2020 7374  rams,.        st
-0008a050: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0008a060: 202a 2066 2c0a 2020 2020 2020 2020 7374   * f,.        st
-0008a070: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
-0008a080: 202a 2067 662c 0a20 2020 2020 2020 2073   * gf,.        s
-0008a090: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-0008a0a0: 6820 2a20 6762 2920 7b0a 2020 2020 6966  h * gb) {.    if
-0008a0b0: 2028 7061 7261 6d73 2e6c 6266 6773 2e6c   (params.lbfgs.l
-0008a0c0: 696e 6573 6561 7263 6820 3d3d 2047 474d  inesearch == GGM
-0008a0d0: 4c5f 4c49 4e45 5345 4152 4348 5f42 4143  L_LINESEARCH_BAC
-0008a0e0: 4b54 5241 434b 494e 475f 574f 4c46 4520  KTRACKING_WOLFE 
-0008a0f0: 7c7c 0a20 2020 2020 2020 2070 6172 616d  ||.        param
-0008a100: 732e 6c62 6667 732e 6c69 6e65 7365 6172  s.lbfgs.linesear
-0008a110: 6368 203d 3d20 4747 4d4c 5f4c 494e 4553  ch == GGML_LINES
-0008a120: 4541 5243 485f 4241 434b 5452 4143 4b49  EARCH_BACKTRACKI
-0008a130: 4e47 5f53 5452 4f4e 475f 574f 4c46 4529  NG_STRONG_WOLFE)
-0008a140: 207b 0a20 2020 2020 2020 2069 6620 2870   {.        if (p
-0008a150: 6172 616d 732e 6c62 6667 732e 776f 6c66  arams.lbfgs.wolf
-0008a160: 6520 3c3d 2070 6172 616d 732e 6c62 6667  e <= params.lbfg
-0008a170: 732e 6674 6f6c 207c 7c20 312e 6620 3c3d  s.ftol || 1.f <=
-0008a180: 2070 6172 616d 732e 6c62 6667 732e 776f   params.lbfgs.wo
-0008a190: 6c66 6529 207b 0a20 2020 2020 2020 2020  lfe) {.         
-0008a1a0: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
-0008a1b0: 5054 5f49 4e56 414c 4944 5f57 4f4c 4645  PT_INVALID_WOLFE
-0008a1c0: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-0008a1d0: 7d0a 0a20 2020 2067 662d 3e6e 5f74 6872  }..    gf->n_thr
-0008a1e0: 6561 6473 203d 2070 6172 616d 732e 6e5f  eads = params.n_
-0008a1f0: 7468 7265 6164 733b 0a20 2020 2067 622d  threads;.    gb-
-0008a200: 3e6e 5f74 6872 6561 6473 203d 2070 6172  >n_threads = par
-0008a210: 616d 732e 6e5f 7468 7265 6164 733b 0a0a  ams.n_threads;..
-0008a220: 2020 2020 636f 6e73 7420 696e 7420 6d20      const int m 
-0008a230: 3d20 7061 7261 6d73 2e6c 6266 6773 2e6d  = params.lbfgs.m
-0008a240: 3b0a 0a20 2020 202f 2f20 7468 6573 6520  ;..    // these 
-0008a250: 7769 6c6c 2073 746f 7265 2074 6865 2070  will store the p
-0008a260: 6172 616d 6574 6572 7320 7765 2077 616e  arameters we wan
-0008a270: 7420 746f 206f 7074 696d 697a 650a 2020  t to optimize.  
-0008a280: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0008a290: 6e73 6f72 202a 2070 735b 4747 4d4c 5f4d  nsor * ps[GGML_M
-0008a2a0: 4158 5f50 4152 414d 535d 3b0a 0a20 2020  AX_PARAMS];..   
-0008a2b0: 2069 6e74 206e 7020 3d20 303b 0a20 2020   int np = 0;.   
-0008a2c0: 2069 6e74 206e 7820 3d20 303b 0a20 2020   int nx = 0;.   
-0008a2d0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0008a2e0: 2069 203c 2067 662d 3e6e 5f6e 6f64 6573   i < gf->n_nodes
-0008a2f0: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-0008a300: 2069 6620 2867 662d 3e6e 6f64 6573 5b69   if (gf->nodes[i
-0008a310: 5d2d 3e69 735f 7061 7261 6d29 207b 0a20  ]->is_param) {. 
-0008a320: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0008a330: 5052 494e 545f 4445 4255 4728 2266 6f75  PRINT_DEBUG("fou
-0008a340: 6e64 2070 6172 616d 2025 643a 2067 7261  nd param %d: gra
-0008a350: 642d 3e6f 7020 3d20 2564 5c6e 222c 206e  d->op = %d\n", n
-0008a360: 702c 2067 662d 3e6e 6f64 6573 5b69 5d2d  p, gf->nodes[i]-
-0008a370: 3e67 7261 642d 3e6f 7029 3b0a 0a20 2020  >grad->op);..   
-0008a380: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-0008a390: 5345 5254 286e 7020 3c20 4747 4d4c 5f4d  SERT(np < GGML_M
-0008a3a0: 4158 5f50 4152 414d 5329 3b0a 0a20 2020  AX_PARAMS);..   
-0008a3b0: 2020 2020 2020 2020 2070 735b 6e70 2b2b           ps[np++
-0008a3c0: 5d20 3d20 6766 2d3e 6e6f 6465 735b 695d  ] = gf->nodes[i]
-0008a3d0: 3b0a 2020 2020 2020 2020 2020 2020 6e78  ;.            nx
-0008a3e0: 202b 3d20 6767 6d6c 5f6e 656c 656d 656e   += ggml_nelemen
-0008a3f0: 7473 2867 662d 3e6e 6f64 6573 5b69 5d29  ts(gf->nodes[i])
-0008a400: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-0008a410: 7d0a 0a20 2020 2069 6620 2828 6f70 742d  }..    if ((opt-
-0008a420: 3e70 6172 616d 732e 7479 7065 2021 3d20  >params.type != 
-0008a430: 7061 7261 6d73 2e74 7970 6529 207c 7c20  params.type) || 
-0008a440: 286f 7074 2d3e 6e78 2021 3d20 6e78 2920  (opt->nx != nx) 
-0008a450: 7c7c 2028 6f70 742d 3e70 6172 616d 732e  || (opt->params.
-0008a460: 7061 7374 2021 3d20 7061 7261 6d73 2e70  past != params.p
-0008a470: 6173 7429 207c 7c20 286f 7074 2d3e 7061  ast) || (opt->pa
-0008a480: 7261 6d73 2e6c 6266 6773 2e6d 2021 3d20  rams.lbfgs.m != 
-0008a490: 7061 7261 6d73 2e6c 6266 6773 2e6d 2929  params.lbfgs.m))
-0008a4a0: 207b 0a20 2020 2020 2020 2069 6e74 2069   {.        int i
-0008a4b0: 7465 7220 3d20 6f70 742d 3e69 7465 723b  ter = opt->iter;
-0008a4c0: 0a20 2020 2020 2020 2067 676d 6c5f 6f70  .        ggml_op
-0008a4d0: 745f 696e 6974 2863 7478 2c20 6f70 742c  t_init(ctx, opt,
-0008a4e0: 2070 6172 616d 732c 206e 7829 3b0a 2020   params, nx);.  
-0008a4f0: 2020 2020 2020 6f70 742d 3e69 7465 7220        opt->iter 
-0008a500: 3d20 6974 6572 3b0a 2020 2020 7d0a 0a20  = iter;.    }.. 
-0008a510: 2020 2066 6c6f 6174 202a 2078 2020 3d20     float * x  = 
-0008a520: 6f70 742d 3e6c 6266 6773 2e78 2d3e 6461  opt->lbfgs.x->da
-0008a530: 7461 3b20 202f 2f20 6375 7272 656e 7420  ta;  // current 
-0008a540: 7061 7261 6d65 7465 7273 0a20 2020 2066  parameters.    f
-0008a550: 6c6f 6174 202a 2078 7020 3d20 6f70 742d  loat * xp = opt-
-0008a560: 3e6c 6266 6773 2e78 702d 3e64 6174 613b  >lbfgs.xp->data;
-0008a570: 202f 2f20 7072 6576 696f 7573 2070 6172   // previous par
-0008a580: 616d 6574 6572 730a 2020 2020 666c 6f61  ameters.    floa
-0008a590: 7420 2a20 6720 203d 206f 7074 2d3e 6c62  t * g  = opt->lb
-0008a5a0: 6667 732e 672d 3e64 6174 613b 2020 2f2f  fgs.g->data;  //
-0008a5b0: 2063 7572 7265 6e74 2067 7261 6469 656e   current gradien
-0008a5c0: 740a 2020 2020 666c 6f61 7420 2a20 6770  t.    float * gp
-0008a5d0: 203d 206f 7074 2d3e 6c62 6667 732e 6770   = opt->lbfgs.gp
-0008a5e0: 2d3e 6461 7461 3b20 2f2f 2070 7265 7669  ->data; // previ
-0008a5f0: 6f75 7320 6772 6164 6965 6e74 0a20 2020  ous gradient.   
-0008a600: 2066 6c6f 6174 202a 2064 2020 3d20 6f70   float * d  = op
-0008a610: 742d 3e6c 6266 6773 2e64 2d3e 6461 7461  t->lbfgs.d->data
-0008a620: 3b20 202f 2f20 7365 6172 6368 2064 6972  ;  // search dir
-0008a630: 6563 7469 6f6e 0a0a 2020 2020 666c 6f61  ection..    floa
-0008a640: 7420 2a20 7066 203d 2070 6172 616d 732e  t * pf = params.
-0008a650: 7061 7374 203e 2030 203f 206f 7074 2d3e  past > 0 ? opt->
-0008a660: 6c62 6667 732e 7066 2d3e 6461 7461 203a  lbfgs.pf->data :
-0008a670: 204e 554c 4c3b 202f 2f20 7061 7374 2066   NULL; // past f
-0008a680: 756e 6374 696f 6e20 7661 6c75 6573 0a0a  unction values..
-0008a690: 2020 2020 666c 6f61 7420 6678 2020 2020      float fx    
-0008a6a0: 3d20 302e 3066 3b20 2f2f 2063 6f73 7420  = 0.0f; // cost 
-0008a6b0: 6675 6e63 7469 6f6e 2076 616c 7565 0a20  function value. 
-0008a6c0: 2020 2066 6c6f 6174 2078 6e6f 726d 203d     float xnorm =
-0008a6d0: 2030 2e30 663b 202f 2f20 7c7c 787c 7c0a   0.0f; // ||x||.
-0008a6e0: 2020 2020 666c 6f61 7420 676e 6f72 6d20      float gnorm 
-0008a6f0: 3d20 302e 3066 3b20 2f2f 207c 7c67 7c7c  = 0.0f; // ||g||
-0008a700: 0a0a 2020 2020 2f2f 2069 6e69 7469 616c  ..    // initial
-0008a710: 697a 6520 7820 6672 6f6d 2074 6865 2067  ize x from the g
-0008a720: 7261 7068 206e 6f64 6573 0a20 2020 2067  raph nodes.    g
-0008a730: 676d 6c5f 6f70 745f 6765 745f 7061 7261  gml_opt_get_para
-0008a740: 6d73 286e 702c 2070 732c 2078 293b 0a0a  ms(np, ps, x);..
-0008a750: 2020 2020 2f2f 2074 6865 204c 2d42 4647      // the L-BFG
-0008a760: 5320 6d65 6d6f 7279 0a20 2020 2066 6c6f  S memory.    flo
-0008a770: 6174 202a 206c 6d5f 616c 7068 6120 3d20  at * lm_alpha = 
-0008a780: 6f70 742d 3e6c 6266 6773 2e6c 6d61 6c2d  opt->lbfgs.lmal-
-0008a790: 3e64 6174 613b 0a20 2020 2066 6c6f 6174  >data;.    float
-0008a7a0: 202a 206c 6d5f 7973 2020 2020 3d20 6f70   * lm_ys    = op
-0008a7b0: 742d 3e6c 6266 6773 2e6c 6d79 732d 3e64  t->lbfgs.lmys->d
-0008a7c0: 6174 613b 0a20 2020 2066 6c6f 6174 202a  ata;.    float *
-0008a7d0: 206c 6d5f 7320 2020 2020 3d20 6f70 742d   lm_s     = opt-
-0008a7e0: 3e6c 6266 6773 2e6c 6d73 2d3e 6461 7461  >lbfgs.lms->data
-0008a7f0: 3b0a 2020 2020 666c 6f61 7420 2a20 6c6d  ;.    float * lm
-0008a800: 5f79 2020 2020 203d 206f 7074 2d3e 6c62  _y     = opt->lb
-0008a810: 6667 732e 6c6d 792d 3e64 6174 613b 0a0a  fgs.lmy->data;..
-0008a820: 2020 2020 2f2f 2065 7661 6c75 6174 6520      // evaluate 
-0008a830: 7468 6520 6675 6e63 7469 6f6e 2076 616c  the function val
-0008a840: 7565 2061 6e64 2069 7473 2067 7261 6469  ue and its gradi
-0008a850: 656e 740a 2020 2020 7b0a 2020 2020 2020  ent.    {.      
-0008a860: 2020 6767 6d6c 5f6f 7074 5f73 6574 5f70    ggml_opt_set_p
-0008a870: 6172 616d 7328 6e70 2c20 7073 2c20 7829  arams(np, ps, x)
-0008a880: 3b0a 0a20 2020 2020 2020 2067 676d 6c5f  ;..        ggml_
-0008a890: 6772 6170 685f 7265 7365 7420 2028 6766  graph_reset  (gf
-0008a8a0: 293b 0a20 2020 2020 2020 2067 676d 6c5f  );.        ggml_
-0008a8b0: 7365 745f 6633 3220 2020 2020 2028 662d  set_f32      (f-
-0008a8c0: 3e67 7261 642c 2031 2e30 6629 3b0a 2020  >grad, 1.0f);.  
-0008a8d0: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-0008a8e0: 5f63 6f6d 7075 7465 2863 7478 2c20 6762  _compute(ctx, gb
-0008a8f0: 293b 0a0a 2020 2020 2020 2020 6767 6d6c  );..        ggml
-0008a900: 5f6f 7074 5f67 6574 5f67 7261 6428 6e70  _opt_get_grad(np
-0008a910: 2c20 7073 2c20 6729 3b0a 0a20 2020 2020  , ps, g);..     
-0008a920: 2020 2066 7820 3d20 6767 6d6c 5f67 6574     fx = ggml_get
-0008a930: 5f66 3332 5f31 6428 662c 2030 293b 0a20  _f32_1d(f, 0);. 
-0008a940: 2020 207d 0a0a 2020 2020 2f2f 2073 6561     }..    // sea
-0008a950: 7263 6820 6469 7265 6374 696f 6e20 3d20  rch direction = 
-0008a960: 2d67 7261 6469 656e 740a 2020 2020 6767  -gradient.    gg
-0008a970: 6d6c 5f76 6563 5f6e 6567 5f66 3332 286e  ml_vec_neg_f32(n
-0008a980: 782c 2064 2c20 6729 3b0a 0a20 2020 202f  x, d, g);..    /
-0008a990: 2f20 7c7c 787c 7c2c 207c 7c67 7c7c 0a20  / ||x||, ||g||. 
-0008a9a0: 2020 2067 676d 6c5f 7665 635f 6e6f 726d     ggml_vec_norm
-0008a9b0: 5f66 3332 286e 782c 2026 786e 6f72 6d2c  _f32(nx, &xnorm,
-0008a9c0: 2078 293b 0a20 2020 2067 676d 6c5f 7665   x);.    ggml_ve
-0008a9d0: 635f 6e6f 726d 5f66 3332 286e 782c 2026  c_norm_f32(nx, &
-0008a9e0: 676e 6f72 6d2c 2067 293b 0a0a 2020 2020  gnorm, g);..    
-0008a9f0: 6966 2028 786e 6f72 6d20 3c20 312e 3066  if (xnorm < 1.0f
-0008aa00: 2920 7b0a 2020 2020 2020 2020 786e 6f72  ) {.        xnor
-0008aa10: 6d20 3d20 312e 3066 3b0a 2020 2020 7d0a  m = 1.0f;.    }.
-0008aa20: 0a20 2020 202f 2f20 616c 7265 6164 7920  .    // already 
-0008aa30: 6f70 7469 6d69 7a65 640a 2020 2020 6966  optimized.    if
-0008aa40: 2028 676e 6f72 6d2f 786e 6f72 6d20 3c3d   (gnorm/xnorm <=
-0008aa50: 2070 6172 616d 732e 6c62 6667 732e 6570   params.lbfgs.ep
-0008aa60: 7329 207b 0a20 2020 2020 2020 2072 6574  s) {.        ret
-0008aa70: 7572 6e20 4747 4d4c 5f4f 5054 5f4f 4b3b  urn GGML_OPT_OK;
-0008aa80: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-0008aa90: 6f70 742d 3e6a 7573 745f 696e 6974 6961  opt->just_initia
-0008aaa0: 6c69 7a65 6429 207b 0a20 2020 2020 2020  lized) {.       
-0008aab0: 2069 6620 2870 6629 207b 0a20 2020 2020   if (pf) {.     
-0008aac0: 2020 2020 2020 2070 665b 305d 203d 2066         pf[0] = f
-0008aad0: 783b 0a20 2020 2020 2020 207d 0a20 2020  x;.        }.   
-0008aae0: 2020 2020 206f 7074 2d3e 6c62 6667 732e       opt->lbfgs.
-0008aaf0: 6678 5f62 6573 7420 3d20 6678 3b0a 0a20  fx_best = fx;.. 
-0008ab00: 2020 2020 2020 202f 2f20 696e 6974 6961         // initia
-0008ab10: 6c20 7374 6570 0a20 2020 2020 2020 2067  l step.        g
-0008ab20: 676d 6c5f 7665 635f 6e6f 726d 5f69 6e76  gml_vec_norm_inv
-0008ab30: 5f66 3332 286e 782c 2026 6f70 742d 3e6c  _f32(nx, &opt->l
-0008ab40: 6266 6773 2e73 7465 702c 2064 293b 0a20  bfgs.step, d);. 
-0008ab50: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
-0008ab60: 732e 6a20 2020 2020 2020 2020 2020 2020  s.j             
-0008ab70: 2020 203d 2030 3b0a 2020 2020 2020 2020     = 0;.        
-0008ab80: 6f70 742d 3e6c 6266 6773 2e6b 2020 2020  opt->lbfgs.k    
-0008ab90: 2020 2020 2020 2020 2020 2020 3d20 313b              = 1;
-0008aba0: 0a20 2020 2020 2020 206f 7074 2d3e 6c62  .        opt->lb
-0008abb0: 6667 732e 656e 6420 2020 2020 2020 2020  fgs.end         
-0008abc0: 2020 2020 203d 2030 3b0a 2020 2020 2020       = 0;.      
-0008abd0: 2020 6f70 742d 3e6c 6266 6773 2e6e 5f6e    opt->lbfgs.n_n
-0008abe0: 6f5f 696d 7072 6f76 656d 656e 7420 3d20  o_improvement = 
-0008abf0: 303b 0a20 2020 2020 2020 206f 7074 2d3e  0;.        opt->
-0008ac00: 6a75 7374 5f69 6e69 7469 616c 697a 6564  just_initialized
-0008ac10: 2020 2020 2020 203d 2066 616c 7365 3b0a         = false;.
-0008ac20: 2020 2020 7d0a 0a20 2020 2066 6c6f 6174      }..    float
-0008ac30: 202a 2066 785f 6265 7374 2020 2020 2020   * fx_best      
-0008ac40: 2020 3d20 266f 7074 2d3e 6c62 6667 732e    = &opt->lbfgs.
-0008ac50: 6678 5f62 6573 743b 0a20 2020 2066 6c6f  fx_best;.    flo
-0008ac60: 6174 202a 2073 7465 7020 2020 2020 2020  at * step       
-0008ac70: 2020 2020 3d20 266f 7074 2d3e 6c62 6667      = &opt->lbfg
-0008ac80: 732e 7374 6570 3b0a 2020 2020 696e 7420  s.step;.    int 
-0008ac90: 2a20 6a20 2020 2020 2020 2020 2020 2020  * j             
-0008aca0: 2020 203d 2026 6f70 742d 3e6c 6266 6773     = &opt->lbfgs
-0008acb0: 2e6a 3b0a 2020 2020 696e 7420 2a20 6b20  .j;.    int * k 
-0008acc0: 2020 2020 2020 2020 2020 2020 2020 203d                 =
-0008acd0: 2026 6f70 742d 3e6c 6266 6773 2e6b 3b0a   &opt->lbfgs.k;.
-0008ace0: 2020 2020 696e 7420 2a20 656e 6420 2020      int * end   
-0008acf0: 2020 2020 2020 2020 2020 203d 2026 6f70             = &op
-0008ad00: 742d 3e6c 6266 6773 2e65 6e64 3b0a 2020  t->lbfgs.end;.  
-0008ad10: 2020 696e 7420 2a20 6e5f 6e6f 5f69 6d70    int * n_no_imp
-0008ad20: 726f 7665 6d65 6e74 203d 2026 6f70 742d  rovement = &opt-
-0008ad30: 3e6c 6266 6773 2e6e 5f6e 6f5f 696d 7072  >lbfgs.n_no_impr
-0008ad40: 6f76 656d 656e 743b 0a0a 2020 2020 696e  ovement;..    in
-0008ad50: 7420 6c73 2020 2020 203d 2030 3b0a 2020  t ls     = 0;.  
-0008ad60: 2020 696e 7420 626f 756e 6420 203d 2030    int bound  = 0
-0008ad70: 3b0a 0a20 2020 2066 6c6f 6174 2079 7320  ;..    float ys 
-0008ad80: 2020 3d20 302e 3066 3b0a 2020 2020 666c    = 0.0f;.    fl
-0008ad90: 6f61 7420 7979 2020 203d 2030 2e30 663b  oat yy   = 0.0f;
-0008ada0: 0a20 2020 2066 6c6f 6174 2062 6574 6120  .    float beta 
-0008adb0: 3d20 302e 3066 3b0a 0a20 2020 2069 6e74  = 0.0f;..    int
-0008adc0: 2069 7420 3d20 303b 0a0a 2020 2020 7768   it = 0;..    wh
-0008add0: 696c 6520 2874 7275 6529 207b 0a20 2020  ile (true) {.   
-0008ade0: 2020 2020 202f 2f20 7374 6f72 6520 7468       // store th
-0008adf0: 6520 6375 7272 656e 7420 706f 7369 7469  e current positi
-0008ae00: 6f6e 2061 6e64 2067 7261 6469 656e 7420  on and gradient 
-0008ae10: 7665 6374 6f72 730a 2020 2020 2020 2020  vectors.        
-0008ae20: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
-0008ae30: 286e 782c 2078 702c 2078 293b 0a20 2020  (nx, xp, x);.   
-0008ae40: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
-0008ae50: 795f 6633 3228 6e78 2c20 6770 2c20 6729  y_f32(nx, gp, g)
-0008ae60: 3b0a 0a20 2020 2020 2020 206c 7320 3d20  ;..        ls = 
-0008ae70: 6c69 6e65 7365 6172 6368 5f62 6163 6b74  linesearch_backt
-0008ae80: 7261 636b 696e 6728 6374 782c 2026 7061  racking(ctx, &pa
-0008ae90: 7261 6d73 2c20 6e78 2c20 782c 2026 6678  rams, nx, x, &fx
-0008aea0: 2c20 672c 2064 2c20 7374 6570 2c20 7870  , g, d, step, xp
-0008aeb0: 2c20 662c 2067 662c 2067 622c 206e 702c  , f, gf, gb, np,
-0008aec0: 2070 7329 3b0a 0a20 2020 2020 2020 2069   ps);..        i
-0008aed0: 6620 286c 7320 3c20 3029 207b 0a20 2020  f (ls < 0) {.   
-0008aee0: 2020 2020 2020 2020 202f 2f20 6c69 6e65           // line
-0008aef0: 7365 6172 6368 2066 6169 6c65 6420 2d20  search failed - 
-0008af00: 676f 2062 6163 6b20 746f 2074 6865 2070  go back to the p
-0008af10: 7265 7669 6f75 7320 706f 696e 7420 616e  revious point an
-0008af20: 6420 7265 7475 726e 0a20 2020 2020 2020  d return.       
-0008af30: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
-0008af40: 795f 6633 3228 6e78 2c20 782c 2078 7029  y_f32(nx, x, xp)
-0008af50: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
-0008af60: 6d6c 5f76 6563 5f63 7079 5f66 3332 286e  ml_vec_cpy_f32(n
-0008af70: 782c 2067 2c20 6770 293b 0a0a 2020 2020  x, g, gp);..    
-0008af80: 2020 2020 2020 2020 7265 7475 726e 206c          return l
-0008af90: 733b 0a20 2020 2020 2020 207d 0a0a 2020  s;.        }..  
-0008afa0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6e        ggml_vec_n
-0008afb0: 6f72 6d5f 6633 3228 6e78 2c20 2678 6e6f  orm_f32(nx, &xno
-0008afc0: 726d 2c20 7829 3b0a 2020 2020 2020 2020  rm, x);.        
-0008afd0: 6767 6d6c 5f76 6563 5f6e 6f72 6d5f 6633  ggml_vec_norm_f3
-0008afe0: 3228 6e78 2c20 2667 6e6f 726d 2c20 6729  2(nx, &gnorm, g)
-0008aff0: 3b0a 0a20 2020 2020 2020 2047 474d 4c5f  ;..        GGML_
-0008b000: 5052 494e 545f 4445 4255 4728 2266 203d  PRINT_DEBUG("f =
-0008b010: 2025 3130 2e36 665c 6e22 2c20 6767 6d6c   %10.6f\n", ggml
-0008b020: 5f67 6574 5f66 3332 5f31 6428 662c 2030  _get_f32_1d(f, 0
-0008b030: 2929 3b0a 0a20 2020 2020 2020 2069 6620  ));..        if 
-0008b040: 2878 6e6f 726d 203c 2031 2e30 6629 207b  (xnorm < 1.0f) {
-0008b050: 0a20 2020 2020 2020 2020 2020 2078 6e6f  .            xno
-0008b060: 726d 203d 2031 2e30 663b 0a20 2020 2020  rm = 1.0f;.     
-0008b070: 2020 207d 0a20 2020 2020 2020 2069 6620     }.        if 
-0008b080: 2867 6e6f 726d 2f78 6e6f 726d 203c 3d20  (gnorm/xnorm <= 
-0008b090: 7061 7261 6d73 2e6c 6266 6773 2e65 7073  params.lbfgs.eps
-0008b0a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008b0b0: 2f2f 2063 6f6e 7665 7267 6564 0a20 2020  // converged.   
-0008b0c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0008b0d0: 4747 4d4c 5f4f 5054 5f4f 4b3b 0a20 2020  GGML_OPT_OK;.   
-0008b0e0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008b0f0: 2f2f 2064 656c 7461 2d62 6173 6564 2063  // delta-based c
-0008b100: 6f6e 7665 7267 656e 6365 2074 6573 740a  onvergence test.
-0008b110: 2020 2020 2020 2020 6966 2028 7066 2021          if (pf !
-0008b120: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
-0008b130: 2020 2020 2020 2f2f 206e 6565 6420 6174        // need at
-0008b140: 206c 6561 7374 2070 6172 616d 732e 7061   least params.pa
-0008b150: 7374 2069 7465 7261 7469 6f6e 7320 746f  st iterations to
-0008b160: 2073 7461 7274 2063 6865 636b 696e 6720   start checking 
-0008b170: 666f 7220 636f 6e76 6572 6765 6e63 650a  for convergence.
-0008b180: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0008b190: 7061 7261 6d73 2e70 6173 7420 3c3d 206b  params.past <= k
-0008b1a0: 5b30 5d29 207b 0a20 2020 2020 2020 2020  [0]) {.         
-0008b1b0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0008b1c0: 6174 2072 6174 6520 3d20 2870 665b 6b5b  at rate = (pf[k[
-0008b1d0: 305d 2570 6172 616d 732e 7061 7374 5d20  0]%params.past] 
-0008b1e0: 2d20 6678 292f 6678 3b0a 0a20 2020 2020  - fx)/fx;..     
-0008b1f0: 2020 2020 2020 2020 2020 2069 6620 2866             if (f
-0008b200: 6162 7366 2872 6174 6529 203c 2070 6172  absf(rate) < par
-0008b210: 616d 732e 6465 6c74 6129 207b 0a20 2020  ams.delta) {.   
+00089b50: 2020 2020 7265 7475 726e 2063 6f75 6e74      return count
+00089b60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00089b70: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+00089b80: 2020 2020 2069 6628 6467 203e 202d 7061       if(dg > -pa
+00089b90: 7261 6d73 2d3e 6c62 6667 732e 776f 6c66  rams->lbfgs.wolf
+00089ba0: 652a 6467 696e 6974 2920 7b0a 2020 2020  e*dginit) {.    
+00089bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089bc0: 7769 6474 6820 3d20 6465 633b 0a20 2020  width = dec;.   
+00089bd0: 2020 2020 2020 2020 2020 2020 207d 2065               } e
+00089be0: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+00089bf0: 2020 2020 2020 2020 2020 2f2f 2073 7472            // str
+00089c00: 6f6e 6720 576f 6c66 6520 636f 6e64 6974  ong Wolfe condit
+00089c10: 696f 6e20 2847 474d 4c5f 4c49 4e45 5345  ion (GGML_LINESE
+00089c20: 4152 4348 5f42 4143 4b54 5241 434b 494e  ARCH_BACKTRACKIN
+00089c30: 475f 5354 524f 4e47 5f57 4f4c 4645 290a  G_STRONG_WOLFE).
+00089c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089c50: 2020 2020 7265 7475 726e 2063 6f75 6e74      return count
+00089c60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00089c70: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00089c80: 2020 2020 7265 7475 726e 2063 6f75 6e74      return count
+00089c90: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+00089ca0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00089cb0: 2020 2069 6620 282a 7374 6570 203c 2070     if (*step < p
+00089cc0: 6172 616d 732d 3e6c 6266 6773 2e6d 696e  arams->lbfgs.min
+00089cd0: 5f73 7465 7029 207b 0a20 2020 2020 2020  _step) {.       
+00089ce0: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
+00089cf0: 5f4c 494e 4553 4541 5243 485f 4d49 4e49  _LINESEARCH_MINI
+00089d00: 4d55 4d5f 5354 4550 3b0a 2020 2020 2020  MUM_STEP;.      
+00089d10: 2020 7d0a 2020 2020 2020 2020 6966 2028    }.        if (
+00089d20: 2a73 7465 7020 3e20 7061 7261 6d73 2d3e  *step > params->
+00089d30: 6c62 6667 732e 6d61 785f 7374 6570 2920  lbfgs.max_step) 
+00089d40: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
+00089d50: 7475 726e 2047 474d 4c5f 4c49 4e45 5345  turn GGML_LINESE
+00089d60: 4152 4348 5f4d 4158 494d 554d 5f53 5445  ARCH_MAXIMUM_STE
+00089d70: 503b 0a20 2020 2020 2020 207d 0a20 2020  P;.        }.   
+00089d80: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
+00089d90: 3e6c 6266 6773 2e6d 6178 5f6c 696e 6573  >lbfgs.max_lines
+00089da0: 6561 7263 6820 3c3d 2063 6f75 6e74 2920  earch <= count) 
+00089db0: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
+00089dc0: 7475 726e 2047 474d 4c5f 4c49 4e45 5345  turn GGML_LINESE
+00089dd0: 4152 4348 5f4d 4158 494d 554d 5f49 5445  ARCH_MAXIMUM_ITE
+00089de0: 5241 5449 4f4e 533b 0a20 2020 2020 2020  RATIONS;.       
+00089df0: 207d 0a0a 2020 2020 2020 2020 282a 7374   }..        (*st
+00089e00: 6570 2920 2a3d 2077 6964 7468 3b0a 2020  ep) *= width;.  
+00089e10: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
+00089e20: 4747 4d4c 5f4c 494e 4553 4541 5243 485f  GGML_LINESEARCH_
+00089e30: 4641 494c 3b0a 7d0a 0a73 7461 7469 6320  FAIL;.}..static 
+00089e40: 656e 756d 2067 676d 6c5f 6f70 745f 7265  enum ggml_opt_re
+00089e50: 7375 6c74 2067 676d 6c5f 6f70 745f 6c62  sult ggml_opt_lb
+00089e60: 6667 7328 0a20 2020 2020 2020 2073 7472  fgs(.        str
+00089e70: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00089e80: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+00089e90: 7374 7275 6374 2067 676d 6c5f 6f70 745f  struct ggml_opt_
+00089ea0: 636f 6e74 6578 7420 2a20 6f70 742c 0a20  context * opt,. 
+00089eb0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00089ec0: 6d6c 5f6f 7074 5f70 6172 616d 7320 7061  ml_opt_params pa
+00089ed0: 7261 6d73 2c0a 2020 2020 2020 2020 7374  rams,.        st
+00089ee0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00089ef0: 202a 2066 2c0a 2020 2020 2020 2020 7374   * f,.        st
+00089f00: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
+00089f10: 202a 2067 662c 0a20 2020 2020 2020 2073   * gf,.        s
+00089f20: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+00089f30: 6820 2a20 6762 2920 7b0a 2020 2020 6966  h * gb) {.    if
+00089f40: 2028 7061 7261 6d73 2e6c 6266 6773 2e6c   (params.lbfgs.l
+00089f50: 696e 6573 6561 7263 6820 3d3d 2047 474d  inesearch == GGM
+00089f60: 4c5f 4c49 4e45 5345 4152 4348 5f42 4143  L_LINESEARCH_BAC
+00089f70: 4b54 5241 434b 494e 475f 574f 4c46 4520  KTRACKING_WOLFE 
+00089f80: 7c7c 0a20 2020 2020 2020 2070 6172 616d  ||.        param
+00089f90: 732e 6c62 6667 732e 6c69 6e65 7365 6172  s.lbfgs.linesear
+00089fa0: 6368 203d 3d20 4747 4d4c 5f4c 494e 4553  ch == GGML_LINES
+00089fb0: 4541 5243 485f 4241 434b 5452 4143 4b49  EARCH_BACKTRACKI
+00089fc0: 4e47 5f53 5452 4f4e 475f 574f 4c46 4529  NG_STRONG_WOLFE)
+00089fd0: 207b 0a20 2020 2020 2020 2069 6620 2870   {.        if (p
+00089fe0: 6172 616d 732e 6c62 6667 732e 776f 6c66  arams.lbfgs.wolf
+00089ff0: 6520 3c3d 2070 6172 616d 732e 6c62 6667  e <= params.lbfg
+0008a000: 732e 6674 6f6c 207c 7c20 312e 6620 3c3d  s.ftol || 1.f <=
+0008a010: 2070 6172 616d 732e 6c62 6667 732e 776f   params.lbfgs.wo
+0008a020: 6c66 6529 207b 0a20 2020 2020 2020 2020  lfe) {.         
+0008a030: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
+0008a040: 5054 5f49 4e56 414c 4944 5f57 4f4c 4645  PT_INVALID_WOLFE
+0008a050: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+0008a060: 7d0a 0a20 2020 2067 662d 3e6e 5f74 6872  }..    gf->n_thr
+0008a070: 6561 6473 203d 2070 6172 616d 732e 6e5f  eads = params.n_
+0008a080: 7468 7265 6164 733b 0a20 2020 2067 622d  threads;.    gb-
+0008a090: 3e6e 5f74 6872 6561 6473 203d 2070 6172  >n_threads = par
+0008a0a0: 616d 732e 6e5f 7468 7265 6164 733b 0a0a  ams.n_threads;..
+0008a0b0: 2020 2020 636f 6e73 7420 696e 7420 6d20      const int m 
+0008a0c0: 3d20 7061 7261 6d73 2e6c 6266 6773 2e6d  = params.lbfgs.m
+0008a0d0: 3b0a 0a20 2020 202f 2f20 7468 6573 6520  ;..    // these 
+0008a0e0: 7769 6c6c 2073 746f 7265 2074 6865 2070  will store the p
+0008a0f0: 6172 616d 6574 6572 7320 7765 2077 616e  arameters we wan
+0008a100: 7420 746f 206f 7074 696d 697a 650a 2020  t to optimize.  
+0008a110: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0008a120: 6e73 6f72 202a 2070 735b 4747 4d4c 5f4d  nsor * ps[GGML_M
+0008a130: 4158 5f50 4152 414d 535d 3b0a 0a20 2020  AX_PARAMS];..   
+0008a140: 2069 6e74 206e 7020 3d20 303b 0a20 2020   int np = 0;.   
+0008a150: 2069 6e74 206e 7820 3d20 303b 0a20 2020   int nx = 0;.   
+0008a160: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0008a170: 2069 203c 2067 662d 3e6e 5f6e 6f64 6573   i < gf->n_nodes
+0008a180: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
+0008a190: 2069 6620 2867 662d 3e6e 6f64 6573 5b69   if (gf->nodes[i
+0008a1a0: 5d2d 3e69 735f 7061 7261 6d29 207b 0a20  ]->is_param) {. 
+0008a1b0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0008a1c0: 5052 494e 545f 4445 4255 4728 2266 6f75  PRINT_DEBUG("fou
+0008a1d0: 6e64 2070 6172 616d 2025 643a 2067 7261  nd param %d: gra
+0008a1e0: 642d 3e6f 7020 3d20 2564 5c6e 222c 206e  d->op = %d\n", n
+0008a1f0: 702c 2067 662d 3e6e 6f64 6573 5b69 5d2d  p, gf->nodes[i]-
+0008a200: 3e67 7261 642d 3e6f 7029 3b0a 0a20 2020  >grad->op);..   
+0008a210: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0008a220: 5345 5254 286e 7020 3c20 4747 4d4c 5f4d  SERT(np < GGML_M
+0008a230: 4158 5f50 4152 414d 5329 3b0a 0a20 2020  AX_PARAMS);..   
+0008a240: 2020 2020 2020 2020 2070 735b 6e70 2b2b           ps[np++
+0008a250: 5d20 3d20 6766 2d3e 6e6f 6465 735b 695d  ] = gf->nodes[i]
+0008a260: 3b0a 2020 2020 2020 2020 2020 2020 6e78  ;.            nx
+0008a270: 202b 3d20 6767 6d6c 5f6e 656c 656d 656e   += ggml_nelemen
+0008a280: 7473 2867 662d 3e6e 6f64 6573 5b69 5d29  ts(gf->nodes[i])
+0008a290: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+0008a2a0: 7d0a 0a20 2020 2069 6620 2828 6f70 742d  }..    if ((opt-
+0008a2b0: 3e70 6172 616d 732e 7479 7065 2021 3d20  >params.type != 
+0008a2c0: 7061 7261 6d73 2e74 7970 6529 207c 7c20  params.type) || 
+0008a2d0: 286f 7074 2d3e 6e78 2021 3d20 6e78 2920  (opt->nx != nx) 
+0008a2e0: 7c7c 2028 6f70 742d 3e70 6172 616d 732e  || (opt->params.
+0008a2f0: 7061 7374 2021 3d20 7061 7261 6d73 2e70  past != params.p
+0008a300: 6173 7429 207c 7c20 286f 7074 2d3e 7061  ast) || (opt->pa
+0008a310: 7261 6d73 2e6c 6266 6773 2e6d 2021 3d20  rams.lbfgs.m != 
+0008a320: 7061 7261 6d73 2e6c 6266 6773 2e6d 2929  params.lbfgs.m))
+0008a330: 207b 0a20 2020 2020 2020 2069 6e74 2069   {.        int i
+0008a340: 7465 7220 3d20 6f70 742d 3e69 7465 723b  ter = opt->iter;
+0008a350: 0a20 2020 2020 2020 2067 676d 6c5f 6f70  .        ggml_op
+0008a360: 745f 696e 6974 2863 7478 2c20 6f70 742c  t_init(ctx, opt,
+0008a370: 2070 6172 616d 732c 206e 7829 3b0a 2020   params, nx);.  
+0008a380: 2020 2020 2020 6f70 742d 3e69 7465 7220        opt->iter 
+0008a390: 3d20 6974 6572 3b0a 2020 2020 7d0a 0a20  = iter;.    }.. 
+0008a3a0: 2020 2066 6c6f 6174 202a 2078 2020 3d20     float * x  = 
+0008a3b0: 6f70 742d 3e6c 6266 6773 2e78 2d3e 6461  opt->lbfgs.x->da
+0008a3c0: 7461 3b20 202f 2f20 6375 7272 656e 7420  ta;  // current 
+0008a3d0: 7061 7261 6d65 7465 7273 0a20 2020 2066  parameters.    f
+0008a3e0: 6c6f 6174 202a 2078 7020 3d20 6f70 742d  loat * xp = opt-
+0008a3f0: 3e6c 6266 6773 2e78 702d 3e64 6174 613b  >lbfgs.xp->data;
+0008a400: 202f 2f20 7072 6576 696f 7573 2070 6172   // previous par
+0008a410: 616d 6574 6572 730a 2020 2020 666c 6f61  ameters.    floa
+0008a420: 7420 2a20 6720 203d 206f 7074 2d3e 6c62  t * g  = opt->lb
+0008a430: 6667 732e 672d 3e64 6174 613b 2020 2f2f  fgs.g->data;  //
+0008a440: 2063 7572 7265 6e74 2067 7261 6469 656e   current gradien
+0008a450: 740a 2020 2020 666c 6f61 7420 2a20 6770  t.    float * gp
+0008a460: 203d 206f 7074 2d3e 6c62 6667 732e 6770   = opt->lbfgs.gp
+0008a470: 2d3e 6461 7461 3b20 2f2f 2070 7265 7669  ->data; // previ
+0008a480: 6f75 7320 6772 6164 6965 6e74 0a20 2020  ous gradient.   
+0008a490: 2066 6c6f 6174 202a 2064 2020 3d20 6f70   float * d  = op
+0008a4a0: 742d 3e6c 6266 6773 2e64 2d3e 6461 7461  t->lbfgs.d->data
+0008a4b0: 3b20 202f 2f20 7365 6172 6368 2064 6972  ;  // search dir
+0008a4c0: 6563 7469 6f6e 0a0a 2020 2020 666c 6f61  ection..    floa
+0008a4d0: 7420 2a20 7066 203d 2070 6172 616d 732e  t * pf = params.
+0008a4e0: 7061 7374 203e 2030 203f 206f 7074 2d3e  past > 0 ? opt->
+0008a4f0: 6c62 6667 732e 7066 2d3e 6461 7461 203a  lbfgs.pf->data :
+0008a500: 204e 554c 4c3b 202f 2f20 7061 7374 2066   NULL; // past f
+0008a510: 756e 6374 696f 6e20 7661 6c75 6573 0a0a  unction values..
+0008a520: 2020 2020 666c 6f61 7420 6678 2020 2020      float fx    
+0008a530: 3d20 302e 3066 3b20 2f2f 2063 6f73 7420  = 0.0f; // cost 
+0008a540: 6675 6e63 7469 6f6e 2076 616c 7565 0a20  function value. 
+0008a550: 2020 2066 6c6f 6174 2078 6e6f 726d 203d     float xnorm =
+0008a560: 2030 2e30 663b 202f 2f20 7c7c 787c 7c0a   0.0f; // ||x||.
+0008a570: 2020 2020 666c 6f61 7420 676e 6f72 6d20      float gnorm 
+0008a580: 3d20 302e 3066 3b20 2f2f 207c 7c67 7c7c  = 0.0f; // ||g||
+0008a590: 0a0a 2020 2020 2f2f 2069 6e69 7469 616c  ..    // initial
+0008a5a0: 697a 6520 7820 6672 6f6d 2074 6865 2067  ize x from the g
+0008a5b0: 7261 7068 206e 6f64 6573 0a20 2020 2067  raph nodes.    g
+0008a5c0: 676d 6c5f 6f70 745f 6765 745f 7061 7261  gml_opt_get_para
+0008a5d0: 6d73 286e 702c 2070 732c 2078 293b 0a0a  ms(np, ps, x);..
+0008a5e0: 2020 2020 2f2f 2074 6865 204c 2d42 4647      // the L-BFG
+0008a5f0: 5320 6d65 6d6f 7279 0a20 2020 2066 6c6f  S memory.    flo
+0008a600: 6174 202a 206c 6d5f 616c 7068 6120 3d20  at * lm_alpha = 
+0008a610: 6f70 742d 3e6c 6266 6773 2e6c 6d61 6c2d  opt->lbfgs.lmal-
+0008a620: 3e64 6174 613b 0a20 2020 2066 6c6f 6174  >data;.    float
+0008a630: 202a 206c 6d5f 7973 2020 2020 3d20 6f70   * lm_ys    = op
+0008a640: 742d 3e6c 6266 6773 2e6c 6d79 732d 3e64  t->lbfgs.lmys->d
+0008a650: 6174 613b 0a20 2020 2066 6c6f 6174 202a  ata;.    float *
+0008a660: 206c 6d5f 7320 2020 2020 3d20 6f70 742d   lm_s     = opt-
+0008a670: 3e6c 6266 6773 2e6c 6d73 2d3e 6461 7461  >lbfgs.lms->data
+0008a680: 3b0a 2020 2020 666c 6f61 7420 2a20 6c6d  ;.    float * lm
+0008a690: 5f79 2020 2020 203d 206f 7074 2d3e 6c62  _y     = opt->lb
+0008a6a0: 6667 732e 6c6d 792d 3e64 6174 613b 0a0a  fgs.lmy->data;..
+0008a6b0: 2020 2020 2f2f 2065 7661 6c75 6174 6520      // evaluate 
+0008a6c0: 7468 6520 6675 6e63 7469 6f6e 2076 616c  the function val
+0008a6d0: 7565 2061 6e64 2069 7473 2067 7261 6469  ue and its gradi
+0008a6e0: 656e 740a 2020 2020 7b0a 2020 2020 2020  ent.    {.      
+0008a6f0: 2020 6767 6d6c 5f6f 7074 5f73 6574 5f70    ggml_opt_set_p
+0008a700: 6172 616d 7328 6e70 2c20 7073 2c20 7829  arams(np, ps, x)
+0008a710: 3b0a 0a20 2020 2020 2020 2067 676d 6c5f  ;..        ggml_
+0008a720: 6772 6170 685f 7265 7365 7420 2028 6766  graph_reset  (gf
+0008a730: 293b 0a20 2020 2020 2020 2067 676d 6c5f  );.        ggml_
+0008a740: 7365 745f 6633 3220 2020 2020 2028 662d  set_f32      (f-
+0008a750: 3e67 7261 642c 2031 2e30 6629 3b0a 2020  >grad, 1.0f);.  
+0008a760: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
+0008a770: 5f63 6f6d 7075 7465 2863 7478 2c20 6762  _compute(ctx, gb
+0008a780: 293b 0a0a 2020 2020 2020 2020 6767 6d6c  );..        ggml
+0008a790: 5f6f 7074 5f67 6574 5f67 7261 6428 6e70  _opt_get_grad(np
+0008a7a0: 2c20 7073 2c20 6729 3b0a 0a20 2020 2020  , ps, g);..     
+0008a7b0: 2020 2066 7820 3d20 6767 6d6c 5f67 6574     fx = ggml_get
+0008a7c0: 5f66 3332 5f31 6428 662c 2030 293b 0a20  _f32_1d(f, 0);. 
+0008a7d0: 2020 207d 0a0a 2020 2020 2f2f 2073 6561     }..    // sea
+0008a7e0: 7263 6820 6469 7265 6374 696f 6e20 3d20  rch direction = 
+0008a7f0: 2d67 7261 6469 656e 740a 2020 2020 6767  -gradient.    gg
+0008a800: 6d6c 5f76 6563 5f6e 6567 5f66 3332 286e  ml_vec_neg_f32(n
+0008a810: 782c 2064 2c20 6729 3b0a 0a20 2020 202f  x, d, g);..    /
+0008a820: 2f20 7c7c 787c 7c2c 207c 7c67 7c7c 0a20  / ||x||, ||g||. 
+0008a830: 2020 2067 676d 6c5f 7665 635f 6e6f 726d     ggml_vec_norm
+0008a840: 5f66 3332 286e 782c 2026 786e 6f72 6d2c  _f32(nx, &xnorm,
+0008a850: 2078 293b 0a20 2020 2067 676d 6c5f 7665   x);.    ggml_ve
+0008a860: 635f 6e6f 726d 5f66 3332 286e 782c 2026  c_norm_f32(nx, &
+0008a870: 676e 6f72 6d2c 2067 293b 0a0a 2020 2020  gnorm, g);..    
+0008a880: 6966 2028 786e 6f72 6d20 3c20 312e 3066  if (xnorm < 1.0f
+0008a890: 2920 7b0a 2020 2020 2020 2020 786e 6f72  ) {.        xnor
+0008a8a0: 6d20 3d20 312e 3066 3b0a 2020 2020 7d0a  m = 1.0f;.    }.
+0008a8b0: 0a20 2020 202f 2f20 616c 7265 6164 7920  .    // already 
+0008a8c0: 6f70 7469 6d69 7a65 640a 2020 2020 6966  optimized.    if
+0008a8d0: 2028 676e 6f72 6d2f 786e 6f72 6d20 3c3d   (gnorm/xnorm <=
+0008a8e0: 2070 6172 616d 732e 6c62 6667 732e 6570   params.lbfgs.ep
+0008a8f0: 7329 207b 0a20 2020 2020 2020 2072 6574  s) {.        ret
+0008a900: 7572 6e20 4747 4d4c 5f4f 5054 5f4f 4b3b  urn GGML_OPT_OK;
+0008a910: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
+0008a920: 6f70 742d 3e6a 7573 745f 696e 6974 6961  opt->just_initia
+0008a930: 6c69 7a65 6429 207b 0a20 2020 2020 2020  lized) {.       
+0008a940: 2069 6620 2870 6629 207b 0a20 2020 2020   if (pf) {.     
+0008a950: 2020 2020 2020 2070 665b 305d 203d 2066         pf[0] = f
+0008a960: 783b 0a20 2020 2020 2020 207d 0a20 2020  x;.        }.   
+0008a970: 2020 2020 206f 7074 2d3e 6c62 6667 732e       opt->lbfgs.
+0008a980: 6678 5f62 6573 7420 3d20 6678 3b0a 0a20  fx_best = fx;.. 
+0008a990: 2020 2020 2020 202f 2f20 696e 6974 6961         // initia
+0008a9a0: 6c20 7374 6570 0a20 2020 2020 2020 2067  l step.        g
+0008a9b0: 676d 6c5f 7665 635f 6e6f 726d 5f69 6e76  gml_vec_norm_inv
+0008a9c0: 5f66 3332 286e 782c 2026 6f70 742d 3e6c  _f32(nx, &opt->l
+0008a9d0: 6266 6773 2e73 7465 702c 2064 293b 0a20  bfgs.step, d);. 
+0008a9e0: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
+0008a9f0: 732e 6a20 2020 2020 2020 2020 2020 2020  s.j             
+0008aa00: 2020 203d 2030 3b0a 2020 2020 2020 2020     = 0;.        
+0008aa10: 6f70 742d 3e6c 6266 6773 2e6b 2020 2020  opt->lbfgs.k    
+0008aa20: 2020 2020 2020 2020 2020 2020 3d20 313b              = 1;
+0008aa30: 0a20 2020 2020 2020 206f 7074 2d3e 6c62  .        opt->lb
+0008aa40: 6667 732e 656e 6420 2020 2020 2020 2020  fgs.end         
+0008aa50: 2020 2020 203d 2030 3b0a 2020 2020 2020       = 0;.      
+0008aa60: 2020 6f70 742d 3e6c 6266 6773 2e6e 5f6e    opt->lbfgs.n_n
+0008aa70: 6f5f 696d 7072 6f76 656d 656e 7420 3d20  o_improvement = 
+0008aa80: 303b 0a20 2020 2020 2020 206f 7074 2d3e  0;.        opt->
+0008aa90: 6a75 7374 5f69 6e69 7469 616c 697a 6564  just_initialized
+0008aaa0: 2020 2020 2020 203d 2066 616c 7365 3b0a         = false;.
+0008aab0: 2020 2020 7d0a 0a20 2020 2066 6c6f 6174      }..    float
+0008aac0: 202a 2066 785f 6265 7374 2020 2020 2020   * fx_best      
+0008aad0: 2020 3d20 266f 7074 2d3e 6c62 6667 732e    = &opt->lbfgs.
+0008aae0: 6678 5f62 6573 743b 0a20 2020 2066 6c6f  fx_best;.    flo
+0008aaf0: 6174 202a 2073 7465 7020 2020 2020 2020  at * step       
+0008ab00: 2020 2020 3d20 266f 7074 2d3e 6c62 6667      = &opt->lbfg
+0008ab10: 732e 7374 6570 3b0a 2020 2020 696e 7420  s.step;.    int 
+0008ab20: 2a20 6a20 2020 2020 2020 2020 2020 2020  * j             
+0008ab30: 2020 203d 2026 6f70 742d 3e6c 6266 6773     = &opt->lbfgs
+0008ab40: 2e6a 3b0a 2020 2020 696e 7420 2a20 6b20  .j;.    int * k 
+0008ab50: 2020 2020 2020 2020 2020 2020 2020 203d                 =
+0008ab60: 2026 6f70 742d 3e6c 6266 6773 2e6b 3b0a   &opt->lbfgs.k;.
+0008ab70: 2020 2020 696e 7420 2a20 656e 6420 2020      int * end   
+0008ab80: 2020 2020 2020 2020 2020 203d 2026 6f70             = &op
+0008ab90: 742d 3e6c 6266 6773 2e65 6e64 3b0a 2020  t->lbfgs.end;.  
+0008aba0: 2020 696e 7420 2a20 6e5f 6e6f 5f69 6d70    int * n_no_imp
+0008abb0: 726f 7665 6d65 6e74 203d 2026 6f70 742d  rovement = &opt-
+0008abc0: 3e6c 6266 6773 2e6e 5f6e 6f5f 696d 7072  >lbfgs.n_no_impr
+0008abd0: 6f76 656d 656e 743b 0a0a 2020 2020 696e  ovement;..    in
+0008abe0: 7420 6c73 2020 2020 203d 2030 3b0a 2020  t ls     = 0;.  
+0008abf0: 2020 696e 7420 626f 756e 6420 203d 2030    int bound  = 0
+0008ac00: 3b0a 0a20 2020 2066 6c6f 6174 2079 7320  ;..    float ys 
+0008ac10: 2020 3d20 302e 3066 3b0a 2020 2020 666c    = 0.0f;.    fl
+0008ac20: 6f61 7420 7979 2020 203d 2030 2e30 663b  oat yy   = 0.0f;
+0008ac30: 0a20 2020 2066 6c6f 6174 2062 6574 6120  .    float beta 
+0008ac40: 3d20 302e 3066 3b0a 0a20 2020 2069 6e74  = 0.0f;..    int
+0008ac50: 2069 7420 3d20 303b 0a0a 2020 2020 7768   it = 0;..    wh
+0008ac60: 696c 6520 2874 7275 6529 207b 0a20 2020  ile (true) {.   
+0008ac70: 2020 2020 202f 2f20 7374 6f72 6520 7468       // store th
+0008ac80: 6520 6375 7272 656e 7420 706f 7369 7469  e current positi
+0008ac90: 6f6e 2061 6e64 2067 7261 6469 656e 7420  on and gradient 
+0008aca0: 7665 6374 6f72 730a 2020 2020 2020 2020  vectors.        
+0008acb0: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
+0008acc0: 286e 782c 2078 702c 2078 293b 0a20 2020  (nx, xp, x);.   
+0008acd0: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
+0008ace0: 795f 6633 3228 6e78 2c20 6770 2c20 6729  y_f32(nx, gp, g)
+0008acf0: 3b0a 0a20 2020 2020 2020 206c 7320 3d20  ;..        ls = 
+0008ad00: 6c69 6e65 7365 6172 6368 5f62 6163 6b74  linesearch_backt
+0008ad10: 7261 636b 696e 6728 6374 782c 2026 7061  racking(ctx, &pa
+0008ad20: 7261 6d73 2c20 6e78 2c20 782c 2026 6678  rams, nx, x, &fx
+0008ad30: 2c20 672c 2064 2c20 7374 6570 2c20 7870  , g, d, step, xp
+0008ad40: 2c20 662c 2067 662c 2067 622c 206e 702c  , f, gf, gb, np,
+0008ad50: 2070 7329 3b0a 0a20 2020 2020 2020 2069   ps);..        i
+0008ad60: 6620 286c 7320 3c20 3029 207b 0a20 2020  f (ls < 0) {.   
+0008ad70: 2020 2020 2020 2020 202f 2f20 6c69 6e65           // line
+0008ad80: 7365 6172 6368 2066 6169 6c65 6420 2d20  search failed - 
+0008ad90: 676f 2062 6163 6b20 746f 2074 6865 2070  go back to the p
+0008ada0: 7265 7669 6f75 7320 706f 696e 7420 616e  revious point an
+0008adb0: 6420 7265 7475 726e 0a20 2020 2020 2020  d return.       
+0008adc0: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
+0008add0: 795f 6633 3228 6e78 2c20 782c 2078 7029  y_f32(nx, x, xp)
+0008ade0: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
+0008adf0: 6d6c 5f76 6563 5f63 7079 5f66 3332 286e  ml_vec_cpy_f32(n
+0008ae00: 782c 2067 2c20 6770 293b 0a0a 2020 2020  x, g, gp);..    
+0008ae10: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+0008ae20: 733b 0a20 2020 2020 2020 207d 0a0a 2020  s;.        }..  
+0008ae30: 2020 2020 2020 6767 6d6c 5f76 6563 5f6e        ggml_vec_n
+0008ae40: 6f72 6d5f 6633 3228 6e78 2c20 2678 6e6f  orm_f32(nx, &xno
+0008ae50: 726d 2c20 7829 3b0a 2020 2020 2020 2020  rm, x);.        
+0008ae60: 6767 6d6c 5f76 6563 5f6e 6f72 6d5f 6633  ggml_vec_norm_f3
+0008ae70: 3228 6e78 2c20 2667 6e6f 726d 2c20 6729  2(nx, &gnorm, g)
+0008ae80: 3b0a 0a20 2020 2020 2020 2047 474d 4c5f  ;..        GGML_
+0008ae90: 5052 494e 545f 4445 4255 4728 2266 203d  PRINT_DEBUG("f =
+0008aea0: 2025 3130 2e36 665c 6e22 2c20 6767 6d6c   %10.6f\n", ggml
+0008aeb0: 5f67 6574 5f66 3332 5f31 6428 662c 2030  _get_f32_1d(f, 0
+0008aec0: 2929 3b0a 0a20 2020 2020 2020 2069 6620  ));..        if 
+0008aed0: 2878 6e6f 726d 203c 2031 2e30 6629 207b  (xnorm < 1.0f) {
+0008aee0: 0a20 2020 2020 2020 2020 2020 2078 6e6f  .            xno
+0008aef0: 726d 203d 2031 2e30 663b 0a20 2020 2020  rm = 1.0f;.     
+0008af00: 2020 207d 0a20 2020 2020 2020 2069 6620     }.        if 
+0008af10: 2867 6e6f 726d 2f78 6e6f 726d 203c 3d20  (gnorm/xnorm <= 
+0008af20: 7061 7261 6d73 2e6c 6266 6773 2e65 7073  params.lbfgs.eps
+0008af30: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008af40: 2f2f 2063 6f6e 7665 7267 6564 0a20 2020  // converged.   
+0008af50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0008af60: 4747 4d4c 5f4f 5054 5f4f 4b3b 0a20 2020  GGML_OPT_OK;.   
+0008af70: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0008af80: 2f2f 2064 656c 7461 2d62 6173 6564 2063  // delta-based c
+0008af90: 6f6e 7665 7267 656e 6365 2074 6573 740a  onvergence test.
+0008afa0: 2020 2020 2020 2020 6966 2028 7066 2021          if (pf !
+0008afb0: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
+0008afc0: 2020 2020 2020 2f2f 206e 6565 6420 6174        // need at
+0008afd0: 206c 6561 7374 2070 6172 616d 732e 7061   least params.pa
+0008afe0: 7374 2069 7465 7261 7469 6f6e 7320 746f  st iterations to
+0008aff0: 2073 7461 7274 2063 6865 636b 696e 6720   start checking 
+0008b000: 666f 7220 636f 6e76 6572 6765 6e63 650a  for convergence.
+0008b010: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0008b020: 7061 7261 6d73 2e70 6173 7420 3c3d 206b  params.past <= k
+0008b030: 5b30 5d29 207b 0a20 2020 2020 2020 2020  [0]) {.         
+0008b040: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0008b050: 6174 2072 6174 6520 3d20 2870 665b 6b5b  at rate = (pf[k[
+0008b060: 305d 2570 6172 616d 732e 7061 7374 5d20  0]%params.past] 
+0008b070: 2d20 6678 292f 6678 3b0a 0a20 2020 2020  - fx)/fx;..     
+0008b080: 2020 2020 2020 2020 2020 2069 6620 2866             if (f
+0008b090: 6162 7366 2872 6174 6529 203c 2070 6172  absf(rate) < par
+0008b0a0: 616d 732e 6465 6c74 6129 207b 0a20 2020  ams.delta) {.   
+0008b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008b0c0: 2072 6574 7572 6e20 4747 4d4c 5f4f 5054   return GGML_OPT
+0008b0d0: 5f4f 4b3b 0a20 2020 2020 2020 2020 2020  _OK;.           
+0008b0e0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0008b0f0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+0008b100: 2020 7066 5b6b 5b30 5d25 7061 7261 6d73    pf[k[0]%params
+0008b110: 2e70 6173 745d 203d 2066 783b 0a20 2020  .past] = fx;.   
+0008b120: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0008b130: 2f2f 2063 6865 636b 2066 6f72 2069 6d70  // check for imp
+0008b140: 726f 7665 6d65 6e74 0a20 2020 2020 2020  rovement.       
+0008b150: 2069 6620 2870 6172 616d 732e 6d61 785f   if (params.max_
+0008b160: 6e6f 5f69 6d70 726f 7665 6d65 6e74 203e  no_improvement >
+0008b170: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
+0008b180: 2020 6966 2028 6678 203c 2066 785f 6265    if (fx < fx_be
+0008b190: 7374 5b30 5d29 207b 0a20 2020 2020 2020  st[0]) {.       
+0008b1a0: 2020 2020 2020 2020 2066 785f 6265 7374           fx_best
+0008b1b0: 5b30 5d20 3d20 6678 3b0a 2020 2020 2020  [0] = fx;.      
+0008b1c0: 2020 2020 2020 2020 2020 6e5f 6e6f 5f69            n_no_i
+0008b1d0: 6d70 726f 7665 6d65 6e74 5b30 5d20 3d20  mprovement[0] = 
+0008b1e0: 303b 0a20 2020 2020 2020 2020 2020 207d  0;.            }
+0008b1f0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+0008b200: 2020 2020 2020 2020 6e5f 6e6f 5f69 6d70          n_no_imp
+0008b210: 726f 7665 6d65 6e74 5b30 5d2b 2b3b 0a0a  rovement[0]++;..
 0008b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b230: 2072 6574 7572 6e20 4747 4d4c 5f4f 5054   return GGML_OPT
-0008b240: 5f4f 4b3b 0a20 2020 2020 2020 2020 2020  _OK;.           
-0008b250: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0008b260: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-0008b270: 2020 7066 5b6b 5b30 5d25 7061 7261 6d73    pf[k[0]%params
-0008b280: 2e70 6173 745d 203d 2066 783b 0a20 2020  .past] = fx;.   
-0008b290: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008b2a0: 2f2f 2063 6865 636b 2066 6f72 2069 6d70  // check for imp
-0008b2b0: 726f 7665 6d65 6e74 0a20 2020 2020 2020  rovement.       
-0008b2c0: 2069 6620 2870 6172 616d 732e 6d61 785f   if (params.max_
-0008b2d0: 6e6f 5f69 6d70 726f 7665 6d65 6e74 203e  no_improvement >
-0008b2e0: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
-0008b2f0: 2020 6966 2028 6678 203c 2066 785f 6265    if (fx < fx_be
-0008b300: 7374 5b30 5d29 207b 0a20 2020 2020 2020  st[0]) {.       
-0008b310: 2020 2020 2020 2020 2066 785f 6265 7374           fx_best
-0008b320: 5b30 5d20 3d20 6678 3b0a 2020 2020 2020  [0] = fx;.      
-0008b330: 2020 2020 2020 2020 2020 6e5f 6e6f 5f69            n_no_i
-0008b340: 6d70 726f 7665 6d65 6e74 5b30 5d20 3d20  mprovement[0] = 
-0008b350: 303b 0a20 2020 2020 2020 2020 2020 207d  0;.            }
-0008b360: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-0008b370: 2020 2020 2020 2020 6e5f 6e6f 5f69 6d70          n_no_imp
-0008b380: 726f 7665 6d65 6e74 5b30 5d2b 2b3b 0a0a  rovement[0]++;..
-0008b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b3a0: 6966 2028 6e5f 6e6f 5f69 6d70 726f 7665  if (n_no_improve
-0008b3b0: 6d65 6e74 5b30 5d20 3e3d 2070 6172 616d  ment[0] >= param
-0008b3c0: 732e 6d61 785f 6e6f 5f69 6d70 726f 7665  s.max_no_improve
-0008b3d0: 6d65 6e74 2920 7b0a 2020 2020 2020 2020  ment) {.        
-0008b3e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0008b3f0: 726e 2047 474d 4c5f 4f50 545f 4f4b 3b0a  rn GGML_OPT_OK;.
-0008b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b410: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-0008b420: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0008b430: 2020 2069 6620 2870 6172 616d 732e 6c62     if (params.lb
-0008b440: 6667 732e 6e5f 6974 6572 2021 3d20 3020  fgs.n_iter != 0 
-0008b450: 2626 2070 6172 616d 732e 6c62 6667 732e  && params.lbfgs.
-0008b460: 6e5f 6974 6572 203c 2069 7420 2b20 3129  n_iter < it + 1)
-0008b470: 207b 0a20 2020 2020 2020 2020 2020 202f   {.            /
-0008b480: 2f20 7265 6163 6865 6420 7468 6520 6d61  / reached the ma
-0008b490: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
-0008b4a0: 6974 6572 6174 696f 6e73 0a20 2020 2020  iterations.     
-0008b4b0: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
-0008b4c0: 4d4c 5f4f 5054 5f44 4944 5f4e 4f54 5f43  ML_OPT_DID_NOT_C
-0008b4d0: 4f4e 5645 5247 453b 0a20 2020 2020 2020  ONVERGE;.       
-0008b4e0: 207d 0a0a 2020 2020 2020 2020 2f2f 2075   }..        // u
-0008b4f0: 7064 6174 6520 7665 6374 6f72 7320 7320  pdate vectors s 
-0008b500: 616e 6420 793a 0a20 2020 2020 2020 202f  and y:.        /
-0008b510: 2f20 2020 735f 7b6b 2b31 7d20 3d20 785f  /   s_{k+1} = x_
-0008b520: 7b6b 2b31 7d20 2d20 785f 7b6b 7d20 3d20  {k+1} - x_{k} = 
-0008b530: 5c73 7465 7020 2a20 645f 7b6b 7d2e 0a20  \step * d_{k}.. 
-0008b540: 2020 2020 2020 202f 2f20 2020 795f 7b6b         //   y_{k
-0008b550: 2b31 7d20 3d20 675f 7b6b 2b31 7d20 2d20  +1} = g_{k+1} - 
-0008b560: 675f 7b6b 7d2e 0a20 2020 2020 2020 202f  g_{k}..        /
-0008b570: 2f0a 2020 2020 2020 2020 6767 6d6c 5f76  /.        ggml_v
-0008b580: 6563 5f73 7562 5f66 3332 286e 782c 2026  ec_sub_f32(nx, &
-0008b590: 6c6d 5f73 5b65 6e64 5b30 5d2a 6e78 5d2c  lm_s[end[0]*nx],
-0008b5a0: 2078 2c20 7870 293b 0a20 2020 2020 2020   x, xp);.       
-0008b5b0: 2067 676d 6c5f 7665 635f 7375 625f 6633   ggml_vec_sub_f3
-0008b5c0: 3228 6e78 2c20 266c 6d5f 795b 656e 645b  2(nx, &lm_y[end[
-0008b5d0: 305d 2a6e 785d 2c20 672c 2067 7029 3b0a  0]*nx], g, gp);.
-0008b5e0: 0a20 2020 2020 2020 202f 2f20 636f 6d70  .        // comp
-0008b5f0: 7574 6520 7363 616c 6172 7320 7973 2061  ute scalars ys a
-0008b600: 6e64 2079 793a 0a20 2020 2020 2020 202f  nd yy:.        /
-0008b610: 2f20 2020 2020 7973 203d 2079 5e74 205c  /     ys = y^t \
-0008b620: 6364 6f74 2073 2020 2020 2d3e 2031 202f  cdot s    -> 1 /
-0008b630: 205c 7268 6f2e 0a20 2020 2020 2020 202f   \rho..        /
-0008b640: 2f20 2020 2020 7979 203d 2079 5e74 205c  /     yy = y^t \
-0008b650: 6364 6f74 2079 2e0a 2020 2020 2020 2020  cdot y..        
-0008b660: 2f2f 0a20 2020 2020 2020 2067 676d 6c5f  //.        ggml_
-0008b670: 7665 635f 646f 745f 6633 3228 6e78 2c20  vec_dot_f32(nx, 
-0008b680: 2679 732c 2026 6c6d 5f79 5b65 6e64 5b30  &ys, &lm_y[end[0
-0008b690: 5d2a 6e78 5d2c 2026 6c6d 5f73 5b65 6e64  ]*nx], &lm_s[end
-0008b6a0: 5b30 5d20 2a6e 785d 293b 0a20 2020 2020  [0] *nx]);.     
-0008b6b0: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
-0008b6c0: 6633 3228 6e78 2c20 2679 792c 2026 6c6d  f32(nx, &yy, &lm
-0008b6d0: 5f79 5b65 6e64 5b30 5d2a 6e78 5d2c 2026  _y[end[0]*nx], &
-0008b6e0: 6c6d 5f79 5b65 6e64 5b30 5d2a 6e78 5d29  lm_y[end[0]*nx])
-0008b6f0: 3b0a 0a20 2020 2020 2020 206c 6d5f 7973  ;..        lm_ys
-0008b700: 5b65 6e64 5b30 5d5d 203d 2079 733b 0a0a  [end[0]] = ys;..
-0008b710: 2020 2020 2020 2020 2f2f 2066 696e 6420          // find 
-0008b720: 6e65 7720 7365 6172 6368 2064 6972 6563  new search direc
-0008b730: 7469 6f6e 0a20 2020 2020 2020 202f 2f20  tion.        // 
-0008b740: 2020 7265 663a 2068 7474 7073 3a2f 2f65    ref: https://e
-0008b750: 6e2e 7769 6b69 7065 6469 612e 6f72 672f  n.wikipedia.org/
-0008b760: 7769 6b69 2f4c 696d 6974 6564 2d6d 656d  wiki/Limited-mem
-0008b770: 6f72 795f 4246 4753 0a0a 2020 2020 2020  ory_BFGS..      
-0008b780: 2020 626f 756e 6420 3d20 286d 203c 3d20    bound = (m <= 
-0008b790: 6b5b 305d 2920 3f20 6d20 3a20 6b5b 305d  k[0]) ? m : k[0]
-0008b7a0: 3b0a 2020 2020 2020 2020 6b5b 305d 2b2b  ;.        k[0]++
-0008b7b0: 3b0a 2020 2020 2020 2020 6974 2b2b 3b0a  ;.        it++;.
-0008b7c0: 2020 2020 2020 2020 656e 645b 305d 203d          end[0] =
-0008b7d0: 2028 656e 645b 305d 202b 2031 2925 6d3b   (end[0] + 1)%m;
-0008b7e0: 0a0a 2020 2020 2020 2020 2f2f 2069 6e69  ..        // ini
-0008b7f0: 7469 616c 697a 6520 7365 6172 6368 2064  tialize search d
-0008b800: 6972 6563 7469 6f6e 2077 6974 6820 2d67  irection with -g
-0008b810: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-0008b820: 635f 6e65 675f 6633 3228 6e78 2c20 642c  c_neg_f32(nx, d,
-0008b830: 2067 293b 0a0a 2020 2020 2020 2020 6a5b   g);..        j[
-0008b840: 305d 203d 2065 6e64 5b30 5d3b 0a20 2020  0] = end[0];.   
-0008b850: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-0008b860: 3d20 303b 2069 203c 2062 6f75 6e64 3b20  = 0; i < bound; 
-0008b870: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
-0008b880: 2020 206a 5b30 5d20 3d20 286a 5b30 5d20     j[0] = (j[0] 
-0008b890: 2b20 6d20 2d20 3129 2025 206d 3b0a 2020  + m - 1) % m;.  
-0008b8a0: 2020 2020 2020 2020 2020 2f2f 205c 616c            // \al
-0008b8b0: 7068 615f 7b6a 7d20 3d20 5c72 686f 5f7b  pha_{j} = \rho_{
-0008b8c0: 6a7d 2073 5e7b 747d 5f7b 6a7d 205c 6364  j} s^{t}_{j} \cd
-0008b8d0: 6f74 2071 5f7b 6b2b 317d 0a20 2020 2020  ot q_{k+1}.     
-0008b8e0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0008b8f0: 646f 745f 6633 3228 6e78 2c20 266c 6d5f  dot_f32(nx, &lm_
-0008b900: 616c 7068 615b 6a5b 305d 5d2c 2026 6c6d  alpha[j[0]], &lm
-0008b910: 5f73 5b6a 5b30 5d2a 6e78 5d2c 2064 293b  _s[j[0]*nx], d);
-0008b920: 0a20 2020 2020 2020 2020 2020 206c 6d5f  .            lm_
-0008b930: 616c 7068 615b 6a5b 305d 5d20 2f3d 206c  alpha[j[0]] /= l
-0008b940: 6d5f 7973 5b6a 5b30 5d5d 3b0a 2020 2020  m_ys[j[0]];.    
-0008b950: 2020 2020 2020 2020 2f2f 2071 5f7b 697d          // q_{i}
-0008b960: 203d 2071 5f7b 692b 317d 202d 205c 616c   = q_{i+1} - \al
-0008b970: 7068 615f 7b69 7d20 795f 7b69 7d0a 2020  pha_{i} y_{i}.  
-0008b980: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-0008b990: 6563 5f6d 6164 5f66 3332 286e 782c 2064  ec_mad_f32(nx, d
-0008b9a0: 2c20 266c 6d5f 795b 6a5b 305d 2a6e 785d  , &lm_y[j[0]*nx]
-0008b9b0: 2c20 2d6c 6d5f 616c 7068 615b 6a5b 305d  , -lm_alpha[j[0]
-0008b9c0: 5d29 3b0a 2020 2020 2020 2020 7d0a 0a20  ]);.        }.. 
-0008b9d0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0008b9e0: 7363 616c 655f 6633 3228 6e78 2c20 642c  scale_f32(nx, d,
-0008b9f0: 2079 732f 7979 293b 0a0a 2020 2020 2020   ys/yy);..      
-0008ba00: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-0008ba10: 3b20 6920 3c20 626f 756e 643b 202b 2b69  ; i < bound; ++i
-0008ba20: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008ba30: 2f2f 205c 6265 7461 5f7b 6a7d 203d 205c  // \beta_{j} = \
-0008ba40: 7268 6f5f 7b6a 7d20 795e 745f 7b6a 7d20  rho_{j} y^t_{j} 
-0008ba50: 5c63 646f 7420 5c67 616d 6d61 5f7b 697d  \cdot \gamma_{i}
-0008ba60: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-0008ba70: 6c5f 7665 635f 646f 745f 6633 3228 6e78  l_vec_dot_f32(nx
-0008ba80: 2c20 2662 6574 612c 2026 6c6d 5f79 5b6a  , &beta, &lm_y[j
-0008ba90: 5b30 5d2a 6e78 5d2c 2064 293b 0a20 2020  [0]*nx], d);.   
-0008baa0: 2020 2020 2020 2020 2062 6574 6120 2f3d           beta /=
-0008bab0: 206c 6d5f 7973 5b6a 5b30 5d5d 3b0a 2020   lm_ys[j[0]];.  
-0008bac0: 2020 2020 2020 2020 2020 2f2f 205c 6761            // \ga
-0008bad0: 6d6d 615f 7b69 2b31 7d20 3d20 5c67 616d  mma_{i+1} = \gam
-0008bae0: 6d61 5f7b 697d 202b 2028 5c61 6c70 6861  ma_{i} + (\alpha
-0008baf0: 5f7b 6a7d 202d 205c 6265 7461 5f7b 6a7d  _{j} - \beta_{j}
-0008bb00: 2920 735f 7b6a 7d0a 2020 2020 2020 2020  ) s_{j}.        
-0008bb10: 2020 2020 6767 6d6c 5f76 6563 5f6d 6164      ggml_vec_mad
-0008bb20: 5f66 3332 286e 782c 2064 2c20 266c 6d5f  _f32(nx, d, &lm_
-0008bb30: 735b 6a5b 305d 2a6e 785d 2c20 6c6d 5f61  s[j[0]*nx], lm_a
-0008bb40: 6c70 6861 5b6a 5b30 5d5d 202d 2062 6574  lpha[j[0]] - bet
-0008bb50: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
-0008bb60: 6a5b 305d 203d 2028 6a5b 305d 202b 2031  j[0] = (j[0] + 1
-0008bb70: 2925 6d3b 0a20 2020 2020 2020 207d 0a0a  )%m;.        }..
-0008bb80: 2020 2020 2020 2020 7374 6570 5b30 5d20          step[0] 
-0008bb90: 3d20 312e 303b 0a20 2020 207d 0a0a 2020  = 1.0;.    }..  
-0008bba0: 2020 7265 7475 726e 2047 474d 4c5f 4f50    return GGML_OP
-0008bbb0: 545f 4449 445f 4e4f 545f 434f 4e56 4552  T_DID_NOT_CONVER
-0008bbc0: 4745 3b0a 7d0a 0a73 7472 7563 7420 6767  GE;.}..struct gg
-0008bbd0: 6d6c 5f6f 7074 5f70 6172 616d 7320 6767  ml_opt_params gg
-0008bbe0: 6d6c 5f6f 7074 5f64 6566 6175 6c74 5f70  ml_opt_default_p
-0008bbf0: 6172 616d 7328 656e 756d 2067 676d 6c5f  arams(enum ggml_
-0008bc00: 6f70 745f 7479 7065 2074 7970 6529 207b  opt_type type) {
-0008bc10: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-0008bc20: 5f6f 7074 5f70 6172 616d 7320 7265 7375  _opt_params resu
-0008bc30: 6c74 3b0a 0a20 2020 2073 7769 7463 6820  lt;..    switch 
-0008bc40: 2874 7970 6529 207b 0a20 2020 2020 2020  (type) {.       
-0008bc50: 2063 6173 6520 4747 4d4c 5f4f 5054 5f41   case GGML_OPT_A
-0008bc60: 4441 4d3a 0a20 2020 2020 2020 2020 2020  DAM:.           
-0008bc70: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008bc80: 2020 2072 6573 756c 7420 3d20 2873 7472     result = (str
-0008bc90: 7563 7420 6767 6d6c 5f6f 7074 5f70 6172  uct ggml_opt_par
-0008bca0: 616d 7329 207b 0a20 2020 2020 2020 2020  ams) {.         
-0008bcb0: 2020 2020 2020 2020 2020 202e 7479 7065             .type
-0008bcc0: 2020 2020 2020 3d20 4747 4d4c 5f4f 5054        = GGML_OPT
-0008bcd0: 5f41 4441 4d2c 0a20 2020 2020 2020 2020  _ADAM,.         
-0008bce0: 2020 2020 2020 2020 2020 202e 6e5f 7468             .n_th
-0008bcf0: 7265 6164 7320 3d20 312c 0a20 2020 2020  reads = 1,.     
-0008bd00: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-0008bd10: 7061 7374 2020 2020 2020 3d20 302c 0a20  past      = 0,. 
-0008bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bd30: 2020 202e 6465 6c74 6120 2020 2020 3d20     .delta     = 
-0008bd40: 3165 2d35 662c 0a0a 2020 2020 2020 2020  1e-5f,..        
-0008bd50: 2020 2020 2020 2020 2020 2020 2e6d 6178              .max
-0008bd60: 5f6e 6f5f 696d 7072 6f76 656d 656e 7420  _no_improvement 
-0008bd70: 3d20 3130 302c 0a0a 2020 2020 2020 2020  = 100,..        
-0008bd80: 2020 2020 2020 2020 2020 2020 2e70 7269              .pri
-0008bd90: 6e74 5f66 6f72 7761 7264 5f67 7261 7068  nt_forward_graph
-0008bda0: 2020 3d20 7472 7565 2c0a 2020 2020 2020    = true,.      
-0008bdb0: 2020 2020 2020 2020 2020 2020 2020 2e70                .p
-0008bdc0: 7269 6e74 5f62 6163 6b77 6172 645f 6772  rint_backward_gr
-0008bdd0: 6170 6820 3d20 7472 7565 2c0a 0a20 2020  aph = true,..   
-0008bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bdf0: 202e 6164 616d 203d 207b 0a20 2020 2020   .adam = {.     
+0008b230: 6966 2028 6e5f 6e6f 5f69 6d70 726f 7665  if (n_no_improve
+0008b240: 6d65 6e74 5b30 5d20 3e3d 2070 6172 616d  ment[0] >= param
+0008b250: 732e 6d61 785f 6e6f 5f69 6d70 726f 7665  s.max_no_improve
+0008b260: 6d65 6e74 2920 7b0a 2020 2020 2020 2020  ment) {.        
+0008b270: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0008b280: 726e 2047 474d 4c5f 4f50 545f 4f4b 3b0a  rn GGML_OPT_OK;.
+0008b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008b2a0: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
+0008b2b0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0008b2c0: 2020 2069 6620 2870 6172 616d 732e 6c62     if (params.lb
+0008b2d0: 6667 732e 6e5f 6974 6572 2021 3d20 3020  fgs.n_iter != 0 
+0008b2e0: 2626 2070 6172 616d 732e 6c62 6667 732e  && params.lbfgs.
+0008b2f0: 6e5f 6974 6572 203c 2069 7420 2b20 3129  n_iter < it + 1)
+0008b300: 207b 0a20 2020 2020 2020 2020 2020 202f   {.            /
+0008b310: 2f20 7265 6163 6865 6420 7468 6520 6d61  / reached the ma
+0008b320: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
+0008b330: 6974 6572 6174 696f 6e73 0a20 2020 2020  iterations.     
+0008b340: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
+0008b350: 4d4c 5f4f 5054 5f44 4944 5f4e 4f54 5f43  ML_OPT_DID_NOT_C
+0008b360: 4f4e 5645 5247 453b 0a20 2020 2020 2020  ONVERGE;.       
+0008b370: 207d 0a0a 2020 2020 2020 2020 2f2f 2075   }..        // u
+0008b380: 7064 6174 6520 7665 6374 6f72 7320 7320  pdate vectors s 
+0008b390: 616e 6420 793a 0a20 2020 2020 2020 202f  and y:.        /
+0008b3a0: 2f20 2020 735f 7b6b 2b31 7d20 3d20 785f  /   s_{k+1} = x_
+0008b3b0: 7b6b 2b31 7d20 2d20 785f 7b6b 7d20 3d20  {k+1} - x_{k} = 
+0008b3c0: 5c73 7465 7020 2a20 645f 7b6b 7d2e 0a20  \step * d_{k}.. 
+0008b3d0: 2020 2020 2020 202f 2f20 2020 795f 7b6b         //   y_{k
+0008b3e0: 2b31 7d20 3d20 675f 7b6b 2b31 7d20 2d20  +1} = g_{k+1} - 
+0008b3f0: 675f 7b6b 7d2e 0a20 2020 2020 2020 202f  g_{k}..        /
+0008b400: 2f0a 2020 2020 2020 2020 6767 6d6c 5f76  /.        ggml_v
+0008b410: 6563 5f73 7562 5f66 3332 286e 782c 2026  ec_sub_f32(nx, &
+0008b420: 6c6d 5f73 5b65 6e64 5b30 5d2a 6e78 5d2c  lm_s[end[0]*nx],
+0008b430: 2078 2c20 7870 293b 0a20 2020 2020 2020   x, xp);.       
+0008b440: 2067 676d 6c5f 7665 635f 7375 625f 6633   ggml_vec_sub_f3
+0008b450: 3228 6e78 2c20 266c 6d5f 795b 656e 645b  2(nx, &lm_y[end[
+0008b460: 305d 2a6e 785d 2c20 672c 2067 7029 3b0a  0]*nx], g, gp);.
+0008b470: 0a20 2020 2020 2020 202f 2f20 636f 6d70  .        // comp
+0008b480: 7574 6520 7363 616c 6172 7320 7973 2061  ute scalars ys a
+0008b490: 6e64 2079 793a 0a20 2020 2020 2020 202f  nd yy:.        /
+0008b4a0: 2f20 2020 2020 7973 203d 2079 5e74 205c  /     ys = y^t \
+0008b4b0: 6364 6f74 2073 2020 2020 2d3e 2031 202f  cdot s    -> 1 /
+0008b4c0: 205c 7268 6f2e 0a20 2020 2020 2020 202f   \rho..        /
+0008b4d0: 2f20 2020 2020 7979 203d 2079 5e74 205c  /     yy = y^t \
+0008b4e0: 6364 6f74 2079 2e0a 2020 2020 2020 2020  cdot y..        
+0008b4f0: 2f2f 0a20 2020 2020 2020 2067 676d 6c5f  //.        ggml_
+0008b500: 7665 635f 646f 745f 6633 3228 6e78 2c20  vec_dot_f32(nx, 
+0008b510: 2679 732c 2026 6c6d 5f79 5b65 6e64 5b30  &ys, &lm_y[end[0
+0008b520: 5d2a 6e78 5d2c 2026 6c6d 5f73 5b65 6e64  ]*nx], &lm_s[end
+0008b530: 5b30 5d20 2a6e 785d 293b 0a20 2020 2020  [0] *nx]);.     
+0008b540: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
+0008b550: 6633 3228 6e78 2c20 2679 792c 2026 6c6d  f32(nx, &yy, &lm
+0008b560: 5f79 5b65 6e64 5b30 5d2a 6e78 5d2c 2026  _y[end[0]*nx], &
+0008b570: 6c6d 5f79 5b65 6e64 5b30 5d2a 6e78 5d29  lm_y[end[0]*nx])
+0008b580: 3b0a 0a20 2020 2020 2020 206c 6d5f 7973  ;..        lm_ys
+0008b590: 5b65 6e64 5b30 5d5d 203d 2079 733b 0a0a  [end[0]] = ys;..
+0008b5a0: 2020 2020 2020 2020 2f2f 2066 696e 6420          // find 
+0008b5b0: 6e65 7720 7365 6172 6368 2064 6972 6563  new search direc
+0008b5c0: 7469 6f6e 0a20 2020 2020 2020 202f 2f20  tion.        // 
+0008b5d0: 2020 7265 663a 2068 7474 7073 3a2f 2f65    ref: https://e
+0008b5e0: 6e2e 7769 6b69 7065 6469 612e 6f72 672f  n.wikipedia.org/
+0008b5f0: 7769 6b69 2f4c 696d 6974 6564 2d6d 656d  wiki/Limited-mem
+0008b600: 6f72 795f 4246 4753 0a0a 2020 2020 2020  ory_BFGS..      
+0008b610: 2020 626f 756e 6420 3d20 286d 203c 3d20    bound = (m <= 
+0008b620: 6b5b 305d 2920 3f20 6d20 3a20 6b5b 305d  k[0]) ? m : k[0]
+0008b630: 3b0a 2020 2020 2020 2020 6b5b 305d 2b2b  ;.        k[0]++
+0008b640: 3b0a 2020 2020 2020 2020 6974 2b2b 3b0a  ;.        it++;.
+0008b650: 2020 2020 2020 2020 656e 645b 305d 203d          end[0] =
+0008b660: 2028 656e 645b 305d 202b 2031 2925 6d3b   (end[0] + 1)%m;
+0008b670: 0a0a 2020 2020 2020 2020 2f2f 2069 6e69  ..        // ini
+0008b680: 7469 616c 697a 6520 7365 6172 6368 2064  tialize search d
+0008b690: 6972 6563 7469 6f6e 2077 6974 6820 2d67  irection with -g
+0008b6a0: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
+0008b6b0: 635f 6e65 675f 6633 3228 6e78 2c20 642c  c_neg_f32(nx, d,
+0008b6c0: 2067 293b 0a0a 2020 2020 2020 2020 6a5b   g);..        j[
+0008b6d0: 305d 203d 2065 6e64 5b30 5d3b 0a20 2020  0] = end[0];.   
+0008b6e0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+0008b6f0: 3d20 303b 2069 203c 2062 6f75 6e64 3b20  = 0; i < bound; 
+0008b700: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
+0008b710: 2020 206a 5b30 5d20 3d20 286a 5b30 5d20     j[0] = (j[0] 
+0008b720: 2b20 6d20 2d20 3129 2025 206d 3b0a 2020  + m - 1) % m;.  
+0008b730: 2020 2020 2020 2020 2020 2f2f 205c 616c            // \al
+0008b740: 7068 615f 7b6a 7d20 3d20 5c72 686f 5f7b  pha_{j} = \rho_{
+0008b750: 6a7d 2073 5e7b 747d 5f7b 6a7d 205c 6364  j} s^{t}_{j} \cd
+0008b760: 6f74 2071 5f7b 6b2b 317d 0a20 2020 2020  ot q_{k+1}.     
+0008b770: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0008b780: 646f 745f 6633 3228 6e78 2c20 266c 6d5f  dot_f32(nx, &lm_
+0008b790: 616c 7068 615b 6a5b 305d 5d2c 2026 6c6d  alpha[j[0]], &lm
+0008b7a0: 5f73 5b6a 5b30 5d2a 6e78 5d2c 2064 293b  _s[j[0]*nx], d);
+0008b7b0: 0a20 2020 2020 2020 2020 2020 206c 6d5f  .            lm_
+0008b7c0: 616c 7068 615b 6a5b 305d 5d20 2f3d 206c  alpha[j[0]] /= l
+0008b7d0: 6d5f 7973 5b6a 5b30 5d5d 3b0a 2020 2020  m_ys[j[0]];.    
+0008b7e0: 2020 2020 2020 2020 2f2f 2071 5f7b 697d          // q_{i}
+0008b7f0: 203d 2071 5f7b 692b 317d 202d 205c 616c   = q_{i+1} - \al
+0008b800: 7068 615f 7b69 7d20 795f 7b69 7d0a 2020  pha_{i} y_{i}.  
+0008b810: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+0008b820: 6563 5f6d 6164 5f66 3332 286e 782c 2064  ec_mad_f32(nx, d
+0008b830: 2c20 266c 6d5f 795b 6a5b 305d 2a6e 785d  , &lm_y[j[0]*nx]
+0008b840: 2c20 2d6c 6d5f 616c 7068 615b 6a5b 305d  , -lm_alpha[j[0]
+0008b850: 5d29 3b0a 2020 2020 2020 2020 7d0a 0a20  ]);.        }.. 
+0008b860: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0008b870: 7363 616c 655f 6633 3228 6e78 2c20 642c  scale_f32(nx, d,
+0008b880: 2079 732f 7979 293b 0a0a 2020 2020 2020   ys/yy);..      
+0008b890: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0008b8a0: 3b20 6920 3c20 626f 756e 643b 202b 2b69  ; i < bound; ++i
+0008b8b0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008b8c0: 2f2f 205c 6265 7461 5f7b 6a7d 203d 205c  // \beta_{j} = \
+0008b8d0: 7268 6f5f 7b6a 7d20 795e 745f 7b6a 7d20  rho_{j} y^t_{j} 
+0008b8e0: 5c63 646f 7420 5c67 616d 6d61 5f7b 697d  \cdot \gamma_{i}
+0008b8f0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0008b900: 6c5f 7665 635f 646f 745f 6633 3228 6e78  l_vec_dot_f32(nx
+0008b910: 2c20 2662 6574 612c 2026 6c6d 5f79 5b6a  , &beta, &lm_y[j
+0008b920: 5b30 5d2a 6e78 5d2c 2064 293b 0a20 2020  [0]*nx], d);.   
+0008b930: 2020 2020 2020 2020 2062 6574 6120 2f3d           beta /=
+0008b940: 206c 6d5f 7973 5b6a 5b30 5d5d 3b0a 2020   lm_ys[j[0]];.  
+0008b950: 2020 2020 2020 2020 2020 2f2f 205c 6761            // \ga
+0008b960: 6d6d 615f 7b69 2b31 7d20 3d20 5c67 616d  mma_{i+1} = \gam
+0008b970: 6d61 5f7b 697d 202b 2028 5c61 6c70 6861  ma_{i} + (\alpha
+0008b980: 5f7b 6a7d 202d 205c 6265 7461 5f7b 6a7d  _{j} - \beta_{j}
+0008b990: 2920 735f 7b6a 7d0a 2020 2020 2020 2020  ) s_{j}.        
+0008b9a0: 2020 2020 6767 6d6c 5f76 6563 5f6d 6164      ggml_vec_mad
+0008b9b0: 5f66 3332 286e 782c 2064 2c20 266c 6d5f  _f32(nx, d, &lm_
+0008b9c0: 735b 6a5b 305d 2a6e 785d 2c20 6c6d 5f61  s[j[0]*nx], lm_a
+0008b9d0: 6c70 6861 5b6a 5b30 5d5d 202d 2062 6574  lpha[j[0]] - bet
+0008b9e0: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
+0008b9f0: 6a5b 305d 203d 2028 6a5b 305d 202b 2031  j[0] = (j[0] + 1
+0008ba00: 2925 6d3b 0a20 2020 2020 2020 207d 0a0a  )%m;.        }..
+0008ba10: 2020 2020 2020 2020 7374 6570 5b30 5d20          step[0] 
+0008ba20: 3d20 312e 303b 0a20 2020 207d 0a0a 2020  = 1.0;.    }..  
+0008ba30: 2020 7265 7475 726e 2047 474d 4c5f 4f50    return GGML_OP
+0008ba40: 545f 4449 445f 4e4f 545f 434f 4e56 4552  T_DID_NOT_CONVER
+0008ba50: 4745 3b0a 7d0a 0a73 7472 7563 7420 6767  GE;.}..struct gg
+0008ba60: 6d6c 5f6f 7074 5f70 6172 616d 7320 6767  ml_opt_params gg
+0008ba70: 6d6c 5f6f 7074 5f64 6566 6175 6c74 5f70  ml_opt_default_p
+0008ba80: 6172 616d 7328 656e 756d 2067 676d 6c5f  arams(enum ggml_
+0008ba90: 6f70 745f 7479 7065 2074 7970 6529 207b  opt_type type) {
+0008baa0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+0008bab0: 5f6f 7074 5f70 6172 616d 7320 7265 7375  _opt_params resu
+0008bac0: 6c74 3b0a 0a20 2020 2073 7769 7463 6820  lt;..    switch 
+0008bad0: 2874 7970 6529 207b 0a20 2020 2020 2020  (type) {.       
+0008bae0: 2063 6173 6520 4747 4d4c 5f4f 5054 5f41   case GGML_OPT_A
+0008baf0: 4441 4d3a 0a20 2020 2020 2020 2020 2020  DAM:.           
+0008bb00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0008bb10: 2020 2072 6573 756c 7420 3d20 2873 7472     result = (str
+0008bb20: 7563 7420 6767 6d6c 5f6f 7074 5f70 6172  uct ggml_opt_par
+0008bb30: 616d 7329 207b 0a20 2020 2020 2020 2020  ams) {.         
+0008bb40: 2020 2020 2020 2020 2020 202e 7479 7065             .type
+0008bb50: 2020 2020 2020 3d20 4747 4d4c 5f4f 5054        = GGML_OPT
+0008bb60: 5f41 4441 4d2c 0a20 2020 2020 2020 2020  _ADAM,.         
+0008bb70: 2020 2020 2020 2020 2020 202e 6e5f 7468             .n_th
+0008bb80: 7265 6164 7320 3d20 312c 0a20 2020 2020  reads = 1,.     
+0008bb90: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+0008bba0: 7061 7374 2020 2020 2020 3d20 302c 0a20  past      = 0,. 
+0008bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bbc0: 2020 202e 6465 6c74 6120 2020 2020 3d20     .delta     = 
+0008bbd0: 3165 2d35 662c 0a0a 2020 2020 2020 2020  1e-5f,..        
+0008bbe0: 2020 2020 2020 2020 2020 2020 2e6d 6178              .max
+0008bbf0: 5f6e 6f5f 696d 7072 6f76 656d 656e 7420  _no_improvement 
+0008bc00: 3d20 3130 302c 0a0a 2020 2020 2020 2020  = 100,..        
+0008bc10: 2020 2020 2020 2020 2020 2020 2e70 7269              .pri
+0008bc20: 6e74 5f66 6f72 7761 7264 5f67 7261 7068  nt_forward_graph
+0008bc30: 2020 3d20 7472 7565 2c0a 2020 2020 2020    = true,.      
+0008bc40: 2020 2020 2020 2020 2020 2020 2020 2e70                .p
+0008bc50: 7269 6e74 5f62 6163 6b77 6172 645f 6772  rint_backward_gr
+0008bc60: 6170 6820 3d20 7472 7565 2c0a 0a20 2020  aph = true,..   
+0008bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bc80: 202e 6164 616d 203d 207b 0a20 2020 2020   .adam = {.     
+0008bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bca0: 2020 202e 6e5f 6974 6572 203d 2031 3030     .n_iter = 100
+0008bcb0: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+0008bcc0: 2020 2020 2020 2020 2020 2020 2e73 6368              .sch
+0008bcd0: 6564 2020 3d20 312e 3030 3066 2c0a 2020  ed  = 1.000f,.  
+0008bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bcf0: 2020 2020 2020 2e64 6563 6179 2020 3d20        .decay  = 
+0008bd00: 302e 3030 3166 2c0a 2020 2020 2020 2020  0.001f,.        
+0008bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bd20: 2e61 6c70 6861 2020 3d20 302e 3030 3166  .alpha  = 0.001f
+0008bd30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0008bd40: 2020 2020 2020 2020 2020 2e62 6574 6131            .beta1
+0008bd50: 2020 3d20 302e 3966 2c0a 2020 2020 2020    = 0.9f,.      
+0008bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bd70: 2020 2e62 6574 6132 2020 3d20 302e 3939    .beta2  = 0.99
+0008bd80: 3966 2c0a 2020 2020 2020 2020 2020 2020  9f,.            
+0008bd90: 2020 2020 2020 2020 2020 2020 2e65 7073              .eps
+0008bda0: 2020 2020 3d20 3165 2d38 662c 0a20 2020      = 1e-8f,.   
+0008bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bdc0: 2020 2020 202e 6570 735f 6620 203d 2031       .eps_f  = 1
+0008bdd0: 652d 3566 2c0a 2020 2020 2020 2020 2020  e-5f,.          
+0008bde0: 2020 2020 2020 2020 2020 2020 2020 2e65                .e
+0008bdf0: 7073 5f67 2020 3d20 3165 2d33 662c 0a20  ps_g  = 1e-3f,. 
 0008be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008be10: 2020 202e 6e5f 6974 6572 203d 2031 3030     .n_iter = 100
-0008be20: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-0008be30: 2020 2020 2020 2020 2020 2020 2e73 6368              .sch
-0008be40: 6564 2020 3d20 312e 3030 3066 2c0a 2020  ed  = 1.000f,.  
-0008be50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008be60: 2020 2020 2020 2e64 6563 6179 2020 3d20        .decay  = 
-0008be70: 302e 3030 3166 2c0a 2020 2020 2020 2020  0.001f,.        
-0008be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008be90: 2e61 6c70 6861 2020 3d20 302e 3030 3166  .alpha  = 0.001f
-0008bea0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0008beb0: 2020 2020 2020 2020 2020 2e62 6574 6131            .beta1
-0008bec0: 2020 3d20 302e 3966 2c0a 2020 2020 2020    = 0.9f,.      
+0008be10: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+0008be20: 2020 2020 2020 7d3b 0a20 2020 2020 2020        };.       
+0008be30: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0008be40: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0008be50: 4f50 545f 4c42 4647 533a 0a20 2020 2020  OPT_LBFGS:.     
+0008be60: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0008be70: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+0008be80: 3d20 2873 7472 7563 7420 6767 6d6c 5f6f  = (struct ggml_o
+0008be90: 7074 5f70 6172 616d 7329 207b 0a20 2020  pt_params) {.   
+0008bea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008beb0: 202e 7479 7065 2020 2020 2020 3d20 4747   .type      = GG
+0008bec0: 4d4c 5f4f 5054 5f4c 4246 4753 2c0a 2020  ML_OPT_LBFGS,.  
 0008bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bee0: 2020 2e62 6574 6132 2020 3d20 302e 3939    .beta2  = 0.99
-0008bef0: 3966 2c0a 2020 2020 2020 2020 2020 2020  9f,.            
-0008bf00: 2020 2020 2020 2020 2020 2020 2e65 7073              .eps
-0008bf10: 2020 2020 3d20 3165 2d38 662c 0a20 2020      = 1e-8f,.   
-0008bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bf30: 2020 2020 202e 6570 735f 6620 203d 2031       .eps_f  = 1
-0008bf40: 652d 3566 2c0a 2020 2020 2020 2020 2020  e-5f,.          
-0008bf50: 2020 2020 2020 2020 2020 2020 2020 2e65                .e
-0008bf60: 7073 5f67 2020 3d20 3165 2d33 662c 0a20  ps_g  = 1e-3f,. 
+0008bee0: 2020 2e6e 5f74 6872 6561 6473 203d 2031    .n_threads = 1
+0008bef0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0008bf00: 2020 2020 2020 2e70 6173 7420 2020 2020        .past     
+0008bf10: 203d 2030 2c0a 2020 2020 2020 2020 2020   = 0,.          
+0008bf20: 2020 2020 2020 2020 2020 2e64 656c 7461            .delta
+0008bf30: 2020 2020 203d 2031 652d 3566 2c0a 0a20       = 1e-5f,.. 
+0008bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bf50: 2020 202e 6d61 785f 6e6f 5f69 6d70 726f     .max_no_impro
+0008bf60: 7665 6d65 6e74 203d 2030 2c0a 0a20 2020  vement = 0,..   
 0008bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bf80: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-0008bf90: 2020 2020 2020 7d3b 0a20 2020 2020 2020        };.       
-0008bfa0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0008bfb0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0008bfc0: 4f50 545f 4c42 4647 533a 0a20 2020 2020  OPT_LBFGS:.     
-0008bfd0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0008bfe0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-0008bff0: 3d20 2873 7472 7563 7420 6767 6d6c 5f6f  = (struct ggml_o
-0008c000: 7074 5f70 6172 616d 7329 207b 0a20 2020  pt_params) {.   
-0008c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c020: 202e 7479 7065 2020 2020 2020 3d20 4747   .type      = GG
-0008c030: 4d4c 5f4f 5054 5f4c 4246 4753 2c0a 2020  ML_OPT_LBFGS,.  
-0008c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c050: 2020 2e6e 5f74 6872 6561 6473 203d 2031    .n_threads = 1
-0008c060: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0008c070: 2020 2020 2020 2e70 6173 7420 2020 2020        .past     
-0008c080: 203d 2030 2c0a 2020 2020 2020 2020 2020   = 0,.          
-0008c090: 2020 2020 2020 2020 2020 2e64 656c 7461            .delta
-0008c0a0: 2020 2020 203d 2031 652d 3566 2c0a 0a20       = 1e-5f,.. 
-0008c0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c0c0: 2020 202e 6d61 785f 6e6f 5f69 6d70 726f     .max_no_impro
-0008c0d0: 7665 6d65 6e74 203d 2030 2c0a 0a20 2020  vement = 0,..   
-0008c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c0f0: 202e 7072 696e 745f 666f 7277 6172 645f   .print_forward_
-0008c100: 6772 6170 6820 203d 2074 7275 652c 0a20  graph  = true,. 
-0008c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c120: 2020 202e 7072 696e 745f 6261 636b 7761     .print_backwa
-0008c130: 7264 5f67 7261 7068 203d 2074 7275 652c  rd_graph = true,
-0008c140: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0008c150: 2020 2020 2020 2e6c 6266 6773 203d 207b        .lbfgs = {
-0008c160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008c170: 2020 2020 2020 2020 202e 6d20 2020 2020           .m     
-0008c180: 2020 2020 2020 2020 203d 2036 2c0a 2020           = 6,.  
-0008c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c1a0: 2020 2020 2020 2e6e 5f69 7465 7220 2020        .n_iter   
-0008c1b0: 2020 2020 2020 3d20 3130 302c 0a20 2020        = 100,.   
-0008c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c1d0: 2020 2020 202e 6d61 785f 6c69 6e65 7365       .max_linese
-0008c1e0: 6172 6368 203d 2032 302c 0a0a 2020 2020  arch = 20,..    
-0008c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c200: 2020 2020 2e65 7073 2020 2020 2020 3d20      .eps      = 
-0008c210: 3165 2d35 662c 0a20 2020 2020 2020 2020  1e-5f,.         
-0008c220: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-0008c230: 6674 6f6c 2020 2020 203d 2031 652d 3466  ftol     = 1e-4f
-0008c240: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0008c250: 2020 2020 2020 2020 2020 2e77 6f6c 6665            .wolfe
-0008c260: 2020 2020 3d20 302e 3966 2c0a 2020 2020      = 0.9f,.    
-0008c270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c280: 2020 2020 2e6d 696e 5f73 7465 7020 3d20      .min_step = 
-0008c290: 3165 2d32 3066 2c0a 2020 2020 2020 2020  1e-20f,.        
-0008c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c2b0: 2e6d 6178 5f73 7465 7020 3d20 3165 2b32  .max_step = 1e+2
-0008c2c0: 3066 2c0a 0a20 2020 2020 2020 2020 2020  0f,..           
-0008c2d0: 2020 2020 2020 2020 2020 2020 202e 6c69               .li
-0008c2e0: 6e65 7365 6172 6368 203d 2047 474d 4c5f  nesearch = GGML_
-0008c2f0: 4c49 4e45 5345 4152 4348 5f44 4546 4155  LINESEARCH_DEFAU
-0008c300: 4c54 2c0a 2020 2020 2020 2020 2020 2020  LT,.            
-0008c310: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-0008c320: 2020 2020 2020 2020 2020 207d 3b0a 2020             };.  
-0008c330: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0008c340: 6b3b 0a20 2020 207d 0a0a 2020 2020 7265  k;.    }..    re
-0008c350: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-0008c360: 4747 4d4c 5f41 5049 2076 6f69 6420 6767  GGML_API void gg
-0008c370: 6d6c 5f6f 7074 5f69 6e69 7428 0a20 2020  ml_opt_init(.   
-0008c380: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0008c390: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0008c3a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0008c3b0: 676d 6c5f 6f70 745f 636f 6e74 6578 7420  gml_opt_context 
-0008c3c0: 2a20 6f70 742c 0a20 2020 2020 2020 2073  * opt,.        s
-0008c3d0: 7472 7563 7420 6767 6d6c 5f6f 7074 5f70  truct ggml_opt_p
-0008c3e0: 6172 616d 7320 7061 7261 6d73 2c0a 2020  arams params,.  
-0008c3f0: 2020 2020 2020 696e 7436 345f 7420 6e78        int64_t nx
-0008c400: 2920 7b0a 2020 2020 6f70 742d 3e63 7478  ) {.    opt->ctx
-0008c410: 203d 2063 7478 3b0a 2020 2020 6f70 742d   = ctx;.    opt-
-0008c420: 3e70 6172 616d 7320 3d20 7061 7261 6d73  >params = params
-0008c430: 3b0a 2020 2020 6f70 742d 3e69 7465 7220  ;.    opt->iter 
-0008c440: 3d20 303b 0a20 2020 206f 7074 2d3e 6e78  = 0;.    opt->nx
-0008c450: 203d 206e 783b 0a20 2020 206f 7074 2d3e   = nx;.    opt->
-0008c460: 6a75 7374 5f69 6e69 7469 616c 697a 6564  just_initialized
-0008c470: 203d 2074 7275 653b 0a20 2020 2073 7769   = true;.    swi
-0008c480: 7463 6820 286f 7074 2d3e 7061 7261 6d73  tch (opt->params
-0008c490: 2e74 7970 6529 207b 0a20 2020 2020 2020  .type) {.       
-0008c4a0: 2063 6173 6520 4747 4d4c 5f4f 5054 5f41   case GGML_OPT_A
-0008c4b0: 4441 4d3a 0a20 2020 2020 2020 2020 2020  DAM:.           
-0008c4c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008c4d0: 2020 206f 7074 2d3e 6164 616d 2e78 2020     opt->adam.x  
-0008c4e0: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-0008c4f0: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-0008c500: 5950 455f 4633 322c 206e 7829 3b0a 2020  YPE_F32, nx);.  
-0008c510: 2020 2020 2020 2020 2020 2020 2020 6f70                op
-0008c520: 742d 3e61 6461 6d2e 6731 203d 2067 676d  t->adam.g1 = ggm
-0008c530: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
-0008c540: 6374 782c 2047 474d 4c5f 5459 5045 5f46  ctx, GGML_TYPE_F
-0008c550: 3332 2c20 6e78 293b 0a20 2020 2020 2020  32, nx);.       
-0008c560: 2020 2020 2020 2020 206f 7074 2d3e 6164           opt->ad
-0008c570: 616d 2e67 3220 3d20 6767 6d6c 5f6e 6577  am.g2 = ggml_new
-0008c580: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
-0008c590: 4747 4d4c 5f54 5950 455f 4633 322c 206e  GGML_TYPE_F32, n
-0008c5a0: 7829 3b0a 2020 2020 2020 2020 2020 2020  x);.            
-0008c5b0: 2020 2020 6f70 742d 3e61 6461 6d2e 6d20      opt->adam.m 
-0008c5c0: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
-0008c5d0: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
-0008c5e0: 5459 5045 5f46 3332 2c20 6e78 293b 0a20  TYPE_F32, nx);. 
-0008c5f0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0008c600: 7074 2d3e 6164 616d 2e76 2020 3d20 6767  pt->adam.v  = gg
-0008c610: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
-0008c620: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
-0008c630: 4633 322c 206e 7829 3b0a 2020 2020 2020  F32, nx);.      
-0008c640: 2020 2020 2020 2020 2020 6f70 742d 3e61            opt->a
-0008c650: 6461 6d2e 6d68 203d 2067 676d 6c5f 6e65  dam.mh = ggml_ne
-0008c660: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
-0008c670: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
-0008c680: 6e78 293b 0a20 2020 2020 2020 2020 2020  nx);.           
-0008c690: 2020 2020 206f 7074 2d3e 6164 616d 2e76       opt->adam.v
-0008c6a0: 6820 3d20 6767 6d6c 5f6e 6577 5f74 656e  h = ggml_new_ten
-0008c6b0: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
-0008c6c0: 5f54 5950 455f 4633 322c 206e 7829 3b0a  _TYPE_F32, nx);.
-0008c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c6e0: 6f70 742d 3e61 6461 6d2e 7066 203d 2070  opt->adam.pf = p
-0008c6f0: 6172 616d 732e 7061 7374 203e 2030 0a20  arams.past > 0. 
+0008bf80: 202e 7072 696e 745f 666f 7277 6172 645f   .print_forward_
+0008bf90: 6772 6170 6820 203d 2074 7275 652c 0a20  graph  = true,. 
+0008bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bfb0: 2020 202e 7072 696e 745f 6261 636b 7761     .print_backwa
+0008bfc0: 7264 5f67 7261 7068 203d 2074 7275 652c  rd_graph = true,
+0008bfd0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0008bfe0: 2020 2020 2020 2e6c 6266 6773 203d 207b        .lbfgs = {
+0008bff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008c000: 2020 2020 2020 2020 202e 6d20 2020 2020           .m     
+0008c010: 2020 2020 2020 2020 203d 2036 2c0a 2020           = 6,.  
+0008c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c030: 2020 2020 2020 2e6e 5f69 7465 7220 2020        .n_iter   
+0008c040: 2020 2020 2020 3d20 3130 302c 0a20 2020        = 100,.   
+0008c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c060: 2020 2020 202e 6d61 785f 6c69 6e65 7365       .max_linese
+0008c070: 6172 6368 203d 2032 302c 0a0a 2020 2020  arch = 20,..    
+0008c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c090: 2020 2020 2e65 7073 2020 2020 2020 3d20      .eps      = 
+0008c0a0: 3165 2d35 662c 0a20 2020 2020 2020 2020  1e-5f,.         
+0008c0b0: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+0008c0c0: 6674 6f6c 2020 2020 203d 2031 652d 3466  ftol     = 1e-4f
+0008c0d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0008c0e0: 2020 2020 2020 2020 2020 2e77 6f6c 6665            .wolfe
+0008c0f0: 2020 2020 3d20 302e 3966 2c0a 2020 2020      = 0.9f,.    
+0008c100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c110: 2020 2020 2e6d 696e 5f73 7465 7020 3d20      .min_step = 
+0008c120: 3165 2d32 3066 2c0a 2020 2020 2020 2020  1e-20f,.        
+0008c130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c140: 2e6d 6178 5f73 7465 7020 3d20 3165 2b32  .max_step = 1e+2
+0008c150: 3066 2c0a 0a20 2020 2020 2020 2020 2020  0f,..           
+0008c160: 2020 2020 2020 2020 2020 2020 202e 6c69               .li
+0008c170: 6e65 7365 6172 6368 203d 2047 474d 4c5f  nesearch = GGML_
+0008c180: 4c49 4e45 5345 4152 4348 5f44 4546 4155  LINESEARCH_DEFAU
+0008c190: 4c54 2c0a 2020 2020 2020 2020 2020 2020  LT,.            
+0008c1a0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+0008c1b0: 2020 2020 2020 2020 2020 207d 3b0a 2020             };.  
+0008c1c0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0008c1d0: 6b3b 0a20 2020 207d 0a0a 2020 2020 7265  k;.    }..    re
+0008c1e0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+0008c1f0: 4747 4d4c 5f41 5049 2076 6f69 6420 6767  GGML_API void gg
+0008c200: 6d6c 5f6f 7074 5f69 6e69 7428 0a20 2020  ml_opt_init(.   
+0008c210: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0008c220: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+0008c230: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0008c240: 676d 6c5f 6f70 745f 636f 6e74 6578 7420  gml_opt_context 
+0008c250: 2a20 6f70 742c 0a20 2020 2020 2020 2073  * opt,.        s
+0008c260: 7472 7563 7420 6767 6d6c 5f6f 7074 5f70  truct ggml_opt_p
+0008c270: 6172 616d 7320 7061 7261 6d73 2c0a 2020  arams params,.  
+0008c280: 2020 2020 2020 696e 7436 345f 7420 6e78        int64_t nx
+0008c290: 2920 7b0a 2020 2020 6f70 742d 3e63 7478  ) {.    opt->ctx
+0008c2a0: 203d 2063 7478 3b0a 2020 2020 6f70 742d   = ctx;.    opt-
+0008c2b0: 3e70 6172 616d 7320 3d20 7061 7261 6d73  >params = params
+0008c2c0: 3b0a 2020 2020 6f70 742d 3e69 7465 7220  ;.    opt->iter 
+0008c2d0: 3d20 303b 0a20 2020 206f 7074 2d3e 6e78  = 0;.    opt->nx
+0008c2e0: 203d 206e 783b 0a20 2020 206f 7074 2d3e   = nx;.    opt->
+0008c2f0: 6a75 7374 5f69 6e69 7469 616c 697a 6564  just_initialized
+0008c300: 203d 2074 7275 653b 0a20 2020 2073 7769   = true;.    swi
+0008c310: 7463 6820 286f 7074 2d3e 7061 7261 6d73  tch (opt->params
+0008c320: 2e74 7970 6529 207b 0a20 2020 2020 2020  .type) {.       
+0008c330: 2063 6173 6520 4747 4d4c 5f4f 5054 5f41   case GGML_OPT_A
+0008c340: 4441 4d3a 0a20 2020 2020 2020 2020 2020  DAM:.           
+0008c350: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0008c360: 2020 206f 7074 2d3e 6164 616d 2e78 2020     opt->adam.x  
+0008c370: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
+0008c380: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
+0008c390: 5950 455f 4633 322c 206e 7829 3b0a 2020  YPE_F32, nx);.  
+0008c3a0: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+0008c3b0: 742d 3e61 6461 6d2e 6731 203d 2067 676d  t->adam.g1 = ggm
+0008c3c0: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
+0008c3d0: 6374 782c 2047 474d 4c5f 5459 5045 5f46  ctx, GGML_TYPE_F
+0008c3e0: 3332 2c20 6e78 293b 0a20 2020 2020 2020  32, nx);.       
+0008c3f0: 2020 2020 2020 2020 206f 7074 2d3e 6164           opt->ad
+0008c400: 616d 2e67 3220 3d20 6767 6d6c 5f6e 6577  am.g2 = ggml_new
+0008c410: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
+0008c420: 4747 4d4c 5f54 5950 455f 4633 322c 206e  GGML_TYPE_F32, n
+0008c430: 7829 3b0a 2020 2020 2020 2020 2020 2020  x);.            
+0008c440: 2020 2020 6f70 742d 3e61 6461 6d2e 6d20      opt->adam.m 
+0008c450: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+0008c460: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+0008c470: 5459 5045 5f46 3332 2c20 6e78 293b 0a20  TYPE_F32, nx);. 
+0008c480: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0008c490: 7074 2d3e 6164 616d 2e76 2020 3d20 6767  pt->adam.v  = gg
+0008c4a0: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
+0008c4b0: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
+0008c4c0: 4633 322c 206e 7829 3b0a 2020 2020 2020  F32, nx);.      
+0008c4d0: 2020 2020 2020 2020 2020 6f70 742d 3e61            opt->a
+0008c4e0: 6461 6d2e 6d68 203d 2067 676d 6c5f 6e65  dam.mh = ggml_ne
+0008c4f0: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
+0008c500: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
+0008c510: 6e78 293b 0a20 2020 2020 2020 2020 2020  nx);.           
+0008c520: 2020 2020 206f 7074 2d3e 6164 616d 2e76       opt->adam.v
+0008c530: 6820 3d20 6767 6d6c 5f6e 6577 5f74 656e  h = ggml_new_ten
+0008c540: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
+0008c550: 5f54 5950 455f 4633 322c 206e 7829 3b0a  _TYPE_F32, nx);.
+0008c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c570: 6f70 742d 3e61 6461 6d2e 7066 203d 2070  opt->adam.pf = p
+0008c580: 6172 616d 732e 7061 7374 203e 2030 0a20  arams.past > 0. 
+0008c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c5a0: 2020 203f 2067 676d 6c5f 6e65 775f 7465     ? ggml_new_te
+0008c5b0: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
+0008c5c0: 4c5f 5459 5045 5f46 3332 2c20 7061 7261  L_TYPE_F32, para
+0008c5d0: 6d73 2e70 6173 7429 0a20 2020 2020 2020  ms.past).       
+0008c5e0: 2020 2020 2020 2020 2020 2020 203a 204e               : N
+0008c5f0: 554c 4c3b 0a20 2020 2020 2020 2020 2020  ULL;.           
+0008c600: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
+0008c610: 726f 286f 7074 2d3e 6164 616d 2e78 293b  ro(opt->adam.x);
+0008c620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008c630: 2067 676d 6c5f 7365 745f 7a65 726f 286f   ggml_set_zero(o
+0008c640: 7074 2d3e 6164 616d 2e67 3129 3b0a 2020  pt->adam.g1);.  
+0008c650: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0008c660: 6d6c 5f73 6574 5f7a 6572 6f28 6f70 742d  ml_set_zero(opt-
+0008c670: 3e61 6461 6d2e 6732 293b 0a20 2020 2020  >adam.g2);.     
+0008c680: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0008c690: 7365 745f 7a65 726f 286f 7074 2d3e 6164  set_zero(opt->ad
+0008c6a0: 616d 2e6d 293b 0a20 2020 2020 2020 2020  am.m);.         
+0008c6b0: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
+0008c6c0: 7a65 726f 286f 7074 2d3e 6164 616d 2e76  zero(opt->adam.v
+0008c6d0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0008c6e0: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
+0008c6f0: 286f 7074 2d3e 6164 616d 2e6d 6829 3b0a  (opt->adam.mh);.
 0008c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c710: 2020 203f 2067 676d 6c5f 6e65 775f 7465     ? ggml_new_te
-0008c720: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
-0008c730: 4c5f 5459 5045 5f46 3332 2c20 7061 7261  L_TYPE_F32, para
-0008c740: 6d73 2e70 6173 7429 0a20 2020 2020 2020  ms.past).       
-0008c750: 2020 2020 2020 2020 2020 2020 203a 204e               : N
-0008c760: 554c 4c3b 0a20 2020 2020 2020 2020 2020  ULL;.           
-0008c770: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
-0008c780: 726f 286f 7074 2d3e 6164 616d 2e78 293b  ro(opt->adam.x);
-0008c790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008c7a0: 2067 676d 6c5f 7365 745f 7a65 726f 286f   ggml_set_zero(o
-0008c7b0: 7074 2d3e 6164 616d 2e67 3129 3b0a 2020  pt->adam.g1);.  
-0008c7c0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0008c7d0: 6d6c 5f73 6574 5f7a 6572 6f28 6f70 742d  ml_set_zero(opt-
-0008c7e0: 3e61 6461 6d2e 6732 293b 0a20 2020 2020  >adam.g2);.     
-0008c7f0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0008c800: 7365 745f 7a65 726f 286f 7074 2d3e 6164  set_zero(opt->ad
-0008c810: 616d 2e6d 293b 0a20 2020 2020 2020 2020  am.m);.         
-0008c820: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
-0008c830: 7a65 726f 286f 7074 2d3e 6164 616d 2e76  zero(opt->adam.v
-0008c840: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0008c850: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
-0008c860: 286f 7074 2d3e 6164 616d 2e6d 6829 3b0a  (opt->adam.mh);.
-0008c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c880: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
-0008c890: 742d 3e61 6461 6d2e 7668 293b 0a20 2020  t->adam.vh);.   
-0008c8a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0008c8b0: 286f 7074 2d3e 6164 616d 2e70 6629 207b  (opt->adam.pf) {
-0008c8c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008c8d0: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
-0008c8e0: 726f 286f 7074 2d3e 6164 616d 2e70 6629  ro(opt->adam.pf)
-0008c8f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0008c900: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0008c910: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0008c920: 2063 6173 6520 4747 4d4c 5f4f 5054 5f4c   case GGML_OPT_L
-0008c930: 4246 4753 3a0a 2020 2020 2020 2020 2020  BFGS:.          
-0008c940: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0008c950: 2020 2020 6f70 742d 3e6c 6266 6773 2e78      opt->lbfgs.x
-0008c960: 2020 3d20 6767 6d6c 5f6e 6577 5f74 656e    = ggml_new_ten
-0008c970: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
-0008c980: 5f54 5950 455f 4633 322c 206e 7829 3b0a  _TYPE_F32, nx);.
-0008c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008c9a0: 6f70 742d 3e6c 6266 6773 2e78 7020 3d20  opt->lbfgs.xp = 
-0008c9b0: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
-0008c9c0: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
-0008c9d0: 455f 4633 322c 206e 7829 3b0a 2020 2020  E_F32, nx);.    
-0008c9e0: 2020 2020 2020 2020 2020 2020 6f70 742d              opt-
-0008c9f0: 3e6c 6266 6773 2e67 2020 3d20 6767 6d6c  >lbfgs.g  = ggml
-0008ca00: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
-0008ca10: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
-0008ca20: 322c 206e 7829 3b0a 2020 2020 2020 2020  2, nx);.        
-0008ca30: 2020 2020 2020 2020 6f70 742d 3e6c 6266          opt->lbf
-0008ca40: 6773 2e67 7020 3d20 6767 6d6c 5f6e 6577  gs.gp = ggml_new
-0008ca50: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
-0008ca60: 4747 4d4c 5f54 5950 455f 4633 322c 206e  GGML_TYPE_F32, n
-0008ca70: 7829 3b0a 2020 2020 2020 2020 2020 2020  x);.            
-0008ca80: 2020 2020 6f70 742d 3e6c 6266 6773 2e64      opt->lbfgs.d
-0008ca90: 2020 3d20 6767 6d6c 5f6e 6577 5f74 656e    = ggml_new_ten
-0008caa0: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
-0008cab0: 5f54 5950 455f 4633 322c 206e 7829 3b0a  _TYPE_F32, nx);.
-0008cac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008cad0: 6f70 742d 3e6c 6266 6773 2e70 6620 3d20  opt->lbfgs.pf = 
-0008cae0: 7061 7261 6d73 2e70 6173 7420 3e20 300a  params.past > 0.
-0008caf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008cb00: 2020 2020 3f20 6767 6d6c 5f6e 6577 5f74      ? ggml_new_t
-0008cb10: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
-0008cb20: 4d4c 5f54 5950 455f 4633 322c 2070 6172  ML_TYPE_F32, par
-0008cb30: 616d 732e 7061 7374 290a 2020 2020 2020  ams.past).      
-0008cb40: 2020 2020 2020 2020 2020 2020 2020 3a20                : 
-0008cb50: 4e55 4c4c 3b0a 2020 2020 2020 2020 2020  NULL;.          
-0008cb60: 2020 2020 2020 6f70 742d 3e6c 6266 6773        opt->lbfgs
-0008cb70: 2e6c 6d61 6c20 3d20 6767 6d6c 5f6e 6577  .lmal = ggml_new
-0008cb80: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
-0008cb90: 4747 4d4c 5f54 5950 455f 4633 322c 2070  GGML_TYPE_F32, p
-0008cba0: 6172 616d 732e 6c62 6667 732e 6d29 3b0a  arams.lbfgs.m);.
-0008cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008cbc0: 6f70 742d 3e6c 6266 6773 2e6c 6d79 7320  opt->lbfgs.lmys 
-0008cbd0: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-0008cbe0: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-0008cbf0: 5950 455f 4633 322c 2070 6172 616d 732e  YPE_F32, params.
-0008cc00: 6c62 6667 732e 6d29 3b0a 2020 2020 2020  lbfgs.m);.      
-0008cc10: 2020 2020 2020 2020 2020 6f70 742d 3e6c            opt->l
-0008cc20: 6266 6773 2e6c 6d73 2020 3d20 6767 6d6c  bfgs.lms  = ggml
-0008cc30: 5f6e 6577 5f74 656e 736f 725f 3264 2863  _new_tensor_2d(c
-0008cc40: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
-0008cc50: 322c 206e 782c 2070 6172 616d 732e 6c62  2, nx, params.lb
-0008cc60: 6667 732e 6d29 3b0a 2020 2020 2020 2020  fgs.m);.        
-0008cc70: 2020 2020 2020 2020 6f70 742d 3e6c 6266          opt->lbf
-0008cc80: 6773 2e6c 6d79 2020 3d20 6767 6d6c 5f6e  gs.lmy  = ggml_n
-0008cc90: 6577 5f74 656e 736f 725f 3264 2863 7478  ew_tensor_2d(ctx
-0008cca0: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
-0008ccb0: 206e 782c 2070 6172 616d 732e 6c62 6667   nx, params.lbfg
-0008ccc0: 732e 6d29 3b0a 2020 2020 2020 2020 2020  s.m);.          
-0008ccd0: 2020 2020 2020 6767 6d6c 5f73 6574 5f7a        ggml_set_z
-0008cce0: 6572 6f28 6f70 742d 3e6c 6266 6773 2e78  ero(opt->lbfgs.x
-0008ccf0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0008cd00: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
-0008cd10: 286f 7074 2d3e 6c62 6667 732e 7870 293b  (opt->lbfgs.xp);
-0008cd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008cd30: 2067 676d 6c5f 7365 745f 7a65 726f 286f   ggml_set_zero(o
-0008cd40: 7074 2d3e 6c62 6667 732e 6729 3b0a 2020  pt->lbfgs.g);.  
-0008cd50: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0008cd60: 6d6c 5f73 6574 5f7a 6572 6f28 6f70 742d  ml_set_zero(opt-
-0008cd70: 3e6c 6266 6773 2e67 7029 3b0a 2020 2020  >lbfgs.gp);.    
-0008cd80: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0008cd90: 5f73 6574 5f7a 6572 6f28 6f70 742d 3e6c  _set_zero(opt->l
-0008cda0: 6266 6773 2e64 293b 0a20 2020 2020 2020  bfgs.d);.       
-0008cdb0: 2020 2020 2020 2020 2067 676d 6c5f 7365           ggml_se
-0008cdc0: 745f 7a65 726f 286f 7074 2d3e 6c62 6667  t_zero(opt->lbfg
-0008cdd0: 732e 7066 293b 0a20 2020 2020 2020 2020  s.pf);.         
-0008cde0: 2020 2020 2020 2069 6620 286f 7074 2d3e         if (opt->
-0008cdf0: 6c62 6667 732e 7066 2920 7b0a 2020 2020  lbfgs.pf) {.    
-0008ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ce10: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
-0008ce20: 742d 3e6c 6266 6773 2e70 6629 3b0a 2020  t->lbfgs.pf);.  
-0008ce30: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0008ce40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ce50: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
-0008ce60: 742d 3e6c 6266 6773 2e6c 6d61 6c29 3b0a  t->lbfgs.lmal);.
-0008ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ce80: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
-0008ce90: 742d 3e6c 6266 6773 2e6c 6d79 7329 3b0a  t->lbfgs.lmys);.
-0008cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ceb0: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
-0008cec0: 742d 3e6c 6266 6773 2e6c 6d73 293b 0a20  t->lbfgs.lms);. 
-0008ced0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0008cee0: 676d 6c5f 7365 745f 7a65 726f 286f 7074  gml_set_zero(opt
-0008cef0: 2d3e 6c62 6667 732e 6c6d 7929 3b0a 2020  ->lbfgs.lmy);.  
-0008cf00: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0008cf10: 6b3b 0a20 2020 207d 0a7d 0a0a 656e 756d  k;.    }.}..enum
-0008cf20: 2067 676d 6c5f 6f70 745f 7265 7375 6c74   ggml_opt_result
-0008cf30: 2067 676d 6c5f 6f70 7428 0a20 2020 2020   ggml_opt(.     
-0008cf40: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0008cf50: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
-0008cf60: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0008cf70: 6c5f 6f70 745f 7061 7261 6d73 2070 6172  l_opt_params par
-0008cf80: 616d 732c 0a20 2020 2020 2020 2073 7472  ams,.        str
-0008cf90: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0008cfa0: 2a20 6629 207b 0a20 2020 2062 6f6f 6c20  * f) {.    bool 
-0008cfb0: 6672 6565 5f63 7478 203d 2066 616c 7365  free_ctx = false
-0008cfc0: 3b0a 2020 2020 6966 2028 6374 7820 3d3d  ;.    if (ctx ==
-0008cfd0: 204e 554c 4c29 207b 0a20 2020 2020 2020   NULL) {.       
-0008cfe0: 2073 7472 7563 7420 6767 6d6c 5f69 6e69   struct ggml_ini
-0008cff0: 745f 7061 7261 6d73 2070 6172 616d 735f  t_params params_
-0008d000: 6374 7820 3d20 7b0a 2020 2020 2020 2020  ctx = {.        
-0008d010: 2020 2020 2e6d 656d 5f73 697a 6520 2020      .mem_size   
-0008d020: 3d20 3136 2a31 3032 342a 3130 3234 2c0a  = 16*1024*1024,.
-0008d030: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
-0008d040: 5f62 7566 6665 7220 3d20 4e55 4c4c 2c0a  _buffer = NULL,.
-0008d050: 2020 2020 2020 2020 2020 2020 2e6e 6f5f              .no_
-0008d060: 616c 6c6f 6320 2020 3d20 6661 6c73 652c  alloc   = false,
-0008d070: 0a20 2020 2020 2020 207d 3b0a 0a20 2020  .        };..   
-0008d080: 2020 2020 2063 7478 203d 2067 676d 6c5f       ctx = ggml_
-0008d090: 696e 6974 2870 6172 616d 735f 6374 7829  init(params_ctx)
-0008d0a0: 3b0a 2020 2020 2020 2020 6966 2028 6374  ;.        if (ct
-0008d0b0: 7820 3d3d 204e 554c 4c29 207b 0a20 2020  x == NULL) {.   
-0008d0c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0008d0d0: 4747 4d4c 5f4f 5054 5f4e 4f5f 434f 4e54  GGML_OPT_NO_CONT
-0008d0e0: 4558 543b 0a20 2020 2020 2020 207d 0a0a  EXT;.        }..
-0008d0f0: 2020 2020 2020 2020 6672 6565 5f63 7478          free_ctx
-0008d100: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
-0008d110: 2020 2020 656e 756d 2067 676d 6c5f 6f70      enum ggml_op
-0008d120: 745f 7265 7375 6c74 2072 6573 756c 7420  t_result result 
-0008d130: 3d20 4747 4d4c 5f4f 5054 5f4f 4b3b 0a0a  = GGML_OPT_OK;..
-0008d140: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0008d150: 6f70 745f 636f 6e74 6578 7420 2a20 6f70  opt_context * op
-0008d160: 7420 3d20 2873 7472 7563 7420 6767 6d6c  t = (struct ggml
-0008d170: 5f6f 7074 5f63 6f6e 7465 7874 202a 2920  _opt_context *) 
-0008d180: 616c 6c6f 6361 2873 697a 656f 6628 7374  alloca(sizeof(st
-0008d190: 7275 6374 2067 676d 6c5f 6f70 745f 636f  ruct ggml_opt_co
-0008d1a0: 6e74 6578 7429 293b 0a0a 2020 2020 6767  ntext));..    gg
-0008d1b0: 6d6c 5f6f 7074 5f69 6e69 7428 6374 782c  ml_opt_init(ctx,
-0008d1c0: 206f 7074 2c20 7061 7261 6d73 2c20 3029   opt, params, 0)
-0008d1d0: 3b0a 2020 2020 7265 7375 6c74 203d 2067  ;.    result = g
-0008d1e0: 676d 6c5f 6f70 745f 7265 7375 6d65 2863  gml_opt_resume(c
-0008d1f0: 7478 2c20 6f70 742c 2066 293b 0a0a 2020  tx, opt, f);..  
-0008d200: 2020 6966 2028 6672 6565 5f63 7478 2920    if (free_ctx) 
-0008d210: 7b0a 2020 2020 2020 2020 6767 6d6c 5f66  {.        ggml_f
-0008d220: 7265 6528 6374 7829 3b0a 2020 2020 7d0a  ree(ctx);.    }.
-0008d230: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-0008d240: 6c74 3b0a 7d0a 0a65 6e75 6d20 6767 6d6c  lt;.}..enum ggml
-0008d250: 5f6f 7074 5f72 6573 756c 7420 6767 6d6c  _opt_result ggml
-0008d260: 5f6f 7074 5f72 6573 756d 6528 0a20 2020  _opt_resume(.   
-0008d270: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0008d280: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
-0008d290: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0008d2a0: 676d 6c5f 6f70 745f 636f 6e74 6578 7420  gml_opt_context 
-0008d2b0: 2a20 6f70 742c 0a20 2020 2020 2020 2073  * opt,.        s
-0008d2c0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0008d2d0: 7220 2a20 6629 207b 0a0a 2020 2020 2f2f  r * f) {..    //
-0008d2e0: 2062 7569 6c64 2066 6f72 7761 7264 202b   build forward +
-0008d2f0: 2062 6163 6b77 6172 6420 636f 6d70 7574   backward comput
-0008d300: 6520 6772 6170 6873 0a20 2020 2073 7472  e graphs.    str
-0008d310: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0008d320: 2a20 6766 6275 6620 3d20 6767 6d6c 5f6e  * gfbuf = ggml_n
-0008d330: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
-0008d340: 2c20 4747 4d4c 5f54 5950 455f 4933 322c  , GGML_TYPE_I32,
-0008d350: 2073 697a 656f 6628 7374 7275 6374 2067   sizeof(struct g
-0008d360: 676d 6c5f 6367 7261 7068 2920 2f20 4747  gml_cgraph) / GG
-0008d370: 4d4c 5f54 5950 455f 5349 5a45 5b47 474d  ML_TYPE_SIZE[GGM
-0008d380: 4c5f 5459 5045 5f49 3332 5d2b 2028 7369  L_TYPE_I32]+ (si
-0008d390: 7a65 6f66 2873 7472 7563 7420 6767 6d6c  zeof(struct ggml
-0008d3a0: 5f63 6772 6170 6829 2025 2047 474d 4c5f  _cgraph) % GGML_
-0008d3b0: 5459 5045 5f53 495a 455b 4747 4d4c 5f54  TYPE_SIZE[GGML_T
-0008d3c0: 5950 455f 4933 325d 203f 2031 203a 2030  YPE_I32] ? 1 : 0
-0008d3d0: 2929 3b0a 2020 2020 7374 7275 6374 2067  ));.    struct g
-0008d3e0: 676d 6c5f 7465 6e73 6f72 202a 2067 6262  gml_tensor * gbb
-0008d3f0: 7566 203d 2067 676d 6c5f 6e65 775f 7465  uf = ggml_new_te
-0008d400: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
-0008d410: 4c5f 5459 5045 5f49 3332 2c20 7369 7a65  L_TYPE_I32, size
-0008d420: 6f66 2873 7472 7563 7420 6767 6d6c 5f63  of(struct ggml_c
-0008d430: 6772 6170 6829 202f 2047 474d 4c5f 5459  graph) / GGML_TY
-0008d440: 5045 5f53 495a 455b 4747 4d4c 5f54 5950  PE_SIZE[GGML_TYP
-0008d450: 455f 4933 325d 2b20 2873 697a 656f 6628  E_I32]+ (sizeof(
-0008d460: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-0008d470: 7068 2920 2520 4747 4d4c 5f54 5950 455f  ph) % GGML_TYPE_
-0008d480: 5349 5a45 5b47 474d 4c5f 5459 5045 5f49  SIZE[GGML_TYPE_I
-0008d490: 3332 5d20 3f20 3120 3a20 3029 293b 0a0a  32] ? 1 : 0));..
-0008d4a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0008d4b0: 6367 7261 7068 202a 2067 6620 3d20 2873  cgraph * gf = (s
-0008d4c0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-0008d4d0: 6820 2a29 2067 6662 7566 2d3e 6461 7461  h *) gfbuf->data
-0008d4e0: 3b0a 2020 2020 7374 7275 6374 2067 676d  ;.    struct ggm
-0008d4f0: 6c5f 6367 7261 7068 202a 2067 6220 3d20  l_cgraph * gb = 
-0008d500: 2873 7472 7563 7420 6767 6d6c 5f63 6772  (struct ggml_cgr
-0008d510: 6170 6820 2a29 2067 6262 7566 2d3e 6461  aph *) gbbuf->da
-0008d520: 7461 3b0a 0a20 2020 202a 6766 203d 2067  ta;..    *gf = g
-0008d530: 676d 6c5f 6275 696c 645f 666f 7277 6172  gml_build_forwar
-0008d540: 6420 2866 293b 0a20 2020 202a 6762 203d  d (f);.    *gb =
-0008d550: 2067 676d 6c5f 6275 696c 645f 6261 636b   ggml_build_back
-0008d560: 7761 7264 2863 7478 2c20 6766 2c20 7472  ward(ctx, gf, tr
-0008d570: 7565 293b 0a0a 2020 2020 7265 7475 726e  ue);..    return
-0008d580: 2067 676d 6c5f 6f70 745f 7265 7375 6d65   ggml_opt_resume
-0008d590: 5f67 2863 7478 2c20 6f70 742c 2066 2c20  _g(ctx, opt, f, 
-0008d5a0: 6766 2c20 6762 293b 0a7d 0a0a 656e 756d  gf, gb);.}..enum
-0008d5b0: 2067 676d 6c5f 6f70 745f 7265 7375 6c74   ggml_opt_result
-0008d5c0: 2067 676d 6c5f 6f70 745f 7265 7375 6d65   ggml_opt_resume
-0008d5d0: 5f67 280a 2020 2020 2020 2020 7374 7275  _g(.        stru
-0008d5e0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0008d5f0: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
-0008d600: 7472 7563 7420 6767 6d6c 5f6f 7074 5f63  truct ggml_opt_c
-0008d610: 6f6e 7465 7874 202a 206f 7074 2c0a 2020  ontext * opt,.  
-0008d620: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0008d630: 6c5f 7465 6e73 6f72 202a 2066 2c0a 2020  l_tensor * f,.  
-0008d640: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0008d650: 6c5f 6367 7261 7068 202a 2067 662c 0a20  l_cgraph * gf,. 
-0008d660: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0008d670: 6d6c 5f63 6772 6170 6820 2a20 6762 2920  ml_cgraph * gb) 
-0008d680: 7b0a 0a20 2020 202f 2f20 6275 696c 6420  {..    // build 
-0008d690: 666f 7277 6172 6420 2b20 6261 636b 7761  forward + backwa
-0008d6a0: 7264 2063 6f6d 7075 7465 2067 7261 7068  rd compute graph
-0008d6b0: 730a 2020 2020 656e 756d 2067 676d 6c5f  s.    enum ggml_
-0008d6c0: 6f70 745f 7265 7375 6c74 2072 6573 756c  opt_result resul
-0008d6d0: 7420 3d20 4747 4d4c 5f4f 5054 5f4f 4b3b  t = GGML_OPT_OK;
-0008d6e0: 0a0a 2020 2020 7377 6974 6368 2028 6f70  ..    switch (op
-0008d6f0: 742d 3e70 6172 616d 732e 7479 7065 2920  t->params.type) 
-0008d700: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-0008d710: 474d 4c5f 4f50 545f 4144 414d 3a0a 2020  GML_OPT_ADAM:.  
-0008d720: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0008d730: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-0008d740: 6c74 203d 2067 676d 6c5f 6f70 745f 6164  lt = ggml_opt_ad
-0008d750: 616d 2863 7478 2c20 6f70 742c 206f 7074  am(ctx, opt, opt
-0008d760: 2d3e 7061 7261 6d73 2c20 662c 2067 662c  ->params, f, gf,
-0008d770: 2067 6229 3b0a 2020 2020 2020 2020 2020   gb);.          
-0008d780: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0008d790: 2020 2063 6173 6520 4747 4d4c 5f4f 5054     case GGML_OPT
-0008d7a0: 5f4c 4246 4753 3a0a 2020 2020 2020 2020  _LBFGS:.        
-0008d7b0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0008d7c0: 2020 2020 2020 7265 7375 6c74 203d 2067        result = g
-0008d7d0: 676d 6c5f 6f70 745f 6c62 6667 7328 6374  gml_opt_lbfgs(ct
-0008d7e0: 782c 206f 7074 2c20 6f70 742d 3e70 6172  x, opt, opt->par
-0008d7f0: 616d 732c 2066 2c20 6766 2c20 6762 293b  ams, f, gf, gb);
-0008d800: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0008d810: 7265 616b 3b0a 2020 2020 7d0a 0a20 2020  reak;.    }..   
-0008d820: 2069 6620 286f 7074 2d3e 7061 7261 6d73   if (opt->params
-0008d830: 2e70 7269 6e74 5f66 6f72 7761 7264 5f67  .print_forward_g
-0008d840: 7261 7068 2920 7b0a 2020 2020 2020 2020  raph) {.        
-0008d850: 6767 6d6c 5f67 7261 7068 5f70 7269 6e74  ggml_graph_print
-0008d860: 2020 2028 6766 293b 0a20 2020 2020 2020     (gf);.       
-0008d870: 2067 676d 6c5f 6772 6170 685f 6475 6d70   ggml_graph_dump
-0008d880: 5f64 6f74 2867 662c 204e 554c 4c2c 2022  _dot(gf, NULL, "
-0008d890: 6f70 742d 666f 7277 6172 642e 646f 7422  opt-forward.dot"
-0008d8a0: 293b 0a20 2020 207d 0a0a 2020 2020 6966  );.    }..    if
-0008d8b0: 2028 6f70 742d 3e70 6172 616d 732e 7072   (opt->params.pr
-0008d8c0: 696e 745f 6261 636b 7761 7264 5f67 7261  int_backward_gra
-0008d8d0: 7068 2920 7b0a 2020 2020 2020 2020 6767  ph) {.        gg
-0008d8e0: 6d6c 5f67 7261 7068 5f70 7269 6e74 2020  ml_graph_print  
-0008d8f0: 2028 6762 293b 0a20 2020 2020 2020 2067   (gb);.        g
-0008d900: 676d 6c5f 6772 6170 685f 6475 6d70 5f64  gml_graph_dump_d
-0008d910: 6f74 2867 622c 2067 662c 2022 6f70 742d  ot(gb, gf, "opt-
-0008d920: 6261 636b 7761 7264 2e64 6f74 2229 3b0a  backward.dot");.
-0008d930: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
-0008d940: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f2f  n result;.}..///
-0008d950: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008d960: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008d970: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008d980: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008d990: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a 0a73  /////////////..s
-0008d9a0: 697a 655f 7420 6767 6d6c 5f71 7561 6e74  ize_t ggml_quant
-0008d9b0: 697a 655f 7134 5f30 2863 6f6e 7374 2066  ize_q4_0(const f
-0008d9c0: 6c6f 6174 202a 2073 7263 2c20 766f 6964  loat * src, void
-0008d9d0: 202a 2064 7374 2c20 696e 7420 6e2c 2069   * dst, int n, i
-0008d9e0: 6e74 206b 2c20 696e 7436 345f 7420 2a20  nt k, int64_t * 
-0008d9f0: 6869 7374 2920 7b0a 2020 2020 6173 7365  hist) {.    asse
-0008da00: 7274 286b 2025 2051 4b34 5f30 203d 3d20  rt(k % QK4_0 == 
-0008da10: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
-0008da20: 7420 6e62 203d 206b 202f 2051 4b34 5f30  t nb = k / QK4_0
-0008da30: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-0008da40: 6220 3d20 303b 2062 203c 206e 3b20 6220  b = 0; b < n; b 
-0008da50: 2b3d 206b 2920 7b0a 2020 2020 2020 2020  += k) {.        
-0008da60: 626c 6f63 6b5f 7134 5f30 202a 2072 6573  block_q4_0 * res
-0008da70: 7472 6963 7420 7920 3d20 2862 6c6f 636b  trict y = (block
-0008da80: 5f71 345f 3020 2a29 2064 7374 202b 2062  _q4_0 *) dst + b
-0008da90: 2f51 4b34 5f30 3b0a 0a20 2020 2020 2020  /QK4_0;..       
-0008daa0: 2071 7561 6e74 697a 655f 726f 775f 7134   quantize_row_q4
-0008dab0: 5f30 5f72 6566 6572 656e 6365 2873 7263  _0_reference(src
-0008dac0: 202b 2062 2c20 792c 206b 293b 0a0a 2020   + b, y, k);..  
-0008dad0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0008dae0: 203d 2030 3b20 6920 3c20 6e62 3b20 692b   = 0; i < nb; i+
-0008daf0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-0008db00: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-0008db10: 206a 203c 2051 4b34 5f30 3b20 6a20 2b3d   j < QK4_0; j +=
-0008db20: 2032 2920 7b0a 2020 2020 2020 2020 2020   2) {.          
-0008db30: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-0008db40: 385f 7420 7669 3020 3d20 795b 695d 2e71  8_t vi0 = y[i].q
-0008db50: 735b 6a2f 325d 2026 2030 7830 463b 0a20  s[j/2] & 0x0F;. 
-0008db60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0008db70: 6f6e 7374 2075 696e 7438 5f74 2076 6931  onst uint8_t vi1
-0008db80: 203d 2079 5b69 5d2e 7173 5b6a 2f32 5d20   = y[i].qs[j/2] 
-0008db90: 3e3e 2034 3b0a 0a20 2020 2020 2020 2020  >> 4;..         
-0008dba0: 2020 2020 2020 2068 6973 745b 7669 305d         hist[vi0]
-0008dbb0: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
-0008dbc0: 2020 2020 6869 7374 5b76 6931 5d2b 2b3b      hist[vi1]++;
-0008dbd0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-0008dbe0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-0008dbf0: 2020 2020 7265 7475 726e 2028 6e2f 514b      return (n/QK
-0008dc00: 345f 302a 7369 7a65 6f66 2862 6c6f 636b  4_0*sizeof(block
-0008dc10: 5f71 345f 3029 293b 0a7d 0a0a 7369 7a65  _q4_0));.}..size
-0008dc20: 5f74 2067 676d 6c5f 7175 616e 7469 7a65  _t ggml_quantize
-0008dc30: 5f71 345f 3128 636f 6e73 7420 666c 6f61  _q4_1(const floa
-0008dc40: 7420 2a20 7372 632c 2076 6f69 6420 2a20  t * src, void * 
-0008dc50: 6473 742c 2069 6e74 206e 2c20 696e 7420  dst, int n, int 
-0008dc60: 6b2c 2069 6e74 3634 5f74 202a 2068 6973  k, int64_t * his
-0008dc70: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
-0008dc80: 6b20 2520 514b 345f 3120 3d3d 2030 293b  k % QK4_1 == 0);
-0008dc90: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0008dca0: 6220 3d20 6b20 2f20 514b 345f 313b 0a0a  b = k / QK4_1;..
-0008dcb0: 2020 2020 666f 7220 2869 6e74 2062 203d      for (int b =
-0008dcc0: 2030 3b20 6220 3c20 6e3b 2062 202b 3d20   0; b < n; b += 
-0008dcd0: 6b29 207b 0a20 2020 2020 2020 2062 6c6f  k) {.        blo
-0008dce0: 636b 5f71 345f 3120 2a20 7265 7374 7269  ck_q4_1 * restri
-0008dcf0: 6374 2079 203d 2028 626c 6f63 6b5f 7134  ct y = (block_q4
-0008dd00: 5f31 202a 2920 6473 7420 2b20 622f 514b  _1 *) dst + b/QK
-0008dd10: 345f 313b 0a0a 2020 2020 2020 2020 7175  4_1;..        qu
-0008dd20: 616e 7469 7a65 5f72 6f77 5f71 345f 315f  antize_row_q4_1_
-0008dd30: 7265 6665 7265 6e63 6528 7372 6320 2b20  reference(src + 
-0008dd40: 622c 2079 2c20 6b29 3b0a 0a20 2020 2020  b, y, k);..     
-0008dd50: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-0008dd60: 303b 2069 203c 206e 623b 2069 2b2b 2920  0; i < nb; i++) 
-0008dd70: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
-0008dd80: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
-0008dd90: 3c20 514b 345f 313b 206a 202b 3d20 3229  < QK4_1; j += 2)
-0008dda0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008ddb0: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
-0008ddc0: 2076 6930 203d 2079 5b69 5d2e 7173 5b6a   vi0 = y[i].qs[j
-0008ddd0: 2f32 5d20 2620 3078 3046 3b0a 2020 2020  /2] & 0x0F;.    
-0008dde0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0008ddf0: 7420 7569 6e74 385f 7420 7669 3120 3d20  t uint8_t vi1 = 
-0008de00: 795b 695d 2e71 735b 6a2f 325d 203e 3e20  y[i].qs[j/2] >> 
-0008de10: 343b 0a0a 2020 2020 2020 2020 2020 2020  4;..            
-0008de20: 2020 2020 6869 7374 5b76 6930 5d2b 2b3b      hist[vi0]++;
-0008de30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008de40: 2068 6973 745b 7669 315d 2b2b 3b0a 2020   hist[vi1]++;.  
-0008de50: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0008de60: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
-0008de70: 2072 6574 7572 6e20 286e 2f51 4b34 5f31   return (n/QK4_1
-0008de80: 2a73 697a 656f 6628 626c 6f63 6b5f 7134  *sizeof(block_q4
-0008de90: 5f31 2929 3b0a 7d0a 0a73 697a 655f 7420  _1));.}..size_t 
-0008dea0: 6767 6d6c 5f71 7561 6e74 697a 655f 7135  ggml_quantize_q5
-0008deb0: 5f30 2863 6f6e 7374 2066 6c6f 6174 202a  _0(const float *
-0008dec0: 2073 7263 2c20 766f 6964 202a 2064 7374   src, void * dst
-0008ded0: 2c20 696e 7420 6e2c 2069 6e74 206b 2c20  , int n, int k, 
-0008dee0: 696e 7436 345f 7420 2a20 6869 7374 2920  int64_t * hist) 
-0008def0: 7b0a 2020 2020 6173 7365 7274 286b 2025  {.    assert(k %
-0008df00: 2051 4b35 5f30 203d 3d20 3029 3b0a 2020   QK5_0 == 0);.  
-0008df10: 2020 636f 6e73 7420 696e 7420 6e62 203d    const int nb =
-0008df20: 206b 202f 2051 4b35 5f30 3b0a 0a20 2020   k / QK5_0;..   
-0008df30: 2066 6f72 2028 696e 7420 6220 3d20 303b   for (int b = 0;
-0008df40: 2062 203c 206e 3b20 6220 2b3d 206b 2920   b < n; b += k) 
-0008df50: 7b0a 2020 2020 2020 2020 626c 6f63 6b5f  {.        block_
-0008df60: 7135 5f30 202a 2072 6573 7472 6963 7420  q5_0 * restrict 
-0008df70: 7920 3d20 2862 6c6f 636b 5f71 355f 3020  y = (block_q5_0 
-0008df80: 2a29 6473 7420 2b20 622f 514b 355f 303b  *)dst + b/QK5_0;
-0008df90: 0a0a 2020 2020 2020 2020 7175 616e 7469  ..        quanti
-0008dfa0: 7a65 5f72 6f77 5f71 355f 305f 7265 6665  ze_row_q5_0_refe
-0008dfb0: 7265 6e63 6528 7372 6320 2b20 622c 2079  rence(src + b, y
-0008dfc0: 2c20 6b29 3b0a 0a20 2020 2020 2020 2066  , k);..        f
-0008dfd0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0008dfe0: 203c 206e 623b 2069 2b2b 2920 7b0a 2020   < nb; i++) {.  
-0008dff0: 2020 2020 2020 2020 2020 7569 6e74 3332            uint32
-0008e000: 5f74 2071 683b 0a20 2020 2020 2020 2020  _t qh;.         
-0008e010: 2020 206d 656d 6370 7928 2671 682c 2026     memcpy(&qh, &
-0008e020: 795b 695d 2e71 682c 2073 697a 656f 6628  y[i].qh, sizeof(
-0008e030: 7168 2929 3b0a 0a20 2020 2020 2020 2020  qh));..         
-0008e040: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-0008e050: 303b 206a 203c 2051 4b35 5f30 3b20 6a20  0; j < QK5_0; j 
-0008e060: 2b3d 2032 2920 7b0a 2020 2020 2020 2020  += 2) {.        
-0008e070: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-0008e080: 6e74 385f 7420 7668 3020 3d20 2828 7168  nt8_t vh0 = ((qh
-0008e090: 2026 2028 3175 203c 3c20 286a 202b 2030   & (1u << (j + 0
-0008e0a0: 2029 2929 203e 3e20 286a 202b 2030 2029   ))) >> (j + 0 )
-0008e0b0: 2920 3c3c 2034 3b0a 2020 2020 2020 2020  ) << 4;.        
-0008e0c0: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-0008e0d0: 6e74 385f 7420 7668 3120 3d20 2828 7168  nt8_t vh1 = ((qh
-0008e0e0: 2026 2028 3175 203c 3c20 286a 202b 2031   & (1u << (j + 1
-0008e0f0: 3629 2929 203e 3e20 286a 202b 2031 3229  6))) >> (j + 12)
-0008e100: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0008e110: 2020 2020 2f2f 2063 6173 7420 746f 2031      // cast to 1
-0008e120: 3620 6269 6e73 0a20 2020 2020 2020 2020  6 bins.         
-0008e130: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-0008e140: 7438 5f74 2076 6930 203d 2028 2879 5b69  t8_t vi0 = ((y[i
-0008e150: 5d2e 7173 5b6a 2f32 5d20 2620 3078 3046  ].qs[j/2] & 0x0F
-0008e160: 2920 7c20 7668 3029 202f 2032 3b0a 2020  ) | vh0) / 2;.  
-0008e170: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0008e180: 6e73 7420 7569 6e74 385f 7420 7669 3120  nst uint8_t vi1 
-0008e190: 3d20 2828 795b 695d 2e71 735b 6a2f 325d  = ((y[i].qs[j/2]
-0008e1a0: 203e 3e20 2020 3429 207c 2076 6831 2920   >>   4) | vh1) 
-0008e1b0: 2f20 323b 0a0a 2020 2020 2020 2020 2020  / 2;..          
-0008e1c0: 2020 2020 2020 6869 7374 5b76 6930 5d2b        hist[vi0]+
-0008e1d0: 2b3b 0a20 2020 2020 2020 2020 2020 2020  +;.             
-0008e1e0: 2020 2068 6973 745b 7669 315d 2b2b 3b0a     hist[vi1]++;.
-0008e1f0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0008e200: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
-0008e210: 2020 2072 6574 7572 6e20 286e 2f51 4b35     return (n/QK5
-0008e220: 5f30 2a73 697a 656f 6628 626c 6f63 6b5f  _0*sizeof(block_
-0008e230: 7135 5f30 2929 3b0a 7d0a 0a73 697a 655f  q5_0));.}..size_
-0008e240: 7420 6767 6d6c 5f71 7561 6e74 697a 655f  t ggml_quantize_
-0008e250: 7135 5f31 2863 6f6e 7374 2066 6c6f 6174  q5_1(const float
-0008e260: 202a 2073 7263 2c20 766f 6964 202a 2064   * src, void * d
-0008e270: 7374 2c20 696e 7420 6e2c 2069 6e74 206b  st, int n, int k
-0008e280: 2c20 696e 7436 345f 7420 2a20 6869 7374  , int64_t * hist
-0008e290: 2920 7b0a 2020 2020 6173 7365 7274 286b  ) {.    assert(k
-0008e2a0: 2025 2051 4b35 5f31 203d 3d20 3029 3b0a   % QK5_1 == 0);.
-0008e2b0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-0008e2c0: 203d 206b 202f 2051 4b35 5f31 3b0a 0a20   = k / QK5_1;.. 
-0008e2d0: 2020 2066 6f72 2028 696e 7420 6220 3d20     for (int b = 
-0008e2e0: 303b 2062 203c 206e 3b20 6220 2b3d 206b  0; b < n; b += k
-0008e2f0: 2920 7b0a 2020 2020 2020 2020 626c 6f63  ) {.        bloc
-0008e300: 6b5f 7135 5f31 202a 2072 6573 7472 6963  k_q5_1 * restric
-0008e310: 7420 7920 3d20 2862 6c6f 636b 5f71 355f  t y = (block_q5_
-0008e320: 3120 2a29 6473 7420 2b20 622f 514b 355f  1 *)dst + b/QK5_
-0008e330: 313b 0a0a 2020 2020 2020 2020 7175 616e  1;..        quan
-0008e340: 7469 7a65 5f72 6f77 5f71 355f 315f 7265  tize_row_q5_1_re
-0008e350: 6665 7265 6e63 6528 7372 6320 2b20 622c  ference(src + b,
-0008e360: 2079 2c20 6b29 3b0a 0a20 2020 2020 2020   y, k);..       
-0008e370: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-0008e380: 2069 203c 206e 623b 2069 2b2b 2920 7b0a   i < nb; i++) {.
-0008e390: 2020 2020 2020 2020 2020 2020 7569 6e74              uint
-0008e3a0: 3332 5f74 2071 683b 0a20 2020 2020 2020  32_t qh;.       
-0008e3b0: 2020 2020 206d 656d 6370 7928 2671 682c       memcpy(&qh,
-0008e3c0: 2026 795b 695d 2e71 682c 2073 697a 656f   &y[i].qh, sizeo
-0008e3d0: 6628 7168 2929 3b0a 0a20 2020 2020 2020  f(qh));..       
-0008e3e0: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
-0008e3f0: 3d20 303b 206a 203c 2051 4b35 5f31 3b20  = 0; j < QK5_1; 
-0008e400: 6a20 2b3d 2032 2920 7b0a 2020 2020 2020  j += 2) {.      
-0008e410: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0008e420: 7569 6e74 385f 7420 7668 3020 3d20 2828  uint8_t vh0 = ((
-0008e430: 7168 2026 2028 3175 203c 3c20 286a 202b  qh & (1u << (j +
-0008e440: 2030 2029 2929 203e 3e20 286a 202b 2030   0 ))) >> (j + 0
-0008e450: 2029 2920 3c3c 2034 3b0a 2020 2020 2020   )) << 4;.      
-0008e460: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0008e470: 7569 6e74 385f 7420 7668 3120 3d20 2828  uint8_t vh1 = ((
-0008e480: 7168 2026 2028 3175 203c 3c20 286a 202b  qh & (1u << (j +
-0008e490: 2031 3629 2929 203e 3e20 286a 202b 2031   16))) >> (j + 1
-0008e4a0: 3229 293b 0a0a 2020 2020 2020 2020 2020  2));..          
-0008e4b0: 2020 2020 2020 2f2f 2063 6173 7420 746f        // cast to
-0008e4c0: 2031 3620 6269 6e73 0a20 2020 2020 2020   16 bins.       
-0008e4d0: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
-0008e4e0: 696e 7438 5f74 2076 6930 203d 2028 2879  int8_t vi0 = ((y
-0008e4f0: 5b69 5d2e 7173 5b6a 2f32 5d20 2620 3078  [i].qs[j/2] & 0x
-0008e500: 3046 2920 7c20 7668 3029 202f 2032 3b0a  0F) | vh0) / 2;.
-0008e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008e520: 636f 6e73 7420 7569 6e74 385f 7420 7669  const uint8_t vi
-0008e530: 3120 3d20 2828 795b 695d 2e71 735b 6a2f  1 = ((y[i].qs[j/
-0008e540: 325d 203e 3e20 2020 3429 207c 2076 6831  2] >>   4) | vh1
-0008e550: 2920 2f20 323b 0a0a 2020 2020 2020 2020  ) / 2;..        
-0008e560: 2020 2020 2020 2020 6869 7374 5b76 6930          hist[vi0
-0008e570: 5d2b 2b3b 0a20 2020 2020 2020 2020 2020  ]++;.           
-0008e580: 2020 2020 2068 6973 745b 7669 315d 2b2b       hist[vi1]++
-0008e590: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-0008e5a0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-0008e5b0: 0a20 2020 2072 6574 7572 6e20 286e 2f51  .    return (n/Q
-0008e5c0: 4b35 5f31 2a73 697a 656f 6628 626c 6f63  K5_1*sizeof(bloc
-0008e5d0: 6b5f 7135 5f31 2929 3b0a 7d0a 0a73 697a  k_q5_1));.}..siz
-0008e5e0: 655f 7420 6767 6d6c 5f71 7561 6e74 697a  e_t ggml_quantiz
-0008e5f0: 655f 7138 5f30 2863 6f6e 7374 2066 6c6f  e_q8_0(const flo
-0008e600: 6174 202a 2073 7263 2c20 766f 6964 202a  at * src, void *
-0008e610: 2064 7374 2c20 696e 7420 6e2c 2069 6e74   dst, int n, int
-0008e620: 206b 2c20 696e 7436 345f 7420 2a20 6869   k, int64_t * hi
-0008e630: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
-0008e640: 286b 2025 2051 4b38 5f30 203d 3d20 3029  (k % QK8_0 == 0)
-0008e650: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-0008e660: 6e62 203d 206b 202f 2051 4b38 5f30 3b0a  nb = k / QK8_0;.
-0008e670: 0a20 2020 2066 6f72 2028 696e 7420 6220  .    for (int b 
-0008e680: 3d20 303b 2062 203c 206e 3b20 6220 2b3d  = 0; b < n; b +=
-0008e690: 206b 2920 7b0a 2020 2020 2020 2020 626c   k) {.        bl
-0008e6a0: 6f63 6b5f 7138 5f30 202a 2072 6573 7472  ock_q8_0 * restr
-0008e6b0: 6963 7420 7920 3d20 2862 6c6f 636b 5f71  ict y = (block_q
-0008e6c0: 385f 3020 2a29 6473 7420 2b20 622f 514b  8_0 *)dst + b/QK
-0008e6d0: 385f 303b 0a0a 2020 2020 2020 2020 7175  8_0;..        qu
-0008e6e0: 616e 7469 7a65 5f72 6f77 5f71 385f 305f  antize_row_q8_0_
-0008e6f0: 7265 6665 7265 6e63 6528 7372 6320 2b20  reference(src + 
-0008e700: 622c 2079 2c20 6b29 3b0a 0a20 2020 2020  b, y, k);..     
-0008e710: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-0008e720: 303b 2069 203c 206e 623b 2069 2b2b 2920  0; i < nb; i++) 
-0008e730: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
-0008e740: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
-0008e750: 3c20 514b 385f 303b 202b 2b6a 2920 7b0a  < QK8_0; ++j) {.
-0008e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008e770: 636f 6e73 7420 696e 7438 5f74 2076 6920  const int8_t vi 
-0008e780: 3d20 795b 695d 2e71 735b 6a5d 3b0a 0a20  = y[i].qs[j];.. 
-0008e790: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0008e7a0: 6973 745b 7669 2f31 3620 2b20 385d 2b2b  ist[vi/16 + 8]++
-0008e7b0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-0008e7c0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-0008e7d0: 0a20 2020 2072 6574 7572 6e20 286e 2f51  .    return (n/Q
-0008e7e0: 4b38 5f30 2a73 697a 656f 6628 626c 6f63  K8_0*sizeof(bloc
-0008e7f0: 6b5f 7138 5f30 2929 3b0a 7d0a 0a73 697a  k_q8_0));.}..siz
-0008e800: 655f 7420 6767 6d6c 5f71 7561 6e74 697a  e_t ggml_quantiz
-0008e810: 655f 6368 756e 6b28 656e 756d 2067 676d  e_chunk(enum ggm
-0008e820: 6c5f 7479 7065 2074 7970 652c 2063 6f6e  l_type type, con
-0008e830: 7374 2066 6c6f 6174 202a 2073 7263 2c20  st float * src, 
-0008e840: 766f 6964 202a 2064 7374 2c20 696e 7420  void * dst, int 
-0008e850: 7374 6172 742c 2069 6e74 206e 2c20 696e  start, int n, in
-0008e860: 7436 345f 7420 2a20 6869 7374 2920 7b0a  t64_t * hist) {.
-0008e870: 2020 2020 7369 7a65 5f74 2072 6573 756c      size_t resul
-0008e880: 7420 3d20 303b 0a20 2020 2073 7769 7463  t = 0;.    switc
-0008e890: 6820 2874 7970 6529 207b 0a20 2020 2020  h (type) {.     
-0008e8a0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0008e8b0: 455f 5134 5f30 3a0a 2020 2020 2020 2020  E_Q4_0:.        
-0008e8c0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0008e8d0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0008e8e0: 5428 7374 6172 7420 2520 514b 345f 3020  T(start % QK4_0 
-0008e8f0: 3d3d 2030 293b 0a20 2020 2020 2020 2020  == 0);.         
-0008e900: 2020 2020 2020 2062 6c6f 636b 5f71 345f         block_q4_
-0008e910: 3020 2a20 626c 6f63 6b20 3d20 2862 6c6f  0 * block = (blo
-0008e920: 636b 5f71 345f 302a 2964 7374 202b 2073  ck_q4_0*)dst + s
-0008e930: 7461 7274 202f 2051 4b34 5f30 3b0a 2020  tart / QK4_0;.  
-0008e940: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0008e950: 7375 6c74 203d 2067 676d 6c5f 7175 616e  sult = ggml_quan
-0008e960: 7469 7a65 5f71 345f 3028 7372 6320 2b20  tize_q4_0(src + 
-0008e970: 7374 6172 742c 2062 6c6f 636b 2c20 6e2c  start, block, n,
-0008e980: 206e 2c20 6869 7374 293b 0a20 2020 2020   n, hist);.     
-0008e990: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0008e9a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0008e9b0: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
-0008e9c0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0008e9d0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0008e9e0: 4153 5345 5254 2873 7461 7274 2025 2051  ASSERT(start % Q
-0008e9f0: 4b34 5f31 203d 3d20 3029 3b0a 2020 2020  K4_1 == 0);.    
-0008ea00: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-0008ea10: 6b5f 7134 5f31 202a 2062 6c6f 636b 203d  k_q4_1 * block =
-0008ea20: 2028 626c 6f63 6b5f 7134 5f31 2a29 6473   (block_q4_1*)ds
-0008ea30: 7420 2b20 7374 6172 7420 2f20 514b 345f  t + start / QK4_
-0008ea40: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
-0008ea50: 2020 2072 6573 756c 7420 3d20 6767 6d6c     result = ggml
-0008ea60: 5f71 7561 6e74 697a 655f 7134 5f31 2873  _quantize_q4_1(s
-0008ea70: 7263 202b 2073 7461 7274 2c20 626c 6f63  rc + start, bloc
-0008ea80: 6b2c 206e 2c20 6e2c 2068 6973 7429 3b0a  k, n, n, hist);.
-0008ea90: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0008eaa0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0008eab0: 6520 4747 4d4c 5f54 5950 455f 5135 5f30  e GGML_TYPE_Q5_0
-0008eac0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0008ead0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008eae0: 4747 4d4c 5f41 5353 4552 5428 7374 6172  GGML_ASSERT(star
-0008eaf0: 7420 2520 514b 355f 3020 3d3d 2030 293b  t % QK5_0 == 0);
-0008eb00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008eb10: 2062 6c6f 636b 5f71 355f 3020 2a20 626c   block_q5_0 * bl
-0008eb20: 6f63 6b20 3d20 2862 6c6f 636b 5f71 355f  ock = (block_q5_
-0008eb30: 302a 2964 7374 202b 2073 7461 7274 202f  0*)dst + start /
-0008eb40: 2051 4b35 5f30 3b0a 2020 2020 2020 2020   QK5_0;.        
-0008eb50: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0008eb60: 2067 676d 6c5f 7175 616e 7469 7a65 5f71   ggml_quantize_q
-0008eb70: 355f 3028 7372 6320 2b20 7374 6172 742c  5_0(src + start,
-0008eb80: 2062 6c6f 636b 2c20 6e2c 206e 2c20 6869   block, n, n, hi
-0008eb90: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-0008eba0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0008ebb0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-0008ebc0: 5f51 355f 313a 0a20 2020 2020 2020 2020  _Q5_1:.         
-0008ebd0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0008ebe0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-0008ebf0: 2873 7461 7274 2025 2051 4b35 5f31 203d  (start % QK5_1 =
-0008ec00: 3d20 3029 3b0a 2020 2020 2020 2020 2020  = 0);.          
-0008ec10: 2020 2020 2020 626c 6f63 6b5f 7135 5f31        block_q5_1
-0008ec20: 202a 2062 6c6f 636b 203d 2028 626c 6f63   * block = (bloc
-0008ec30: 6b5f 7135 5f31 2a29 6473 7420 2b20 7374  k_q5_1*)dst + st
-0008ec40: 6172 7420 2f20 514b 355f 313b 0a20 2020  art / QK5_1;.   
-0008ec50: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0008ec60: 756c 7420 3d20 6767 6d6c 5f71 7561 6e74  ult = ggml_quant
-0008ec70: 697a 655f 7135 5f31 2873 7263 202b 2073  ize_q5_1(src + s
-0008ec80: 7461 7274 2c20 626c 6f63 6b2c 206e 2c20  tart, block, n, 
-0008ec90: 6e2c 2068 6973 7429 3b0a 2020 2020 2020  n, hist);.      
-0008eca0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0008ecb0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0008ecc0: 5f54 5950 455f 5138 5f30 3a0a 2020 2020  _TYPE_Q8_0:.    
-0008ecd0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0008ece0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-0008ecf0: 5353 4552 5428 7374 6172 7420 2520 514b  SSERT(start % QK
-0008ed00: 385f 3020 3d3d 2030 293b 0a20 2020 2020  8_0 == 0);.     
-0008ed10: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-0008ed20: 5f71 385f 3020 2a20 626c 6f63 6b20 3d20  _q8_0 * block = 
-0008ed30: 2862 6c6f 636b 5f71 385f 302a 2964 7374  (block_q8_0*)dst
-0008ed40: 202b 2073 7461 7274 202f 2051 4b38 5f30   + start / QK8_0
-0008ed50: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0008ed60: 2020 7265 7375 6c74 203d 2067 676d 6c5f    result = ggml_
-0008ed70: 7175 616e 7469 7a65 5f71 385f 3028 7372  quantize_q8_0(sr
-0008ed80: 6320 2b20 7374 6172 742c 2062 6c6f 636b  c + start, block
-0008ed90: 2c20 6e2c 206e 2c20 6869 7374 293b 0a20  , n, n, hist);. 
-0008eda0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0008edb0: 616b 3b0a 2369 6664 6566 2047 474d 4c5f  ak;.#ifdef GGML_
-0008edc0: 5553 455f 4b5f 5155 414e 5453 0a20 2020  USE_K_QUANTS.   
-0008edd0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0008ede0: 5950 455f 5132 5f4b 3a0a 2020 2020 2020  YPE_Q2_K:.      
-0008edf0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0008ee00: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-0008ee10: 4552 5428 7374 6172 7420 2520 514b 5f4b  ERT(start % QK_K
-0008ee20: 203d 3d20 3029 3b0a 2020 2020 2020 2020   == 0);.        
-0008ee30: 2020 2020 2020 2020 626c 6f63 6b5f 7132          block_q2
-0008ee40: 5f4b 202a 2062 6c6f 636b 203d 2028 626c  _K * block = (bl
-0008ee50: 6f63 6b5f 7132 5f4b 2a29 6473 7420 2b20  ock_q2_K*)dst + 
-0008ee60: 7374 6172 7420 2f20 514b 5f4b 3b0a 2020  start / QK_K;.  
-0008ee70: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0008ee80: 7375 6c74 203d 2067 676d 6c5f 7175 616e  sult = ggml_quan
-0008ee90: 7469 7a65 5f71 325f 4b28 7372 6320 2b20  tize_q2_K(src + 
-0008eea0: 7374 6172 742c 2062 6c6f 636b 2c20 6e2c  start, block, n,
-0008eeb0: 206e 2c20 6869 7374 293b 0a20 2020 2020   n, hist);.     
-0008eec0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0008eed0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0008eee0: 4c5f 5459 5045 5f51 335f 4b3a 0a20 2020  L_TYPE_Q3_K:.   
-0008eef0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0008ef00: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0008ef10: 4153 5345 5254 2873 7461 7274 2025 2051  ASSERT(start % Q
-0008ef20: 4b5f 4b20 3d3d 2030 293b 0a20 2020 2020  K_K == 0);.     
-0008ef30: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-0008ef40: 5f71 335f 4b20 2a20 626c 6f63 6b20 3d20  _q3_K * block = 
-0008ef50: 2862 6c6f 636b 5f71 335f 4b2a 2964 7374  (block_q3_K*)dst
-0008ef60: 202b 2073 7461 7274 202f 2051 4b5f 4b3b   + start / QK_K;
-0008ef70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008ef80: 2072 6573 756c 7420 3d20 6767 6d6c 5f71   result = ggml_q
-0008ef90: 7561 6e74 697a 655f 7133 5f4b 2873 7263  uantize_q3_K(src
-0008efa0: 202b 2073 7461 7274 2c20 626c 6f63 6b2c   + start, block,
-0008efb0: 206e 2c20 6e2c 2068 6973 7429 3b0a 2020   n, n, hist);.  
-0008efc0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0008efd0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0008efe0: 4747 4d4c 5f54 5950 455f 5134 5f4b 3a0a  GGML_TYPE_Q4_K:.
-0008eff0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0008f000: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-0008f010: 4d4c 5f41 5353 4552 5428 7374 6172 7420  ML_ASSERT(start 
-0008f020: 2520 514b 5f4b 203d 3d20 3029 3b0a 2020  % QK_K == 0);.  
-0008f030: 2020 2020 2020 2020 2020 2020 2020 626c                bl
-0008f040: 6f63 6b5f 7134 5f4b 202a 2062 6c6f 636b  ock_q4_K * block
-0008f050: 203d 2028 626c 6f63 6b5f 7134 5f4b 2a29   = (block_q4_K*)
-0008f060: 6473 7420 2b20 7374 6172 7420 2f20 514b  dst + start / QK
-0008f070: 5f4b 3b0a 2020 2020 2020 2020 2020 2020  _K;.            
-0008f080: 2020 2020 7265 7375 6c74 203d 2067 676d      result = ggm
-0008f090: 6c5f 7175 616e 7469 7a65 5f71 345f 4b28  l_quantize_q4_K(
-0008f0a0: 7372 6320 2b20 7374 6172 742c 2062 6c6f  src + start, blo
-0008f0b0: 636b 2c20 6e2c 206e 2c20 6869 7374 293b  ck, n, n, hist);
-0008f0c0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0008f0d0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-0008f0e0: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
-0008f0f0: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
-0008f100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008f110: 2047 474d 4c5f 4153 5345 5254 2873 7461   GGML_ASSERT(sta
-0008f120: 7274 2025 2051 4b5f 4b20 3d3d 2030 293b  rt % QK_K == 0);
-0008f130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008f140: 2062 6c6f 636b 5f71 355f 4b20 2a20 626c   block_q5_K * bl
-0008f150: 6f63 6b20 3d20 2862 6c6f 636b 5f71 355f  ock = (block_q5_
-0008f160: 4b2a 2964 7374 202b 2073 7461 7274 202f  K*)dst + start /
-0008f170: 2051 4b5f 4b3b 0a20 2020 2020 2020 2020   QK_K;.         
-0008f180: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0008f190: 6767 6d6c 5f71 7561 6e74 697a 655f 7135  ggml_quantize_q5
-0008f1a0: 5f4b 2873 7263 202b 2073 7461 7274 2c20  _K(src + start, 
-0008f1b0: 626c 6f63 6b2c 206e 2c20 6e2c 2068 6973  block, n, n, his
-0008f1c0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-0008f1d0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0008f1e0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-0008f1f0: 5136 5f4b 3a0a 2020 2020 2020 2020 2020  Q6_K:.          
-0008f200: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0008f210: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0008f220: 7374 6172 7420 2520 514b 5f4b 203d 3d20  start % QK_K == 
-0008f230: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
-0008f240: 2020 2020 626c 6f63 6b5f 7136 5f4b 202a      block_q6_K *
-0008f250: 2062 6c6f 636b 203d 2028 626c 6f63 6b5f   block = (block_
-0008f260: 7136 5f4b 2a29 6473 7420 2b20 7374 6172  q6_K*)dst + star
-0008f270: 7420 2f20 514b 5f4b 3b0a 2020 2020 2020  t / QK_K;.      
-0008f280: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-0008f290: 203d 2067 676d 6c5f 7175 616e 7469 7a65   = ggml_quantize
-0008f2a0: 5f71 365f 4b28 7372 6320 2b20 7374 6172  _q6_K(src + star
-0008f2b0: 742c 2062 6c6f 636b 2c20 6e2c 206e 2c20  t, block, n, n, 
-0008f2c0: 6869 7374 293b 0a20 2020 2020 2020 2020  hist);.         
-0008f2d0: 2020 207d 2062 7265 616b 3b0a 2365 6e64     } break;.#end
-0008f2e0: 6966 0a20 2020 2020 2020 2063 6173 6520  if.        case 
-0008f2f0: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
-0008f300: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0008f310: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-0008f320: 2065 6c65 6d73 697a 6520 3d20 7369 7a65   elemsize = size
-0008f330: 6f66 2867 676d 6c5f 6670 3136 5f74 293b  of(ggml_fp16_t);
-0008f340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008f350: 2067 676d 6c5f 6670 3332 5f74 6f5f 6670   ggml_fp32_to_fp
-0008f360: 3136 5f72 6f77 2873 7263 202b 2073 7461  16_row(src + sta
-0008f370: 7274 2c20 2867 676d 6c5f 6670 3136 5f74  rt, (ggml_fp16_t
-0008f380: 202a 2964 7374 202b 2073 7461 7274 2c20   *)dst + start, 
-0008f390: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
-0008f3a0: 2020 2020 7265 7375 6c74 203d 206e 202a      result = n *
-0008f3b0: 2065 6c65 6d73 697a 653b 0a20 2020 2020   elemsize;.     
-0008f3c0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0008f3d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0008f3e0: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
-0008f3f0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0008f400: 2020 2020 2020 2020 2020 696e 7420 656c            int el
-0008f410: 656d 7369 7a65 203d 2073 697a 656f 6628  emsize = sizeof(
-0008f420: 666c 6f61 7429 3b0a 2020 2020 2020 2020  float);.        
-0008f430: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0008f440: 206e 202a 2065 6c65 6d73 697a 653b 0a20   n * elemsize;. 
-0008f450: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0008f460: 656d 6370 7928 2875 696e 7438 5f74 202a  emcpy((uint8_t *
-0008f470: 2964 7374 202b 2073 7461 7274 202a 2065  )dst + start * e
-0008f480: 6c65 6d73 697a 652c 2073 7263 202b 2073  lemsize, src + s
-0008f490: 7461 7274 2c20 7265 7375 6c74 293b 0a20  tart, result);. 
-0008f4a0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0008f4b0: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
-0008f4c0: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-0008f4d0: 2061 7373 6572 7428 6661 6c73 6529 3b0a   assert(false);.
-0008f4e0: 2020 2020 7d0a 2020 2020 7265 7475 726e      }.    return
-0008f4f0: 2072 6573 756c 743b 0a7d 0a0a 2f2f 2f2f   result;.}..////
-0008f500: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008f510: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008f520: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008f530: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008f540: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 0a0a 696e  ////////////..in
-0008f550: 7420 6767 6d6c 5f63 7075 5f68 6173 5f61  t ggml_cpu_has_a
-0008f560: 7678 2876 6f69 6429 207b 0a23 6966 2064  vx(void) {.#if d
-0008f570: 6566 696e 6564 285f 5f41 5658 5f5f 290a  efined(__AVX__).
-0008f580: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
-0008f590: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
-0008f5a0: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
-0008f5b0: 6767 6d6c 5f63 7075 5f68 6173 5f61 7678  ggml_cpu_has_avx
-0008f5c0: 3228 766f 6964 2920 7b0a 2369 6620 6465  2(void) {.#if de
-0008f5d0: 6669 6e65 6428 5f5f 4156 5832 5f5f 290a  fined(__AVX2__).
-0008f5e0: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
-0008f5f0: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
-0008f600: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
-0008f610: 6767 6d6c 5f63 7075 5f68 6173 5f61 7678  ggml_cpu_has_avx
-0008f620: 3531 3228 766f 6964 2920 7b0a 2369 6620  512(void) {.#if 
-0008f630: 6465 6669 6e65 6428 5f5f 4156 5835 3132  defined(__AVX512
-0008f640: 465f 5f29 0a20 2020 2072 6574 7572 6e20  F__).    return 
-0008f650: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
-0008f660: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
-0008f670: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
-0008f680: 735f 6176 7835 3132 5f76 626d 6928 766f  s_avx512_vbmi(vo
-0008f690: 6964 2920 7b0a 2369 6620 6465 6669 6e65  id) {.#if define
-0008f6a0: 6428 5f5f 4156 5835 3132 5642 4d49 5f5f  d(__AVX512VBMI__
-0008f6b0: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
-0008f6c0: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
-0008f6d0: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
-0008f6e0: 7420 6767 6d6c 5f63 7075 5f68 6173 5f61  t ggml_cpu_has_a
-0008f6f0: 7678 3531 325f 766e 6e69 2876 6f69 6429  vx512_vnni(void)
-0008f700: 207b 0a23 6966 2064 6566 696e 6564 285f   {.#if defined(_
-0008f710: 5f41 5658 3531 3256 4e4e 495f 5f29 0a20  _AVX512VNNI__). 
-0008f720: 2020 2072 6574 7572 6e20 313b 0a23 656c     return 1;.#el
-0008f730: 7365 0a20 2020 2072 6574 7572 6e20 303b  se.    return 0;
-0008f740: 0a23 656e 6469 660a 7d0a 0a69 6e74 2067  .#endif.}..int g
-0008f750: 676d 6c5f 6370 755f 6861 735f 666d 6128  gml_cpu_has_fma(
-0008f760: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
-0008f770: 6e65 6428 5f5f 464d 415f 5f29 0a20 2020  ned(__FMA__).   
-0008f780: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
-0008f790: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
-0008f7a0: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
-0008f7b0: 6c5f 6370 755f 6861 735f 6e65 6f6e 2876  l_cpu_has_neon(v
-0008f7c0: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
-0008f7d0: 6564 285f 5f41 524d 5f4e 454f 4e29 0a20  ed(__ARM_NEON). 
-0008f7e0: 2020 2072 6574 7572 6e20 313b 0a23 656c     return 1;.#el
-0008f7f0: 7365 0a20 2020 2072 6574 7572 6e20 303b  se.    return 0;
-0008f800: 0a23 656e 6469 660a 7d0a 0a69 6e74 2067  .#endif.}..int g
-0008f810: 676d 6c5f 6370 755f 6861 735f 6172 6d5f  gml_cpu_has_arm_
-0008f820: 666d 6128 766f 6964 2920 7b0a 2369 6620  fma(void) {.#if 
-0008f830: 6465 6669 6e65 6428 5f5f 4152 4d5f 4645  defined(__ARM_FE
-0008f840: 4154 5552 455f 464d 4129 0a20 2020 2072  ATURE_FMA).    r
-0008f850: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
-0008f860: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
-0008f870: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
-0008f880: 6370 755f 6861 735f 6631 3663 2876 6f69  cpu_has_f16c(voi
-0008f890: 6429 207b 0a23 6966 2064 6566 696e 6564  d) {.#if defined
-0008f8a0: 285f 5f46 3136 435f 5f29 0a20 2020 2072  (__F16C__).    r
-0008f8b0: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
-0008f8c0: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
-0008f8d0: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
-0008f8e0: 6370 755f 6861 735f 6670 3136 5f76 6128  cpu_has_fp16_va(
-0008f8f0: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
-0008f900: 6e65 6428 5f5f 4152 4d5f 4645 4154 5552  ned(__ARM_FEATUR
-0008f910: 455f 4650 3136 5f56 4543 544f 525f 4152  E_FP16_VECTOR_AR
-0008f920: 4954 484d 4554 4943 290a 2020 2020 7265  ITHMETIC).    re
-0008f930: 7475 726e 2031 3b0a 2365 6c73 650a 2020  turn 1;.#else.  
-0008f940: 2020 7265 7475 726e 2030 3b0a 2365 6e64    return 0;.#end
-0008f950: 6966 0a7d 0a0a 696e 7420 6767 6d6c 5f63  if.}..int ggml_c
-0008f960: 7075 5f68 6173 5f77 6173 6d5f 7369 6d64  pu_has_wasm_simd
-0008f970: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
-0008f980: 696e 6564 285f 5f77 6173 6d5f 7369 6d64  ined(__wasm_simd
-0008f990: 3132 385f 5f29 0a20 2020 2072 6574 7572  128__).    retur
-0008f9a0: 6e20 313b 0a23 656c 7365 0a20 2020 2072  n 1;.#else.    r
-0008f9b0: 6574 7572 6e20 303b 0a23 656e 6469 660a  eturn 0;.#endif.
-0008f9c0: 7d0a 0a69 6e74 2067 676d 6c5f 6370 755f  }..int ggml_cpu_
-0008f9d0: 6861 735f 626c 6173 2876 6f69 6429 207b  has_blas(void) {
-0008f9e0: 0a23 6966 2064 6566 696e 6564 2847 474d  .#if defined(GGM
-0008f9f0: 4c5f 5553 455f 4143 4345 4c45 5241 5445  L_USE_ACCELERATE
-0008fa00: 2920 7c7c 2064 6566 696e 6564 2847 474d  ) || defined(GGM
-0008fa10: 4c5f 5553 455f 4f50 454e 424c 4153 2920  L_USE_OPENBLAS) 
-0008fa20: 7c7c 2064 6566 696e 6564 2847 474d 4c5f  || defined(GGML_
-0008fa30: 5553 455f 4355 424c 4153 2920 7c7c 2064  USE_CUBLAS) || d
-0008fa40: 6566 696e 6564 2847 474d 4c5f 5553 455f  efined(GGML_USE_
-0008fa50: 434c 424c 4153 5429 0a20 2020 2072 6574  CLBLAST).    ret
-0008fa60: 7572 6e20 313b 0a23 656c 7365 0a20 2020  urn 1;.#else.   
-0008fa70: 2072 6574 7572 6e20 303b 0a23 656e 6469   return 0;.#endi
-0008fa80: 660a 7d0a 0a69 6e74 2067 676d 6c5f 6370  f.}..int ggml_cp
-0008fa90: 755f 6861 735f 6375 626c 6173 2876 6f69  u_has_cublas(voi
-0008faa0: 6429 207b 0a23 6966 2064 6566 696e 6564  d) {.#if defined
-0008fab0: 2847 474d 4c5f 5553 455f 4355 424c 4153  (GGML_USE_CUBLAS
-0008fac0: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
-0008fad0: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
-0008fae0: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
-0008faf0: 7420 6767 6d6c 5f63 7075 5f68 6173 5f63  t ggml_cpu_has_c
-0008fb00: 6c62 6c61 7374 2876 6f69 6429 207b 0a23  lblast(void) {.#
-0008fb10: 6966 2064 6566 696e 6564 2847 474d 4c5f  if defined(GGML_
-0008fb20: 5553 455f 434c 424c 4153 5429 0a20 2020  USE_CLBLAST).   
-0008fb30: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
-0008fb40: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
-0008fb50: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
-0008fb60: 6c5f 6370 755f 6861 735f 6770 7562 6c61  l_cpu_has_gpubla
-0008fb70: 7328 766f 6964 2920 7b0a 2020 2020 7265  s(void) {.    re
-0008fb80: 7475 726e 2067 676d 6c5f 6370 755f 6861  turn ggml_cpu_ha
-0008fb90: 735f 6375 626c 6173 2829 207c 7c20 6767  s_cublas() || gg
-0008fba0: 6d6c 5f63 7075 5f68 6173 5f63 6c62 6c61  ml_cpu_has_clbla
-0008fbb0: 7374 2829 3b0a 7d0a 0a69 6e74 2067 676d  st();.}..int ggm
-0008fbc0: 6c5f 6370 755f 6861 735f 7373 6533 2876  l_cpu_has_sse3(v
-0008fbd0: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
-0008fbe0: 6564 285f 5f53 5345 335f 5f29 0a20 2020  ed(__SSE3__).   
-0008fbf0: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
-0008fc00: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
-0008fc10: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
-0008fc20: 6c5f 6370 755f 6861 735f 7673 7828 766f  l_cpu_has_vsx(vo
-0008fc30: 6964 2920 7b0a 2369 6620 6465 6669 6e65  id) {.#if define
-0008fc40: 6428 5f5f 504f 5745 5239 5f56 4543 544f  d(__POWER9_VECTO
-0008fc50: 525f 5f29 0a20 2020 2072 6574 7572 6e20  R__).    return 
-0008fc60: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
-0008fc70: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
-0008fc80: 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .///////////////
-0008fc90: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008fca0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008fcb0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008fcc0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008fcd0: 2f0a                                     /.
+0008c710: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
+0008c720: 742d 3e61 6461 6d2e 7668 293b 0a20 2020  t->adam.vh);.   
+0008c730: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0008c740: 286f 7074 2d3e 6164 616d 2e70 6629 207b  (opt->adam.pf) {
+0008c750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008c760: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
+0008c770: 726f 286f 7074 2d3e 6164 616d 2e70 6629  ro(opt->adam.pf)
+0008c780: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0008c790: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0008c7a0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0008c7b0: 2063 6173 6520 4747 4d4c 5f4f 5054 5f4c   case GGML_OPT_L
+0008c7c0: 4246 4753 3a0a 2020 2020 2020 2020 2020  BFGS:.          
+0008c7d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0008c7e0: 2020 2020 6f70 742d 3e6c 6266 6773 2e78      opt->lbfgs.x
+0008c7f0: 2020 3d20 6767 6d6c 5f6e 6577 5f74 656e    = ggml_new_ten
+0008c800: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
+0008c810: 5f54 5950 455f 4633 322c 206e 7829 3b0a  _TYPE_F32, nx);.
+0008c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c830: 6f70 742d 3e6c 6266 6773 2e78 7020 3d20  opt->lbfgs.xp = 
+0008c840: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
+0008c850: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
+0008c860: 455f 4633 322c 206e 7829 3b0a 2020 2020  E_F32, nx);.    
+0008c870: 2020 2020 2020 2020 2020 2020 6f70 742d              opt-
+0008c880: 3e6c 6266 6773 2e67 2020 3d20 6767 6d6c  >lbfgs.g  = ggml
+0008c890: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
+0008c8a0: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
+0008c8b0: 322c 206e 7829 3b0a 2020 2020 2020 2020  2, nx);.        
+0008c8c0: 2020 2020 2020 2020 6f70 742d 3e6c 6266          opt->lbf
+0008c8d0: 6773 2e67 7020 3d20 6767 6d6c 5f6e 6577  gs.gp = ggml_new
+0008c8e0: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
+0008c8f0: 4747 4d4c 5f54 5950 455f 4633 322c 206e  GGML_TYPE_F32, n
+0008c900: 7829 3b0a 2020 2020 2020 2020 2020 2020  x);.            
+0008c910: 2020 2020 6f70 742d 3e6c 6266 6773 2e64      opt->lbfgs.d
+0008c920: 2020 3d20 6767 6d6c 5f6e 6577 5f74 656e    = ggml_new_ten
+0008c930: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
+0008c940: 5f54 5950 455f 4633 322c 206e 7829 3b0a  _TYPE_F32, nx);.
+0008c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c960: 6f70 742d 3e6c 6266 6773 2e70 6620 3d20  opt->lbfgs.pf = 
+0008c970: 7061 7261 6d73 2e70 6173 7420 3e20 300a  params.past > 0.
+0008c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008c990: 2020 2020 3f20 6767 6d6c 5f6e 6577 5f74      ? ggml_new_t
+0008c9a0: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
+0008c9b0: 4d4c 5f54 5950 455f 4633 322c 2070 6172  ML_TYPE_F32, par
+0008c9c0: 616d 732e 7061 7374 290a 2020 2020 2020  ams.past).      
+0008c9d0: 2020 2020 2020 2020 2020 2020 2020 3a20                : 
+0008c9e0: 4e55 4c4c 3b0a 2020 2020 2020 2020 2020  NULL;.          
+0008c9f0: 2020 2020 2020 6f70 742d 3e6c 6266 6773        opt->lbfgs
+0008ca00: 2e6c 6d61 6c20 3d20 6767 6d6c 5f6e 6577  .lmal = ggml_new
+0008ca10: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
+0008ca20: 4747 4d4c 5f54 5950 455f 4633 322c 2070  GGML_TYPE_F32, p
+0008ca30: 6172 616d 732e 6c62 6667 732e 6d29 3b0a  arams.lbfgs.m);.
+0008ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008ca50: 6f70 742d 3e6c 6266 6773 2e6c 6d79 7320  opt->lbfgs.lmys 
+0008ca60: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
+0008ca70: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
+0008ca80: 5950 455f 4633 322c 2070 6172 616d 732e  YPE_F32, params.
+0008ca90: 6c62 6667 732e 6d29 3b0a 2020 2020 2020  lbfgs.m);.      
+0008caa0: 2020 2020 2020 2020 2020 6f70 742d 3e6c            opt->l
+0008cab0: 6266 6773 2e6c 6d73 2020 3d20 6767 6d6c  bfgs.lms  = ggml
+0008cac0: 5f6e 6577 5f74 656e 736f 725f 3264 2863  _new_tensor_2d(c
+0008cad0: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
+0008cae0: 322c 206e 782c 2070 6172 616d 732e 6c62  2, nx, params.lb
+0008caf0: 6667 732e 6d29 3b0a 2020 2020 2020 2020  fgs.m);.        
+0008cb00: 2020 2020 2020 2020 6f70 742d 3e6c 6266          opt->lbf
+0008cb10: 6773 2e6c 6d79 2020 3d20 6767 6d6c 5f6e  gs.lmy  = ggml_n
+0008cb20: 6577 5f74 656e 736f 725f 3264 2863 7478  ew_tensor_2d(ctx
+0008cb30: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
+0008cb40: 206e 782c 2070 6172 616d 732e 6c62 6667   nx, params.lbfg
+0008cb50: 732e 6d29 3b0a 2020 2020 2020 2020 2020  s.m);.          
+0008cb60: 2020 2020 2020 6767 6d6c 5f73 6574 5f7a        ggml_set_z
+0008cb70: 6572 6f28 6f70 742d 3e6c 6266 6773 2e78  ero(opt->lbfgs.x
+0008cb80: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0008cb90: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
+0008cba0: 286f 7074 2d3e 6c62 6667 732e 7870 293b  (opt->lbfgs.xp);
+0008cbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008cbc0: 2067 676d 6c5f 7365 745f 7a65 726f 286f   ggml_set_zero(o
+0008cbd0: 7074 2d3e 6c62 6667 732e 6729 3b0a 2020  pt->lbfgs.g);.  
+0008cbe0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0008cbf0: 6d6c 5f73 6574 5f7a 6572 6f28 6f70 742d  ml_set_zero(opt-
+0008cc00: 3e6c 6266 6773 2e67 7029 3b0a 2020 2020  >lbfgs.gp);.    
+0008cc10: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0008cc20: 5f73 6574 5f7a 6572 6f28 6f70 742d 3e6c  _set_zero(opt->l
+0008cc30: 6266 6773 2e64 293b 0a20 2020 2020 2020  bfgs.d);.       
+0008cc40: 2020 2020 2020 2020 2067 676d 6c5f 7365           ggml_se
+0008cc50: 745f 7a65 726f 286f 7074 2d3e 6c62 6667  t_zero(opt->lbfg
+0008cc60: 732e 7066 293b 0a20 2020 2020 2020 2020  s.pf);.         
+0008cc70: 2020 2020 2020 2069 6620 286f 7074 2d3e         if (opt->
+0008cc80: 6c62 6667 732e 7066 2920 7b0a 2020 2020  lbfgs.pf) {.    
+0008cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008cca0: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
+0008ccb0: 742d 3e6c 6266 6773 2e70 6629 3b0a 2020  t->lbfgs.pf);.  
+0008ccc0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0008ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008cce0: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
+0008ccf0: 742d 3e6c 6266 6773 2e6c 6d61 6c29 3b0a  t->lbfgs.lmal);.
+0008cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008cd10: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
+0008cd20: 742d 3e6c 6266 6773 2e6c 6d79 7329 3b0a  t->lbfgs.lmys);.
+0008cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008cd40: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
+0008cd50: 742d 3e6c 6266 6773 2e6c 6d73 293b 0a20  t->lbfgs.lms);. 
+0008cd60: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0008cd70: 676d 6c5f 7365 745f 7a65 726f 286f 7074  gml_set_zero(opt
+0008cd80: 2d3e 6c62 6667 732e 6c6d 7929 3b0a 2020  ->lbfgs.lmy);.  
+0008cd90: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0008cda0: 6b3b 0a20 2020 207d 0a7d 0a0a 656e 756d  k;.    }.}..enum
+0008cdb0: 2067 676d 6c5f 6f70 745f 7265 7375 6c74   ggml_opt_result
+0008cdc0: 2067 676d 6c5f 6f70 7428 0a20 2020 2020   ggml_opt(.     
+0008cdd0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
+0008cde0: 6f6e 7465 7874 202a 2063 7478 2c0a 2020  ontext * ctx,.  
+0008cdf0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0008ce00: 6c5f 6f70 745f 7061 7261 6d73 2070 6172  l_opt_params par
+0008ce10: 616d 732c 0a20 2020 2020 2020 2073 7472  ams,.        str
+0008ce20: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0008ce30: 2a20 6629 207b 0a20 2020 2062 6f6f 6c20  * f) {.    bool 
+0008ce40: 6672 6565 5f63 7478 203d 2066 616c 7365  free_ctx = false
+0008ce50: 3b0a 2020 2020 6966 2028 6374 7820 3d3d  ;.    if (ctx ==
+0008ce60: 204e 554c 4c29 207b 0a20 2020 2020 2020   NULL) {.       
+0008ce70: 2073 7472 7563 7420 6767 6d6c 5f69 6e69   struct ggml_ini
+0008ce80: 745f 7061 7261 6d73 2070 6172 616d 735f  t_params params_
+0008ce90: 6374 7820 3d20 7b0a 2020 2020 2020 2020  ctx = {.        
+0008cea0: 2020 2020 2e6d 656d 5f73 697a 6520 2020      .mem_size   
+0008ceb0: 3d20 3136 2a31 3032 342a 3130 3234 2c0a  = 16*1024*1024,.
+0008cec0: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
+0008ced0: 5f62 7566 6665 7220 3d20 4e55 4c4c 2c0a  _buffer = NULL,.
+0008cee0: 2020 2020 2020 2020 2020 2020 2e6e 6f5f              .no_
+0008cef0: 616c 6c6f 6320 2020 3d20 6661 6c73 652c  alloc   = false,
+0008cf00: 0a20 2020 2020 2020 207d 3b0a 0a20 2020  .        };..   
+0008cf10: 2020 2020 2063 7478 203d 2067 676d 6c5f       ctx = ggml_
+0008cf20: 696e 6974 2870 6172 616d 735f 6374 7829  init(params_ctx)
+0008cf30: 3b0a 2020 2020 2020 2020 6966 2028 6374  ;.        if (ct
+0008cf40: 7820 3d3d 204e 554c 4c29 207b 0a20 2020  x == NULL) {.   
+0008cf50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0008cf60: 4747 4d4c 5f4f 5054 5f4e 4f5f 434f 4e54  GGML_OPT_NO_CONT
+0008cf70: 4558 543b 0a20 2020 2020 2020 207d 0a0a  EXT;.        }..
+0008cf80: 2020 2020 2020 2020 6672 6565 5f63 7478          free_ctx
+0008cf90: 203d 2074 7275 653b 0a20 2020 207d 0a0a   = true;.    }..
+0008cfa0: 2020 2020 656e 756d 2067 676d 6c5f 6f70      enum ggml_op
+0008cfb0: 745f 7265 7375 6c74 2072 6573 756c 7420  t_result result 
+0008cfc0: 3d20 4747 4d4c 5f4f 5054 5f4f 4b3b 0a0a  = GGML_OPT_OK;..
+0008cfd0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0008cfe0: 6f70 745f 636f 6e74 6578 7420 2a20 6f70  opt_context * op
+0008cff0: 7420 3d20 2873 7472 7563 7420 6767 6d6c  t = (struct ggml
+0008d000: 5f6f 7074 5f63 6f6e 7465 7874 202a 2920  _opt_context *) 
+0008d010: 616c 6c6f 6361 2873 697a 656f 6628 7374  alloca(sizeof(st
+0008d020: 7275 6374 2067 676d 6c5f 6f70 745f 636f  ruct ggml_opt_co
+0008d030: 6e74 6578 7429 293b 0a0a 2020 2020 6767  ntext));..    gg
+0008d040: 6d6c 5f6f 7074 5f69 6e69 7428 6374 782c  ml_opt_init(ctx,
+0008d050: 206f 7074 2c20 7061 7261 6d73 2c20 3029   opt, params, 0)
+0008d060: 3b0a 2020 2020 7265 7375 6c74 203d 2067  ;.    result = g
+0008d070: 676d 6c5f 6f70 745f 7265 7375 6d65 2863  gml_opt_resume(c
+0008d080: 7478 2c20 6f70 742c 2066 293b 0a0a 2020  tx, opt, f);..  
+0008d090: 2020 6966 2028 6672 6565 5f63 7478 2920    if (free_ctx) 
+0008d0a0: 7b0a 2020 2020 2020 2020 6767 6d6c 5f66  {.        ggml_f
+0008d0b0: 7265 6528 6374 7829 3b0a 2020 2020 7d0a  ree(ctx);.    }.
+0008d0c0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+0008d0d0: 6c74 3b0a 7d0a 0a65 6e75 6d20 6767 6d6c  lt;.}..enum ggml
+0008d0e0: 5f6f 7074 5f72 6573 756c 7420 6767 6d6c  _opt_result ggml
+0008d0f0: 5f6f 7074 5f72 6573 756d 6528 0a20 2020  _opt_resume(.   
+0008d100: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0008d110: 5f63 6f6e 7465 7874 202a 2063 7478 2c0a  _context * ctx,.
+0008d120: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0008d130: 676d 6c5f 6f70 745f 636f 6e74 6578 7420  gml_opt_context 
+0008d140: 2a20 6f70 742c 0a20 2020 2020 2020 2073  * opt,.        s
+0008d150: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0008d160: 7220 2a20 6629 207b 0a0a 2020 2020 2f2f  r * f) {..    //
+0008d170: 2062 7569 6c64 2066 6f72 7761 7264 202b   build forward +
+0008d180: 2062 6163 6b77 6172 6420 636f 6d70 7574   backward comput
+0008d190: 6520 6772 6170 6873 0a20 2020 2073 7472  e graphs.    str
+0008d1a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0008d1b0: 2a20 6766 6275 6620 3d20 6767 6d6c 5f6e  * gfbuf = ggml_n
+0008d1c0: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
+0008d1d0: 2c20 4747 4d4c 5f54 5950 455f 4933 322c  , GGML_TYPE_I32,
+0008d1e0: 2073 697a 656f 6628 7374 7275 6374 2067   sizeof(struct g
+0008d1f0: 676d 6c5f 6367 7261 7068 2920 2f20 4747  gml_cgraph) / GG
+0008d200: 4d4c 5f54 5950 455f 5349 5a45 5b47 474d  ML_TYPE_SIZE[GGM
+0008d210: 4c5f 5459 5045 5f49 3332 5d2b 2028 7369  L_TYPE_I32]+ (si
+0008d220: 7a65 6f66 2873 7472 7563 7420 6767 6d6c  zeof(struct ggml
+0008d230: 5f63 6772 6170 6829 2025 2047 474d 4c5f  _cgraph) % GGML_
+0008d240: 5459 5045 5f53 495a 455b 4747 4d4c 5f54  TYPE_SIZE[GGML_T
+0008d250: 5950 455f 4933 325d 203f 2031 203a 2030  YPE_I32] ? 1 : 0
+0008d260: 2929 3b0a 2020 2020 7374 7275 6374 2067  ));.    struct g
+0008d270: 676d 6c5f 7465 6e73 6f72 202a 2067 6262  gml_tensor * gbb
+0008d280: 7566 203d 2067 676d 6c5f 6e65 775f 7465  uf = ggml_new_te
+0008d290: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
+0008d2a0: 4c5f 5459 5045 5f49 3332 2c20 7369 7a65  L_TYPE_I32, size
+0008d2b0: 6f66 2873 7472 7563 7420 6767 6d6c 5f63  of(struct ggml_c
+0008d2c0: 6772 6170 6829 202f 2047 474d 4c5f 5459  graph) / GGML_TY
+0008d2d0: 5045 5f53 495a 455b 4747 4d4c 5f54 5950  PE_SIZE[GGML_TYP
+0008d2e0: 455f 4933 325d 2b20 2873 697a 656f 6628  E_I32]+ (sizeof(
+0008d2f0: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+0008d300: 7068 2920 2520 4747 4d4c 5f54 5950 455f  ph) % GGML_TYPE_
+0008d310: 5349 5a45 5b47 474d 4c5f 5459 5045 5f49  SIZE[GGML_TYPE_I
+0008d320: 3332 5d20 3f20 3120 3a20 3029 293b 0a0a  32] ? 1 : 0));..
+0008d330: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0008d340: 6367 7261 7068 202a 2067 6620 3d20 2873  cgraph * gf = (s
+0008d350: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+0008d360: 6820 2a29 2067 6662 7566 2d3e 6461 7461  h *) gfbuf->data
+0008d370: 3b0a 2020 2020 7374 7275 6374 2067 676d  ;.    struct ggm
+0008d380: 6c5f 6367 7261 7068 202a 2067 6220 3d20  l_cgraph * gb = 
+0008d390: 2873 7472 7563 7420 6767 6d6c 5f63 6772  (struct ggml_cgr
+0008d3a0: 6170 6820 2a29 2067 6262 7566 2d3e 6461  aph *) gbbuf->da
+0008d3b0: 7461 3b0a 0a20 2020 202a 6766 203d 2067  ta;..    *gf = g
+0008d3c0: 676d 6c5f 6275 696c 645f 666f 7277 6172  gml_build_forwar
+0008d3d0: 6420 2866 293b 0a20 2020 202a 6762 203d  d (f);.    *gb =
+0008d3e0: 2067 676d 6c5f 6275 696c 645f 6261 636b   ggml_build_back
+0008d3f0: 7761 7264 2863 7478 2c20 6766 2c20 7472  ward(ctx, gf, tr
+0008d400: 7565 293b 0a0a 2020 2020 7265 7475 726e  ue);..    return
+0008d410: 2067 676d 6c5f 6f70 745f 7265 7375 6d65   ggml_opt_resume
+0008d420: 5f67 2863 7478 2c20 6f70 742c 2066 2c20  _g(ctx, opt, f, 
+0008d430: 6766 2c20 6762 293b 0a7d 0a0a 656e 756d  gf, gb);.}..enum
+0008d440: 2067 676d 6c5f 6f70 745f 7265 7375 6c74   ggml_opt_result
+0008d450: 2067 676d 6c5f 6f70 745f 7265 7375 6d65   ggml_opt_resume
+0008d460: 5f67 280a 2020 2020 2020 2020 7374 7275  _g(.        stru
+0008d470: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0008d480: 2a20 6374 782c 0a20 2020 2020 2020 2073  * ctx,.        s
+0008d490: 7472 7563 7420 6767 6d6c 5f6f 7074 5f63  truct ggml_opt_c
+0008d4a0: 6f6e 7465 7874 202a 206f 7074 2c0a 2020  ontext * opt,.  
+0008d4b0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0008d4c0: 6c5f 7465 6e73 6f72 202a 2066 2c0a 2020  l_tensor * f,.  
+0008d4d0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0008d4e0: 6c5f 6367 7261 7068 202a 2067 662c 0a20  l_cgraph * gf,. 
+0008d4f0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0008d500: 6d6c 5f63 6772 6170 6820 2a20 6762 2920  ml_cgraph * gb) 
+0008d510: 7b0a 0a20 2020 202f 2f20 6275 696c 6420  {..    // build 
+0008d520: 666f 7277 6172 6420 2b20 6261 636b 7761  forward + backwa
+0008d530: 7264 2063 6f6d 7075 7465 2067 7261 7068  rd compute graph
+0008d540: 730a 2020 2020 656e 756d 2067 676d 6c5f  s.    enum ggml_
+0008d550: 6f70 745f 7265 7375 6c74 2072 6573 756c  opt_result resul
+0008d560: 7420 3d20 4747 4d4c 5f4f 5054 5f4f 4b3b  t = GGML_OPT_OK;
+0008d570: 0a0a 2020 2020 7377 6974 6368 2028 6f70  ..    switch (op
+0008d580: 742d 3e70 6172 616d 732e 7479 7065 2920  t->params.type) 
+0008d590: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
+0008d5a0: 474d 4c5f 4f50 545f 4144 414d 3a0a 2020  GML_OPT_ADAM:.  
+0008d5b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0008d5c0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+0008d5d0: 6c74 203d 2067 676d 6c5f 6f70 745f 6164  lt = ggml_opt_ad
+0008d5e0: 616d 2863 7478 2c20 6f70 742c 206f 7074  am(ctx, opt, opt
+0008d5f0: 2d3e 7061 7261 6d73 2c20 662c 2067 662c  ->params, f, gf,
+0008d600: 2067 6229 3b0a 2020 2020 2020 2020 2020   gb);.          
+0008d610: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0008d620: 2020 2063 6173 6520 4747 4d4c 5f4f 5054     case GGML_OPT
+0008d630: 5f4c 4246 4753 3a0a 2020 2020 2020 2020  _LBFGS:.        
+0008d640: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0008d650: 2020 2020 2020 7265 7375 6c74 203d 2067        result = g
+0008d660: 676d 6c5f 6f70 745f 6c62 6667 7328 6374  gml_opt_lbfgs(ct
+0008d670: 782c 206f 7074 2c20 6f70 742d 3e70 6172  x, opt, opt->par
+0008d680: 616d 732c 2066 2c20 6766 2c20 6762 293b  ams, f, gf, gb);
+0008d690: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0008d6a0: 7265 616b 3b0a 2020 2020 7d0a 0a20 2020  reak;.    }..   
+0008d6b0: 2069 6620 286f 7074 2d3e 7061 7261 6d73   if (opt->params
+0008d6c0: 2e70 7269 6e74 5f66 6f72 7761 7264 5f67  .print_forward_g
+0008d6d0: 7261 7068 2920 7b0a 2020 2020 2020 2020  raph) {.        
+0008d6e0: 6767 6d6c 5f67 7261 7068 5f70 7269 6e74  ggml_graph_print
+0008d6f0: 2020 2028 6766 293b 0a20 2020 2020 2020     (gf);.       
+0008d700: 2067 676d 6c5f 6772 6170 685f 6475 6d70   ggml_graph_dump
+0008d710: 5f64 6f74 2867 662c 204e 554c 4c2c 2022  _dot(gf, NULL, "
+0008d720: 6f70 742d 666f 7277 6172 642e 646f 7422  opt-forward.dot"
+0008d730: 293b 0a20 2020 207d 0a0a 2020 2020 6966  );.    }..    if
+0008d740: 2028 6f70 742d 3e70 6172 616d 732e 7072   (opt->params.pr
+0008d750: 696e 745f 6261 636b 7761 7264 5f67 7261  int_backward_gra
+0008d760: 7068 2920 7b0a 2020 2020 2020 2020 6767  ph) {.        gg
+0008d770: 6d6c 5f67 7261 7068 5f70 7269 6e74 2020  ml_graph_print  
+0008d780: 2028 6762 293b 0a20 2020 2020 2020 2067   (gb);.        g
+0008d790: 676d 6c5f 6772 6170 685f 6475 6d70 5f64  gml_graph_dump_d
+0008d7a0: 6f74 2867 622c 2067 662c 2022 6f70 742d  ot(gb, gf, "opt-
+0008d7b0: 6261 636b 7761 7264 2e64 6f74 2229 3b0a  backward.dot");.
+0008d7c0: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
+0008d7d0: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f2f  n result;.}..///
+0008d7e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008d7f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008d800: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008d810: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008d820: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a 0a73  /////////////..s
+0008d830: 697a 655f 7420 6767 6d6c 5f71 7561 6e74  ize_t ggml_quant
+0008d840: 697a 655f 7134 5f30 2863 6f6e 7374 2066  ize_q4_0(const f
+0008d850: 6c6f 6174 202a 2073 7263 2c20 766f 6964  loat * src, void
+0008d860: 202a 2064 7374 2c20 696e 7420 6e2c 2069   * dst, int n, i
+0008d870: 6e74 206b 2c20 696e 7436 345f 7420 2a20  nt k, int64_t * 
+0008d880: 6869 7374 2920 7b0a 2020 2020 6173 7365  hist) {.    asse
+0008d890: 7274 286b 2025 2051 4b34 5f30 203d 3d20  rt(k % QK4_0 == 
+0008d8a0: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+0008d8b0: 7420 6e62 203d 206b 202f 2051 4b34 5f30  t nb = k / QK4_0
+0008d8c0: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+0008d8d0: 6220 3d20 303b 2062 203c 206e 3b20 6220  b = 0; b < n; b 
+0008d8e0: 2b3d 206b 2920 7b0a 2020 2020 2020 2020  += k) {.        
+0008d8f0: 626c 6f63 6b5f 7134 5f30 202a 2072 6573  block_q4_0 * res
+0008d900: 7472 6963 7420 7920 3d20 2862 6c6f 636b  trict y = (block
+0008d910: 5f71 345f 3020 2a29 2064 7374 202b 2062  _q4_0 *) dst + b
+0008d920: 2f51 4b34 5f30 3b0a 0a20 2020 2020 2020  /QK4_0;..       
+0008d930: 2071 7561 6e74 697a 655f 726f 775f 7134   quantize_row_q4
+0008d940: 5f30 5f72 6566 6572 656e 6365 2873 7263  _0_reference(src
+0008d950: 202b 2062 2c20 792c 206b 293b 0a0a 2020   + b, y, k);..  
+0008d960: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0008d970: 203d 2030 3b20 6920 3c20 6e62 3b20 692b   = 0; i < nb; i+
+0008d980: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0008d990: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+0008d9a0: 206a 203c 2051 4b34 5f30 3b20 6a20 2b3d   j < QK4_0; j +=
+0008d9b0: 2032 2920 7b0a 2020 2020 2020 2020 2020   2) {.          
+0008d9c0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
+0008d9d0: 385f 7420 7669 3020 3d20 795b 695d 2e71  8_t vi0 = y[i].q
+0008d9e0: 735b 6a2f 325d 2026 2030 7830 463b 0a20  s[j/2] & 0x0F;. 
+0008d9f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0008da00: 6f6e 7374 2075 696e 7438 5f74 2076 6931  onst uint8_t vi1
+0008da10: 203d 2079 5b69 5d2e 7173 5b6a 2f32 5d20   = y[i].qs[j/2] 
+0008da20: 3e3e 2034 3b0a 0a20 2020 2020 2020 2020  >> 4;..         
+0008da30: 2020 2020 2020 2068 6973 745b 7669 305d         hist[vi0]
+0008da40: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
+0008da50: 2020 2020 6869 7374 5b76 6931 5d2b 2b3b      hist[vi1]++;
+0008da60: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0008da70: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+0008da80: 2020 2020 7265 7475 726e 2028 6e2f 514b      return (n/QK
+0008da90: 345f 302a 7369 7a65 6f66 2862 6c6f 636b  4_0*sizeof(block
+0008daa0: 5f71 345f 3029 293b 0a7d 0a0a 7369 7a65  _q4_0));.}..size
+0008dab0: 5f74 2067 676d 6c5f 7175 616e 7469 7a65  _t ggml_quantize
+0008dac0: 5f71 345f 3128 636f 6e73 7420 666c 6f61  _q4_1(const floa
+0008dad0: 7420 2a20 7372 632c 2076 6f69 6420 2a20  t * src, void * 
+0008dae0: 6473 742c 2069 6e74 206e 2c20 696e 7420  dst, int n, int 
+0008daf0: 6b2c 2069 6e74 3634 5f74 202a 2068 6973  k, int64_t * his
+0008db00: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
+0008db10: 6b20 2520 514b 345f 3120 3d3d 2030 293b  k % QK4_1 == 0);
+0008db20: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0008db30: 6220 3d20 6b20 2f20 514b 345f 313b 0a0a  b = k / QK4_1;..
+0008db40: 2020 2020 666f 7220 2869 6e74 2062 203d      for (int b =
+0008db50: 2030 3b20 6220 3c20 6e3b 2062 202b 3d20   0; b < n; b += 
+0008db60: 6b29 207b 0a20 2020 2020 2020 2062 6c6f  k) {.        blo
+0008db70: 636b 5f71 345f 3120 2a20 7265 7374 7269  ck_q4_1 * restri
+0008db80: 6374 2079 203d 2028 626c 6f63 6b5f 7134  ct y = (block_q4
+0008db90: 5f31 202a 2920 6473 7420 2b20 622f 514b  _1 *) dst + b/QK
+0008dba0: 345f 313b 0a0a 2020 2020 2020 2020 7175  4_1;..        qu
+0008dbb0: 616e 7469 7a65 5f72 6f77 5f71 345f 315f  antize_row_q4_1_
+0008dbc0: 7265 6665 7265 6e63 6528 7372 6320 2b20  reference(src + 
+0008dbd0: 622c 2079 2c20 6b29 3b0a 0a20 2020 2020  b, y, k);..     
+0008dbe0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+0008dbf0: 303b 2069 203c 206e 623b 2069 2b2b 2920  0; i < nb; i++) 
+0008dc00: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
+0008dc10: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+0008dc20: 3c20 514b 345f 313b 206a 202b 3d20 3229  < QK4_1; j += 2)
+0008dc30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0008dc40: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
+0008dc50: 2076 6930 203d 2079 5b69 5d2e 7173 5b6a   vi0 = y[i].qs[j
+0008dc60: 2f32 5d20 2620 3078 3046 3b0a 2020 2020  /2] & 0x0F;.    
+0008dc70: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0008dc80: 7420 7569 6e74 385f 7420 7669 3120 3d20  t uint8_t vi1 = 
+0008dc90: 795b 695d 2e71 735b 6a2f 325d 203e 3e20  y[i].qs[j/2] >> 
+0008dca0: 343b 0a0a 2020 2020 2020 2020 2020 2020  4;..            
+0008dcb0: 2020 2020 6869 7374 5b76 6930 5d2b 2b3b      hist[vi0]++;
+0008dcc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008dcd0: 2068 6973 745b 7669 315d 2b2b 3b0a 2020   hist[vi1]++;.  
+0008dce0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0008dcf0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+0008dd00: 2072 6574 7572 6e20 286e 2f51 4b34 5f31   return (n/QK4_1
+0008dd10: 2a73 697a 656f 6628 626c 6f63 6b5f 7134  *sizeof(block_q4
+0008dd20: 5f31 2929 3b0a 7d0a 0a73 697a 655f 7420  _1));.}..size_t 
+0008dd30: 6767 6d6c 5f71 7561 6e74 697a 655f 7135  ggml_quantize_q5
+0008dd40: 5f30 2863 6f6e 7374 2066 6c6f 6174 202a  _0(const float *
+0008dd50: 2073 7263 2c20 766f 6964 202a 2064 7374   src, void * dst
+0008dd60: 2c20 696e 7420 6e2c 2069 6e74 206b 2c20  , int n, int k, 
+0008dd70: 696e 7436 345f 7420 2a20 6869 7374 2920  int64_t * hist) 
+0008dd80: 7b0a 2020 2020 6173 7365 7274 286b 2025  {.    assert(k %
+0008dd90: 2051 4b35 5f30 203d 3d20 3029 3b0a 2020   QK5_0 == 0);.  
+0008dda0: 2020 636f 6e73 7420 696e 7420 6e62 203d    const int nb =
+0008ddb0: 206b 202f 2051 4b35 5f30 3b0a 0a20 2020   k / QK5_0;..   
+0008ddc0: 2066 6f72 2028 696e 7420 6220 3d20 303b   for (int b = 0;
+0008ddd0: 2062 203c 206e 3b20 6220 2b3d 206b 2920   b < n; b += k) 
+0008dde0: 7b0a 2020 2020 2020 2020 626c 6f63 6b5f  {.        block_
+0008ddf0: 7135 5f30 202a 2072 6573 7472 6963 7420  q5_0 * restrict 
+0008de00: 7920 3d20 2862 6c6f 636b 5f71 355f 3020  y = (block_q5_0 
+0008de10: 2a29 6473 7420 2b20 622f 514b 355f 303b  *)dst + b/QK5_0;
+0008de20: 0a0a 2020 2020 2020 2020 7175 616e 7469  ..        quanti
+0008de30: 7a65 5f72 6f77 5f71 355f 305f 7265 6665  ze_row_q5_0_refe
+0008de40: 7265 6e63 6528 7372 6320 2b20 622c 2079  rence(src + b, y
+0008de50: 2c20 6b29 3b0a 0a20 2020 2020 2020 2066  , k);..        f
+0008de60: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+0008de70: 203c 206e 623b 2069 2b2b 2920 7b0a 2020   < nb; i++) {.  
+0008de80: 2020 2020 2020 2020 2020 7569 6e74 3332            uint32
+0008de90: 5f74 2071 683b 0a20 2020 2020 2020 2020  _t qh;.         
+0008dea0: 2020 206d 656d 6370 7928 2671 682c 2026     memcpy(&qh, &
+0008deb0: 795b 695d 2e71 682c 2073 697a 656f 6628  y[i].qh, sizeof(
+0008dec0: 7168 2929 3b0a 0a20 2020 2020 2020 2020  qh));..         
+0008ded0: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
+0008dee0: 303b 206a 203c 2051 4b35 5f30 3b20 6a20  0; j < QK5_0; j 
+0008def0: 2b3d 2032 2920 7b0a 2020 2020 2020 2020  += 2) {.        
+0008df00: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+0008df10: 6e74 385f 7420 7668 3020 3d20 2828 7168  nt8_t vh0 = ((qh
+0008df20: 2026 2028 3175 203c 3c20 286a 202b 2030   & (1u << (j + 0
+0008df30: 2029 2929 203e 3e20 286a 202b 2030 2029   ))) >> (j + 0 )
+0008df40: 2920 3c3c 2034 3b0a 2020 2020 2020 2020  ) << 4;.        
+0008df50: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+0008df60: 6e74 385f 7420 7668 3120 3d20 2828 7168  nt8_t vh1 = ((qh
+0008df70: 2026 2028 3175 203c 3c20 286a 202b 2031   & (1u << (j + 1
+0008df80: 3629 2929 203e 3e20 286a 202b 2031 3229  6))) >> (j + 12)
+0008df90: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0008dfa0: 2020 2020 2f2f 2063 6173 7420 746f 2031      // cast to 1
+0008dfb0: 3620 6269 6e73 0a20 2020 2020 2020 2020  6 bins.         
+0008dfc0: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+0008dfd0: 7438 5f74 2076 6930 203d 2028 2879 5b69  t8_t vi0 = ((y[i
+0008dfe0: 5d2e 7173 5b6a 2f32 5d20 2620 3078 3046  ].qs[j/2] & 0x0F
+0008dff0: 2920 7c20 7668 3029 202f 2032 3b0a 2020  ) | vh0) / 2;.  
+0008e000: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0008e010: 6e73 7420 7569 6e74 385f 7420 7669 3120  nst uint8_t vi1 
+0008e020: 3d20 2828 795b 695d 2e71 735b 6a2f 325d  = ((y[i].qs[j/2]
+0008e030: 203e 3e20 2020 3429 207c 2076 6831 2920   >>   4) | vh1) 
+0008e040: 2f20 323b 0a0a 2020 2020 2020 2020 2020  / 2;..          
+0008e050: 2020 2020 2020 6869 7374 5b76 6930 5d2b        hist[vi0]+
+0008e060: 2b3b 0a20 2020 2020 2020 2020 2020 2020  +;.             
+0008e070: 2020 2068 6973 745b 7669 315d 2b2b 3b0a     hist[vi1]++;.
+0008e080: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0008e090: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
+0008e0a0: 2020 2072 6574 7572 6e20 286e 2f51 4b35     return (n/QK5
+0008e0b0: 5f30 2a73 697a 656f 6628 626c 6f63 6b5f  _0*sizeof(block_
+0008e0c0: 7135 5f30 2929 3b0a 7d0a 0a73 697a 655f  q5_0));.}..size_
+0008e0d0: 7420 6767 6d6c 5f71 7561 6e74 697a 655f  t ggml_quantize_
+0008e0e0: 7135 5f31 2863 6f6e 7374 2066 6c6f 6174  q5_1(const float
+0008e0f0: 202a 2073 7263 2c20 766f 6964 202a 2064   * src, void * d
+0008e100: 7374 2c20 696e 7420 6e2c 2069 6e74 206b  st, int n, int k
+0008e110: 2c20 696e 7436 345f 7420 2a20 6869 7374  , int64_t * hist
+0008e120: 2920 7b0a 2020 2020 6173 7365 7274 286b  ) {.    assert(k
+0008e130: 2025 2051 4b35 5f31 203d 3d20 3029 3b0a   % QK5_1 == 0);.
+0008e140: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+0008e150: 203d 206b 202f 2051 4b35 5f31 3b0a 0a20   = k / QK5_1;.. 
+0008e160: 2020 2066 6f72 2028 696e 7420 6220 3d20     for (int b = 
+0008e170: 303b 2062 203c 206e 3b20 6220 2b3d 206b  0; b < n; b += k
+0008e180: 2920 7b0a 2020 2020 2020 2020 626c 6f63  ) {.        bloc
+0008e190: 6b5f 7135 5f31 202a 2072 6573 7472 6963  k_q5_1 * restric
+0008e1a0: 7420 7920 3d20 2862 6c6f 636b 5f71 355f  t y = (block_q5_
+0008e1b0: 3120 2a29 6473 7420 2b20 622f 514b 355f  1 *)dst + b/QK5_
+0008e1c0: 313b 0a0a 2020 2020 2020 2020 7175 616e  1;..        quan
+0008e1d0: 7469 7a65 5f72 6f77 5f71 355f 315f 7265  tize_row_q5_1_re
+0008e1e0: 6665 7265 6e63 6528 7372 6320 2b20 622c  ference(src + b,
+0008e1f0: 2079 2c20 6b29 3b0a 0a20 2020 2020 2020   y, k);..       
+0008e200: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0008e210: 2069 203c 206e 623b 2069 2b2b 2920 7b0a   i < nb; i++) {.
+0008e220: 2020 2020 2020 2020 2020 2020 7569 6e74              uint
+0008e230: 3332 5f74 2071 683b 0a20 2020 2020 2020  32_t qh;.       
+0008e240: 2020 2020 206d 656d 6370 7928 2671 682c       memcpy(&qh,
+0008e250: 2026 795b 695d 2e71 682c 2073 697a 656f   &y[i].qh, sizeo
+0008e260: 6628 7168 2929 3b0a 0a20 2020 2020 2020  f(qh));..       
+0008e270: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+0008e280: 3d20 303b 206a 203c 2051 4b35 5f31 3b20  = 0; j < QK5_1; 
+0008e290: 6a20 2b3d 2032 2920 7b0a 2020 2020 2020  j += 2) {.      
+0008e2a0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0008e2b0: 7569 6e74 385f 7420 7668 3020 3d20 2828  uint8_t vh0 = ((
+0008e2c0: 7168 2026 2028 3175 203c 3c20 286a 202b  qh & (1u << (j +
+0008e2d0: 2030 2029 2929 203e 3e20 286a 202b 2030   0 ))) >> (j + 0
+0008e2e0: 2029 2920 3c3c 2034 3b0a 2020 2020 2020   )) << 4;.      
+0008e2f0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0008e300: 7569 6e74 385f 7420 7668 3120 3d20 2828  uint8_t vh1 = ((
+0008e310: 7168 2026 2028 3175 203c 3c20 286a 202b  qh & (1u << (j +
+0008e320: 2031 3629 2929 203e 3e20 286a 202b 2031   16))) >> (j + 1
+0008e330: 3229 293b 0a0a 2020 2020 2020 2020 2020  2));..          
+0008e340: 2020 2020 2020 2f2f 2063 6173 7420 746f        // cast to
+0008e350: 2031 3620 6269 6e73 0a20 2020 2020 2020   16 bins.       
+0008e360: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+0008e370: 696e 7438 5f74 2076 6930 203d 2028 2879  int8_t vi0 = ((y
+0008e380: 5b69 5d2e 7173 5b6a 2f32 5d20 2620 3078  [i].qs[j/2] & 0x
+0008e390: 3046 2920 7c20 7668 3029 202f 2032 3b0a  0F) | vh0) / 2;.
+0008e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008e3b0: 636f 6e73 7420 7569 6e74 385f 7420 7669  const uint8_t vi
+0008e3c0: 3120 3d20 2828 795b 695d 2e71 735b 6a2f  1 = ((y[i].qs[j/
+0008e3d0: 325d 203e 3e20 2020 3429 207c 2076 6831  2] >>   4) | vh1
+0008e3e0: 2920 2f20 323b 0a0a 2020 2020 2020 2020  ) / 2;..        
+0008e3f0: 2020 2020 2020 2020 6869 7374 5b76 6930          hist[vi0
+0008e400: 5d2b 2b3b 0a20 2020 2020 2020 2020 2020  ]++;.           
+0008e410: 2020 2020 2068 6973 745b 7669 315d 2b2b       hist[vi1]++
+0008e420: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+0008e430: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+0008e440: 0a20 2020 2072 6574 7572 6e20 286e 2f51  .    return (n/Q
+0008e450: 4b35 5f31 2a73 697a 656f 6628 626c 6f63  K5_1*sizeof(bloc
+0008e460: 6b5f 7135 5f31 2929 3b0a 7d0a 0a73 697a  k_q5_1));.}..siz
+0008e470: 655f 7420 6767 6d6c 5f71 7561 6e74 697a  e_t ggml_quantiz
+0008e480: 655f 7138 5f30 2863 6f6e 7374 2066 6c6f  e_q8_0(const flo
+0008e490: 6174 202a 2073 7263 2c20 766f 6964 202a  at * src, void *
+0008e4a0: 2064 7374 2c20 696e 7420 6e2c 2069 6e74   dst, int n, int
+0008e4b0: 206b 2c20 696e 7436 345f 7420 2a20 6869   k, int64_t * hi
+0008e4c0: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
+0008e4d0: 286b 2025 2051 4b38 5f30 203d 3d20 3029  (k % QK8_0 == 0)
+0008e4e0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0008e4f0: 6e62 203d 206b 202f 2051 4b38 5f30 3b0a  nb = k / QK8_0;.
+0008e500: 0a20 2020 2066 6f72 2028 696e 7420 6220  .    for (int b 
+0008e510: 3d20 303b 2062 203c 206e 3b20 6220 2b3d  = 0; b < n; b +=
+0008e520: 206b 2920 7b0a 2020 2020 2020 2020 626c   k) {.        bl
+0008e530: 6f63 6b5f 7138 5f30 202a 2072 6573 7472  ock_q8_0 * restr
+0008e540: 6963 7420 7920 3d20 2862 6c6f 636b 5f71  ict y = (block_q
+0008e550: 385f 3020 2a29 6473 7420 2b20 622f 514b  8_0 *)dst + b/QK
+0008e560: 385f 303b 0a0a 2020 2020 2020 2020 7175  8_0;..        qu
+0008e570: 616e 7469 7a65 5f72 6f77 5f71 385f 305f  antize_row_q8_0_
+0008e580: 7265 6665 7265 6e63 6528 7372 6320 2b20  reference(src + 
+0008e590: 622c 2079 2c20 6b29 3b0a 0a20 2020 2020  b, y, k);..     
+0008e5a0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+0008e5b0: 303b 2069 203c 206e 623b 2069 2b2b 2920  0; i < nb; i++) 
+0008e5c0: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
+0008e5d0: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+0008e5e0: 3c20 514b 385f 303b 202b 2b6a 2920 7b0a  < QK8_0; ++j) {.
+0008e5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008e600: 636f 6e73 7420 696e 7438 5f74 2076 6920  const int8_t vi 
+0008e610: 3d20 795b 695d 2e71 735b 6a5d 3b0a 0a20  = y[i].qs[j];.. 
+0008e620: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0008e630: 6973 745b 7669 2f31 3620 2b20 385d 2b2b  ist[vi/16 + 8]++
+0008e640: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+0008e650: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+0008e660: 0a20 2020 2072 6574 7572 6e20 286e 2f51  .    return (n/Q
+0008e670: 4b38 5f30 2a73 697a 656f 6628 626c 6f63  K8_0*sizeof(bloc
+0008e680: 6b5f 7138 5f30 2929 3b0a 7d0a 0a73 697a  k_q8_0));.}..siz
+0008e690: 655f 7420 6767 6d6c 5f71 7561 6e74 697a  e_t ggml_quantiz
+0008e6a0: 655f 6368 756e 6b28 656e 756d 2067 676d  e_chunk(enum ggm
+0008e6b0: 6c5f 7479 7065 2074 7970 652c 2063 6f6e  l_type type, con
+0008e6c0: 7374 2066 6c6f 6174 202a 2073 7263 2c20  st float * src, 
+0008e6d0: 766f 6964 202a 2064 7374 2c20 696e 7420  void * dst, int 
+0008e6e0: 7374 6172 742c 2069 6e74 206e 2c20 696e  start, int n, in
+0008e6f0: 7436 345f 7420 2a20 6869 7374 2920 7b0a  t64_t * hist) {.
+0008e700: 2020 2020 7369 7a65 5f74 2072 6573 756c      size_t resul
+0008e710: 7420 3d20 303b 0a20 2020 2073 7769 7463  t = 0;.    switc
+0008e720: 6820 2874 7970 6529 207b 0a20 2020 2020  h (type) {.     
+0008e730: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+0008e740: 455f 5134 5f30 3a0a 2020 2020 2020 2020  E_Q4_0:.        
+0008e750: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0008e760: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0008e770: 5428 7374 6172 7420 2520 514b 345f 3020  T(start % QK4_0 
+0008e780: 3d3d 2030 293b 0a20 2020 2020 2020 2020  == 0);.         
+0008e790: 2020 2020 2020 2062 6c6f 636b 5f71 345f         block_q4_
+0008e7a0: 3020 2a20 626c 6f63 6b20 3d20 2862 6c6f  0 * block = (blo
+0008e7b0: 636b 5f71 345f 302a 2964 7374 202b 2073  ck_q4_0*)dst + s
+0008e7c0: 7461 7274 202f 2051 4b34 5f30 3b0a 2020  tart / QK4_0;.  
+0008e7d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0008e7e0: 7375 6c74 203d 2067 676d 6c5f 7175 616e  sult = ggml_quan
+0008e7f0: 7469 7a65 5f71 345f 3028 7372 6320 2b20  tize_q4_0(src + 
+0008e800: 7374 6172 742c 2062 6c6f 636b 2c20 6e2c  start, block, n,
+0008e810: 206e 2c20 6869 7374 293b 0a20 2020 2020   n, hist);.     
+0008e820: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0008e830: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0008e840: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
+0008e850: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0008e860: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0008e870: 4153 5345 5254 2873 7461 7274 2025 2051  ASSERT(start % Q
+0008e880: 4b34 5f31 203d 3d20 3029 3b0a 2020 2020  K4_1 == 0);.    
+0008e890: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
+0008e8a0: 6b5f 7134 5f31 202a 2062 6c6f 636b 203d  k_q4_1 * block =
+0008e8b0: 2028 626c 6f63 6b5f 7134 5f31 2a29 6473   (block_q4_1*)ds
+0008e8c0: 7420 2b20 7374 6172 7420 2f20 514b 345f  t + start / QK4_
+0008e8d0: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
+0008e8e0: 2020 2072 6573 756c 7420 3d20 6767 6d6c     result = ggml
+0008e8f0: 5f71 7561 6e74 697a 655f 7134 5f31 2873  _quantize_q4_1(s
+0008e900: 7263 202b 2073 7461 7274 2c20 626c 6f63  rc + start, bloc
+0008e910: 6b2c 206e 2c20 6e2c 2068 6973 7429 3b0a  k, n, n, hist);.
+0008e920: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0008e930: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0008e940: 6520 4747 4d4c 5f54 5950 455f 5135 5f30  e GGML_TYPE_Q5_0
+0008e950: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0008e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008e970: 4747 4d4c 5f41 5353 4552 5428 7374 6172  GGML_ASSERT(star
+0008e980: 7420 2520 514b 355f 3020 3d3d 2030 293b  t % QK5_0 == 0);
+0008e990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008e9a0: 2062 6c6f 636b 5f71 355f 3020 2a20 626c   block_q5_0 * bl
+0008e9b0: 6f63 6b20 3d20 2862 6c6f 636b 5f71 355f  ock = (block_q5_
+0008e9c0: 302a 2964 7374 202b 2073 7461 7274 202f  0*)dst + start /
+0008e9d0: 2051 4b35 5f30 3b0a 2020 2020 2020 2020   QK5_0;.        
+0008e9e0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+0008e9f0: 2067 676d 6c5f 7175 616e 7469 7a65 5f71   ggml_quantize_q
+0008ea00: 355f 3028 7372 6320 2b20 7374 6172 742c  5_0(src + start,
+0008ea10: 2062 6c6f 636b 2c20 6e2c 206e 2c20 6869   block, n, n, hi
+0008ea20: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
+0008ea30: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0008ea40: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0008ea50: 5f51 355f 313a 0a20 2020 2020 2020 2020  _Q5_1:.         
+0008ea60: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0008ea70: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0008ea80: 2873 7461 7274 2025 2051 4b35 5f31 203d  (start % QK5_1 =
+0008ea90: 3d20 3029 3b0a 2020 2020 2020 2020 2020  = 0);.          
+0008eaa0: 2020 2020 2020 626c 6f63 6b5f 7135 5f31        block_q5_1
+0008eab0: 202a 2062 6c6f 636b 203d 2028 626c 6f63   * block = (bloc
+0008eac0: 6b5f 7135 5f31 2a29 6473 7420 2b20 7374  k_q5_1*)dst + st
+0008ead0: 6172 7420 2f20 514b 355f 313b 0a20 2020  art / QK5_1;.   
+0008eae0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+0008eaf0: 756c 7420 3d20 6767 6d6c 5f71 7561 6e74  ult = ggml_quant
+0008eb00: 697a 655f 7135 5f31 2873 7263 202b 2073  ize_q5_1(src + s
+0008eb10: 7461 7274 2c20 626c 6f63 6b2c 206e 2c20  tart, block, n, 
+0008eb20: 6e2c 2068 6973 7429 3b0a 2020 2020 2020  n, hist);.      
+0008eb30: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0008eb40: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0008eb50: 5f54 5950 455f 5138 5f30 3a0a 2020 2020  _TYPE_Q8_0:.    
+0008eb60: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0008eb70: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0008eb80: 5353 4552 5428 7374 6172 7420 2520 514b  SSERT(start % QK
+0008eb90: 385f 3020 3d3d 2030 293b 0a20 2020 2020  8_0 == 0);.     
+0008eba0: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
+0008ebb0: 5f71 385f 3020 2a20 626c 6f63 6b20 3d20  _q8_0 * block = 
+0008ebc0: 2862 6c6f 636b 5f71 385f 302a 2964 7374  (block_q8_0*)dst
+0008ebd0: 202b 2073 7461 7274 202f 2051 4b38 5f30   + start / QK8_0
+0008ebe0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0008ebf0: 2020 7265 7375 6c74 203d 2067 676d 6c5f    result = ggml_
+0008ec00: 7175 616e 7469 7a65 5f71 385f 3028 7372  quantize_q8_0(sr
+0008ec10: 6320 2b20 7374 6172 742c 2062 6c6f 636b  c + start, block
+0008ec20: 2c20 6e2c 206e 2c20 6869 7374 293b 0a20  , n, n, hist);. 
+0008ec30: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0008ec40: 616b 3b0a 2369 6664 6566 2047 474d 4c5f  ak;.#ifdef GGML_
+0008ec50: 5553 455f 4b5f 5155 414e 5453 0a20 2020  USE_K_QUANTS.   
+0008ec60: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0008ec70: 5950 455f 5132 5f4b 3a0a 2020 2020 2020  YPE_Q2_K:.      
+0008ec80: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0008ec90: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0008eca0: 4552 5428 7374 6172 7420 2520 514b 5f4b  ERT(start % QK_K
+0008ecb0: 203d 3d20 3029 3b0a 2020 2020 2020 2020   == 0);.        
+0008ecc0: 2020 2020 2020 2020 626c 6f63 6b5f 7132          block_q2
+0008ecd0: 5f4b 202a 2062 6c6f 636b 203d 2028 626c  _K * block = (bl
+0008ece0: 6f63 6b5f 7132 5f4b 2a29 6473 7420 2b20  ock_q2_K*)dst + 
+0008ecf0: 7374 6172 7420 2f20 514b 5f4b 3b0a 2020  start / QK_K;.  
+0008ed00: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0008ed10: 7375 6c74 203d 2067 676d 6c5f 7175 616e  sult = ggml_quan
+0008ed20: 7469 7a65 5f71 325f 4b28 7372 6320 2b20  tize_q2_K(src + 
+0008ed30: 7374 6172 742c 2062 6c6f 636b 2c20 6e2c  start, block, n,
+0008ed40: 206e 2c20 6869 7374 293b 0a20 2020 2020   n, hist);.     
+0008ed50: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0008ed60: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0008ed70: 4c5f 5459 5045 5f51 335f 4b3a 0a20 2020  L_TYPE_Q3_K:.   
+0008ed80: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0008ed90: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0008eda0: 4153 5345 5254 2873 7461 7274 2025 2051  ASSERT(start % Q
+0008edb0: 4b5f 4b20 3d3d 2030 293b 0a20 2020 2020  K_K == 0);.     
+0008edc0: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
+0008edd0: 5f71 335f 4b20 2a20 626c 6f63 6b20 3d20  _q3_K * block = 
+0008ede0: 2862 6c6f 636b 5f71 335f 4b2a 2964 7374  (block_q3_K*)dst
+0008edf0: 202b 2073 7461 7274 202f 2051 4b5f 4b3b   + start / QK_K;
+0008ee00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008ee10: 2072 6573 756c 7420 3d20 6767 6d6c 5f71   result = ggml_q
+0008ee20: 7561 6e74 697a 655f 7133 5f4b 2873 7263  uantize_q3_K(src
+0008ee30: 202b 2073 7461 7274 2c20 626c 6f63 6b2c   + start, block,
+0008ee40: 206e 2c20 6e2c 2068 6973 7429 3b0a 2020   n, n, hist);.  
+0008ee50: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0008ee60: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0008ee70: 4747 4d4c 5f54 5950 455f 5134 5f4b 3a0a  GGML_TYPE_Q4_K:.
+0008ee80: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0008ee90: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+0008eea0: 4d4c 5f41 5353 4552 5428 7374 6172 7420  ML_ASSERT(start 
+0008eeb0: 2520 514b 5f4b 203d 3d20 3029 3b0a 2020  % QK_K == 0);.  
+0008eec0: 2020 2020 2020 2020 2020 2020 2020 626c                bl
+0008eed0: 6f63 6b5f 7134 5f4b 202a 2062 6c6f 636b  ock_q4_K * block
+0008eee0: 203d 2028 626c 6f63 6b5f 7134 5f4b 2a29   = (block_q4_K*)
+0008eef0: 6473 7420 2b20 7374 6172 7420 2f20 514b  dst + start / QK
+0008ef00: 5f4b 3b0a 2020 2020 2020 2020 2020 2020  _K;.            
+0008ef10: 2020 2020 7265 7375 6c74 203d 2067 676d      result = ggm
+0008ef20: 6c5f 7175 616e 7469 7a65 5f71 345f 4b28  l_quantize_q4_K(
+0008ef30: 7372 6320 2b20 7374 6172 742c 2062 6c6f  src + start, blo
+0008ef40: 636b 2c20 6e2c 206e 2c20 6869 7374 293b  ck, n, n, hist);
+0008ef50: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0008ef60: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0008ef70: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
+0008ef80: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
+0008ef90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008efa0: 2047 474d 4c5f 4153 5345 5254 2873 7461   GGML_ASSERT(sta
+0008efb0: 7274 2025 2051 4b5f 4b20 3d3d 2030 293b  rt % QK_K == 0);
+0008efc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008efd0: 2062 6c6f 636b 5f71 355f 4b20 2a20 626c   block_q5_K * bl
+0008efe0: 6f63 6b20 3d20 2862 6c6f 636b 5f71 355f  ock = (block_q5_
+0008eff0: 4b2a 2964 7374 202b 2073 7461 7274 202f  K*)dst + start /
+0008f000: 2051 4b5f 4b3b 0a20 2020 2020 2020 2020   QK_K;.         
+0008f010: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+0008f020: 6767 6d6c 5f71 7561 6e74 697a 655f 7135  ggml_quantize_q5
+0008f030: 5f4b 2873 7263 202b 2073 7461 7274 2c20  _K(src + start, 
+0008f040: 626c 6f63 6b2c 206e 2c20 6e2c 2068 6973  block, n, n, his
+0008f050: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+0008f060: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0008f070: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0008f080: 5136 5f4b 3a0a 2020 2020 2020 2020 2020  Q6_K:.          
+0008f090: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0008f0a0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0008f0b0: 7374 6172 7420 2520 514b 5f4b 203d 3d20  start % QK_K == 
+0008f0c0: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
+0008f0d0: 2020 2020 626c 6f63 6b5f 7136 5f4b 202a      block_q6_K *
+0008f0e0: 2062 6c6f 636b 203d 2028 626c 6f63 6b5f   block = (block_
+0008f0f0: 7136 5f4b 2a29 6473 7420 2b20 7374 6172  q6_K*)dst + star
+0008f100: 7420 2f20 514b 5f4b 3b0a 2020 2020 2020  t / QK_K;.      
+0008f110: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+0008f120: 203d 2067 676d 6c5f 7175 616e 7469 7a65   = ggml_quantize
+0008f130: 5f71 365f 4b28 7372 6320 2b20 7374 6172  _q6_K(src + star
+0008f140: 742c 2062 6c6f 636b 2c20 6e2c 206e 2c20  t, block, n, n, 
+0008f150: 6869 7374 293b 0a20 2020 2020 2020 2020  hist);.         
+0008f160: 2020 207d 2062 7265 616b 3b0a 2365 6e64     } break;.#end
+0008f170: 6966 0a20 2020 2020 2020 2063 6173 6520  if.        case 
+0008f180: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+0008f190: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0008f1a0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0008f1b0: 2065 6c65 6d73 697a 6520 3d20 7369 7a65   elemsize = size
+0008f1c0: 6f66 2867 676d 6c5f 6670 3136 5f74 293b  of(ggml_fp16_t);
+0008f1d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008f1e0: 2067 676d 6c5f 6670 3332 5f74 6f5f 6670   ggml_fp32_to_fp
+0008f1f0: 3136 5f72 6f77 2873 7263 202b 2073 7461  16_row(src + sta
+0008f200: 7274 2c20 2867 676d 6c5f 6670 3136 5f74  rt, (ggml_fp16_t
+0008f210: 202a 2964 7374 202b 2073 7461 7274 2c20   *)dst + start, 
+0008f220: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
+0008f230: 2020 2020 7265 7375 6c74 203d 206e 202a      result = n *
+0008f240: 2065 6c65 6d73 697a 653b 0a20 2020 2020   elemsize;.     
+0008f250: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0008f260: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0008f270: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+0008f280: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0008f290: 2020 2020 2020 2020 2020 696e 7420 656c            int el
+0008f2a0: 656d 7369 7a65 203d 2073 697a 656f 6628  emsize = sizeof(
+0008f2b0: 666c 6f61 7429 3b0a 2020 2020 2020 2020  float);.        
+0008f2c0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+0008f2d0: 206e 202a 2065 6c65 6d73 697a 653b 0a20   n * elemsize;. 
+0008f2e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0008f2f0: 656d 6370 7928 2875 696e 7438 5f74 202a  emcpy((uint8_t *
+0008f300: 2964 7374 202b 2073 7461 7274 202a 2065  )dst + start * e
+0008f310: 6c65 6d73 697a 652c 2073 7263 202b 2073  lemsize, src + s
+0008f320: 7461 7274 2c20 7265 7375 6c74 293b 0a20  tart, result);. 
+0008f330: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0008f340: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
+0008f350: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
+0008f360: 2061 7373 6572 7428 6661 6c73 6529 3b0a   assert(false);.
+0008f370: 2020 2020 7d0a 2020 2020 7265 7475 726e      }.    return
+0008f380: 2072 6573 756c 743b 0a7d 0a0a 2f2f 2f2f   result;.}..////
+0008f390: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008f3a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008f3b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008f3c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008f3d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 0a0a 696e  ////////////..in
+0008f3e0: 7420 6767 6d6c 5f63 7075 5f68 6173 5f61  t ggml_cpu_has_a
+0008f3f0: 7678 2876 6f69 6429 207b 0a23 6966 2064  vx(void) {.#if d
+0008f400: 6566 696e 6564 285f 5f41 5658 5f5f 290a  efined(__AVX__).
+0008f410: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
+0008f420: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
+0008f430: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
+0008f440: 6767 6d6c 5f63 7075 5f68 6173 5f61 7678  ggml_cpu_has_avx
+0008f450: 3228 766f 6964 2920 7b0a 2369 6620 6465  2(void) {.#if de
+0008f460: 6669 6e65 6428 5f5f 4156 5832 5f5f 290a  fined(__AVX2__).
+0008f470: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
+0008f480: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
+0008f490: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
+0008f4a0: 6767 6d6c 5f63 7075 5f68 6173 5f61 7678  ggml_cpu_has_avx
+0008f4b0: 3531 3228 766f 6964 2920 7b0a 2369 6620  512(void) {.#if 
+0008f4c0: 6465 6669 6e65 6428 5f5f 4156 5835 3132  defined(__AVX512
+0008f4d0: 465f 5f29 0a20 2020 2072 6574 7572 6e20  F__).    return 
+0008f4e0: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
+0008f4f0: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
+0008f500: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
+0008f510: 735f 6176 7835 3132 5f76 626d 6928 766f  s_avx512_vbmi(vo
+0008f520: 6964 2920 7b0a 2369 6620 6465 6669 6e65  id) {.#if define
+0008f530: 6428 5f5f 4156 5835 3132 5642 4d49 5f5f  d(__AVX512VBMI__
+0008f540: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
+0008f550: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
+0008f560: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
+0008f570: 7420 6767 6d6c 5f63 7075 5f68 6173 5f61  t ggml_cpu_has_a
+0008f580: 7678 3531 325f 766e 6e69 2876 6f69 6429  vx512_vnni(void)
+0008f590: 207b 0a23 6966 2064 6566 696e 6564 285f   {.#if defined(_
+0008f5a0: 5f41 5658 3531 3256 4e4e 495f 5f29 0a20  _AVX512VNNI__). 
+0008f5b0: 2020 2072 6574 7572 6e20 313b 0a23 656c     return 1;.#el
+0008f5c0: 7365 0a20 2020 2072 6574 7572 6e20 303b  se.    return 0;
+0008f5d0: 0a23 656e 6469 660a 7d0a 0a69 6e74 2067  .#endif.}..int g
+0008f5e0: 676d 6c5f 6370 755f 6861 735f 666d 6128  gml_cpu_has_fma(
+0008f5f0: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
+0008f600: 6e65 6428 5f5f 464d 415f 5f29 0a20 2020  ned(__FMA__).   
+0008f610: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
+0008f620: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
+0008f630: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
+0008f640: 6c5f 6370 755f 6861 735f 6e65 6f6e 2876  l_cpu_has_neon(v
+0008f650: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
+0008f660: 6564 285f 5f41 524d 5f4e 454f 4e29 0a20  ed(__ARM_NEON). 
+0008f670: 2020 2072 6574 7572 6e20 313b 0a23 656c     return 1;.#el
+0008f680: 7365 0a20 2020 2072 6574 7572 6e20 303b  se.    return 0;
+0008f690: 0a23 656e 6469 660a 7d0a 0a69 6e74 2067  .#endif.}..int g
+0008f6a0: 676d 6c5f 6370 755f 6861 735f 6172 6d5f  gml_cpu_has_arm_
+0008f6b0: 666d 6128 766f 6964 2920 7b0a 2369 6620  fma(void) {.#if 
+0008f6c0: 6465 6669 6e65 6428 5f5f 4152 4d5f 4645  defined(__ARM_FE
+0008f6d0: 4154 5552 455f 464d 4129 0a20 2020 2072  ATURE_FMA).    r
+0008f6e0: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
+0008f6f0: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
+0008f700: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
+0008f710: 6370 755f 6861 735f 6631 3663 2876 6f69  cpu_has_f16c(voi
+0008f720: 6429 207b 0a23 6966 2064 6566 696e 6564  d) {.#if defined
+0008f730: 285f 5f46 3136 435f 5f29 0a20 2020 2072  (__F16C__).    r
+0008f740: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
+0008f750: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
+0008f760: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
+0008f770: 6370 755f 6861 735f 6670 3136 5f76 6128  cpu_has_fp16_va(
+0008f780: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
+0008f790: 6e65 6428 5f5f 4152 4d5f 4645 4154 5552  ned(__ARM_FEATUR
+0008f7a0: 455f 4650 3136 5f56 4543 544f 525f 4152  E_FP16_VECTOR_AR
+0008f7b0: 4954 484d 4554 4943 290a 2020 2020 7265  ITHMETIC).    re
+0008f7c0: 7475 726e 2031 3b0a 2365 6c73 650a 2020  turn 1;.#else.  
+0008f7d0: 2020 7265 7475 726e 2030 3b0a 2365 6e64    return 0;.#end
+0008f7e0: 6966 0a7d 0a0a 696e 7420 6767 6d6c 5f63  if.}..int ggml_c
+0008f7f0: 7075 5f68 6173 5f77 6173 6d5f 7369 6d64  pu_has_wasm_simd
+0008f800: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
+0008f810: 696e 6564 285f 5f77 6173 6d5f 7369 6d64  ined(__wasm_simd
+0008f820: 3132 385f 5f29 0a20 2020 2072 6574 7572  128__).    retur
+0008f830: 6e20 313b 0a23 656c 7365 0a20 2020 2072  n 1;.#else.    r
+0008f840: 6574 7572 6e20 303b 0a23 656e 6469 660a  eturn 0;.#endif.
+0008f850: 7d0a 0a69 6e74 2067 676d 6c5f 6370 755f  }..int ggml_cpu_
+0008f860: 6861 735f 626c 6173 2876 6f69 6429 207b  has_blas(void) {
+0008f870: 0a23 6966 2064 6566 696e 6564 2847 474d  .#if defined(GGM
+0008f880: 4c5f 5553 455f 4143 4345 4c45 5241 5445  L_USE_ACCELERATE
+0008f890: 2920 7c7c 2064 6566 696e 6564 2847 474d  ) || defined(GGM
+0008f8a0: 4c5f 5553 455f 4f50 454e 424c 4153 2920  L_USE_OPENBLAS) 
+0008f8b0: 7c7c 2064 6566 696e 6564 2847 474d 4c5f  || defined(GGML_
+0008f8c0: 5553 455f 4355 424c 4153 2920 7c7c 2064  USE_CUBLAS) || d
+0008f8d0: 6566 696e 6564 2847 474d 4c5f 5553 455f  efined(GGML_USE_
+0008f8e0: 434c 424c 4153 5429 0a20 2020 2072 6574  CLBLAST).    ret
+0008f8f0: 7572 6e20 313b 0a23 656c 7365 0a20 2020  urn 1;.#else.   
+0008f900: 2072 6574 7572 6e20 303b 0a23 656e 6469   return 0;.#endi
+0008f910: 660a 7d0a 0a69 6e74 2067 676d 6c5f 6370  f.}..int ggml_cp
+0008f920: 755f 6861 735f 6375 626c 6173 2876 6f69  u_has_cublas(voi
+0008f930: 6429 207b 0a23 6966 2064 6566 696e 6564  d) {.#if defined
+0008f940: 2847 474d 4c5f 5553 455f 4355 424c 4153  (GGML_USE_CUBLAS
+0008f950: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
+0008f960: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
+0008f970: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
+0008f980: 7420 6767 6d6c 5f63 7075 5f68 6173 5f63  t ggml_cpu_has_c
+0008f990: 6c62 6c61 7374 2876 6f69 6429 207b 0a23  lblast(void) {.#
+0008f9a0: 6966 2064 6566 696e 6564 2847 474d 4c5f  if defined(GGML_
+0008f9b0: 5553 455f 434c 424c 4153 5429 0a20 2020  USE_CLBLAST).   
+0008f9c0: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
+0008f9d0: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
+0008f9e0: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
+0008f9f0: 6c5f 6370 755f 6861 735f 6770 7562 6c61  l_cpu_has_gpubla
+0008fa00: 7328 766f 6964 2920 7b0a 2020 2020 7265  s(void) {.    re
+0008fa10: 7475 726e 2067 676d 6c5f 6370 755f 6861  turn ggml_cpu_ha
+0008fa20: 735f 6375 626c 6173 2829 207c 7c20 6767  s_cublas() || gg
+0008fa30: 6d6c 5f63 7075 5f68 6173 5f63 6c62 6c61  ml_cpu_has_clbla
+0008fa40: 7374 2829 3b0a 7d0a 0a69 6e74 2067 676d  st();.}..int ggm
+0008fa50: 6c5f 6370 755f 6861 735f 7373 6533 2876  l_cpu_has_sse3(v
+0008fa60: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
+0008fa70: 6564 285f 5f53 5345 335f 5f29 0a20 2020  ed(__SSE3__).   
+0008fa80: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
+0008fa90: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
+0008faa0: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
+0008fab0: 6c5f 6370 755f 6861 735f 7673 7828 766f  l_cpu_has_vsx(vo
+0008fac0: 6964 2920 7b0a 2369 6620 6465 6669 6e65  id) {.#if define
+0008fad0: 6428 5f5f 504f 5745 5239 5f56 4543 544f  d(__POWER9_VECTO
+0008fae0: 525f 5f29 0a20 2020 2072 6574 7572 6e20  R__).    return 
+0008faf0: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
+0008fb00: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
+0008fb10: 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .///////////////
+0008fb20: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008fb30: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008fb40: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008fb50: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008fb60: 2f0a                                     /.
```

### Comparing `ctransformers-langdash-0.2.11/models/ggml/ggml.h` & `ctransformers-langdash-0.2.9/models/ggml/ggml.h`

 * *Files 0% similar despite different names*

```diff
@@ -293,15 +293,14 @@
         GGML_OP_SQRT,
         GGML_OP_LOG,
         GGML_OP_SUM,
         GGML_OP_SUM_ROWS,
         GGML_OP_MEAN,
         GGML_OP_REPEAT,
         GGML_OP_REPEAT_BACK,
-        GGML_OP_REPEAT2,
         GGML_OP_ABS,
         GGML_OP_SGN,
         GGML_OP_NEG,
         GGML_OP_STEP,
         GGML_OP_RELU,
         GGML_OP_GELU,
         GGML_OP_SILU,
@@ -661,16 +660,14 @@
             struct ggml_tensor  * b);
 
     GGML_API struct ggml_tensor * ggml_repeat_back(
             struct ggml_context * ctx,
             struct ggml_tensor  * a,
             struct ggml_tensor  * b);
 
-    #include "ggml/ggml-ggllm.h"
-
     GGML_API struct ggml_tensor * ggml_abs(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
     GGML_API struct ggml_tensor * ggml_sgn(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
```

### Comparing `ctransformers-langdash-0.2.11/models/ggml/k_quants.c` & `ctransformers-langdash-0.2.9/models/ggml/k_quants.c`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/ggml/k_quants.h` & `ctransformers-langdash-0.2.9/models/ggml/k_quants.h`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/ggml/libfalcon.cpp` & `ctransformers-langdash-0.2.9/models/ggml/llama.cpp`

 * *Files 8% similar despite different names*

```diff
@@ -1,34 +1,32 @@
 // Defines fileno on msys:
-// inference&model based on the ggml falcon example PR from
-// https://github.com/KerfuffleV2/ggml-falcon
 #ifndef _GNU_SOURCE
 #define _GNU_SOURCE
 #include <cstddef>
 #include <cstdint>
 #include <cstdio>
 #endif
 
 #include "ggml.h"
-#include "libfalcon.h"
 #include "llama-util.h"
+#include "llama.h"
 #ifdef GGML_USE_CUBLAS
-#include <cuda_runtime.h>
-
 #include "ggml-cuda.h"
 #elif defined(GGML_USE_CLBLAST)
 #include "ggml-opencl.h"
 #endif
 
 #ifdef GGML_USE_METAL
 #include "ggml-metal.h"
 #endif
+#ifdef GGML_USE_K_QUANTS
 #ifndef QK_K
 #define QK_K 256
 #endif
+#endif
 
 #include <algorithm>
 #include <array>
 #include <atomic>
 #include <cassert>
 #include <cinttypes>
 #include <climits>
@@ -43,176 +41,203 @@
 #include <queue>
 #include <random>
 #include <sstream>
 #include <thread>
 #include <unordered_map>
 
 #if defined(_MSC_VER)
-// disable "possible loss of data"
-#pragma warning(disable : 4244 4267)
+#pragma warning(disable : 4244 4267)  // possible loss of data
 #endif
 
 #define LLAMA_USE_SCRATCH
 #define LLAMA_MAX_SCRATCH_BUFFERS 16
 
-// available falcon models
-enum falcon_e_model {
-  FALCON_UNKNOWN,
-  FALCON_7B,
-  FALCON_40B,
+// available llama models
+enum e_model {
+  MODEL_UNKNOWN,
+  MODEL_3B,
+  MODEL_7B,
+  MODEL_13B,
+  MODEL_30B,
+  MODEL_65B,
 };
 
+static const size_t MB = 1024 * 1024;
+
 // computed for n_ctx == 2048
 // TODO: dynamically determine these sizes
 //       needs modifications in ggml
 
 typedef void (*offload_func_t)(struct ggml_tensor *tensor);
 
-static const std::map<falcon_e_model, size_t> &FALCON_MEM_REQ_SCRATCH0() {
-  static std::map<falcon_e_model, size_t> k_sizes = {
-      {FALCON_7B, 512ull * MB},
-      {FALCON_40B, 1024ull * MB},
+void llama_nop(struct ggml_tensor *tensor) {  // don't offload by default
+  (void)tensor;
+}
+
+static const std::map<e_model, size_t> &MEM_REQ_SCRATCH0() {
+  static std::map<e_model, size_t> k_sizes = {
+      {MODEL_3B, 256ull * MB},   {MODEL_7B, 512ull * MB},
+      {MODEL_13B, 512ull * MB},  {MODEL_30B, 512ull * MB},
+      {MODEL_65B, 1024ull * MB},
+  };
+  return k_sizes;
+}
+
+static const std::map<e_model, size_t> &MEM_REQ_SCRATCH1() {
+  static std::map<e_model, size_t> k_sizes = {
+      {MODEL_3B, 256ull * MB},   {MODEL_7B, 512ull * MB},
+      {MODEL_13B, 512ull * MB},  {MODEL_30B, 512ull * MB},
+      {MODEL_65B, 1024ull * MB},
   };
   return k_sizes;
 }
 
-static const std::map<falcon_e_model, size_t> &FALCON_MEM_REQ_SCRATCH1() {
-  static std::map<falcon_e_model, size_t> k_sizes = {
-      {FALCON_7B, 512ull * MB},
-      {FALCON_40B, 1024ull * MB},
+// 2*n_embd*n_ctx*n_layer*sizeof(float16)
+static const std::map<e_model, size_t> &MEM_REQ_KV_SELF() {
+  static std::map<e_model, size_t> k_sizes = {
+      {MODEL_3B, 682ull * MB},   {MODEL_7B, 1026ull * MB},
+      {MODEL_13B, 1608ull * MB}, {MODEL_30B, 3124ull * MB},
+      {MODEL_65B, 5120ull * MB},
   };
   return k_sizes;
 }
 
 // this is mostly needed for temporary mul_mat buffers to dequantize the data
 // not actually needed if BLAS is disabled
-static const std::map<falcon_e_model, size_t> &FALCON_MEM_REQ_EVAL() {
-  static std::map<falcon_e_model, size_t> k_sizes = {
-      {FALCON_7B, 768ull * MB},
-      {FALCON_40B, 1536ull * MB},
+static const std::map<e_model, size_t> &MEM_REQ_EVAL() {
+  static std::map<e_model, size_t> k_sizes = {
+      {MODEL_3B, 512ull * MB},   {MODEL_7B, 768ull * MB},
+      {MODEL_13B, 1024ull * MB}, {MODEL_30B, 1280ull * MB},
+      {MODEL_65B, 1536ull * MB},
   };
   return k_sizes;
 }
 
-// default hparams (Falcon 7B)
-struct falcon_hparams {
-  int32_t n_vocab = 65024;
-  int32_t n_ctx = 2048;
-  int32_t n_embd = 4544;
-  int32_t n_head = 71;
-  int32_t n_head_kv = 1;
-  int32_t n_layer = 32;
-  int32_t n_falcon_type = 7;  // 7 for Falcon-7B, 40 for Falcon-40B
+// default hparams (LLaMA 7B)
+struct llama_hparams {
+  uint32_t n_vocab = 32000;
+  uint32_t n_ctx = 512;  // this is provided as user input?
+  uint32_t n_embd = 4096;
+  uint32_t n_mult = 256;
+  uint32_t n_head = 32;
+  uint32_t n_layer = 32;
+  uint32_t n_rot = 64;
   enum llama_ftype ftype = LLAMA_FTYPE_MOSTLY_F16;
 
-  bool operator!=(const falcon_hparams &other) const {
-    return static_cast<bool>(memcmp(this, &other, sizeof(falcon_hparams)));
+  bool operator!=(const llama_hparams &other) const {
+    return static_cast<bool>(memcmp(this, &other, sizeof(llama_hparams)));
   }
 };
 
-static size_t FALCON_MEM_REQ_KV_SELF(const falcon_hparams &hparams,
-                                     ggml_type wtype, int32_t n_ctx) {
-  const int n_head_kv = hparams.n_head_kv;
-  const int head_dim = hparams.n_embd / hparams.n_head;
-  const int n_layer = hparams.n_layer;
-
-  const int64_t ne = n_head_kv * head_dim * n_layer * n_ctx;
-
-  return 2u * (ggml_tensor_overhead() + ne * ggml_type_size(wtype));
-}
-
-struct falcon_layer {
+struct llama_layer {
   // normalization
-  struct ggml_tensor *input_layernorm;
-  struct ggml_tensor *input_layernorm_b;
-  struct ggml_tensor *attention_norm;    // Falcon-40B only
-  struct ggml_tensor *attention_norm_b;  // Falcon-40B only
+  struct ggml_tensor *attention_norm;
 
   // attention
-  struct ggml_tensor *query_key_value;
+  struct ggml_tensor *wq;
+  struct ggml_tensor *wk;
+  struct ggml_tensor *wv;
   struct ggml_tensor *wo;
 
+  // normalization
+  struct ggml_tensor *ffn_norm;
+
   // ff
-  struct ggml_tensor *ffn_up;
-  struct ggml_tensor *ffn_down;
+  struct ggml_tensor *w1;
+  struct ggml_tensor *w2;
+  struct ggml_tensor *w3;
 };
 
-struct falcon_kv_cache {
+struct llama_kv_cache {
   struct ggml_tensor *k;
   struct ggml_tensor *v;
 
   struct ggml_context *ctx = NULL;
 
   llama_ctx_buffer buf;
 
   int n;  // number of tokens currently in the cache
 
-  ~falcon_kv_cache() {
+  ~llama_kv_cache() {
     if (ctx) {
       ggml_free(ctx);
     }
+
+#ifdef GGML_USE_CUBLAS
+    ggml_cuda_free_data(k);
+    ggml_cuda_free_data(v);
+#endif  // GGML_USE_CUBLAS
   }
 };
 
-struct falcon_model {
-  falcon_e_model type = FALCON_UNKNOWN;
+struct llama_model {
+  e_model type = MODEL_UNKNOWN;
 
-  falcon_hparams hparams;
+  llama_hparams hparams;
 
   struct ggml_tensor *tok_embeddings;
-  struct ggml_tensor *output_norm;
-  struct ggml_tensor *output_norm_b;
-  struct ggml_tensor *lm_head;
-  // struct ggml_tensor* output;
 
-  std::vector<falcon_layer> layers;
+  struct ggml_tensor *norm;
+  struct ggml_tensor *output;
 
+  std::vector<llama_layer> layers;
   int n_gpu_layers;
-  int i_gpu_start;
-  int i_gpu_last;
 
   // context
   struct ggml_context *ctx = NULL;
-  std::map<std::string, struct ggml_tensor *> tensors;
 
   // key + value cache for the self attention
   // TODO: move to llama_state
-  struct falcon_kv_cache kv_self;
+  struct llama_kv_cache kv_self;
 
   // the model memory buffer
   llama_ctx_buffer buf;
 
   // model memory mapped file
   std::unique_ptr<llama_mmap> mapping;
 
   // objects representing data potentially being locked in memory
   llama_mlock mlock_buf;
   llama_mlock mlock_mmap;
 
   // for quantize-stats only
   std::vector<std::pair<std::string, struct ggml_tensor *>> tensors_by_name;
 
-  ~falcon_model() {
+  ~llama_model() {
     if (ctx) {
       ggml_free(ctx);
     }
 
 #ifdef GGML_USE_CUBLAS
     for (size_t i = 0; i < tensors_by_name.size(); ++i) {
       ggml_cuda_free_data(tensors_by_name[i].second);
     }
+    ggml_cuda_free_scratch();
 #elif defined(GGML_USE_CLBLAST)
     for (size_t i = 0; i < tensors_by_name.size(); ++i) {
       ggml_cl_free_data(tensors_by_name[i].second);
     }
 #endif
   }
 };
 
-struct falcon_context {
+struct llama_vocab {
+  using id = int32_t;
+  using token = std::string;
+
+  struct token_score {
+    token tok;
+    float score;
+  };
+
+  std::unordered_map<token, id> token_to_id;
+  std::vector<token_score> id_to_token;
+};
+
+struct llama_context {
   std::mt19937 rng;
 
   int64_t t_load_us = 0;
   int64_t t_start_us = 0;
   bool has_evaluated_once = false;
 
   int64_t t_sample_us = 0;
@@ -220,15 +245,15 @@
   int64_t t_p_eval_us = 0;
 
   int32_t n_sample = 0;  // number of tokens sampled
   int32_t n_eval = 0;    // number of eval calls
   int32_t n_p_eval =
       0;  // number of tokens in eval calls for the prompt (with batch size > 1)
 
-  falcon_model model;
+  llama_model model;
   llama_vocab vocab;
 
   size_t mem_per_token = 0;
 
   // decode output (2-dimensional array: [n_tokens][n_vocab])
   std::vector<float> logits;
   bool logits_all = false;
@@ -284,29 +309,163 @@
 #else
     (void)i;
     return 0;
 #endif
   }
 };
 
-struct falcon_file_loader {
+template <typename T>
+static T checked_mul(T a, T b) {
+  T ret = a * b;
+  if (a != 0 && ret / a != b) {
+    throw std::runtime_error(format("overflow multiplying %llu * %llu",
+                                    (unsigned long long)a,
+                                    (unsigned long long)b));
+  }
+  return ret;
+}
+
+static size_t checked_div(size_t a, size_t b) {
+  if (b == 0 || a % b != 0) {
+    throw std::runtime_error(format("error dividing %zu / %zu", a, b));
+  }
+  return a / b;
+}
+
+static std::string llama_format_tensor_shape(const std::vector<uint32_t> &ne) {
+  char buf[256];
+  snprintf(buf, sizeof(buf), "%5u", ne.at(0));
+  for (size_t i = 1; i < ne.size(); i++) {
+    snprintf(buf + strlen(buf), sizeof(buf) - strlen(buf), " x %5u", ne.at(i));
+  }
+  return buf;
+}
+
+static size_t llama_calc_tensor_size(const std::vector<uint32_t> &ne,
+                                     enum ggml_type type) {
+  size_t size = ggml_type_size(type);
+  for (uint32_t dim : ne) {
+    size = checked_mul<size_t>(size, dim);
+  }
+  return size / ggml_blck_size(type);
+}
+
+struct llama_load_tensor_shard {
+  std::vector<uint32_t> ne;
+  size_t size;
+  enum ggml_type type;
+  size_t file_idx;
+  size_t file_off;
+
+  void calc_size() { size = llama_calc_tensor_size(ne, type); }
+};
+
+enum llama_split_type { SPLIT_NONE, SPLIT_BY_COLUMNS, SPLIT_BY_ROWS };
+
+struct llama_load_tensor {
+  std::vector<llama_load_tensor_shard> shards;
+
+  std::string name;
+  enum ggml_type type = GGML_TYPE_F32;
+  llama_split_type split_type = SPLIT_NONE;
+  std::vector<uint32_t> ne;
+  size_t size;
+  struct ggml_tensor *ggml_tensor = NULL;
+  uint8_t *data;
+
+  llama_load_tensor(const std::string &name) : name(name) {}
+
+  void calc_all() {
+    calc_type();
+    calc_split_type();
+    calc_ne();
+    calc_size();
+  }
+
+  void calc_type() {
+    const auto &first_shard = shards.at(0);
+    for (const auto &shard : shards) {
+      if (shard.type != first_shard.type) {
+        throw std::runtime_error(
+            format("inconsistent tensor shard type in '%s'", name.c_str()));
+      }
+    }
+    type = first_shard.type;
+  }
+
+  void calc_split_type() {
+    if (shards.at(0).ne.size() ==
+            1 ||               // 1D tensors are just duplicated in every file
+        shards.size() == 1) {  // only one file?
+      split_type = SPLIT_NONE;
+    } else if (name.find("tok_embeddings.") == 0 ||
+               name.find(".attention.wo.weight") != std::string::npos ||
+               name.find(".feed_forward.w2.weight") != std::string::npos) {
+      split_type = SPLIT_BY_COLUMNS;
+    } else {
+      split_type = SPLIT_BY_ROWS;
+    }
+  }
+
+  void calc_ne() {
+    const auto &first_shard = shards.at(0);
+    for (const auto &shard : shards) {
+      if (shard.ne != first_shard.ne) {
+        throw std::runtime_error(format(
+            "inconsistent tensor shard shape in '%s': first was %s, other was "
+            "%s",
+            name.c_str(), llama_format_tensor_shape(first_shard.ne).c_str(),
+            llama_format_tensor_shape(shard.ne).c_str()));
+      }
+    }
+    ne = first_shard.ne;
+    LLAMA_ASSERT(shards.size() <= UINT32_MAX);
+    uint32_t n_shards = (uint32_t)shards.size();
+    switch (split_type) {
+      case SPLIT_NONE:
+        ne = first_shard.ne;
+        break;
+      case SPLIT_BY_COLUMNS:
+        ne = {checked_mul<uint32_t>(first_shard.ne[0], n_shards),
+              first_shard.ne[1]};
+        break;
+      case SPLIT_BY_ROWS:
+        ne = {first_shard.ne[0],
+              checked_mul<uint32_t>(first_shard.ne[1], n_shards)};
+        break;
+    }
+  }
+
+  void calc_size() { size = llama_calc_tensor_size(ne, type); }
+};
+
+struct llama_load_tensors_map {
+  // tensors is kept in a separate vector to preserve file order
+  std::vector<llama_load_tensor> tensors;
+  std::unordered_map<std::string, size_t> name_to_idx;
+};
+
+enum llama_file_version {
+  LLAMA_FILE_VERSION_GGML,
+  LLAMA_FILE_VERSION_GGMF_V1,  // added version field and scores in vocab
+  LLAMA_FILE_VERSION_GGJT_V1,  // added padding
+  LLAMA_FILE_VERSION_GGJT_V2,  // changed quantization format
+  LLAMA_FILE_VERSION_GGJT_V3,  // changed Q4 and Q8 quantization format
+};
+
+struct llama_file_loader {
   llama_file file;
   llama_file_version file_version;
-  falcon_hparams hparams;
+  llama_hparams hparams;
   llama_vocab vocab;
 
-  falcon_file_loader(const char *fname, size_t file_idx,
-                     llama_load_tensors_map &tensors_map)
+  llama_file_loader(const char *fname, size_t file_idx,
+                    llama_load_tensors_map &tensors_map)
       : file(fname, "rb") {
     read_magic();
-    if (file_version <= 1)
-      fprintf(stderr,
-              "falcon.cpp: file version %d - Use falcon_quantize to update "
-              "version and improve performance\n",
-              file_version);
     read_hparams();
     read_vocab();
     read_tensor_metadata(file_idx, tensors_map);
   }
   void read_magic() {
     uint32_t magic = file.read_u32();
 
@@ -343,38 +502,28 @@
         format("unknown (magic, version) combination: %08x, %08x; is this "
                "really a GGML file?",
                magic, version));
   }
   void read_hparams() {
     hparams.n_vocab = file.read_u32();
     hparams.n_embd = file.read_u32();
+    hparams.n_mult = file.read_u32();
     hparams.n_head = file.read_u32();
-    hparams.n_head_kv = file.read_u32();
     hparams.n_layer = file.read_u32();
-    hparams.n_falcon_type = file.read_u32();
-    if (file_version == LLAMA_FILE_VERSION_GGML) {
-      int32_t ftype = file.read_u32();
-      const int32_t qntvr = hparams.ftype / GGML_QNT_VERSION_FACTOR;
-      hparams.ftype =
-          (enum llama_ftype)(hparams.ftype % GGML_QNT_VERSION_FACTOR);
-    } else {
-      hparams.ftype = (enum llama_ftype)file.read_u32();
-    }
-
-    // hparams.ftype %= GGML_QNT_VERSION_FACTOR;
+    hparams.n_rot = file.read_u32();
+    hparams.ftype = (enum llama_ftype)file.read_u32();
   }
   void read_vocab() {
     vocab.id_to_token.resize(hparams.n_vocab);
 
-    for (uint32_t i = 0; i < (uint32_t)hparams.n_vocab; i++) {
+    for (uint32_t i = 0; i < hparams.n_vocab; i++) {
       uint32_t len = file.read_u32();
       std::string word = file.read_string(len);
 
-      float score = 0.0f;  // flacon does not have scores in vocab, scores are a
-                           // sentencepiece addition
+      float score = 0.0f;
       if (file_version >= LLAMA_FILE_VERSION_GGMF_V1) {
         file.read_raw(&score, sizeof(score));
       }
 
       vocab.token_to_id[word] = i;
 
       auto &tok_score = vocab.id_to_token[i];
@@ -390,15 +539,15 @@
       uint32_t name_len = file.read_u32();
       shard.type = (enum ggml_type)file.read_u32();
       shard.ne.resize(n_dims);
       file.read_raw(shard.ne.data(), sizeof(shard.ne[0]) * n_dims);
       std::string name = file.read_string(name_len);
       if (n_dims < 1 || n_dims > 2) {
         throw std::runtime_error(
-            format("falcon.cpp: tensor '%s' should not be %u-dimensional",
+            format("llama.cpp: tensor '%s' should not be %u-dimensional",
                    name.c_str(), n_dims));
       }
       switch (shard.type) {
         case GGML_TYPE_F32:
         case GGML_TYPE_F16:
         case GGML_TYPE_Q4_0:
         case GGML_TYPE_Q4_1:
@@ -437,43 +586,43 @@
         tensors_map.name_to_idx.emplace(name, idx);
       }
       tensors_map.tensors.at(idx).shards.push_back(shard);
     }
   }
 };
 
-struct falcon_file_saver {
+struct llama_file_saver {
   llama_file file;
-  falcon_file_loader *any_file_loader;
-  falcon_file_saver(const char *fname, falcon_file_loader *any_file_loader,
-                    enum llama_ftype new_ftype)
+  llama_file_loader *any_file_loader;
+  llama_file_saver(const char *fname, llama_file_loader *any_file_loader,
+                   enum llama_ftype new_ftype)
       : file(fname, "wb"), any_file_loader(any_file_loader) {
-    fprintf(stderr, "falcon.cpp: saving model to %s\n", fname);
+    fprintf(stderr, "llama.cpp: saving model to %s\n", fname);
     write_magic();
     write_hparams(new_ftype);
     write_vocab();
   }
   void write_magic() {
     file.write_u32(LLAMA_FILE_MAGIC);    // magic
     file.write_u32(LLAMA_FILE_VERSION);  // version
   }
   void write_hparams(enum llama_ftype new_ftype) {
-    const falcon_hparams &hparams = any_file_loader->hparams;
+    const llama_hparams &hparams = any_file_loader->hparams;
     file.write_u32(hparams.n_vocab);
     file.write_u32(hparams.n_embd);
+    file.write_u32(hparams.n_mult);
     file.write_u32(hparams.n_head);
-    file.write_u32(hparams.n_head_kv);
     file.write_u32(hparams.n_layer);
-    file.write_u32(hparams.n_falcon_type);
+    file.write_u32(hparams.n_rot);
     file.write_u32(new_ftype);
   }
   void write_vocab() {
     if (any_file_loader->file_version == LLAMA_FILE_VERSION_GGML) {
       fprintf(stderr,
-              "falcon.cpp: WARNING: input is an old file that doesn't have "
+              "llama.cpp: WARNING: input is an old file that doesn't have "
               "scores; will add dummy scores\n");
     }
     uint32_t n_vocab = any_file_loader->hparams.n_vocab;
     for (uint32_t i = 0; i < n_vocab; i++) {
       const auto &token_score = any_file_loader->vocab.id_to_token.at(i);
       file.write_u32((uint32_t)token_score.tok.size());
       file.write_raw(token_score.tok.data(), token_score.tok.size());
@@ -506,43 +655,43 @@
     file.write_raw(tensor.name.data(), tensor.name.size());
     file.seek(-static_cast<ptrdiff_t>(file.tell()) & 31, SEEK_CUR);
     LLAMA_ASSERT(new_size == llama_calc_tensor_size(tensor.ne, new_type));
     file.write_raw(new_data, new_size);
   }
 };
 
-struct falcon_model_loader {
-  std::vector<std::unique_ptr<falcon_file_loader>> file_loaders;
+struct llama_model_loader {
+  std::vector<std::unique_ptr<llama_file_loader>> file_loaders;
   llama_load_tensors_map tensors_map;
   bool use_mmap;
   size_t num_ggml_tensors_created = 0;
   struct ggml_context *ggml_ctx = NULL;
   std::unique_ptr<llama_mmap> mapping;
 
-  falcon_model_loader(const std::string &fname_base, bool use_mmap,
-                      bool vocab_only) {
+  llama_model_loader(const std::string &fname_base, bool use_mmap,
+                     bool vocab_only) {
     auto *first_file =
-        new falcon_file_loader(fname_base.c_str(), 0, tensors_map);
+        new llama_file_loader(fname_base.c_str(), 0, tensors_map);
     file_loaders.emplace_back(first_file);
     uint32_t n_parts = vocab_only ? 1 : guess_n_parts();
     for (uint32_t i = 1; i < n_parts; i++) {
       std::string fname = fname_base + "." + std::to_string(i);
-      auto *ith_file = new falcon_file_loader(fname.c_str(), i, tensors_map);
+      auto *ith_file = new llama_file_loader(fname.c_str(), i, tensors_map);
       file_loaders.emplace_back(ith_file);
       if (ith_file->hparams != first_file->hparams) {
         throw std::runtime_error(
-            format("falcon.cpp: hparams inconsistent between files"));
+            format("llama.cpp: hparams inconsistent between files"));
       }
     }
     if (!llama_mmap::SUPPORTED) {
       use_mmap = false;
     }
     if (use_mmap && alignment_prevents_mmap()) {
       fprintf(stderr,
-              "falcon.cpp: can't use mmap because tensors are not aligned; "
+              "llama.cpp: can't use mmap because tensors are not aligned; "
               "convert to new format to avoid this\n");
       use_mmap = false;
     }
     this->use_mmap = use_mmap;
     for (llama_load_tensor &lt : tensors_map.tensors) {
       lt.calc_all();
     }
@@ -556,43 +705,42 @@
         }
       }
     }
     return false;
   }
 
   uint32_t guess_n_parts() const {
-    auto it =
-        tensors_map.name_to_idx.find("transformer.word_embeddings.weight");
+    auto it = tensors_map.name_to_idx.find("tok_embeddings.weight");
     if (it == tensors_map.name_to_idx.end()) {
       throw std::runtime_error(std::string("missing tok_embeddings.weight"));
     }
     const llama_load_tensor &lt = tensors_map.tensors.at(it->second);
     return file_loaders.at(0)->hparams.n_embd / lt.shards.at(0).ne.at(0);
   }
 
   void calc_sizes(size_t *ctx_size_p, size_t *mmapped_size_p) const {
     *ctx_size_p = *mmapped_size_p = 0;
     for (const llama_load_tensor &lt : tensors_map.tensors) {
-      *ctx_size_p += ggml_tensor_overhead();
+      *ctx_size_p += sizeof(struct ggml_tensor) + GGML_OBJECT_SIZE;
       *(use_mmap ? mmapped_size_p : ctx_size_p) += lt.size;
     }
   }
 
   struct ggml_tensor *get_tensor(const std::string &name,
                                  const std::vector<uint32_t> &ne,
                                  ggml_backend backend) {
     auto it = tensors_map.name_to_idx.find(name);
     if (it == tensors_map.name_to_idx.end()) {
       throw std::runtime_error(std::runtime_error(format(
-          "falcon.cpp: tensor '%s' is missing from model", name.c_str())));
+          "llama.cpp: tensor '%s' is missing from model", name.c_str())));
     }
     llama_load_tensor &lt = tensors_map.tensors.at(it->second);
     if (lt.ne != ne) {
       throw std::runtime_error(
-          format("falcon.cpp: tensor '%s' has wrong shape; expected %s, got %s",
+          format("llama.cpp: tensor '%s' has wrong shape; expected %s, got %s",
                  name.c_str(), llama_format_tensor_shape(ne).c_str(),
                  llama_format_tensor_shape(lt.ne).c_str()));
     }
 
     return get_tensor_for(lt, backend);
   }
 
@@ -621,15 +769,15 @@
     num_ggml_tensors_created++;
     return tensor;
   }
 
   void done_getting_tensors() const {
     if (num_ggml_tensors_created != tensors_map.tensors.size()) {
       throw std::runtime_error(
-          std::string("falcon.cpp: file contained more tensors than expected"));
+          std::string("llama.cpp: file contained more tensors than expected"));
     }
   }
 
   void load_all_data(llama_progress_callback progress_callback,
                      void *progress_callback_user_data, llama_mlock *lmlock) {
     size_t data_size = 0;
     size_t prefetch_size = 0;
@@ -755,23 +903,25 @@
   }
 };
 
 //
 // kv cache
 //
 
-static bool kv_cache_init(const struct falcon_hparams &hparams,
-                          struct falcon_kv_cache &cache, ggml_type wtype,
+static bool kv_cache_init(const struct llama_hparams &hparams,
+                          struct llama_kv_cache &cache, ggml_type wtype,
                           int n_ctx, int n_gpu_layers) {
-  const int64_t n_layer = hparams.n_layer;
-  const int64_t head_dim = hparams.n_embd / hparams.n_head;
-  const int64_t n_elements =
-      hparams.n_layer * n_ctx * head_dim * hparams.n_head_kv;
+  const int n_embd = hparams.n_embd;
+  const int n_layer = hparams.n_layer;
+
+  const int64_t n_mem = n_layer * n_ctx;
+  const int64_t n_elements = n_embd * n_mem;
 
-  cache.buf.resize(FALCON_MEM_REQ_KV_SELF(hparams, wtype, n_ctx));
+  cache.buf.resize(2u * n_elements * ggml_type_size(wtype) + 2u * MB);
+  cache.n = 0;
 
   struct ggml_init_params params;
   params.mem_size = cache.buf.size;
   params.mem_buffer = cache.buf.addr;
   params.no_alloc = false;
 
   cache.ctx = ggml_init(params);
@@ -785,142 +935,203 @@
   cache.v = ggml_new_tensor_1d(cache.ctx, wtype, n_elements);
   ggml_set_name(cache.k, "cache_k");
   ggml_set_name(cache.v, "cache_v");
 
   (void)n_gpu_layers;
 #ifdef GGML_USE_CUBLAS
   if (n_gpu_layers > n_layer + 1) {
-    ggml_cuda_assign_buffers_no_scratch(cache.k);
     ggml_cuda_assign_buffers_no_scratch(cache.v);
   }
+  if (n_gpu_layers > n_layer + 2) {
+    ggml_cuda_assign_buffers_no_scratch(cache.k);
+  }
 #endif  // GGML_USE_CUBLAS
 
   return true;
 }
 
-struct falcon_context_params falcon_context_default_params() {
-  struct falcon_context_params result = {
+struct llama_context_params llama_context_default_params() {
+  struct llama_context_params result = {
       /*.n_ctx                       =*/512,
       /*.n_batch                     =*/512,
-      /*.n_gpu_layers                  =*/0,
-      /*.i_gpu_start                 =*/-1,
-      /*.i_gpu_last                   =*/-1,
+      /*.gpu_layers                  =*/0,
       /*.main_gpu                    =*/0,
       /*.tensor_split                =*/{0},
+      /*.low_vram                    =*/false,
       /*.seed                        =*/-1,
-      /*.f16_kv                      =*/false,
+      /*.f16_kv                      =*/true,
       /*.logits_all                  =*/false,
       /*.vocab_only                  =*/false,
       /*.use_mmap                    =*/true,
       /*.use_mlock                   =*/false,
       /*.embedding                   =*/false,
       /*.progress_callback           =*/nullptr,
       /*.progress_callback_user_data =*/nullptr,
   };
 
   return result;
 }
 
-struct falcon_model_quantize_params falcon_model_quantize_default_params() {
-  struct falcon_model_quantize_params result = {
+struct llama_model_quantize_params llama_model_quantize_default_params() {
+  struct llama_model_quantize_params result = {
       /*.nthread                     =*/0,
       /*.ftype                       =*/LLAMA_FTYPE_MOSTLY_Q5_1,
       /*.allow_requantize            =*/false,
       /*.quantize_output_tensor      =*/true,
   };
 
   return result;
 }
 
-//
-// model loading
-//
+bool llama_mmap_supported() { return llama_mmap::SUPPORTED; }
 
-static const char *falcon_model_type_name(falcon_e_model type) {
-  switch (type) {
-    case FALCON_7B:
-      return "7B";
-    case FALCON_40B:
-      return "40B";
-    default:
-      LLAMA_ASSERT(false);
+bool llama_mlock_supported() { return llama_mlock::SUPPORTED; }
+
+void llama_init_backend() {
+  ggml_time_init();
+
+  // needed to initialize f16 tables
+  {
+    struct ggml_init_params params = {0, NULL, false};
+    struct ggml_context *ctx = ggml_init(params);
+    ggml_free(ctx);
   }
 }
 
-// dynamically gets all tensors from a layer
-std::vector<ggml_tensor *> get_tensors_from_layer(falcon_layer &layer) {
-  std::vector<ggml_tensor *> tensors;
-  ggml_tensor **tensor_ptr = reinterpret_cast<ggml_tensor **>(
-      &layer);  // Cast to the pointer to ggml_tensor pointer
+int64_t llama_time_us() { return ggml_time_us(); }
+
+//
+// model loading
+//
 
-  // Iterate through the members and store their addresses in the vector
-  for (std::size_t i = 0; i < sizeof(falcon_layer) / sizeof(ggml_tensor *);
-       ++i) {
-    tensors.push_back(tensor_ptr[i]);
+static const char *llama_file_version_name(llama_file_version version) {
+  switch (version) {
+    case LLAMA_FILE_VERSION_GGML:
+      return "'ggml' (old version with low tokenizer quality and no mmap "
+             "support)";
+    case LLAMA_FILE_VERSION_GGMF_V1:
+      return "ggmf v1 (old version with no mmap support)";
+    case LLAMA_FILE_VERSION_GGJT_V1:
+      return "ggjt v1 (pre #1405)";
+    case LLAMA_FILE_VERSION_GGJT_V2:
+      return "ggjt v2 (pre #1508)";
+    case LLAMA_FILE_VERSION_GGJT_V3:
+      return "ggjt v3 (latest)";
   }
 
-  return tensors;
+  return "unknown";
 }
-// get vram size of all tensors in a layer (todo: split handling)
-size_t calculate_layer_vram_bytes(const falcon_layer &layer) {
-  size_t size = 0;
-  auto tensors = get_tensors_from_layer(const_cast<falcon_layer &>(layer));
 
-  // Add the size of each member with GPU backend
-  for (const auto &tensor : tensors) {
-    if (tensor != nullptr && tensor->backend != GGML_BACKEND_CPU) {
-      size += ggml_nbytes(tensor);
-    }
+static const char *llama_ftype_name(enum llama_ftype ftype) {
+  switch (ftype) {
+    case LLAMA_FTYPE_ALL_F32:
+      return "all F32";
+    case LLAMA_FTYPE_MOSTLY_F16:
+      return "mostly F16";
+    case LLAMA_FTYPE_MOSTLY_Q4_0:
+      return "mostly Q4_0";
+    case LLAMA_FTYPE_MOSTLY_Q4_1:
+      return "mostly Q4_1";
+    case LLAMA_FTYPE_MOSTLY_Q4_1_SOME_F16:
+      return "mostly Q4_1, some F16";
+    case LLAMA_FTYPE_MOSTLY_Q5_0:
+      return "mostly Q5_0";
+    case LLAMA_FTYPE_MOSTLY_Q5_1:
+      return "mostly Q5_1";
+    case LLAMA_FTYPE_MOSTLY_Q8_0:
+      return "mostly Q8_0";
+    // K-quants
+    case LLAMA_FTYPE_MOSTLY_Q2_K:
+      return "mostly Q2_K";
+    case LLAMA_FTYPE_MOSTLY_Q3_K_S:
+      return "mostly Q3_K - Small";
+    case LLAMA_FTYPE_MOSTLY_Q3_K_M:
+      return "mostly Q3_K - Medium";
+    case LLAMA_FTYPE_MOSTLY_Q3_K_L:
+      return "mostly Q3_K - Large";
+    case LLAMA_FTYPE_MOSTLY_Q4_K_S:
+      return "mostly Q4_K - Small";
+    case LLAMA_FTYPE_MOSTLY_Q4_K_M:
+      return "mostly Q4_K - Medium";
+    case LLAMA_FTYPE_MOSTLY_Q5_K_S:
+      return "mostly Q5_K - Small";
+    case LLAMA_FTYPE_MOSTLY_Q5_K_M:
+      return "mostly Q5_K - Medium";
+    case LLAMA_FTYPE_MOSTLY_Q6_K:
+      return "mostly Q6_K";
+    default:
+      return "unknown, may not work";
   }
+}
 
-  return size;
+static const char *llama_model_type_name(e_model type) {
+  switch (type) {
+    case MODEL_3B:
+      return "3B";
+    case MODEL_7B:
+      return "7B";
+    case MODEL_13B:
+      return "13B";
+    case MODEL_30B:
+      return "30B";
+    case MODEL_65B:
+      return "65B";
+    default:
+      LLAMA_ASSERT(false);
+  }
 }
 
-static void falcon_model_load_internal(
-    const std::string &fname, falcon_context &lctx, int n_ctx, int n_batch,
-    int n_gpu_layers, int main_gpu, const float *tensor_split,
+static void llama_model_load_internal(
+    const std::string &fname, llama_context &lctx, int n_ctx, int n_batch,
+    int n_gpu_layers, int main_gpu, const float *tensor_split, bool low_vram,
     ggml_type memory_type, bool use_mmap, bool use_mlock, bool vocab_only,
     llama_progress_callback progress_callback,
     void *progress_callback_user_data) {
   lctx.t_start_us = ggml_time_us();
 
-  std::unique_ptr<falcon_model_loader> ml(
-      new falcon_model_loader(fname, use_mmap, vocab_only));
+  std::unique_ptr<llama_model_loader> ml(
+      new llama_model_loader(fname, use_mmap, vocab_only));
 
   lctx.vocab = std::move(ml->file_loaders.at(0)->vocab);
   auto &model = lctx.model;
   model.hparams = ml->file_loaders.at(0)->hparams;
   model.n_gpu_layers = n_gpu_layers;
-
   llama_file_version file_version = ml->file_loaders.at(0)->file_version;
   auto &hparams = model.hparams;
 
   {
     switch (hparams.n_layer) {
+      case 26:
+        model.type = e_model::MODEL_3B;
+        break;
       case 32:
-        model.type = falcon_e_model::FALCON_7B;
+        model.type = e_model::MODEL_7B;
+        break;
+      case 40:
+        model.type = e_model::MODEL_13B;
         break;
       case 60:
-        model.type = falcon_e_model::FALCON_40B;
+        model.type = e_model::MODEL_30B;
+        break;
+      case 80:
+        model.type = e_model::MODEL_65B;
         break;
       default: {
-        if (hparams.n_falcon_type == 7) {
-          model.type = falcon_e_model::FALCON_7B;
-        } else if (hparams.n_falcon_type == 40) {
-          model.type = falcon_e_model::FALCON_40B;
-        } else {
-          LLAMA_ASSERT(false);
+        if (hparams.n_layer < 32) {
+          model.type = e_model::MODEL_7B;
         }
       } break;
     }
 
     hparams.n_ctx = n_ctx;
   }
 
-  const uint32_t n_ff = 4 * model.hparams.n_embd;
+  const uint32_t n_ff =
+      ((2 * (4 * hparams.n_embd) / 3 + hparams.n_mult - 1) / hparams.n_mult) *
+      hparams.n_mult;
 
   if (file_version < LLAMA_FILE_VERSION_GGJT_V2) {
     if (hparams.ftype != LLAMA_FTYPE_ALL_F32 &&
         hparams.ftype != LLAMA_FTYPE_MOSTLY_F16 &&
         hparams.ftype != LLAMA_FTYPE_MOSTLY_Q8_0) {
       throw std::runtime_error(
           format("this format is no longer supported (see "
@@ -978,212 +1189,162 @@
 #define LLAMA_BACKEND_OFFLOAD GGML_BACKEND_GPU
 #define LLAMA_BACKEND_OFFLOAD_SPLIT GGML_BACKEND_GPU
 #else
 #define LLAMA_BACKEND_OFFLOAD GGML_BACKEND_CPU
 #define LLAMA_BACKEND_OFFLOAD_SPLIT GGML_BACKEND_CPU
 #endif
 
-  size_t vram_total = 0;
-  size_t vram_free = 0;
-  const size_t vram_reserved =
-      512 *
-      MB;  // that amount of VRAM is to stay free on GPU (headroom for other
-           // processes - may be reduced in pure server environments)
-  size_t vram_overhead =
-      1250 *
-      MB;  // this amount of vram is estimated for non weight storage buffers on
-           // VRAM (no big difference between 7B and 40B, needs to increase when
-           // more work is offloaded in the future)
-#if defined(GGML_USE_CUBLAS)
-  // cublas is used in 32 bit mode, temporary cuda storage/conversion buffers
-  // are needed for batch ingestion ( could be run in 16 bit mode without
-  // performance downgrade and save half the VRAM)
-  if (model.type == FALCON_40B && n_batch > 1) {
-    vram_overhead += (1024 + 288 + 256) * MB;
-  }
-  if (model.type == FALCON_7B && n_batch > 1) {
-    vram_overhead += (315 + 80 + 78) * MB;
-  }
-  cudaMemGetInfo(
-      &vram_free,
-      &vram_total);  // this should go in ggml-cuda.cu but I don't want to make
-                     // Johannes life harder by modifying that yet
-#endif
-
   // prepare memory for the weights
   size_t vram_weights = 0;
   size_t vram_scratch = 0;
-
-  (void)vram_scratch;
-  (void)n_batch;
-  // calculate scratch buffer size and allocate it
-#ifdef GGML_USE_CUBLAS
-  // vram_scratch = n_batch * MB;
-  vram_scratch = 0;  // these are not used until we have multi operation support
-  ggml_cuda_set_scratch_size(vram_scratch);
-#endif  // GGML_USE_CUBLAS
-
   {
     const uint32_t n_embd = hparams.n_embd;
-    const uint32_t n_head = hparams.n_head;
-    const uint32_t n_head_kv = hparams.n_head_kv;
     const uint32_t n_layer = hparams.n_layer;
-    const uint32_t n_ff = 4 * model.hparams.n_embd;
     const uint32_t n_vocab = hparams.n_vocab;
-    const uint32_t head_dim = hparams.n_embd / hparams.n_head;
 
     ml->ggml_ctx = ctx;
 
-    model.tok_embeddings = ml->get_tensor("transformer.word_embeddings.weight",
+    model.tok_embeddings = ml->get_tensor("tok_embeddings.weight",
                                           {n_embd, n_vocab}, GGML_BACKEND_CPU);
 
-    ggml_backend backend_norm;
-    ggml_backend backend_output;
-    // disabled norm/output offloading until further tests, causes silent crash
-    // at the moment
-    if (n_gpu_layers > int(n_layer) && false) {  // NOLINT
-      backend_norm = LLAMA_BACKEND_OFFLOAD;
-      backend_output = LLAMA_BACKEND_OFFLOAD_SPLIT;
-    } else {
-      backend_norm = GGML_BACKEND_CPU;
-      backend_output = GGML_BACKEND_CPU;
-    }
-
     // "output" tensor
     {
-      model.output_norm =
-          ml->get_tensor("transformer.ln_f.weight", {n_embd}, backend_norm);
-      model.output_norm_b =
-          ml->get_tensor("transformer.ln_f.bias", {n_embd}, backend_norm);
-      model.lm_head =
-          ml->get_tensor("lm_head.weight", {n_embd, n_vocab}, backend_output);
-    }
-
-    if (backend_norm != GGML_BACKEND_CPU) {
-      vram_weights +=
-          ggml_nbytes(model.output_norm) + ggml_nbytes(model.output_norm_b);
-      vram_free -=
-          ggml_nbytes(model.output_norm) + ggml_nbytes(model.output_norm_b);
-    }
-    if (backend_output != GGML_BACKEND_CPU) {
-      vram_weights += ggml_nbytes(model.lm_head);
-      vram_free -= ggml_nbytes(model.lm_head);
-    }
-
-    int i_gpu_start = n_layer - n_gpu_layers;
-    if (i_gpu_start < 0)
-      i_gpu_start = 0;  // n_gpu_layers can be larger than n_layer
-
-    int i_gpu_last = n_layer;  // allows to terminate the offloading earlier.
-                               // TODO: instead do a proper calculation run and
-                               // determine the start before the loop
-    model.i_gpu_start = i_gpu_start;
-    model.i_gpu_last = i_gpu_last;  // if VRAM doesn't run out i_gpu_last is
-                                    // always the last layer
+      ggml_backend backend_norm;
+      ggml_backend backend_output;
+      if (n_gpu_layers > int(n_layer)) {  // NOLINT
+        // norm is not performance relevant on its own but keeping it in VRAM
+        // reduces data copying on Windows however this is detrimental unless
+        // everything is on the GPU
+#ifndef _WIN32
+        backend_norm = low_vram ? GGML_BACKEND_CPU : LLAMA_BACKEND_OFFLOAD;
+#else
+        backend_norm = low_vram || n_gpu_layers <= (int)n_layer + 2
+                           ? GGML_BACKEND_CPU
+                           : LLAMA_BACKEND_OFFLOAD;
+#endif  // _WIN32
+
+        backend_output = LLAMA_BACKEND_OFFLOAD_SPLIT;
+      } else {
+        backend_norm = GGML_BACKEND_CPU;
+        backend_output = GGML_BACKEND_CPU;
+      }
+
+      model.norm = ml->get_tensor("norm.weight", {n_embd}, backend_norm);
+      model.output =
+          ml->get_tensor("output.weight", {n_embd, n_vocab}, backend_output);
+      if (backend_norm == GGML_BACKEND_GPU) {
+        vram_weights += ggml_nbytes(model.norm);
+      }
+      if (backend_output == GGML_BACKEND_GPU_SPLIT) {
+        vram_weights += ggml_nbytes(model.output);
+      }
+    }
+
+    const int i_gpu_start = n_layer - n_gpu_layers;
 
     model.layers.resize(n_layer);
     for (uint32_t i = 0; i < n_layer; ++i) {
-      const ggml_backend backend = (int(i) < i_gpu_start || int(i) > i_gpu_last)
+      const ggml_backend backend = int(i) < i_gpu_start
                                        ? GGML_BACKEND_CPU
                                        : LLAMA_BACKEND_OFFLOAD;  // NOLINT
       const ggml_backend backend_split =
-          (int(i) < i_gpu_start || int(i) > i_gpu_last)
-              ? GGML_BACKEND_CPU
-              : LLAMA_BACKEND_OFFLOAD_SPLIT;  // NOLINT
+          int(i) < i_gpu_start ? GGML_BACKEND_CPU
+                               : LLAMA_BACKEND_OFFLOAD_SPLIT;  // NOLINT
 
       auto &layer = model.layers[i];
 
       std::string layers_i = "layers." + std::to_string(i);
-      std::string str_i = std::to_string(i);
 
-      if (model.type == FALCON_40B) {
-        layer.input_layernorm =
-            ml->get_tensor("transformer.h." + str_i + ".ln_mlp.weight",
-                           {n_embd}, GGML_BACKEND_CPU);
-        layer.input_layernorm_b =
-            ml->get_tensor("transformer.h." + str_i + ".ln_mlp.bias", {n_embd},
-                           GGML_BACKEND_CPU);
-        layer.attention_norm =
-            ml->get_tensor("transformer.h." + str_i + ".ln_attn.weight",
-                           {n_embd}, GGML_BACKEND_CPU);
-        layer.attention_norm_b =
-            ml->get_tensor("transformer.h." + str_i + ".ln_attn.bias", {n_embd},
-                           GGML_BACKEND_CPU);
-      } else  // FALCON_7B
-      {
-        layer.input_layernorm =
-            ml->get_tensor("transformer.h." + str_i + ".input_layernorm.weight",
-                           {n_embd}, backend);
-        layer.input_layernorm_b =
-            ml->get_tensor("transformer.h." + str_i + ".input_layernorm.bias",
-                           {n_embd}, GGML_BACKEND_CPU);
-      }
-
-      layer.query_key_value = ml->get_tensor(
-          "transformer.h." + str_i + ".self_attention.query_key_value.weight",
-          {n_embd, (n_head_kv * 2 + n_head) * head_dim}, backend_split);
-      layer.wo = ml->get_tensor(
-          "transformer.h." + str_i + ".self_attention.dense.weight",
-          {n_embd, n_embd}, backend_split);
-
-      layer.ffn_up =
-          ml->get_tensor("transformer.h." + str_i + ".mlp.dense_h_to_4h.weight",
-                         {n_embd, n_ff}, backend_split);  // before gelu
-      layer.ffn_down =
-          ml->get_tensor("transformer.h." + str_i + ".mlp.dense_4h_to_h.weight",
-                         {n_ff, n_embd}, backend_split);  // after gelu
-
-      if (backend != GGML_BACKEND_CPU) {
-        size_t vram_layer = 0;
-        vram_layer = calculate_layer_vram_bytes(layer);
-        vram_weights += vram_layer;
-        vram_free =
-            (vram_layer > vram_free)
-                ? 0
-                : vram_free -
-                      vram_layer;  // simulate the layer being loaded in VRAM
-        // test if we have enough VRAM to offload the next layer
-        if (i < n_layer && vram_free <= (vram_overhead + vram_scratch +
-                                         vram_reserved + vram_layer)) {
-          fprintf(stderr,
-                  "INFO: Not enough VRAM to load all requested layers - at "
-                  "layer %d of %d: skipping\n",
-                  i, n_layer);
-          model.n_gpu_layers = n_gpu_layers;
-          i_gpu_last = i;
-          model.i_gpu_last = i_gpu_last;
-          n_gpu_layers = i_gpu_last - i_gpu_start;
-          printf("INFO: %d layers will be offloaded to GPU (layers %d to %d)\n",
-                 n_gpu_layers, i_gpu_start + 1, i_gpu_last + 1);
-        }
+      layer.attention_norm = ml->get_tensor(layers_i + ".attention_norm.weight",
+                                            {n_embd}, backend);
+
+      layer.wq = ml->get_tensor(layers_i + ".attention.wq.weight",
+                                {n_embd, n_embd}, backend_split);
+      layer.wk = ml->get_tensor(layers_i + ".attention.wk.weight",
+                                {n_embd, n_embd}, backend_split);
+      layer.wv = ml->get_tensor(layers_i + ".attention.wv.weight",
+                                {n_embd, n_embd}, backend_split);
+      layer.wo = ml->get_tensor(layers_i + ".attention.wo.weight",
+                                {n_embd, n_embd}, backend_split);
+
+      layer.ffn_norm =
+          ml->get_tensor(layers_i + ".ffn_norm.weight", {n_embd}, backend);
+
+      layer.w1 = ml->get_tensor(layers_i + ".feed_forward.w1.weight",
+                                {n_embd, n_ff}, backend_split);
+      layer.w2 = ml->get_tensor(layers_i + ".feed_forward.w2.weight",
+                                {n_ff, n_embd}, backend_split);
+      layer.w3 = ml->get_tensor(layers_i + ".feed_forward.w3.weight",
+                                {n_embd, n_ff}, backend_split);
+
+      if (backend == GGML_BACKEND_GPU) {
+        vram_weights += ggml_nbytes(layer.attention_norm) +
+                        ggml_nbytes(layer.wq) + ggml_nbytes(layer.wk) +
+                        ggml_nbytes(layer.wv) + ggml_nbytes(layer.wo) +
+                        ggml_nbytes(layer.ffn_norm) + ggml_nbytes(layer.w1) +
+                        ggml_nbytes(layer.w2) + ggml_nbytes(layer.w3);
       }
     }
   }
 
   ml->done_getting_tensors();
 
   // print memory requirements
   {
-    // this is the total memory required to run the inference
-    // TODO: this calculation is still wrong
-    int64_t mem_required = ctx_size + mmapped_size -
-                           vram_weights +  // weights in VRAM not in memory
-                           FALCON_MEM_REQ_SCRATCH0().at(model.type) +
-                           FALCON_MEM_REQ_SCRATCH1().at(model.type) +
-                           FALCON_MEM_REQ_EVAL().at(model.type);
+    const size_t scale = memory_type == GGML_TYPE_F32 ? 2 : 1;
 
-    if (mem_required < 0) mem_required = 0;
+    // this is the total memory required to run the inference
+    const size_t mem_required = ctx_size + mmapped_size -
+                                vram_weights +  // weights in VRAM not in memory
+                                MEM_REQ_SCRATCH0().at(model.type) +
+                                MEM_REQ_SCRATCH1().at(model.type) +
+                                MEM_REQ_EVAL().at(model.type);
 
     // this is the memory required by one llama_state
-    const size_t mem_required_state =
-        FALCON_MEM_REQ_KV_SELF(model.hparams, memory_type, n_ctx);
+    const size_t mem_required_state = scale * MEM_REQ_KV_SELF().at(model.type);
 
-    // moved scratch allocation of vram to top
+    (void)vram_scratch;
+    (void)n_batch;
+#ifdef GGML_USE_CUBLAS
+    if (low_vram) {
+      fprintf(
+          stderr,
+          "%s: not allocating a VRAM scratch buffer due to low VRAM option\n",
+          __func__);
+      ggml_cuda_set_scratch_size(0);  // disable scratch
+    } else {
+      vram_scratch = n_batch * MB;
+      ggml_cuda_set_scratch_size(vram_scratch);
+    }
+#endif  // GGML_USE_CUBLAS
 #if defined(GGML_USE_CUBLAS) || defined(GGML_USE_CLBLAST)
     const int n_gpu = std::min(n_gpu_layers, int(hparams.n_layer));
+    size_t vram_kv_cache = 0;
+    if (n_gpu_layers > (int)hparams.n_layer + 1) {
+      if (low_vram) {
+        fprintf(stderr,
+                "%s: cannot offload v cache to GPU due to low VRAM option\n",
+                __func__);
+      } else {
+        fprintf(stderr, "%s: offloading v cache to GPU\n", __func__);
+        vram_kv_cache += MEM_REQ_KV_SELF().at(model.type) / 2;
+      }
+    }
+    if (n_gpu_layers > (int)hparams.n_layer + 2) {
+      if (low_vram) {
+        fprintf(stderr,
+                "%s: cannot offload k cache to GPU due to low VRAM option\n",
+                __func__);
+      } else {
+        fprintf(stderr, "%s: offloading k cache to GPU\n", __func__);
+        vram_kv_cache += MEM_REQ_KV_SELF().at(model.type) / 2;
+      }
+    }
+    const int max_offloadable_layers =
+        low_vram ? hparams.n_layer + 1 : hparams.n_layer + 3;
 #else
     (void)n_gpu_layers;
 #endif
   }
 
   // populate `tensors_by_name`
   for (llama_load_tensor &lt : ml->tensors_map.tensors) {
@@ -1198,41 +1359,33 @@
   ml->load_all_data(progress_callback, progress_callback_user_data,
                     use_mlock ? &lctx.model.mlock_mmap : NULL);
 
   if (progress_callback) {
     progress_callback(1.0f, progress_callback_user_data);
   }
 
-#if defined(GGML_USE_CUBLAS)
-  // size_t vram_free_simulated = vram_free;
-  cudaMemGetInfo(
-      &vram_free,
-      &vram_total);  // this should go in ggml-cuda.cu but I don't want to make
-                     // Johannes life harder by modifying that yet
-#endif
-
   model.mapping = std::move(ml->mapping);
 
   // loading time will be recalculate after the first eval, so
   // we take page faults deferred by mmap() into consideration
   lctx.t_load_us = ggml_time_us() - lctx.t_start_us;
 }
 
-static bool falcon_model_load(const std::string &fname, falcon_context &lctx,
-                              int n_ctx, int n_batch, int n_gpu_layers,
-                              int main_gpu, float *tensor_split,
-                              ggml_type memory_type, bool use_mmap,
-                              bool use_mlock, bool vocab_only,
-                              llama_progress_callback progress_callback,
-                              void *progress_callback_user_data) {
+static bool llama_model_load(const std::string &fname, llama_context &lctx,
+                             int n_ctx, int n_batch, int n_gpu_layers,
+                             int main_gpu, float *tensor_split, bool low_vram,
+                             ggml_type memory_type, bool use_mmap,
+                             bool use_mlock, bool vocab_only,
+                             llama_progress_callback progress_callback,
+                             void *progress_callback_user_data) {
   try {
-    falcon_model_load_internal(fname, lctx, n_ctx, n_batch, n_gpu_layers,
-                               main_gpu, tensor_split, memory_type, use_mmap,
-                               use_mlock, vocab_only, progress_callback,
-                               progress_callback_user_data);
+    llama_model_load_internal(fname, lctx, n_ctx, n_batch, n_gpu_layers,
+                              main_gpu, tensor_split, low_vram, memory_type,
+                              use_mmap, use_mlock, vocab_only,
+                              progress_callback, progress_callback_user_data);
     return true;
   } catch (const std::exception &err) {
     fprintf(stderr, "error loading model: %s\n", err.what());
     return false;
   }
 }
 
@@ -1240,39 +1393,41 @@
 //
 //   - lctx:         llama context
 //   - tokens:       new batch of tokens to process
 //   - n_past:       the context size so far
 //   - n_threads:    number of threads to use
 //   - cgraph_fname: filename of the exported computation graph
 //
-static bool falcon_eval_internal(falcon_context &lctx,
-                                 const llama_token *tokens, const int n_tokens,
-                                 const int n_past, const int n_threads,
-                                 const char *cgraph_fname, int debug_timings) {
+static bool llama_eval_internal(llama_context &lctx, const llama_token *tokens,
+                                const int n_tokens, const int n_past,
+                                const int n_threads, const char *cgraph_fname) {
+  // enforce that the first token is BOS
+  if (n_past == 0 && tokens[0] != llama_token_bos()) {
+    fprintf(stderr, "%s: first token must be BOS\n", __func__);
+    return false;
+  }
+
   const int64_t t_start_us = ggml_time_us();
 
   const int N = n_tokens;
-  // const int N = embd_inp.size();
 
   const auto &model = lctx.model;
   const auto &hparams = model.hparams;
 
   const auto &kv_self = model.kv_self;
 
   LLAMA_ASSERT(!!kv_self.ctx);
 
   const int n_embd = hparams.n_embd;
   const int n_layer = hparams.n_layer;
   const int n_ctx = hparams.n_ctx;
   const int n_head = hparams.n_head;
-  const int n_head_kv = hparams.n_head_kv;
   const int n_vocab = hparams.n_vocab;
-  const int n_falcon_type = hparams.n_falcon_type;
+  const int n_rot = hparams.n_embd / hparams.n_head;
   const int n_gpu_layers = model.n_gpu_layers;
-  const size_t head_dim = n_embd / n_head;  // == n_rot in llama
 
   auto &mem_per_token = lctx.mem_per_token;
   auto &buf_compute = lctx.buf_compute;
 
   struct ggml_init_params params = {
       /*.mem_size   =*/buf_compute.size,
       /*.mem_buffer =*/buf_compute.addr,
@@ -1290,294 +1445,281 @@
 
   struct ggml_tensor *embd = ggml_new_tensor_1d(ctx0, GGML_TYPE_I32, N);
   ggml_set_name(embd, "embd");
   memcpy(embd->data, tokens, N * ggml_element_size(embd));
 
   struct ggml_tensor *cur;
   struct ggml_tensor *inpL = ggml_get_rows(ctx0, model.tok_embeddings, embd);
-  struct ggml_tensor *repeat_dummy =
-      ggml_new_tensor_3d(ctx0, inpL->type, head_dim, N + n_past, n_head);
 
-  struct ggml_tensor *layernorm_output;
-
-  ggml_type wtype = GGML_TYPE_F32;
-  // ggml_type wtype = ggml_ftype_to_ggml_type((ggml_ftype)
-  // (model.hparams.ftype));
-  const int sizeof_wtype = ggml_type_sizef(wtype);
-
-  // const int i_gpu_start = n_layer - n_gpu_layers;
-  const int i_gpu_start = lctx.model.i_gpu_start;
-  const int i_gpu_last =
-      lctx.model.i_gpu_last > 0 ? lctx.model.i_gpu_last : n_layer;
+  const int i_gpu_start = n_layer - n_gpu_layers;
   (void)i_gpu_start;
 
   // offload functions set the tensor output backend to GPU
   // tensors are GPU-accelerated if any input or the output has been offloaded
   //
   // with the low VRAM option VRAM scratch is disabled in
   // llama_load_model_internal in that case ggml_cuda_assign_buffers has no
   // effect
   offload_func_t offload_func_nr = llama_nop;  // nr = non-repeating
-  offload_func_t offload_func_kqv = llama_nop;
+  offload_func_t offload_func_kq = llama_nop;
+  offload_func_t offload_func_v = llama_nop;
 
 #ifdef GGML_USE_CUBLAS
-  // todo: use either a flag in model/params or a backend test to determine if
-  // norm/output are on GPU
   if (n_gpu_layers > n_layer) {
     offload_func_nr = ggml_cuda_assign_buffers;
   }
   if (n_gpu_layers > n_layer + 1) {
-    offload_func_kqv = ggml_cuda_assign_buffers;
+    offload_func_v = ggml_cuda_assign_buffers;
+  }
+  if (n_gpu_layers > n_layer + 2) {
+    offload_func_kq = ggml_cuda_assign_buffers;
   }
 #endif  // GGML_USE_CUBLAS
 
   for (int il = 0; il < n_layer; ++il) {
     offload_func_t offload_func = llama_nop;
 
 #ifdef GGML_USE_CUBLAS
-    if (il >= i_gpu_start && il < i_gpu_last) {
-      offload_func =
-          ggml_cuda_assign_buffers;  // sets the output backend to GPU
+    if (il >= i_gpu_start) {
+      offload_func = ggml_cuda_assign_buffers;
     }
 #endif  // GGML_USE_CUBLAS
 
     struct ggml_tensor *inpSA = inpL;
 
     lctx.use_buf(ctx0, 0);
 
-    // self-attention
+    // norm
     {
-      layernorm_output = ggml_norm(ctx0, inpL);
-
-      ggml_tensor *il_a =
-          ggml_mul(ctx0, layernorm_output, model.layers[il].input_layernorm);
-      offload_func(il_a);  // (todo: uses vram scratch)
-
-      layernorm_output =
-          ggml_add(ctx0, il_a,
-                   ggml_repeat(ctx0, model.layers[il].input_layernorm_b,
-                               layernorm_output));
-      offload_func(layernorm_output);
-      ggml_set_name(layernorm_output, "layernorm_output");
-
-      if (model.type == FALCON_40B || n_falcon_type == 40) {
-        cur = ggml_norm(ctx0, inpL);
-
-        cur = ggml_add(
-            ctx0,
-            ggml_mul(ctx0,
-                     ggml_repeat(ctx0, model.layers[il].attention_norm, cur),
-                     cur),
-            ggml_repeat(ctx0, model.layers[il].attention_norm_b, cur));
-      } else {
-        cur = layernorm_output;
-      }
-
-      // compute QKV
-
-      cur = ggml_mul_mat(ctx0, model.layers[il].query_key_value, cur);
-      // offload_func(cur);
-
-      // Note that the strides for Kcur, Vcur are set up so that the
-      // resulting views are misaligned with the tensor's storage
-      // (by applying the K/V offset we shift the tensor's original
-      // view to stick out behind the viewed QKV tensor's allocated
-      // memory, so to say). This is ok because no actual accesses
-      // happen to that out-of-range memory, but it can require some
-      // trickery when trying to accurately dump these views for
-      // debugging.
-
-      struct ggml_tensor *Qcur =
-          ggml_view_3d(ctx0, cur, head_dim, n_head, N, head_dim * sizeof_wtype,
-                       head_dim * (n_head + 2 * n_head_kv) * sizeof_wtype, 0);
-      ggml_set_name(Qcur, "Qcur");
+      cur = ggml_rms_norm(ctx0, inpL);
+      offload_func(cur);
+      ggml_set_name(cur, "rms_norm_0");
+
+      // cur = cur*attention_norm(broadcasted)
+      cur = ggml_mul(ctx0, cur, model.layers[il].attention_norm);
+      offload_func(cur);
+      ggml_set_name(cur, "attention_norm_0");
+    }
 
-      struct ggml_tensor *Kcur = ggml_view_3d(
-          ctx0, cur, head_dim, n_head_kv, N, head_dim * sizeof_wtype,
-          head_dim * (n_head + 2 * n_head_kv) * sizeof_wtype,
-          head_dim * n_head * sizeof_wtype);
+    // self-attention
+    {
+      // compute Q and K and RoPE them
+      struct ggml_tensor *tmpk = ggml_mul_mat(ctx0, model.layers[il].wk, cur);
+      offload_func_kq(tmpk);
+      ggml_set_name(tmpk, "tmpk");
+
+      struct ggml_tensor *tmpq = ggml_mul_mat(ctx0, model.layers[il].wq, cur);
+      offload_func_kq(tmpq);
+      ggml_set_name(tmpq, "tmpq");
+
+      struct ggml_tensor *Kcur = ggml_rope_inplace(
+          ctx0, ggml_reshape_3d(ctx0, tmpk, n_embd / n_head, n_head, N), n_past,
+          n_rot, 0);
+      offload_func_kq(Kcur);
       ggml_set_name(Kcur, "Kcur");
 
-      struct ggml_tensor *Vcur = ggml_view_3d(
-          ctx0, cur, head_dim, n_head_kv, N, head_dim * sizeof_wtype,
-          head_dim * (n_head + 2 * n_head_kv) * sizeof_wtype,
-          head_dim * (n_head + n_head_kv) * sizeof_wtype);
-      ggml_set_name(Vcur, "Vcur");
-
-      // using mode = 2 for neox mode
-      Qcur = ggml_rope_inplace(ctx0, Qcur, n_past, head_dim, 2);
-      Kcur = ggml_rope_inplace(ctx0, Kcur, n_past, head_dim, 2);
+      struct ggml_tensor *Qcur = ggml_rope_inplace(
+          ctx0, ggml_reshape_3d(ctx0, tmpq, n_embd / n_head, n_head, N), n_past,
+          n_rot, 0);
+      offload_func_kq(Qcur);
+      ggml_set_name(Qcur, "Qcur");
 
       // store key and value to memory
       {
-        struct ggml_tensor *k =
-            ggml_view_1d(ctx0, kv_self.k, N * n_head_kv * head_dim,
-                         (ggml_element_size(kv_self.k) * n_head_kv * head_dim) *
-                             (il * n_ctx + n_past));
+        // compute the transposed [N, n_embd] V matrix
+
+        struct ggml_tensor *tmpv = ggml_mul_mat(ctx0, model.layers[il].wv, cur);
+        offload_func_v(tmpv);
+        ggml_set_name(tmpv, "tmpv");
+
+        struct ggml_tensor *Vcur =
+            ggml_transpose(ctx0, ggml_reshape_2d(ctx0, tmpv, n_embd, N));
+        offload_func_v(Vcur);
+        ggml_set_name(Vcur, "Vcur");
+
+        struct ggml_tensor *k = ggml_view_1d(
+            ctx0, kv_self.k, N * n_embd,
+            (ggml_element_size(kv_self.k) * n_embd) * (il * n_ctx + n_past));
+        offload_func_kq(k);
         ggml_set_name(k, "k");
-        struct ggml_tensor *v =
-            ggml_view_1d(ctx0, kv_self.v, N * n_head_kv * head_dim,
-                         (ggml_element_size(kv_self.v) * n_head_kv * head_dim) *
-                             (il * n_ctx + n_past));
+
+        struct ggml_tensor *v = ggml_view_2d(
+            ctx0, kv_self.v, N, n_embd, (n_ctx)*ggml_element_size(kv_self.v),
+            (il * n_ctx) * ggml_element_size(kv_self.v) * n_embd +
+                n_past * ggml_element_size(kv_self.v));
+        offload_func_v(v);
         ggml_set_name(v, "v");
 
+        // important: storing RoPE-ed version of K in the KV cache!
         ggml_build_forward_expand(&gf, ggml_cpy(ctx0, Kcur, k));
         ggml_build_forward_expand(&gf, ggml_cpy(ctx0, Vcur, v));
       }
 
+      struct ggml_tensor *Q = ggml_permute(ctx0, Qcur, 0, 2, 1, 3);
+      offload_func_kq(Q);
+      ggml_set_name(Q, "Q");
+
       struct ggml_tensor *K = ggml_permute(
           ctx0,
           ggml_reshape_3d(
               ctx0,
-              ggml_view_1d(ctx0, kv_self.k, (n_past + N) * n_head_kv * head_dim,
-                           il * n_ctx * ggml_element_size(kv_self.k) *
-                               n_head_kv * head_dim),
-              head_dim, n_head_kv, n_past + N),
+              ggml_view_1d(ctx0, kv_self.k, (n_past + N) * n_embd,
+                           il * n_ctx * ggml_element_size(kv_self.k) * n_embd),
+              n_embd / n_head, n_head, n_past + N),
           0, 2, 1, 3);
-
-      // K * Q
-
-      K = ggml_cont(ctx0, ggml_repeat2(ctx0, K, repeat_dummy));
+      offload_func_kq(K);
       ggml_set_name(K, "K");
 
-      struct ggml_tensor *Q = ggml_permute(ctx0, Qcur, 0, 2, 1, 3);
-      ggml_set_name(Q, "Q");
+      // K * Q
       struct ggml_tensor *KQ = ggml_mul_mat(ctx0, K, Q);
+      offload_func_kq(KQ);
       ggml_set_name(KQ, "KQ");
 
       // KQ_scaled = KQ / sqrt(n_embd/n_head)
-      struct ggml_tensor *KQ_scaled = ggml_scale_inplace(
-          ctx0, KQ, ggml_new_f32(ctx0, 1.0f / sqrt(float(head_dim))));
+      struct ggml_tensor *KQ_scale =
+          ggml_new_f32(ctx0, 1.0f / sqrtf(float(n_embd) / n_head));
+      ggml_set_name(KQ_scale, "1/sqrt(n_embd/n_head)");
+
+      // KQ_scaled shape [n_past + N, N, n_head, 1]
+      struct ggml_tensor *KQ_scaled = ggml_scale_inplace(ctx0, KQ, KQ_scale);
+      offload_func_kq(KQ_scaled);
       ggml_set_name(KQ_scaled, "KQ_scaled");
 
       // KQ_masked = mask_past(KQ_scaled)
       struct ggml_tensor *KQ_masked =
           ggml_diag_mask_inf_inplace(ctx0, KQ_scaled, n_past);
+      offload_func_kq(KQ_masked);
       ggml_set_name(KQ_masked, "KQ_masked");
 
       // KQ = soft_max(KQ_masked)
       struct ggml_tensor *KQ_soft_max = ggml_soft_max_inplace(ctx0, KQ_masked);
+      offload_func_v(KQ_soft_max);
       ggml_set_name(KQ_soft_max, "KQ_soft_max");
 
-      // V_trans = Vmem.view(n_embd/n_head, n_head, n_past + N).permute(1, 2, 0,
-      // 3).contiguous()
-      struct ggml_tensor *V = ggml_permute(
-          ctx0,
-          ggml_reshape_3d(
-              ctx0,
-              ggml_view_1d(ctx0, kv_self.v, (n_past + N) * n_head_kv * head_dim,
-                           il * n_ctx * ggml_element_size(model.kv_self.v) *
-                               n_head_kv * head_dim),
-              head_dim, n_head_kv, n_past + N),
-          0, 2, 1, 3);
-
-      V = ggml_cont(ctx0,
-                    ggml_transpose(ctx0, ggml_repeat2(ctx0, V, repeat_dummy)));
+      // split cached V into n_head heads
+      struct ggml_tensor *V =
+          ggml_view_3d(ctx0, kv_self.v, n_past + N, n_embd / n_head, n_head,
+                       n_ctx * ggml_element_size(kv_self.v),
+                       n_ctx * ggml_element_size(kv_self.v) * n_embd / n_head,
+                       il * n_ctx * ggml_element_size(kv_self.v) * n_embd);
+      offload_func_v(V);
       ggml_set_name(V, "V");
 
-      // KQV = transpose(V) * KQ_soft_max
+#if 1
       struct ggml_tensor *KQV = ggml_mul_mat(ctx0, V, KQ_soft_max);
+      offload_func_v(KQV);
       ggml_set_name(KQV, "KQV");
+#else
+      // make V contiguous in memory to speed up the matmul, however we waste
+      // time on the copy on M1 this is faster for the perplexity computation,
+      // but ~5% slower for the single-token generation is there a better way?
+      struct ggml_tensor *V_cont =
+          ggml_cpy(ctx0, V,
+                   ggml_new_tensor_3d(ctx0, kv_self.v->type, n_past + N,
+                                      n_embd / n_head, n_head));
+      struct ggml_tensor *KQV = ggml_mul_mat(ctx0, V_cont, KQ_soft_max);
+#endif
 
       // KQV_merged = KQV.permute(0, 2, 1, 3)
       struct ggml_tensor *KQV_merged = ggml_permute(ctx0, KQV, 0, 2, 1, 3);
+      offload_func_v(KQV_merged);
       ggml_set_name(KQV_merged, "KQV_merged");
 
       // cur = KQV_merged.contiguous().view(n_embd, N)
       cur = ggml_cpy(ctx0, KQV_merged,
                      ggml_new_tensor_2d(ctx0, GGML_TYPE_F32, n_embd, N));
+      offload_func_v(cur);
+      ggml_set_name(cur, "KQV_merged_contiguous");
 
-      // projection
-      {
-        cur = ggml_mul_mat(ctx0, model.layers[il].wo, cur);
-        // offload_func(cur);
-        ggml_set_name(cur, "result_wo");
-      }
-    }  // end of attention
+      // projection (no bias)
+      cur = ggml_mul_mat(ctx0, model.layers[il].wo, cur);
+      offload_func(cur);
+      ggml_set_name(cur, "result_wo");
+    }
 
     lctx.use_buf(ctx0, 1);
-    // ggml_cuda_set_scratch(1);
 
-    struct ggml_tensor *inpFF = layernorm_output;
+    struct ggml_tensor *inpFF = ggml_add(ctx0, cur, inpSA);
+    offload_func(inpFF);
     ggml_set_name(inpFF, "inpFF");
-    struct ggml_tensor *attn_out =
-        ggml_cpy(ctx0, cur, ggml_new_tensor_2d(ctx0, GGML_TYPE_F32, n_embd, N));
-    // offload_func(attn_out);
-    ggml_set_name(attn_out, "attn_out");
+
+    // feed-forward network
     {
-      cur = ggml_mul_mat(ctx0, model.layers[il].ffn_up, inpFF);
-      // offload_func(cur);
-      ggml_set_name(cur, "inpFF*ff_up");
-      cur = ggml_gelu(ctx0, cur);
-      // offload_func(cur);
-      cur = ggml_mul_mat(ctx0, model.layers[il].ffn_down, cur);
-      // offload_func(cur);
-      ggml_set_name(cur, "gelu_cur*ff_down");
+      // norm
+      {
+        cur = ggml_rms_norm(ctx0, inpFF);
+        offload_func(cur);
+        ggml_set_name(cur, "rms_norm_1");
+
+        // cur = cur*ffn_norm(broadcasted)
+        cur = ggml_mul(ctx0, cur, model.layers[il].ffn_norm);
+        offload_func(cur);
+        ggml_set_name(cur, "ffn_norm");
+      }
+
+      struct ggml_tensor *tmp = ggml_mul_mat(ctx0, model.layers[il].w3, cur);
+      offload_func(tmp);
+      ggml_set_name(tmp, "result_w3");
+
+      cur = ggml_mul_mat(ctx0, model.layers[il].w1, cur);
+      offload_func(cur);
+      ggml_set_name(cur, "result_w2");
+
+      // SILU activation
+      cur = ggml_silu(ctx0, cur);
+      offload_func(cur);
+      ggml_set_name(cur, "silu");
+
+      cur = ggml_mul(ctx0, cur, tmp);
+      offload_func(cur);
+      ggml_set_name(cur, "silu_x_result_w3");
+
+      cur = ggml_mul_mat(ctx0, model.layers[il].w2, cur);
+      offload_func(cur);
+      ggml_set_name(cur, "result_w2");
     }
 
-    cur = ggml_add(ctx0, cur, attn_out);
-    cur = ggml_add(ctx0, cur, inpL);
-    ggml_set_name(cur, "inpFF_+_result_attn_out");
+    cur = ggml_add(ctx0, cur, inpFF);
+    offload_func(cur);
+    ggml_set_name(cur, "inpFF_+_result_w2");
+
     // input for next layer
     inpL = cur;
-  }  // end of layer loop
+  }
+
   lctx.use_buf(ctx0, 0);
-  // ggml_cuda_set_scratch(0);
 
   // used at the end to optionally extract the embeddings
   struct ggml_tensor *embeddings = NULL;
 
-  offload_func_t offload_func = llama_nop;
-
-#ifdef GGML_USE_CUBLAS
-  if (n_gpu_layers > 0 && n_layer >= i_gpu_start && n_layer <= i_gpu_last) {
-    offload_func = ggml_cuda_assign_buffers;  // sets the output backend to GPU
-  }
-#endif  // GGML_USE_CUBLAS
-
   // norm
   {
-    cur = ggml_norm(ctx0, cur);
-    // offload_func(cur);
-    ggml_set_name(cur, "norm_cur");
-
-    // inpL = ln_f_g*inpL + ln_f_b
-    cur = ggml_add(
-        ctx0, ggml_mul(ctx0, ggml_repeat(ctx0, model.output_norm, cur), cur),
-        ggml_repeat(ctx0, model.output_norm_b, cur));
-    // offload_func(cur);
+    cur = ggml_rms_norm(ctx0, inpL);
+    offload_func_nr(cur);
+    ggml_set_name(cur, "rms_norm_2");
+
+    // cur = cur*norm(broadcasted)
+    cur = ggml_mul(ctx0, cur, model.norm);
+    // offload_func_nr(cur); // TODO CPU + GPU mirrored backend
     ggml_set_name(cur, "result_norm");
 
     embeddings = cur;
   }
 
-  // language modelling head
-  cur = ggml_mul_mat(ctx0, model.lm_head, cur);
-  // offload_func(cur);
-  ggml_set_name(cur, "result_lm_head");
-
-  //  cur = ggml_mul_mat(ctx0, model.output, cur);
-  // ggml_set_name(cur, "result_output");
+  // lm_head
+  cur = ggml_mul_mat(ctx0, model.output, cur);
+  ggml_set_name(cur, "result_output");
 
   lctx.use_buf(ctx0, -1);
 
   // logits -> probs
   // cur = ggml_soft_max_inplace(ctx0, cur);
 
   // run the computation
   ggml_build_forward_expand(&gf, cur);
-#if 0
-    // use to confirm vram_overhead is correct
-    size_t vram_total=0;
-    size_t vram_free=0;
-#if defined(GGML_USE_CUBLAS)
-    cudaMemGetInfo(&vram_free, &vram_total); // this should go in ggml-cuda.cu but I don't want to make Johannes life harder by modifying that yet
-    fprintf(stderr, "\n%s: VRAM free: %7.2f MB  of %7.2f MB (in use: %7.2f MB)\n", __func__, vram_free/MB*1.0, vram_total/MB*1.0, (vram_total-vram_free)/MB*1.0);
-#endif
-#endif
 
 #ifdef GGML_USE_METAL
   if (lctx.ctx_metal && N == 1) {
     ggml_metal_graph_compute(lctx.ctx_metal, &gf);
     ggml_metal_get_tensor(lctx.ctx_metal, cur);
   } else {
     // IMPORTANT:
@@ -1603,14 +1745,20 @@
   ggml_graph_compute(ctx0, &gf);
 #endif
 
   if (cgraph_fname) {
     ggml_graph_export(&gf, cgraph_fname);
   }
 
+#ifdef GGML_PERF
+  // print timing information per ggml operation (for debugging purposes)
+  // requires GGML_PERF to be defined
+  ggml_graph_print(&gf);
+#endif
+
   // plot the computation graph in dot format (for debugging purposes)
   // if (n_past%100 == 0) {
   //    ggml_graph_dump_dot(&gf, NULL, "llama.dot");
   //}
 
   // embd_w.resize(n_vocab*N);
   // memcpy(embd_w.data(), ggml_get_data(cur), sizeof(float)*n_vocab*N);
@@ -1670,38 +1818,176 @@
   return true;
 }
 
 //
 // tokenizer
 //
 
-static std::vector<llama_vocab::id> falcon_tokenize(const llama_vocab &vocab,
-                                                    const std::string &text,
-                                                    bool bos) {
+static size_t utf8_len(char src) {
+  const size_t lookup[] = {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 3, 4};
+  uint8_t highbits = static_cast<uint8_t>(src) >> 4;
+  return lookup[highbits];
+}
+
+struct llama_sp_symbol {
+  using index = int;
+  index prev;
+  index next;
+  const char *text;
+  size_t n;
+};
+
+static_assert(std::is_trivially_copyable<llama_sp_symbol>::value,
+              "llama_sp_symbol is not trivially copyable");
+
+struct llama_sp_bigram {
+  struct comparator {
+    bool operator()(llama_sp_bigram &l, llama_sp_bigram &r) {
+      return (l.score < r.score) || (l.score == r.score && l.left > r.left);
+    }
+  };
+  using queue_storage = std::vector<llama_sp_bigram>;
+  using queue = std::priority_queue<llama_sp_bigram, queue_storage, comparator>;
+  llama_sp_symbol::index left;
+  llama_sp_symbol::index right;
+  float score;
+  size_t size;
+};
+
+// original implementation:
+// https://github.com/ggerganov/llama.cpp/commit/074bea2eb1f1349a0118239c4152914aecaa1be4
+struct llama_tokenizer {
+  llama_tokenizer(const llama_vocab &vocab) : vocab_(vocab) {}
+
+  void tokenize(const std::string &text, std::vector<llama_vocab::id> &output) {
+    // split string into utf8 chars
+    int index = 0;
+    size_t offs = 0;
+    while (offs < text.size()) {
+      llama_sp_symbol sym;
+      size_t char_len = std::min(text.size() - offs, utf8_len(text[offs]));
+      sym.text = text.c_str() + offs;
+      sym.n = char_len;
+      offs += char_len;
+      sym.prev = index - 1;
+      sym.next = offs == text.size() ? -1 : index + 1;
+      index++;
+      symbols_.emplace_back(sym);
+    }
+
+    // seed the work queue with all possible 2-character tokens.
+    for (size_t i = 1; i < symbols_.size(); ++i) {
+      try_add_bigram(i - 1, i);
+    }
+
+    // keep substituting the highest frequency pairs for as long as we can.
+    while (!work_queue_.empty()) {
+      auto bigram = work_queue_.top();
+      work_queue_.pop();
+
+      auto &left_sym = symbols_[bigram.left];
+      auto &right_sym = symbols_[bigram.right];
+
+      // if one of the symbols already got merged, skip it.
+      if (left_sym.n == 0 || right_sym.n == 0 ||
+          left_sym.n + right_sym.n != bigram.size) {
+        continue;
+      }
+
+      // merge the right sym into the left one
+      left_sym.n += right_sym.n;
+      right_sym.n = 0;
+
+      // printf("left = '%*s' size = %zu\n", (int) left_sym.n, left_sym.text,
+      // bigram.size);
+
+      // remove the right sym from the chain
+      left_sym.next = right_sym.next;
+      if (right_sym.next >= 0) {
+        symbols_[right_sym.next].prev = bigram.left;
+      }
+
+      // find more substitutions
+      try_add_bigram(left_sym.prev, bigram.left);
+      try_add_bigram(bigram.left, left_sym.next);
+    }
+
+    for (int i = 0; i != -1; i = symbols_[i].next) {
+      auto &symbol = symbols_[i];
+      auto token = vocab_.token_to_id.find(std::string(symbol.text, symbol.n));
+
+      if (token == vocab_.token_to_id.end()) {
+        // output any symbols that did not form tokens as bytes.
+        for (int j = 0; j < (int)symbol.n; ++j) {
+          llama_vocab::id token_id = static_cast<uint8_t>(symbol.text[j]) + 3;
+          output.push_back(token_id);
+        }
+      } else {
+        output.push_back((*token).second);
+      }
+    }
+  }
+
+ private:
+  void try_add_bigram(int left, int right) {
+    if (left == -1 || right == -1) {
+      return;
+    }
+
+    const std::string text =
+        std::string(symbols_[left].text, symbols_[left].n + symbols_[right].n);
+    auto token = vocab_.token_to_id.find(text);
+
+    if (token == vocab_.token_to_id.end()) {
+      return;
+    }
+
+    if (static_cast<size_t>((*token).second) >= vocab_.id_to_token.size()) {
+      return;
+    }
+
+    const auto &tok_score = vocab_.id_to_token[(*token).second];
+
+    llama_sp_bigram bigram;
+    bigram.left = left;
+    bigram.right = right;
+    bigram.score = tok_score.score;
+    bigram.size = text.size();
+    work_queue_.push(bigram);
+  }
+
+  const llama_vocab &vocab_;
+  std::vector<llama_sp_symbol> symbols_;
+  llama_sp_bigram::queue work_queue_;
+};
+
+static std::vector<llama_vocab::id> llama_tokenize(const llama_vocab &vocab,
+                                                   const std::string &text,
+                                                   bool bos) {
   llama_tokenizer tokenizer(vocab);
   std::vector<llama_vocab::id> output;
 
   if (text.empty()) {
     return output;
   }
 
   if (bos) {
-    output.push_back(falcon_token_bos());
+    output.push_back(llama_token_bos());
   }
 
   tokenizer.tokenize(text, output);
   return output;
 }
 
 //
 // sampling
 //
 
-void falcon_sample_softmax(struct falcon_context *ctx,
-                           llama_token_data_array *candidates) {
+void llama_sample_softmax(struct llama_context *ctx,
+                          llama_token_data_array *candidates) {
   assert(candidates->size > 0);
 
   const int64_t t_start_sample_us = ggml_time_us();
 
   // Sort the logits in descending order
   if (!candidates->sorted) {
     std::sort(candidates->data, candidates->data + candidates->size,
@@ -1723,17 +2009,17 @@
   }
 
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
 }
 
-void falcon_sample_top_k(struct falcon_context *ctx,
-                         llama_token_data_array *candidates, int k,
-                         size_t min_keep) {
+void llama_sample_top_k(struct llama_context *ctx,
+                        llama_token_data_array *candidates, int k,
+                        size_t min_keep) {
   const int64_t t_start_sample_us = ggml_time_us();
 
   k = std::max(k, (int)min_keep);
   k = std::min(k, (int)candidates->size);
 
   // Sort scores in descending order
   if (!candidates->sorted) {
@@ -1751,24 +2037,24 @@
   candidates->size = k;
 
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
 }
 
-void falcon_sample_top_p(struct falcon_context *ctx,
-                         llama_token_data_array *candidates, float p,
-                         size_t min_keep) {
+void llama_sample_top_p(struct llama_context *ctx,
+                        llama_token_data_array *candidates, float p,
+                        size_t min_keep) {
   if (p >= 1.0f) {
     return;
   }
 
   const int64_t t_start_sample_us = ggml_time_us();
 
-  falcon_sample_softmax(ctx, candidates);
+  llama_sample_softmax(ctx, candidates);
 
   // Compute the cumulative probabilities
   float cum_sum = 0.0f;
   size_t last_idx = candidates->size;
 
   for (size_t i = 0; i < candidates->size; ++i) {
     cum_sum += candidates->data[i].p;
@@ -1785,24 +2071,24 @@
   candidates->size = last_idx;
 
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
 }
 
-void falcon_sample_tail_free(struct falcon_context *ctx,
-                             llama_token_data_array *candidates, float z,
-                             size_t min_keep) {
+void llama_sample_tail_free(struct llama_context *ctx,
+                            llama_token_data_array *candidates, float z,
+                            size_t min_keep) {
   if (z >= 1.0f || candidates->size <= 2) {
     return;
   }
 
   const int64_t t_start_sample_us = ggml_time_us();
 
-  falcon_sample_softmax(nullptr, candidates);
+  llama_sample_softmax(nullptr, candidates);
 
   // Compute the first and second derivatives
   std::vector<float> first_derivatives(candidates->size - 1);
   std::vector<float> second_derivatives(candidates->size - 2);
 
   for (size_t i = 0; i < first_derivatives.size(); ++i) {
     first_derivatives[i] = candidates->data[i].p - candidates->data[i + 1].p;
@@ -1840,27 +2126,27 @@
   candidates->size = last_idx;
 
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
 }
 
-void falcon_sample_typical(struct falcon_context *ctx,
-                           llama_token_data_array *candidates, float p,
-                           size_t min_keep) {
+void llama_sample_typical(struct llama_context *ctx,
+                          llama_token_data_array *candidates, float p,
+                          size_t min_keep) {
   // Reference implementation:
   // https://github.com/huggingface/transformers/compare/main...cimeister:typical-sampling:typical-pr
   if (p >= 1.0f) {
     return;
   }
 
   const int64_t t_start_sample_us = ggml_time_us();
 
   // Compute the softmax of logits and calculate entropy
-  falcon_sample_softmax(nullptr, candidates);
+  llama_sample_softmax(nullptr, candidates);
 
   float entropy = 0.0f;
   for (size_t i = 0; i < candidates->size; ++i) {
     entropy += -candidates->data[i].p * logf(candidates->data[i].p);
   }
 
   // Compute the absolute difference between negative log probability and
@@ -1907,32 +2193,32 @@
   candidates->size = new_candidates.size();
 
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
 }
 
-void falcon_sample_temperature(struct falcon_context *ctx,
-                               llama_token_data_array *candidates_p,
-                               float temp) {
+void llama_sample_temperature(struct llama_context *ctx,
+                              llama_token_data_array *candidates_p,
+                              float temp) {
   const int64_t t_start_sample_us = ggml_time_us();
 
   for (size_t i = 0; i < candidates_p->size; ++i) {
     candidates_p->data[i].logit /= temp;
   }
 
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
 }
 
-void falcon_sample_repetition_penalty(struct falcon_context *ctx,
-                                      llama_token_data_array *candidates,
-                                      const llama_token *last_tokens,
-                                      size_t last_tokens_size, float penalty) {
+void llama_sample_repetition_penalty(struct llama_context *ctx,
+                                     llama_token_data_array *candidates,
+                                     const llama_token *last_tokens,
+                                     size_t last_tokens_size, float penalty) {
   if (last_tokens_size == 0 || penalty == 1.0f) {
     return;
   }
 
   const int64_t t_start_sample_us = ggml_time_us();
 
   for (size_t i = 0; i < candidates->size; ++i) {
@@ -1956,16 +2242,16 @@
   candidates->sorted = false;
 
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
 }
 
-void falcon_sample_frequency_and_presence_penalties(
-    struct falcon_context *ctx, llama_token_data_array *candidates,
+void llama_sample_frequency_and_presence_penalties(
+    struct llama_context *ctx, llama_token_data_array *candidates,
     const llama_token *last_tokens_p, size_t last_tokens_size,
     float alpha_frequency, float alpha_presence) {
   if (last_tokens_size == 0 ||
       (alpha_frequency == 0.0f && alpha_presence == 0.0f)) {
     return;
   }
 
@@ -1992,24 +2278,24 @@
   candidates->sorted = false;
 
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
 }
 
-llama_token falcon_sample_token_mirostat(struct falcon_context *ctx,
-                                         llama_token_data_array *candidates,
-                                         float tau, float eta, int m,
-                                         float *mu) {
+llama_token llama_sample_token_mirostat(struct llama_context *ctx,
+                                        llama_token_data_array *candidates,
+                                        float tau, float eta, int m,
+                                        float *mu) {
   assert(ctx);
-  auto N = float(falcon_n_vocab(ctx));
+  auto N = float(llama_n_vocab(ctx));
   int64_t t_start_sample_us;
   t_start_sample_us = ggml_time_us();
 
-  falcon_sample_softmax(nullptr, candidates);
+  llama_sample_softmax(nullptr, candidates);
 
   // Estimate s_hat using the most probable m tokens
   float s_hat = 0.0;
   float sum_ti_bi = 0.0;
   float sum_ti_sq = 0.0;
   for (size_t i = 0; i < size_t(m - 1) && i < candidates->size - 1; ++i) {
     float t_i = logf(float(i + 2) / float(i + 1));
@@ -2021,19 +2307,19 @@
 
   // Compute k from the estimated s_hat and target surprise value
   float epsilon_hat = s_hat - 1;
   float k = powf((epsilon_hat * powf(2, *mu)) / (1 - powf(N, -epsilon_hat)),
                  1 / s_hat);
 
   // Sample the next word X using top-k sampling
-  falcon_sample_top_k(nullptr, candidates, int(k), 1);
+  llama_sample_top_k(nullptr, candidates, int(k), 1);
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
-  llama_token X = falcon_sample_token(ctx, candidates);
+  llama_token X = llama_sample_token(ctx, candidates);
   t_start_sample_us = ggml_time_us();
 
   // Compute error as the difference between observed surprise and target
   // surprise value
   size_t X_idx = std::distance(
       candidates->data,
       std::find_if(candidates->data, candidates->data + candidates->size,
@@ -2049,43 +2335,43 @@
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
     ctx->n_sample++;
   }
   return X;
 }
 
-llama_token falcon_sample_token_mirostat_v2(struct falcon_context *ctx,
-                                            llama_token_data_array *candidates,
-                                            float tau, float eta, float *mu) {
+llama_token llama_sample_token_mirostat_v2(struct llama_context *ctx,
+                                           llama_token_data_array *candidates,
+                                           float tau, float eta, float *mu) {
   assert(ctx);
   int64_t t_start_sample_us;
   t_start_sample_us = ggml_time_us();
 
-  falcon_sample_softmax(ctx, candidates);
+  llama_sample_softmax(ctx, candidates);
 
   // Truncate the words with surprise values greater than mu
   candidates->size = std::distance(
       candidates->data,
       std::find_if(candidates->data, candidates->data + candidates->size,
                    [&](const llama_token_data &candidate) {
                      return -log2f(candidate.p) > *mu;
                    }));
 
   if (candidates->size == 0) {
     candidates->size = 1;
   }
 
   // Normalize the probabilities of the remaining words
-  falcon_sample_softmax(ctx, candidates);
+  llama_sample_softmax(ctx, candidates);
 
   // Sample the next word X from the remaining words
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
-  llama_token X = falcon_sample_token(ctx, candidates);
+  llama_token X = llama_sample_token(ctx, candidates);
   t_start_sample_us = ggml_time_us();
 
   // Compute error as the difference between observed surprise and target
   // surprise value
   size_t X_idx = std::distance(
       candidates->data,
       std::find_if(candidates->data, candidates->data + candidates->size,
@@ -2100,16 +2386,16 @@
 
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
   }
   return X;
 }
 
-llama_token falcon_sample_token_greedy(struct falcon_context *ctx,
-                                       llama_token_data_array *candidates) {
+llama_token llama_sample_token_greedy(struct llama_context *ctx,
+                                      llama_token_data_array *candidates) {
   const int64_t t_start_sample_us = ggml_time_us();
 
   // Find max element
   auto *max_iter = std::max_element(
       candidates->data, candidates->data + candidates->size,
       [](const llama_token_data &a, const llama_token_data &b) {
         return a.logit < b.logit;
@@ -2119,19 +2405,19 @@
   if (ctx) {
     ctx->t_sample_us += ggml_time_us() - t_start_sample_us;
     ctx->n_sample++;
   }
   return result;
 }
 
-llama_token falcon_sample_token(struct falcon_context *ctx,
-                                llama_token_data_array *candidates) {
+llama_token llama_sample_token(struct llama_context *ctx,
+                               llama_token_data_array *candidates) {
   assert(ctx);
   const int64_t t_start_sample_us = ggml_time_us();
-  falcon_sample_softmax(nullptr, candidates);
+  llama_sample_softmax(nullptr, candidates);
 
   std::vector<float> probs;
   probs.reserve(candidates->size);
   for (size_t i = 0; i < candidates->size; ++i) {
     probs.push_back(candidates->data[i].p);
   }
 
@@ -2146,17 +2432,92 @@
   return result;
 }
 
 //
 // quantization
 //
 
-static void falcon_model_quantize_internal(
+static void llama_convert_tensor_internal(const llama_load_tensor &tensor,
+                                          llama_buffer &output,
+                                          const int nelements,
+                                          const int nthread) {
+  if (output.size < nelements * sizeof(float)) {
+    output.resize(nelements * sizeof(float));
+  }
+  float *f32_output = (float *)output.addr;
+
+  quantize_fns_t qtype;
+  if (ggml_is_quantized(tensor.type)) {
+    qtype = ggml_internal_get_quantize_fn(tensor.type);
+    if (qtype.dequantize_row_q == NULL) {
+      throw std::runtime_error(
+          format("type %s unsupported for integer quantization: no "
+                 "dequantization available",
+                 ggml_type_name(tensor.type)));
+    }
+  } else if (tensor.type != GGML_TYPE_F16) {
+    throw std::runtime_error(format("cannot dequantize/convert tensor type %s",
+                                    ggml_type_name(tensor.type)));
+  }
+
+  if (nthread < 2) {
+    if (tensor.type == GGML_TYPE_F16) {
+      ggml_fp16_to_fp32_row((ggml_fp16_t *)tensor.data, f32_output, nelements);
+    } else if (ggml_is_quantized(tensor.type)) {
+      qtype.dequantize_row_q(tensor.data, f32_output, nelements);
+    } else {
+      LLAMA_ASSERT(false);  // unreachable
+    }
+    return;
+  }
+
+  auto block_size =
+      tensor.type == GGML_TYPE_F16 ? 1 : (size_t)ggml_blck_size(tensor.type);
+  auto block_size_bytes = ggml_type_size(tensor.type);
+
+  LLAMA_ASSERT(nelements % block_size == 0);
+  auto nblocks = nelements / block_size;
+  auto blocks_per_thread = nblocks / nthread;
+  auto spare_blocks =
+      nblocks - (blocks_per_thread *
+                 nthread);  // if blocks aren't divisible by thread count
+
+  std::vector<std::thread> workers;
+  for (auto tnum = 0, in_buff_offs = 0, out_buff_offs = 0; tnum < nthread;
+       tnum++) {
+    auto thr_blocks =
+        blocks_per_thread +
+        (tnum == nthread - 1 ? spare_blocks : 0);  // num blocks for this thread
+    auto thr_elems =
+        thr_blocks * block_size;  // number of elements for this thread
+    auto thr_block_bytes =
+        thr_blocks * block_size_bytes;  // number of input bytes for this thread
+
+    auto compute = [qtype](ggml_type typ, uint8_t *inbuf, float *outbuf,
+                           int nels) {
+      if (typ == GGML_TYPE_F16) {
+        ggml_fp16_to_fp32_row((ggml_fp16_t *)inbuf, outbuf, nels);
+      } else {
+        qtype.dequantize_row_q(inbuf, outbuf, nels);
+      }
+    };
+    workers.push_back(std::thread(compute, tensor.type,
+                                  tensor.data + in_buff_offs,
+                                  f32_output + out_buff_offs, thr_elems));
+    in_buff_offs += thr_block_bytes;
+    out_buff_offs += thr_elems;
+  }
+  for (auto &worker : workers) {
+    worker.join();
+  }
+}
+
+static void llama_model_quantize_internal(
     const std::string &fname_inp, const std::string &fname_out,
-    const falcon_model_quantize_params *params) {
+    const llama_model_quantize_params *params) {
   ggml_type quantized_type;
   llama_ftype ftype = params->ftype;
   int nthread = params->nthread;
 
   switch (params->ftype) {
     case LLAMA_FTYPE_MOSTLY_Q4_0:
       quantized_type = GGML_TYPE_Q4_0;
@@ -2206,18 +2567,18 @@
       throw std::runtime_error(format("invalid output file type %d\n", ftype));
   }
 
   if (nthread <= 0) {
     nthread = std::thread::hardware_concurrency();
   }
 
-  std::unique_ptr<falcon_model_loader> model_loader(
-      new falcon_model_loader(fname_inp, /*use_mmap*/ false,
-                              /*vocab_only*/ false));
-  falcon_file_saver file_saver(
+  std::unique_ptr<llama_model_loader> model_loader(
+      new llama_model_loader(fname_inp, /*use_mmap*/ false,
+                             /*vocab_only*/ false));
+  llama_file_saver file_saver(
       fname_out.c_str(), model_loader->file_loaders.at(0).get(), params->ftype);
 
 #ifdef GGML_USE_K_QUANTS
   int n_attention_wv = 0;
   int n_feed_forward_w2 = 0;
   for (auto &tensor : model_loader->tensors_map.tensors) {
     if (tensor.name.find("attention.wv.weight") != std::string::npos) {
@@ -2267,16 +2628,15 @@
     size_t new_size;
     llama_buffer work;
 
     if (!quantize) {
       new_type = tensor.type;
       new_data = tensor.data;
       new_size = tensor.size;
-      printf("(Not quantizing) size = %8.3f MB\n",
-             tensor.size / 1024.0 / 1024.0);
+      printf("size = %8.3f MB\n", tensor.size / 1024.0 / 1024.0);
     } else {
       new_type = quantized_type;
 #ifdef GGML_USE_K_QUANTS
       if (quantized_type == GGML_TYPE_Q2_K ||
           quantized_type == GGML_TYPE_Q3_K ||
           quantized_type == GGML_TYPE_Q4_K ||
           quantized_type == GGML_TYPE_Q5_K ||
@@ -2292,19 +2652,50 @@
                   "This is required to be able to use k-quants for now!\n");
           fprintf(stderr,
                   "============================================================"
                   "============================\n\n");
           throw std::runtime_error("Unsupported tensor size encountered\n");
         }
       }
-      // if (tensor.name == ".mlp.dense_") {
-      //    new_type = GGML_TYPE_Q6_K;
-      // }
-      // TODO falcon
-
+      if (tensor.name == "output.weight") {
+        new_type = GGML_TYPE_Q6_K;
+      } else if (tensor.name.find("attention.wv.weight") != std::string::npos) {
+        if (ftype == LLAMA_FTYPE_MOSTLY_Q3_K_M ||
+            ftype == LLAMA_FTYPE_MOSTLY_Q2_K)
+          new_type = GGML_TYPE_Q4_K;
+        else if (ftype == LLAMA_FTYPE_MOSTLY_Q3_K_L)
+          new_type = GGML_TYPE_Q5_K;
+        else if ((ftype == LLAMA_FTYPE_MOSTLY_Q4_K_M ||
+                  ftype == LLAMA_FTYPE_MOSTLY_Q5_K_M) &&
+                 (i_attention_wv < n_attention_wv / 8 ||
+                  i_attention_wv >= 7 * n_attention_wv / 8 ||
+                  (i_attention_wv - n_attention_wv / 8) % 3 == 2))
+          new_type = GGML_TYPE_Q6_K;
+        ++i_attention_wv;
+      } else if (tensor.name.find("feed_forward.w2.weight") !=
+                 std::string::npos) {
+        if (ftype == LLAMA_FTYPE_MOSTLY_Q3_K_M ||
+            ftype == LLAMA_FTYPE_MOSTLY_Q2_K)
+          new_type = GGML_TYPE_Q4_K;
+        else if (ftype == LLAMA_FTYPE_MOSTLY_Q3_K_L)
+          new_type = GGML_TYPE_Q5_K;
+        else if ((ftype == LLAMA_FTYPE_MOSTLY_Q4_K_M ||
+                  ftype == LLAMA_FTYPE_MOSTLY_Q5_K_M) &&
+                 (i_feed_forward_w2 < n_feed_forward_w2 / 8 ||
+                  i_feed_forward_w2 >= 7 * n_feed_forward_w2 / 8 ||
+                  (i_feed_forward_w2 - n_feed_forward_w2 / 8) % 3 == 2))
+          new_type = GGML_TYPE_Q6_K;
+        ++i_feed_forward_w2;
+      } else if (tensor.name.find("attention.wo.weight") != std::string::npos) {
+        if (ftype == LLAMA_FTYPE_MOSTLY_Q3_K_M ||
+            ftype == LLAMA_FTYPE_MOSTLY_Q2_K)
+          new_type = GGML_TYPE_Q4_K;
+        else if (ftype == LLAMA_FTYPE_MOSTLY_Q3_K_L)
+          new_type = GGML_TYPE_Q5_K;
+      }
 #endif
 
       float *f32_data;
       size_t nelements = tensor.ne.at(0) * tensor.ne.at(1);
       llama_buffer f32_conv_buf;
 
       if (tensor.type == GGML_TYPE_F32) {
@@ -2414,19 +2805,19 @@
   }
 }
 
 //
 // interface implementation
 //
 
-struct falcon_context *falcon_init_from_file(
-    const char *path_model, struct falcon_context_params params) {
+struct llama_context *llama_init_from_file(const char *path_model,
+                                           struct llama_context_params params) {
   ggml_time_init();
 
-  falcon_context *ctx = new falcon_context;
+  llama_context *ctx = new llama_context;
 
   if (params.seed < 0) {
     params.seed = time(NULL);
   }
 
   unsigned cur_percentage = 0;
   if (params.progress_callback == NULL) {
@@ -2441,37 +2832,31 @@
   }
 
   ctx->rng = std::mt19937(params.seed);
   ctx->logits_all = params.logits_all;
 
   ggml_type memory_type = params.f16_kv ? GGML_TYPE_F16 : GGML_TYPE_F32;
 
-  if (!falcon_model_load(
+  if (!llama_model_load(
           path_model, *ctx, params.n_ctx, params.n_batch, params.n_gpu_layers,
-          params.main_gpu, params.tensor_split, memory_type, params.use_mmap,
-          params.use_mlock, params.vocab_only, params.progress_callback,
-          params.progress_callback_user_data)) {
+          params.main_gpu, params.tensor_split, params.low_vram, memory_type,
+          params.use_mmap, params.use_mlock, params.vocab_only,
+          params.progress_callback, params.progress_callback_user_data)) {
     fprintf(stderr, "%s: failed to load model\n", __func__);
-    falcon_free(ctx);
+    llama_free(ctx);
     return nullptr;
   }
-  // model_load_internal() may change this if VRAM runs out
-  params.n_gpu_layers = ctx->model.n_gpu_layers;
-  params.i_gpu_start =
-      ctx->model.i_gpu_start;  // first layer that's GPU accelerated
-  params.i_gpu_last =
-      ctx->model.i_gpu_last;  // last layer that's GPU accelerated
 
   // reserve memory for context buffers
   if (!params.vocab_only) {
     if (!kv_cache_init(ctx->model.hparams, ctx->model.kv_self, memory_type,
                        ctx->model.hparams.n_ctx, params.n_gpu_layers)) {
       fprintf(stderr, "%s: kv_cache_init() failed for self-attention cache\n",
               __func__);
-      falcon_free(ctx);
+      llama_free(ctx);
       return nullptr;
     }
 
     const auto &hparams = ctx->model.hparams;
 
     // resized during inference
     if (params.logits_all) {
@@ -2480,80 +2865,88 @@
       ctx->logits.reserve(hparams.n_vocab);
     }
 
     if (params.embedding) {
       ctx->embedding.resize(hparams.n_embd);
     }
 
-    ctx->buf_compute.resize(FALCON_MEM_REQ_EVAL().at(ctx->model.type));
+    ctx->buf_compute.resize(MEM_REQ_EVAL().at(ctx->model.type));
 
-    ctx->buf_scratch[0].resize(FALCON_MEM_REQ_SCRATCH0().at(ctx->model.type));
-    ctx->buf_scratch[1].resize(FALCON_MEM_REQ_SCRATCH1().at(ctx->model.type));
+    ctx->buf_scratch[0].resize(MEM_REQ_SCRATCH0().at(ctx->model.type));
+    ctx->buf_scratch[1].resize(MEM_REQ_SCRATCH1().at(ctx->model.type));
   }
 
 #ifdef GGML_USE_METAL
   if (params.n_gpu_layers > 0) {
     // this allocates all Metal resources and memory buffers
     ctx->ctx_metal = ggml_metal_init();
 
     void *data_ptr = NULL;
     size_t data_size = 0;
+
     if (params.use_mmap) {
       data_ptr = ctx->model.mapping->addr;
       data_size = ctx->model.mapping->size;
     } else {
       data_ptr = ggml_get_mem_buffer(ctx->model.ctx);
       data_size = ggml_get_mem_size(ctx->model.ctx);
     }
 
+    const size_t max_size = ggml_get_max_tensor_size(ctx->model.ctx);
+
+    printf("%s: max tensor size = %8.2f MB\n", __func__,
+           max_size / 1024.0 / 1024.0);
+
 #define LLAMA_METAL_CHECK_BUF(result)                        \
   if (!(result)) {                                           \
     fprintf(stderr, "%s: failed to add buffer\n", __func__); \
-    falcon_free(ctx);                                        \
+    llama_free(ctx);                                         \
     return NULL;                                             \
   }
 
+    LLAMA_METAL_CHECK_BUF(ggml_metal_add_buffer(ctx->ctx_metal, "data",
+                                                data_ptr, data_size, max_size));
+
+    LLAMA_METAL_CHECK_BUF(ggml_metal_add_buffer(ctx->ctx_metal, "eval",
+                                                ctx->buf_compute.addr,
+                                                ctx->buf_compute.size, 0));
     LLAMA_METAL_CHECK_BUF(
-        ggml_metal_add_buffer(ctx->ctx_metal, "data", data_ptr, data_size));
-    LLAMA_METAL_CHECK_BUF(ggml_metal_add_buffer(
-        ctx->ctx_metal, "eval", ctx->buf_compute.addr, ctx->buf_compute.size));
-
-    LLAMA_METAL_CHECK_BUF(ggml_metal_add_buffer(ctx->ctx_metal, "kv",
-                                                ctx->model.kv_self.buf.addr,
-                                                ctx->model.kv_self.buf.size));
+        ggml_metal_add_buffer(ctx->ctx_metal, "kv", ctx->model.kv_self.buf.addr,
+                              ctx->model.kv_self.buf.size, 0));
+
     LLAMA_METAL_CHECK_BUF(ggml_metal_add_buffer(ctx->ctx_metal, "scr0",
                                                 ctx->buf_scratch[0].addr,
-                                                ctx->buf_scratch[0].size));
+                                                ctx->buf_scratch[0].size, 0));
     LLAMA_METAL_CHECK_BUF(ggml_metal_add_buffer(ctx->ctx_metal, "scr1",
                                                 ctx->buf_scratch[1].addr,
-                                                ctx->buf_scratch[1].size));
+                                                ctx->buf_scratch[1].size, 0));
 #undef LLAMA_METAL_CHECK_BUF
   }
 #endif
 
   return ctx;
 }
 
-void falcon_free(struct falcon_context *ctx) { delete ctx; }
+void llama_free(struct llama_context *ctx) { delete ctx; }
 
-int falcon_model_quantize(const char *fname_inp, const char *fname_out,
-                          const falcon_model_quantize_params *params) {
+int llama_model_quantize(const char *fname_inp, const char *fname_out,
+                         const llama_model_quantize_params *params) {
   try {
-    falcon_model_quantize_internal(fname_inp, fname_out, params);
+    llama_model_quantize_internal(fname_inp, fname_out, params);
     return 0;
   } catch (const std::exception &err) {
     fprintf(stderr, "%s: failed to quantize: %s\n", __func__, err.what());
     return 1;
   }
 }
 
-int falcon_apply_lora_from_file_internal(struct falcon_context *ctx,
-                                         const char *path_lora,
-                                         const char *path_base_model,
-                                         int n_threads) {
+int llama_apply_lora_from_file_internal(struct llama_context *ctx,
+                                        const char *path_lora,
+                                        const char *path_base_model,
+                                        int n_threads) {
   fprintf(stderr, "%s: applying lora adapter from '%s' - please wait ...\n",
           __func__, path_lora);
 
   auto &model = ctx->model;
 
   const int64_t t_start_lora_us = ggml_time_us();
 
@@ -2603,21 +2996,21 @@
   // create a name -> tensor map of the model to accelerate lookups
   std::unordered_map<std::string, struct ggml_tensor *> model_tensors;
   for (auto &kv : model.tensors_by_name) {
     model_tensors.insert(kv);
   }
 
   // load base model
-  std::unique_ptr<falcon_model_loader> model_loader;
+  std::unique_ptr<llama_model_loader> model_loader;
   ggml_context *base_ctx = NULL;
   llama_buffer base_buf;
   if (path_base_model) {
     fprintf(stderr, "%s: loading base model from '%s'\n", __func__,
             path_base_model);
-    model_loader.reset(new falcon_model_loader(
+    model_loader.reset(new llama_model_loader(
         path_base_model, /*use_mmap*/ true, /*vocab_only*/ false));
 
     size_t ctx_size;
     size_t mmapped_size;
     model_loader->calc_sizes(&ctx_size, &mmapped_size);
     base_buf.resize(ctx_size);
 
@@ -2626,15 +3019,15 @@
     base_params.mem_buffer = base_buf.addr;
     base_params.no_alloc = model_loader->use_mmap;
 
     base_ctx = ggml_init(base_params);
 
     model_loader->ggml_ctx = base_ctx;
 
-    // maybe this should in falcon_model_loader
+    // maybe this should in llama_model_loader
     if (model_loader->use_mmap) {
       model_loader->mapping.reset(new llama_mmap(
           &model_loader->file_loaders.at(0)->file, /* prefetch */ 0));
     }
   }
 
   // read tensors and apply
@@ -2805,42 +3198,41 @@
 
   const int64_t t_lora_us = ggml_time_us() - t_start_lora_us;
   fprintf(stderr, " done (%.2f ms)\n", t_lora_us / 1000.0);
 
   return 0;
 }
 
-int falcon_apply_lora_from_file(struct falcon_context *ctx,
-                                const char *path_lora,
-                                const char *path_base_model, int n_threads) {
+int llama_apply_lora_from_file(struct llama_context *ctx, const char *path_lora,
+                               const char *path_base_model, int n_threads) {
   try {
-    return falcon_apply_lora_from_file_internal(ctx, path_lora, path_base_model,
-                                                n_threads);
+    return llama_apply_lora_from_file_internal(ctx, path_lora, path_base_model,
+                                               n_threads);
   } catch (const std::exception &err) {
     fprintf(stderr, "%s: failed to apply lora adapter: %s\n", __func__,
             err.what());
     return 1;
   }
 }
 
-int falcon_get_kv_cache_token_count(const struct falcon_context *ctx) {
+int llama_get_kv_cache_token_count(const struct llama_context *ctx) {
   return ctx->model.kv_self.n;
 }
 
 #define LLAMA_MAX_RNG_STATE (64 * 1024)
 
-void falcon_set_rng_seed(struct falcon_context *ctx, int seed) {
+void llama_set_rng_seed(struct llama_context *ctx, int seed) {
   if (seed < 0) {
     seed = time(NULL);
   }
   ctx->rng.seed(seed);
 }
 
 // Returns the *maximum* size of the state
-size_t falcon_get_state_size(const struct falcon_context *ctx) {
+size_t llama_get_state_size(const struct llama_context *ctx) {
   // we don't know size of rng until we actually serialize it. so reserve more
   // than enough memory for its serialized state. for reference,
   // std::mt19937(1337) serializes to 6701 bytes.
   const size_t s_rng_size = sizeof(size_t);
   const size_t s_rng = LLAMA_MAX_RNG_STATE;
   const size_t s_logits_capacity = sizeof(size_t);
   const size_t s_logits_size = sizeof(size_t);
@@ -2855,15 +3247,15 @@
       (+s_rng_size + s_rng + s_logits_capacity + s_logits_size + s_logits +
        s_embedding_size + s_embedding + s_kv_size + s_kv_ntok + s_kv);
 
   return s_total;
 }
 
 // Copies the state to the specified destination address
-size_t falcon_copy_state_data(struct falcon_context *ctx, uint8_t *dst) {
+size_t llama_copy_state_data(struct llama_context *ctx, uint8_t *dst) {
   uint8_t *out = dst;
 
   // copy rng
   {
     std::stringstream rng_ss;
     rng_ss << ctx->rng;
 
@@ -2914,15 +3306,15 @@
     const auto &kv_self = ctx->model.kv_self;
     const auto &hparams = ctx->model.hparams;
     const int n_layer = hparams.n_layer;
     const int n_embd = hparams.n_embd;
     const int n_ctx = hparams.n_ctx;
 
     const size_t kv_size = kv_self.buf.size;
-    const int kv_ntok = falcon_get_kv_cache_token_count(ctx);
+    const int kv_ntok = llama_get_kv_cache_token_count(ctx);
 
     memcpy(out, &kv_size, sizeof(kv_size));
     out += sizeof(kv_size);
     memcpy(out, &kv_ntok, sizeof(kv_ntok));
     out += sizeof(kv_ntok);
 
     if (kv_size) {
@@ -2958,23 +3350,23 @@
       ggml_graph_compute(cpy_ctx, &gf);
 
       ggml_free(cpy_ctx);
     }
   }
 
   const size_t written = out - dst;
-  const size_t max_size = falcon_get_state_size(ctx);
+  const size_t max_size = llama_get_state_size(ctx);
 
   LLAMA_ASSERT(written <= max_size);
 
   return written;
 }
 
 // Sets the state reading from the specified source address
-size_t falcon_set_state_data(struct falcon_context *ctx, uint8_t *src) {
+size_t llama_set_state_data(struct llama_context *ctx, uint8_t *src) {
   uint8_t *inp = src;
 
   // set rng
   {
     size_t rng_size;
     char rng_buf[LLAMA_MAX_RNG_STATE];
 
@@ -3078,41 +3470,41 @@
       ggml_free(cpy_ctx);
     }
 
     ctx->model.kv_self.n = kv_ntok;
   }
 
   const size_t nread = inp - src;
-  const size_t max_size = falcon_get_state_size(ctx);
+  const size_t max_size = llama_get_state_size(ctx);
 
   LLAMA_ASSERT(nread <= max_size);
 
   return nread;
 }
 
-bool falcon_load_session_file(struct falcon_context *ctx,
-                              const char *path_session, llama_token *tokens_out,
-                              size_t n_token_capacity,
-                              size_t *n_token_count_out) {
+bool llama_load_session_file(struct llama_context *ctx,
+                             const char *path_session, llama_token *tokens_out,
+                             size_t n_token_capacity,
+                             size_t *n_token_count_out) {
   llama_file file(path_session, "rb");
 
   // sanity checks
   {
     const uint32_t magic = file.read_u32();
     const uint32_t version = file.read_u32();
 
     if (magic != LLAMA_SESSION_MAGIC || version != LLAMA_SESSION_VERSION) {
       fprintf(stderr,
               "%s : unknown (magic, version) for session file: %08x, %08x\n",
               __func__, magic, version);
       return false;
     }
 
-    falcon_hparams session_hparams;
-    file.read_raw(&session_hparams, sizeof(falcon_hparams));
+    llama_hparams session_hparams;
+    file.read_raw(&session_hparams, sizeof(llama_hparams));
 
     if (session_hparams != ctx->model.hparams) {
       fprintf(stderr, "%s : model hparams didn't match from session file!\n",
               __func__);
       return false;
     }
   }
@@ -3131,190 +3523,193 @@
     file.read_raw(tokens_out, sizeof(llama_token) * n_token_count);
     *n_token_count_out = n_token_count;
   }
 
   // restore the context state
   {
     const size_t n_state_size_cur = file.size - file.tell();
-    const size_t n_state_size_max = falcon_get_state_size(ctx);
+    const size_t n_state_size_max = llama_get_state_size(ctx);
 
     if (n_state_size_cur > n_state_size_max) {
       fprintf(
           stderr,
           "%s : the state size in session file is too big! max %zu, got %zu\n",
           __func__, n_state_size_max, n_state_size_cur);
       return false;
     }
 
     std::vector<uint8_t> state_data(n_state_size_max);
     file.read_raw(state_data.data(), n_state_size_cur);
 
-    falcon_set_state_data(ctx, state_data.data());
+    llama_set_state_data(ctx, state_data.data());
   }
 
   return true;
 }
 
-bool falcon_save_session_file(struct falcon_context *ctx,
-                              const char *path_session,
-                              const llama_token *tokens, size_t n_token_count) {
+bool llama_save_session_file(struct llama_context *ctx,
+                             const char *path_session,
+                             const llama_token *tokens, size_t n_token_count) {
   llama_file file(path_session, "wb");
 
   file.write_u32(LLAMA_SESSION_MAGIC);
   file.write_u32(LLAMA_SESSION_VERSION);
 
-  file.write_raw(&ctx->model.hparams, sizeof(falcon_hparams));
+  file.write_raw(&ctx->model.hparams, sizeof(llama_hparams));
 
   // save the prompt
   file.write_u32((uint32_t)n_token_count);
   file.write_raw(tokens, sizeof(llama_token) * n_token_count);
 
   // save the context state
   {
-    const size_t n_state_size_max = falcon_get_state_size(ctx);
+    const size_t n_state_size_max = llama_get_state_size(ctx);
 
     std::vector<uint8_t> state_data(n_state_size_max);
     const size_t n_state_size_cur =
-        falcon_copy_state_data(ctx, state_data.data());
+        llama_copy_state_data(ctx, state_data.data());
 
     file.write_raw(state_data.data(), n_state_size_cur);
   }
 
   return true;
 }
 
-int falcon_eval(struct falcon_context *ctx, const llama_token *tokens,
-                int n_tokens, int n_past, int n_threads, int debug_timings) {
-  if (!falcon_eval_internal(*ctx, tokens, n_tokens, n_past, n_threads, nullptr,
-                            debug_timings)) {
+int llama_eval(struct llama_context *ctx, const llama_token *tokens,
+               int n_tokens, int n_past, int n_threads) {
+  if (!llama_eval_internal(*ctx, tokens, n_tokens, n_past, n_threads,
+                           nullptr)) {
     fprintf(stderr, "%s: failed to eval\n", __func__);
     return 1;
   }
 
   // get a more accurate load time, upon first eval
   // TODO: fix this
   if (!ctx->has_evaluated_once) {
     ctx->t_load_us = ggml_time_us() - ctx->t_start_us;
     ctx->has_evaluated_once = true;
   }
 
   return 0;
 }
 
-int falcon_eval_export(struct falcon_context *ctx, const char *fname) {
+int llama_eval_export(struct llama_context *ctx, const char *fname) {
   const int n_batch = 1;
   const int n_ctx = 512 - n_batch;
 
-  const std::vector<llama_token> tmp(n_batch, falcon_token_bos());
+  const std::vector<llama_token> tmp(n_batch, llama_token_bos());
 
-  if (!falcon_eval_internal(*ctx, tmp.data(), tmp.size(), n_ctx, 1, fname, 0)) {
+  if (!llama_eval_internal(*ctx, tmp.data(), tmp.size(), n_ctx, 1, fname)) {
     fprintf(stderr, "%s: failed to eval\n", __func__);
     return 1;
   }
 
   return 0;
 }
 
-int falcon_tokenize(struct falcon_context *ctx, const char *text,
-                    llama_token *tokens, int n_max_tokens, bool add_bos) {
-  auto res = falcon_tokenize(ctx->vocab, text, add_bos);
+int llama_tokenize(struct llama_context *ctx, const char *text,
+                   llama_token *tokens, int n_max_tokens, bool add_bos) {
+  auto res = llama_tokenize(ctx->vocab, text, add_bos);
 
   if (n_max_tokens < (int)res.size()) {
     fprintf(stderr, "%s: too many tokens\n", __func__);
     return -((int)res.size());
   }
 
   for (size_t i = 0; i < res.size(); i++) {
     tokens[i] = res[i];
   }
 
   return res.size();
 }
 
-int falcon_n_vocab(const struct falcon_context *ctx) {
+int llama_n_vocab(const struct llama_context *ctx) {
   return ctx->vocab.id_to_token.size();
 }
 
-int falcon_n_ctx(const struct falcon_context *ctx) {
+int llama_n_ctx(const struct llama_context *ctx) {
   return ctx->model.hparams.n_ctx;
 }
 
-int falcon_n_embd(const struct falcon_context *ctx) {
+int llama_n_embd(const struct llama_context *ctx) {
   return ctx->model.hparams.n_embd;
 }
 
-int falcon_get_vocab(const struct falcon_context *ctx, const char **strings,
-                     float *scores, int capacity) {
+int llama_get_vocab(const struct llama_context *ctx, const char **strings,
+                    float *scores, int capacity) {
   int n = std::min(capacity, (int)ctx->vocab.id_to_token.size());
   for (int i = 0; i < n; ++i) {
     strings[i] = ctx->vocab.id_to_token[i].tok.c_str();
     scores[i] = ctx->vocab.id_to_token[i].score;
   }
   return n;
 }
 
-float *falcon_get_logits(struct falcon_context *ctx) {
+float *llama_get_logits(struct llama_context *ctx) {
   return ctx->logits.data();
 }
 
-float *falcon_get_embeddings(struct falcon_context *ctx) {
+float *llama_get_embeddings(struct llama_context *ctx) {
   return ctx->embedding.data();
 }
 
-const char *falcon_token_to_str(const struct falcon_context *ctx,
-                                llama_token token) {
-  if (token >= falcon_n_vocab(ctx)) {
+const char *llama_token_to_str(const struct llama_context *ctx,
+                               llama_token token) {
+  if (token >= llama_n_vocab(ctx)) {
     return nullptr;
   }
 
   return ctx->vocab.id_to_token[token].tok.c_str();
 }
 
-llama_token falcon_token_bos() { return 11; }
-
-llama_token falcon_token_eos() { return 11; }
+llama_token llama_token_bos() { return 1; }
 
-llama_token falcon_token_nl() { return 193; }
+llama_token llama_token_eos() { return 2; }
 
-llama_token falcon_token_cr() { return 195; }
+llama_token llama_token_nl() { return 13; }
 
-void falcon_print_timings(struct falcon_context *ctx) {
+void llama_print_timings(struct llama_context *ctx) {
   const int64_t t_end_us = ggml_time_us();
 
   const int32_t n_sample = std::max(1, ctx->n_sample);
   const int32_t n_eval = std::max(1, ctx->n_eval);
   const int32_t n_p_eval = std::max(1, ctx->n_p_eval);
 
   fprintf(stderr, "\n");
   fprintf(stderr, "%s:        load time = %8.2f ms\n", __func__,
           ctx->t_load_us / 1000.0);
   fprintf(stderr,
-          "%s:      sample time = %8.2f ms / %5d runs   (%8.2f ms per token)\n",
+          "%s:      sample time = %8.2f ms / %5d runs   (%8.2f ms per token, "
+          "%8.2f tokens per second)\n",
           __func__, 1e-3 * ctx->t_sample_us, n_sample,
-          1e-3 * ctx->t_sample_us / n_sample);
+          1e-3 * ctx->t_sample_us / n_sample,
+          1e6 / ctx->t_sample_us * n_sample);
   fprintf(stderr,
-          "%s: prompt eval time = %8.2f ms / %5d tokens (%8.2f ms per token)\n",
+          "%s: prompt eval time = %8.2f ms / %5d tokens (%8.2f ms per token, "
+          "%8.2f tokens per second)\n",
           __func__, 1e-3 * ctx->t_p_eval_us, n_p_eval,
-          1e-3 * ctx->t_p_eval_us / n_p_eval);
+          1e-3 * ctx->t_p_eval_us / n_p_eval,
+          1e6 / ctx->t_p_eval_us * n_p_eval);
   fprintf(stderr,
-          "%s:        eval time = %8.2f ms / %5d runs   (%8.2f ms per token)\n",
+          "%s:        eval time = %8.2f ms / %5d runs   (%8.2f ms per token, "
+          "%8.2f tokens per second)\n",
           __func__, 1e-3 * ctx->t_eval_us, n_eval,
-          1e-3 * ctx->t_eval_us / n_eval);
+          1e-3 * ctx->t_eval_us / n_eval, 1e6 / ctx->t_eval_us * n_eval);
   fprintf(stderr, "%s:       total time = %8.2f ms\n", __func__,
           (t_end_us - ctx->t_start_us) / 1000.0);
 }
 
-void falcon_reset_timings(struct falcon_context *ctx) {
+void llama_reset_timings(struct llama_context *ctx) {
   ctx->t_start_us = ggml_time_us();
   ctx->t_sample_us = ctx->n_sample = 0;
   ctx->t_eval_us = ctx->n_eval = 0;
   ctx->t_p_eval_us = ctx->n_p_eval = 0;
 }
 
-const char *falcon_print_system_info(void) {
+const char *llama_print_system_info(void) {
   static std::string s;
 
   s = "";
   s += "AVX = " + std::to_string(ggml_cpu_has_avx()) + " | ";
   s += "AVX2 = " + std::to_string(ggml_cpu_has_avx2()) + " | ";
   s += "AVX512 = " + std::to_string(ggml_cpu_has_avx512()) + " | ";
   s += "AVX512_VBMI = " + std::to_string(ggml_cpu_has_avx512_vbmi()) + " | ";
@@ -3330,10 +3725,10 @@
   s += "VSX = " + std::to_string(ggml_cpu_has_vsx()) + " | ";
 
   return s.c_str();
 }
 
 // For internal test use
 std::vector<std::pair<std::string, struct ggml_tensor *>>
-    &llama_internal_get_tensor_map(struct falcon_context *ctx) {
+    &llama_internal_get_tensor_map(struct llama_context *ctx) {
   return ctx->model.tensors_by_name;
 }
```

### Comparing `ctransformers-langdash-0.2.11/models/ggml/libfalcon.h` & `ctransformers-langdash-0.2.9/models/ggml/llama.h`

 * *Files 22% similar despite different names*

```diff
@@ -1,334 +1,318 @@
-#ifndef FALCON_H
-#define FALCON_H
+#ifndef LLAMA_H
+#define LLAMA_H
 
 #include "ggml.h"
 #ifdef GGML_USE_CUBLAS
 #include "ggml-cuda.h"
 #define LLAMA_MAX_DEVICES GGML_CUDA_MAX_DEVICES
 #else
 #define LLAMA_MAX_DEVICES 1
-#endif  // GGML_USE_CUBLAS
-#include <stdbool.h>
+#endif // GGML_USE_CUBLAS
 #include <stddef.h>
 #include <stdint.h>
+#include <stdbool.h>
 
 #ifdef LLAMA_SHARED
-#if defined(_WIN32) && !defined(__MINGW32__)
-#ifdef LLAMA_BUILD
-#define LLAMA_API __declspec(dllexport)
+#    if defined(_WIN32) && !defined(__MINGW32__)
+#        ifdef LLAMA_BUILD
+#            define LLAMA_API __declspec(dllexport)
+#        else
+#            define LLAMA_API __declspec(dllimport)
+#        endif
+#    else
+#        define LLAMA_API __attribute__ ((visibility ("default")))
+#    endif
 #else
-#define LLAMA_API __declspec(dllimport)
-#endif
-#else
-#define LLAMA_API __attribute__((visibility("default")))
-#endif
-#else
-#define LLAMA_API
+#    define LLAMA_API
 #endif
 
-#define LLAMA_FILE_MAGIC_GGJT 0x67676a74u  // 'ggjt'
-#define LLAMA_FILE_MAGIC_GGLA 0x67676c61u  // 'ggla'
-#define LLAMA_FILE_MAGIC_GGMF 0x67676d66u  // 'ggmf'
-#define LLAMA_FILE_MAGIC_GGML 0x67676d6cu  // 'ggml'
-#define LLAMA_FILE_MAGIC_GGSN 0x6767736eu  // 'ggsn'
+#define LLAMA_FILE_MAGIC_GGJT        0x67676a74u // 'ggjt'
+#define LLAMA_FILE_MAGIC_GGLA        0x67676c61u // 'ggla'
+#define LLAMA_FILE_MAGIC_GGMF        0x67676d66u // 'ggmf'
+#define LLAMA_FILE_MAGIC_GGML        0x67676d6cu // 'ggml'
+#define LLAMA_FILE_MAGIC_GGSN        0x6767736eu // 'ggsn'
 
-#define LLAMA_FILE_VERSION 3
-#define LLAMA_FILE_MAGIC LLAMA_FILE_MAGIC_GGJT
+#define LLAMA_FILE_VERSION           3
+#define LLAMA_FILE_MAGIC             LLAMA_FILE_MAGIC_GGJT
 #define LLAMA_FILE_MAGIC_UNVERSIONED LLAMA_FILE_MAGIC_GGML
-#define LLAMA_SESSION_MAGIC LLAMA_FILE_MAGIC_GGSN
-#define LLAMA_SESSION_VERSION 1
+#define LLAMA_SESSION_MAGIC          LLAMA_FILE_MAGIC_GGSN
+#define LLAMA_SESSION_VERSION        1
 
-#if defined(GGML_USE_CUBLAS) || defined(GGML_USE_CLBLAST) || \
-    defined(GGML_USE_METAL)
-// Defined when llama.cpp is compiled with support for offloading model layers
-// to GPU.
+#if defined(GGML_USE_CUBLAS) || defined(GGML_USE_CLBLAST) || defined(GGML_USE_METAL)
+// Defined when llama.cpp is compiled with support for offloading model layers to GPU.
 #define LLAMA_SUPPORTS_GPU_OFFLOAD
 #endif
 
 #ifdef __cplusplus
 extern "C" {
 #endif
 
-//
-// C interface
-//
-// TODO: show sample usage
-//
-
-struct falcon_context;
-
-struct falcon_context_params {
-  int n_ctx;         // text context
-  int n_batch;       // prompt processing batch size
-  int n_gpu_layers;  // number of layers to store in VRAM
-  int i_gpu_start;   // first gpu layer
-  int i_gpu_last;    // last gpu layer
-  int main_gpu;      // the GPU that is used for scratch and small tensors
-  float tensor_split[LLAMA_MAX_DEVICES];  // how to split layers across multiple
-                                          // GPUs
-  int seed;                               // RNG seed, -1 for random
-
-  bool f16_kv;      // use fp16 for KV cache
-  bool logits_all;  // the llama_eval() call computes all logits, not just the
-                    // last one
-  bool vocab_only;  // only load the vocabulary, no weights
-  bool use_mmap;    // use mmap if possible
-  bool use_mlock;   // force system to keep model in RAM
-  bool embedding;   // embedding mode only
-
-  // called with a progress value between 0 and 1, pass NULL to disable
-  llama_progress_callback progress_callback;
-  // context pointer passed to the progress callback
-  void *progress_callback_user_data;
-};
-
-// model quantization parameters
-typedef struct falcon_model_quantize_params {
-  int nthread;  // number of threads to use for quantizing, if <=0 will use
-                // std::thread::hardware_concurrency()
-  enum llama_ftype ftype;       // quantize to this llama_ftype
-  bool allow_requantize;        // allow quantizing non-f32/f16 tensors
-  bool quantize_output_tensor;  // quantize output.weight
-} falcon_model_quantize_params;
-
-LLAMA_API struct falcon_context_params falcon_context_default_params();
-LLAMA_API struct falcon_model_quantize_params
-falcon_model_quantize_default_params();
-
-// Various functions for loading a ggml llama model.
-// Allocate (almost) all memory needed for the model.
-// Return NULL on failure
-LLAMA_API struct falcon_context *falcon_init_from_file(
-    const char *path_model, struct falcon_context_params params);
-
-// Frees all allocated memory
-LLAMA_API void falcon_free(struct falcon_context *ctx);
-
-// Returns 0 on success
-LLAMA_API int falcon_model_quantize(const char *fname_inp,
-                                    const char *fname_out,
-                                    const falcon_model_quantize_params *params);
-
-// Apply a LoRA adapter to a loaded model
-// path_base_model is the path to a higher quality model to use as a base for
-// the layers modified by the adapter. Can be NULL to use the current loaded
-// model. The model needs to be reloaded before applying a new adapter,
-// otherwise the adapter will be applied on top of the previous one Returns 0 on
-// success
-LLAMA_API int falcon_apply_lora_from_file(struct falcon_context *ctx,
-                                          const char *path_lora,
-                                          const char *path_base_model,
-                                          int n_threads);
-
-// Returns the number of tokens in the KV cache
-LLAMA_API int falcon_get_kv_cache_token_count(const struct falcon_context *ctx);
-
-// Sets the current rng seed.
-LLAMA_API void falcon_set_rng_seed(struct falcon_context *ctx, int seed);
-
-// Returns the maximum size in bytes of the state (rng, logits, embedding
-// and kv_cache) - will often be smaller after compacting tokens
-LLAMA_API size_t falcon_get_state_size(const struct falcon_context *ctx);
-
-// Copies the state to the specified destination address.
-// Destination needs to have allocated enough memory.
-// Returns the number of bytes copied
-LLAMA_API size_t falcon_copy_state_data(struct falcon_context *ctx,
-                                        uint8_t *dst);
-
-// Set the state reading from the specified address
-// Returns the number of bytes read
-LLAMA_API size_t falcon_set_state_data(struct falcon_context *ctx,
-                                       uint8_t *src);
-
-// Save/load session file
-LLAMA_API bool falcon_load_session_file(struct falcon_context *ctx,
-                                        const char *path_session,
-                                        llama_token *tokens_out,
-                                        size_t n_token_capacity,
-                                        size_t *n_token_count_out);
-LLAMA_API bool falcon_save_session_file(struct falcon_context *ctx,
-                                        const char *path_session,
-                                        const llama_token *tokens,
-                                        size_t n_token_count);
-
-// Run the llama inference to obtain the logits and probabilities for the next
-// token. tokens + n_tokens is the provided batch of new tokens to process
-// n_past is the number of tokens to use from previous eval calls
-// Returns 0 on success
-LLAMA_API int falcon_eval(struct falcon_context *ctx, const llama_token *tokens,
-                          int n_tokens, int n_past, int n_threads,
-                          int debug_timings);
-
-// Export a static computation graph for context of 511 and batch size of 1
-// NOTE: since this functionality is mostly for debugging and demonstration
-// purposes, we hardcode these
-//       parameters here to keep things simple
-// IMPORTANT: do not use for anything else other than debugging and testing!
-LLAMA_API int falcon_eval_export(struct falcon_context *ctx, const char *fname);
-
-// Convert the provided text into tokens.
-// The tokens pointer must be large enough to hold the resulting tokens.
-// Returns the number of tokens on success, no more than n_max_tokens
-// Returns a negative number on failure - the number of tokens that would have
-// been returned
-// TODO: not sure if correct
-LLAMA_API int falcon_tokenize(struct falcon_context *ctx, const char *text,
-                              llama_token *tokens, int n_max_tokens,
-                              bool add_bos);
-
-LLAMA_API int falcon_n_vocab(const struct falcon_context *ctx);
-LLAMA_API int falcon_n_ctx(const struct falcon_context *ctx);
-LLAMA_API int falcon_n_embd(const struct falcon_context *ctx);
-
-// Get the vocabulary as output parameters.
-// Returns number of results.
-LLAMA_API int falcon_get_vocab(const struct falcon_context *ctx,
-                               const char **strings, float *scores,
-                               int capacity);
-
-// Token logits obtained from the last call to llama_eval()
-// The logits for the last token are stored in the last row
-// Can be mutated in order to change the probabilities of the next token
-// Rows: n_tokens
-// Cols: n_vocab
-LLAMA_API float *falcon_get_logits(struct falcon_context *ctx);
-
-// Get the embeddings for the input
-// shape: [n_embd] (1-dimensional)
-LLAMA_API float *falcon_get_embeddings(struct falcon_context *ctx);
-
-// Token Id -> String. Uses the vocabulary in the provided context
-LLAMA_API const char *falcon_token_to_str(const struct falcon_context *ctx,
-                                          llama_token token);
-
-// Special tokens
-LLAMA_API llama_token falcon_token_bos();
-LLAMA_API llama_token falcon_token_eos();
-LLAMA_API llama_token falcon_token_nl();
-
-// Sampling functions
-
-/// @details Repetition penalty described in CTRL academic paper
-/// https://arxiv.org/abs/1909.05858, with negative logit fix.
-LLAMA_API void falcon_sample_repetition_penalty(
-    struct falcon_context *ctx, llama_token_data_array *candidates,
-    const llama_token *last_tokens, size_t last_tokens_size, float penalty);
-
-/// @details Frequency and presence penalties described in OpenAI API
-/// https://platform.openai.com/docs/api-reference/parameter-details.
-LLAMA_API void falcon_sample_frequency_and_presence_penalties(
-    struct falcon_context *ctx, llama_token_data_array *candidates,
-    const llama_token *last_tokens, size_t last_tokens_size,
-    float alpha_frequency, float alpha_presence);
-
-/// @details Sorts candidate tokens by their logits in descending order and
-/// calculate probabilities based on logits.
-LLAMA_API void falcon_sample_softmax(struct falcon_context *ctx,
-                                     llama_token_data_array *candidates);
-
-/// @details Top-K sampling described in academic paper "The Curious Case of
-/// Neural Text Degeneration" https://arxiv.org/abs/1904.09751
-LLAMA_API void falcon_sample_top_k(struct falcon_context *ctx,
-                                   llama_token_data_array *candidates, int k,
-                                   size_t min_keep);
-
-/// @details Nucleus sampling described in academic paper "The Curious Case of
-/// Neural Text Degeneration" https://arxiv.org/abs/1904.09751
-LLAMA_API void falcon_sample_top_p(struct falcon_context *ctx,
-                                   llama_token_data_array *candidates, float p,
-                                   size_t min_keep);
-
-/// @details Tail Free Sampling described in
-/// https://www.trentonbricken.com/Tail-Free-Sampling/.
-LLAMA_API void falcon_sample_tail_free(struct falcon_context *ctx,
-                                       llama_token_data_array *candidates,
-                                       float z, size_t min_keep);
-
-/// @details Locally Typical Sampling implementation described in the paper
-/// https://arxiv.org/abs/2202.00666.
-LLAMA_API void falcon_sample_typical(struct falcon_context *ctx,
-                                     llama_token_data_array *candidates,
-                                     float p, size_t min_keep);
-LLAMA_API void falcon_sample_temperature(struct falcon_context *ctx,
-                                         llama_token_data_array *candidates,
-                                         float temp);
-
-/// @details Mirostat 1.0 algorithm described in the paper
-/// https://arxiv.org/abs/2007.14966. Uses tokens instead of words.
-/// @param candidates A vector of `llama_token_data` containing the candidate
-/// tokens, their probabilities (p), and log-odds (logit) for the current
-/// position in the generated text.
-/// @param tau  The target cross-entropy (or surprise) value you want to achieve
-/// for the generated text. A higher value corresponds to more surprising or
-/// less predictable text, while a lower value corresponds to less surprising or
-/// more predictable text.
-/// @param eta The learning rate used to update `mu` based on the error between
-/// the target and observed surprisal of the sampled word. A larger learning
-/// rate will cause `mu` to be updated more quickly, while a smaller learning
-/// rate will result in slower updates.
-/// @param m The number of tokens considered in the estimation of `s_hat`. This
-/// is an arbitrary value that is used to calculate `s_hat`, which in turn helps
-/// to calculate the value of `k`. In the paper, they use `m = 100`, but you can
-/// experiment with different values to see how it affects the performance of
-/// the algorithm.
-/// @param mu Maximum cross-entropy. This value is initialized to be twice the
-/// target cross-entropy (`2 * tau`) and is updated in the algorithm based on
-/// the error between the target and observed surprisal.
-LLAMA_API llama_token falcon_sample_token_mirostat(
-    struct falcon_context *ctx, llama_token_data_array *candidates, float tau,
-    float eta, int m, float *mu);
-
-/// @details Mirostat 2.0 algorithm described in the paper
-/// https://arxiv.org/abs/2007.14966. Uses tokens instead of words.
-/// @param candidates A vector of `llama_token_data` containing the candidate
-/// tokens, their probabilities (p), and log-odds (logit) for the current
-/// position in the generated text.
-/// @param tau  The target cross-entropy (or surprise) value you want to achieve
-/// for the generated text. A higher value corresponds to more surprising or
-/// less predictable text, while a lower value corresponds to less surprising or
-/// more predictable text.
-/// @param eta The learning rate used to update `mu` based on the error between
-/// the target and observed surprisal of the sampled word. A larger learning
-/// rate will cause `mu` to be updated more quickly, while a smaller learning
-/// rate will result in slower updates.
-/// @param mu Maximum cross-entropy. This value is initialized to be twice the
-/// target cross-entropy (`2 * tau`) and is updated in the algorithm based on
-/// the error between the target and observed surprisal.
-LLAMA_API llama_token falcon_sample_token_mirostat_v2(
-    struct falcon_context *ctx, llama_token_data_array *candidates, float tau,
-    float eta, float *mu);
-
-/// @details Selects the token with the highest probability.
-LLAMA_API llama_token falcon_sample_token_greedy(
-    struct falcon_context *ctx, llama_token_data_array *candidates);
-
-/// @details Randomly selects a token from the candidates based on their
-/// probabilities.
-LLAMA_API llama_token falcon_sample_token(struct falcon_context *ctx,
-                                          llama_token_data_array *candidates);
-
-// Performance information
-LLAMA_API void falcon_print_timings(struct falcon_context *ctx);
-LLAMA_API void falcon_reset_timings(struct falcon_context *ctx);
+    //
+    // C interface
+    //
+    // TODO: show sample usage
+    //
+
+    struct llama_context;
+
+    typedef int llama_token;
+
+    typedef struct llama_token_data {
+        llama_token id; // token id
+        float logit;    // log-odds of the token
+        float p;        // probability of the token
+    } llama_token_data;
+
+    typedef struct llama_token_data_array {
+        llama_token_data * data;
+        size_t size;
+        bool sorted;
+    } llama_token_data_array;
+
+    typedef void (*llama_progress_callback)(float progress, void *ctx);
+
+    struct llama_context_params {
+        int n_ctx;                             // text context
+        int n_batch;                           // prompt processing batch size
+        int n_gpu_layers;                      // number of layers to store in VRAM
+        int main_gpu;                          // the GPU that is used for scratch and small tensors
+        float tensor_split[LLAMA_MAX_DEVICES]; // how to split layers across multiple GPUs
+        bool low_vram;                         // if true, reduce VRAM usage at the cost of performance
+        int seed;                              // RNG seed, -1 for random
+
+        bool f16_kv;     // use fp16 for KV cache
+        bool logits_all; // the llama_eval() call computes all logits, not just the last one
+        bool vocab_only; // only load the vocabulary, no weights
+        bool use_mmap;   // use mmap if possible
+        bool use_mlock;  // force system to keep model in RAM
+        bool embedding;  // embedding mode only
+
+        // called with a progress value between 0 and 1, pass NULL to disable
+        llama_progress_callback progress_callback;
+        // context pointer passed to the progress callback
+        void * progress_callback_user_data;
+    };
+
+    // model file types
+    enum llama_ftype {
+        LLAMA_FTYPE_ALL_F32              = 0,
+        LLAMA_FTYPE_MOSTLY_F16           = 1, // except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q4_0          = 2, // except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q4_1          = 3, // except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q4_1_SOME_F16 = 4, // tok_embeddings.weight and output.weight are F16
+        // LLAMA_FTYPE_MOSTLY_Q4_2       = 5, // support has been removed
+        // LLAMA_FTYPE_MOSTLY_Q4_3       = 6, // support has been removed
+        LLAMA_FTYPE_MOSTLY_Q8_0          = 7, // except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q5_0          = 8, // except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q5_1          = 9, // except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q2_K          = 10,// except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q3_K_S        = 11,// except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q3_K_M        = 12,// except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q3_K_L        = 13,// except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q4_K_S        = 14,// except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q4_K_M        = 15,// except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q5_K_S        = 16,// except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q5_K_M        = 17,// except 1d tensors
+        LLAMA_FTYPE_MOSTLY_Q6_K          = 18,// except 1d tensors
+    };
+
+    // model quantization parameters
+    typedef struct llama_model_quantize_params {
+        int nthread;                 // number of threads to use for quantizing, if <=0 will use std::thread::hardware_concurrency()
+        enum llama_ftype   ftype;    // quantize to this llama_ftype
+        bool allow_requantize;       // allow quantizing non-f32/f16 tensors
+        bool quantize_output_tensor; // quantize output.weight
+    } llama_model_quantize_params;
+
+    LLAMA_API struct llama_context_params llama_context_default_params();
+    LLAMA_API struct llama_model_quantize_params llama_model_quantize_default_params();
+
+    LLAMA_API bool llama_mmap_supported();
+    LLAMA_API bool llama_mlock_supported();
+
+    // TODO: not great API - very likely to change
+    // Initialize the llama + ggml backend
+    // Call once at the start of the program
+    LLAMA_API void llama_init_backend();
+
+    LLAMA_API int64_t llama_time_us();
+
+    // Various functions for loading a ggml llama model.
+    // Allocate (almost) all memory needed for the model.
+    // Return NULL on failure
+    LLAMA_API struct llama_context * llama_init_from_file(
+                             const char * path_model,
+            struct llama_context_params   params);
+
+    // Frees all allocated memory
+    LLAMA_API void llama_free(struct llama_context * ctx);
+
+    // Returns 0 on success
+    LLAMA_API int llama_model_quantize(
+            const char * fname_inp,
+            const char * fname_out,
+            const llama_model_quantize_params * params);
+
+    // Apply a LoRA adapter to a loaded model
+    // path_base_model is the path to a higher quality model to use as a base for
+    // the layers modified by the adapter. Can be NULL to use the current loaded model.
+    // The model needs to be reloaded before applying a new adapter, otherwise the adapter
+    // will be applied on top of the previous one
+    // Returns 0 on success
+    LLAMA_API int llama_apply_lora_from_file(
+            struct llama_context * ctx,
+                      const char * path_lora,
+                      const char * path_base_model,
+                             int   n_threads);
+
+    // Returns the number of tokens in the KV cache
+    LLAMA_API int llama_get_kv_cache_token_count(const struct llama_context * ctx);
+
+    // Sets the current rng seed.
+    LLAMA_API void llama_set_rng_seed(struct llama_context * ctx, int seed);
+
+    // Returns the maximum size in bytes of the state (rng, logits, embedding
+    // and kv_cache) - will often be smaller after compacting tokens
+    LLAMA_API size_t llama_get_state_size(const struct llama_context * ctx);
+
+    // Copies the state to the specified destination address.
+    // Destination needs to have allocated enough memory.
+    // Returns the number of bytes copied
+    LLAMA_API size_t llama_copy_state_data(struct llama_context * ctx, uint8_t * dst);
+
+    // Set the state reading from the specified address
+    // Returns the number of bytes read
+    LLAMA_API size_t llama_set_state_data(struct llama_context * ctx, uint8_t * src);
+
+    // Save/load session file
+    LLAMA_API bool llama_load_session_file(struct llama_context * ctx, const char * path_session, llama_token * tokens_out, size_t n_token_capacity, size_t * n_token_count_out);
+    LLAMA_API bool llama_save_session_file(struct llama_context * ctx, const char * path_session, const llama_token * tokens, size_t n_token_count);
+
+    // Run the llama inference to obtain the logits and probabilities for the next token.
+    // tokens + n_tokens is the provided batch of new tokens to process
+    // n_past is the number of tokens to use from previous eval calls
+    // Returns 0 on success
+    LLAMA_API int llama_eval(
+            struct llama_context * ctx,
+               const llama_token * tokens,
+                             int   n_tokens,
+                             int   n_past,
+                             int   n_threads);
+
+    // Export a static computation graph for context of 511 and batch size of 1
+    // NOTE: since this functionality is mostly for debugging and demonstration purposes, we hardcode these
+    //       parameters here to keep things simple
+    // IMPORTANT: do not use for anything else other than debugging and testing!
+    LLAMA_API int llama_eval_export(struct llama_context * ctx, const char * fname);
+
+    // Convert the provided text into tokens.
+    // The tokens pointer must be large enough to hold the resulting tokens.
+    // Returns the number of tokens on success, no more than n_max_tokens
+    // Returns a negative number on failure - the number of tokens that would have been returned
+    // TODO: not sure if correct
+    LLAMA_API int llama_tokenize(
+            struct llama_context * ctx,
+                      const char * text,
+                     llama_token * tokens,
+                             int   n_max_tokens,
+                            bool   add_bos);
+
+    LLAMA_API int llama_n_vocab(const struct llama_context * ctx);
+    LLAMA_API int llama_n_ctx  (const struct llama_context * ctx);
+    LLAMA_API int llama_n_embd (const struct llama_context * ctx);
+
+    // Get the vocabulary as output parameters.
+    // Returns number of results.
+    LLAMA_API int llama_get_vocab(
+            const struct llama_context * ctx,
+                          const char * * strings,
+                                 float * scores,
+                                   int   capacity);
+
+    // Token logits obtained from the last call to llama_eval()
+    // The logits for the last token are stored in the last row
+    // Can be mutated in order to change the probabilities of the next token
+    // Rows: n_tokens
+    // Cols: n_vocab
+    LLAMA_API float * llama_get_logits(struct llama_context * ctx);
+
+    // Get the embeddings for the input
+    // shape: [n_embd] (1-dimensional)
+    LLAMA_API float * llama_get_embeddings(struct llama_context * ctx);
+
+    // Token Id -> String. Uses the vocabulary in the provided context
+    LLAMA_API const char * llama_token_to_str(const struct llama_context * ctx, llama_token token);
+
+    // Special tokens
+    LLAMA_API llama_token llama_token_bos();  // beginning-of-sentence
+    LLAMA_API llama_token llama_token_eos();  // end-of-sentence
+    LLAMA_API llama_token llama_token_nl();   // next-line
+
+    // Sampling functions
+
+    /// @details Repetition penalty described in CTRL academic paper https://arxiv.org/abs/1909.05858, with negative logit fix.
+    LLAMA_API void llama_sample_repetition_penalty(struct llama_context * ctx, llama_token_data_array * candidates, const llama_token * last_tokens, size_t last_tokens_size, float penalty);
+
+    /// @details Frequency and presence penalties described in OpenAI API https://platform.openai.com/docs/api-reference/parameter-details.
+    LLAMA_API void llama_sample_frequency_and_presence_penalties(struct llama_context * ctx, llama_token_data_array * candidates, const llama_token * last_tokens, size_t last_tokens_size, float alpha_frequency, float alpha_presence);
+
+    /// @details Sorts candidate tokens by their logits in descending order and calculate probabilities based on logits.
+    LLAMA_API void llama_sample_softmax(struct llama_context * ctx, llama_token_data_array * candidates);
+
+    /// @details Top-K sampling described in academic paper "The Curious Case of Neural Text Degeneration" https://arxiv.org/abs/1904.09751
+    LLAMA_API void llama_sample_top_k(struct llama_context * ctx, llama_token_data_array * candidates, int k, size_t min_keep);
+
+    /// @details Nucleus sampling described in academic paper "The Curious Case of Neural Text Degeneration" https://arxiv.org/abs/1904.09751
+    LLAMA_API void llama_sample_top_p(struct llama_context * ctx, llama_token_data_array * candidates, float p, size_t min_keep);
+
+    /// @details Tail Free Sampling described in https://www.trentonbricken.com/Tail-Free-Sampling/.
+    LLAMA_API void llama_sample_tail_free(struct llama_context * ctx, llama_token_data_array * candidates, float z, size_t min_keep);
+
+    /// @details Locally Typical Sampling implementation described in the paper https://arxiv.org/abs/2202.00666.
+    LLAMA_API void llama_sample_typical(struct llama_context * ctx, llama_token_data_array * candidates, float p, size_t min_keep);
+    LLAMA_API void llama_sample_temperature(struct llama_context * ctx, llama_token_data_array * candidates, float temp);
+
+    /// @details Mirostat 1.0 algorithm described in the paper https://arxiv.org/abs/2007.14966. Uses tokens instead of words.
+    /// @param candidates A vector of `llama_token_data` containing the candidate tokens, their probabilities (p), and log-odds (logit) for the current position in the generated text.
+    /// @param tau  The target cross-entropy (or surprise) value you want to achieve for the generated text. A higher value corresponds to more surprising or less predictable text, while a lower value corresponds to less surprising or more predictable text.
+    /// @param eta The learning rate used to update `mu` based on the error between the target and observed surprisal of the sampled word. A larger learning rate will cause `mu` to be updated more quickly, while a smaller learning rate will result in slower updates.
+    /// @param m The number of tokens considered in the estimation of `s_hat`. This is an arbitrary value that is used to calculate `s_hat`, which in turn helps to calculate the value of `k`. In the paper, they use `m = 100`, but you can experiment with different values to see how it affects the performance of the algorithm.
+    /// @param mu Maximum cross-entropy. This value is initialized to be twice the target cross-entropy (`2 * tau`) and is updated in the algorithm based on the error between the target and observed surprisal.
+    LLAMA_API llama_token llama_sample_token_mirostat(struct llama_context * ctx, llama_token_data_array * candidates, float tau, float eta, int m, float * mu);
+
+    /// @details Mirostat 2.0 algorithm described in the paper https://arxiv.org/abs/2007.14966. Uses tokens instead of words.
+    /// @param candidates A vector of `llama_token_data` containing the candidate tokens, their probabilities (p), and log-odds (logit) for the current position in the generated text.
+    /// @param tau  The target cross-entropy (or surprise) value you want to achieve for the generated text. A higher value corresponds to more surprising or less predictable text, while a lower value corresponds to less surprising or more predictable text.
+    /// @param eta The learning rate used to update `mu` based on the error between the target and observed surprisal of the sampled word. A larger learning rate will cause `mu` to be updated more quickly, while a smaller learning rate will result in slower updates.
+    /// @param mu Maximum cross-entropy. This value is initialized to be twice the target cross-entropy (`2 * tau`) and is updated in the algorithm based on the error between the target and observed surprisal.
+    LLAMA_API llama_token llama_sample_token_mirostat_v2(struct llama_context * ctx, llama_token_data_array * candidates, float tau, float eta, float * mu);
+
+    /// @details Selects the token with the highest probability.
+    LLAMA_API llama_token llama_sample_token_greedy(struct llama_context * ctx, llama_token_data_array * candidates);
+
+    /// @details Randomly selects a token from the candidates based on their probabilities.
+    LLAMA_API llama_token llama_sample_token(struct llama_context * ctx, llama_token_data_array * candidates);
+
+    // Performance information
+    LLAMA_API void llama_print_timings(struct llama_context * ctx);
+    LLAMA_API void llama_reset_timings(struct llama_context * ctx);
 
-// Print system information
-LLAMA_API const char *falcon_print_system_info(void);
+    // Print system information
+    LLAMA_API const char * llama_print_system_info(void);
 
 #ifdef __cplusplus
 }
 #endif
 
 // Internal API to be implemented by llama.cpp and used by tests/benchmarks only
 #ifdef LLAMA_API_INTERNAL
 
-#include <string>
 #include <vector>
+#include <string>
 struct ggml_tensor;
 
-std::vector<std::pair<std::string, struct ggml_tensor *>>
-    &llama_internal_get_tensor_map(struct falcon_context *ctx);
+std::vector<std::pair<std::string, struct ggml_tensor *>>& llama_internal_get_tensor_map(struct llama_context * ctx);
 
 #endif
 
-#endif
+#endif // LLAMA_H
```

### Comparing `ctransformers-langdash-0.2.11/models/ggml/llama-util.h` & `ctransformers-langdash-0.2.9/models/ggml/llama-util.h`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/llm.cc` & `ctransformers-langdash-0.2.9/models/llm.cc`

 * *Files 3% similar despite different names*

```diff
@@ -3,20 +3,16 @@
 #include "common.h"
 #include "llms/dolly.cc"
 #include "llms/gpt-neox.cc"
 #include "llms/gpt2.cc"
 #include "llms/gptj.cc"
 #include "llms/llama.cc"
 #include "llms/mpt.cc"
-#include "llms/replit.cc"
 #include "llms/starcoder.cc"
 
-// Import falcon after llama.
-#include "llms/falcon.cc"
-
 #ifdef __cplusplus
 extern "C" {
 #endif
 
 LLM* ctransformers_llm_create(const char* model_path, const char* model_type,
                               const int context_length, const int gpu_layers) {
   std::string type = model_type;
@@ -24,28 +20,24 @@
   type.erase(std::remove_if(type.begin(), type.end(),
                             [](const char c) { return !std::isalnum(c); }),
              type.end());
 
   LLM* llm = nullptr;
   if (type == "dollyv2") {
     llm = new dollyv2_llm;
-  } else if (type == "falcon") {
-    llm = new falcon_llm;
   } else if (type == "gpt2") {
     llm = new gpt2_llm;
   } else if (type == "gptj") {
     llm = new gptj_llm;
   } else if (type == "gptneox") {
     llm = new gpt_neox_llm;
   } else if (type == "llama") {
     llm = new llama_llm;
   } else if (type == "mpt") {
     llm = new mpt_llm;
-  } else if (type == "replit") {
-    llm = new replit_llm;
   } else if (type == "starcoder") {
     llm = new starcoder_llm;
   }
 
   if (llm == nullptr) {
     fprintf(stderr, "Model type '%s' is not supported.\n", model_type);
     return nullptr;
```

### Comparing `ctransformers-langdash-0.2.11/models/llm.h` & `ctransformers-langdash-0.2.9/models/llm.h`

 * *Files 4% similar despite different names*

```diff
@@ -273,17 +273,15 @@
                     const int n_past) = 0;
 
  private:
   bool initialized_ = false;
 
   bool EvalInternal(const std::vector<gpt_vocab::id> &tokens, int threads) {
     if (threads < 0) {
-      // https://github.com/ggerganov/llama.cpp/blob/cc45a7feb8412e84ff292207621412fffc0d3d51/examples/common.cpp#L67-L68
-      const int n = std::thread::hardware_concurrency();
-      threads = n > 0 ? (n <= 4 ? n : n / 2) : 4;
+      threads = std::min((int)std::thread::hardware_concurrency(), 4);
     }
     threads = std::max(threads, 1);
     const int n_past =
         std::min(ContextLength() - (int)tokens.size(), previous_tokens_.Size());
     if (!Eval(tokens, threads, n_past)) {
       return false;
     }
```

### Comparing `ctransformers-langdash-0.2.11/models/llms/dolly.cc` & `ctransformers-langdash-0.2.9/models/llms/dolly.cc`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/llms/falcon.cc` & `ctransformers-langdash-0.2.9/models/llms/llama.cc`

 * *Files 11% similar despite different names*

```diff
@@ -1,39 +1,39 @@
 #include "llm.h"
 
-// https://github.com/cmp-nct/ggllm.cpp/blob/master/examples/falcon/falcon_main.cpp
+// https://github.com/ggerganov/llama.cpp/blob/master/examples/main/main.cpp
 
-#include "ggml/libfalcon.cpp"
+#include "ggml/llama.cpp"
 
-class falcon_llm : public LLM {
+class llama_llm : public LLM {
  public:
-  virtual ~falcon_llm() {
+  virtual ~llama_llm() {
     if (ctx_ != nullptr) {
-      falcon_free(ctx_);
+      llama_free(ctx_);
     }
   }
 
   std::vector<gpt_vocab::id> Tokenize(const std::string &text) const override {
-    return falcon_tokenize(ctx_->vocab, text, /*bos=*/false);
+    return llama_tokenize(ctx_->vocab, text, /*bos=*/true);
   }
 
   const std::string &Detokenize(const gpt_vocab::id id) const override {
-    if (id >= falcon_n_vocab(ctx_)) {
+    if (id >= llama_n_vocab(ctx_)) {
       return kEmptyString;
     }
     return ctx_->vocab.id_to_token[id].tok;
   }
 
   bool IsEosToken(const gpt_vocab::id token) const override {
     return token == EosToken();
   }
 
-  gpt_vocab::id EosToken() const override { return falcon_token_eos(); }
+  gpt_vocab::id EosToken() const override { return llama_token_eos(); }
 
-  int VocabSize() const override { return falcon_n_vocab(ctx_); }
+  int VocabSize() const override { return llama_n_vocab(ctx_); }
 
   std::vector<float> &Logits() override { return ctx_->logits; }
 
   const std::vector<float> &Embeddings() const override {
     return ctx_->embedding;
   }
 
@@ -44,16 +44,16 @@
       last_n_tokens = ContextLength();
     }
     if (seed < 0) {
       seed = time(nullptr);
     }
     ctx_->rng.seed(seed);
 
-    const float *logits = falcon_get_logits(ctx_);
-    const int n_vocab = falcon_n_vocab(ctx_);
+    const float *logits = llama_get_logits(ctx_);
+    const int n_vocab = llama_n_vocab(ctx_);
 
     std::vector<llama_token_data> candidates;
     candidates.reserve(n_vocab);
     for (llama_token token_id = 0; token_id < n_vocab; token_id++) {
       candidates.emplace_back(
           llama_token_data{token_id, logits[token_id], 0.0f});
     }
@@ -67,46 +67,45 @@
     {
       std::unordered_set<gpt_vocab::id> recent_tokens_set;
       if (repetition_penalty != 1.0f) {
         recent_tokens_set = previous_tokens_.GetRecent(last_n_tokens);
       }
       std::vector<gpt_vocab::id> recent_tokens(recent_tokens_set.begin(),
                                                recent_tokens_set.end());
-      falcon_sample_repetition_penalty(
-          ctx_, &candidates_p, recent_tokens.data(), recent_tokens.size(),
-          repetition_penalty);
+      llama_sample_repetition_penalty(ctx_, &candidates_p, recent_tokens.data(),
+                                      recent_tokens.size(), repetition_penalty);
     }
 
-    falcon_sample_top_k(ctx_, &candidates_p, top_k, 1);
-    falcon_sample_top_p(ctx_, &candidates_p, top_p, 1);
-    falcon_sample_temperature(ctx_, &candidates_p, temperature);
-    return falcon_sample_token(ctx_, &candidates_p);
+    llama_sample_top_k(ctx_, &candidates_p, top_k, 1);
+    llama_sample_top_p(ctx_, &candidates_p, top_p, 1);
+    llama_sample_temperature(ctx_, &candidates_p, temperature);
+    return llama_sample_token(ctx_, &candidates_p);
   }
 
  protected:
   bool Load(const std::string &filename, const int context_length,
             const int gpu_layers) override {
-    falcon_context_params params = falcon_context_default_params();
+    llama_context_params params = llama_context_default_params();
     params.embedding = true;
     if (context_length > 0) {
       params.n_ctx = context_length;
     }
     params.n_gpu_layers = gpu_layers;
 
-    ctx_ = falcon_init_from_file(filename.c_str(), params);
+    ctx_ = llama_init_from_file(filename.c_str(), params);
     if (ctx_ == nullptr) {
       return false;
     }
-    n_ctx_ = falcon_n_ctx(ctx_);
+    n_ctx_ = llama_n_ctx(ctx_);
     return true;
   }
 
   bool Eval(const std::vector<gpt_vocab::id> &tokens, const int threads,
             const int n_past) override {
-    const int status = falcon_eval(ctx_, tokens.data(), tokens.size(), n_past,
-                                   threads, /*debug_timings=*/0);
+    const int status =
+        llama_eval(ctx_, tokens.data(), tokens.size(), n_past, threads);
     return status == 0;
   }
 
  private:
-  falcon_context *ctx_ = nullptr;
+  llama_context *ctx_ = nullptr;
 };
```

### Comparing `ctransformers-langdash-0.2.11/models/llms/gpt-neox.cc` & `ctransformers-langdash-0.2.9/models/llms/gpt-neox.cc`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/llms/gpt2.cc` & `ctransformers-langdash-0.2.9/models/llms/gpt2.cc`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/llms/gptj.cc` & `ctransformers-langdash-0.2.9/models/llms/gptj.cc`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/llms/mpt.cc` & `ctransformers-langdash-0.2.9/models/llms/mpt.cc`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/models/llms/replit.cc` & `ctransformers-langdash-0.2.9/models/llms/starcoder.cc`

 * *Files 15% similar despite different names*

```diff
@@ -1,164 +1,70 @@
 #include "llm.h"
 
-// https://github.com/ggerganov/ggml/blob/master/examples/replit/main.cpp
+// https://github.com/ggerganov/ggml/blob/master/examples/starcoder/main.cpp
 
-// no defaults for now
-struct replit_hparams {
-  int32_t d_model = 0;
-  int32_t max_seq_len = 0;
-  int32_t n_heads = 0;
-  int32_t n_layers = 0;
-  int32_t n_vocab = 0;
-  int32_t ftype = 0;
+// default hparams (GPT-2 117M)
+// https://huggingface.co/bigcode/gpt_bigcode-santacoder/blob/main/config.json
+struct starcoder_hparams {
+  int32_t n_vocab = 49280;
   int32_t n_ctx = 2048;
+  int32_t n_embd = 2048;
+  int32_t n_head = 16;
+  int32_t n_layer = 24;
+  int32_t ftype = 1;
 };
 
-using piece_t = std::pair<std::size_t, float>;
-using piece_map_t = std::unordered_map<std::string, piece_t>;
+struct starcoder_layer {
+  // normalization
+  struct ggml_tensor *ln_1_g;
+  struct ggml_tensor *ln_1_b;
 
-struct replit_tokenizer {
-  gpt_vocab raw_vocab;
-  piece_map_t piece_map;
-  std::vector<std::string> vocab;
-};
-
-struct replit_layer {
-  // pre normalization
-  struct ggml_tensor *norm_1_weight;
+  struct ggml_tensor *ln_2_g;
+  struct ggml_tensor *ln_2_b;
 
   // attention
-  struct ggml_tensor *c_attn_wqkv_weight;
-  struct ggml_tensor *c_attn_out_proj_weight;
+  struct ggml_tensor *c_attn_attn_w;
+  struct ggml_tensor *c_attn_attn_b;
 
-  // post normalization
-  struct ggml_tensor *norm_2_weight;
+  struct ggml_tensor *c_attn_proj_w;
+  struct ggml_tensor *c_attn_proj_b;
 
-  // ff
-  struct ggml_tensor *ffn_up_proj;
-  struct ggml_tensor *ffn_down_proj;
+  // mlp
+  struct ggml_tensor *c_mlp_fc_w;
+  struct ggml_tensor *c_mlp_fc_b;
+
+  struct ggml_tensor *c_mlp_proj_w;
+  struct ggml_tensor *c_mlp_proj_b;
 };
 
-struct replit_model {
-  replit_hparams hparams;
+struct starcoder_model {
+  starcoder_hparams hparams;
 
-  struct ggml_tensor *wte_weight;     // position embedding
-  struct ggml_tensor *norm_f_weight;  // language model head
+  // normalization
+  struct ggml_tensor *ln_f_g;
+  struct ggml_tensor *ln_f_b;
+
+  struct ggml_tensor *wte;      // position embedding
+  struct ggml_tensor *wpe;      //    token embedding
+  struct ggml_tensor *lm_head;  // language model head
 
-  std::vector<replit_layer> layers;
+  std::vector<starcoder_layer> layers;
 
   // key + value memory
   struct ggml_tensor *memory_k;
   struct ggml_tensor *memory_v;
 
+  //
   struct ggml_context *ctx;
   std::map<std::string, struct ggml_tensor *> tensors;
 };
 
-std::pair<std::vector<gpt_vocab::id>, float> encode_word(
-    const std::string &word, const piece_map_t &model) {
-  std::vector<int> best_segmentations_starts(word.length() + 1, -1);
-  best_segmentations_starts[0] = 0;
-
-  std::vector<float> best_segmentations_scores(
-      word.length() + 1, -std::numeric_limits<float>::infinity());
-  best_segmentations_scores[0] = 1.0;
-
-  for (int start_idx = 0; start_idx < word.length(); ++start_idx) {
-    float best_score_at_start = best_segmentations_scores[start_idx];
-    for (int end_idx = start_idx + 1; end_idx <= word.length(); ++end_idx) {
-      std::string token = word.substr(start_idx, end_idx - start_idx);
-      if (model.count(token) &&
-          best_score_at_start != -std::numeric_limits<float>::infinity()) {
-        float token_score = model.at(token).second;
-        float score = token_score + best_score_at_start;
-        if (best_segmentations_scores[end_idx] ==
-                -std::numeric_limits<float>::infinity() ||
-            best_segmentations_scores[end_idx] > score) {
-          best_segmentations_starts[end_idx] = start_idx;
-          best_segmentations_scores[end_idx] = score;
-        }
-      }
-    }
-  }
-
-  if (best_segmentations_scores.back() ==
-      -std::numeric_limits<float>::infinity()) {
-    return std::make_pair(std::vector<gpt_vocab::id>{0}, 0.0f);
-  }
-
-  float score = best_segmentations_scores.back();
-  int start = best_segmentations_starts.back();
-  int end = word.length();
-  std::vector<gpt_vocab::id> tokens;
-  while (start != 0) {
-    const auto token_id = model.at(word.substr(start, end - start)).first;
-    tokens.insert(tokens.begin(), token_id);
-    int next_start = best_segmentations_starts[start];
-    end = start;
-    start = next_start;
-  }
-  const auto token_id = model.at(word.substr(start, end - start)).first;
-  tokens.insert(tokens.begin(), token_id);
-  return std::make_pair(tokens, score);
-}
-
-bool replit_tokenizer_load(replit_tokenizer &tokenizer, std::istream &fin,
-                           int max_vocab_size) {
-  std::string word;
-  std::vector<char> buf(128);
-
-  for (std::size_t i = 0; i < max_vocab_size; i++) {
-    uint32_t len;
-    fin.read((char *)&len, sizeof(len));
-
-    buf.resize(len);
-    fin.read((char *)buf.data(), len);
-    word.assign(buf.data(), len);
-
-    float score;
-    fin.read((char *)&score, sizeof(score));
-
-    tokenizer.piece_map[word] = std::make_pair(i, -score);
-    tokenizer.raw_vocab.id_to_token[i] = word;
-  }
-
-  return true;
-}
-
-std::string replace_all(const std::string &str,     // where to work
-                        const std::string &find,    // substitute 'find'
-                        const std::string &replace  //      by 'replace'
-) {
-  using namespace std;
-  string result;
-  size_t find_len = find.size();
-  size_t pos, from = 0;
-  while (string::npos != (pos = str.find(find, from))) {
-    result.append(str, from, pos - from);
-    result.append(replace);
-    from = pos + find_len;
-  }
-  result.append(str, from, string::npos);
-  return result;
-}
-
-std::string ws_symbol = "\342\226\201";
-std::vector<gpt_vocab::id> replit_tokenizer_tokenize(
-    const replit_tokenizer &tokenizer, const std::string &text) {
-  std::vector<gpt_vocab::id> tokens;
-  auto normalized_text = replace_all(text, " ", ws_symbol);
-  auto tokenized = encode_word(normalized_text, tokenizer.piece_map);
-
-  return tokenized.first;
-}
-
 // load the model's weights from a file
-bool replit_model_load(const std::string &fname, replit_model &model,
-                       replit_tokenizer &tokenizer) {
+bool starcoder_model_load(const std::string &fname, starcoder_model &model,
+                          gpt_vocab &vocab) {
   auto fin = std::ifstream(fname, std::ios::binary);
   if (!fin) {
     fprintf(stderr, "%s: failed to open '%s'\n", __func__, fname.c_str());
     return false;
   }
 
   // verify magic
@@ -172,75 +78,129 @@
     }
   }
 
   // load hparams
   {
     auto &hparams = model.hparams;
 
-    fin.read((char *)&hparams.d_model, sizeof(hparams.d_model));
-    fin.read((char *)&hparams.max_seq_len, sizeof(hparams.max_seq_len));
-    fin.read((char *)&hparams.n_heads, sizeof(hparams.n_heads));
-    fin.read((char *)&hparams.n_layers, sizeof(hparams.n_layers));
     fin.read((char *)&hparams.n_vocab, sizeof(hparams.n_vocab));
+    fin.read((char *)&hparams.n_ctx, sizeof(hparams.n_ctx));
+    fin.read((char *)&hparams.n_embd, sizeof(hparams.n_embd));
+    fin.read((char *)&hparams.n_head, sizeof(hparams.n_head));
+    fin.read((char *)&hparams.n_layer, sizeof(hparams.n_layer));
     fin.read((char *)&hparams.ftype, sizeof(hparams.ftype));
 
-    hparams.n_ctx = std::min(hparams.max_seq_len, hparams.n_ctx);
-
     const int32_t qntvr = hparams.ftype / GGML_QNT_VERSION_FACTOR;
 
     hparams.ftype %= GGML_QNT_VERSION_FACTOR;
   }
 
   // load vocab
-  replit_tokenizer_load(tokenizer, fin, model.hparams.n_vocab);
+  {
+    int32_t n_vocab = 0;
+    fin.read((char *)&n_vocab, sizeof(n_vocab));
 
-  // for the big tensors, we have the option to store the data in 16-bit
-  // floats or quantized in order to save memory and also to speed up the
-  // computation
+    if (n_vocab != model.hparams.n_vocab) {
+      fprintf(stderr, "%s: invalid model file '%s' (bad vocab size %d != %d)\n",
+              __func__, fname.c_str(), n_vocab, model.hparams.n_vocab);
+      return false;
+    }
+
+    std::string word;
+    std::vector<char> buf(128);
+
+    for (int i = 0; i < n_vocab; i++) {
+      uint32_t len;
+      fin.read((char *)&len, sizeof(len));
+
+      buf.resize(len);
+      fin.read((char *)buf.data(), len);
+      word.assign(buf.data(), len);
+
+      vocab.token_to_id[word] = i;
+      vocab.id_to_token[i] = word;
+    }
+
+    // Add StarChat special tokens.
+    for (const std::string &token : {
+             "<|system|>",
+             "<|user|>",
+             "<|assistant|>",
+             "<|end|>",
+         }) {
+      if (vocab.token_to_id.find(token) != vocab.token_to_id.end()) {
+        vocab.add_special_token(token);
+      }
+    }
+  }
+
+  // for the big tensors, we have the option to store the data in 16-bit floats
+  // or quantized in order to save memory and also to speed up the computation
   ggml_type wtype = ggml_ftype_to_ggml_type((ggml_ftype)(model.hparams.ftype));
   if (wtype == GGML_TYPE_COUNT) {
     fprintf(stderr, "%s: invalid model file '%s' (bad ftype value %d)\n",
             __func__, fname.c_str(), model.hparams.ftype);
     return false;
   }
 
   auto &ctx = model.ctx;
 
   size_t ctx_size = 0;
 
   {
     const auto &hparams = model.hparams;
 
-    const int n_embd = hparams.d_model;
-    const int n_layer = hparams.n_layers;
-    const int n_ctx = hparams.max_seq_len;
+    const int n_embd = hparams.n_embd;
+    const int n_layer = hparams.n_layer;
+    const int n_ctx = hparams.n_ctx;
     const int n_vocab = hparams.n_vocab;
 
-    ctx_size += n_embd * n_vocab * ggml_type_sizef(wtype);  // wte_weight
-    ctx_size += n_embd * ggml_type_sizef(GGML_TYPE_F32);    // ln_f_weight
+    const int head_dim = n_embd / hparams.n_head;
+    const int kv_heads = hparams.n_head;  // 1 if MQA else hparams.n_head
+    const int kv_dim = kv_heads * head_dim;
+
+    ctx_size += n_embd * ggml_type_sizef(GGML_TYPE_F32);  // ln_f_g
+    ctx_size += n_embd * ggml_type_sizef(GGML_TYPE_F32);  // ln_f_b
+
+    ctx_size += n_vocab * n_embd * ggml_type_sizef(wtype);        // wte
+    ctx_size += n_ctx * n_embd * ggml_type_sizef(GGML_TYPE_F32);  // wpe
+    ctx_size += n_vocab * n_embd * ggml_type_sizef(wtype);        // lm_head
+
+    ctx_size += n_layer * (n_embd * ggml_type_sizef(GGML_TYPE_F32));  // ln_1_g
+    ctx_size += n_layer * (n_embd * ggml_type_sizef(GGML_TYPE_F32));  // ln_1_b
+
+    ctx_size += n_layer * (n_embd * ggml_type_sizef(GGML_TYPE_F32));  // ln_2_g
+    ctx_size += n_layer * (n_embd * ggml_type_sizef(GGML_TYPE_F32));  // ln_2_b
+
+    ctx_size += n_layer * ((n_embd + 2 * kv_dim) * n_embd *
+                           ggml_type_sizef(wtype));  // c_attn_attn_w // TODO:
+    ctx_size += n_layer * ((n_embd + 2 * kv_dim) *
+                           ggml_type_sizef(GGML_TYPE_F32));  // c_attn_attn_b
 
     ctx_size +=
-        n_layer * (n_embd * ggml_type_sizef(GGML_TYPE_F32));  // ln_1_weight
-    ctx_size += n_layer * (3 * n_embd * n_embd *
-                           ggml_type_sizef(wtype));  // attn_Wqkv_weight
-    ctx_size += n_layer * (n_embd * n_embd *
-                           ggml_type_sizef(wtype));  // attn_out_proj_weight
+        n_layer * (n_embd * n_embd * ggml_type_sizef(wtype));  // c_attn_proj_w
+    ctx_size +=
+        n_layer * (n_embd * ggml_type_sizef(GGML_TYPE_F32));  // c_attn_proj_b
+
+    ctx_size +=
+        n_layer * (4 * n_embd * n_embd * ggml_type_sizef(wtype));  // c_mlp_fc_w
+    ctx_size +=
+        n_layer * (4 * n_embd * ggml_type_sizef(GGML_TYPE_F32));  // c_mlp_fc_b
+
+    ctx_size += n_layer *
+                (4 * n_embd * n_embd * ggml_type_sizef(wtype));  // c_mlp_proj_w
     ctx_size +=
-        n_layer * (n_embd * ggml_type_sizef(GGML_TYPE_F32));  // ln_2_weight
-    ctx_size += n_layer * (4 * n_embd * n_embd *
-                           ggml_type_sizef(wtype));  // mlp_mlp_up_weight
-    ctx_size += n_layer * (n_embd * n_embd * 4 *
-                           ggml_type_sizef(wtype));  // mlp_mlp_down_weight
+        n_layer * (n_embd * ggml_type_sizef(GGML_TYPE_F32));  // c_mlp_proj_b
 
     ctx_size +=
-        n_ctx * n_layer * n_embd * ggml_type_sizef(GGML_TYPE_F16);  // memory_k
+        n_ctx * n_layer * n_embd * ggml_type_sizef(GGML_TYPE_F32);  // memory_k
     ctx_size +=
-        n_ctx * n_layer * n_embd * ggml_type_sizef(GGML_TYPE_F16);  // memory_v
+        n_ctx * n_layer * n_embd * ggml_type_sizef(GGML_TYPE_F32);  // memory_v
 
-    ctx_size += (1 + 6 * n_layer) * 512;  // object overhead
+    ctx_size += (6 + 12 * n_layer) * 512;  // object overhead
   }
 
   // create the ggml context
   {
     struct ggml_init_params params = {
         /*.mem_size   =*/ctx_size,
         /*.mem_buffer =*/NULL,
@@ -254,75 +214,117 @@
     }
   }
 
   // prepare memory for the weights
   {
     const auto &hparams = model.hparams;
 
-    const size_t n_embd = hparams.d_model;
-    const size_t n_layer = hparams.n_layers;
-    const size_t n_vocab = hparams.n_vocab;
+    const int n_embd = hparams.n_embd;
+    const int n_layer = hparams.n_layer;
+    const int n_ctx = hparams.n_ctx;
+    const int n_vocab = hparams.n_vocab;
+
+    const int head_dim = n_embd / hparams.n_head;
+    const int kv_heads = hparams.n_head;  // 1 if MQA else hparams.n_head
+    const int kv_dim = kv_heads * head_dim;
 
     model.layers.resize(n_layer);
 
-    model.wte_weight = ggml_new_tensor_2d(ctx, wtype, n_embd, n_vocab);
-    model.norm_f_weight = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
+    model.ln_f_g = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
+    model.ln_f_b = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
+
+    model.wte = ggml_new_tensor_2d(ctx, wtype, n_embd, n_vocab);
+    model.wpe = ggml_new_tensor_2d(ctx, GGML_TYPE_F32, n_embd, n_ctx);
+    model.lm_head = ggml_new_tensor_2d(ctx, wtype, n_embd, n_vocab);
 
     // map by name
-    model.tensors["transformer.wte.weight"] = model.wte_weight;
-    model.tensors["transformer.norm_f.weight"] = model.norm_f_weight;
+    model.tensors["model/ln_f/g"] = model.ln_f_g;
+    model.tensors["model/ln_f/b"] = model.ln_f_b;
 
-    for (int i = 0; i < (int)n_layer; ++i) {
+    model.tensors["model/wte"] = model.wte;
+    model.tensors["model/wpe"] = model.wpe;
+    model.tensors["model/lm_head"] = model.lm_head;
+
+    for (int i = 0; i < n_layer; ++i) {
       auto &layer = model.layers[i];
 
-      layer.norm_1_weight = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
-      layer.c_attn_wqkv_weight =
-          ggml_new_tensor_2d(ctx, wtype, n_embd, 3 * n_embd);
-      layer.c_attn_out_proj_weight =
-          ggml_new_tensor_2d(ctx, wtype, n_embd, n_embd);
-      layer.norm_2_weight = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
-      layer.ffn_up_proj = ggml_new_tensor_2d(ctx, wtype, n_embd, 4 * n_embd);
-      layer.ffn_down_proj = ggml_new_tensor_2d(ctx, wtype, 4 * n_embd, n_embd);
+      layer.ln_1_g = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
+      layer.ln_1_b = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
+
+      layer.ln_2_g = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
+      layer.ln_2_b = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
+
+      layer.c_attn_attn_w =
+          ggml_new_tensor_2d(ctx, wtype, n_embd, n_embd + 2 * kv_dim);
+      layer.c_attn_attn_b =
+          ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd + 2 * kv_dim);
+
+      layer.c_attn_proj_w = ggml_new_tensor_2d(ctx, wtype, n_embd, n_embd);
+      layer.c_attn_proj_b = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
+
+      layer.c_mlp_fc_w = ggml_new_tensor_2d(
+          ctx, wtype, n_embd, 4 * n_embd);  // TODO: 4*n_embd = config.n_inner
+      layer.c_mlp_fc_b = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, 4 * n_embd);
+
+      layer.c_mlp_proj_w = ggml_new_tensor_2d(ctx, wtype, 4 * n_embd, n_embd);
+      layer.c_mlp_proj_b = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_embd);
 
       // map by name
-      model.tensors["transformer.blocks." + std::to_string(i) +
-                    ".norm_1.weight"] = layer.norm_1_weight;
-      model.tensors["transformer.blocks." + std::to_string(i) +
-                    ".attn.Wqkv.weight"] = layer.c_attn_wqkv_weight;
-      model.tensors["transformer.blocks." + std::to_string(i) +
-                    ".attn.out_proj.weight"] = layer.c_attn_out_proj_weight;
-      model.tensors["transformer.blocks." + std::to_string(i) +
-                    ".norm_2.weight"] = layer.norm_2_weight;
-      model.tensors["transformer.blocks." + std::to_string(i) +
-                    ".ffn.up_proj.weight"] = layer.ffn_up_proj;
-      model.tensors["transformer.blocks." + std::to_string(i) +
-                    ".ffn.down_proj.weight"] = layer.ffn_down_proj;
+      model.tensors["model/h" + std::to_string(i) + "/ln_1/g"] = layer.ln_1_g;
+      model.tensors["model/h" + std::to_string(i) + "/ln_1/b"] = layer.ln_1_b;
+
+      model.tensors["model/h" + std::to_string(i) + "/ln_2/g"] = layer.ln_2_g;
+      model.tensors["model/h" + std::to_string(i) + "/ln_2/b"] = layer.ln_2_b;
+
+      model.tensors["model/h" + std::to_string(i) + "/attn/c_attn/w"] =
+          layer.c_attn_attn_w;
+      model.tensors["model/h" + std::to_string(i) + "/attn/c_attn/b"] =
+          layer.c_attn_attn_b;
+
+      model.tensors["model/h" + std::to_string(i) + "/attn/c_proj/w"] =
+          layer.c_attn_proj_w;
+      model.tensors["model/h" + std::to_string(i) + "/attn/c_proj/b"] =
+          layer.c_attn_proj_b;
+
+      model.tensors["model/h" + std::to_string(i) + "/mlp/c_fc/w"] =
+          layer.c_mlp_fc_w;
+      model.tensors["model/h" + std::to_string(i) + "/mlp/c_fc/b"] =
+          layer.c_mlp_fc_b;
+
+      model.tensors["model/h" + std::to_string(i) + "/mlp/c_proj/w"] =
+          layer.c_mlp_proj_w;
+      model.tensors["model/h" + std::to_string(i) + "/mlp/c_proj/b"] =
+          layer.c_mlp_proj_b;
     }
   }
 
   // key + value memory
   {
     const auto &hparams = model.hparams;
 
-    const int n_embd = hparams.d_model;
-    const int n_layer = hparams.n_layers;
-    const int n_ctx = hparams.max_seq_len;
+    const int n_embd = hparams.n_embd;
+    const int n_layer = hparams.n_layer;
+    const int n_ctx = hparams.n_ctx;
 
-    const int64_t n_mem = n_layer * n_ctx;
-    const int64_t n_elements = n_embd * n_mem;
+    const int n_mem = n_layer * n_ctx;
+    const int n_elements = n_embd * n_mem;
 
-    model.memory_k = ggml_new_tensor_1d(ctx, GGML_TYPE_F16, n_elements);
-    model.memory_v = ggml_new_tensor_1d(ctx, GGML_TYPE_F16, n_elements);
+    model.memory_k = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_elements);
+    model.memory_v = ggml_new_tensor_1d(ctx, GGML_TYPE_F32, n_elements);
 
     const size_t memory_size =
         ggml_nbytes(model.memory_k) + ggml_nbytes(model.memory_v);
   }
 
   // load weights
   {
+    size_t total_size = 0;
+
+    bool has_lm_head = false;
+
     while (true) {
       int32_t n_dims;
       int32_t length;
       int32_t ttype;
 
       fin.read(reinterpret_cast<char *>(&n_dims), sizeof(n_dims));
       fin.read(reinterpret_cast<char *>(&length), sizeof(length));
@@ -345,28 +347,29 @@
       if (model.tensors.find(name.data()) == model.tensors.end()) {
         fprintf(stderr, "%s: unknown tensor '%s' in model file\n", __func__,
                 name.data());
         return false;
       }
 
       auto tensor = model.tensors[name.data()];
-      if (ggml_nelements(tensor) != nelements) {
-        fprintf(stderr, "%s: tensor '%s' has wrong size in model file\n",
-                __func__, name.data());
-        return false;
-      }
-
       if (tensor->ne[0] != ne[0] || tensor->ne[1] != ne[1]) {
         fprintf(stderr,
-                "%s: tensor '%s' has wrong shape in model file: got [%5d, "
-                "%5d], expected [%5d, %5d]\n",
+                "%s: tensor '%s' has wrong shape in model file: got [%d, %d], "
+                "expected [%d, %d]\n",
                 __func__, name.data(), (int)tensor->ne[0], (int)tensor->ne[1],
                 ne[0], ne[1]);
         return false;
       }
+      if (ggml_nelements(tensor) != nelements) {
+        fprintf(stderr,
+                "%s: tensor '%s' has wrong size in model file. got %d, "
+                "expected %d\n",
+                __func__, name.data(), (int)ggml_nelements(tensor), nelements);
+        return false;
+      }
 
       // for debugging
       if (0) {
         printf("%24s - [%5d, %5d], type = %6s, %6.2f MB, %9zu bytes\n",
                name.data(), ne[0], ne[1], ggml_type_name(ggml_type(ttype)),
                ggml_nbytes(tensor) / 1024.0 / 1024.0, ggml_nbytes(tensor));
       }
@@ -379,14 +382,25 @@
                 "%s: tensor '%s' has wrong size in model file: got %zu, "
                 "expected %zu\n",
                 __func__, name.data(), ggml_nbytes(tensor), nelements * bpe);
         return false;
       }
 
       fin.read(reinterpret_cast<char *>(tensor->data), ggml_nbytes(tensor));
+
+      // GPT-2 models share the WTE tensor as the LM head
+      if (name == "model/wte" && has_lm_head == false) {
+        memcpy(model.lm_head->data, tensor->data, ggml_nbytes(tensor));
+      }
+
+      if (name == "model/lm_head") {
+        has_lm_head = true;
+      }
+
+      total_size += ggml_nbytes(tensor);
     }
   }
 
   fin.close();
 
   return true;
 }
@@ -395,31 +409,39 @@
 //
 //   - model:     the model
 //   - n_threads: number of threads to use
 //   - n_past:    the context size so far
 //   - embd_inp:  the embeddings of the tokens in the context
 //   - embd_w:    the predicted logits for the next token
 //
-bool replit_eval(const replit_model &model, const int n_threads,
-                 const int n_past, const std::vector<gpt_vocab::id> &embd_inp,
-                 std::vector<float> &embd_w, size_t &mem_per_token) {
-  const bool logits_all = false;
+bool starcoder_eval(const starcoder_model &model, const int n_threads,
+                    const int n_past,
+                    const std::vector<gpt_vocab::id> &embd_inp,
+                    std::vector<float> &embd_w, size_t &mem_per_token) {
   const int N = embd_inp.size();
 
   const auto &hparams = model.hparams;
 
-  const int n_embd = hparams.d_model;
-  const int n_layer = hparams.n_layers;
-  const int n_head = hparams.n_heads;
+  const int n_embd = hparams.n_embd;
+  const int n_layer = hparams.n_layer;
+  const int n_ctx = hparams.n_ctx;
+  const int n_head = hparams.n_head;
   const int n_vocab = hparams.n_vocab;
-  const int n_ctx = hparams.max_seq_len;
 
   static size_t buf_size = 256u * 1024 * 1024;
   static void *buf = malloc(buf_size);
 
+  // use 2 scratch buffers
+  // TODO: very hacky solution - reimplement in a more elegant way
+  static size_t scr0_size = 256u * 1024 * 1024;
+  static void *scr0 = malloc(scr0_size);
+
+  static size_t scr1_size = 256u * 1024 * 1024;
+  static void *scr1 = malloc(scr1_size);
+
   if (mem_per_token > 0 && mem_per_token * N > buf_size) {
     const size_t buf_size_new =
         1.1 *
         (mem_per_token * N);  // add 10% to account for ggml object overhead
     // printf("\n%s: reallocating buffer from %zu to %zu bytes\n", __func__,
     // buf_size, buf_size_new);
 
@@ -441,96 +463,142 @@
   struct ggml_context *ctx0 = ggml_init(params);
   struct ggml_cgraph gf = {};
   gf.n_threads = n_threads;
 
   struct ggml_tensor *embd = ggml_new_tensor_1d(ctx0, GGML_TYPE_I32, N);
   memcpy(embd->data, embd_inp.data(), N * ggml_element_size(embd));
 
-  struct ggml_tensor *inpL = ggml_get_rows(ctx0, model.wte_weight, embd);
+  struct ggml_tensor *position = ggml_new_tensor_1d(ctx0, GGML_TYPE_I32, N);
+  for (int i = 0; i < N; ++i) {
+    ((int32_t *)position->data)[i] = n_past + i;
+  }
+
+  // wte + wpe
+  struct ggml_tensor *inpL =
+      ggml_add(ctx0, ggml_get_rows(ctx0, model.wte, embd),
+               ggml_get_rows(ctx0, model.wpe, position));
 
   for (int il = 0; il < n_layer; ++il) {
     struct ggml_tensor *cur;
 
-    // a = self.ln_1(x)
+    ggml_set_scratch(ctx0, {
+                               0,
+                               scr0_size,
+                               scr0,
+                           });
+
+    // norm
     {
+      // [ 768, N]
       cur = ggml_norm(ctx0, inpL);
 
-      cur = ggml_mul(
-          ctx0, ggml_repeat(ctx0, model.layers[il].norm_1_weight, cur), cur);
+      // cur = ln_1_g*cur + ln_1_b
+      // [ 768, N]
+      cur = ggml_add(
+          ctx0,
+          ggml_mul(ctx0, ggml_repeat(ctx0, model.layers[il].ln_1_g, cur), cur),
+          ggml_repeat(ctx0, model.layers[il].ln_1_b, cur));
     }
 
-    // self-attention
-    //  b, _, past_key_value = self.attn(a, past_key_value=past_key_value,
-    //  attn_bias=attn_bias, attention_mask=attention_mask,
-    //  is_causal=is_causal)
+    // attn
+    // [2304, 768] - model.layers[il].c_attn_attn_w
+    // [2304,   1] - model.layers[il].c_attn_attn_b
+    // [ 768,   N] - cur (in)
+    // [2304,   N] - cur (out)
+    //
+    // cur = attn_w*cur + attn_b
+    // [2304, N]
     {
-      // compute QKV
-      cur = ggml_mul_mat(ctx0, model.layers[il].c_attn_wqkv_weight, cur);
+      cur = ggml_mul_mat(ctx0, model.layers[il].c_attn_attn_w, cur);
 
+      cur = ggml_add(
+          ctx0, ggml_repeat(ctx0, model.layers[il].c_attn_attn_b, cur), cur);
+    }
+
+    // self-attention
+    {
       struct ggml_tensor *Qcur = ggml_view_2d(ctx0, cur, n_embd, N, cur->nb[1],
                                               0 * sizeof(float) * n_embd);
       struct ggml_tensor *Kcur = ggml_view_2d(ctx0, cur, n_embd, N, cur->nb[1],
                                               1 * sizeof(float) * n_embd);
       struct ggml_tensor *Vcur = ggml_view_2d(ctx0, cur, n_embd, N, cur->nb[1],
                                               2 * sizeof(float) * n_embd);
 
       // store key and value to memory
-      {
+      if (N >= 1) {
         struct ggml_tensor *k =
             ggml_view_1d(ctx0, model.memory_k, N * n_embd,
                          (ggml_element_size(model.memory_k) * n_embd) *
                              (il * n_ctx + n_past));
         struct ggml_tensor *v =
             ggml_view_1d(ctx0, model.memory_v, N * n_embd,
                          (ggml_element_size(model.memory_v) * n_embd) *
                              (il * n_ctx + n_past));
 
         ggml_build_forward_expand(&gf, ggml_cpy(ctx0, Kcur, k));
         ggml_build_forward_expand(&gf, ggml_cpy(ctx0, Vcur, v));
       }
 
-      // Q = Qcur.contiguous().view(n_embd/n_head, n_head, N).permute(0,
-      // 2, 1, 3) [64, N, 12]
+      // Q = Qcur.contiguous().view(n_embd/n_head, n_head, N).permute(0, 2, 1,
+      // 3) [64, N, 12]
       struct ggml_tensor *Q =
           ggml_permute(ctx0,
                        ggml_cpy(ctx0, Qcur,
                                 ggml_new_tensor_3d(ctx0, GGML_TYPE_F32,
                                                    n_embd / n_head, n_head, N)),
                        0, 2, 1, 3);
 
-      // K = Kmem.view(n_embd/n_head, n_head, n_past + N).permute(0, 2, 1,
-      // 3) [64, n_past + N, 12]
+      // K = Kmem.view(n_embd/n_head, n_head, n_past + N).permute(0, 2, 1, 3)
+      // [64, n_past + N, 12]
       struct ggml_tensor *K = ggml_permute(
           ctx0,
           ggml_reshape_3d(
               ctx0,
               ggml_view_1d(
                   ctx0, model.memory_k, (n_past + N) * n_embd,
                   il * n_ctx * ggml_element_size(model.memory_k) * n_embd),
               n_embd / n_head, n_head, n_past + N),
-          0, 2, 1, 3);
+          0, 2, 1, 3);  // TODO: need to be tiled
+
+      // GG: flash attention
+      // struct ggml_tensor * V =
+      //    ggml_cpy(ctx0,
+      //            ggml_permute(ctx0,
+      //                ggml_reshape_3d(ctx0,
+      //                    ggml_view_1d(ctx0, model.memory_v, (n_past +
+      //                    N)*n_embd,
+      //                    il*n_ctx*ggml_element_size(model.memory_v)*n_embd),
+      //                    n_embd/n_head, n_head, n_past + N),
+      //                1, 2, 0, 3),
+      //            ggml_new_tensor_3d(ctx0, GGML_TYPE_F32, n_past + N,
+      //            n_embd/n_head, n_head));
+
+      // struct ggml_tensor * KQV = ggml_flash_attn(ctx0, Q, K, V, true);
+
       // K * Q
-      struct ggml_tensor *KQ = ggml_mul_mat(ctx0, K, Q);
+      // [n_past + N, N, 12]
+      struct ggml_tensor *KQ =
+          ggml_mul_mat(ctx0, K, Q);  // TODO: check if it broadcasts
 
       // KQ_scaled = KQ / sqrt(n_embd/n_head)
-      struct ggml_tensor *KQ_scaled = ggml_scale(
+      // [n_past + N, N, 12]
+      struct ggml_tensor *KQ_scaled = ggml_scale_inplace(
           ctx0, KQ, ggml_new_f32(ctx0, 1.0f / sqrt(float(n_embd) / n_head)));
 
-      struct ggml_tensor *KQ_scaled_alibi =
-          ggml_alibi(ctx0, KQ_scaled, n_past, n_head, 8.0f);
-
       // KQ_masked = mask_past(KQ_scaled)
+      // [n_past + N, N, 12]
       struct ggml_tensor *KQ_masked =
-          ggml_diag_mask_inf(ctx0, KQ_scaled_alibi, n_past);
+          ggml_diag_mask_inf_inplace(ctx0, KQ_scaled, n_past);
 
       // KQ = soft_max(KQ_masked)
-      struct ggml_tensor *KQ_soft_max = ggml_soft_max(ctx0, KQ_masked);
+      // [n_past + N, N, 12]
+      struct ggml_tensor *KQ_soft_max = ggml_soft_max_inplace(ctx0, KQ_masked);
 
-      // V_trans = Vmem.view(n_embd/n_head, n_head, n_past + N).permute(1,
-      // 2, 0, 3).contiguous() [n_past + N, 64, 12]
+      // V_trans = Vmem.view(n_embd/n_head, n_head, n_past + N).permute(1, 2, 0,
+      // 3).contiguous() [n_past + N, 64, 12]
       struct ggml_tensor *V_trans = ggml_cpy(
           ctx0,
           ggml_permute(
               ctx0,
               ggml_reshape_3d(
                   ctx0,
                   ggml_view_1d(
@@ -538,135 +606,189 @@
                       il * n_ctx * ggml_element_size(model.memory_v) * n_embd),
                   n_embd / n_head, n_head, n_past + N),
               1, 2, 0, 3),
           ggml_new_tensor_3d(ctx0, model.memory_v->type, n_past + N,
                              n_embd / n_head, n_head));
 
       // KQV = transpose(V) * KQ_soft_max
+      // [64, N, 12]
       struct ggml_tensor *KQV = ggml_mul_mat(ctx0, V_trans, KQ_soft_max);
 
       // KQV_merged = KQV.permute(0, 2, 1, 3)
+      // [64, 12, N]
       struct ggml_tensor *KQV_merged = ggml_permute(ctx0, KQV, 0, 2, 1, 3);
 
       // cur = KQV_merged.contiguous().view(n_embd, N)
+      // [768, N]
       cur = ggml_cpy(ctx0, KQV_merged,
                      ggml_new_tensor_2d(ctx0, GGML_TYPE_F32, n_embd, N));
-
-      // projection
-      {
-        cur = ggml_mul_mat(ctx0, model.layers[il].c_attn_out_proj_weight, cur);
-      }
     }
 
-    inpL = ggml_add(ctx0, inpL, cur);
-
-    // m = self.ln_2(x)
+    // projection
+    // [ 768, 768] - model.layers[il].c_attn_proj_w
+    // [ 768,   1] - model.layers[il].c_attn_proj_b
+    // [ 768,   N] - cur (in)
+    // [ 768,   N] - cur (out)
+    //
+    // cur = proj_w*cur + proj_b
+    // [768, N]
     {
-      cur = ggml_norm(ctx0, inpL);
+      cur = ggml_mul_mat(ctx0, model.layers[il].c_attn_proj_w, cur);
 
-      cur = ggml_mul(
-          ctx0, ggml_repeat(ctx0, model.layers[il].norm_2_weight, cur), cur);
+      cur = ggml_add(
+          ctx0, ggml_repeat(ctx0, model.layers[il].c_attn_proj_b, cur), cur);
     }
 
-    // n = self.mlp(m)
+    // add the input
+    cur = ggml_add(ctx0, cur, inpL);
+
+    struct ggml_tensor *inpFF = cur;
+
+    ggml_set_scratch(ctx0, {
+                               0,
+                               scr1_size,
+                               scr1,
+                           });
+
+    // feed-forward network
     {
-      cur = ggml_mul_mat(ctx0, model.layers[il].ffn_up_proj, cur);
+      // norm
+      {
+        cur = ggml_norm(ctx0, inpFF);
+
+        // cur = ln_2_g*cur + ln_2_b
+        // [ 768, N]
+        cur = ggml_add(
+            ctx0,
+            ggml_mul(ctx0, ggml_repeat(ctx0, model.layers[il].ln_2_g, cur),
+                     cur),
+            ggml_repeat(ctx0, model.layers[il].ln_2_b, cur));
+      }
+
+      // fully connected
+      // [3072, 768] - model.layers[il].c_mlp_fc_w
+      // [3072,   1] - model.layers[il].c_mlp_fc_b
+      // [ 768,   N] - cur (in)
+      // [3072,   N] - cur (out)
+      //
+      // cur = fc_w*cur + fc_b
+      // [3072, N]
+      cur = ggml_mul_mat(ctx0, model.layers[il].c_mlp_fc_w, cur);
+
+      cur = ggml_add(ctx0, ggml_repeat(ctx0, model.layers[il].c_mlp_fc_b, cur),
+                     cur);
 
       // GELU activation
+      // [3072, N]
       cur = ggml_gelu(ctx0, cur);
 
       // projection
+      // [ 768, 3072] - model.layers[il].c_mlp_proj_w
+      // [ 768,    1] - model.layers[il].c_mlp_proj_b
+      // [3072,    N] - cur (in)
+      // [ 768,    N] - cur (out)
+      //
       // cur = proj_w*cur + proj_b
-      cur = ggml_mul_mat(ctx0, model.layers[il].ffn_down_proj, cur);
+      // [768, N]
+      cur = ggml_mul_mat(ctx0, model.layers[il].c_mlp_proj_w, cur);
+
+      cur = ggml_add(
+          ctx0, ggml_repeat(ctx0, model.layers[il].c_mlp_proj_b, cur), cur);
     }
 
-    // x = x + n
-    inpL = ggml_add(ctx0, inpL, cur);
+    // input for next layer
+    inpL = ggml_add(ctx0, cur, inpFF);
   }
 
+  ggml_set_scratch(ctx0, {
+                             0,
+                             scr0_size,
+                             scr0,
+                         });
+
   // norm
   {
+    // [ 768, N]
     inpL = ggml_norm(ctx0, inpL);
-    // inpL = ln_f_g*inpL
-    inpL = ggml_mul(ctx0, ggml_repeat(ctx0, model.norm_f_weight, inpL), inpL);
-  }
 
-  // output embedding weight tied to input embedding
-  inpL = ggml_mul_mat(ctx0, model.wte_weight, inpL);
+    // inpL = ln_f_g*inpL + ln_f_b
+    // [ 768, N]
+    inpL = ggml_add(ctx0,
+                    ggml_mul(ctx0, ggml_repeat(ctx0, model.ln_f_g, inpL), inpL),
+                    ggml_repeat(ctx0, model.ln_f_b, inpL));
+  }
+
+  ggml_set_scratch(ctx0, {
+                             0,
+                             0,
+                             nullptr,
+                         });
+
+  // inpL = WTE * inpL
+  // [ 768, 50257] - model.lm_head
+  // [ 768, N]     - inpL
+  inpL = ggml_mul_mat(ctx0, model.lm_head, inpL);
+
+  // logits -> probs
+  // inpL = ggml_soft_max_inplace(ctx0, inpL);
 
   // run the computation
   ggml_build_forward_expand(&gf, inpL);
   ggml_graph_compute(ctx0, &gf);
 
-  if (logits_all) {
-    // return result for all tokens
-    embd_w.resize(n_vocab * N);
-    memcpy(embd_w.data(), (float *)ggml_get_data(inpL),
-           sizeof(float) * n_vocab * N);
-  } else {
-    // return result for just the last token
-    embd_w.resize(n_vocab);
-    memcpy(embd_w.data(), (float *)ggml_get_data(inpL) + (n_vocab * (N - 1)),
-           sizeof(float) * n_vocab);
-  }
+  // if (n_past%100 == 0) {
+  //    ggml_graph_print   (&gf);
+  //    ggml_graph_dump_dot(&gf, NULL, "gpt-2.dot");
+  //}
+
+  // embd_w.resize(n_vocab*N);
+  // memcpy(embd_w.data(), ggml_get_data(inpL), sizeof(float)*n_vocab*N);
+
+  // return result just for the last token
+  embd_w.resize(n_vocab);
+  memcpy(embd_w.data(), (float *)ggml_get_data(inpL) + (n_vocab * (N - 1)),
+         sizeof(float) * n_vocab);
 
   if (mem_per_token == 0) {
     mem_per_token = ggml_used_mem(ctx0) / N;
   }
-  // printf("used_mem = %zu\n", ggml_used_mem(ctx0));
+  // printf("used_mem = %zu MB\n", ggml_used_mem(ctx0)/(1024*1024));
 
   ggml_free(ctx0);
 
   return true;
 }
 
-class replit_llm : public LLM {
- public:
-  virtual ~replit_llm() {
-    if (model_.ctx != nullptr) {
-      ggml_free(model_.ctx);
-    }
-  }
-
-  std::vector<gpt_vocab::id> Tokenize(const std::string &text) const override {
-    // tokenize the prompt
-    std::vector<gpt_vocab::id> embd_inp =
-        replit_tokenizer_tokenize(replit_tokenizer_, text);
-
-    return embd_inp;
-  }
-
-  const std::string &Detokenize(const gpt_vocab::id id) const override {
-    const auto it = vocab_.id_to_token.find(id);
-    if (it == vocab_.id_to_token.end()) {
-      return kEmptyString;
-    }
-
-    detokenized_text_ = replace_all(vocab_.id_to_token.at(id), ws_symbol, " ");
-    return detokenized_text_;
-  }
+size_t starcoder_get_state_size(const starcoder_model &model) {
+  size_t nbytes = 0;
+  nbytes += ggml_nbytes(model.memory_k);
+  nbytes += ggml_nbytes(model.memory_v);
+  return nbytes;
+}
 
- protected:
-  replit_tokenizer replit_tokenizer_;
-  bool Load(const std::string &filename, const int context_length,
-            const int gpu_layers) override {
-    if (context_length > 0) {
-      model_.hparams.n_ctx = context_length;
-    }
-    if (!replit_model_load(filename, model_, replit_tokenizer_)) {
-      return false;
-    }
-    n_ctx_ = model_.hparams.n_ctx;
-    vocab_ = replit_tokenizer_.raw_vocab;
-    return true;
-  }
+void starcoder_clone_state(const starcoder_model &model, void *data) {
+  uint8_t *data_bytes = static_cast<uint8_t *>(data);
+  size_t nbytes;
+
+  nbytes = ggml_nbytes(model.memory_k);
+  memcpy(data_bytes, ggml_get_data(model.memory_k), nbytes);
+  data_bytes += nbytes;
+
+  nbytes = ggml_nbytes(model.memory_v);
+  memcpy(data_bytes, ggml_get_data(model.memory_v), nbytes);
+  data_bytes += nbytes;
+}
 
-  bool Eval(const std::vector<gpt_vocab::id> &tokens, const int threads,
-            const int n_past) override {
-    return replit_eval(model_, threads, n_past, tokens, logits_,
-                       mem_per_token_);
-  }
+void starcoder_set_state(const starcoder_model &model, void *data) {
+  uint8_t *data_bytes = static_cast<uint8_t *>(data);
+  size_t nbytes;
+
+  nbytes = ggml_nbytes(model.memory_k);
+  memcpy(ggml_get_data(model.memory_k), data_bytes, nbytes);
+  data_bytes += nbytes;
+
+  nbytes = ggml_nbytes(model.memory_v);
+  memcpy(ggml_get_data(model.memory_v), data_bytes, nbytes);
+  data_bytes += nbytes;
+}
 
- private:
-  replit_model model_;
-  mutable std::string detokenized_text_;
-};
+REGISTER_LLM(starcoder);
```

### Comparing `ctransformers-langdash-0.2.11/scripts/docs.py` & `ctransformers-langdash-0.2.9/scripts/docs.py`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/scripts/sync.sh` & `ctransformers-langdash-0.2.9/scripts/sync.sh`

 * *Files 10% similar despite different names*

```diff
@@ -19,10 +19,7 @@
 
 cp models/submodules/llama.cpp/k_quants.c models/ggml/
 cp models/submodules/llama.cpp/k_quants.h models/ggml/
 
 cp models/submodules/llama.cpp/llama-util.h models/ggml/
 cp models/submodules/llama.cpp/llama.cpp models/ggml/
 cp models/submodules/llama.cpp/llama.h models/ggml/
-
-cp models/submodules/ggllm.cpp/libfalcon.cpp models/ggml/
-cp models/submodules/ggllm.cpp/libfalcon.h models/ggml/
```

### Comparing `ctransformers-langdash-0.2.11/setup.py` & `ctransformers-langdash-0.2.9/setup.py`

 * *Files 0% similar despite different names*

```diff
@@ -17,15 +17,15 @@
 with open("README.md") as f:
     long_description = f.read()
 
 name = "ctransformers"
 
 setup(
     name=f"{name}-langdash",
-    version="0.2.11",
+    version="0.2.9",
     description="Fork of CTransformers to support Langdash functions.",
     long_description=long_description,
     long_description_content_type="text/markdown",
     author='Nana Mochizuki',
     author_email='nana@mysymphony.jp.net',
     url='https://git.mysymphony.jp.net/nana/ctransformers',
     license="MIT",
```

### Comparing `ctransformers-langdash-0.2.11/tests/test_llm.py` & `ctransformers-langdash-0.2.9/tests/test_llm.py`

 * *Files identical despite different names*

### Comparing `ctransformers-langdash-0.2.11/tests/test_model.py` & `ctransformers-langdash-0.2.9/tests/test_model.py`

 * *Files identical despite different names*

